<?xml version="1.0"?>
<xtml version="1.0" xmlns="urn:www.pactolus.com:xtml" >
  <version sce-version="422a4" prev-sce-version="422a4" last-mod-time="Monday, July 30, 2012 12:55:11"/>
  <events >
    <event name="CSRBeginAssignment" display="CSRBeginAssignment" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="lCSRAssignmentId" type="i8"/>
      <parameter name="lCSRRequestId" type="i8"/>
      <parameter name="lCSRUserId" type="i8"/>
      <parameter name="lCSRRequestSkillId" type="i8"/>
      <parameter name="strCSRRequestSkillName" type="string"/>
      <parameter name="lCSRRequestLanguageId" type="i8"/>
      <parameter name="strCSRRequestLanguageName" type="string"/>
      <parameter name="lCSRRequestGroupId" type="i8"/>
      <parameter name="strCSRRequestGroupName" type="string"/>
      <parameter name="nCSRRequestType" type="i4"/>
      <parameter name="strCSRRequestTypeName" type="string"/>
      <parameter name="lServiceProviderId" type="i8"/>
      <parameter name="strServiceProviderName" type="string"/>
      <parameter name="lOfferingId" type="i8"/>
      <parameter name="strOfferingName" type="string"/>
      <parameter name="strConfEventId" type="string"/>
      <parameter name="strConfModPasscode" type="string"/>
      <parameter name="strSubscriberAccount" type="string"/>
      <parameter name="strSubscriberFirstName" type="string"/>
      <parameter name="strSubscriberLastName" type="string"/>
      <parameter name="strCSRAppServerIP" type="string"/>
      <parameter name="strCSRAssignmentType" type="string"/>
      <parameter name="lCSRAssignmentDuration" type="i8"/>
      <parameter name="strSubscriberPin" type="string"/>
      <parameter name="strCSRAssignmentAction" type="string"/>
    </event>
    <event name="CSREndAssignment" display="CSREndAssignment" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strCSRTransactionId" type="string"/>
      <parameter name="lCSRAssignmentId" type="string"/>
      <parameter name="lCSRRequestId" type="i8"/>
      <parameter name="lCSRUserId" type="i8"/>
      <parameter name="strCSRAssignmentAction" type="string"/>
      <parameter name="strPasscode" type="string"/>
      <parameter name="strPrepaidPin" type="string"/>
      <parameter name="strPostpaidPin" type="string"/>
      <parameter name="strPostpaidAccountNumber" type="string"/>
      <parameter name="strOutdialPhoneNumber" type="string"/>
      <parameter name="nCSRAvailabilityState" type="i4"/>
      <parameter name="strBillableFlag" type="string"/>
      <parameter name="nReleaseToConfStatus" type="i4"/>
      <parameter name="lPartySchedId" type="i8"/>
      <parameter name="strPartyDetail" type="string"/>
      <parameter name="nDefaultAudioMode" type="i4"/>
      <parameter name="strRequeueFlag      " type="string"/>
    </event>
    <event name="CallerOffHold" display="CallerOffHold" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="CallerOnHold" display="CallerOnHold" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="CSROutdialBLeg" display="CSROutdialBLeg" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="strPhoneNumber" type="string"/>
      <parameter name="strPrepaidPin" type="string"/>
      <parameter name="strPostpaidPin" type="string"/>
      <parameter name="strPostpaidAccountNum" type="string"/>
      <parameter name="strBillableFlag" type="string"/>
    </event>
    <event name="Ping" display="Ping" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="strHostIP" type="string"/>
      <parameter name="nHostPort" type="i4"/>
    </event>
    <event name="CSRCancelOutdialToBLeg" display="CSRCancelOutdialToBLeg" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="CSRHangupBLeg" display="CSRHangupBLeg" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="ClickToDial" display="ClickToDial" >
      <parameter name="strSrcIpAddress" type="string"/>
      <parameter name="nPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="strCallingNumber" type="string"/>
      <parameter name="strCalledNumber" type="string"/>
      <parameter name="nTreatmentCode" type="i4"/>
      <parameter name="strServiceProviderCode" type="string"/>
      <parameter name="lServiceProviderId" type="i8"/>
      <parameter name="strPrepaidPinNbr" type="string"/>
      <parameter name="strPostpaidAcctNbr" type="string"/>
      <parameter name="strPostpaidPinNbr" type="string"/>
      <parameter name="strLanguage" type="string"/>
    </event>
    <event name="ClickToDialQuery" display="ClickToDialQuery" >
      <parameter name="strSrcAddress" type="string"/>
      <parameter name="nPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="ACDAuditRequest" display="ACDAuditRequest" >
      <parameter name="strAcdControllerIp" type="string"/>
      <parameter name="nAcdControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
  </events>
  <global-handlers >
    <handler event="Pactolus.EveSipRefer.1" function="OnRefer" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipInvite.1" function="OnInvite" public="1" always-on="0"/>
    <handler event="Pactolus.EveSipBye.1" function="OnBye" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipCancel.1" function="OnCancel" public="0" always-on="0"/>
    <handler event="Standard.OnServiceLoad.1" function="OnServiceLoad" public="0" always-on="0"/>
    <handler event="Standard.OnSessionEnd.1" function="OnSessionEnd" public="0" always-on="0"/>
    <handler event="Standard.OnTimer.1" function="OnTimer" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipInfo.1" function="OnInfo" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipOptions.1" function="OnOptions" public="1" always-on="0"/>
    <handler event="CSRBeginAssignment" function="OnCSRBeginAssignment" public="0" always-on="0"/>
    <handler event="CSREndAssignment" function="OnCSREndAssignment" public="0" always-on="0"/>
    <handler event="CallerOffHold" function="OnCSRTakeCallerOffHold" public="0" always-on="0"/>
    <handler event="CallerOnHold" function="OnCSRPutCallerOnHold" public="0" always-on="0"/>
    <handler event="CSROutdialBLeg" function="OnCSROutdialBLeg" public="0" always-on="0"/>
    <handler event="Ping" function="OnPing" public="0" always-on="0"/>
    <handler event="CSRCancelOutdialToBLeg" function="OnCSRCancelOutdialToBLeg" public="0" always-on="0"/>
    <handler event="CSRHangupBLeg" function="OnCSRHangupBLeg" public="0" always-on="0"/>
    <handler event="ClickToDial" function="OnClickToDial" public="1" always-on="0"/>
    <handler event="ClickToDialQuery" function="OnClickToDialQuery" public="1" always-on="0"/>
    <handler event="ACDAuditRequest" function="OnACDAuditRequest" public="0" always-on="0"/>
  </global-handlers>
  <global-vars >
    <var name="g_nMode" type="i4" >0</var>
    <var name="g_nMinIntlDigits" type="i4" >3</var>
    <var name="g_nOrigTacRegionId" type="i4" >1</var>
    <var name="g_strContact" type="string" ></var>
    <var name="g_nCurrentState" type="i4" >-1</var>
    <var name="g_strTempString" type="string" ></var>
    <var name="g_nTempInt" type="i4" >0</var>
    <var name="g_lTempLong" type="i8" >0</var>
    <var name="g_nTimeAvailable" type="i4" >0</var>
    <var name="g_nPromptToPlay" type="i4" >0</var>
    <var name="g_bGotRechargeSettings" type="boolean" >0</var>
    <var name="g_strDigit" type="string" >""</var>
    <var name="g_nSessionType" type="i4" >1</var>
    <var name="g_nNumRetry" type="i4" >0</var>
    <var name="g_sMaxLoginAttempts" type="i2" >0</var>
    <var name="g_bNullFlag" type="boolean" >0</var>
    <var name="g_strTestOriginationNumber" type="string" ></var>
    <var name="g_nSessionExpiresA" type="i4" >0</var>
    <var name="g_nSessionExpiresB" type="i4" >0</var>
    <var name="g_strTerminationDigit" type="string" ></var>
    <var name="g_bFirstTry" type="boolean" >1</var>
    <var name="g_strAlarmType" type="string" ></var>
    <var name="g_strAlarmPriority" type="string" ></var>
    <var name="g_oCallLegA" type="object" ></var>
    <var name="g_oCallLegB" type="object" ></var>
    <var name="g_oMS" type="object" ></var>
    <var name="g_bSentFinalResponse" type="boolean" >0</var>
    <var name="g_bNewCall" type="boolean" >1</var>
    <var name="g_nErrorMsgNumber" type="i4" >0</var>
    <var name="g_oTimerThreshold1" type="object" ></var>
    <var name="g_oTimerThreshold2" type="object" ></var>
    <var name="g_oTimerThreshold3" type="object" ></var>
    <var name="g_oTimerGSXA" type="object" ></var>
    <var name="g_oTimerPhoneA" type="object" ></var>
    <var name="g_oTimerPhoneB" type="object" ></var>
    <var name="g_oTimerGSXB" type="object" ></var>
    <var name="g_oTimerMaxTime" type="object" ></var>
    <var name="g_oAPI" type="object" ></var>
    <var name="g_oACD" type="object" ></var>
    <var name="g_oSUB" type="object" ></var>
    <var name="g_oRATE" type="object" ></var>
    <var name="g_oBALXFER" type="object" ></var>
    <var name="g_oCC" type="object" ></var>
    <var name="g_oMOH" type="object" ></var>
    <var name="g_oTimerMOH" type="object" ></var>
    <var name="g_oTimerPleaseHold" type="object" ></var>
    <var name="g_oTimerMaxWaitCSR" type="object" ></var>
    <var name="g_oConfMS" type="object" ></var>
    <var name="g_oNULL" type="object" ></var>
    <var name="g_oTimerHeartBeat" type="object" ></var>
    <var name="g_oTEST" type="object" ></var>
    <var name="g_oPrompts" type="object" ></var>
    <var name="g_bGotCSRCancelOutdial" type="boolean" >0</var>
    <var name="g_bGotCSRHangupOutdial" type="boolean" >0</var>
    <var name="g_bBeginAssignment" type="boolean" >0</var>
    <var name="g_bBeginRequest" type="boolean" >0</var>
    <var name="g_bFailToConnectToMS" type="boolean" >0</var>
    <var name="g_nPromptHoldForCSR" type="i4" >1501</var>
    <var name="g_nPromptNotAllowed" type="i4" >524</var>
    <var name="g_nReturnCode" type="i4" >0</var>
    <var name="g_oLanguages" type="object" ></var>
    <var name="g_oArrayCallLegs" type="object" ></var>
    <var name="g_strClick2DialStatus" type="string" ></var>
    <var name="g_nClick2DialCode" type="i4" >0</var>
    <var name="g_bValidateByANI" type="boolean" >0</var>
    <var name="g_strZeroTransactionId" type="string" >0</var>
    <var name="g_strOutdialANumber" type="string" ></var>
    <var name="g_strC2DCalledNumber" type="string" ></var>
    <var name="g_strC2DSoapIp" type="string" ></var>
    <var name="g_nC2DSoapPort" type="i4" >0</var>
    <var name="g_strC2DTransactionId" type="string" ></var>
    <var name="g_bSingleStageDialing" type="boolean" >0</var>
    <var name="g_bInitiatedANCallback" type="boolean" >0</var>
    <var name="g_bTryAgain" type="boolean" >1</var>
    <var name="g_oTimerMaxTimeALeg" type="object" ></var>
    <var name="g_strAuthenticationNbr" type="string" ></var>
    <var name="g_bGetPinOnly" type="boolean" >0</var>
    <var name="g_strDigitCollected" type="string" ></var>
    <var name="g_bALegRatingOn" type="boolean" >0</var>
    <var name="g_bGotCSROutdial" type="boolean" >0</var>
    <var name="g_strOrigAEndPoint" type="string" ></var>
    <var name="g_strNULL" type="string" ></var>
    <var name="g_bGotEndAssignment" type="boolean" >0</var>
    <var name="g_bDoNotEnableEvents" type="boolean" >0</var>
    <var name="g_nCurrentArrayIndex" type="i4" >-1</var>
    <var name="g_oOnByeCallIds" type="object" ></var>
    <var name="g_bDirectCallFlag" type="boolean" >0</var>
    <var name="g_bUsedTempLeg" type="boolean" >0</var>
    <var name="g_bModAddingParty" type="boolean" >0</var>
    <var name="g_oTempLeg" type="object" ></var>
    <var name="g_oTimerLongCallInterval" type="object" ></var>
    <var name="g_bBalXferPinLocked" type="boolean" >0</var>
    <var name="g_bOutOfMoney" type="boolean" >0</var>
    <var name="g_bSuppressCallCSPrompt" type="boolean" >0</var>
    <var name="g_strAuthAniHost" type="string" ></var>
    <var name="g_nChimeOrSilence" type="i4" >0</var>
    <var name="g_bInvalidAniRedirect" type="boolean" >0</var>
    <var name="g_oSTB" type="object" ></var>
    <var name="g_nCutOffTimerId" type="i4" >0</var>
    <var name="g_nPrimSecBalance" type="i4" >0</var>
    <var name="g_nPrimSecUsed" type="i4" >0</var>
    <var name="g_oTimerBillingCycle" type="object" ></var>
    <var name="g_strCallingCardNumber" type="string" ></var>
    <var name="g_strPinNumber" type="string" ></var>
    <var name="g_breturnFromMain" type="boolean" >0</var>
    <var name="g_bAutoAniAccessNumber" type="boolean" >0</var>
  </global-vars>
  <shared-vars >
    <var name="s_strPrimaryPSX" type="string" >10.6.9.64</var>
    <var name="s_nSLEEPTIME" type="i4" >7</var>
    <var name="s_nTIMEOUT" type="i4" >30</var>
    <var name="s_strPROTOCOL" type="string" >UDP</var>
    <var name="s_strSIPVERSION" type="string" >SIP/2.0</var>
    <var name="s_strApplicationName" type="string" ></var>
    <var name="s_nINITIALIZE_SESSION" type="i4" >0</var>
    <var name="s_nGET_PIN" type="i4" >1</var>
    <var name="s_nAUTHENTICATE_PIN" type="i4" >2</var>
    <var name="s_nGET_DESTINATION" type="i4" >3</var>
    <var name="s_nAUTHORIZE_DESTINATION" type="i4" >4</var>
    <var name="s_nMAKE_CONNECTION" type="i4" >5</var>
    <var name="s_nCONNECTED" type="i4" >6</var>
    <var name="s_nCALL_COMPLETE" type="i4" >7</var>
    <var name="s_nSESSION_COMPLETE" type="i4" >8</var>
    <var name="s_nEND_CALL" type="i4" >9</var>
    <var name="s_nBALANCE_XFER" type="i4" >10</var>
    <var name="s_nCC_RECHARGE" type="i4" >11</var>
    <var name="s_nPLAY_BALANCE" type="i4" >12</var>
    <var name="s_nPLAY_EXPDATE" type="i4" >13</var>
    <var name="s_nMAKE_CALL" type="i4" >14</var>
    <var name="s_nMAIN_MENU" type="i4" >15</var>
    <var name="s_nRING_NO_ANSWER_TIME" type="i4" >60</var>
    <var name="s_strLocalHost" type="string" ></var>
    <var name="s_bTestMode" type="boolean" >0</var>
    <var name="s_strDEFAULT_ANI" type="string" ></var>
    <var name="s_strBackupPSX" type="string" ></var>
    <var name="s_strTestModeFlag" type="string" ></var>
    <var name="s_nPROMPTLENGTH" type="i4" >35</var>
    <var name="s_strContentType" type="string" >application/sdp</var>
    <var name="s_strSEND_ALARM_REQUEST" type="string" >OnAlarm</var>
    <var name="s_strSendAlarmFlag" type="string" ></var>
    <var name="s_strMSType" type="string" ></var>
    <var name="s_sSUCCESS" type="i2" >0</var>
    <var name="s_sFAILURE" type="i2" >-1</var>
    <var name="s_sCALLERHUNGUP" type="i2" >-2</var>
    <var name="s_strMSRetryFlag" type="string" ></var>
    <var name="s_strDigitPrependToOutDial" type="string" ></var>
    <var name="s_nPROMPT_GOOD_BYE" type="i4" >322</var>
    <var name="s_nPacketizationPeriod" type="i4" >0</var>
    <var name="s_strOutdialDigitMap" type="string" ></var>
    <var name="s_strSessionTimerFlag" type="string" ></var>
    <var name="s_nSessionTimerInterval" type="i4" >0</var>
    <var name="s_nIntlMinConnectTime" type="i4" >0</var>
    <var name="s_nDomMinConnectTime" type="i4" >0</var>
    <var name="s_strOutdialDialingPlan" type="string" ></var>
    <var name="s_strIgnorePinLanguage" type="string" >F</var>
    <var name="s_nHalfSecSilence" type="i4" >220</var>
    <var name="s_fPreStartCallDelay" type="float" >0</var>
    <var name="s_strCodec" type="string" ></var>
    <var name="s_nPROMPT_JOIN_TONE" type="string" >231</var>
    <var name="s_nBEGINASSIGNMENT" type="i4" >20</var>
    <var name="s_nREQUEUE" type="i4" >24</var>
    <var name="s_strCustomerCode" type="string" ></var>
    <var name="s_nSoapPort" type="i4" >0</var>
    <var name="s_nConferenceMaxParties" type="i4" >4</var>
    <var name="s_nConferenceMaxTalkers" type="i4" >4</var>
    <var name="s_nWAIT_FOR_MESSAGE" type="i4" >16</var>
    <var name="s_nSPEED_DIAL" type="i4" >17</var>
    <var name="s_nSPEED_DIAL_SE_ID" type="i4" >1</var>
    <var name="s_nEXCEEDINVALID" type="i4" >2</var>
    <var name="s_nCSR_ROUTE_REASON_ZERO_OUT" type="i4" >4</var>
    <var name="s_nBEGINREQUEST" type="i4" >22</var>
    <var name="s_strSendInfoMsg" type="string" ></var>
    <var name="s_nROUTE_TO_CSR" type="i4" >19</var>
    <var name="s_oCSR_REASONS" type="object" ></var>
    <var name="s_nSTATE_LANGUAGE_MENU" type="i4" >25</var>
    <var name="s_nSTATE_PROC_CSR_ATTEMPT" type="i4" >26</var>
    <var name="s_nCSR_ROUTE_REASON_TIMEOUT" type="i4" >5</var>
    <var name="s_nCSR_ROUTE_REASON_INVALID" type="i4" >6</var>
    <var name="s_strSendPrecallInfoMsg" type="string" ></var>
    <var name="s_strVia" type="string" ></var>
    <var name="s_strACDMediaServerType" type="string" ></var>
    <var name="s_strMOHMediaServerType" type="string" ></var>
    <var name="s_oINITIATION_TYPES" type="object" ></var>
    <var name="s_oORIG_TYPES" type="object" ></var>
    <var name="s_nDIAL_OUT_A_AND_B" type="i4" >27</var>
    <var name="s_nDIAL_OUT_A_ONLY" type="i4" >28</var>
    <var name="s_nSTATE_INIT_AN_CALLBACK" type="i4" >30</var>
    <var name="s_nPROMPT_CALLBACK" type="i4" >282</var>
    <var name="s_nIVR_CALLBACK_DELAY" type="i4" >5</var>
    <var name="s_nTREATMENT_CODE_IVR_INIT" type="i4" >2</var>
    <var name="s_strNULL" type="string" ></var>
    <var name="s_nPROMPT_CANT_CALLBACK" type="i4" >283</var>
    <var name="s_strPrependSVC" type="string" ></var>
    <var name="s_nSERVICE_ELEMENT_ID_POPD" type="i4" >3</var>
    <var name="s_nSERVICE_ELEMENT_ID_PRPD" type="i4" >1</var>
    <var name="s_nSTATE_AUTH_PIN_POPD" type="i4" >31</var>
    <var name="s_nSTATE_AUTH_PRPD_OR_POPD" type="i4" >32</var>
    <var name="s_nSTATE_GET_PIN_POPD" type="i4" >33</var>
    <var name="s_nSTATE_GET_PIN_PRPD_OR_POPD" type="i4" >34</var>
    <var name="s_nSTATE_MAIN_MENU_POPD" type="i4" >35</var>
    <var name="s_nSTATE_MAIN_MENU_PRPD_OR_POPD" type="i4" >36</var>
    <var name="s_strReadCallTreatmentType" type="string" ></var>
    <var name="s_strReadSPCode" type="string" ></var>
    <var name="s_nGetPostPaidAcctNbrTimeout" type="i4" >40</var>
    <var name="s_nGetPrepaidPinTimeout" type="i4" >40</var>
    <var name="s_nGetDestTimeout" type="i4" >40</var>
    <var name="s_nPROMPT_CONNECTING_CALL" type="i4" >517</var>
    <var name="s_nSTATE_CALLBACK_MAINT" type="i4" >37</var>
    <var name="s_strAppPropCheckAniForInfoDigts" type="string" >F</var>
    <var name="s_bPlayRingbackForOutdial" type="boolean" >0</var>
    <var name="s_strAccessNumberFromURI" type="string" ></var>
    <var name="s_strBlindCallback" type="string" >prompt</var>
    <var name="s_strE164_Dialing" type="string" ></var>
    <var name="s_bAppPropSuppressOnHold" type="boolean" >0</var>
    <var name="s_nGET_DIRECT_CALLID" type="i4" >52</var>
    <var name="s_nSTATE_PROC_N_LEG" type="i4" >38</var>
    <var name="s_nSTATE_RETURN_TO_CONF" type="i4" >39</var>
    <var name="s_nSTATE_ADD_LEG_CONF" type="i4" >40</var>
    <var name="s_strStripLeadingOne" type="string" >T</var>
    <var name="s_nTREATMENT_CODE_MESSAGE_INIT" type="i4" >1</var>
    <var name="s_nTREATMENT_CODE_CLICK_TO_DIAL" type="i4" >0</var>
    <var name="s_strSuppressCallerId" type="string" >F</var>
    <var name="s_bAppPropUseFromHeaderForAni" type="boolean" >0</var>
    <var name="s_nAppPropPleaseHoldInterval" type="i4" >0</var>
    <var name="s_nDTMFDefaultTimeout" type="i4" >0</var>
    <var name="s_bSuppressCallCSPrompt" type="boolean" >0</var>
    <var name="s_sFEATURE_CHECK_BALANCE" type="i2" >1</var>
    <var name="s_bRedirect" type="boolean" >0</var>
    <var name="s_strOutboundCIC" type="string" ></var>
    <var name="s_bSingleStageDialing" type="boolean" >0</var>
    <var name="s_strServiceProviderCode" type="string" ></var>
    <var name="s_bPlayChime" type="boolean" >0</var>
    <var name="s_bAnncDisabled" type="boolean" >0</var>
    <var name="s_sDISABLED_BUCKET_EXHAUSTED" type="i2" >16</var>
    <var name="s_sDISABLED_CANCELLED" type="i2" >7</var>
    <var name="s_sDISABLED_CREDIT_LIMIT_EXCEED" type="i2" >14</var>
    <var name="s_sDISABLED_SUSPENDED" type="i2" >15</var>
    <var name="s_fSingleStagePrePromptDelay" type="float" >2</var>
    <var name="s_strDestPromptPoundKey" type="string" >F</var>
    <var name="s_nInvalidAccessNumberPrompt" type="i4" >0</var>
    <var name="s_strAnswerInvalidAccessNumber" type="string" ></var>
    <var name="s_nCutOffTimeSeconds" type="i4" >0</var>
    <var name="s_bAnnounceHoursMins" type="boolean" >0</var>
    <var name="s_nSTATE_CHECK_PIN_PRPD_OR_POPD" type="i4" >41</var>
    <var name="s_bPinPlayZeroForOperator" type="boolean" >0</var>
    <var name="s_nTREATMENT_CODE_AN_INIT" type="i4" >3</var>
    <var name="s_oAutoAniArray" type="object" ></var>
    <var name="s_strJavaClass" type="string" >com.rawabi.xtml.XtmlInterface</var>
  </shared-vars>
  <functions >
    <function name="Main" start="1" event="Main" returns="void" >
      <local-vars >
        <var name="f_strContentON" type="string" >ON</var>
        <var name="f_nMaxLoginAttempts" type="i4" >0</var>
        <var name="f_bSendTo3WayMenu" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=14 y=316 ?>
          <!--what is the g_nCurrentState-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="initializeSession()" link="3" stubbed="0" >g_nCurrentState == s_nINITIALIZE_SESSION</result>
            <result name="getPinNumber()" link="16" stubbed="1" >g_nCurrentState == s_nGET_PIN</result>
            <result name="authenticatePin()" link="5" stubbed="0" >g_nCurrentState == s_nAUTHENTICATE_PIN</result>
            <result name="getDestNumber()" link="17" stubbed="0" >g_nCurrentState == s_nGET_DESTINATION</result>
            <result name="authorizationDestination()" link="7" stubbed="0" >g_nCurrentState == s_nAUTHORIZE_DESTINATION</result>
            <result name="make connection" link="12" stubbed="0" >g_nCurrentState == s_nMAKE_CONNECTION</result>
            <result name="connected" link="21" stubbed="1" >g_nCurrentState == s_nCONNECTED</result>
            <result name="end call" link="15" stubbed="0" >g_nCurrentState == s_nEND_CALL</result>
            <result name="main menu" link="18" stubbed="0" >g_nCurrentState == s_nMAIN_MENU</result>
            <result name="route to csr" link="23" stubbed="0" >g_nCurrentState == s_nROUTE_TO_CSR</result>
            <result name="language menu" link="25" stubbed="0" >g_nCurrentState == s_nSTATE_LANGUAGE_MENU</result>
            <result name="proc CSR attempt" link="26" stubbed="0" >g_nCurrentState == s_nSTATE_PROC_CSR_ATTEMPT</result>
            <result name="DialOutPartyA" link="27" stubbed="0" >g_nCurrentState == s_nDIAL_OUT_A_ONLY</result>
            <result name="Init AN Callback" link="30" stubbed="0" >g_nCurrentState == s_nSTATE_INIT_AN_CALLBACK</result>
            <result name="Auth Pre or Post" link="35" stubbed="0" >g_nCurrentState == s_nSTATE_AUTH_PRPD_OR_POPD</result>
            <result name="Get Pin Pre or Post" link="36" stubbed="0" >g_nCurrentState == s_nSTATE_GET_PIN_PRPD_OR_POPD</result>
            <result name="Auth Popd Pin" link="37" stubbed="0" >g_nCurrentState == s_nSTATE_AUTH_PIN_POPD</result>
            <result name="Get Popd Pin" link="38" stubbed="0" >g_nCurrentState == s_nSTATE_GET_PIN_POPD</result>
            <result name="Main Menu Prpd or Popd" link="39" stubbed="0" >g_nCurrentState == s_nSTATE_MAIN_MENU_PRPD_OR_POPD</result>
            <result name="Main Menu Popd" link="40" stubbed="0" >g_nCurrentState == s_nSTATE_MAIN_MENU_POPD</result>
            <result name="Callback Maint" link="41" stubbed="0" >g_nCurrentState == s_nSTATE_CALLBACK_MAINT</result>
            <result name="getDirectCall" link="44" stubbed="0" >g_nCurrentState == s_nGET_DIRECT_CALLID</result>
            <result name="Add Leg to Conf" link="45" stubbed="0" >g_nCurrentState == s_nSTATE_ADD_LEG_CONF</result>
            <result name="Return to Conf" link="47" stubbed="1" >g_nCurrentState == s_nSTATE_RETURN_TO_CONF</result>
            <result name="Proc N Leg" link="48" stubbed="1" >g_nCurrentState == s_nSTATE_PROC_N_LEG</result>
            <result name="Check pin prpd or popd" link="50" stubbed="0" >g_nCurrentState  == s_nSTATE_CHECK_PIN_PRPD_OR_POPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*** THE CURRENT STATE IS: *** " + Session.g_nCurrentState);]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=514 y=50 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=632 y=119 ?>
          <!--call initializeSession()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;InitializeSession&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=728 y=330 ?>
          <!--call authenticatePin()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AuthenticatePin&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=721 y=537 ?>
          <!--call authorizeDest()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AuthorizeDestination&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=686 y=633 ?>
          <!--make the connection-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Connect&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1128 y=740 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="15" plug-in="Standard.EndSession.1" ><?xtml-editor x=628 y=876 ?></action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1157 y=225 ?>
          <!--getPinNumber()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetPinNumber&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=749 y=440 ?>
          <!--getDestNumber()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetDestNumber&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=632 y=950 ?>
          <!--call main menu-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MainMenu&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="19" plug-in="Pactolus.Branch.1" ><?xtml-editor x=674 y=223 ?>
          <!--delay?-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="s_fPreStartCallDelay &gt; 0 ?" link="20" stubbed="0" >s_fPreStartCallDelay &gt; 0</result>
          </results>
        </action>
        <action id="20" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=914 y=224 ?>
          <!--s_fPreStartCallDelay secs-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="s_fPreStartCallDelay"/>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
        <action id="21" plug-in="Pactolus.Branch.1" ><?xtml-editor x=645 y=745 ?>
          <!--send info msg = T and send info precall = F ?-->
          <results >
            <result name="Default" link="14" stubbed="1"/>
            <result name="SendInfoMs &amp;&amp; PreCall = F" link="22" stubbed="0" >s_strSendInfoMsg match "T"
AND s_strSendPrecallInfoMsg match "F"</result>
          </results>
        </action>
        <action id="22" plug-in="Pactolus.SipInfo.1" ><?xtml-editor x=887 y=742 ?>
          <!--ON-->
          <element-tag increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >f_strContentON</content>
            <content-type >"application/dtmf"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strTo</from>
            <request-uri >g_oCallLegA.strRequestUri</request-uri>
            <to >g_oCallLegA.strFrom</to>
            <via >s_strVia</via>
          </element-tag>
          <results >
            <result name="Default" link="14" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=616 y=1065 ?>
          <!--RouteToCSR-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;RouteToCSR&quot;" return="g_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="24" stubbed="0"/>
            <result name="Success" link="1" stubbed="1" >g_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;
js_disable_event();

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.g_nReturnCode == 0) {
	Session.g_bBeginRequest = true;
}	

Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;

js_enable_event();
]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=825 y=1051 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
          </results>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=600 y=1184 ?>
          <!--playLanguageMenu-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;playLanguageMenu&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oLanguages</parameter>
            <parameter >g_oAPI.nPromptLanguageMenuIndex</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oAPI.strPromptLanguageMenuUrl</parameter>
          </function>
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="ProcCSRAttempt" >g_nReturnCode == 1
OR g_nReturnCode == 2
OR g_nReturnCode == 3</result>
            <result name="MS Error" link="24" stubbed="1" >g_nReturnCode == -1</result>
            <result name="!bValidateByANI " >g_bValidateByANI == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oLanguages.length = 0;

if(Session.s_strCustomerCode == "goldline") {

	//Set Language Menu attributes specific to Goldline
	Session.f_nMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;
	Session.g_oAPI.nMaxLoginAttempts = 1;
}

if(Session.g_oAPI.strPromptLanguageMenuUrl.length > 0 || Session.g_oAPI.nPromptLanguageMenuIndex > 0) {

	//App will play one single prompt so only need to set up language codes.
	if(Session.g_oAPI.strLanguageOption1.length > 0) {
		Session.g_oLanguages[0].strCode = Session.g_oAPI.strLanguageOption1;
	}

	if(Session.g_oAPI.strLanguageOption2.length > 0) {
		Session.g_oLanguages[1].strCode = Session.g_oAPI.strLanguageOption2;
	}

	if(Session.g_oAPI.strLanguageOption3.length > 0) {
		Session.g_oLanguages[2].strCode = Session.g_oAPI.strLanguageOption3;
	}

	if(Session.g_oAPI.strLanguageOption4.length > 0) {
		Session.g_oLanguages[3].strCode = Session.g_oAPI.strLanguageOption4;
	}

	if(Session.g_oAPI.strLanguageOption5.length > 0) {
		Session.g_oLanguages[4].strCode = Session.g_oAPI.strLanguageOption5;
	}

	if(Session.g_oAPI.strLanguageOption6.length > 0) {
		Session.g_oLanguages[5].strCode = Session.g_oAPI.strLanguageOption6;
	}

	if(Session.g_oAPI.strLanguageOption7.length > 0) {
		Session.g_oLanguages[6].strCode = Session.g_oAPI.strLanguageOption7;
	}

	if(Session.g_oAPI.strLanguageOption8.length > 0) {
		Session.g_oLanguages[7].strCode = Session.g_oAPI.strLanguageOption8;
	}

	if(Session.g_oAPI.strLanguageOption9.length > 0) {
		Session.g_oLanguages[8].strCode = Session.g_oAPI.strLanguageOption9;
	}
} else {

	/*
	TO DO:
	 App will need to build dynamic language prompts and make this confifurable with the new branding prompt feature in ACE

	if language 1 == english
		set 311, 343.
	else if language 1 == spanish
		set 312, 346.	

	Session.g_oLanguages[0].nPressNumber = 311;
	Session.g_oLanguages[0].nForLanguage = 343;
	Session.g_oLanguages[0].strCode = "eng";
	Session.g_oLanguages[1].nPressNumber = 312;
	Session.g_oLanguages[1].nForLanguage = 346;
	Session.g_oLanguages[1].strCode = "spa";
	Session.g_oLanguages[2].nPressNumber = 313;
	Session.g_oLanguages[2].nForLanguage = 344;
	Session.g_oLanguages[2].strCode = "ita";
	Session.g_oLanguages[3].nPressNumber = 314;
	Session.g_oLanguages[3].nForLanguage = 347;
	Session.g_oLanguages[3].strCode = "ger";
	Session.g_oLanguages[4].nPressNumber = 315;
	Session.g_oLanguages[4].nForLanguage = 371;
	Session.g_oLanguages[4].strCode = "chi";
	*/

	/*
	if(Session.g_oMS.strMSType == "CONV") {
		// Using Dynamic Language Menu w/ Convedia - need to set offsets for each language:
		Session.g_oLanguages[0].nOffset = 0; 	   	// Offset for English	
		Session.g_oLanguages[1].nOffset = 5000;	// Offset for Spanish	
		Session.g_oLanguages[2].nOffset = 20000;	// Offset for Italian
		Session.g_oLanguages[3].nOffset = 25000; 	// Offset for German	
		Session.g_oLanguages[4].nOffset = 30000; 	// Offset for Mandarin
	}
	*/

	// For now
	Server.logError("App is calling play language menu but no branding prompt is set.");
}	]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(2 == Result.id) {
	if(Session.g_nReturnCode == 1) {
	
		if(Session.s_strCustomerCode == "goldline") {	
			if(Session.g_bValidateByANI) {
				Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;			
			} else {
				Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;			
			}
		} else {
			Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nLanguageMenuMaxTimeouts;
			Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_TIMEOUT;
			Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
			Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_LANGUAGE_MENU;			
		}			
	} else if(Session.g_nReturnCode == 2) {
	
		if(Session.s_strCustomerCode == "goldline") {	
			if(Session.g_bValidateByANI) {
				Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;			
			} else {
				Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;			
			}
		} else {	
			Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nLanguageMenuMaxInvalids;
			Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;
			Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
			Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_LANGUAGE_MENU;		
		}
		
	} else if(Session.g_nReturnCode == 3) {
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nLanguageMenuZeroOut;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
		Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
		Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_LANGUAGE_MENU;
	}
} else if(3 == Result.id) {
	Server.logError("Error playing language menu.");
} else if(4 == Result.id) {
	Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
} else {
	Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
}
if(Session.s_strCustomerCode == "goldline") {
	Session.g_oAPI.nMaxLoginAttempts = Session.f_nMaxLoginAttempts;
}

]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=588 y=1315 ?>
          <!--ProcessCSRAttempt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcessCSRAttempt&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_nPromptHoldForCSR</parameter>
            <parameter >g_nPromptNotAllowed</parameter>
            <parameter >g_oMS</parameter>
            <parameter >s_oCSR_REASONS</parameter>
            <parameter >s_nTIMEOUT</parameter>
          </function>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nStatePriorToCSR: " + Session.g_oAPI.nStatePriorToCSR);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oACD.nCSRRouteReasonCode = Session.g_oACD.nCSRRouteReasonCodeTemp;

if(Session.g_nReturnCode == 1) {
	Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;
} else if(Session.g_nReturnCode == 2) {
	Session.g_nCurrentState = Session.s_nROUTE_TO_CSR;	
} else if(Session.g_nReturnCode == 3) {
	Session.g_nCurrentState = Session.s_nEND_CALL;	
} else if(Session.g_nReturnCode == 0) {
	Session.g_nCurrentState = Session.g_oAPI.nStatePriorToCSR;
}
]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=584 y=1414 ?>
          <!--DialOutPartyA-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DialOutPartyA&quot;" return="g_nReturnCode" external-function="1" library="lib_calltreatment.xml" >
            <parameter >g_strOutdialANumber</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strClick2DialStatus</parameter>
            <parameter >g_nClick2DialCode</parameter>
          </function>
          <results >
            <result name="Default" link="29" stubbed="0"/>
            <result name="Success" link="43" stubbed="0" >g_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("BEFORE g_strOutdialANumber prepend : <" + Session.g_strOutdialANumber + " >");

Session.g_strOutdialANumber = js_prepend_digits(Session.g_strOutdialANumber, Session.s_strDigitPrependToOutDial);

Server.logInfo("AFTER g_strOutdialANumber prepend : <" + Session.g_strOutdialANumber + " >");
Session.g_strOutdialANumber = js_translate_destination_post_rating(Session.s_strCustomerCode, Session.g_strOutdialANumber, Session.g_oAPI.strOriginationNumber, Session.g_oAPI.nOrigCountryId, Session.s_strE164_Dialing);


if ("T" == Session.s_strPrependSVC) {

	Session.g_strOutdialANumber = Session.g_oAPI.strServiceProviderCode + Session.g_strOutdialANumber;

}


if(Session.g_oAPI.strPrimarySoftswitchIP.length > 0) {

	Session.g_oCallLegA.strRequestUri = Session.g_oAPI.strPrimarySoftswitchIP;

} else {

	Session.g_oCallLegA.strRequestUri = Session.s_strPrimaryPSX;

}
if(Session.g_oAPI.strBackupSoftswitchIP.length > 0) {

	Session.g_oCallLegA.strBackupRequestUri = Session.g_oAPI.strBackupSoftswitchIP;

} else {

	Session.g_oCallLegA.strBackupRequestUri = Session.s_strBackupPSX;

}	
var to = new SipTo(Session.g_oCallLegA.strTo.toString());
//hack, store the calculated PAI for the a-leg into the b-leg
//Session.g_oCallLegB.strPAssertedIdentity = js_create_app_PAI(
//	Session.s_strCarrierName,
//	typeof(to.url) == "undefined" ?  "" : to.url.user,//from ANI
//	Session.g_oAPI.nOrigCountryId,
//	false,
//	Session.g_oAPI.strAniReceived,
//	typeof(to.url) == "undefined" ?  "" : to.url.host,//from HOST
//	Session.g_oCallLegA.strPAssertedIdentity,
//	false,
//	Session.s_strDEFAULT_ANI);
	
//create a-leg PAI from default ANI
Session.g_oCallLegA.strPAssertedIdentity = js_create_app_PAI(
	Session.s_strCarrierName,
	Session.g_strOutdialANumber,//from ANI
	Session.g_oAPI.nOrigCountryId,
	false,
	Session.g_oAPI.strAniReceived,
	Session.g_strC2DSoapIp,//from HOST
	Session.g_oCallLegA.strPAssertedIdentity,
	true,//force default
	Session.s_strDEFAULT_ANI);
//hack, store the calculated PAI for the a-leg into the b-leg
Session.g_oCallLegB.strPAssertedIdentity = Session.g_oCallLegA.strPAssertedIdentity;
//diversion header
Session.g_oCallLegA.strDiversion = "<sip:"+Session.s_strDEFAULT_ANI +"@" + Session.s_strLocalHost+">";]]></script>
            <script language="javascript" timing="last" ><![CDATA[//hack, take stored data and put it back into the correct location
Session.g_oCallLegA.strPAssertedIdentity = Session.g_oCallLegB.strPAssertedIdentity;]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1347 y=1535 ?>
          <!--call playPrepaidBalance()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPrepaidBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="29" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=830 y=1403 ?>
          <sleep xmlns="www.pactolus.com:xtml:application" duration="5"/>
          <results >
            <result name="Default" link="15" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strClick2DialStatus = "Unable to connect." ;
Session.g_nClick2DialCode = 503 ;
]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=587 y=1534 ?>
          <!--SetUpOneWayMedia-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;SetUpOneWayMedia&quot;" return="g_nReturnCode" external-function="1" library="lib_calltreatment.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_nPromptToPlay</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.bCollectPinForCallback</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Success, Callback" link="1" stubbed="1" >g_nPromptToPlay == s_nPROMPT_CALLBACK
AND g_nReturnCode == s_sSUCCESS</result>
            <result name="Success, Collect Pin" link="42" stubbed="0" >g_nReturnCode == s_sSUCCESS
AND g_nPromptToPlay == s_nPROMPT_CONNECTING_CALL</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Session.g_nReturnCode == Session.s_sSUCCESS && Session.g_nPromptToPlay == Session.s_nPROMPT_CALLBACK) {
	var strPrimaryRouteCode = Session.g_oCallLegA.strPrimaryRouteCode;
	Session.g_nCurrentState = Session.s_nDIAL_OUT_A_ONLY;
	var oCallLegA = Session.g_oCallLegA;
	js_initCallLeg(Session.g_oCallLegA);
	Session.g_oCallLegA.oRate = oCallLegA.oRate; // This needs to be phased out...
	Session.g_oCallLegA.oRATE = oCallLegA.oRATE;	
	Session.g_oCallLegA.strPrimaryRouteCode = strPrimaryRouteCode;	
	Session.g_bInitiatedANCallback = true;

    if(Session.g_oSUB.strCallbackNumber.length > 0 && Session.g_oSUB.bCallbackNumberEnable) {
		Session.g_strOutdialANumber = Session.g_oSUB.strCallbackNumber;
	} else {
		Session.g_strOutdialANumber = Session.g_oAPI.strOriginationNumber;
	}		
} ]]></script>
          </scripts>
        </action>
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1124 y=1584 ?>
          <!--play balance?-->
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="g_oSUB.strPlayBalanceFlag==&quot;T&quot;" link="28" stubbed="0" >g_oSUB.strPlayBalanceFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.strOriginationType: " + Session.g_oAPI.strOriginationType);

if (Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strClickToDial) {

	if (Session.g_strC2DCalledNumber.length > 0)
	{
		Server.logInfo("CLIK TO DIAL AND HAS CALLED NUMBER, NO NEED TO GET DEST");
		Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;
		Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
	}
	else
	{
		Server.logInfo("CLICK TO DIAL AND HAS NO DEST, NEED TO GET DEST");
		Session.g_nCurrentState = Session.s_nGET_DESTINATION;
	}

	Session.g_strClick2DialStatus = "Connected." ;
	Session.g_nClick2DialCode = 200 ;

} else if (Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strMessageCallback) {	

		if (Session.g_strC2DCalledNumber.length > 0)
		{
			Server.logInfo("MESSAGE INITIATE CALL AND HAS CALLED NUMBER, NO NEED TO GET DEST");
			Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;
			Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
		}
		else
		{
			Server.logInfo("MESSAGE INITIATE CALL AND HAS NO DEST, NEED TO GET DEST");
			Session.g_nCurrentState = Session.s_nGET_DESTINATION;
		}
} else {

	Session.g_nCurrentState = Session.s_nGET_DESTINATION;
}	]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1077 y=1440 ?>
          <!--StartALegTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartALegTimer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
        </action>
        <action id="35" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=580 y=1655 ?>
          <!--AuthenticatePinPrpdOrPopd-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AuthenticatePinPrpdOrPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="36" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=582 y=1779 ?>
          <!--GetPinNumberPrpdOrPopd-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetPinNumberPrpdOrPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="37" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=577 y=1862 ?>
          <!--AuthenticatePinPopd-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AuthenticatePinPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="38" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=583 y=1966 ?>
          <!--GetPinNumberPopd-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetPinNumberPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="39" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=577 y=2055 ?>
          <!--MainMenuPrpdOrPopd-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MainMenuPrpdOrPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="40" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=577 y=2144 ?>
          <!--MainMenuPopd-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MainMenuPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="41" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=567 y=2233 ?>
          <!--Callback Maint-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CallbackMaint&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="42" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=863 y=1715 ?>
          <!--StartALegTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartALegTimer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;]]></script>
          </scripts>
        </action>
        <action id="43" plug-in="Pactolus.Branch.1" ><?xtml-editor x=850 y=1530 ?>
          <results >
            <result name="Default" link="34" stubbed="0"/>
            <result name="oAPI.bBlindCallback" link="1" stubbed="1" >g_oAPI.bBlindCallback == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 == Result.id) {
	Server.logInfo("MESSAGE INITIATE CALL AND DOES NOT HAVE PIN, NEED TO GET PIN");	
	Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;

	if (Session.g_strC2DCalledNumber.length > 0)
	{
		Server.logInfo("MESSAGE INITIATE CALL AND HAS CALLED NUMBER, NO NEED TO GET DEST");
		//Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
    }
	else
	{
		Server.logInfo("MESSAGE INITIATE CALL AND HAS NO DEST, NEED TO GET DEST");
	}
}]]></script>
          </scripts>
        </action>
        <action id="44" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=561 y=2322 ?>
          <!--"GetDirectCallId"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetDirectCallId&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="45" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=570 y=2410 ?>
          <!--AddLegToConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AddLegToConf&quot;" return="g_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oConfMS</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oMS</parameter>
            <parameter >s_strSIPVERSION</parameter>
            <parameter >g_oOnByeCallIds</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
          </function>
          <results >
            <result name="Default" link="49" stubbed="0"/>
            <result name="-1:Fail to add party" >g_nReturnCode == -1</result>
            <result name="-99:End Session" link="46" stubbed="0" >g_nReturnCode == -99</result>
            <result name="1:No Conf, A cnctd to 1B" link="2" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.s_strTestModeFlag == "T")
{
	Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;
}										

Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);
Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strConfCallFlag: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strConfCallFlag);
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber = js_translate_destination_post_rating(Session.s_strCustomerCode, Session.g_oAPI.strDestinationNumber, Session.g_oAPI.strOriginationNumber, Session.g_oAPI.nOrigCountryId, Session.s_strE164_Dialing);

if ("T" == Session.s_strPrependSVC) {
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber = Session.g_oAPI.strServiceProviderCode + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber;
}

Session.g_oCallLegA.strContent = Session.g_oCallLegA.strOriginalContent;
Session.g_oAPI.nRTPClockRate = 8000;
Session.g_oAPI.nRTPEncoding = 0;
// Need to allow double the amount of endpoints in case callers hang up while moderator is adding another B leg.  
Session.g_oConfMS.nConferenceMaxParties = Session.g_oAPI.nMaxPartiesAllowed + Session.g_oAPI.nMaxPartiesAllowed + 1;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bModAddingParty = false;
if(4 == Result.id) {

	Session.g_oOnByeCallIds.length = 0;

}
if(-1 == Session.g_nReturnCode) {

	Session.f_bSendTo3WayMenu = true;

}

]]></script>
          </scripts>
        </action>
        <action id="46" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=896 y=2469 ?>
          <!--ProcTerminateConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcTerminateConf&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="24" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="47" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=561 y=2543 ?>
          <!--ReturnToConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReturnToConf&quot;" return="g_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Error - End Session" link="15" stubbed="1" >g_nReturnCode == -99</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.strConfCallFlag = "F";]]></script>
          </scripts>
        </action>
        <action id="48" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=558 y=2670 ?>
          <!--ProcNLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcNLeg&quot;" return="g_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="24" stubbed="1"/>
            <result name="0 - Wait for event" link="49" stubbed="0" >g_nReturnCode == 0</result>
            <result name="3 - Get Dest" link="1" stubbed="1" >g_nReturnCode == 3</result>
            <result name="4 - Get Non Conf Dest" link="1" stubbed="1" >g_nReturnCode == 4</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(3 == Session.g_nReturnCode) {
	Session.g_nCurrentState = Session.s_nGET_DESTINATION;
	Session.g_oCallLegB.strConfCallFlag = "T";	

} else if(4 == Session.g_nReturnCode) {
	Session.g_oCallLegB.strConfCallFlag = "F";
	Session.g_nCurrentState = Session.s_nGET_DESTINATION;

} else if(0 == Session.g_nReturnCode) {

	Session.g_bModAddingParty = false;
}]]></script>
          </scripts>
        </action>
        <action id="49" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=836 y=2666 ?>
          <!--ProcOnByes-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcOnByes&quot;" return="g_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oOnByeCallIds</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerMaxTime</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="-99: End Session" link="24" stubbed="1" >g_nReturnCode == -99</result>
            <result name="f_bSendTo3WayMenu" link="1" stubbed="1" >f_bSendTo3WayMenu == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();

if(Session.f_bSendTo3WayMenu) {
	Session.g_nCurrentState = Session.s_nSTATE_PROC_N_LEG;
	Session.f_bSendTo3WayMenu = false;
}]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=579 y=2834 ?>
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CheckPinNumberPrpdOrPopd&quot;" return="g_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Before Calling Check Pin for Prepaid or postpaid");
Session.g_breturnFromMain=true;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnInvite" start="114" event="OnInvite" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAlertInfo" type="string" pass="byref"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAnonymity" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strCallInfo" type="string" pass="byref"/>
        <parameter name="strContact" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentEncoding" type="string" pass="byref"/>
        <parameter name="strContentLanguage" type="string" pass="byref"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strExpires" type="string"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strInReplyTo" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strMinSE" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strPriority" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRemotePartyId" type="string" pass="byref"/>
        <parameter name="strReplaces" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSessionExpires" type="string" pass="byref"/>
        <parameter name="strSubject" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_b_A_re_INVITE" type="boolean" >0</var>
        <var name="f_b_B_re_INVITE" type="boolean" >0</var>
        <var name="f_b_New_A_SDP" type="boolean" >0</var>
        <var name="f_b_New_B_SDP" type="boolean" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bBLegConnectedNoMS" type="boolean" >0</var>
        <var name="f_bDuringOutdial" type="boolean" >0</var>
        <var name="bUsedTempLegForB" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="114" plug-in="Pactolus.Branch.1" ><?xtml-editor x=21 y=42 ?>
          <!--New Call?-->
          <results >
            <result name="Default" link="113" stubbed="0"/>
            <result name="g_bNewCall" link="127" stubbed="0" >g_bNewCall == true</result>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=959 y=19 ?>
          <!--send to Main function-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bAutoAniAccessNumber = isAutoAni( Session.g_oAPI.strAccessNumber) ;

Session.g_nCurrentState = Session.s_nINITIALIZE_SESSION;

]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Pactolus.Branch.1" ><?xtml-editor x=538 y=112 ?>
          <!--use object save incoming info s_strTestModeFlag==T-->
          <results >
            <result name="Default" link="126" stubbed="0"/>
            <result name="s_strTestModeFlag==T" link="124" stubbed="0" >s_strTestModeFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bNewCall = false;

Server.logInfo("CALLER CALL ID: " + Session.strCallId);

js_initAPI(Session.g_oAPI);
Session.g_oAPI.bSuppressOnHold = Session.s_bAppPropSuppressOnHold;
js_initACD(Session.g_oACD);
js_initBALXFER(Session.g_oBALXFER);
js_initCallLeg(Session.g_oCallLegA);
js_initCallLeg(Session.g_oCallLegB);
js_initACD(Session.g_oACD);
js_initCC(Session.g_oCC);
js_initMS(Session.g_oMS, Session.s_strMSType);
js_initRATE(Session.g_oRATE);
js_initSUB(Session.g_oSUB);
js_initSTB(Session.g_oSTB);
js_initMS(Session.g_oMOH, Session.s_strMSType);
js_initMS(Session.g_oConfMS, Session.s_strMSType);
js_initTimer(Session.g_oTimerPleaseHold);
Session.g_oTimerPleaseHold.lSleepTime = Session.s_nAppPropPleaseHoldInterval;



Session.g_oMS.strACDType = Session.s_strACDMediaServerType;
Session.g_oMS.strMOHType = Session.s_strMOHMediaServerType;
Session.g_oConfMS.strACDType = Session.s_strACDMediaServerType;
Session.g_oConfMS.strMOHType = Session.s_strMOHMediaServerType;

Session.g_oAPI.lPlatformSessionStartTime = Server.getUTCTime();
Session.g_oCallLegA.strAccept = Session.strAccept;
Session.g_oCallLegA.strAcceptEncoding = Session.strAcceptEncoding;
Session.g_oCallLegA.strAcceptLanguage = Session.strAcceptLanguage;
Session.g_oCallLegA.strAlertInfo = Session.strAlertInfo;
Session.g_oCallLegA.strAllow = Session.strAllow;
Session.g_oCallLegA.strAllowEvents = Session.strAllowEvents;
Session.g_oCallLegA.strAnonymity = Session.strAnonymity;
Session.g_oCallLegA.strAuthorization = Session.strAuthorization;
Session.g_oCallLegA.strCallId = Session.strCallId;
Session.g_oCallLegA.strCallInfo = Session.strCallInfo;
Session.g_oCallLegA.strContact = Session.strContact;
Session.g_oCallLegA.strContent = Session.strContent;
Session.g_oCallLegA.strContentDisposition = Session.strContentDisposition;
Session.g_oCallLegA.strContentEncoding = Session.strContentEncoding;
Session.g_oCallLegA.strContentLanguage = Session.strContentLanguage;
Session.g_oCallLegA.strContentType = Session.strContentType;
Session.g_oCallLegA.strCSeq = Session.strCSeq;
Session.g_oCallLegA.strDate = Session.strDate;
Session.g_oCallLegA.strEncryption = Session.strEncryption;
Session.g_oCallLegA.strErrorInfo = Session.strErrorInfo;
Session.g_oCallLegA.strExpires = Session.strExpires;
Session.g_oCallLegA.strFrom = Session.strFrom;
Session.g_oCallLegA.strInReplyTo = Session.strInReplyTo;
Session.g_oCallLegA.strMaxForwards = Session.strMaxForwards;
Session.g_oCallLegA.strMIMEVersion = Session.strMIMEVersion;
Session.g_oCallLegA.strMinSE = Session.strMinSE;
Session.g_oCallLegA.strOrganization = Session.strOrganization;
Session.g_oCallLegA.strPriority = Session.strPriority;
Session.g_oCallLegA.strProxyAuthorization = Session.strProxyAuthorization;
Session.g_oCallLegA.strProxyRequire = Session.strProxyRequire;
Session.g_oCallLegA.strRecordRoute = Session.strRecordRoute;
Session.g_oCallLegA.strReferredBy = Session.strReferredBy;
Session.g_oCallLegA.strRemotePartyId = Session.strRemotePartyId;
Session.g_oCallLegA.strReplaces = Session.strReplaces;
Session.g_oCallLegA.strRequestUri = Session.strRequestUri;
Session.g_oCallLegA.strRequire = Session.strRequire;
//Session.g_oCallLegA.strResponseKey = Session.strResponseKey;
Session.g_oCallLegA.strRoute = Session.strRoute;
Session.g_oCallLegA.strSessionExpires = Session.strSessionExpires;
Session.g_oCallLegA.strSubject = Session.strSubject;
Session.g_oCallLegA.strSupported = Session.strSupported;
Session.g_oCallLegA.strTimestamp = Session.strTimestamp;
Session.g_oCallLegA.strTo = Session.strTo;
Session.g_oCallLegA.strUserAgent = Session.strUserAgent;
Session.g_oCallLegA.strVia = Session.strVia;


//temporary platform work around: strAnonymity will actually be the P-Asserted-Identity field,
// if one is present.
Session.g_oCallLegA.strPAssertedIdentity = Session.strAnonymity;
//Another Temporary Work around for the Privacy Header, if present it will be in strResponseKey
Session.g_oCallLegA.strPrivacy = Session.strResponseKey;
//Ingress

var from_uri = new SipFrom( Session.strFrom ) ;

if (from_uri.url.host == undefined)
{
	Session.g_oAPI.strGWIPIngress = Session.s_strPrimaryPSX;
}
else
{
	Session.g_oAPI.strGWIPIngress = from_uri.url.host;
}
if (from_uri.url.port == undefined)
{
	Session.g_oAPI.nGWPortIngress = 5060;
}
else
{
	Session.g_oAPI.nGWPortIngress = from_uri.url.port;
}

if (from_uri.url.user == undefined)
{
	Session.g_oCallLegA.strFromUriUrlUser = "";
}
else
{
	Session.g_oCallLegA.strFromUriUrlUser = new String(from_uri.url.user);
}


//Egress

var contact = new SipNameAddr(Session.strContact);

if (contact.url.host == undefined)
{
	Session.g_oAPI.strGWIPEgress = Session.s_strPrimaryPSX;
}
else
{
	Session.g_oAPI.strGWIPEgress = contact.url.host;
}

if (contact.url.port == undefined)
{
	Session.g_oAPI.nGWPortEgress = 5060;
}
else
{
	Session.g_oAPI.nGWPortEgress = contact.url.port;
}

if(from_uri.url.otg != undefined) {
	Session.g_oCallLegA.strOrigTrunkGroup = from_uri.url.otg;
}

// Phone A object

Session.g_oCallLegA.bReverseFromTo = true;
Session.g_oCallLegA.bUac = false;
Session.g_oCallLegA.strOriginalContent = Session.strContent;
Session.g_oCallLegA.strRemoteSdp = Session.strContent;
Session.g_oCallLegA.strRemoteCSeq = Session.strCSeq;
Session.g_oCallLegA.nSessionTimer = Number(Session.strSessionExpires);
Session.g_oCallLegA.strOriginalTo = Session.strTo;
// Check to get Privacy if PAI is in place or remotParty ID
//Session.g_oCallLegA.strPrivacy = Session.strPrivacy; 
 var isPrivacy = Session.g_oCallLegA.strPrivacy.length ;
 Server.logInfo("Privacy Length = " + isPrivacy );
if ( isPrivacy <= 0 ) {
Session.g_oCallLegA.strPrivacy = js_get_privacy_from_remote_party_id(Session.strRemotePartyId);
}
Server.logInfo("PRIVACY after js_get_privacy = " + Session.g_oCallLegA.strPrivacy);
js_initTimer(Session.g_oTimerGSXA);
js_initTimer(Session.g_oTimerGSXB);

Session.g_oTimerGSXA.lSleepTime = Number(Session.strSessionExpires);
Session.g_oTimerGSXB.lSleepTime = Number(Session.strSessionExpires);

Server.logInfo("CALLING js_calculate_uri_and_route");
Server.logInfo("BEFORE contact: " + Session.g_oCallLegA.strContact);
Server.logInfo("BEFORE record route: " + Session.g_oCallLegA.strRecordRoute);
Server.logInfo("BEFORE request Uri: " + Session.g_oCallLegA.strRequestUri);
Server.logInfo("BEFORE route: " + Session.g_oCallLegA.strRoute);

var bDialIn = true;
js_calculate_uri_and_route(bDialIn, Session.s_strSIPVERSION, Session.g_oCallLegA.strFrom, Session.g_oCallLegA.strContact, Session.g_oCallLegA.strRecordRoute, Session.g_oCallLegA.strRequestUri, Session.g_oCallLegA.strRoute);

Server.logInfo("AFTER contact: " + Session.g_oCallLegA.strContact);
Server.logInfo("AFTER record route: " + Session.g_oCallLegA.strRecordRoute);
Server.logInfo("AFTER request Uri: " + Session.g_oCallLegA.strRequestUri);
Server.logInfo("AFTER route: " + Session.g_oCallLegA.strRoute);
Server.logInfo("Call leg A request Uri is: " + Session.g_oCallLegA.strRequestUri);
Session.g_oCallLegA.strRemoteUri = Session.g_oCallLegA.strRequestUri;
Server.logInfo("Call leg A remote Uri is: " + Session.g_oCallLegA.strRemoteUri);

Session.g_oCallLegA.nTearDownTime = 0;

if (Session.s_strSessionTimerFlag == "T")
{
	Session.g_oCallLegA.strSessionTimerFlag = Session.s_strSessionTimerFlag;
	Session.g_oCallLegA.nSessionTimer = Session.s_nSessionTimerInterval;
	Session.g_oCallLegA.lTimerGSXA_SleepTime = Session.s_nSessionTimerInterval;
	Server.logInfo(" Session.g_oCallLegA.lTimerGSXA_SleepTime = " + Session.g_oCallLegA.lTimerGSXA_SleepTime);
}
Server.lockSharedVariables();
js_set_ani_and_info_digits(Session.strFrom, Session.strRemotePartyId, Session.g_oCallLegA.strPAssertedIdentity.toString(), Session.s_strDEFAULT_ANI, Session.s_strAppPropCheckAniForInfoDigts, Session.s_bAppPropUseFromHeaderForAni, Session.g_oAPI.strOriginationNumber, Session.g_oCallLegA.strCallingNumber, Session.g_oAPI.strUsedDefaultANIFlag, Session.g_oAPI.strInfoDigits, Session.g_strAuthAniHost,Session.s_strCustomerCode);
Server.unlockSharedVariables();

//suppress-caller-id?
if ("T" == Session.s_strSuppressCallerId)
{
	Session.g_oCallLegA.strCallingNumber = "";
	Server.logInfo("SUPPRESS CALLER ID");
}
// get dnis
//DH: Request-URI is NOT a sup url; it contains a sip url
//var myUri = new SipUrl(Session.strRequestUri);
var myUri = new SipRequestUri(Session.strRequestUri) ;

//Session.g_oAPI.strAccessNumber = myUri.phoneNumber;
Session.g_oAPI.strAccessNumber = myUri.url.phoneNumber;

Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);
Server.logInfo("BEFORE strip non digit off access number: <" + Session.g_oAPI.strAccessNumber + " >");

Session.g_oAPI.strAccessNumber = js_strip_non_digits(Session.g_oAPI.strAccessNumber);

Server.logInfo("AFTER strip non digit off access number: <" + Session.g_oAPI.strAccessNumber + " >");

var myTo = new SipTo (Session.strTo);

Session.g_oAPI.strDestinationNumber = myTo.url.user;

// set server contact

if( Server.sipPort != 5060 )
{
 Session.g_strContact = "<sip:" + Session.s_strLocalHost + ":" + Server.sipPort + ">";
}
else
{
	Session.g_strContact = "<sip:" + Session.s_strLocalHost + ">";
}

// already build remote/request uri, set contact to appserver

Session.g_oCallLegA.strContact = Session.g_strContact;

Server.logInfo("PLATFORM SESSION ID:  " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("APPLICATION NAME:  " + Session._appName);

// Mediaserver object

Session.g_oMS.strContent = "";
Session.g_oMS.strCallId = "";
Session.g_oMS.strEndPoint = "";
Session.g_oMS.strConnectionId = "";
Session.g_oMS.strType = Session.s_strMSType;
Session.g_oMS.bCurrentlyConnected = false;
Session.g_oMS.nPacketizationPeriod = Session.s_nPacketizationPeriod;
Session.g_oMS.strCodec = Session.s_strCodec;

if (Session.s_strMSRetryFlag == "T")
{
	Session.g_oMS.bRetry = true;
}
else
{
	Session.g_oMS.bRetry = false;
}

if ( Session.s_bPlayChime ) {
	Session.g_nChimeOrSilence = 236;
}
else {
	Session.g_nChimeOrSilence = 220;
}]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=41 y=684 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="53" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=1020 y=251 ?>
          <!--500 Server Error-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 500 Server Internal Error"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="115" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("TEST MODE, BUT FAIL TO GET TEST DATA");
Server.logError("RESPONSE WITH 500 Server Error");
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="66" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=624 y=327 ?>
          <!--481 Transaction does not exist-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 481 Call Leg/Transaction Does Not Exist"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("ERROR: GET REINVITE BUT TRANSACTION DOES NOT EXIST.");

Server.logError("ERROR: FROM: " + Session.strFrom);

Server.logError("ERROR: TO: " + Session.strTo);

Server.logError("ERROR: CALL ID: " + Session.strCallId);

Server.logError("ERROR: CSEQ: " + Session.strCSeq);

Server.logError("ERROR: CONTENT: " + Session.strContent);]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Pactolus.Branch.1" ><?xtml-editor x=137 y=493 ?>
          <!--connected to ms?-->
          <results >
            <result name="Default" link="83" stubbed="0"/>
            <result name="bLegConnectedNoMS" link="121" stubbed="0" >f_bBLegConnectedNoMS == true</result>
            <result name="bDuringOutdial" link="90" stubbed="0" >f_bDuringOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[

if (0 == Clib.strcmpi(Session.strCallId, Session.g_oCallLegA.strCallId))
{
	Session.f_b_A_re_INVITE = true;
	var newCSeq = new SipCSeq(Session.strCSeq);
	var oldCSeq = new SipCSeq(Session.g_oCallLegA.strCSeq);
	
        if(newCSeq.value >= oldCSeq.value) 
	{
		newCSeq.increment() ;
		Session.g_oCallLegA.strCSeq = newCSeq.encode() ;
	}
	if (Clib.strcmpi(Session.strContent, Session.g_oCallLegA.strContent) != 0)
	{
		Session.f_b_New_A_SDP = true;
		Session.g_oCallLegA.strContent = Session.strContent;
		Session.g_oCallLegA.strOriginalContent = Session.strContent;
	}
}
else
{
		if(Session.g_nCurrentArrayIndex < 0 || Session.g_oArrayCallLegs.length == 0) {
			Server.logError("Received INVITE from B leg but index less than 0 OR array length == 0");
			Server.logError("g_nCurrentArrayIndex:" + Session.g_nCurrentArrayIndex);			
			Server.logError("g_oArrayCallLegs.length:" + Session.g_oArrayCallLegs.length);			
		}

		Session.f_b_B_re_INVITE = true;
		var newCSeq = new SipCSeq(Session.strCSeq);
		var oldCSeq = new SipCSeq(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCSeq);

		if(newCSeq.value >= oldCSeq.value) 
		{
			newCSeq.increment() ;
			Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCSeq = newCSeq.encode() ;
		}

		if (Clib.strcmpi(Session.strContent, Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContent) != 0)
		{
 		        Session.f_b_New_B_SDP = true;
			Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContent = Session.strContent;
		}
}

Session.f_bBLegConnectedNoMS = false;
Session.f_bDuringOutdial = false;

if(Session.g_oMS.bCurrentlyConnected == false) {

	if(Session.g_nCurrentArrayIndex >= 0 && Session.g_oArrayCallLegs.length > 0) {

		if(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bConnected == true) {

			Session.f_bBLegConnectedNoMS = true;

		} else if(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bConnected == false) {

			Session.f_bDuringOutdial = true;

		} // end if bConnected

	} // end index >= 0 && length > 0

} // bCurrentlyConnected == false

]]></script>
          </scripts>
        </action>
        <action id="83" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=384 y=432 ?>
          <!--200 OK SDP of MS-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <content >g_oMS.strContent</content>
            <content-type >s_strContentType</content-type>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="90" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=377 y=803 ?>
          <!--200 OK hold SDP A-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <content >g_oCallLegA.strContent</content>
            <content-type >s_strContentType</content-type>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="93" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1030 y=632 ?>
          <!--Hang Up Phone  B-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="96" stubbed="0"/>
          </results>
        </action>
        <action id="94" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1431 y=750 ?>
          <!--Re-originate-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();

Session.f_b_A_re_INVITE = false;

Session.f_b_B_re_INVITE = false;

Session.f_b_New_A_SDP = false;

Session.f_b_New_B_SDP = false;]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1261 y=627 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="118" stubbed="0"/>
            <result name="Success" link="94" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 9;
Session.f_nReturnCode = -50;]]></script>
          </scripts>
        </action>
        <action id="113" plug-in="Pactolus.Branch.1" ><?xtml-editor x=22 y=326 ?>
          <!--re-invite from A or B?-->
          <results >
            <result name="Default" link="66" stubbed="0"/>
            <result name="re-invite from A or B" link="81" stubbed="0" >strCallId match g_oCallLegA.strCallId
OR f_b_B_re_INVITE == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oCallLegA.strCallId != Session.strCallId) {
	Server.logInfo("Recieved ReInvite, was not from A leg. Determine which B leg.");
	Session.g_nCurrentArrayIndex = -1;
	Session.g_nCurrentArrayIndex = js_search_callid(Session.g_oArrayCallLegs, Session.strCallId);

	if(Session.g_nCurrentArrayIndex >= 0) {
		Session.f_b_B_re_INVITE = true;
	}
}]]></script>
          </scripts>
        </action>
        <action id="115" plug-in="Standard.EndSession.1" ><?xtml-editor x=37 y=748 ?></action>
        <action id="118" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1448 y=527 ?>
          <!--Hang Up Phone  A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="115" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="121" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=377 y=598 ?>
          <!--ProcessReInvite-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcessReInvite&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >f_b_A_re_INVITE</parameter>
            <parameter >f_b_New_A_SDP</parameter>
            <parameter >f_b_B_re_INVITE</parameter>
            <parameter >f_b_New_B_SDP</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTempLeg.oTimer</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oTempLeg</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTempLeg.oTimerGSX</parameter>
            <parameter >strContentType</parameter>
            <parameter >g_strContact</parameter>
            <parameter >strCallId</parameter>
            <parameter >strCSeq</parameter>
            <parameter >strTo</parameter>
            <parameter >strFrom</parameter>
            <parameter >strVia</parameter>
            <parameter >strSessionExpires</parameter>
          </function>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Send 481" link="66" stubbed="0" >f_nReturnCode == 1</result>
            <result name="-2" link="130" stubbed="0" >f_nReturnCode == -2</result>
            <result name="-3" link="132" stubbed="0" >f_nReturnCode == -3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bUsedTempLeg = false;
js_initCallLeg(Session.g_oTempLeg);

if(0 != Session.g_oArrayCallLegs.length && Session.f_b_B_re_INVITE) {

	Session.g_oTempLeg = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex];
	Session.g_bUsedTempLeg = true;

}
else if( 0 != Session.g_oArrayCallLegs.length && Session.f_b_A_re_INVITE ) {
	Session.g_oTempLeg = Session.g_oArrayCallLegs[0] ;
	Session.bUsedTempLegForB = true ;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.g_bUsedTempLeg) {

	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex] =	Session.g_oTempLeg;

}
if( Session.bUsedTempLegForB ) {
	Session.g_oArrayCallLegs[0] = Session.g_oTempLeg ;
}]]></script>
          </scripts>
        </action>
        <action id="123" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=859 y=722 ?>
          <!--StopTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="134" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();

]]></script>
          </scripts>
        </action>
        <action id="124" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=774 y=248 ?>
          <!--APIGetTestData-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;APIGetTestData&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oTEST</parameter>
          </function>
          <results >
            <result name="Default" link="53" stubbed="0"/>
            <result name="Success" link="126" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (0 == Session.f_nReturnCode)
{
	Session.g_oAPI.strOriginationNumber = Session.g_oTEST.strTestOriginationNumber;

	if (Session.g_oAPI.strOriginationNumber == "undefined" ||
		Session.g_oAPI.strOriginationNumber == undefined ||
		Session.g_oAPI.strOriginationNumber.length <= 0 ||
		Session.g_oAPI.strOriginationNumber.indexOf("restricted") != -1 ||
		Session.g_oAPI.strOriginationNumber.indexOf("Restricted") != -1	||
		Session.g_oAPI.strOriginationNumber.indexOf("RESTRICTED")  != -1)
	{
		Session.g_oAPI.strUsedDefaultANIFlag = "T";
		Session.g_oAPI.strOriginationNumber = Session.s_strDEFAULT_ANI;
		Session.g_oCallLegA.strCallingNumber = Session.s_strDEFAULT_ANI;
	}	

	Server.logInfo("BEFORE strip non digit off original number: <" + Session.g_oAPI.strOriginationNumber + " >");
	Session.g_oAPI.strOriginationNumber = js_strip_non_digits(Session.g_oAPI.strOriginationNumber);
	Server.logInfo("AFTER strip non digit off original number: <" + Session.g_oAPI.strOriginationNumber + " >");

	if("T" == Session.s_strAppPropCheckAniForInfoDigts) {
		Server.logInfo("Application property check-ani-for-infodigts is 'T', ignoring test info digits and using first 2 chars of the ANI for info digits.");
		Session.g_oAPI.strInfoDigits = Session.g_oAPI.strOriginationNumber.substring(0,2);
		Session.g_oCallLegA.strCallingNumber = 	Session.g_oAPI.strOriginationNumber.substring(2, strANI.length);
		Session.g_oAPI.strOriginationNumber  = 	Session.g_oAPI.strOriginationNumber.substring(2, strANI.length);
	} else {
		Session.g_oAPI.strInfoDigits = Session.g_oTEST.strTestInfoDigits;
	}			
}
else
{
	Server.logError("ERROR: FAIL TO GET TEST DATA");
}]]></script>
          </scripts>
        </action>
        <action id="125" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1008 y=137 ?>
          <!--"SingleStageDialing"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;SingleStageDialing&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
        </action>
        <action id="126" plug-in="Pactolus.Branch.1" ><?xtml-editor x=745 y=45 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="g_bSingleStageDialing" link="125" stubbed="0" >g_bSingleStageDialing == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var myString = new String(Session.g_oAPI.strDestinationNumber);
var myAccess = new String(Session.g_oAPI.strAccessNumber);
var myCode = new String();

// if this system is only supporting single stage dialing ... 
if (Session.s_bSingleStageDialing)
{
	// set the single stage dialing flag to true, the service provider code and 
	// clear the access number field ... we don't have to set the dest number 
	// seeing it's already in the correct form ...
	Session.g_bSingleStageDialing = true;
	Session.g_oAPI.strServiceProviderCode = Session.s_strServiceProviderCode;
	Session.g_oAPI.strAccessNumber = "";
}
// otherwise, check to see if we're checking the call treatment type to determine whether
// it's a single or two stage call ...
else if ("T" == Session.s_strReadCallTreatmentType)
{
	Server.logInfo("READ CALL TREATMENT TYPE IS T");

	if ('0' == myString.charAt(0) )
	{
		Server.logInfo("FIRST CHAR IS ZERO");
		Session.g_bSingleStageDialing = true;
		Server.logInfo("THIS IS SINGLE STAGE DIALING.  DESTINATION NUMBER IS: " + myString);

		if ("T" == Session.s_strReadSPCode)
		{	
			Server.logInfo("READ SERVICE PROVIDER CODE IS T");
			Session.g_oAPI.strServiceProviderCode = myString.substr(1, 4);
			Server.logInfo("SERVICE PROVIDER CODE IS: " + Session.g_oAPI.strServiceProviderCode);
			Session.g_oAPI.strDestinationNumber = myString.substr(5);
			Server.logInfo("DESTINATION NUMBER IS: " + Session.g_oAPI.strDestinationNumber);	
			Session.g_oAPI.strAccessNumber = "";
		}
		else
		{
			Server.logInfo("READ SERVICE PROVIDER CODE IS NOT T");
			if (Session.s_strAccessNumberFromURI == "T") {
				Server.logInfo("Using access number from URI.");
				Session.g_oAPI.strAccessNumber = myAccess.substr(1);
			} else {
			   Session.g_oAPI.strAccessNumber = myString.substr(1);
			}
			Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);		
		}
	}
	else //first char is not zero
	{
		Server.logInfo("FIRST CHAR IS NOT ZERO");
		Session.g_bSingleStageDialing = false;
		Server.logInfo("THIS IS NOT SINGLE STAGE DIALING.  DESTINATION NUMBER IS: " + myString);

		if ("T" == Session.s_strReadSPCode)
		{	
			Server.logInfo("READ SERVICE PROVIDER CODE IS T");
			myCode = myString.substr(1, 4);
			if ("0000" == myCode)
			{
				Server.logInfo("ZERO SERVICE PROVIDER CODE");

				if (Session.s_strAccessNumberFromURI == "T") {
				    Server.logInfo("Using access number from URI.");
				    Session.g_oAPI.strAccessNumber = myAccess.substr(5);
			    } else {
				    Session.g_oAPI.strAccessNumber = myString.substr(5);
				}    
				Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);			
			}
			else
			{
				Session.g_oAPI.strServiceProviderCode = myString.substr(1, 4);
				Server.logInfo("SERVICE PROVIDER CODE IS: " + Session.g_oAPI.strServiceProviderCode);
				Session.g_oAPI.strDestinationNumber = "";

		                if (Session.s_strAccessNumberFromURI == "T") {
				    Server.logInfo("Using access number from URI.");
				    Session.g_oAPI.strAccessNumber = myAccess.substr(5);
			    } else {
				    Session.g_oAPI.strAccessNumber = myString.substr(5);
				}
			}
		}
		else
		{
			Server.logInfo("READ SERVICE PROVIDER CODE IS NOT T");
			if (Session.s_strAccessNumberFromURI == "T") {
				Server.logInfo("Using access number from URI.");
				Session.g_oAPI.strAccessNumber = myAccess.substr(1);
			} else {
			        Session.g_oAPI.strAccessNumber = myString.substr(1);
			}
			Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);		
		}	

	} //end check first char
}
else //read call treatment is NOT T
{
	Session.g_bSingleStageDialing = false;

	if ("T" == Session.s_strReadSPCode)
	{	
		Server.logInfo("READ SERVICE PROVIDER CODE IS T");
		myCode = myString.substr(0, 4);

	        if ("0000" == myCode)
		{
			Server.logInfo("ZERO SERVICE PROVIDER CODE");
			if (Session.s_strAccessNumberFromURI == "T") {
				Server.logInfo("Using access number from URI.");
				Session.g_oAPI.strAccessNumber = myAccess.substr(4);
			} else {
				Session.g_oAPI.strAccessNumber = myString.substr(4);
			}
			Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);
	        }
	        else
		{
			Server.logInfo("NON ZERO SERVICE PROVIDER CODE");
			Session.g_oAPI.strServiceProviderCode = myCode;
			Server.logInfo("SERVICE PROVIDER CODE IS: " + Session.g_oAPI.strServiceProviderCode);
			Session.g_oAPI.strAccessNumber = myString.substr(4);
		    Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);			
		}
	}
	else
	{
		Server.logInfo("READ SERVICE PROVIDER CODE IS NOT T");
		if (Session.s_strAccessNumberFromURI == "T") {
			Server.logInfo("Using access number from URI.");
			Session.g_oAPI.strAccessNumber = myAccess;
		} else {
		    Session.g_oAPI.strAccessNumber = myString;
		}
		Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);		
	}
}]]></script>
          </scripts>
        </action>
        <action id="127" plug-in="Pactolus.Branch.1" ><?xtml-editor x=216 y=151 ?>
          <!--use object save incoming info s_strTestModeFlag==T-->
          <results >
            <result name="Default" link="28" stubbed="0"/>
            <result name="s_strTestModeFlag==T" link="128" stubbed="0" >s_strTestModeFlag match "T"</result>
          </results>
        </action>
        <action id="128" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=350 y=24 ?>
          <!--APIGetTestInviteData-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;APIGetTestInviteData&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oTEST</parameter>
          </function>
          <results >
            <result name="Default" link="28" stubbed="0"/>
            <result name="Success" link="28" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_initTEST(Session.g_oTEST);
Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (0 == Session.f_nReturnCode)
{
	Session.strTo   = Session.g_oTEST.strTestToField;
	Session.strFrom = Session.g_oTEST.strTestFromField;
	Server.logInfo("Session to field = " + Session.strTo);
	Server.logInfo("Session from field = " + Session.strFrom);
}
else
{
	Server.logError("ERROR: FAIL TO GET TEST INVITE DATA");
}]]></script>
          </scripts>
        </action>
        <action id="130" plug-in="Pactolus.Branch.1" ><?xtml-editor x=707 y=531 ?>
          <!--If last leg, need to stop all timers, if not only stop this leg's timers-->
          <results >
            <result name="Default" link="131" stubbed="0"/>
            <result name="oArrayCallLegs.length = 1" link="123" stubbed="0" >g_oArrayCallLegs.length == 1</result>
          </results>
        </action>
        <action id="131" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=928 y=486 ?>
          <!--StopBLegTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopBLegTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimer</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimerGSX</parameter>
          </function>
          <results >
            <result name="Default" link="93" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();]]></script>
          </scripts>
        </action>
        <action id="132" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=682 y=909 ?>
          <!--ProcTerminateConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcTerminateConf&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="133" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();

Session.g_oAPI.nCallTerminationReason = 9;

Session.g_oAPI.nSessionTerminationReason = 11;]]></script>
          </scripts>
        </action>
        <action id="133" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=902 y=916 ?>
          <!--Hang Up Phone  A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="115" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="134" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1026 y=770 ?>
          <!--StopOneTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopOneTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="93" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="InitializeSession" start="85" event="InitializeSession" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nLanguageMenuPrompt" type="i4" >4163</var>
        <var name="f_nInvalidAccessNumberPrompt" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="85" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=36 y=48 ?>
          <!--psAPIInitializeSession-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIInitializeSession&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="Success, bCallback" link="72" stubbed="1" >f_nReturnCode == s_sSUCCESS

AND g_oAPI.bANCallbackFlag == true</result>
            <result name="Fail, bCallback" link="95" stubbed="1" >f_nReturnCode != 0
AND g_oAPI.bANCallbackFlag == true</result>
            <result name="Success, Shared Access" link="97" stubbed="0" >f_nReturnCode == s_sSUCCESS
AND g_oAPI.bSharedAccessNumber  == true</result>
            <result name="Success" link="90" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="-2, -4, -5, -6, -8, -7, -9,Shared Access Number" link="83" stubbed="0" >(f_nReturnCode == -2
OR f_nReturnCode == -4
OR f_nReturnCode == -5
OR f_nReturnCode == -6
OR f_nReturnCode == -8
OR f_nReturnCode == -7
OR f_nReturnCode == -9)
AND g_oAPI.bSharedAccessNumber  == true</result>
            <result name="-2, -4, -5, -6, -8, -7, -9" link="96" stubbed="0" >f_nReturnCode == -2
OR f_nReturnCode == -4
OR f_nReturnCode == -5
OR f_nReturnCode == -6
OR f_nReturnCode == -8
OR f_nReturnCode == -7
OR f_nReturnCode == -9</result>
            <result name="-3, Invalid Access Number" link="109" stubbed="0" >f_nReturnCode == -3</result>
            <result name="-11 - Shared Access Number" link="107" stubbed="0" >f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");

Server.logInfo("InitializeSession returned " + Session.f_nReturnCode);
Session.g_sMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;

if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != -11)
{
	Server.logError("ERROR: FAIL TO CALL JAVA INITIALIZE SESSION, EXIT ON: " + Result.name);
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1002; //bad ani
			Session.g_oAPI.nSessionTerminationReason = 9;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 2;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1004; //service disable
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 0; // INvalid ANI
			break;						
		case -9:
			Session.g_nErrorMsgNumber = 0; // No Available Sessions
			Server.logInfo("No Available Sessions - End Call.");
			break;		
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
        }
} else {

	if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "" || Session.g_oAPI.strThirdPartyOutdialNumber != "") {

		Session.g_oACD.strPinZeroOut = "T";
		Session.g_oACD.strLanguageMenuZeroOut = "T";
		Session.g_oACD.strMainMenuZeroOut = "T";		

		if("goldline" == Session.s_strCustomerCode) {

			Session.g_oACD.strLanguageMenuZeroOut = "F";
		} else {
			Session.g_oACD.strLanguageMenuZeroOut = "T";
		}		

		if(Session.g_oACD.strEnableFlag == "T") {
			if(Session.g_oACD.strCSROnMaxLoginsEnabled == "T") {
				Session.g_oACD.strPinMaxTimeouts = "T";		
				Session.g_oACD.strPinMaxInvalids = "T";
				Session.g_oACD.strMainMenuMaxInvalids = "T";
				Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
			}
		} else if(Session.g_oAPI.strCustomerServicePhone != "") {
				Session.g_oACD.strPinMaxTimeouts = "T";		
				Session.g_oACD.strPinMaxInvalids = "T";
				Session.g_oACD.strMainMenuMaxInvalids = "T";
				Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
		}// end if 

		// Settings Based on Customer
		Session.g_oACD.strDestMaxInvalids = "F";
		Session.g_oACD.strDestMaxTimeouts = "F";
		Session.g_oACD.strDestZeroOut = "F";		
			
		Session.g_oACD.strMainMenuMaxTimeouts = "F";
		Session.g_oACD.strLanguageMenuMaxTimeouts = "F";	
	
		if(Session.s_strCustomerCode == "goldline") {
			Session.g_oACD.strLanguageMenuMaxInvalids = "F";		
		}

	} // end strEnableFlag		
} // end return code

Server.logInfo("g_oACD.strPinZeroOut " + Session.g_oACD.strPinZeroOut);
Server.logInfo("g_oACD.strLanguageMenuZeroOut " + Session.g_oACD.strLanguageMenuZeroOut);
Server.logInfo("g_oACD.strMainMenuZeroOut " + Session.g_oACD.strMainMenuZeroOut);
Server.logInfo("g_oACD.strPinMaxTimeouts " + Session.g_oACD.strPinMaxTimeouts);
Server.logInfo("g_oACD.strPinMaxInvalids " + Session.g_oACD.strPinMaxInvalids);

Server.logInfo("g_oACD.strMainMenuMaxInvalids " + Session.g_oACD.strMainMenuMaxInvalids);
Server.logInfo("g_oACD.strLanguageMenuMaxInvalids " + Session.g_oACD.strLanguageMenuMaxInvalids);
Server.logInfo("g_oACD.strDestMaxInvalids " + Session.g_oACD.strDestMaxInvalids);
Server.logInfo("g_oACD.strDestMaxTimeouts " + Session.g_oACD.strDestMaxTimeouts);
Server.logInfo("g_oACD.strDestZeroOut " + Session.g_oACD.strDestZeroOut);
Server.logInfo("g_oACD.strMainMenuMaxTimeouts " + Session.g_oACD.strMainMenuMaxTimeouts);
Server.logInfo("g_oACD.strLanguageMenuMaxTimeouts " + Session.g_oACD.strLanguageMenuMaxTimeouts);

Session.g_oSUB.strPinLanguage = Session.g_oAPI.strLanguage;

if(Session.g_oAPI.bANCallbackFlag) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegAccessNbrIniatedCallback;
	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strAccessNumCallback;
}

if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD) {
	Session.g_oAPI.strPostPaidFlag = "T";
	Session.g_oACD.lCSRRequestSkillId = 3;
	
	if (0 == Session.g_oAPI.nAccountNumLength) 	{
		Session.g_oSUB.strDigitMapAccountNbr = "(xxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {

		var temp_digits = "(";

		for (var i = 0; i < Session.g_oAPI.nAccountNumLength; i++) 	{

			temp_digits += "x";

		}

		Session.g_oSUB.strDigitMapAccountNbr = temp_digits + "|x.T|x.#|xx.*|*x)";

	}	
	if (0 == Session.g_oAPI.nPostpaidPinLength) {

		Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {

		var temp_digits = "(";

		for (var i = 0; i < Session.g_oAPI.nPostpaidPinLength; i++) 	{
			temp_digits += "x";
		}
		Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
	}

	if(Session.g_oSUB.strAccountNumber.length > 0 && Session.g_oSUB.strUserPin.length > 0) {

		Session.g_oAPI.strValidateByANI = "1";
		Session.g_bValidateByANI = true;
		Session.g_oSUB.strUserPin = Session.g_oSUB.strAccountNumber + Session.g_oSUB.strUserPin;
		Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;
	} else if(Session.g_oSUB.strAccountNumber.length > 0 && Session.g_oSUB.strUserPin.length <= 0) {

		Session.g_oAPI.strValidateByANI = "2";
		Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;		
		Session.g_bGetPinOnly = true;
		// Will need to get pin only
	} else {
		// Will need to get account number and pin
	}

} else if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD) {



	Session.g_oACD.lCSRRequestSkillId = 1;



	if (0 == Session.g_oAPI.nPrepaidPinLength) {

		Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";

	} else {

		var temp_digits = "(";

		for (var i = 0; i < Session.g_oAPI.nPrepaidPinLength; i++) 	{

			temp_digits += "x";

		}

		Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";

	}

        Session.g_oAPI.strValidateByANI = "0";
	if(Session.g_oSUB.strUserPin.length > 0) {

                Session.g_oAPI.strValidateByANI = "1";
		Session.g_bValidateByANI = true;

	}



} else {

	Server.logError("Service Element Id is unknown.");

}
Session.g_oCallLegA.strFrom = js_check_to_strip_oli(Session.g_oAPI.strInfoDigits, Session.g_oAPI.strOlisToStrip, Session.g_oCallLegA.strFrom);

]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=599 y=769 ?>
          <!--s_nSTATE_GET_PIN_PRPD_OR_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_GET_PIN_PRPD_OR_POPD"/>
        </action>
        <action id="34" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=326 y=238 ?>
          <!--503 service unavailable-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 503 Service Unavailable"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="65" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("ERROR: INITIALIZE SESSION FAILS, RESPONSE 503 SERVICE UNAVAILABLE");

var myTo = new SipTo(Session.g_oCallLegA.strTo);

if (undefined == myTo.tag)
{
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strTo + ";tag=" + Server.getUTCTime();

}]]></script>
          </scripts>
        </action>
        <action id="59" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=766 y=90 ?>
          <!--send JAVA ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="101" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "JAVA: initialize session";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=817 y=235 ?>
          <!--send MEDIASERVER ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="84" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: connect caller to ms";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Pactolus.Branch.1" ><?xtml-editor x=516 y=92 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="105" stubbed="0"/>
            <result name="s_strSendAlarmFlag==T" link="59" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="65" plug-in="Pactolus.Branch.1" ><?xtml-editor x=565 y=232 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="84" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="61" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="71" plug-in="Pactolus.Branch.1" ><?xtml-editor x=16 y=624 ?>
          <results >
            <result name="Default" link="72" stubbed="0"/>
            <result name="ACD.strGreetEnabled" link="89" stubbed="0" >g_oACD.strGreetEnabled match "T"</result>
            <result name="languagePrompt?" link="94" stubbed="0" >g_oAPI.strPromptLanguageMenuUrl.length &gt; 0



OR g_oAPI.nPromptLanguageMenuIndex &gt; 0</result>
            <result name="!bValidateByANI" link="113" stubbed="0" >g_bValidateByANI == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_oSUB.strUserPin.length <= 0)

	Session.g_bNullFlag = true;

else
{
	Session.g_bNullFlag = false;
	Session.g_bValidateByANI = true;
}
]]></script>
          </scripts>
        </action>
        <action id="72" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=16 y=768 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.bANCallbackNoAniCollectPin && (Session.g_oAPI.strUsedDefaultANIFlag == "T" || Session.g_oSUB.strUserPin.length <=0)) {
	Session.g_oAPI.bCollectPinForCallback = true;
	Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
	Session.g_nPromptToPlay = Session.s_nPROMPT_CONNECTING_CALL; // Please hold while your call is connected.
	Server.logInfo("SET THE CURRENT STATE TO *** INITIATE ACCESS NUMBER CALL BACK *** ");
} else {
	Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
	Server.logInfo("SET THE CURRENT STATE TO *** AUTHENTICATE_PIN *** ");	
	
}
]]></script>
          </scripts>
        </action>
        <action id="73" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=277 y=91 ?>
          <!--send alert db error-->
          <user-function xmlns="www.pactolus.com:xtml:application" process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"dbase-error"</parameter>
          </user-function>
          <results >
            <result name="Default" link="63" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=17 y=947 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="84" stubbed="0"/>
          </results>
        </action>
        <action id="84" plug-in="Standard.EndSession.1" ><?xtml-editor x=453 y=950 ?></action>
        <action id="87" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=572 y=573 ?>
          <!--RouteToCSR-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;RouteToCSR&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="83" stubbed="1"/>
            <result name="Success" link="88" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
Session.g_oACD.nCSRRouteReasonCode = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;  //call assistant, zero out or greeting
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="88" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=828 y=610 ?>
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="89" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=316 y=535 ?>
          <!--please hold for csr-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1501</audio>
          </play>
          <results >
            <result name="Default" link="87" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="90" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=32 y=320 ?>
          <!--direct caller to MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DirectCallerToMS&quot;" return="f_nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="34" stubbed="0"/>
            <result name="Success" link="97" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="84" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
	Session.g_bFailToConnectToMS = true;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
	Session.g_bFailToConnectToMS = true;
}
else
{
	Session.g_bSentFinalResponse = true;
}]]></script>
          </scripts>
        </action>
        <action id="94" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=423 y=695 ?>
          <!--return s_nSTATE_LANGUAGE_MENU-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_LANGUAGE_MENU"/>
        </action>
        <action id="95" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=14 y=863 ?>
          <!--s_nSTATE_INIT_AN_CALLBACK-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_INIT_AN_CALLBACK"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nPromptToPlay = 283; //The system cannot call you back at this number.

]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1211 y=88 ?>
          <!--direct caller to MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DirectCallerToMS&quot;" return="f_nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="84" stubbed="1"/>
            <result name="Success" link="83" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="84" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_bFailToConnectToMS = true;
}
else if (3 == Result.id)
{
	Session.g_bFailToConnectToMS = true;
}
else
{
	Session.g_bSentFinalResponse = true;
}]]></script>
          </scripts>
        </action>
        <action id="97" plug-in="Pactolus.Branch.1" ><?xtml-editor x=332 y=397 ?>
          <!--delay?-->
          <results >
            <result name="Default" link="99" stubbed="0"/>
            <result name="s_fPreStartCallDelay &gt; 0" link="98" stubbed="0" >s_fPreStartCallDelay &gt; 0.0</result>
          </results>
        </action>
        <action id="98" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=578 y=393 ?>
          <!--s_fPreStartCallDelay-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >s_fPreStartCallDelay</audio>
          </play>
          <results >
            <result name="Default" link="99" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing silence for Precall Start Delay. Session.s_fPreStartCallDelay: " + Session.s_fPreStartCallDelay);
}]]></script>
          </scripts>
        </action>
        <action id="99" plug-in="Pactolus.Branch.1" ><?xtml-editor x=101 y=432 ?>
          <!--Is Direct Call?-->
          <results >
            <result name="Default" link="106" stubbed="0"/>
            <result name="Direct Call" link="100" stubbed="0" >g_oAPI.bANDirectCallFlag == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Direct Call Flag = " + Session.g_oAPI.bANDirectCallFlag);]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.g_oAPI.bANDirectCallFlag == true) 



{



    Session.g_bDirectCallFlag = true;



    Session.g_oSUB.strDirectCallDigitMap = "(xxxxxxxxxxxx|x.T|x.#|xx.*|*x)";



}]]></script>
          </scripts>
        </action>
        <action id="100" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=17 y=1032 ?>
          <!--s_nGET_DIRECT_CALLID-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_DIRECT_CALLID"/>
        </action>
        <action id="101" plug-in="Pactolus.Branch.1" ><?xtml-editor x=994 y=108 ?>
          <results >
            <result name="Default" link="105" stubbed="0"/>
            <result name="invalid access number" link="109" stubbed="0" >f_nReturnCode == -3</result>
          </results>
        </action>
        <action id="102" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1496 y=292 ?>
          <!--ConnectWithOneWayMedia-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ConnectWithOneWayMedia&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >f_nInvalidAccessNumberPrompt</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
          </function>
          <results >
            <result name="Default" link="84" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Session.f_nInvalidAccessNumberPrompt = 322;]]></script>
          </scripts>
        </action>
        <action id="103" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1184 y=371 ?>
          <results >
            <result name="Default" link="102" stubbed="0"/>
            <result name="Answer Call" link="104" stubbed="0" >s_strAnswerInvalidAccessNumber == "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Answer Invalid Access Number = " + Session.s_strAnswerInvalidAccessNumber);
Server.logInfo("Invalid Access Number Prompt = " + Session.s_nInvalidAccessNumberPrompt);

Session.f_nInvalidAccessNumberPrompt = 322;

if(Session.s_nInvalidAccessNumberPrompt > 0) {
	  Session.f_nInvalidAccessNumberPrompt = Session.s_nInvalidAccessNumberPrompt
}]]></script>
          </scripts>
        </action>
        <action id="104" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1500 y=445 ?>
          <!--ConnectWithAnswer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ConnectWithAnswer&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >f_nInvalidAccessNumberPrompt</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
          </function>
          <results >
            <result name="Default" link="84" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Session.f_nInvalidAccessNumberPrompt = 322;]]></script>
          </scripts>
        </action>
        <action id="105" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=1448 y=22 ?>
          <!--503 service unavailable-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 503 Service Unavailable"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="84" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("ERROR: INITIALIZE SESSION FAILS, RESPONSE 503 SERVICE UNAVAILABLE");

var myTo = new SipTo(Session.g_oCallLegA.strTo);

if (undefined == myTo.tag)
{
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strTo + ";tag=" + Server.getUTCTime();

}]]></script>
          </scripts>
        </action>
        <action id="106" plug-in="Pactolus.Branch.1" ><?xtml-editor x=32 y=529 ?>
          <results >
            <result name="Default" link="71" stubbed="1"/>
            <result name="payPhoneSwipeFlag &amp; noPin" link="113" stubbed="0" >g_oAPI.bPayPhoneSwipeFlag  == true
AND g_bNullFlag == true</result>
            <result name="payPhoneSwipeFlag &amp; hasPin" link="72" stubbed="0" >g_oAPI.bPayPhoneSwipeFlag  == true
AND g_bNullFlag == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_oSUB.strUserPin.length <= 0)
	Session.g_bNullFlag = true;
else
	Session.g_bNullFlag = false;
	
if (0 == Session.g_oAPI.nPrepaidPinLength || Session.g_oAPI.bPayPhoneSwipeFlag)
{
	Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
}
Server.logInfo("PAYPHONE SWIPE BRANCH");
Server.logInfo("Session.g_oAPI.bPayPhoneSwipeFlag <"+Session.g_oAPI.bPayPhoneSwipeFlag+">");
Server.logInfo("Session.g_bNullFlag <"+Session.g_bNullFlag+">");]]></script>
          </scripts>
        </action>
        <action id="107" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=707 y=704 ?>
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CheckPinNumberPrpdOrPopd&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="108" stubbed="0"/>
          </results>
        </action>
        <action id="108" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=882 y=705 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Before Calling Initialize Session");
Server.logInfo("Current State"+Session.g_nCurrentState);]]></script>
          </scripts>
        </action>
        <action id="109" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1125 y=265 ?>
          <results >
            <result name="Default" link="103" stubbed="0"/>
          </results>
        </action>
        <action id="111" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=605 y=851 ?>
          <!--RegisterAutoAni-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;RegisterAuthAni&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="112" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Call was made on an auto-ANI access number with an unrecognized ANI; try to register this ANI") ;]]></script>
          </scripts>
        </action>
        <action id="112" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=845 y=851 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
        </action>
        <action id="113" plug-in="Pactolus.Branch.1" ><?xtml-editor x=265 y=800 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="auto ANI access number" link="111" stubbed="0" >g_bAutoAniAccessNumber == true</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="AuthenticatePin" start="117" event="AuthenticatePin" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bRequestCSR" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bNull" type="boolean" >0</var>
        <var name="f_strCollectedDigits" type="string" ></var>
        <var name="nAskForAniRegCount" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="117" plug-in="Pactolus.Branch.1" ><?xtml-editor x=12 y=24 ?>
          <results >
            <result name="Default" link="102" stubbed="0"/>
            <result name="Callback" link="116" stubbed="1" >g_oAPI.bANCallbackFlag == true
AND g_oAPI.bCollectPinForCallback == false</result>
          </results>
        </action>
        <action id="15" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1860 y=34 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
        </action>
        <action id="42" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1123 y=29 ?>
          <!--play balance?-->
          <results >
            <result name="Default" link="125" stubbed="0"/>
            <result name="g_oSUB.strPlayBalanceFlag==&quot;T&quot;" link="124" stubbed="0" >g_oSUB.strPlayBalanceFlag match "T"</result>
          </results>
        </action>
        <action id="47" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=883 y=118 ?>
          <!--Post Pin Prompt URL-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strPostPinPromptUrl</audio>
          </play>
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="76" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=35 y=1161 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="77" stubbed="0"/>
          </results>
        </action>
        <action id="77" plug-in="Standard.EndSession.1" ><?xtml-editor x=317 y=1196 ?></action>
        <action id="84" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=794 y=439 ?>
          <!--get pin again-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_PIN"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Make shared access number false after we determine prepaid/postpaid

Session.g_oAPI.bSharedAccessNumber=false;]]></script>
          </scripts>
        </action>
        <action id="85" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=337 y=517 ?>
          <!--507-low balance-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="97" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="86" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1028 y=598 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="89" plug-in="Pactolus.Branch.1" ><?xtml-editor x=646 y=23 ?>
          <!--g_oAPI.strPostPinPromptType = U or I-->
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="g_oAPI.strPostPinPromptType==U" link="47" stubbed="0" >g_oAPI.strPostPinPromptType match "U"</result>
            <result name="g_oAPI.strPostPinPromptType==I" link="90" stubbed="0" >g_oAPI.strPostPinPromptType match "I"
AND g_oAPI.nPostPinPromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="90" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=899 y=271 ?>
          <!--post pin prompt index-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nPostPinPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="92" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=325 y=398 ?>
          <!--g_nPromptToPlay-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="93" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=598 y=713 ?>
          <!--reason prompt-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="returnCode = 8" link="110" stubbed="1" >f_nReturnCode == 8</result>
          </results>
        </action>
        <action id="94" plug-in="Pactolus.Branch.1" ><?xtml-editor x=561 y=420 ?>
          <!--max retry-->
          <results >
            <result name="Default" link="110" stubbed="1"/>
            <result name="nNumRetry&lt;oAPI.nMaxLoginAttempts" link="84" stubbed="0" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;	
}]]></script>
          </scripts>
        </action>
        <action id="95" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=480 y=862 ?>
          <!--pin in used-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >338</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="97" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=530 y=552 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="Success" link="123" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);

if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Server.logError("FAIL TO GET RECHARGE SETTINGS");
	Session.g_nErrorMsgNumber = 1000; //jvm server error
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="102" plug-in="Pactolus.Branch.1" ><?xtml-editor x=14 y=156 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Misdial" link="94" stubbed="1" >f_bMissDial == true</result>
            <result name="Request CSR" link="110" stubbed="1" >f_bRequestCSR == true</result>
            <result name="Null" link="92" stubbed="1" >f_bNull == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oSUB.strUserPin.length <= 0) {

	Session.g_nPromptToPlay = 552; // I did not hear a response.
	Session.f_bNull = true;
	Session.g_oAPI.nSessionTerminationReason = 6;
	Session.g_nErrorMsgNumber = 1012; //max retry

} else if("*" == Session.g_strTerminationDigit || "*" == Session.g_oSUB.strUserPin) {

	Session.f_bMissDial = true;

} else if("0" == Session.g_oSUB.strUserPin && Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strTwoStageDialing) {

	Session.f_bRequestCSR = true;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinZeroOut;
}

Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
        <action id="110" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=29 y=1078 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oSUB.strUserPin = "";
Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;]]></script>
          </scripts>
        </action>
        <action id="113" plug-in="Pactolus.Branch.1" ><?xtml-editor x=297 y=301 ?>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="g_bValidateByANI" link="84" stubbed="1" >g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_bValidateByANI = false;
	Session.g_oSUB.strUserPin = "";
}]]></script>
          </scripts>
        </action>
        <action id="114" plug-in="Pactolus.Branch.1" ><?xtml-editor x=317 y=749 ?>
          <results >
            <result name="Default" link="93" stubbed="0"/>
            <result name="g_bValidateByANI" link="84" stubbed="1" >g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_bValidateByANI = false;
	Session.g_oSUB.strUserPin = "";
}]]></script>
          </scripts>
        </action>
        <action id="115" plug-in="Pactolus.Branch.1" ><?xtml-editor x=308 y=852 ?>
          <results >
            <result name="Default" link="95" stubbed="0"/>
            <result name="g_bValidateByANI" link="84" stubbed="1" >g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_bValidateByANI = false;
	Session.g_oSUB.strUserPin = "";
}]]></script>
          </scripts>
        </action>
        <action id="116" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=27 y=906 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="120" stubbed="0"/>
            <result name="Get Dest" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Get Pin Again" >f_nReturnCode == 6</result>
            <result name="Recharge" >f_nReturnCode == 1</result>
            <result name="Play Reason" >f_nReturnCode == 3
OR f_nReturnCode == 4
OR f_nReturnCode == 7
OR f_nReturnCode == 8
OR f_nReturnCode == 10
OR f_nReturnCode == 11
OR f_nReturnCode == 12</result>
            <result name="Pin Locked" >f_nReturnCode == 5</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);


js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();

// Default to Auth Dest. If we fail here, we will set this to s_nSTATE_INIT_AN_CALLBACK.
Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;

Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}


if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK; //The system cannot call you back at this number

	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			//Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				//Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				//Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;							
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //inactive pin
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;					
		case 15:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.g_nPromptToPlay = 1253;
			break;	
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {


	Session.g_nPromptToPlay = Session.s_nPROMPT_CALLBACK; // The system will call you back shortly.

}
]]></script>
          </scripts>
        </action>
        <action id="118" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=508 y=1022 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("This is An Aleg Callback. Turning setting AlegRatingOn to <true>");
Session.g_oAPI.bALegRatingOn = true;]]></script>
          </scripts>
        </action>
        <action id="119" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=261 y=25 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="122" stubbed="0"/>
          </results>
        </action>
        <action id="120" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=238 y=1013 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
        </action>
        <action id="121" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=857 y=703 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="86" stubbed="0"/>
          </results>
        </action>
        <action id="122" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=312 y=154 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="Success" link="130" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);

if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Server.logError("FAIL TO GET RECHARGE SETTINGS");
	Session.g_nErrorMsgNumber = 1000; //jvm server error
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="123" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=787 y=551 ?>
          <!--ProcLowBalance-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcLowBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="121" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bOutOfMoney = true;]]></script>
          </scripts>
        </action>
        <action id="124" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1226 y=188 ?>
          <!--call playPrepaidBalance()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPrepaidBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="125" stubbed="0"/>
          </results>
        </action>
        <action id="125" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1388 y=33 ?>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="oAPI.bBlindCallback" link="126" stubbed="0" >g_oAPI.bBlindCallback == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {
	if(Session.g_oAPI.bCollectPinForCallback) {
		Session.g_nCurrentState = Session.s_nSTATE_CALLBACK_MAINT;
	} else {
		Session.g_nCurrentState = Session.s_nGET_DESTINATION;
	}
}



]]></script>
          </scripts>
        </action>
        <action id="126" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1493 y=161 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="129" stubbed="0" >f_nReturnCode == 0



OR f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination for A Leg *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);

Session.g_bALegRatingOn = true;
Session.g_oAPI.bALegCallback = true;	]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("AuthorizeDest for A Leg returned " + Session.f_nReturnCode);

Session.g_nPromptToPlay = 0;

if (Session.f_nReturnCode != 0)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;

		case -3:

			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;

		case -4:

			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;

		case -5:

			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;

		case -6:

			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;

		case -7:

			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;

		case -8: // Not in Phone Me List

			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	

		case -9:

			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;

		case -50:

			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;

		default:

			Session.g_nErrorMsgNumber = 0;
			break;
	}
} 
Server.logInfo("g_oCallLegA.oRATE.fAlegMeteredRate" + Session.g_oCallLegA.oRATE.fAlegMeteredRate);]]></script>
          </scripts>
        </action>
        <action id="129" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1699 y=170 ?>
          <!--StartALegTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartALegTimer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="nSecondsAvailable &gt; 0" link="15" stubbed="0" >g_oSUB.nSecondsAvailable &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_strC2DCalledNumber.length > 0) {

	Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;
	Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
} else {
	Session.g_nCurrentState = Session.s_nGET_DESTINATION;
}

Server.logInfo("Need to recalculate time available from A leg.");
Server.logInfo("Original Max A Leg Time Allowed: " + Session.g_oSUB.nSecondsAvailable);
var lALegTimeInSeconds = Server.getUTCTime() - Session.g_oCallLegA.lTimeAnswered;
Server.logInfo("A Leg has been up for <"+lALegTimeInSeconds+">. Need to subtract this from the time available from the A leg.");
Session.g_oSUB.nSecondsAvailable = Session.g_oSUB.nSecondsAvailable - lALegTimeInSeconds;
Server.logInfo("New Max A Leg Time Allowed: " + Session.g_oSUB.nSecondsAvailable);

if(Session.g_oSUB.nSecondsAvailable <= 0) { 
	Server.logInfo("No more A leg time availabe after the sub was authenticated and callback number authorized.");
}]]></script>
          </scripts>
        </action>
        <action id="130" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=545 y=236 ?>
          <!--PlayBrandingPrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptFirstUseType</parameter>
            <parameter >g_oAPI.nPromptFirstUseIndex</parameter>
            <parameter >g_oAPI.strPromptFirstUseUrl</parameter>
          </function>
          <results >
            <result name="Default" link="89" stubbed="0"/>
          </results>
        </action>
        <action id="131" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=18 y=292 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="113" stubbed="1"/>
            <result name="Get Dest" link="119" stubbed="1" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Get Pin Again" link="92" stubbed="1" >f_nReturnCode == 6</result>
            <result name="Recharge" link="85" stubbed="1" >f_nReturnCode == 1</result>
            <result name="Play Reason" link="114" stubbed="1" >f_nReturnCode == 3
OR f_nReturnCode == 4
OR f_nReturnCode == 7
OR f_nReturnCode == 8
OR f_nReturnCode == 10
OR f_nReturnCode == 11
OR f_nReturnCode == 12</result>
            <result name="Pin Locked" link="115" stubbed="1" >f_nReturnCode == 5</result>
            <result name="Add ANI Request" link="132" stubbed="1" >f_nReturnCode == 16</result>
            <result name="Call From unauthorized ANI" link="133" stubbed="1" >f_nReturnCode == 15</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);
Session.nAskForAniRegCount = 0;
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();

Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}

Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				Session.g_nPromptToPlay = 506;
			}
			Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;
			Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;			
			Session.g_oAPI.nSessionTerminationReason = 3;
			if ( Session.s_bSuppressCallCSPrompt ) {
				Session.g_bSuppressCallCSPrompt = true;
			}
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;
			Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nEXCEEDINVALID;								
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;		
		case 15:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.g_nPromptToPlay = 1253;
			break;		
		case 16:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.g_nPromptToPlay = 1253;
			break;		
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="132" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=16 y=493 ?>
          <!--PlayBrandingPrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptAuthAniReq</parameter>
            <parameter >g_oAPI.nPromptAuthAniReqIndex</parameter>
            <parameter >g_oAPI.strPromptAuthAniReqUrl</parameter>
          </function>
          <results >
            <result name="Default" link="134" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.strPromptAuthAniReqUrl.length == 0 && Session.g_oAPI.nPromptAuthAniReqIndex == 0){
	Session.g_oAPI.nPromptAuthAniReqIndex = 611;
}

Server.logInfo("Playing Free Call Branding Prompt");]]></script>
          </scripts>
        </action>
        <action id="133" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=385 y=654 ?>
          <!--PlayBrandingPrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptCallFromInvalidAni</parameter>
            <parameter >g_oAPI.nPromptCallFromInvalidAniIndex</parameter>
            <parameter >g_oAPI.strPromptCallFromInvalidAniUrl</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.strPromptCallFromInvalidAni.length == 0 && Session.g_oAPI.nPromptCallFromInvalidAniIndex == 0){
	Session.g_oAPI.nPromptCallFromInvalidAniIndex = Session.g_nPromptToPlay;
}

Server.logInfo("Playing Calling from invalid ANI Branding Prompt");]]></script>
          </scripts>
        </action>
        <action id="134" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=21 y=578 ?>
          <!--Ask to add ANI to auth ANI list-->
          <collect-play xmlns="www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="60" ms-type="g_oMS.strType" played-length="" digits="f_strCollectedDigits" terminating-char="" rc="" returns="f_nReturnCode" play-offset="" language="g_oAPI.strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;(x)&quot;" fdt="100" idt="40" ict="16" terminating-digit=""/>
          <results >
            <result name="Default" link="135" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="Add ANI" link="136" stubbed="1" >f_strCollectedDigits match "1"</result>
          </results>
        </action>
        <action id="135" plug-in="Pactolus.Branch.1" ><?xtml-editor x=205 y=654 ?>
          <results >
            <result name="Default" link="132" stubbed="1"/>
            <result name="ThirdTry" link="76" stubbed="1" >nAskForAniRegCount == 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nAskForAniRegCount += 1;]]></script>
          </scripts>
        </action>
        <action id="136" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=139 y=769 ?>
          <!--psAPIAddAuthAni-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAddAuthAni&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="114" stubbed="0"/>
            <result name="Success" link="119" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Change the one step dialing value to the originating number, this needs to be done because the library function
//uses strOneStepDialingNumber as the ANI to add
Session.g_oSUB.strOneStepDialingNumber = Session.g_oAPI.strOriginationNumber;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode == 0){
	
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="AuthorizeDestination" start="86" event="AuthorizeDestination" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bNull" type="boolean" >0</var>
        <var name="f_bMainMenu" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bIsDestValid" type="boolean" >0</var>
        <var name="f_nPrompt" type="i4" >380</var>
        <var name="f_bAllowConfCall" type="boolean" >0</var>
        <var name="f_oArrayCallLegs" type="object" ></var>
        <var name="f_nMinutesAvailable" type="i4" >0</var>
        <var name="bNoChargeAnnoncedCall" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="86" plug-in="Pactolus.Branch.1" ><?xtml-editor x=38 y=27 ?>
          <results >
            <result name="Default" link="77" stubbed="0"/>
            <result name="bANCallbackFlag, !bInitANCB" link="80" stubbed="1" >g_oAPI.bANCallbackFlag == true
AND g_bInitiatedANCallback == false
AND g_oAPI.strOriginationType == s_oORIG_TYPES.strAccessNumCallback</result>
          </results>
        </action>
        <action id="10" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1775 y=186 ?>
          <!--return s_nMAKE_CONNECTION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nMAKE_CONNECTION"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strOutdialDestNbr: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strOutdialDestNbr);]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Pactolus.Branch.1" ><?xtml-editor x=448 y=320 ?>
          <!--g_oAPI.strPostDestPromptType= U or I-->
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="g_oAPI.strPostDestPromptType==U" link="34" stubbed="0" >g_oAPI.strPostDestPromptType match "U"</result>
            <result name="g_oAPI.strPostDestPromptType==I" link="67" stubbed="0" >g_oAPI.strPostDestPromptType match "I"
AND g_oAPI.nPostDestPromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;

Session.g_oAPI.strDestinationNumber = Session.g_oCallLegB.strOutdialDestNbr;
]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=675 y=508 ?>
          <!--strPostDestPromptURL-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strPostDestPromptUrl</audio>
          </play>
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="51" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1056 y=530 ?>
          <!--play time available-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayTimeAvailable&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="96" stubbed="0"/>
          </results>
        </action>
        <action id="67" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=501 y=604 ?>
          <!--g_oAPI.nPostDestPromptIndex-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nPostDestPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="68" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=186 y=671 ?>
          <!--g_nPromptToPlay-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="69" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="strConfCall = T" link="81" stubbed="0" >g_oCallLegB.strConfCallFlag == "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(5 == Result.id) {

	Session.g_nCurrentState = Session.s_nSTATE_PROC_N_LEG;

}]]></script>
          </scripts>
        </action>
        <action id="69" plug-in="Pactolus.Branch.1" ><?xtml-editor x=496 y=769 ?>
          <!--max retry-->
          <results >
            <result name="Default" link="71" stubbed="1"/>
            <result name="intMaxRetry &lt; oAPI.nMaxLoginAttempts" link="70" stubbed="0" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
            <result name="strConfCallFlag = T" link="81" stubbed="1" >g_oCallLegB.strConfCallFlag == "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(3 == Result.id) {

	Session.g_nCurrentState = Session.s_nSTATE_RETURN_TO_CONF;

}]]></script>
          </scripts>
        </action>
        <action id="70" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=754 y=757 ?>
          <!--s_nGET_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_DESTINATION"/>
        </action>
        <action id="71" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=308 y=231 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="72" stubbed="0"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.EndSession.1" ><?xtml-editor x=734 y=213 ?></action>
        <action id="74" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=22 y=347 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="71" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="88" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 1</result>
            <result name="-3,-4,-6,-7, -8, -9, -10: Get Dest Again" link="87" stubbed="0" >f_nReturnCode == -3
OR f_nReturnCode == -4
OR f_nReturnCode == -6
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9
OR f_nReturnCode == -10</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");

Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);

Session.g_oAPI.bALegCallback = false;

Session.g_oRATE.fAlegMeteredRate = Session.g_oCallLegA.oRATE.fAlegMeteredRate;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");

Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;

if (Session.f_nReturnCode != 0)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;							
		case -10:
			Session.g_nErrorMsgNumber = 2002; //occurs if zero cost turned on at service level, but one or more associated rates has an amount greater than 0
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;					
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="77" plug-in="Pactolus.Branch.1" ><?xtml-editor x=32 y=152 ?>
          <!--null string?-->
          <results >
            <result name="Default" link="74" stubbed="0"/>
            <result name="main menu" link="78" stubbed="0" >f_bMainMenu == true</result>
            <result name="miss dial" link="69" stubbed="1" >f_bMissDial == true</result>
            <result name="Invalid or Null" link="68" stubbed="1" >f_bIsDestValid == false
OR f_bNull == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nPromptToPlay = 0;
Session.g_nErrorMsgNumber = 0;

Session.g_nNumRetry++;

if(Session.g_oAPI.strDestinationNumber.length <= 0) {

	Session.g_nPromptToPlay = 552; // I did not hear a response.
	Session.f_bNull = true;
	Session.g_oAPI.nSessionTerminationReason = 6;
	Session.g_nErrorMsgNumber = 1012; //max retry
	
} else if("*" == Session.g_strTerminationDigit && "*" == Session.g_oAPI.strDestinationNumber && "T" == Session.g_oAPI.strMainMenuFlag && "T" != Session.g_oCallLegB.strConfCallFlag) {

	Session.f_bMainMenu = true; 		
	
} else if(Session.s_strCustomerCode == "latinode" && Session.g_oAPI.strDestinationNumber.length != 2 && Session.g_oAPI.strDestinationNumber.length < 10) {	

	Session.g_nPromptToPlay = Session.f_nPrompt; // ?
	Session.f_bIsDestValid = false;
	
	
} else if("*" == Session.g_strTerminationDigit) {

	Session.f_bMissDial = true;

} else if('0' == Session.g_oAPI.strDestinationNumber.charAt(0) && 1 == Session.g_oAPI.nDialingPlanId) {

		if ( '1' == Session.g_oAPI.strDestinationNumber.charAt(1) && '1' == Session.g_oAPI.strDestinationNumber.charAt(2)) {
			Session.f_bIsDestValid = true;
		} else {
			Session.f_bIsDestValid = false;
			Session.g_nPromptToPlay = 514;
		} // end if charAt(1) == 1, charAt(2) == 2;
} else {

	Session.f_bIsDestValid = true;
	
}
]]></script>
          </scripts>
        </action>
        <action id="78" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=291 y=151 ?>
          <!--s_nSTATE_MAIN_MENU_PRPD_OR_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_MAIN_MENU_PRPD_OR_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strTerminationDigit = "";
Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="80" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=15 y=857 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="81" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" >f_nReturnCode == 0
OR f_nReturnCode == 1</result>
            <result name="-3,-4,-6,-7, -8, -9: Get Dest Again" >f_nReturnCode == -3
OR f_nReturnCode == -4
OR f_nReturnCode == -6
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9
OR f_nReturnCode == -10</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");

Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);

Session.g_oAPI.bALegCallback = true;
var myString = new String ("");

if(Session.g_oSUB.strCallbackNumber.length > 0 && Session.g_oSUB.bCallbackNumberEnable) {
	myString = new String (Session.g_oSUB.strCallbackNumber);	
} else if(Session.g_oAPI.strOriginationNumber.length > 0) {
	myString = new String (Session.g_oAPI.strOriginationNumber);		
} else {
	Server.logError("Attempting to authorize destination for A leg callback but callback number and ANI are empty.");
}		

var myArray = myString.split("x");

Session.g_oAPI.strDestinationNumber = myArray[0];
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 1)
{
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK;
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			//Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 514;	
		case -10:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;									
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {
	Session.g_nPromptToPlay = Session.s_nPROMPT_CALLBACK;
}


Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=254 y=921 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1552 y=487 ?>
          <!--PlayOnePrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayOnePrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_nPromptToPlay</parameter>
          </function>
          <results >
            <result name="Default" link="89" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nPromptToPlay = 517; // PLease hold while your call...]]></script>
          </scripts>
        </action>
        <action id="84" plug-in="Pactolus.Branch.1" ><?xtml-editor x=972 y=255 ?>
          <results >
            <result name="Default" link="91" stubbed="0"/>
            <result name="creditLimitFlag = T" link="85" stubbed="0" >g_oAPI.strCreditLimitFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="85" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1118 y=370 ?>
          <!--"PlayTimeAvailable"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayTimeAvailable&quot;" return="" external-function="0" library="lib_utils.xml"/>
          <results >
            <result name="Default" link="96" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Play Time Available (credit limit)");]]></script>
          </scripts>
        </action>
        <action id="87" plug-in="Pactolus.Branch.1" ><?xtml-editor x=27 y=540 ?>
          <!--Is Direct Call?-->
          <results >
            <result name="Default" link="71" stubbed="1"/>
            <result name="Not Direct Call" link="68" stubbed="0" >g_bDirectCallFlag == false</result>
            <result name="Direct Call" link="71" stubbed="1" >g_bDirectCallFlag == true</result>
          </results>
        </action>
        <action id="88" plug-in="Pactolus.Branch.1" ><?xtml-editor x=258 y=474 ?>
          <results >
            <result name="Default" link="68" stubbed="1"/>
            <result name="Direct Call = T" link="89" stubbed="1" >g_bDirectCallFlag == true</result>
            <result name="strConfCallFlag = F" link="33" stubbed="0" >g_oCallLegB.strConfCallFlag == "F"</result>
            <result name="bAllowConfCall" link="89" stubbed="1" >f_bAllowConfCall == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oCallLegB.strConfCallFlag == "T") {

	Session.f_oArrayCallLegs = Session.g_oArrayCallLegs;
	var sHasMoneyForConf = hasMoneyForConfLeg(Session.g_oSUB.fPrepaidBalance, Session.g_oArrayCallLegs, Session.g_oRATE.fTotalFixedRate);
	Session.g_oArrayCallLegs = Session.f_oArrayCallLegs;

	if (sHasMoneyForConf != "T") {
		Session.g_nPromptToPlay = 507;
		Server.logInfo("DON'T HAVE ENOUGH MONEY TO ADD MORE PARTY TO CONFERENCE");
		Session.f_bAllowConfCall = false;
	} else 	{
		Session.g_nPromptToPlay = 99;
		Server.logInfo("HAS ENOUGH MONEY TO ADD MORE PARTY TO CONFERENCE");
		Session.f_bAllowConfCall = true;
	}


}	]]></script>
          </scripts>
        </action>
        <action id="89" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1597 y=248 ?>
          <!--InitCallLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;InitCallLeg&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_nCurrentArrayIndex</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="strConfCallFlag = T" link="90" stubbed="0" >g_oCallLegB.strConfCallFlag == "T"</result>
          </results>
        </action>
        <action id="90" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1742 y=493 ?>
          <!--s_nSTATE_ADD_LEG_CONF-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_ADD_LEG_CONF"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strConfCallFlag: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strConfCallFlag);

Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strOutdialDestNbr: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strOutdialDestNbr);

Session.g_oCallLegB.strConfCallFlag = "F";]]></script>
          </scripts>
        </action>
        <action id="91" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1328 y=393 ?>
          <results >
            <result name="Default" link="89" stubbed="0"/>
            <result name="C2D or Msg Init" link="83" stubbed="0" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback</result>
            <result name="play bucket refill warning" link="92" stubbed="0" >g_oSUB.strPlayBucketRefillWarning match "T"</result>
            <result name="play bucket exhaust warning" link="93" stubbed="0" >g_oSUB.strPlayBucketExhaustWarning match "T"</result>
          </results>
        </action>
        <action id="92" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1556 y=580 ?>
          <!--play the bucket refill warning-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1304</audio>
            <audio type="index" >1305</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1306</audio>
          </play>
          <results >
            <result name="Default" link="89" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//calculate minutes available
Session.f_nMinutesAvailable = (Session.g_oSUB.nSecondsBalance - Session.g_oSUB.nSecondsUsed) / 60;
if ( 0 > Session.f_nMinutesAvailable ) {
	Session.f_nMinutesAvailable = 0;
}]]></script>
          </scripts>
        </action>
        <action id="93" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1556 y=742 ?>
          <!--play the bucket exhaust warning-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1304</audio>
            <audio type="index" >1307</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1308</audio>
          </play>
          <results >
            <result name="Default" link="89" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//calculate minutes available
Session.f_nMinutesAvailable = (Session.g_oSUB.nSecondsBalance - Session.g_oSUB.nSecondsUsed) / 60;
if ( 0 > Session.f_nMinutesAvailable ) {
	Session.f_nMinutesAvailable = 0;
}]]></script>
          </scripts>
        </action>
        <action id="94" plug-in="Pactolus.Branch.1" ><?xtml-editor x=868 y=400 ?>
          <!--play time avail?-->
          <results >
            <result name="Default" link="84" stubbed="0"/>
            <result name="PlayTime" link="51" stubbed="0" >g_oSUB.strPlayTimeAvailableFlag match "T"
AND g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD
AND g_oAPI.bNoAnnouncedChargeCall  == false</result>
            <result name="No Announced Charge" link="95" stubbed="0" >g_oAPI.bNoAnnouncedChargeCall  == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Session.g_oAPI.bNoAnnouncedChargeCall <"+Session.g_oAPI.bNoAnnouncedChargeCall+">");

Server.logInfo("Session.g_oAPI.strPromptFreeCall <"+Session.g_oAPI.strPromptFreeCall+">");
Server.logInfo("Session.g_oAPI.nPromptFreeCallIndex <"+Session.g_oAPI.nPromptFreeCallIndex+">");
Server.logInfo("Session.g_oAPI.strPromptFreeCallUrl <"+Session.g_oAPI.strPromptFreeCallUrl+">");
Session.g_nTimeAvailable  = Session.g_oSUB.nSecondsAnnounce;]]></script>
          </scripts>
        </action>
        <action id="95" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1013 y=614 ?>
          <!--Play No Announced Charge Branding Prompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptFreeCall</parameter>
            <parameter >g_oAPI.nPromptFreeCallIndex</parameter>
            <parameter >g_oAPI.strPromptFreeCallUrl</parameter>
          </function>
          <results >
            <result name="Default" link="91" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing Free Call Branding Prompt");]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1265 y=578 ?>
          <!--Post Time Announced Disclaimer PlayBrandingPrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptPostTimeDisclaimer</parameter>
            <parameter >g_oAPI.nPromptPostTimeDisclaimerIndex</parameter>
            <parameter >g_oAPI.strPromptPostTimeDisclaimerUrl</parameter>
          </function>
          <results >
            <result name="Default" link="91" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing Post Time Announced Disclaimer Branding Prompt");]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="Connect" start="93" event="Connect" returns="i4" >
      <local-vars >
        <var name="f_sStatus" type="i2" >0</var>
        <var name="f_lStartTime" type="i8" >0</var>
        <var name="f_lEndTime" type="i8" >0</var>
        <var name="f_nDuration" type="i4" >0</var>
        <var name="f_nTimerAFirstTimer" type="i4" >60</var>
        <var name="f_nTimerBFirstTimer" type="i4" >60</var>
        <var name="f_nBUSY" type="i4" >2</var>
        <var name="f_nCALLEDPARTYERROR" type="i4" >-2</var>
        <var name="f_nCALLINGPARTYERROR" type="i4" >-3</var>
        <var name="f_nDTMFINTERRUPTED" type="i4" >3</var>
        <var name="f_nOTHERERROR" type="i4" >-4</var>
        <var name="f_nRESOURCEUNAVAIL" type="i4" >-5</var>
        <var name="f_nRINGNOANSWER" type="i4" >1</var>
        <var name="f_nSUCCESS" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_strContentON" type="string" >ON</var>
      </local-vars>
      <actions >
        <action id="93" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=22 y=20 ?>
          <!--Delete MS Connection-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="130" stubbed="0"/>
            <result name="Init Call Leg?" link="134" stubbed="0" >g_oAPI.strOutdialOperatorFlag == "T"

AND g_oACD.strCSRDidOutdial != "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strOutdialDestNbr: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strOutdialDestNbr);]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1507 y=226 ?>
          <!--s_nGET_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_DESTINATION"/>
        </action>
        <action id="54" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=30 y=609 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -1;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode != Session.s_sSUCCESS) {
	Server.logError("There was an error hanging up the A leg.");
}]]></script>
          </scripts>
        </action>
        <action id="110" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=297 y=461 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -1;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode != Session.s_sSUCCESS) {
	Server.logError("There was an error hanging up the A leg.");
}]]></script>
          </scripts>
        </action>
        <action id="112" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=787 y=234 ?>
          <!--outdial from MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success" link="122" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="118" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
	Server.logError("There was an error outdialing the A leg to the MS after an unsuccessful outdial attempt.");	
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="116" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=43 y=271 ?>
          <!--Setup B leg and outdial-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;OutdialParty&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].lTimeStart</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].lTimeAnswered</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].strSIPStatus</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >s_bPlayRingbackForOutdial</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="132" stubbed="0"/>
            <result name="0 - success" link="127" stubbed="0" >f_nReturnCode == f_nSUCCESS</result>
            <result name="CallingParty error, other error, resource unavail" link="110" stubbed="0" >f_nReturnCode == f_nCALLINGPARTYERROR
OR f_nReturnCode == f_nOTHERERROR
OR f_nReturnCode == f_nRESOURCEUNAVAIL</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.s_strTestModeFlag == "T")

{

	if(Session.g_oTEST.strTestDestinationNumber.length > 0) {

		Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;

	} else {

		Server.logError("Application is in test mode but no test number exists. Using: " + Session.g_oAPI.strDestinationNumber);

	}			

}										



Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");

Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);

Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber = js_translate_destination_post_rating(Session.s_strCustomerCode, Session.g_oAPI.strDestinationNumber, Session.g_oAPI.strOriginationNumber, Session.g_oAPI.nOrigCountryId, Session.s_strE164_Dialing);



if ("T" == Session.s_strPrependSVC)

	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber = Session.g_oAPI.strServiceProviderCode + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber;



Session.g_oCallLegA.strContent = Session.g_oCallLegA.strOriginalContent;

Session.g_oAPI.nRTPClockRate = 8000;

Session.g_oAPI.nRTPEncoding = 0;

Session.f_lStartTime = Server.getUTCTime();

//PAI came in as the anonymity header (hack)
var from = new SipFrom(Session.g_oCallLegA.strFrom);
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strPAssertedIdentity = js_create_app_PAI(
	Session.s_strCarrierName,
	from.url.user,
	Session.g_oAPI.nOrigCountryId,
	false,
	Session.g_oAPI.strAniReceived,
	from.url.host,
	Session.g_oCallLegA.strPAssertedIdentity,
 	false,
	Session.s_strDEFAULT_ANI);

//Diversion header is the ANI taken from the app property
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strDiversion = "<sip:"+Session.s_strDEFAULT_ANI +"@" + Session.s_strLocalHost+">";

]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("********* OUTDIAL RETURN *********");
Server.logInfo("f_nReturnCode " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
// if last call redial is configured for this service and
// the call completed, was busy or the caller did not answer
// set the last redial number and increment the last call redial count
if ((Session.g_oAPI.bLastCallRedial == true) &&
      ((Session.f_nReturnCode == Session.f_nSUCCESS) ||
       (Session.f_nReturnCode == Session.f_nBUSY) ||
       (Session.f_nReturnCode == Session.f_nRINGNOANSWER)))
{
      Session.g_oAPI.strLastDestination = Session.g_oAPI.strDestinationNumber;
}

switch (Session.f_nReturnCode)
{
	case 0:  //success
		Session.f_lEndTime = Server.getUTCTime();
		Session.f_nDuration = Session.f_lEndTime - Session.f_lStartTime;
		break;
	case 1:  //ring no answer
		Session.g_nPromptToPlay = 551;
		Session.g_oAPI.nCallTerminationReason = 8;
		break;
	case 2:  //busy
		Session.g_nPromptToPlay = 550;
		Session.g_oAPI.nCallTerminationReason = 7;
		break;
	case 3:  //DTMF interrupted
		Session.g_nPromptToPlay = 0;
		Session.g_oAPI.nCallTerminationReason = 5;
		break;
	case -3:  //calling party error
		Session.g_oAPI.nCallTerminationReason = 6;
		Session.g_oAPI.nSessionTerminationReason = 5;
		break;
	default:
		Session.g_nPromptToPlay = 549;
		Session.g_oAPI.nCallTerminationReason = 4;
		break;

}

Server.logInfo("CALLING js_calculate_uri_and_route");
Server.logInfo("BEFORE contact: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContact);
Server.logInfo("BEFORE record route: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRecordRoute);
Server.logInfo("BEFORE request Uri: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri);
Server.logInfo("BEFORE route: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRoute);
var bDialIn = false;
js_calculate_uri_and_route(bDialIn, Session.s_strSIPVERSION, Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom, Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContact, Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRecordRoute, Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri, Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRoute);
Server.logInfo("AFTER contact: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContact);
Server.logInfo("AFTER record route: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRecordRoute);
Server.logInfo("AFTER request Uri: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri);
Server.logInfo("AFTER route: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRoute);
Server.logInfo("Call leg B request Uri is: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri);
var myUri = new SipRequestUri(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri);
Session.g_oAPI.strGWIPEgress = myUri.url.host;
if(myUri.url.port == undefined || myUri.url.port == "undefined") {
	Server.logInfo("myUri.url.port: <" + myUri.url.port + ">");
} else {
	Session.g_oAPI.nGWPortEgress = myUri.url.port;
}

if (myUri.url.dtg != undefined) {
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strDestTrunkGroup = myUri.url.dtg;
}	

if(Session.g_oCallLegB.strContent.length > 0) {

	var sdpUsed = new Sdp(Session.g_oCallLegB.strContent.toString());

	if(sdpUsed.media.length > 0 && sdpUsed.media[0].rtpMaps.length > 0) {
		Session.g_oAPI.nRTPEncoding = sdpUsed.media[0].rtpMaps[0].type;
	} else {
		Server.logInfo("Could not determine nRTPEncoding.");
	}
}	]]></script>
          </scripts>
        </action>
        <action id="118" plug-in="Standard.EndSession.1" ><?xtml-editor x=286 y=643 ?></action>
        <action id="119" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1270 y=332 ?>
          <!--g_nPromptToPlay-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="124" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="122" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1016 y=234 ?>
          <!--play prompt?-->
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="g_nPromptToPlay &gt; 0" link="119" stubbed="0" >g_nPromptToPlay &gt; 0</result>
          </results>
        </action>
        <action id="124" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1256 y=228 ?>
          <!--outdial csr?-->
          <results >
            <result name="Default" link="133" stubbed="0"/>
            <result name="g_oAPI.strOutdialOperatorFlag==T" link="125" stubbed="0" >g_oAPI.strOutdialOperatorFlag match "T"</result>
          </results>
        </action>
        <action id="125" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1523 y=312 ?>
          <!--could not reach csr-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1503</audio>
          </play>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 10;]]></script>
          </scripts>
        </action>
        <action id="127" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=315 y=365 ?>
          <!--SetTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;SetTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimer</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimerGSX</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >f_nDuration</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="128" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers
js_initTimer(Session.g_oTimerThreshold1);
js_initTimer(Session.g_oTimerThreshold2);
js_initTimer(Session.g_oTimerThreshold3);
js_initTimer(Session.g_oTimerPhoneA);
js_initTimer(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].oTimer);
js_initTimer(Session.g_oTimerMaxTime);
js_initTimer(Session.g_oTimerLongCallInterval);
if (Session.g_bDirectCallFlag == true) {
  Server.logInfo("Direct call flag enabled.  Warning thresholds disabled.");
} else {
   Session.g_oTimerThreshold1.nThresholdTime = Session.g_oAPI.nWarningThreshold1;
   Session.g_oTimerThreshold2.nThresholdTime = Session.g_oAPI.nWarningThreshold2;
   Session.g_oTimerThreshold3.nThresholdTime = Session.g_oAPI.nWarningThreshold3;
}
Session.g_oTimerPhoneA.lSleepTime = Session.g_oCallLegA.initSessionTimer;
Session.g_oTimerPhoneB.lSleepTime = Session.g_oCallLegB.initSessionTimer;
Session.g_oTimerLongCallInterval.lSleepTime = Session.g_oAPI.nLongCallInterval * 60;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].oTimer.lSleepTime = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].nSessionTimer;

if (Session.g_oSUB.nSecondsAvailable > 0){
	Session.g_oTimerMaxTime.lSleepTime = Session.g_oSUB.nSecondsAvailable;
} else if (Session.g_oAPI.nMaxAllowedSeconds > 0){
	Session.g_oTimerMaxTime.lSleepTime =  Session.g_oAPI.nMaxAllowedSeconds;
} else {
	Session.g_oTimerMaxTime.lSleepTime = 4294967;
	Server.logInfo("INFO: BOTH SECOND AVAILABLE AND MAX ALLOW SECONDS EQUAL ZERO");
}]]></script>
          </scripts>
        </action>
        <action id="128" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=551 y=368 ?>
          <!--return s_nCONNECTED-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nCONNECTED"/>
        </action>
        <action id="129" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=539 y=175 ?>
          <!--put A on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success" link="112" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(0 != Session.f_nReturnCode) {
	Server.logError("There was an error putting the A leg on hold after an unsuccessful outdial attempt. The application will send a BYE to the A leg and end the session.");
	Server.logError("The outdial stop reason (not necessarily a problem) - g_oAPI.nCallTerminationReason: " + Session.g_oAPI.nCallTerminationReason);
}]]></script>
          </scripts>
        </action>
        <action id="130" plug-in="Pactolus.Branch.1" ><?xtml-editor x=479 y=30 ?>
          <!--send info msg?-->
          <results >
            <result name="Default" link="116" stubbed="1"/>
            <result name="SendInfoMs &amp;&amp; SendPreCall" link="131" stubbed="0" >s_strSendInfoMsg match "T"
AND s_strSendPrecallInfoMsg match "T"</result>
          </results>
        </action>
        <action id="131" plug-in="Pactolus.SipInfo.1" ><?xtml-editor x=721 y=30 ?>
          <!--ON-->
          <element-tag increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >f_strContentON</content>
            <content-type >"application/dtmf"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strTo</from>
            <request-uri >g_oCallLegA.strRequestUri</request-uri>
            <to >g_oCallLegA.strFrom</to>
            <via >s_strVia</via>
          </element-tag>
          <results >
            <result name="Default" link="116" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="132" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=318 y=234 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success, !Suppress Hold" link="129" stubbed="0" >f_nReturnCode == s_sSUCCESS



AND g_oAPI.bSuppressOnHold == false</result>
            <result name="Success, Suppress Hold" link="112" stubbed="0" >g_oAPI.bSuppressOnHold == true



AND f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)



{



	Session.g_oAPI.nSessionTerminationReason = 5;



	Server.logError("Error calling proc call completion.");



}]]></script>
          </scripts>
        </action>
        <action id="133" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1407 y=104 ?>
          <!--Is Direct Call?-->
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Not Direct Call" link="30" stubbed="1" >g_bDirectCallFlag == false</result>
            <result name="Direct Call" link="54" stubbed="1" >g_bDirectCallFlag == true</result>
          </results>
        </action>
        <action id="134" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=277 y=125 ?>
          <!--InitCallLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;InitCallLeg&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_nCurrentArrayIndex</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="130" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnBye" start="1" event="OnBye" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bByeFromBLeg" type="boolean" >0</var>
        <var name="f_bSendCancel" type="boolean" >0</var>
        <var name="f_bPutCallersOnHold" type="boolean" >1</var>
        <var name="f_nIndex" type="i4" >0</var>
        <var name="f_bUnlockBalXferPin" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=26 y=28 ?>
          <!--reponse 200 OK-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Session.array.length:" + Session.g_oArrayCallLegs.length);
Server.logInfo("A-Leg call ID   : "+Session.g_oCallLegA.strCallId);
Server.logInfo("Session call ID : "+Session.strCallId);


js_disable_event();



if(Session.g_oCallLegA.strCallId != Session.strCallId) {



	Server.logInfo("Recieved OnBye, was not from A leg. Determine which B leg.");

	

	Session.g_nCurrentArrayIndex = -1;

	Session.g_nCurrentArrayIndex = js_search_callid(Session.g_oArrayCallLegs, Session.strCallId);

	Server.logInfo("B-Leg index: "+Session.g_nCurrentArrayIndex);

	if(Session.g_nCurrentArrayIndex >= 0) {

		Session.f_bByeFromBLeg = true;
		Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strConfCallFlag: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strConfCallFlag);

	}

	

}

]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Pactolus.Branch.1" ><?xtml-editor x=272 y=29 ?>
          <!--BYE from phone A or Phone B-->
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="from phoneA" link="58" stubbed="0" >strCallId match g_oCallLegA.strCallId</result>
            <result name="from phoneB" link="70" stubbed="0" >strCallId match g_oArrayCallLegs[g_nCurrentArrayIndex].strCallId

AND f_bByeFromBLeg == true</result>
          </results>
        </action>
        <action id="34" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=32 y=1237 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oArrayCallLegs. array.length: " + Session.g_oArrayCallLegs.length);



js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="51" plug-in="Standard.EndSession.1" ><?xtml-editor x=1151 y=38 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="53" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=866 y=257 ?>
          <!--Cancel PartyB-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CancelParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="57" stubbed="0"/>
          </results>
        </action>
        <action id="55" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=28 y=1074 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="56" stubbed="0"/>
          </results>
        </action>
        <action id="56" plug-in="Standard.EndSession.1" ><?xtml-editor x=270 y=1113 ?></action>
        <action id="57" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1077 y=333 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="51" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=521 y=27 ?>
          <!--StopTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="85" stubbed="0"/>
          </results>
        </action>
        <action id="60" plug-in="Pactolus.Branch.1" ><?xtml-editor x=19 y=383 ?>
          <results >
            <result name="Default" link="75" stubbed="0"/>
            <result name="true == g_oACD.bCSRWithAB" link="63" stubbed="0" >g_oACD.bCSRWithAB == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bGotCSROutdial = false;

Session.g_bGotEndAssignment = false;]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=450 y=419 ?>
          <!--"CSROutdialBLegHangup"-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="g_oACD.strACDControllerIP" transaction="g_strZeroTransactionId" message-name="&quot;CSROutdialBLegHangup&quot;" destination-port="g_oACD.nACDControllerPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;AssignmentId&quot;" value="g_oACD.lCSRAssignmentId"/>
          </SOAP>
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oACD.bCSRWithAB == true) {

	Session.g_oACD.bCSRWithAB = false;

}]]></script>
          </scripts>
        </action>
        <action id="62" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=847 y=359 ?>
          <!--Hang Up Phone B-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="57" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered = 0;



if(Session.g_oArrayCallLegs.length != 1) {

	Server.logError("FATAL ERROR. ARRAY LENGTH IS GREATER THAN 1, EVEN THOUGH A AND B WERE WITH A CSR.");

}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.g_oArrayCallLegs.length != 1) {

	Server.logError("FATAL ERROR. ARRAY LENGTH IS GREATER THAN 1, EVEN THOUGH A AND B WERE WITH A CSR.");

}]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=242 y=391 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="61" stubbed="0"/>
            <result name="Success" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 1;

Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered = 0;]]></script>
          </scripts>
        </action>
        <action id="67" plug-in="Pactolus.Branch.1" ><?xtml-editor x=281 y=796 ?>
          <!--Click2Dial?-->
          <results >
            <result name="Default" link="84" stubbed="0"/>
            <result name="Type does not allow ReOrg" link="55" stubbed="1" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strOneStageDialing
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strIvrCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strAccessNumCallback</result>
          </results>
        </action>
        <action id="68" plug-in="Pactolus.Branch.1" ><?xtml-editor x=560 y=267 ?>
          <!--connected?-->
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="oArray.length = 0" link="82" stubbed="0" >g_oArrayCallLegs.length == 0</result>
            <result name="f_bSendCancel" link="53" stubbed="0" >f_bSendCancel == true</result>
            <result name="ACD.bCSRWithAB" link="62" stubbed="0" >g_oACD.bCSRWithAB == true</result>
            <result name="oArray.length &gt; 1" link="69" stubbed="0" >g_oArrayCallLegs.length &gt;= 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 2;

Session.g_oAPI.nSessionTerminationReason = 7;





Server.logInfo("Session.array.length:" + Session.g_oArrayCallLegs.length);





if(Session.g_oArrayCallLegs.length >= 1) {



	// check to see if we need to cancel the last outdial leg

	if(true == Session.g_oArrayCallLegs[(Session.g_oArrayCallLegs.length - 1)].bCurrentlyDialing) {

		Session.g_nCurrentArrayIndex = Session.g_oArrayCallLegs.length - 1;

		Session.f_bSendCancel = true;

	}



}

]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Session.array.length:" + Session.g_oArrayCallLegs.length);]]></script>
          </scripts>
        </action>
        <action id="69" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=834 y=465 ?>
          <!--ProcTerminateConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcTerminateConf&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="51" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strClickToDial) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaClickToDial;
} else if(	Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strMessageCallback) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaMessageCallback;
} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strIvrCallback) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaIvr;
} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strAccessNumCallback) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaAccessNbrInitiatedCallback;
} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strOneStageDialing) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOneStageDialing;
} else {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaIvr;
} ]]></script>
          </scripts>
        </action>
        <action id="70" plug-in="Pactolus.Branch.1" ><?xtml-editor x=10 y=207 ?>
          <results >
            <result name="Default" link="60" stubbed="0"/>
            <result name="g_bModAddingParty = true" link="71" stubbed="0" >g_bModAddingParty == true</result>
          </results>
        </action>
        <action id="71" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=291 y=226 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var iIndex = 0;

iIndex = Session.g_oOnByeCallIds.length;

Session.g_oOnByeCallIds[iIndex].strCallId = Session.strCallId;





if(Session.g_oArrayCallLegs.length > 0) {



	if(Session.g_nCurrentArrayIndex > -1 && Session.g_nCurrentArrayIndex <= Session.g_oArrayCallLegs.length) {

		Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded = Server.getUTCTime();

	}

	

} else {

	Server.logError("App has gotten a Bye from the B leg, but the Array.length = 0. Should never be here.");

}
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="72" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=525 y=1046 ?>
          <!--Re-originate-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="73" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bDoNotEnableEvents = false;

js_enable_event();

]]></script>
          </scripts>
        </action>
        <action id="73" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=770 y=859 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="74" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1006 y=625 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="55" stubbed="1"/>
            <result name="Success" link="81" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 1;

Session.g_oAPI.nSessionTerminationReason = 7;



Server.logInfo("g_oArrayCallLegs[g_nCurrentArrayIndex].strConfCallFlag: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strConfCallFlag);



Session.g_bDoNotEnableEvents = true;

]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");

Session.g_oACD.lCSRAssignmentId = 0;

Session.g_oACD.lCSRUserId = 0;	



if(Session.f_nReturnCode != Session.s_sSUCCESS) {

	Session.g_oAPI.nSessionTerminationReason = 5;



}]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Pactolus.Branch.1" ><?xtml-editor x=45 y=575 ?>
          <!--If last leg, need to stop all timers, if not only stop this leg's timers-->
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="oArrayCallLegs.length = 1" link="77" stubbed="0" >g_oArrayCallLegs.length == 1</result>
          </results>
        </action>
        <action id="76" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=293 y=564 ?>
          <!--StopBLegTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopBLegTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimer</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimerGSX</parameter>
          </function>
          <results >
            <result name="Default" link="80" stubbed="0"/>
          </results>
        </action>
        <action id="77" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=313 y=695 ?>
          <!--StopTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="86" stubbed="0"/>
          </results>
        </action>
        <action id="78" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=287 y=941 ?>
          <!--ProcOnly1BLegLeft-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcOnly1BLegLeft&quot;" return="f_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >f_bPutCallersOnHold</parameter>
          </function>
          <results >
            <result name="Default" link="55" stubbed="1"/>
            <result name="Success" link="34" stubbed="0" >f_nReturnCode == 0</result>
          </results>
        </action>
        <action id="79" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=780 y=632 ?>
          <!--Remove B from conference-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;RemoveMemberFromConference&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oMS</parameter>
          </function>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
        </action>
        <action id="80" plug-in="Pactolus.Branch.1" ><?xtml-editor x=524 y=612 ?>
          <!--more than 1?-->
          <results >
            <result name="Default" link="74" stubbed="1"/>
            <result name="oArrayCallLegs.length &gt; 1" link="79" stubbed="0" >g_oArrayCallLegs.length &gt; 1</result>
          </results>
        </action>
        <action id="81" plug-in="Pactolus.Branch.1" ><?xtml-editor x=34 y=820 ?>
          <!--If only 1 leg left, connect A and B directly, teardown conference.-->
          <results >
            <result name="Default" link="67" stubbed="0"/>
            <result name="oArrayCallLegs.length = 1" link="78" stubbed="0" >g_oArrayCallLegs.length == 1</result>
            <result name="oArrayCallLegs.length &gt; 1" link="34" stubbed="0" >g_oArrayCallLegs.length &gt; 1</result>
          </results>
        </action>
        <action id="82" plug-in="Pactolus.Branch.1" ><?xtml-editor x=743 y=64 ?>
          <results >
            <result name="Default" link="51" stubbed="0"/>
            <result name="f_bUnlockBalXferPin" link="83" stubbed="0" >f_bUnlockBalXferPin == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_bBalXferPinLocked) {
	if(Session.g_oBALXFER.strBalXferPin.length > 0) {
		Session.f_bUnlockBalXferPin = true;
	}
}]]></script>
          </scripts>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=964 y=144 ?>
          <!--JAVA: PrepaidAPIUnlockPin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="51" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START unlockPin() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("unlockPin returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO UNLOCK PIN");
	Server.logError("ERROR: unlockPin returned: " + Session.f_nReturnCode);
}


]]></script>
          </scripts>
        </action>
        <action id="84" plug-in="Pactolus.Branch.1" ><?xtml-editor x=508 y=813 ?>
          <!--Is Direct Call?-->
          <results >
            <result name="Default" link="72" stubbed="0"/>
            <result name="Direct Call, CSR Outdial" link="55" stubbed="1" >g_oAPI.bANDirectCallFlag == true
OR g_oAPI.strOutdialOperatorFlag == "T"</result>
          </results>
        </action>
        <action id="85" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=516 y=141 ?>
          <!--StopOneTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopOneTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="68" stubbed="0"/>
          </results>
        </action>
        <action id="86" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=480 y=730 ?>
          <!--StopOneTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopOneTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="80" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="ProcCallCompletion" start="10" event="ProcCallCompletion" returns="i4" >
      <local-vars >
        <var name="f_bWriteCDR" type="boolean" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="bSendEmail" type="boolean" >0</var>
        <var name="f_oArrayCallLegs" type="object" ></var>
      </local-vars>
      <actions >
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=113 y=303 ?>
          <!--write CDR?-->
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="f_bWriteCDR == true" link="12" stubbed="0" >f_bWriteCDR == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();

if (Session.g_oAPI.strProcDBName.length > 0)
{
	Session.f_bWriteCDR = true;
}
else
{
	Session.f_bWriteCDR = false;
	Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION, NO DB NAME.");
	Server.logError("ERROR: g_oAPI.strProcDBName.length is: " + Session.g_oAPI.strProcDBName.length);

	if (Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered > 0)
	{
		var myTime;
		Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION, ANSWER TIMER GREATER THAN ZERO.");
		Server.logError("ERROR: g_oAPI.lPlatformSessionStartTime is: " + Session.g_oAPI.lPlatformSessionStartTime);

		myTime = new Date(Session.g_oAPI.lPlatformSessionStartTime * 1000);

		Server.logError("ERROR: g_oAPI.lPlatformSessionStartTime is: " + myTime.toString() );
		Server.logError("ERROR: Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart is: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart);

		myTime = new Date(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart * 1000);

		Server.logError("ERROR: g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart is: " + myTime.toString() );
		Server.logError("ERROR: g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered is: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered);

		myTime = new Date(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered * 1000);

		Server.logError("ERROR: g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered is: " + myTime.toString() );
		Server.logError("ERROR: g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded is: " + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded);

		myTime = new Date(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded * 1000);

		Server.logError("ERROR: g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded is: " + myTime.toString() );
	}
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1010 y=475 ?>
          <!--SUCCESS-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_sSUCCESS"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_bDoNotEnableEvents) {
	Server.logInfo("App will not enable events here.");
} else {
	js_enable_event();
}
Server.logInfo("INFO: PROC CALL COMPLETION SUCCESS");

]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=431 y=290 ?>
          <!--FAILURE-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_sFAILURE"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=254 y=436 ?>
          <!--JAVA: psAPIProcCallCompletion-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIProcCallCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="bSendEmail" link="15" stubbed="0" >bSendEmail == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START CallComletion *********");

Session.g_oAPI.strEmailEvents = "";

Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strSIPStatus = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strSIPStatus.toString();

if(0 == Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded) {
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeEnded = Server.getUTCTime();
}
if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strClickToDial) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaClickToDial;
} else if(	Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strMessageCallback) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaMessageCallback;
} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strIvrCallback) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaIvr;
} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strAccessNumCallback) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaAccessNbrInitiatedCallback;
} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strOneStageDialing) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOneStageDialing;
} else {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaIvr;
} ]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Server.logInfo("g_oAPI.strEmailEvents: " + Session.g_oAPI.strEmailEvents);

if(Session.g_oAPI.strEmailEvents.length > 0) {
	Session.bSendEmail = true;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("procCallCompletion returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION");
	Server.logError("ERROR: procCallCompletion returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.Branch.1" ><?xtml-editor x=489 y=463 ?>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="oArray.length &gt;= 1" link="14" stubbed="0" >g_oArrayCallLegs.length &gt;= 1</result>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=738 y=539 ?>
          <!--ResetTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ResetTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerMaxTime</parameter>
          </function>
          <results >
            <result name="Default" link="8" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_oArrayCallLegs = Session.g_oArrayCallLegs;
timeRemaining(Session.g_oSUB.fPrepaidBalance, Session.g_oArrayCallLegs, Session.g_oAPI.nRoundingSeconds, Session.g_oSUB.nSecondsAvailable);
Session.g_oArrayCallLegs = Session.f_oArrayCallLegs;

Session.g_oTimerMaxTime.lSleepTime =  Session.g_oSUB.nSecondsAvailable;]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=384 y=659 ?>
          <!--psAPIPrepareAndSendEmails-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIPrepareAndSendEmails&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="13" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode != 0) {
	Server.logError("Error calling psAPIPrepareAndSendEmails.");
} 

]]></script>
          </scripts>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="173" y-coord="128" width="397" height="51" text="Only write CDR if g_oCallLegB.bAttemptedToOutdial == true
Once write CDR, reset bAttemptedToOutdial" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="ProcSessionCompletion" start="7" event="ProcSessionCompletion" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="7" plug-in="Pactolus.Branch.1" ><?xtml-editor x=73 y=57 ?>
          <!--null string?-->
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="null string" link="5" stubbed="0" >g_bNullFlag == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_oAPI.strProcDBName.length <= 0)
{
	Session.g_bNullFlag = true;
}
else
{
	Session.g_bNullFlag = false;
}]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=973 y=233 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=497 y=136 ?>
          <!--MediaServer Connected?-->
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="g_oMS.bCurrentlyConnected == true" link="6" stubbed="0" >g_oMS.bCurrentlyConnected == true</result>
          </results>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=724 y=251 ?>
          <!--Delete MS Connection-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=312 y=558 ?>
          <!--JAVA: PrepaidAPISessionCompletion-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPISessionCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START SessionCompletion *********");
Session.g_oAPI.lPlatformSessionEndTime = Server.getUTCTime();
Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("procSessionCompletion returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC SESSION COMPLETION");
	Server.logError("ERROR: procSessionCompletion returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.Branch.1" ><?xtml-editor x=50 y=262 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Postpaid" link="17" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="15" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Result.id == 1) {
	Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);
}]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Pactolus.Branch.1" ><?xtml-editor x=48 y=552 ?>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="bChargeForIVRTime, Sub.id &gt; 0" link="16" stubbed="0" >g_oAPI.bChargeForIVRTime == true
AND g_oSUB.lSubscriberId &gt; 0</result>
          </results>
        </action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=159 y=690 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="8" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);

Session.g_oAPI.strDestinationNumber = Session.g_oAPI.strOriginationNumber;
Server.logInfo("strDestinationNumber: " + Session.g_oAPI.strDestinationNumber);
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 1)
{
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK;

	switch (Session.f_nReturnCode)
	{
		case -99:
			//Session.g_nErrorMsgNumber = 1001; //db error
			//Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			//Session.g_nErrorMsgNumber = 1007; //restricted dest
			//Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 513;
			break;
		case -4:
			//Session.g_nErrorMsgNumber = 1008; //insufficent digit
			//Session.g_oAPI.nSessionTerminationReason = 4;
			//Session.g_nPromptToPlay = 514;
			break;
		case -5:
			//Session.g_nErrorMsgNumber = 1014; //general error
			//Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			//Session.g_nErrorMsgNumber = 2002; //low balance
			//Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 507;
			break;
		case -7:
			//Session.g_nErrorMsgNumber = 2003; //no rate dest
			//Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			//Session.g_nErrorMsgNumber = 1007; //restricted dest
			//Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			//Session.g_nErrorMsgNumber = 2003; //no rate dest
			//Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 514;							
		case -50:
			//Session.g_nErrorMsgNumber = 1000; //jvm server error
			//Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} 
]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=284 y=371 ?>
          <!--procSessionCompletion-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPISessionCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC SESSION COMPLETION");
	Server.logError("ERROR: procSessionCompletion returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="259" y-coord="59" width="125" height="25" text="Click to edit text." font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="OnTimer" start="77" event="OnTimer" returns="void" >
      <parameters >
        <parameter name="nTimerId" type="i4"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >0</var>
        <var name="f_lCurrentTime" type="i8" >0</var>
        <var name="f_oTimer" type="object" ></var>
        <var name="f_oMS" type="object" ></var>
        <var name="f_bLowBalance" type="boolean" >0</var>
        <var name="f_oTempObject" type="object" ></var>
        <var name="p_lparam1" type="i8" >0</var>
        <var name="p_lparam2" type="i8" >0</var>
        <var name="p_bparam3" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="77" plug-in="Pactolus.Branch.1" ><?xtml-editor x=43 y=55 ?>
          <results >
            <result name="Default" link="79" stubbed="0"/>
            <result name="TimerId = CutOffTimerId" link="85" stubbed="0" >nTimerId == g_nCutOffTimerId</result>
            <result name="ArrayCallLegs.length == 0" link="74" stubbed="0" >g_oArrayCallLegs.length == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("THIS TIMER ID OCCURES : " + Session.nTimerId);

js_disable_event();

js_initMS(Session.f_oMS, Session.s_strMSType);

if (true == Session.g_oConfMS.bCurrentlyInConf) {

	Session.f_oMS = Session.g_oConfMS;

	Server.logInfo("Use conf. media server for process on timer.");	

} else if (true == Session.g_oMOH.bCurrentlyInConf || true == Session.g_oMOH.bCurrentlyConnected) {

	Session.f_oMS = Session.g_oMOH;

	Server.logInfo("Use MOH media server for process on timer.");		

} else {

	Session.f_oMS = Session.g_oMS;

}



js_initTimerPrompts(Session.g_oPrompts);



if(Session.g_oTimerThreshold1.lTimerId == Session.nTimerId) {

	Session.f_oTimer = Session.g_oTimerThreshold1;

	Session.g_oPrompts.nTime = Session.g_oTimerThreshold1.nThresholdTime;	

} else if(Session.g_oTimerThreshold2.lTimerId == Session.nTimerId) {

	Session.f_oTimer = Session.g_oTimerThreshold2;

	Session.g_oPrompts.nTime = Session.g_oTimerThreshold2.nThresholdTime;		

} else if(Session.g_oTimerThreshold3.lTimerId == Session.nTimerId) {

	Session.f_oTimer = Session.g_oTimerThreshold3;

	Session.g_oPrompts.nTime = Session.g_oTimerThreshold3.nThresholdTime;	

}





Server.logInfo("g_oArrayCallLegs.length:" + Session.g_oArrayCallLegs.length);

Server.logInfo("g_nCurrentArrayIndex is:" + Session.g_nCurrentArrayIndex);

Server.logInfo("OnTimer: determine which B leg Timer.");

for (var i = 0; i < Session.g_oArrayCallLegs.length; i++) {

	if(Session.g_oArrayCallLegs[i].oTimer.lTimerId == Session.nTimerId ||

	   Session.g_oArrayCallLegs[i].oTimerGSX.lTimerId == Session.nTimerId) {

	 	Session.g_nCurrentArrayIndex = i;

	 	Server.logInfo("timer for g_nCurrentArrayIndex:" + Session.g_nCurrentArrayIndex);

	}	   

	else {

		Session.g_nCurrentArrayIndex = Session.g_oArrayCallLegs.length - 1;

		Server.logInfo("NOT timer for B legs, g_nCurrentArrayIndex is:" + Session.g_nCurrentArrayIndex);

	}

}

Server.logInfo("g_oArrayCallLegs.length:" + Session.g_oArrayCallLegs.length);

]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=20 y=535 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=379 y=518 ?>
          <!--Hang Up Phone  B-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="64" stubbed="0"/>
          </results>
        </action>
        <action id="62" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1053 y=616 ?>
          <!--Re-originate-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Session.f_b_A_re_INVITE = false;
Session.f_b_B_re_INVITE = false;
Session.f_b_New_A_SDP = false;
Session.f_b_New_B_SDP = false;]]></script>
          </scripts>
        </action>
        <action id="64" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=688 y=516 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="70" stubbed="1"/>
            <result name="Direct Call" link="70" stubbed="1" >g_bDirectCallFlag == true</result>
            <result name="initiate dialout A" link="70" stubbed="1" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strAccessNumCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strIvrCallback</result>
            <result name="Sucess &amp;&amp; !LowBalance" link="62" stubbed="0" >f_nReturnCode == s_sSUCCESS
AND f_bLowBalance == false</result>
            <result name="Success &amp;&amp; LowBalance" link="83" stubbed="0" >f_nReturnCode == s_sSUCCESS
AND f_bLowBalance == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
Session.g_bDoNotEnableEvents = true;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bDoNotEnableEvents = false;]]></script>
          </scripts>
        </action>
        <action id="67" plug-in="Standard.EndSession.1" ><?xtml-editor x=22 y=468 ?></action>
        <action id="70" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=911 y=373 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="67" stubbed="1"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=645 y=282 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="67" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bDoNotEnableEvents = true;]]></script>
          </scripts>
        </action>
        <action id="74" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=339 y=175 ?>
          <!--ProcessOnTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcessOnTimer&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >nTimerId</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >f_oTempObject</parameter>
            <parameter >f_oTimer</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >f_oTempObject</parameter>
            <parameter >g_strContact</parameter>
            <parameter >s_strContentType</parameter>
            <parameter >f_oMS</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oPrompts</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="TimerMaxTime.lTimerId" link="91" stubbed="0" >nTimerId == g_oTimerMaxTime.lTimerId</result>
            <result name="TimerBillingCycle.lTimerId" link="91" stubbed="0" >nTimerId == g_oTimerBillingCycle.lTimerId</result>
            <result name="f_nReturnCode != 0" link="92" stubbed="1" >f_nReturnCode != 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Session.nTimerId == Session.g_oTimerMOH.lTimerId)
{
	Session.g_oMOH = Session.f_oMS;
}
if (-2 == Session.f_nReturnCode)
	Session.f_bLowBalance = true;
else
	Session.f_bLowBalance = false;]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=39 y=314 ?>
          <!--StopTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="80" stubbed="0"/>
            <result name="returnCode = -2" link="61" stubbed="0" >f_nReturnCode == -2</result>
            <result name="returnCode = -4" link="67" stubbed="1" >f_nReturnCode == -4</result>
            <result name="returnCode = -5" link="70" stubbed="0" >f_nReturnCode == -5</result>
            <result name="returnCode = -3" link="81" stubbed="0" >f_nReturnCode == -3</result>
            <result name="returnCode = -6" link="64" stubbed="0" >f_nReturnCode == -6</result>
          </results>
        </action>
        <action id="76" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1025 y=757 ?>
          <!--"ProcLowBalance"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcLowBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Session.f_b_A_re_INVITE = false;
Session.f_b_B_re_INVITE = false;
Session.f_b_New_A_SDP = false;
Session.f_b_New_B_SDP = false;]]></script>
          </scripts>
        </action>
        <action id="78" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=795 y=41 ?>
          <!--ProcTerminateConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcTerminateConf&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="83" stubbed="0"/>
            <result name="Direct Call" link="70" stubbed="0" >g_bDirectCallFlag == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bOutOfMoney = true;]]></script>
          </scripts>
        </action>
        <action id="79" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=340 y=15 ?>
          <!--ProcessOnTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcessOnTimer&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >nTimerId</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimer</parameter>
            <parameter >f_oTimer</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
            <parameter >s_strContentType</parameter>
            <parameter >f_oMS</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oPrompts</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="TimerMaxTime.lTimerId" link="91" stubbed="0" >nTimerId == g_oTimerMaxTime.lTimerId</result>
            <result name="TimerBillingCycle.lTimerId" link="91" stubbed="0" >nTimerId == g_oTimerBillingCycle.lTimerId</result>
            <result name="f_nReturnCode != 0" link="92" stubbed="1" >f_nReturnCode != 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Session.nTimerId == Session.g_oTimerMOH.lTimerId)
{
	Session.g_oMOH = Session.f_oMS;
}
if (-2 == Session.f_nReturnCode)
	Session.f_bLowBalance = true;
else
	Session.f_bLowBalance = false;]]></script>
          </scripts>
        </action>
        <action id="80" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=346 y=298 ?>
          <!--ProcTerminateConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcTerminateConf&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="72" stubbed="0"/>
          </results>
        </action>
        <action id="81" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=438 y=439 ?>
          <!--Hang Up Phone  B-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="82" stubbed="0"/>
          </results>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=667 y=437 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="70" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bDoNotEnableEvents = true;]]></script>
          </scripts>
        </action>
        <action id="83" plug-in="Pactolus.Branch.1" ><?xtml-editor x=801 y=733 ?>
          <!--Click2Dial?-->
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="Type does not allow ReOrg" link="70" stubbed="1" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strOneStageDialing
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strIvrCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strAccessNumCallback</result>
          </results>
        </action>
        <action id="85" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=76 y=652 ?>
          <!--put A on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="81" stubbed="0"/>
            <result name="Success" link="86" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {

	Session.g_oAPI.nCallTerminationReason = 6;

	Session.g_oAPI.nSessionTerminationReason = 5;

}



if(0 != Session.f_nReturnCode) {

	Server.logError("ERROR putting A leg on hold before playing threshold prompt. Session will end.");

}]]></script>
          </scripts>
        </action>
        <action id="86" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=297 y=633 ?>
          <!--put B on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="61" stubbed="0"/>
            <result name="Success" link="87" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {

	Session.g_oAPI.nCallTerminationReason = 6;

	Session.g_oAPI.nSessionTerminationReason = 5;

}



if(0 != Session.f_nReturnCode) {

	Server.logError("ERROR putting B leg on hold before playing threshold prompt. Session will end.");

}]]></script>
          </scripts>
        </action>
        <action id="87" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=162 y=815 ?>
          <!--outdial from MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="88" stubbed="0"/>
            <result name="Success" >f_nReturnCode == s_sSUCCESS</result>
            <result name="A Leg Hangup" >f_nReturnCode == -2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_initMS(Session.g_oMS, Session.s_strMSType);]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {

	Session.g_oAPI.nCallTerminationReason = 4;
	Session.g_oAPI.nSessionTerminationReason = 12;
	Server.logError("ERROR outdialing A leg to media server. Session will end.");

} else if(3 == Result.id) {

	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
	Server.logInfo("Could not connect A leg to MS because A leg has hung up. Session will end.");

}]]></script>
          </scripts>
        </action>
        <action id="88" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=402 y=770 ?>
          <!--play warning threshold as a tone-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >340</audio>
          </play>
          <results >
            <result name="Default" link="89" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//if(Session.p_oPrompts.nTime == 0) {

//	Session.p_oPrompts.nTime = Session.p_nPrompt;

//}]]></script>
          </scripts>
        </action>
        <action id="89" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=392 y=1023 ?>
          <!--delete MS connection-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="90" stubbed="0"/>
          </results>
        </action>
        <action id="90" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=568 y=1116 ?>
          <!--outdial-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;OutdialParty&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >p_lparam1</parameter>
            <parameter >p_lparam2</parameter>
            <parameter >g_oCallLegB.strSIPStatus</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >p_bparam3</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="0"/>
            <result name="SUCCESS" link="40" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// We do not want to try the back up softswitch in case of a failure, so we need to save this off and clear the value.

// We will set this back at the end of the attempt.

Session.g_strBackupSoftswitch = Session.g_oCallLegB.strBackupRequestUri;

Session.g_oCallLegB.strBackupRequestUri = "";

// set the A Leg sdp to what the A leg originally offered. This will be passed
// on to the B Leg and will allow the B Leg to choose from what the A Leg 
// offered originally. That way we're guaranteed that the calls will be brought
// back together.
Session.g_oCallLegA.strContent = Session.g_oCallLegA.strOriginalContent;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if(Session.f_nReturnCode != 0) {
	Server.logInfo("Problem bringing A and B back together after playing threshold prompt. f_nReturnCode: " + Session.f_nReturnCode);

	if(2 == Session.f_nReturnCode) {
		Server.logInfo("B Leg returned Busy.");
		Session.f_bBLegError = true;
	} else if(-2 == Session.f_nReturnCode) {
		Server.logInfo("B Leg returned Called Party Error.");
		Session.f_bBLegError = true;
	} else if(1 == Session.f_nReturnCode) {
		Server.logInfo("B Leg returned Ring No Answer.");	
		Session.f_bBLegError = true;
	} else {
		Server.logError("B leg returned: " + Session.f_nReturnCode);
	}
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[

Session.g_oCallLegB.strBackupRequestUri = Session.g_strBackupSoftswitch;
]]></script>
          </scripts>
        </action>
        <action id="91" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=574 y=106 ?>
          <!--ReAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReAuthorizeDestination&quot;" return="f_nReturnCode" external-function="0" library="" >
            <parameter >nTimerId</parameter>
          </function>
          <results >
            <result name="Default" link="78" stubbed="0"/>
            <result name="Success" link="40" stubbed="1" >f_nReturnCode == 0</result>
            <result name="TimerBillingCycle.lTimerId" link="40" stubbed="1" >nTimerId == g_oTimerBillingCycle.lTimerId</result>
          </results>
        </action>
        <action id="92" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=24 y=184 ?>
          <!--StopOneTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopOneTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="75" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="GetDestNumber" start="48" event="GetDestNumber" returns="i4" >
      <local-vars >
        <var name="f_bIsDestValid" type="boolean" >0</var>
        <var name="f_bCallCSR" type="boolean" >0</var>
        <var name="f_bMainMenu" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bRouteToCSR" type="boolean" >0</var>
        <var name="f_nReturnCode" type="i4" >-99</var>
        <var name="f_nStarStar" type="i4" >359</var>
        <var name="f_nToGoToMainMenu" type="i4" >946</var>
        <var name="f_nTimeout" type="i4" >0</var>
        <var name="f_nOption1" type="i4" >99</var>
        <var name="f_nOption2" type="i4" >99</var>
        <var name="f_nOption3" type="i4" >99</var>
      </local-vars>
      <actions >
        <action id="48" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=20 ?>
          <results >
            <result name="Default" link="58" stubbed="0"/>
            <result name="LCR, NumDialed,No Conf" link="59" stubbed="0" >g_oAPI.bLastCallRedial == true
AND g_oAPI.strLastDestination != ""
AND g_oCallLegB.strConfCallFlag  != "T"</result>
          </results>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=571 y=182 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nAUTHORIZE_DESTINATION"/>
        </action>
        <action id="45" plug-in="Standard.EndSession.1" ><?xtml-editor x=712 y=52 ?></action>
        <action id="47" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=490 y=19 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="45" stubbed="0"/>
          </results>
        </action>
        <action id="49" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=107 y=229 ?>
          <!--play invalid entry-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nGetDestTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="0" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="50" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="exceed retries" link="47" stubbed="1" >g_nNumRetry &gt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=36 y=432 ?>
          <!--To enter a new destination number press 1, to redial the last number press 2 -->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nGetDestTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="0" clear-digits="0" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >590</audio>
            <audio type="index" >311</audio>
            <audio type="index" >589</audio>
            <audio type="index" >312</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="49" stubbed="0"/>
            <result name="Success" link="51" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="51" plug-in="Pactolus.Branch.1" ><?xtml-editor x=336 y=433 ?>
          <results >
            <result name="Default" link="49" stubbed="0"/>
            <result name="get new destination number" link="58" stubbed="0" >g_strDigit match "1"</result>
            <result name="redial last number" link="11" stubbed="0" >g_strDigit match "2"</result>
            <result name="max redials exceeded" link="52" stubbed="0" >g_oAPI.nTotalRedials &gt;= g_oAPI.nMaxRedialsAllowed
AND  g_oAPI.nMaxRedialsAllowed != 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_strDigit == "2")



{



	Session.g_oAPI.nTotalRedials++;



	if ((Session.g_oAPI.nTotalRedials <= Session.g_oAPI.nMaxRedialsAllowed) ||



		(Session.g_oAPI.nMaxRedialsAllowed == 0))



	{



		Session.g_oAPI.strDestinationNumber = Session.g_oAPI.strLastDestination;



		Session.g_strTerminationDigit = "";



		Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaRedial;



	}



	else



	{



		Session.g_strDigit = "";



	}



	



}



]]></script>
          </scripts>
        </action>
        <action id="52" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=599 y=367 ?>
          <!--The maximum number of redials has been reached. Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nGetDestTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="0" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >591</audio>
          </play>
          <results >
            <result name="Default" link="47" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="58" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=284 y=19 ?>
          <!--507: Please enter the phone number you wish to reach. For international calls start with 011.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nGetDestTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="s_strOutdialDigitMap" language="g_oAPI.strLanguage" digits="g_oAPI.strDestinationNumber" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >509</audio>
            <audio type="index" >f_nOption1</audio>
            <audio type="index" >f_nOption2</audio>
            <audio type="index" >f_nOption3</audio>
          </play>
          <results >
            <result name="Default" link="47" stubbed="0"/>
            <result name="Success" link="11" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="11" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTimeout = Session.s_nGetDestTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");

Session.g_oAPI.strDestinationNumber = "";



Session.g_strTerminationDigit = "";



Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strBLegOutdialViaIvr;




if("F" == Session.g_oAPI.strMainMenuFlag || "T" == Session.g_oCallLegB.strConfCallFlag) {



	Session.f_nStarStar = 99;



	Session.f_nToGoToMainMenu = 99;



}

// set the options for the get dest prompt ...
// if we're not playing the "followed by the pound key" ... set 
// option 1 to the f_nStarStar and option 2 to f_nToGoToMainMenu.
if ("F" == Session.s_strDestPromptPoundKey)
{
	Session.f_nOption1 = Session.f_nStarStar;
	Session.f_nOption2 = Session.f_nToGoToMainMenu;
}
else
{
	Session.f_nOption1 = 580; // followed by the pound key prompt ...
	Session.f_nOption2 = Session.f_nStarStar;
	Session.f_nOption3 = Session.f_nToGoToMainMenu;
}


]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("THE DESTINATION COLLECTED IS: " + Session.g_oAPI.strDestinationNumber);
var myString = new String(Session.g_oAPI.strDestinationNumber);
if ('#' == myString.charAt(0) )
{
	Server.logInfo("FIRST CHAR OF DESTINATION IS #, STRIP IT");
	Session.g_oAPI.strDestinationNumber = myString.substring(1, myString.length);
}
Session.g_oAPI.strDestinationNumber = js_translate_destination(Session.s_strCustomerCode, Session.g_oAPI.strDestinationNumber, Session.g_oAPI.strStrippedOrigNumber, Session.g_oAPI.nOrigCountryId);
Server.logInfo("THE DESTINATION AFTER TRANSLATION IS: " + Session.g_oAPI.strDestinationNumber);
if (Result.id != 2) { //ms error
	Session.g_oAPI.nSessionTerminationReason = 12;
}]]></script>
          </scripts>
        </action>
        <action id="59" plug-in="Pactolus.Branch.1" ><?xtml-editor x=28 y=149 ?>
          <results >
            <result name="Default" link="50" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetPinNumber" start="75" event="GetPinNumber" returns="i4" >
      <local-vars >
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_nGetPinPrompt" type="i4" >501</var>
        <var name="f_nTimeout" type="i4" >0</var>
        <var name="f_intBongPrompt" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="75" plug-in="Pactolus.Branch.1" ><?xtml-editor x=29 y=38 ?>
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="payPhoneSwipeFlag" link="76" stubbed="0" >g_oAPI.bPayPhoneSwipeFlag == true</result>
            <result name="Shared Access number, don't prompt for pin." link="21" stubbed="0" >g_oAPI.bSharedAccessNumber == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_intErrorMsgNumber = 0;
Session.g_strTerminationDigit = "";

if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
	Session.f_oCSRPrompts.intOR = 362;
	Session.f_oCSRPrompts.intPRESS = 310;
	Session.f_oCSRPrompts.intZERO = 1;
	Session.f_oCSRPrompts.intFOR_OPERATOR = 931;
} else {
	Session.f_oCSRPrompts.intOR = 99;
	Session.f_oCSRPrompts.intPRESS = 99;
	Session.f_oCSRPrompts.intZERO = 99;
	Session.f_oCSRPrompts.intFOR_OPERATOR = 99;
}
if (Session.g_bFirstTry && Session.g_oAPI.bPayPhoneSwipeFlag)
{
	Session.f_intBongPrompt = 235;
}
else
{
	Session.f_intBongPrompt = 99;
}
if(Session.g_oAPI.bSharedAccessNumber == true){
	Session.g_oSUB.strUserPin = Session.g_strPinNumber
}]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=470 y=18 ?>
          <!--506: Please enter your card number Or Press 0-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >f_nGetPinPrompt</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="1"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_strTerminationDigit = "";

Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=765 y=190 ?>
          <!--return s_nAUTHENTICATE_PIN-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nAUTHENTICATE_PIN"/>
        </action>
        <action id="40" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=487 y=540 ?>
          <!--Welcome prompt Index Or Press 0-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nWelcomePromptIndex</audio>
            <audio type="index" >f_nGetPinPrompt</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="1"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="42" plug-in="Pactolus.Branch.1" ><?xtml-editor x=34 y=230 ?>
          <!--g_oAPI.strWelcomePromptType = U or I-->
          <results >
            <result name="Default" link="80" stubbed="0"/>
            <result name="g_oAPI.strWelcomePromptType==U" link="81" stubbed="0" >g_oAPI.strWelcomePromptType match "U"
AND g_bFirstTry == true</result>
            <result name="g_oAPI.strWelcomePromptType==I" link="82" stubbed="0" >g_oAPI.strWelcomePromptType match "I"
AND g_bFirstTry == true
AND g_oAPI.nWelcomePromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_nErrorMsgNumber = 0;
Session.g_strTerminationDigit = "";

if((Session.g_oACD.strPinZeroOut == "T" || Session.g_oAPI.strCustomerServicePhone != "" || Session.g_oAPI.strThirdPartyOutdialNumber != "") && Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strTwoStageDialing) {
	
	
	if(Session.g_oAPI.strLanguage == "kor" || Session.g_oAPI.strLanguage == "jap") {	
		Session.f_oCSRPrompts.nOR = 362;
		Session.f_oCSRPrompts.nPRESS = 931;
		Session.f_oCSRPrompts.nZERO = 1;
		Session.f_oCSRPrompts.nFOR_OPERATOR = 310;
	} 
	else if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
		Server.logInfo("Special case: Farsi language");
		Session.f_oCSRPrompts.nOR = 362;
		Session.f_oCSRPrompts.nPRESS = 931;  //for opp
		Session.f_oCSRPrompts.nZERO = 3870;  //press zero
		Session.f_oCSRPrompts.nFOR_OPERATOR = 99;  //silence
	}else {
		Session.f_oCSRPrompts.nOR = 362;
		Session.f_oCSRPrompts.nPRESS = 310;
		Session.f_oCSRPrompts.nZERO = 1;
		Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
	}			
	
	
	
	
} else {
	Session.f_oCSRPrompts.nOR = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}


if (Session.g_oAPI.nPrepaidPinLength > 0) {
	Session.f_nGetPinPrompt = 579;
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.g_bFirstTry)
{
	Session.g_bFirstTry = false;
}]]></script>
          </scripts>
        </action>
        <action id="43" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=478 y=282 ?>
          <!--Welcome prompt URL Or Press 0-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strWelcomePromptUrl</audio>
            <audio type="index" >f_nGetPinPrompt</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="1"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="55" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=1019 y=573 ?>
          <!--send MEDIASERVER ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: connect caller to ms";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Pactolus.Branch.1" ><?xtml-editor x=760 y=536 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="s_strSendAlarmFlag==T" link="55" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 12;]]></script>
          </scripts>
        </action>
        <action id="73" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=935 y=461 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
        </action>
        <action id="74" plug-in="Standard.EndSession.1" ><?xtml-editor x=1148 y=501 ?></action>
        <action id="76" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=39 y=478 ?>
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >f_intBongPrompt</audio>
            <audio type="index" >4164</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="0"/>
            <result name="Success" link="21" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bFirstTry = false;
var myPin = new String(Session.g_oSUB.strUserPin);
if (Session.g_oAPI.nPrepaidPinLength > 0 && myPin.length > Session.g_oAPI.nPrepaidPinLength)
{
	Server.logInfo("OLD PIN IS: " + Session.g_oSUB.strUserPin);
	Server.logInfo("PAY PHONE SWIPE, PIN IS LONGER THAN PIN LENGTH IN DB");
	Server.logInfo("PIN LENGTH IN DB IS: " + Session.g_oAPI.nPrepaidPinLength);
	Server.logInfo("USER ENTERED PIN LENGTH IS: " + myPin.length);
	Session.g_oSUB.strUserPin = myPin.substring(0, Session.g_oAPI.nPrepaidPinLength);
	Server.logInfo("NEW PIN IS: " + Session.g_oSUB.strUserPin);
}]]></script>
          </scripts>
        </action>
        <action id="80" plug-in="Pactolus.Branch.1" ><?xtml-editor x=241 y=142 ?>
          <!--Play "Or Press 0 for Operator"-->
          <results >
            <result name="Default" link="83" stubbed="0"/>
            <result name="or press 0 for operator" link="18" stubbed="0" >s_bPinPlayZeroForOperator == true</result>
          </results>
        </action>
        <action id="81" plug-in="Pactolus.Branch.1" ><?xtml-editor x=241 y=252 ?>
          <!--Play "Or Press 0 for Operator"-->
          <results >
            <result name="Default" link="84" stubbed="0"/>
            <result name="or press 0 for operator" link="43" stubbed="0" >s_bPinPlayZeroForOperator == true</result>
          </results>
        </action>
        <action id="82" plug-in="Pactolus.Branch.1" ><?xtml-editor x=242 y=354 ?>
          <!--Play "Or Press 0 for Operator"-->
          <results >
            <result name="Default" link="85" stubbed="0"/>
            <result name="or press 0 for operator" link="40" stubbed="0" >s_bPinPlayZeroForOperator == true</result>
          </results>
        </action>
        <action id="83" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=475 y=149 ?>
          <!--506: Please enter your card number.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >f_nGetPinPrompt</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="1"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_strTerminationDigit = "";

Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="84" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=483 y=421 ?>
          <!--Welcome prompt URL-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strWelcomePromptUrl</audio>
            <audio type="index" >f_nGetPinPrompt</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="1"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="85" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=488 y=674 ?>
          <!--Welcome prompt Index-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nWelcomePromptIndex</audio>
            <audio type="index" >f_nGetPinPrompt</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="1"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetDirectCallId" start="18" event="GetPinNumber" returns="i4" >
      <local-vars >
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_nReturnCode" type="i4" >0</var>
        <var name="f_nGetDirectCallIdTimeout" type="i4" >40</var>
        <var name="isValidCallId" type="boolean" >0</var>
        <var name="f_nTimeoutRetryCount" type="i4" >0</var>
        <var name="f_nMaxRetries" type="i4" >3</var>
        <var name="f_nTimeout" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=24 y=77 ?>
          <!--593: Please enter the easy call id followed by the pound key.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strDirectCallDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strDirectCallId" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >593</audio>
          </play>
          <results >
            <result name="Default" link="86" stubbed="0"/>
            <result name="Success" link="78" stubbed="0"/>
            <result name="Error" link="86" stubbed="0"/>
            <result name="Timeout" link="83" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strDirectCallId = "";
Session.g_strTerminationDigit = "";

Session.g_nTimeout = Session.f_nGetDirectCallIdTimeout;
if ( 0 < Session.f_nTimeoutRetryCount && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");



]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=452 y=799 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nAUTHORIZE_DESTINATION"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Returning from getdirectcallid function.");]]></script>
          </scripts>
        </action>
        <action id="74" plug-in="Standard.EndSession.1" ><?xtml-editor x=499 y=145 ?></action>
        <action id="76" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=647 y=220 ?>
          <!--I'm sorry, I did not hear anything....-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nGetDirectCallIdTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >1810</audio>
          </play>
          <results >
            <result name="Default" link="18" stubbed="1"/>
            <result name="Success" link="18" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="18" stubbed="1"/>
          </results>
        </action>
        <action id="78" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=29 y=293 ?>
          <!--Get subscriber id and destination number.-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIIsValidDirectCallId&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="86" stubbed="0"/>
            <result name="Error" link="86" stubbed="0" >f_nReturnCode == -1</result>
            <result name="Success" link="90" stubbed="0" >f_nReturnCode == 0</result>
            <result name="No Record Found" link="80" stubbed="0" >f_nReturnCode == -3</result>
            <result name="Dest Num Empty" link="89" stubbed="0" >f_nReturnCode == -2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.lSubscriberId = "";
Session.f_nReturnCode = -50;
Session.g_oAPI.strDestinationNumber = "";

if (Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD) 
{
    Session.g_oAPI.strPostPaidFlag = "T";
} 

if (Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD)
{
    Session.g_oAPI.strPostPaidFlag = "F";
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Subscriber id = " + Session.g_oSUB.lSubscriberId );
Server.logInfo("Destination Number = " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Service Id = " + Session.g_oSUB.nServiceId);
Server.logInfo("Prepaid Balance = " + Session.g_oSUB.fPrepaidBalance);
Server.logInfo("Return code = " + Session.f_nReturnCode);]]></script>
          </scripts>
        </action>
        <action id="80" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=622 y=364 ?>
          <!--598:  I'm sorry, there are no subscriber's with that easy call id.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nGetDirectCallIdTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >598</audio>
          </play>
          <results >
            <result name="Default" link="86" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="83" plug-in="Pactolus.Branch.1" ><?xtml-editor x=325 y=208 ?>
          <!--MaxRetries Exceeded?-->
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="MaxRetries Exceeded" link="86" stubbed="1" >f_nTimeoutRetryCount &gt;= f_nMaxRetries</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTimeoutRetryCount++;]]></script>
          </scripts>
        </action>
        <action id="86" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=304 y=103 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
        </action>
        <action id="89" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=547 y=527 ?>
          <!--597: The easy call destination number for the subscriber has not been set.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nGetDirectCallIdTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >597</audio>
          </play>
          <results >
            <result name="Default" link="86" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="90" plug-in="Pactolus.Branch.1" ><?xtml-editor x=40 y=508 ?>
          <!--Is PostPaid or Prepaid?-->
          <results >
            <result name="Default" link="86" stubbed="1"/>
            <result name="Postpaid" link="91" stubbed="0" >g_oAPI.strPostPaidFlag == "T"</result>
            <result name="Prepaid" link="92" stubbed="0" >g_oAPI.strPostPaidFlag == "F"</result>
          </results>
        </action>
        <action id="91" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=322 y=565 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="86" stubbed="1"/>
            <result name="Success or First Use" link="21" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Hangup" >f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -10</result>
            <result name="Get pin again" >f_nReturnCode == -3
OR f_nReturnCode == -6
OR f_nReturnCode == -7</result>
            <result name="Pin locked or Low Balance" >f_nReturnCode == -5
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

Session.f_nReturnCode = -50;

if(Session.g_bGetPinOnly) {
	Session.g_oSUB.strUserPin = Session.g_strAuthenticationNbr + Session.g_oSUB.strUserPin;	
} else {
	Session.g_oSUB.strUserPin = Session.g_oSUB.strAccountNumber + Session.g_oSUB.strUserPin;
}	
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);

js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="92" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=85 y=680 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="86" stubbed="1"/>
            <result name="Get Dest" link="21" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Get Pin Again" >f_nReturnCode == 6</result>
            <result name="Recharge" >f_nReturnCode == 1</result>
            <result name="Play Reason" >f_nReturnCode == 3
OR f_nReturnCode == 4
OR f_nReturnCode == 7
OR f_nReturnCode == 8
OR f_nReturnCode == 10
OR f_nReturnCode == 11
OR f_nReturnCode == 12</result>
            <result name="Pin Locked" >f_nReturnCode == 5</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);

Session.f_nReturnCode = -50;
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();

Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);

]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnOptions" start="1" event="OnOptions" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strCallInfo" type="string" pass="byref"/>
        <parameter name="strContact" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentEncoding" type="string" pass="byref"/>
        <parameter name="strContentLanguage" type="string" pass="byref"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strRemotePartyId" type="string" pass="byref"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=136 y=204 ?>
          <!--200 OK-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="3" plug-in="Standard.EndSession.1" ><?xtml-editor x=370 y=230 ?></action>
      </actions>
    </function>
    <function name="ReOriginate" start="71" event="ReOriginate" returns="void" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bLowBalance" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="71" plug-in="Pactolus.Branch.1" ><?xtml-editor x=12 y=113 ?>
          <results >
            <result name="Default" link="72" stubbed="0"/>
            <result name="bAppPropSuppressOnHold" link="54" stubbed="0" >g_oAPI.bSuppressOnHold == true</result>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=526 y=363 ?>
          <!--call is GET_DEST-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nGET_DESTINATION;]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=588 y=33 ?>
          <!--"HangUpParty"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="58" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="39" plug-in="Pactolus.Branch.1" ><?xtml-editor x=253 y=358 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="f_bLowBalance" link="53" stubbed="0" >f_bLowBalance == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD && Session.g_oSUB.fPrepaidBalance <= Session.g_oCC.fMinPrepaidBalance && Session.g_oAPI.strAllowZeroCostFlag != "T") {
	Session.f_bLowBalance = true;
} 


if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD && 
   Session.g_oAPI.fCreditUsed >= Session.g_oAPI.fCreditLimit && 
   Session.g_oAPI.fCreditLimit > 0 && Session.g_oAPI.strAllowZeroCostFlag != "T") {
	Session.f_bLowBalance = true;
}

]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=612 y=563 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="53" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=32 y=508 ?>
          <!--Low balance-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="70" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 5;
Session.g_oAPI.nSessionTerminationReason = 8;]]></script>
          </scripts>
        </action>
        <action id="54" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=462 y=139 ?>
          <!--outdial from MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="55" stubbed="0"/>
          </results>
        </action>
        <action id="55" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=264 ?>
          <!--SUCCESS?-->
          <results >
            <result name="Default" link="26" stubbed="1"/>
            <result name="SUCCESS?" link="39" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller hung up" link="58" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Standard.EndSession.1" ><?xtml-editor x=749 y=136 ?></action>
        <action id="70" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=314 y=528 ?>
          <!--ProcLowBalance-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcLowBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="0"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=245 y=32 ?>
          <!--put A on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="26" stubbed="0"/>
            <result name="Success" link="54" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="BalanceTransfer" start="20" event="BalanceTransfer" returns="i4" >
      <local-vars >
        <var name="f_bExceedsBalXferTries" type="boolean" >0</var>
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_strDigit" type="string" ></var>
        <var name="f_fBalance" type="float" >0</var>
        <var name="nBalance" type="i4" >0</var>
        <var name="nUnitPrompt" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="20" plug-in="Pactolus.Branch.1" ><?xtml-editor x=19 y=42 ?>
          <!--check rechargeable-->
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="Rechargeable" link="1" stubbed="0" >g_oBALXFER.strBalanceTransferFlag match "T"</result>
          </results>
        </action>
        <action id="1" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=179 y=185 ?>
          <!--Get donor pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxxxxxxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="g_oBALXFER.strBalXferPin" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >541</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success" link="80" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="59" stubbed="0"/>
            <result name="Cancel" link="40" stubbed="1" >g_oBALXFER.strBalXferPin match "*"</result>
            <result name="Same Pin" link="74" stubbed="0" >g_oBALXFER.strBalXferPin match g_oSUB.strUserPin</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oBALXFER.strBalXferPin = "";


]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=821 y=253 ?>
          <!--"This account has a balance of ...."-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="f_strDigit" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >543</audio>
            <audio type="currency" unit="" >g_oBALXFER.fBalXferBalance</audio>
            <audio type="index" >3848</audio>
            <audio type="index" >311</audio>
            <audio type="index" >544</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="0"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Continue" link="83" stubbed="0" >'Result'  == 'Success'
AND f_strDigit match "1"</result>
          </results>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1417 y=533 ?>
          <!--"bal xfer was successful"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >545</audio>
            <audio type="index" >546</audio>
            <audio type="currency" unit="" >g_oSUB.fPrepaidBalance</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="21" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=359 y=36 ?>
          <!--"not allowed"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >524</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="24" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=842 y=573 ?>
          <!--Exceeds max balance, not allowed-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >543</audio>
            <audio type="currency" unit="" >g_oBALXFER.fBalXferBalance</audio>
            <audio type="index" >3848</audio>
            <audio type="index" >532</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=605 y=60 ?>
          <!--return to main menu-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nMAIN_MENU"/>
        </action>
        <action id="59" plug-in="Pactolus.Branch.1" ><?xtml-editor x=468 y=422 ?>
          <!--termination reason = 6-->
          <results >
            <result name="Default" link="78" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 6;]]></script>
          </scripts>
        </action>
        <action id="74" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=339 y=597 ?>
          <!--invalid pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >502</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Session.f_nNumTries++;]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=834 y=423 ?>
          <!--Not allowed-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >542</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="76" plug-in="Pactolus.Branch.1" ><?xtml-editor x=544 y=611 ?>
          <!--check retries-->
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="Too many tries" link="78" stubbed="1" >f_nNumTries &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
}]]></script>
          </scripts>
        </action>
        <action id="77" plug-in="Standard.EndSession.1" ><?xtml-editor x=1186 y=177 ?></action>
        <action id="78" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=827 y=133 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="77" stubbed="0"/>
          </results>
        </action>
        <action id="80" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=495 y=181 ?>
          <!--PrepaidAPIValidateBalanceXfer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIValidateBalanceXfer&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="78" stubbed="0"/>
            <result name="0 Valid" link="14" stubbed="0" >f_nReturnCode == 0</result>
            <result name="bMaxAttempts" link="78" stubbed="0" >g_oBALXFER.bMaxAttempts == true</result>
            <result name="-2, -6, -12 Invalid" link="74" stubbed="1" >f_nReturnCode == -2
OR f_nReturnCode == -6
OR f_nReturnCode == -12</result>
            <result name="-3,-4,-5 Not Alloved" link="75" stubbed="0" >f_nReturnCode == -3
AND f_nReturnCode == -4
AND f_nReturnCode == -5</result>
            <result name="-7 Max Balance" link="24" stubbed="0" >f_nReturnCode == -7</result>
            <result name="-13 card has no $" link="84" stubbed="0" >f_nReturnCode == -13</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
Server.logInfo("*********JAVA START validateBalanceTransfer *********");
Server.logInfo("donor pin = " + Session.g_oBALXFER.strBalXferPin);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("validate bal xfer returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	switch (Session.f_nReturnCode)
	{
		case -1:
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO CALL JAVA VALIDATE BALANCE XFER, EXIT ON: " + Result.name);
			Server.logError("ERROR: validate bal xfer returned " + Session.f_nReturnCode);				
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1010; //invalid subscriber
			break;
		case -3:
			Session.g_nErrorMsgNumber = 2005; //not rechargable
			break;
		case -4:
			Session.g_nErrorMsgNumber = 2004; //currency mismatch
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1005; //disable subscriber
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2006; //exceed max balance
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -14:
			Session.g_nErrorMsgNumber = 1012; //max retires.
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO CALL JAVA VALIDATE BALANCE XFER, EXIT ON: " + Result.name);
			Server.logError("ERROR: validate bal xfer returned " + Session.f_nReturnCode);				
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			Server.logError("ERROR: FAIL TO CALL JAVA VALIDATE BALANCE XFER, EXIT ON: " + Result.name);
			Server.logError("ERROR: validate bal xfer returned " + Session.f_nReturnCode);				
			break;
	}
} else {
	Session.g_bBalXferPinLocked = true;
}


js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1100 y=263 ?>
          <!--JAVA: PrepaidAPIUnlockPin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START unlockPin() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("unlockPin returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO UNLOCK PIN");
	Server.logError("ERROR: unlockPin returned: " + Session.f_nReturnCode);
}


js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1350 y=395 ?>
          <!--JAVA: PrepaidAPIUnlockPin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="78" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START unlockPin() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("unlockPin returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO UNLOCK PIN");
	Server.logError("ERROR: unlockPin returned: " + Session.f_nReturnCode);
}

js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1090 y=398 ?>
          <!--JAVA: PrepaidAPIBalanceXfer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIBalanceXfer&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="0: Valid Pin" link="85" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-2: Invalid Pin" link="74" stubbed="1" >f_nReturnCode == -2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START transferBalance() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("transferBalance returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA XFER BALANCE, EXIT ON: " + Result.name);
	Server.logInfo("transferBalance returned " + Session.f_nReturnCode);	
	switch (Session.f_nReturnCode)
	{
		case -1:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1010; //invalid pin
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}

Session.g_bBalXferPinLocked = false;]]></script>
          </scripts>
        </action>
        <action id="84" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=841 y=734 ?>
          <!--zero balance card-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >543</audio>
            <audio type="currency" unit="" >0</audio>
            <audio type="index" >3848</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries++;]]></script>
          </scripts>
        </action>
        <action id="85" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1183 y=732 ?>
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="bAnnounceCurrencyAsUnits" link="87" stubbed="0" >g_oAPI.bAnnounceCurrencyAsUnits == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_fBalance = Session.g_oSUB.fPrepaidBalance;

js_enable_event();
]]></script>
          </scripts>
        </action>
        <action id="87" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1443 y=759 ?>
          <!--recharge was successful-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >545</audio>
            <audio type="index" >546</audio>
            <audio type="number" >nBalance</audio>
            <audio type="index" >nUnitPrompt</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(1 == Session.f_fBalance) {
	Session.nUnitPrompt = 389; // Unit
} else {
	Session.nUnitPrompt = 390; // Units
}

Session.nBalance = Math.ceil(Session.f_fBalance);

Server.logInfo("Session.nBalance: " + Session.nBalance);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetExpirationDate" start="27" event="GetExpirationDate" returns="i4" >
      <local-vars >
        <var name="f_strExpDate" type="string" >""</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=26 y=110 ?>
          <!--psAPIGetExpDate-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIGetExpDate&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="0"/>
            <result name="Got Exp Date" link="11" stubbed="0" >f_nReturnCode == 0</result>
            <result name="No Exp Date" link="26" stubbed="0" >f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getExpDate returned " + Session.f_nReturnCode);
Server.logInfo("exp date = " + Session.g_oSUB.strExpDate);

if (-1 == Session.f_nReturnCode)
{
	Session.g_nErrorMsgNumber = 1001; //db error
}
else if (-50 == Session.f_nReturnCode)
{
	Session.g_nErrorMsgNumber = 1000; //jvm server error
}
else
{
	Session.g_nErrorMsgNumber = 0;
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=655 y=334 ?>
          <!--s_nSTATE_MAIN_MENU_PRPD_OR_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_MAIN_MENU_PRPD_OR_POPD"/>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=288 y=203 ?>
          <!--Play Exp Date-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >547</audio>
            <audio type="date" >g_oSUB.strExpDate</audio>
          </play>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.EndSession.1" ><?xtml-editor x=824 y=69 ?></action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=456 y=44 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="23" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 5;
Server.logError("ERROR: FAIL TO GET EXP DATE");
Server.logError("ERROR: getExpDate returned " + Session.f_nReturnCode);]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=291 y=373 ?>
          <!--No Exp Date-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >548</audio>
          </play>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="PlayPrepaidBalance" start="5" event="PlayPrepaidBalance" returns="i4" >
      <local-vars >
        <var name="nUnitPrompt" type="i4" >0</var>
        <var name="nBalance" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=33 y=47 ?>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="bAnnounceCurrencyAsUnits" link="7" stubbed="0" >g_oAPI.bAnnounceCurrencyAsUnits == true</result>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=290 y=33 ?>
          <!--502: Your account balance is ...-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >503</audio>
            <audio type="currency" unit="" >g_oSUB.fPrepaidBalance</audio>
          </play>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=571 y=228 ?>
          <!--return MAIN_MENU-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nMAIN_MENU"/>
        </action>
        <action id="7" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=253 y=299 ?>
          <!--502: Your account balance is ...-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >503</audio>
            <audio type="number" >nBalance</audio>
            <audio type="index" >nUnitPrompt</audio>
          </play>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(1 == Session.g_oSUB.fPrepaidBalance) {
	Session.nUnitPrompt = 389; // Unit
} else {
	Session.nUnitPrompt = 390; // Units
}

Session.nBalance = Math.ceil(Session.g_oSUB.fPrepaidBalance);

Server.logInfo("Session.nBalance: " + Session.nBalance);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="MainMenu" start="31" event="MainMenu" returns="i4" >
      <local-vars >
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nCounter" type="i4" >0</var>
        <var name="f_oOptions" type="object" ></var>
        <var name="f_bRecharge" type="boolean" >0</var>
        <var name="f_bBalXfer" type="boolean" >0</var>
        <var name="f_bPlayBalance" type="boolean" >0</var>
        <var name="f_bPlayExpDate" type="boolean" >0</var>
        <var name="f_bMakeCall" type="boolean" >0</var>
        <var name="f_bReviewSD" type="boolean" >0</var>
        <var name="f_bAddSD" type="boolean" >0</var>
        <var name="f_bCustService" type="boolean" >0</var>
        <var name="f_nPACMaxAttempts" type="i4" >2</var>
        <var name="f_bCallbackMaint" type="boolean" >0</var>
        <var name="f_strSoapIp" type="string" ></var>
        <var name="f_nSoapPort" type="i4" >0</var>
        <var name="f_strTransactionId" type="string" ></var>
        <var name="f_strCallbackNumber" type="string" ></var>
        <var name="f_bValidCallbackNbr" type="boolean" >0</var>
        <var name="f_bEasyCallIdMaint" type="boolean" >0</var>
        <var name="f_nPromptIndex" type="i4" >0</var>
        <var name="f_bRegANI" type="boolean" >0</var>
        <var name="f_bUnRegANI" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=18 y=32 ?>
          <!--check return code-->
          <results >
            <result name="Default" link="131" stubbed="0"/>
            <result name="g_nNumRetry &gt;= Max" link="97" stubbed="1" >g_nNumRetry &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.nMaxLoginAttempts > 0) {
	Session.f_nPACMaxAttempts = Session.g_oAPI.nMaxLoginAttempts - 1;
}]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=278 y=494 ?>
          <!--call balanceTransfer()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;BalanceTransfer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=272 y=1204 ?>
          <!--call getExpirationDate()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetExpirationDate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=278 y=603 ?>
          <!--call playPrepaidBalance()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPrepaidBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=533 y=389 ?>
          <!--call creditCardRecharge()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CreditCardRecharge&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Wait For Message" link="127" stubbed="0" >f_nReturnCode == s_nWAIT_FOR_MESSAGE</result>
          </results>
        </action>
        <action id="35" plug-in="Pactolus.Branch.1" ><?xtml-editor x=281 y=689 ?>
          <!--g_oSUB.fPrepaidBalance >= g_oCC.fMinPrepaidBalance-->
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="g_oSUB.fPrepaidBalance &gt;= g_oCC.fMinPrepaidBalance" link="64" stubbed="0" >g_oSUB.fPrepaidBalance  &gt;= g_oCC.fMinPrepaidBalance
OR g_oAPI.strAllowZeroCostFlag == "T"</result>
          </results>
        </action>
        <action id="64" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=768 y=636 ?>
          <!--return GET_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_DESTINATION"/>
        </action>
        <action id="97" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=12 y=629 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="98" stubbed="0"/>
          </results>
        </action>
        <action id="98" plug-in="Standard.EndSession.1" ><?xtml-editor x=7 y=831 ?></action>
        <action id="99" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=512 y=280 ?>
          <!--invalid choice-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error" ><?xtml-editor visible=no?></result>
            <result name="Timeout" ><?xtml-editor visible=no?></result>
            <result name="too many tries" link="97" stubbed="1" >g_nNumRetry &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (5 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuMaxInvalids;	
}]]></script>
          </scripts>
        </action>
        <action id="116" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=280 y=813 ?>
          <!--ReviewSpeedDial-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReviewSpeedDials&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSPEED_DIAL_SE_ID</parameter>
            <parameter >s_strStripLeadingOne</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="117" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=279 y=924 ?>
          <!--call AddSpeedDial()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AddSpeedDial&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSPEED_DIAL_SE_ID</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >s_strStripLeadingOne</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="118" plug-in="Pactolus.Branch.1" ><?xtml-editor x=579 y=785 ?>
          <!--end call? failure?-->
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Failure" link="119" stubbed="0" >f_nReturnCode == s_sFAILURE</result>
            <result name="AuthorizeDest" link="122" stubbed="0" >f_nReturnCode == s_nAUTHORIZE_DESTINATION</result>
            <result name="End Call" link="98" stubbed="1" >f_nReturnCode == s_nEND_CALL</result>
            <result name="Get Dest" link="64" stubbed="0" >f_nReturnCode == s_nGET_DESTINATION</result>
          </results>
        </action>
        <action id="119" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=898 y=744 ?>
          <!--sorry, transaction can't be completed-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >363</audio>
          </play>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="122" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=905 y=938 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nAUTHORIZE_DESTINATION"/>
        </action>
        <action id="124" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=590 y=508 ?>
          <!--insufficient funds-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="97" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="127" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=767 y=384 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="130" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=290 y=1054 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oAPI.nStatePriorToCSR = Session.s_nMAIN_MENU;
Session.g_nNumRetry++;

]]></script>
          </scripts>
        </action>
        <action id="131" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=0 y=240 ?>
          <!--Main menu-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="f_nPACMaxAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >518</audio>
            <audio type="index" >f_oOptions[1].nPress</audio>
            <audio type="index" >f_oOptions[1].nOption</audio>
            <audio type="index" >f_oOptions[1].nHalfTenth</audio>
            <audio type="index" >f_oOptions[2].nPress</audio>
            <audio type="index" >f_oOptions[2].nOption</audio>
            <audio type="index" >f_oOptions[2].nHalfTenth</audio>
            <audio type="index" >f_oOptions[3].nPress</audio>
            <audio type="index" >f_oOptions[3].nOption</audio>
            <audio type="index" >f_oOptions[3].nHalfTenth</audio>
            <audio type="index" >f_oOptions[4].nPress</audio>
            <audio type="index" >f_oOptions[4].nOption</audio>
            <audio type="index" >f_oOptions[4].nHalfTenth</audio>
            <audio type="index" >f_oOptions[5].nPress</audio>
            <audio type="index" >f_oOptions[5].nOption</audio>
            <audio type="index" >f_oOptions[5].nHalfTenth</audio>
            <audio type="index" >f_oOptions[6].nPress</audio>
            <audio type="index" >f_oOptions[6].nOption</audio>
            <audio type="index" >f_oOptions[6].nHalfTenth</audio>
            <audio type="index" >f_oOptions[7].nPress</audio>
            <audio type="index" >f_oOptions[7].nOption</audio>
            <audio type="index" >f_oOptions[7].nHalfTenth</audio>
            <audio type="index" >f_oOptions[8].nPress</audio>
            <audio type="index" >f_oOptions[8].nOption</audio>
            <audio type="index" >f_oOptions[8].nHalfTenth</audio>
            <audio type="index" >f_oOptions[0].nPressCS1</audio>
            <audio type="index" >f_oOptions[0].nPressCS2</audio>
            <audio type="index" >f_oOptions[0].nOptionCS</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="132" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="133" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";

Server.logInfo("g_oCC.strBalanceTransferFlag: " + Session.g_oBALXFER.strBalanceTransferFlag);
Server.logInfo("g_oCC.strRechargableFlag: " + Session.g_oCC.strRechargableFlag);
Server.logInfo("g_oACD.strEnableFlag: " + Session.g_oACD.strEnableFlag);
Server.logInfo("g_oAPI.strCustomerServicePhone: " + Session.g_oAPI.strCustomerServicePhone);
Server.logInfo("g_oAPI.bIVRCallbackAllowed: " + Session.g_oAPI.bIVRCallbackAllowed);
Server.logInfo("g_oAPI.bSvcDirectCallFlag: " + Session.g_oAPI.bSvcDirectCallFlag);


if(Session.g_oAPI.strLanguage == "kor" || Session.g_oAPI.strLanguage == "jap") {
	Session.f_oOptions[0].nPressCS1 = 931; // For operator assistance
	Session.f_oOptions[0].nPressCS2 = 1; // 0
	Session.f_oOptions[0].nOptionCS = 310; // Press
}
else if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
	Session.f_oOptions[0].nPressCS1 = 931; // For operator assistance
	Session.f_oOptions[0].nPressCS2 = 3870; // Press 0
	Session.f_oOptions[0].nOptionCS = 99; // silence
} else {
	Session.f_oOptions[0].nPressCS1 = 310; // Press
	Session.f_oOptions[0].nPressCS2 = 1; // 0
	Session.f_oOptions[0].nOptionCS = 931;// Customer Service
}

if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
	Server.logInfo("Special case: Farsi language");
	// Assume everything is on
	Session.f_oOptions[1].nHalfTenth = 220; // Play half second since assumming all options are on.
	Session.f_oOptions[1].nPress = 519; // Press 1
	Session.f_oOptions[1].nOption = 311; // CC Recharge

	Session.f_oOptions[2].nHalfTenth = 220; // Play half second since assumming all options are on.
	Session.f_oOptions[2].nPress = 520; // Press 2
	Session.f_oOptions[2].nOption = 312; // Bal Xfer

	Session.f_oOptions[3].nHalfTenth = 220; // Play half second
	Session.f_oOptions[3].nPress = 521; // Press 3
	Session.f_oOptions[3].nOption = 313; // Balance

	Session.f_oOptions[4].nHalfTenth = 220; // Play half second
	Session.f_oOptions[4].nPress = 522; // Press 4
	Session.f_oOptions[4].nOption = 314; // Expiration Date

	Session.f_oOptions[5].nHalfTenth = 220; // Play half second
	Session.f_oOptions[5].nPress = 523; // Press 5
	Session.f_oOptions[5].nOption = 315; // Make Call

	Session.f_oOptions[6].nHalfTenth = 220; // Play half second
	Session.f_oOptions[6].nPress = 1263; // Press 6
	Session.f_oOptions[6].nOption = 316; // Review Speed Dials

	Session.f_oOptions[7].nHalfTenth = 220; // Play half second
	Session.f_oOptions[7].nPress = 1264; // Press 7
	Session.f_oOptions[7].nOption = 317; // Add Speed Dials

	Session.f_oOptions[8].nHalfTenth = 220; // Play half second
	Session.f_oOptions[8].nPress = 281; // Press 8
	Session.f_oOptions[8].nOption = 318; // Manage your callback number or initiate a callback
	
	if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
    	 Session.f_oOptions[9].nHalfTenth = 220; // Play half second
	     Session.f_oOptions[9].nPress = 606;     // Press 9
    	 Session.f_oOptions[9].nOption = 319;    // To manage your easy call id.
	}

}		
else  {
// Assume everything is on
Session.f_oOptions[1].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[1].nPress = 311; // Press 1
Session.f_oOptions[1].nOption = 519; // CC Recharge

Session.f_oOptions[2].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[2].nPress = 312; // Press 2
Session.f_oOptions[2].nOption = 520; // Bal Xfer

Session.f_oOptions[3].nHalfTenth = 220; // Play half second
Session.f_oOptions[3].nPress = 313; // Press 3
Session.f_oOptions[3].nOption = 521; // Balance

Session.f_oOptions[4].nHalfTenth = 220; // Play half second
Session.f_oOptions[4].nPress = 314; // Press 4
Session.f_oOptions[4].nOption = 522; // Expiration Date

Session.f_oOptions[5].nHalfTenth = 220; // Play half second
Session.f_oOptions[5].nPress = 315; // Press 5
Session.f_oOptions[5].nOption = 523; // Make Call

Session.f_oOptions[6].nHalfTenth = 220; // Play half second
Session.f_oOptions[6].nPress = 316; // Press 6
Session.f_oOptions[6].nOption = 1263; // Review Speed Dials

Session.f_oOptions[7].nHalfTenth = 220; // Play half second
Session.f_oOptions[7].nPress = 317; // Press 7
Session.f_oOptions[7].nOption = 1264; // Add Speed Dials

Session.f_oOptions[8].nHalfTenth = 220; // Play half second
Session.f_oOptions[8].nPress = 318; // Press 8
Session.f_oOptions[8].nOption = 281; // Manage your callback number or initiate a callback

var ix = 9;
if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
     Session.f_oOptions[9].nHalfTenth = 220; // Play half second
     Session.f_oOptions[9].nPress = 319;     // Press 9
     Session.f_oOptions[9].nOption = 606;    // To manage your easy call id.
     ix = 10;
}
if(Session.g_oAPI.bIvrAniReg == true){
	Session.f_oOptions[ix].nHalfTenth = 220; // Play half second
	Session.f_oOptions[ix].nPress = 350; // Press *1
	if(Session.g_oAPI.strValidateByANI == "0"){
		Session.f_oOptions[ix].nOption = 622; // Register your ANI
	}else{
		Session.f_oOptions[ix].nOption = 623; // Un-register your ANI
	}
	ix++;
}
}

Server.logInfo("f_oOptions.length: " + Session.f_oOptions.length);

var maxPossibleOptions = Session.f_oOptions.length;
var minPossibleOption = 5;
var counter = 2;

if("T" != Session.g_oCC.strRechargableFlag) {
	// Pull each option up
	for (var i = 1; i < Session.f_oOptions.length - 1; i++) {
  	     Session.f_oOptions[i].nOption = Session.f_oOptions[i+1].nOption;
	}

	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
	counter--;
}



if("T" != Session.g_oBALXFER.strBalanceTransferFlag) {

	// Pull each option up	
    for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	

	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
	counter--;	
}

if(!Session.g_oAPI.bIVRCallbackAllowed) {
	counter = counter + 6; // 6 is the lowest possible option #
	// Pull each option up	

	for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	

	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
}



if(("T" != Session.g_oACD.strMainMenuZeroOut && Session.g_oAPI.strCustomerServicePhone == "") || Session.g_oAPI.strOriginationType != Session.s_oORIG_TYPES.strTwoStageDialing) {

	Session.f_oOptions[0].nOptionCS = 99;// Customer Service
    Session.f_oOptions[0].nPressCS1 = 99; // Press
    Session.f_oOptions[0].nPressCS2 = 99; // 0

    // Do not play half second of silence after last option
    Session.f_oOptions[Session.f_oOptions.length - 1].nHalfTenth = 99; 
}

// set options not used to 99 (1/10 silence)
for (var i = Session.f_oOptions.length; i < maxPossibleOptions; i++) {
		Session.f_oOptions[i].nOption = 99;
		Session.f_oOptions[i].nPress = 99;	
   	    Session.f_oOptions[i].nHalfTenth = 99; 
}

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)

{

	Session.g_oAPI.nSessionTerminationReason = 6;

}]]></script>
          </scripts>
        </action>
        <action id="132" plug-in="Pactolus.Branch.1" ><?xtml-editor x=31 y=396 ?>
          <results >
            <result name="Default" link="99" stubbed="0"/>
            <result name="Recharge" link="25" stubbed="0" >f_bRecharge == true</result>
            <result name="Bal Xfer" link="18" stubbed="0" >f_bBalXfer == true</result>
            <result name="Play Balance" link="24" stubbed="0" >f_bPlayBalance == true</result>
            <result name="Make Call" link="35" stubbed="0" >f_bMakeCall == true</result>
            <result name="Review Speed Dial" link="116" stubbed="1" >f_bReviewSD == true</result>
            <result name="Add Speed Dial" link="117" stubbed="1" >f_bAddSD == true</result>
            <result name="Cust Service" link="130" stubbed="0" >f_bCustService == true</result>
            <result name="Play Exp Date" link="23" stubbed="0" >f_bPlayExpDate == true</result>
            <result name="Callback Maint" link="139" stubbed="0" >f_bCallbackMaint == true</result>
            <result name="Easy Call Id Maint" link="140" stubbed="0" >f_bEasyCallIdMaint == true</result>
            <result name="Register ANI" link="141" stubbed="0" >f_bRegANI == true</result>
            <result name="UnRegisterANI" link="142" stubbed="0" >f_bUnRegANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bAddSD = false;
Session.f_bBalXfer = false;
Session.f_bCustService = false;
Session.f_bMakeCall = false;
Session.f_bPlayBalance = false;
Session.f_bPlayExpDate = false;
Session.f_bRecharge = false;
Session.f_bReviewSD = false;
Session.f_bCallbackMaint = false;
Session.f_bEasyCallIdMaint = false;
Session.f_bRegANI = false;
Session.f_bUnRegANI = false;

if(Session.g_strDigit == "1") {
	switch (Session.f_oOptions[1].nOption) {
		case 519:
			Session.f_bRecharge = true;
			break;
		case 520:
			Session.f_bBalXfer = true;
			break;
		case 521:
  		    Session.f_bPlayBalance = true;
			break;
    }
} else if(Session.g_strDigit == "2") {

	switch (Session.f_oOptions[2].nOption) {
		case 520:
		    Session.f_bBalXfer = true;
			break;
		case 521:
 		    Session.f_bPlayBalance = true;
			break;
		case 522:
			Session.f_bPlayExpDate = true;
			break;	
	}

} else if(Session.g_strDigit == "3") {

	switch (Session.f_oOptions[3].nOption) {
		case 521:
		    Session.f_bPlayBalance = true;
			break;
		case 522:
			Session.f_bPlayExpDate = true;
			break;
		case 523:
			Session.f_bMakeCall = true;
			break;	
    }
} else if(Session.g_strDigit == "4") {

	switch (Session.f_oOptions[4].nOption) {
		case 522:
			Session.f_bPlayExpDate = true;
			break;
	    case 523:
			Session.f_bMakeCall = true;
			break;
		case 1263:
			Session.f_bReviewSD = true;
			break;	
	}
} else if(Session.g_strDigit == "5") {

	switch (Session.f_oOptions[5].nOption) {

		case 523:
			Session.f_bMakeCall = true;
			break;
		case 1263:
			Session.f_bReviewSD = true;

			break;

		case 1264:
			Session.f_bAddSD = true;
			break;	
    }
}  else if(Session.g_strDigit == "6") {

	switch (Session.f_oOptions[6].nOption) {

		case 1263:
			Session.f_bReviewSD = true;
			break;
		case 1264:
			Session.f_bAddSD = true;
			break;
		case 281:
			Session.f_bCallbackMaint = true;
			break;
		case 606:
            Session.f_bEasyCallIdMaint = true;
            break;	
        case 622://register
       		Session.f_bRegANI = true;
            break;
       case 623://unregister
       		Session.f_bUnRegANI = true;
       		break;
		default:
			break;	
	}

} else if(Session.g_strDigit == "7") {

	switch (Session.f_oOptions[7].nOption) {
		case 1264:
			Session.f_bAddSD = true;
			break;
		case 281:
			Session.f_bCallbackMaint = true;
			break;
		case 606:
            Session.f_bEasyCallIdMaint = true;
            break;
        case 622://register
       		Session.f_bRegANI = true;
            break;
       case 623://unregister
       		Session.f_bUnRegANI = true;
       		break;
		default:
			break;	
	}
} else if(Session.g_strDigit == "8") {

   switch (Session.f_oOptions[8].nOption) {

   	    case 281:
			Session.f_bCallbackMaint = true;
  		    break;
  	    case 606:
            Session.f_bEasyCallIdMaint = true;
            break;
        case 622://register
       		Session.f_bRegANI = true;
            break;
        case 623://unregister
       		Session.f_bUnRegANI = true;
       		break;
  		default:
  		    break;	
	}
} else if(Session.g_strDigit == "9") {

	switch (Session.f_oOptions[9].nOption) {

       case 606:
            Session.f_bEasyCallIdMaint = true;
            break;
       case 622://register
       		Session.f_bRegANI = true;
            break;
       case 623://unregister
       		Session.f_bUnRegANI = true;
       		break;
		default:
			break;	
	}
} else if(Session.g_strDigit == "*1") {

	switch (Session.f_oOptions[10].nOption) {

       case 622://register
       		Session.f_bRegANI = true;
            break;
       case 623://unregister
       		Session.f_bUnRegANI = true;
       		break;
		default:
			break;	
	}
} else if(Session.g_strDigit == "0") {

		Session.f_bCustService = true;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuZeroOut;		
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 1 && Result.id != 8) {
	Session.g_nNumRetry = 0;
}]]></script>
          </scripts>
        </action>
        <action id="133" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=277 y=219 ?>
          <!--552-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >552</audio>
          </play>
          <results >
            <result name="Default" link="97" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="139" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=262 y=1360 ?>
          <!--CallbackMaint-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CallbackMaint&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries = 0;]]></script>
          </scripts>
        </action>
        <action id="140" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=274 y=369 ?>
          <!--PlayDirectCallMainMenu-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayDirectCallMainMenu&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strDirectCallDigitMap = Session.s_strOutdialDigitMap;
]]></script>
          </scripts>
        </action>
        <action id="141" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=262 y=1451 ?>
          <!--psAPIAddAuthAni-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAddAuthAni&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="143" stubbed="0"/>
            <result name="Success" link="144" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Change the one step dialing value to the originating number, this needs to be done because the library function
//uses strOneStepDialingNumber as the ANI to add
Session.g_oSUB.strOneStepDialingNumber = Session.g_oAPI.strOriginationNumber;]]></script>
            <script language="javascript" timing="last" ><![CDATA[switch(Session.f_nReturnCode){
	case 0://success
	Session.g_oAPI.strValidateByANI = "1";
	Session.f_nPromptIndex = 627;
	break;
	case -2://duplicate ANI 626
	Session.f_nPromptIndex = 626;
	break;
	default://unknown error 625
	Session.f_nPromptIndex = 625;
	break;
}]]></script>
          </scripts>
        </action>
        <action id="142" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=264 y=1552 ?>
          <!--psAPIRemoveAuthAni-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIRemoveAuthAni&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="143" stubbed="0"/>
            <result name="Success" link="144" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Change the one step dialing value to the originating number, this needs to be done because the library function
//uses strOneStepDialingNumber as the ANI to add
Session.g_oSUB.strOneStepDialingNumber = Session.g_oAPI.strOriginationNumber;]]></script>
            <script language="javascript" timing="last" ><![CDATA[switch(Session.f_nReturnCode){
	case 0://success
	Session.g_oAPI.strValidateByANI = "0";
	Session.f_nPromptIndex = 628;
	break;
	default://unknown error 624
	Session.f_nPromptIndex = 624;
	break;
}]]></script>
          </scripts>
        </action>
        <action id="143" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=482 y=1499 ?>
          <!--Error prompt-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >f_nPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("playing prompt "+Session.f_nPromptIndex);]]></script>
          </scripts>
        </action>
        <action id="144" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=488 y=1623 ?>
          <!--Success Prompt-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >f_nPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("playing prompt "+Session.f_nPromptIndex);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="CreditCardRecharge" start="69" event="CreditCardRecharge" returns="i4" >
      <local-vars >
        <var name="f_strCCLast4Digits" type="string" >""</var>
        <var name="f_strInputExpDate" type="string" >""</var>
        <var name="f_bExpDateMatch" type="boolean" >0</var>
        <var name="f_strRechargeAmount" type="string" >""</var>
        <var name="f_bExceedsMaxBalance" type="boolean" >0</var>
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nTimeout" type="i4" >30</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_fBalance" type="float" >0</var>
        <var name="f_bRechargeAllowed" type="boolean" >1</var>
        <var name="f_nPromptEnterAmount" type="i4" >529</var>
        <var name="f_nPromptRechargeFee" type="i4" >535</var>
        <var name="nUnitPrompt" type="i4" >0</var>
        <var name="nBalance" type="i4" >0</var>
        <var name="f_bInvalidEntry" type="boolean" >0</var>
        <var name="f_nPromptInvalidEntry" type="i4" >337</var>
      </local-vars>
      <actions >
        <action id="69" plug-in="Pactolus.Branch.1" ><?xtml-editor x=15 y=36 ?>
          <!--check rechargeable-->
          <results >
            <result name="Default" link="70" stubbed="0"/>
            <result name="Rechargeable" link="208" stubbed="0" >g_oCC.strRechargableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oCC.strRechargableFlag: " + Session.g_oCC.strRechargableFlag);
Server.logInfo("g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
Server.logInfo("g_oCC.fMinRechargeAmount: " + Session.g_oCC.fMinRechargeAmount);
Server.logInfo("g_oCC.fMaxRechargeAmount: " + Session.g_oCC.fMaxRechargeAmount);
Server.logInfo("g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);


if(Session.s_nSERVICE_ELEMENT_ID_POPD == Session.g_oAPI.nServiceElementId) { 
	
	if(Session.g_oAPI.fCreditUsed <= Session.g_oCC.fMinRechargeAmount) {
		Session.f_bRechargeAllowed = false;
		Server.logInfo("Credit Used is less than the minimum recharge amount. Don't allow user to attempt recharge.");
		return;
	}

	if(Session.g_oAPI.fCreditUsed < Session.g_oCC.fMaxRechargeAmount) {
		// need to set max amount to credit used because user can only recharge for that amount
		Session.g_oCC.fMaxRechargeAmount = Session.g_oAPI.fCreditUsed;
	} 

} 	


]]></script>
          </scripts>
        </action>
        <action id="36" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1666 y=211 ?>
          <!--"recharge was successful"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >539</audio>
            <audio type="index" >546</audio>
            <audio type="currency" unit="" >f_fBalance</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="41" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=617 y=212 ?>
          <!--"no active credit card"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >528</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="46" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=12 y=326 ?>
          <!--get cc last 4 digits-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="f_strCCLast4Digits" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >525</audio>
            <audio type="index" >526</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" link="48" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="*" link="81" stubbed="1" >f_strCCLast4Digits match "*"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_oACD.strEnableFlag match "T"
AND f_strCCLast4Digits == "0"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strCCLast4Digits = "";
Session.f_nNumTries++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered cc digits = " + Session.f_strCCLast4Digits);
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="48" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=276 y=340 ?>
          <!--get cc exp date-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="f_strInputExpDate" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >527</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="*" link="81" stubbed="1" >f_strInputExpDate match "*"
AND 'Result'  == 'Success'</result>
            <result name="f_bExpDateMatch==true" link="62" stubbed="0" >f_bExpDateMatch == true
AND 'Result'  == 'Success'</result>
            <result name="f_bExpDateMatch==false" link="203" stubbed="0" >'Result'  == 'Success'
AND f_bExpDateMatch == false</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >f_strInputExpDate match "0"
AND g_oACD.strEnableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strInputExpDate = "";]]></script>
            <script language="javascript" timing="middle" ><![CDATA[//check for match cc and exp date
if ((Session.g_oCC.strExpDate == Session.f_strInputExpDate) && (Session.f_strCCLast4Digits == Session.g_oCC.strCCNum)){
	Session.f_bExpDateMatch = true;
	Session.f_nNumTries = 0;
} else {
	Session.f_bExpDateMatch = false;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered exp date = " + Session.f_strInputExpDate);
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
} ]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1082 y=612 ?>
          <!--"continue or cancel"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >534</audio>
            <audio type="currency" unit="" >g_oCC.fRechargeFee</audio>
            <audio type="index" >f_nPromptRechargeFee</audio>
            <audio type="index" >311</audio>
            <audio type="index" >536</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="201" stubbed="1"/>
            <result name="Continue" link="124" stubbed="0" >g_strDigit match "1"
AND 'Result'  == 'Success'</result>
            <result name="Cancel" link="81" stubbed="1" >g_strDigit match "*"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_strDigit match "T"
AND g_oACD.strEnableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";

if(Session.s_nSERVICE_ELEMENT_ID_POPD == Session.g_oAPI.nServiceElementId) {
	Session.f_nPromptRechargeFee = 392; //...will be counted against your credit.
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered exp date = " + Session.f_strInputExpDate);
Session.f_bExpDateMatch = false;
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="62" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=19 y=576 ?>
          <!--get amount-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(#|*|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="f_strRechargeAmount" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >f_nPromptEnterAmount</audio>
            <audio type="index" >580</audio>
            <audio type="index" >530</audio>
            <audio type="currency" unit="" >g_oCC.fMinRechargeAmount</audio>
            <audio type="index" >531</audio>
            <audio type="currency" unit="" >g_oCC.fMaxRechargeAmount</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" link="71" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="*" link="81" stubbed="1" >f_strRechargeAmount match "*"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_oACD.strEnableFlag match "T"
AND f_strRechargeAmount match "^0{1}$"</result>
            <result name="strRechargeAmount = &quot;&quot;" link="62" stubbed="0" >f_strRechargeAmount match ""</result>
            <result name="f_bInvalidEntry" link="215" stubbed="0" >f_bInvalidEntry == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strRechargeAmount = "";
Session.f_nNumTries++;
Session.f_bInvalidEntry = false;


if(Session.s_nSERVICE_ELEMENT_ID_POPD == Session.g_oAPI.nServiceElementId) {
	Session.f_nPromptEnterAmount = 391; //Please enter the amount you would like to add to your credit.
}]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if(Session.f_strRechargeAmount.length == 0 && Session.g_strTerminationDigit == "#") {
	Session.f_bInvalidEntry = true;
} else if (Session.f_strRechargeAmount == "") {
	Session.f_strRechargeAmount = "0";
} ]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user amount = " + Session.f_strRechargeAmount);
Session.g_oCC.fRechargeAmount = parseFloat(Session.f_strRechargeAmount);
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
} ]]></script>
          </scripts>
        </action>
        <action id="65" plug-in="Pactolus.Branch.1" ><?xtml-editor x=551 y=663 ?>
          <!--check max balance-->
          <results >
            <result name="Default" link="206" stubbed="0"/>
            <result name="Exceeds max balance" link="66" stubbed="0" >f_bExceedsMaxBalance == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bExceedsMaxBalance = false;
if (Session.g_oCC.fRechargeAmount > Session.g_oCC.fMaxRechargeAmount)
{
	Session.f_bExceedsMaxBalance = true;	
	Server.logInfo("recharge amount exceeds max, try again");
}
else if (Session.g_oCC.fRechargeAmount < Session.g_oCC.fMinRechargeAmount)
{
	Session.f_bExceedsMaxBalance = true;	
	Server.logInfo("recharge amount below min, try again");
}]]></script>
          </scripts>
        </action>
        <action id="66" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=825 y=647 ?>
          <!--"exceeds max balance"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >532</audio>
          </play>
          <results >
            <result name="Default" link="62" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="MaxTries, strCSROnMaxLoginsEnabled" link="211" stubbed="1" >f_nNumTries == g_sMaxLoginAttempts
AND g_oACD.strCSROnMaxLoginsEnabled match "T"</result>
          </results>
        </action>
        <action id="70" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=302 y=11 ?>
          <!--"not allowed"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >524</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="71" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=293 y=579 ?>
          <!--"continue or cancel"-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >339</audio>
            <audio type="currency" unit="" >g_oCC.fRechargeAmount</audio>
            <audio type="index" >292</audio>
            <audio type="index" >311</audio>
            <audio type="index" >336</audio>
            <audio type="index" >312</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="Continue" link="65" stubbed="0" >g_strDigit match "1"
AND 'Result'  == 'Success'</result>
            <result name="Cancel" link="81" stubbed="1" >g_strDigit match "*"
AND 'Result'  == 'Success'</result>
            <result name="Try Again" link="62" stubbed="1" >g_strDigit match "2"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_strDigit match "0"
AND g_oACD.strEnableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";

]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered exp date = " + Session.f_strInputExpDate);
Session.f_bExpDateMatch = false;
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=26 y=1113 ?>
          <!--return to main menu-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nMAIN_MENU"/>
        </action>
        <action id="124" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1131 y=436 ?>
          <!--please hold-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="10" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >553</audio>
          </play>
          <results >
            <result name="Default" link="209" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="201" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=23 y=1005 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="202" stubbed="0"/>
          </results>
        </action>
        <action id="202" plug-in="Standard.EndSession.1" ><?xtml-editor x=294 y=1018 ?></action>
        <action id="203" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=588 y=358 ?>
          <!--cc and date not match-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >533</audio>
          </play>
          <results >
            <result name="Default" link="46" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="MaxTries, strCSROnMaxLoginsEnabled" link="211" stubbed="1" >f_nNumTries == g_sMaxLoginAttempts
AND g_oACD.strCSROnMaxLoginsEnabled match "T"</result>
            <result name="max Tries CSROnMax = F" link="210" stubbed="0" >f_nNumTries == g_sMaxLoginAttempts
AND g_oACD.strCSROnMaxLoginsEnabled match "F"</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (6 == Result.id)
{
	Server.logInfo("Max Attempts for CC andExpDate");
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;
			Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nEXCEEDINVALID;
}]]></script>
          </scripts>
        </action>
        <action id="204" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1700 y=627 ?>
          <!--invalid amount-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >532</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="205" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1675 y=766 ?>
          <!--transaction refuse-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >537</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="206" plug-in="Pactolus.Branch.1" ><?xtml-editor x=775 y=524 ?>
          <!--is there a fee?-->
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="rechargeFee &gt; 0" link="50" stubbed="0" >g_oCC.fRechargeFee &gt; 0</result>
          </results>
        </action>
        <action id="208" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=275 y=168 ?>
          <!--JAVA: PrepaidAPIGetActiveCC-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIGetActiveCC&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="201" stubbed="1"/>
            <result name="0 Success" link="46" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-2 No Active CC" link="41" stubbed="0" >f_nReturnCode == -2</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getActiveCC returned " + Session.f_nReturnCode);
Server.logInfo("cc num last 4 digits =  " + Session.g_oCC.strCCNum);
Server.logInfo("cc exp date = " + Session.g_oCC.strExpDate);

if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA GET ACTIVE CC, EXIT ON: " + Result.name);
	Server.logInfo("getActiveCC returned " + Session.f_nReturnCode);
	Session.g_oAPI.nSessionTerminationReason = 5;
	switch (Session.f_nReturnCode)
	{
		case -1:
			Session.g_nErrorMsgNumber = 1001; //db error
			break;
		case -2:
			Session.g_oAPI.nSessionTerminationReason = 0;
			Session.g_nErrorMsgNumber = 2019; //no active credit card selected
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	// Set max balance

	var temp = Session.g_oCC.fMaxPrepaidBalance - Session.g_oSUB.fPrepaidBalance;
	Server.logInfo("current prepaid balance = " + Session.g_oSUB.fPrepaidBalance);
	Server.logInfo("max pp balance = " + Session.g_oCC.fMaxPrepaidBalance);
	Server.logInfo("max recharge amount = " + Session.g_oCC.fMaxRechargeAmount);

	if (temp > 0 && Session.g_oCC.fMaxRechargeAmount > temp){
		Session.g_oCC.fMaxRechargeAmount = temp;
	}

	Session.g_oCC.fMaxRechargeAmount = Math.floor(Session.g_oCC.fMaxRechargeAmount);
	Session.g_oCC.fMinRechargeAmount = Math.ceil(Session.g_oCC.fMinRechargeAmount);

}]]></script>
          </scripts>
        </action>
        <action id="209" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1373 y=602 ?>
          <!--JAVA: psAPIDoCCRecharge-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIDoCCRecharge&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="201" stubbed="1"/>
            <result name="0 - Success" link="214" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-5 - Max Balance" link="204" stubbed="0" >f_nReturnCode == -5</result>
            <result name="Trans Refused" link="205" stubbed="0" >f_nReturnCode == -2
OR f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9
OR f_nReturnCode == -10
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("doCCRecharge returned " + Session.f_nReturnCode);
Server.logInfo("g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
Server.logInfo("g_oSUB.fPrepaidBalance: " + Session.g_oSUB.fPrepaidBalance);


if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO DO CC RECHARGE");
	Server.logError("ERROR: doCCRecharge returned: " + Session.f_nReturnCode);
	switch (Session.f_nReturnCode)
	{
		case -1:
			Session.g_nErrorMsgNumber = 1001; //db error
			break;
		case -2:
			Session.g_nErrorMsgNumber = 2007; //credit card refuse
			break;
		case -3:
			Session.g_nErrorMsgNumber = 2008; //credit card fraud
			break;
		case -4:
			Session.g_nErrorMsgNumber = 2009; //credit card not active
			break;
		case -5:
			Session.g_nErrorMsgNumber = 2006; //exceed max balance
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1011; //locked pin
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2010; //credit card expired
			break;
		case -8:
			Session.g_nErrorMsgNumber = 2011; //credit card invalid
			break;
		case -9:
			Session.g_nErrorMsgNumber = 2012; //credit card bad data
			break;
		case -10:
			Session.g_nErrorMsgNumber = 2013; //credit card missing data
			break;
		case -11:
			Session.g_nErrorMsgNumber = 2014; //cyber source timeout
			break;
		case -12:
			Session.g_nErrorMsgNumber = 2015; //cyber source error
			break;
		case -13:
			Session.g_nErrorMsgNumber = 2016; //cyber source net work error
			break;
		case -14:
			Session.g_nErrorMsgNumber = 2017; //cyber source system config error
			break;
		case -15:
			Session.g_nErrorMsgNumber = 2018; //cyber source unknown error
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="210" plug-in="Pactolus.Branch.1" ><?xtml-editor x=17 y=789 ?>
          <results >
            <result name="Default" link="201" stubbed="1"/>
            <result name="strCSROnMaxLoginsEnabled" link="211" stubbed="1" >g_oACD.strCSROnMaxLoginsEnabled match "T"</result>
          </results>
        </action>
        <action id="211" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=21 y=885 ?>
          <!--RouteToCSR-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;RouteToCSR&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="201" stubbed="1"/>
            <result name="Success" link="212" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.f_nNumTries == Session.g_sMaxLoginAttempts) {
	Session.g_oACD.nCSRRouteReasonCode = 2;	
} else {
	Session.g_oACD.nCSRRouteReasonCode = 3;
}

Session.g_oAPI.nStatePriorToCSR = Session.s_nCC_RECHARGE;
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="212" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=281 y=885 ?>
          <!--s_nWAIT_FOR_MESSAGE-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nWAIT_FOR_MESSAGE"/>
        </action>
        <action id="213" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1723 y=442 ?>
          <!--recharge was successful-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >539</audio>
            <audio type="index" >546</audio>
            <audio type="number" >nBalance</audio>
            <audio type="index" >nUnitPrompt</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(1 == Session.f_fBalance) {
	Session.nUnitPrompt = 389; // Unit
} else {
	Session.nUnitPrompt = 390; // Units
}

Session.nBalance = Math.ceil(Session.f_fBalance);

Server.logInfo("Session.nBalance: " + Session.nBalance);]]></script>
          </scripts>
        </action>
        <action id="214" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1475 y=311 ?>
          <results >
            <result name="Default" link="36" stubbed="0"/>
            <result name="bAnnounceCurrencyAsUnits" link="213" stubbed="0" >g_oAPI.bAnnounceCurrencyAsUnits == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(1 == Session.g_oAPI.nServiceElementId) { //1 = prepaid, 3 = postpaid
	Session.f_fBalance = Session.g_oSUB.fPrepaidBalance;
} else {
	Session.f_fBalance = Session.g_oAPI.fCreditUsed;
}	]]></script>
          </scripts>
        </action>
        <action id="215" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=316 y=781 ?>
          <!--PlayOnePrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayOnePrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >f_nPromptInvalidEntry</parameter>
          </function>
          <results >
            <result name="Default" link="62" stubbed="1"/>
            <result name="Max Attempts" link="210" stubbed="1" >f_nNumTries &gt;= g_sMaxLoginAttempts</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="PlayTimeAvailable" start="20" event="PlayTimeAvailable" returns="void" >
      <actions >
        <action id="20" plug-in="Pactolus.Branch.1" ><?xtml-editor x=48 y=145 ?>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Announce Hour:Mins" link="19" stubbed="0" >s_bAnnounceHoursMins == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id == 2){
Server.logInfo("s_bAnnounceHoursMins = " + Session.s_bAnnounceHoursMins + " will announce in Hours Mins");
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=458 y=323 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="0 minute" link="3" stubbed="0" >g_nTimeAvailable == 0</result>
            <result name="1 minute" link="4" stubbed="0" >g_nTimeAvailable == 1</result>
            <result name="2 or more minutes" link="5" stubbed="0" >g_nTimeAvailable &gt; 1</result>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=742 y=302 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0 second" link="6" stubbed="0" >g_nTempInt == 0</result>
            <result name="1 second" link="7" stubbed="0" >g_nTempInt == 1</result>
            <result name="2 or more seconds" link="8" stubbed="0" >g_nTempInt &gt; 1</result>
          </results>
        </action>
        <action id="4" plug-in="Pactolus.Branch.1" ><?xtml-editor x=696 y=594 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0 second" link="10" stubbed="0" >g_nTempInt == 0</result>
            <result name="1 second" link="11" stubbed="0" >g_nTempInt == 1</result>
            <result name="2 or more seconds" link="12" stubbed="0" >g_nTempInt &gt; 1</result>
          </results>
        </action>
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=667 y=1091 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0 second" link="14" stubbed="0" >g_nTempInt == 0</result>
            <result name="1 second" link="13" stubbed="0" >g_nTempInt == 1</result>
            <result name="2 or more seconds" link="9" stubbed="0" >g_nTempInt &gt; 1</result>
          </results>
        </action>
        <action id="6" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1170 y=101 ?>
          <!--517: You have ...-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="7" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1203 y=266 ?>
          <!--517: You have ...-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1198 y=432 ?>
          <!--517: You have ...-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >46</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="9" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=929 y=1324 ?>
          <!--517: You have x minutes and x seconds-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >309</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >46</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="10" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=987 y=520 ?>
          <!--517: You have 1 minute-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >308</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=981 y=693 ?>
          <!--517: You have 1 minute and 1 second-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >308</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="12" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=950 y=847 ?>
          <!--517: You have 1 minutes and x seconds-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >308</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >46</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="13" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=929 y=1165 ?>
          <!--517: You have x minutes and 1 second-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >309</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="14" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=930 y=1014 ?>
          <!--517: You have x minutes-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >309</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="16" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=683 y=195 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="17" plug-in="Pactolus.Branch.1" ><?xtml-editor x=174 y=248 ?>
          <!--calculation mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="nSecondsAnnounce &gt; 0" link="2" stubbed="0" >g_oSUB.nSecondsAnnounce &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Session.g_oSUB.nSecondsAnnounce <"+Session.g_oSUB.nSecondsAnnounce+">"); 
if(Session.g_oSUB.nSecondsAnnounce > 0) {
	Session.g_nTimeAvailable = Session.g_oSUB.nSecondsAnnounce / 60;
	Session.g_nTempInt = Session.g_oSUB.nSecondsAnnounce % 60;
} else {
	Server.logInfo("nSecondsAnnounce is less than or equal to zero.");
}	]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=433 y=45 ?>
          <!--517: You have ...-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="hhmmss" >g_nTempInt</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var ftemp;

Server.logInfo("Session.g_oSUB.nSecondsAnnounce <"+Session.g_oSUB.nSecondsAnnounce+">");
Server.logInfo("SECONDS TO BE CONVERTED: " + Session.g_oSUB.nSecondsAnnounce); 
if(Session.g_oSUB.nSecondsAnnounce > 0) {
 	 ftemp = Session.g_oSUB.nSecondsAnnounce / 60;
	Session.g_nTempInt = Math.ceil(ftemp);
	Server.logInfo("MINS AVAILABLE ROUNDED UP = " + Session.g_nTempInt);
	Session.g_nTempInt = Session.g_nTempInt * 60;
	Server.logInfo("SECONDS AVAILABLE ROUNDED UP = " + Session.g_nTempInt);
} else {
	Server.logInfo("nSecondsAnnounce is less than or equal to zero.");
  }	

]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnServiceLoad" start="1" event="OnServiceLoad" returns="void" >
      <parameters >
        <parameter name="strAppName" type="string"/>
        <parameter name="nSessionCount" type="i2"/>
        <parameter name="nMaxIterations" type="i2"/>
        <parameter name="nServerId" type="i2"/>
      </parameters>
      <local-vars >
        <var name="f_strPlayRingbackForOutdial" type="string" ></var>
        <var name="f_strAppPropSuppressOnHold" type="string" ></var>
        <var name="f_strUseFromHeaderForAni" type="string" ></var>
        <var name="f_strPlay0" type="string" ></var>
        <var name="strAutoAniList" type="string" ></var>
        <var name="nReturn" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=18 y=30 ?>
          <!--GET PSX IP from config-->
          <user-function xmlns="www.pactolus.com:xtml:application" process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;get_property&quot;" timeout="s_nTIMEOUT" return="" async="0" >
            <parameter >"primary-softswitch"</parameter>
            <parameter >s_strPrimaryPSX</parameter>
            <parameter >"backup-softswitch"</parameter>
            <parameter >s_strBackupPSX</parameter>
            <parameter >"appserver-logical-ip"</parameter>
            <parameter >s_strLocalHost</parameter>
            <parameter >"callingcard-default-ani"</parameter>
            <parameter >s_strDEFAULT_ANI</parameter>
            <parameter >"send-alarm-flag"</parameter>
            <parameter >s_strSendAlarmFlag</parameter>
            <parameter >"prepend-to-outdial"</parameter>
            <parameter >s_strDigitPrependToOutDial</parameter>
            <parameter >"packetization-period"</parameter>
            <parameter >s_nPacketizationPeriod</parameter>
            <parameter >"media-server-type"</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >"ms-connect-retry"</parameter>
            <parameter >s_strMSRetryFlag</parameter>
            <parameter >"outdial-dialing-plan"</parameter>
            <parameter >s_strOutdialDialingPlan</parameter>
            <parameter >"outdial-digit-map"</parameter>
            <parameter >s_strOutdialDigitMap</parameter>
            <parameter >"ring-no-answer-time"</parameter>
            <parameter >s_nRING_NO_ANSWER_TIME</parameter>
            <parameter >"session-timer-enabled"</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >"session-timer-interval"</parameter>
            <parameter >s_nSessionTimerInterval</parameter>
            <parameter >"intl-min-connect-time"</parameter>
            <parameter >s_nIntlMinConnectTime</parameter>
            <parameter >"dom-min-connect-time"</parameter>
            <parameter >s_nDomMinConnectTime</parameter>
            <parameter >"ignore-pin-language"</parameter>
            <parameter >s_strIgnorePinLanguage</parameter>
            <parameter >"callingcard-start-delay"</parameter>
            <parameter >s_fPreStartCallDelay</parameter>
            <parameter >"codec"</parameter>
            <parameter >s_strCodec</parameter>
            <parameter >"customer-code"</parameter>
            <parameter >s_strCustomerCode</parameter>
            <parameter >"send-info-msg"</parameter>
            <parameter >s_strSendInfoMsg</parameter>
            <parameter >"send-precall-info-msg"</parameter>
            <parameter >s_strSendPrecallInfoMsg</parameter>
            <parameter >"acd-media-server-type"</parameter>
            <parameter >s_strACDMediaServerType</parameter>
            <parameter >"moh-media-server-type"</parameter>
            <parameter >s_strMOHMediaServerType</parameter>
            <parameter >"ivr-callback-delay"</parameter>
            <parameter >s_nIVR_CALLBACK_DELAY</parameter>
            <parameter >"prepend-service-provider-code"</parameter>
            <parameter >s_strPrependSVC</parameter>
            <parameter >"use-ingress-call-treatment-types"</parameter>
            <parameter >s_strReadCallTreatmentType</parameter>
            <parameter >"use-ingress-service-provider-codes"</parameter>
            <parameter >s_strReadSPCode</parameter>
            <parameter >"postpaid-acct-nbr-timeout"</parameter>
            <parameter >s_nGetPostPaidAcctNbrTimeout</parameter>
            <parameter >"prepaid-pin-timeout"</parameter>
            <parameter >s_nGetPrepaidPinTimeout</parameter>
            <parameter >"destination-timeout"</parameter>
            <parameter >s_nGetDestTimeout</parameter>
            <parameter >"check-ani-for-info-digits"</parameter>
            <parameter >s_strAppPropCheckAniForInfoDigts</parameter>
            <parameter >"play-ringback-for-outdial"</parameter>
            <parameter >f_strPlayRingbackForOutdial</parameter>
            <parameter >"access-number-from-uri"</parameter>
            <parameter >s_strAccessNumberFromURI</parameter>
            <parameter >"e164-dialing"</parameter>
            <parameter >s_strE164_Dialing</parameter>
            <parameter >"suppress-on-hold"</parameter>
            <parameter >f_strAppPropSuppressOnHold</parameter>
            <parameter >"speed-dial-strip-leading-one"</parameter>
            <parameter >s_strStripLeadingOne</parameter>
            <parameter >"suppress-caller-id"</parameter>
            <parameter >s_strSuppressCallerId</parameter>
            <parameter >"use-from-header-for-ani"</parameter>
            <parameter >f_strUseFromHeaderForAni</parameter>
            <parameter >"please-hold-interval"</parameter>
            <parameter >s_nAppPropPleaseHoldInterval</parameter>
            <parameter >"dtmf-default-timeout"</parameter>
            <parameter >s_nDTMFDefaultTimeout</parameter>
            <parameter >"sub-disabled-suppress-call-cs"</parameter>
            <parameter >s_bSuppressCallCSPrompt</parameter>
            <parameter >"unauthorized-ani-redirect"</parameter>
            <parameter >s_bRedirect</parameter>
            <parameter >"outbound-cic"</parameter>
            <parameter >s_strOutboundCIC</parameter>
            <parameter >"single-stage-only"</parameter>
            <parameter >s_bSingleStageDialing</parameter>
            <parameter >"service-provider-code"</parameter>
            <parameter >s_strServiceProviderCode</parameter>
            <parameter >"play-chime"</parameter>
            <parameter >s_bPlayChime</parameter>
            <parameter >"annc-disabled-reason"</parameter>
            <parameter >s_bAnncDisabled</parameter>
            <parameter >"destination-prompt-pound-key"</parameter>
            <parameter >s_strDestPromptPoundKey</parameter>
            <parameter >"single-stage-pre-prompt-delay"</parameter>
            <parameter >s_fSingleStagePrePromptDelay</parameter>
            <parameter >"answer-invalid-access-number"</parameter>
            <parameter >s_strAnswerInvalidAccessNumber</parameter>
            <parameter >"invalid-access-number-prompt"</parameter>
            <parameter >s_nInvalidAccessNumberPrompt</parameter>
            <parameter >"warn-cut-off-seconds"</parameter>
            <parameter >s_nCutOffTimeSeconds</parameter>
            <parameter >"announce-hhmm"</parameter>
            <parameter >s_bAnnounceHoursMins</parameter>
            <parameter >"pin-play-zero-for-op"</parameter>
            <parameter >f_strPlay0</parameter>
            <parameter >"auto-ani-list"</parameter>
            <parameter >strAutoAniList</parameter>
          </user-function>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.s_strApplicationName = Session._appName;]]></script>
            <script language="javascript" timing="last" ><![CDATA[/**** STRING PROPERTIES *****/
if (Session.s_strPrimaryPSX.length <= 0) {
	Server.logInfo("WARNING:  NO SETTING FOR PRIMARY SOFTSWITCH.");
}

if (Session.s_strBackupPSX.length <= 0) {
	Server.logInfo("WARNING:  NO SETTING FOR BACKUP SOFTSWITCH.");
}

if (Session.s_strLocalHost.length <= 0) {
	Session.s_strLocalHost = Server.sipAddress;
	Server.logInfo("WARNING:  NO SETTING FOR LOCAL HOST IP ADDRESS.  USE DEFAULT: " + Session.s_strLocalHost);
} else {
	Server.logInfo("s_strLocalHost BEFORE: " + Session.s_strLocalHost);
	js_resolve_address(Session.s_strLocalHost);
	Server.logInfo("s_strLocalHost AFTER: " + Session.s_strLocalHost);
}
Server.logInfo("s_strLocalHost: " + Session.s_strLocalHost);

if (Session.s_strDEFAULT_ANI.length <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR PREPAID DEFAULT ANI.");
}

if (Session.s_strDigitPrependToOutDial.length <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR DIGIT PREPEND TO OUTDIAL.");
}

if (Session.s_strMSType.length <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR MEDIA SERVER TYP, DEAULT WILL BE PCS.");
	Session.s_strMSType = "PCS";
}

if (Session.s_strACDMediaServerType.length <= 0){
	Session.s_strACDMediaServerType = Session.s_strMSType;
	Server.logInfo("WARNING:  NO SETTING FOR ACD MEDIASERVER TYPE.  USE s_strMSType");
}

if (Session.s_strMOHMediaServerType.length <= 0){
	Session.s_strMOHMediaServerType = Session.s_strMSType;
	Server.logInfo("WARNING:  NO SETTING FOR MOH MEDIASERVER TYPE.  USE s_strMSType");
}

if (Session.s_strMSRetryFlag.length <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR RETRY TO CONNECT TO MEDIASERVER.");
}

if (Session.s_strOutdialDialingPlan.length <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR OUTDIAL DIALING PLAN.");
}

if (Session.s_strOutdialDigitMap.length <= 0){
	Session.s_strOutdialDigitMap = "(1xxxxxxxxxx|[2-9]xxxxxxxxx|xx.*|x.#|x.T|*x)";
	Server.logInfo("WARNING: NO SETTING OUTDIAL DIGIT MAP.  USE DEFAULT: " + Session.s_strOutdialDigitMap);
}

if (Session.s_strOutdialDialingPlan.length <= 0){
	Session.s_strOutdialDialingPlan = "1";
	Server.logInfo("WARNING: NO SETTING FOR DIALING PLAN.  USE DEFAULT: 1");
}

if (Session.s_strCodec.length <= 0){
	Session.s_strCodec = "PCMU";
	Server.logInfo("WARNING: NO SETTING FOR CODEC.  USE DEFAULT: PCMU");
}

Session.s_strVia = Session.s_strSIPVERSION + "/" + Session.s_strPROTOCOL + " " + Server.sipAddress + ":" + Server.sipPort ;
Server.logInfo("VIA = " + Session.s_strVia);

/***** BOOLEAN ****/
if (Session.s_strE164_Dialing.length <= 0){
    Session.s_strE164_Dialing = "F";
    Server.logInfo("WARNING: NO SETTING FOR E164_Dialing.  USE DEFAULT: " + Session.s_strE164_Dialing);
}

if (Session.s_strAccessNumberFromURI.length <= 0){
    Session.s_strAccessNumberFromURI = "F";
    Server.logInfo("WARNING: NO SETTING FOR ACCESS NUMBER FROM URI.  USE DEFAULT: " + Session.s_strAccessNumberFromURI);
}

if (Session.s_strSendAlarmFlag.length <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR SEND ALARM FLAG.");
}

if (Session.s_strSessionTimerFlag.length <= 0 || "F" == Session.s_strSessionTimerFlag){
	Session.s_strSessionTimerFlag = "F";
	Server.logInfo("WARNING: NO SETTING FOR SESSION TIMER FLAG.  USE DEFAULT: F");
	Session.s_nSessionTimerInterval = 0;
	Server.logInfo("WARNING: NO SETTING SESSION TIMER INTERVAL.  USE DEFAULT: 0");
} else {
	if (Session.s_nSessionTimerInterval <= 0){
		Session.s_nSessionTimerInterval = 120;
		Server.logInfo("WARNING: NO SETTING SESSION TIMER INTERVAL.  USE DEFAULT: 120");
	}
}

if (Session.s_strIgnorePinLanguage.length <= 0){
 Session.s_strIgnorePinLanguage = "F";
}

if (Session.s_strSendInfoMsg.length <= 0){
	Session.s_strSendInfoMsg = "F";
	Server.logInfo("WARNING: NO SETTING SENDING INFO MESSAGE.  USE DEFAULT: " + Session.s_strSendInfoMsg);
}

if (Session.s_strSendPrecallInfoMsg.length <= 0){
	Session.s_strSendPrecallInfoMsg = "F";
	Server.logInfo("WARNING: NO SETTING SENDING INFO MESSAGE PRECALL.  USE DEFAULT: " + Session.s_strSendPrecallInfoMsg);
}

if(Session.s_strAppPropCheckAniForInfoDigts.length <= 0) {
	Session.s_strAppPropCheckAniForInfoDigts = "F";
	Server.logInfo("WARNING: NO SETTING FOR CheckAniForInfoDigts.  USE DEFAULT: " + Session.s_strAppPropCheckAniForInfoDigts);
}

if(Session.f_strUseFromHeaderForAni.length <=0) {
	Session.f_strUseFromHeaderForAni = "T";
	Server.logInfo("WARNING: NO SETTING FOR <use-from-header-for-ani>.  USE DEFAULT: " + Session.f_strUseFromHeaderForAni);
}

Session.s_bAppPropUseFromHeaderForAni = js_process_application_property(Session.f_strUseFromHeaderForAni);
Session.s_bAppPropSuppressOnHold = js_process_application_property(Session.f_strAppPropSuppressOnHold);
Session.s_bPlayRingbackForOutdial = js_process_application_property(Session.f_strPlayRingbackForOutdial);
Session.s_strSendAlarmFlag = js_process_string_application_property(Session.s_strSendAlarmFlag);
Session.s_strMSRetryFlag = js_process_string_application_property(Session.s_strMSRetryFlag);
Session.s_strSessionTimerFlag = js_process_string_application_property(Session.s_strSessionTimerFlag);
Session.s_strIgnorePinLanguage = js_process_string_application_property(Session.s_strIgnorePinLanguage);
Session.s_strSendInfoMsg = js_process_string_application_property(Session.s_strSendInfoMsg);
Session.s_strSendPrecallInfoMsg = js_process_string_application_property(Session.s_strSendPrecallInfoMsg);
Session.s_strReadCallTreatmentType = js_process_string_application_property(Session.s_strReadCallTreatmentType);
Session.s_strReadSPCode = js_process_string_application_property(Session.s_strReadSPCode);
Session.s_strAppPropCheckAniForInfoDigts = js_process_string_application_property(Session.s_strAppPropCheckAniForInfoDigts);

Session.s_strAnswerInvalidAccessNumber = js_process_string_application_property(Session.s_strAnswerInvalidAccessNumber);
if(!Session.s_strAnswerInvalidAccessNumber) {
	 Server.logInfo("WARNING: Application will Play Early Media Prompt For Invalid Access Numbers");
}

if(!Session.s_bAppPropUseFromHeaderForAni) {
	Server.logInfo("WARNING: Application will use Remote Party Id for the ANI.");
}

/***** INTEGER *****/
if (Session.s_nPacketizationPeriod <= 0){
	Session.s_nPacketizationPeriod = 20;
	Server.logInfo("WARNING: NO SETTING FOR PACKETIZATION PERIOD.  USE DEFAULT: " + Session.s_nPacketizationPeriod);
}

if (Session.s_nRING_NO_ANSWER_TIME <= 0){
	Session.s_nRING_NO_ANSWER_TIME = 60;
	Server.logInfo("WARNING: NO SETTING RING NO ANSWER TIME.  USE DEFAULT: " + Session.s_nRING_NO_ANSWER_TIME);
}

if(Session.s_nIVR_CALLBACK_DELAY <= 0) {
	Session.s_nIVR_CALLBACK_DELAY = 5;
	Server.logInfo("WARNING: NO SETTING CALLBACK DELAY.  USE DEFAULT: " + Session.s_nIVR_CALLBACK_DELAY);	
}

if (Session.s_nIntlMinConnectTime <= 0){
	Server.logInfo("WARNING:  NO SETTING FOR INTL MINIMUM CONNECT TIME.");
}

if (Session.s_nDomMinConnectTime){
	Server.logInfo("WARNING:  NO SETTING FOR DOMESTIC MINIMUM CONNECT TIME.");
}

if (Session.s_nGetDestTimeout <= 0){
	Session.s_nGetDestTimeout = 40;
	Server.logInfo("WARNING: NO SETTING FOR s_nGetDestTimeout.  USE DEFAULT: " + Session.s_nGetDestTimeout);
}

if (Session.s_nGetPostPaidAcctNbrTimeout <= 0){
	Session.s_nGetPostPaidAcctNbrTimeout = 40;
	Server.logInfo("WARNING: NO SETTING FOR s_nGetPostPaidAcctNbrTimeout.  USE DEFAULT: " + Session.s_nGetPostPaidAcctNbrTimeout);
}

if (Session.s_nGetPrepaidPinTimeout <= 0){
	Session.s_nGetPrepaidPinTimeout = 40;
	Server.logInfo("WARNING: NO SETTING FOR s_nGetPrepaidPinTimeout.  USE DEFAULT: " + Session.s_nGetPrepaidPinTimeout);
}

if(Session.s_nDTMFDefaultTimeout <= 0){
   Session.s_nDTMFDefaultTimeout = 30;
   Server.logInfo(" WARNING: NO SETTING For <default-dtmf-timeout> in ps_master_config.xml. USING DEFAULT: " + Session.s_nDTMFDefaultTimeout );
}
if(Session.s_nAppPropPleaseHoldInterval <= 0) {
	Session.s_nAppPropPleaseHoldInterval = 30;
	Server.logInfo("WARNING: NO SETTING FOR <please-hold-interval> in ps_master_config.xml.  USE DEFAULT: " + Session.s_nAppPropPleaseHoldInterval);
}

if(Session.s_nInvalidAccessNumberPrompt > 0) {
	 Server.logInfo("INFO: Prompt for Invalid Access Number = " + Session.s_nInvalidAccessNumberPrompt);
} else {
	 Server.logInfo("WARNING: No Setting for Invalid Access Number Prompt in ps_master_config.xml USE DEFAULT: 322-GoodBye");	 	 
}

js_initCSR_REASONS(Session.s_oCSR_REASONS);
js_initORIG_TYPES(Session.s_oORIG_TYPES);
js_initINITIATION_TYPES(Session.s_oINITIATION_TYPES);

Session.s_nSoapPort = Server.soapPort;

/**** FLOAT ****/
if(Session.s_fPreStartCallDelay <= 0) {
	Server.logInfo("WARNING: NO SETTING FOR s_fPreStartCallDelay. USE DEFAULT: " + Session.s_fPreStartCallDelay);
}


if ( Session.s_bSuppressCallCSPrompt ) {
	Server.logInfo("s_bSuppressCallSCPrompt is set to true.");
}

if ( Session.s_bRedirect ) {
	Server.logInfo("If the caller's ani cannot be authorized, a 403 Forbidden will be returned.");
}

if ( 0 < Session.s_strOutboundCIC.length ) {
	Server.logInfo("Default carrier code value to be appened to the B-leg INVITE: " + Session.s_strOutboundCIC);
}

if ( Session.s_bSingleStageDialing ) {
	Server.logInfo("The system is configured for single stage dialing only.");
	Server.logInfo("The Service Provider Code is: " + Session.s_strServiceProviderCode);
	Server.logInfo("The delay before playing the bong or custom prompt is: " + Session.s_fSingleStagePrePromptDelay + " seconds") ;
}
if (Session.s_strDestPromptPoundKey.length <= 0){
	Session.s_strDestPromptPoundKey = "F";
	Server.logInfo("WARNING: NO SETTING DESTINATION PROMPT POUND KEY.  USE DEFAULT: " + Session.s_strDestPromptPoundKey);
}
if(Session.f_strPlay0.length <= 0){
	Session.s_bPinPlayZeroForOperator = true;
	Server.logInfo("WARNING: NO SETTING PIN PLAY 0 FOR OPERATOR.  USE DEFAULT: " + Session.s_bPinPlayZeroForOperator);
}else{
	Session.s_bPinPlayZeroForOperator =  js_process_application_property(Session.f_strPlay0);
}

Session.s_oAutoAniArray.length = 0 ;
if( Session.strAutoAniList.length > 0 ) {
	var arr = Session.strAutoAniList.split(",") ;
	for( var i = 0; i < arr.length; i++ ) {
		var s = new String( arr[i] ) ;
		s = trimString( s ) ;
		
		Server.logInfo("Access number " + s + " will be an auto ANI access number") ;
		Session.s_oAutoAniArray[i] = s ;
	}
}
]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1178 y=101 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=458 y=64 ?>
          <!--APIGetTestData-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;APIGetTestData&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oTEST</parameter>
          </function>
          <results >
            <result name="Default" link="18" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_initTEST(Session.g_oTEST);


]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.lockSharedVariables();
if("T" == Session.g_oTEST.strCardServicesTestFlag) {
	Session.s_strTestModeFlag = "T";
}
Server.unlockSharedVariables();]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=252 y=71 ?>
          <!--PrepaidAPIDeleteLockPins-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIDeleteLockPins&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >s_strLocalHost</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=683 y=67 ?>
          <!--CallingCardCleanupSession-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CallingCardCleanupSessions&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >s_strLocalHost</parameter>
          </function>
          <results >
            <result name="Default" link="19" stubbed="0"/>
          </results>
        </action>
        <action id="19" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=911 y=102 ?>
          <!--Init-->
          <java xmlns="www.pactolus.com:xtml:application" class="s_strJavaClass" method="&quot;Init&quot;" timeout="" return="" method-return-var="nReturn" method-return-type="0"/>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Calling XtmlInterface.Init") ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Back from calling XtmlInterface.Init, return code " + Session.nReturn) ;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnSessionEnd" start="34" event="OnSessionEnd" returns="void" >
      <parameters >
        <parameter name="nSessionEndReason" type="i2"/>
      </parameters>
      <local-vars >
        <var name="f_oNullArray" type="object" ></var>
        <var name="f_nReturnCode" type="i4" >-10</var>
      </local-vars>
      <actions >
        <action id="34" plug-in="Pactolus.Branch.1" ><?xtml-editor x=77 y=171 ?>
          <!--fail to connect to MS-->
          <results >
            <result name="Default" link="24" stubbed="0"/>
            <result name="g_bFailToConnectToMS" link="2" stubbed="1" >g_bFailToConnectToMS == true</result>
            <result name="g_bInvalidAniRedirect" link="2" stubbed="1" >g_bInvalidAniRedirect == true</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=75 y=913 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("INFO: prepaid.END SESSION.3: SUCCESS");
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1107 y=284 ?>
          <!--procSessionCompletion-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcSessionCompletion&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="22" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=79 y=380 ?>
          <!--delete MS connection-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="26" stubbed="0"/>
            <result name="MOH.bCurrentlyInConf" link="28" stubbed="0" >g_oMOH.bCurrentlyInConf == true</result>
          </results>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=340 y=170 ?>
          <!--StopTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=556 y=431 ?>
          <!--DeleteConference-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteConference&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oConfMS</parameter>
          </function>
          <results >
            <result name="Default" link="29" stubbed="1"/>
          </results>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=314 y=341 ?>
          <!--delete MOH connection-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMOH</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="0"/>
          </results>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=334 y=487 ?>
          <!--"DisconnectFromMOH"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DisconnectFromMOH&quot;" return="" external-function="1" library="lib_moh.xml" >
            <parameter >g_oMOH</parameter>
            <parameter >g_oMOH.strSessionId</parameter>
            <parameter >g_oMOH.nConfIndex</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="0"/>
          </results>
        </action>
        <action id="29" plug-in="Pactolus.Branch.1" ><?xtml-editor x=72 y=652 ?>
          <!--what state-->
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Begin Assignment" link="30" stubbed="0" >g_bBeginAssignment == true</result>
            <result name="Begin Request or Requeue" link="32" stubbed="0" >g_bBeginRequest == true</result>
          </results>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=322 y=615 ?>
          <!--Soap EndRequest-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MsgEndRequestCSR&quot;" return="" external-function="1" library="lib_soap.xml" >
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
        </action>
        <action id="31" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=548 y=614 ?>
          <!--"ACDAPIEndAssignment"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ACDAPIEndAssignment&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
        </action>
        <action id="32" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=344 y=747 ?>
          <!--Soap EndRequest-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MsgEndRequestCSR&quot;" return="" external-function="1" library="lib_soap.xml" >
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="33" stubbed="0"/>
          </results>
        </action>
        <action id="33" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=566 y=743 ?>
          <!--"ACDAPIEndRequest"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ACDAPIEndRequest&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="36" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=728 y=355 ?>
          <!--JAVA: psAPIProcCallCompletion-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIProcCallCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >f_oNullArray</parameter>
          </function>
          <results >
            <result name="Default" link="21" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START CallCompletion for A Leg *********");

Session.f_oNullArray.length = 0;

Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);

Session.g_oSUB.nSecondsAvailable = 0;

if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strClickToDial) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegClickToDialOut;

} else if(	Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strMessageCallback) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegMsgInitiatedCallback;

} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strIvrCallback) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegIvrInitiatedCallback;

} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strAccessNumCallback) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegAccessNbrIniatedCallback;

} else if(Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strOneStageDialing) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegOneStageDialing;

} else {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegIvrInitiatedCallback;

} 



]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");

Server.logInfo("procCallCompletion for A leg returned " + Session.f_nReturnCode);



if (Session.f_nReturnCode != 0)

{

	Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION");

	Server.logError("ERROR: procCallCompletion returned: " + Session.f_nReturnCode);

}



Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.Branch.1" ><?xtml-editor x=693 y=202 ?>
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="oAPI.bALegRatingOn" link="36" stubbed="0" >g_oAPI.bALegRatingOn == true</result>
          </results>
        </action>
        <action id="39" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=318 y=1086 ?>
          <!--s_nIVR_CALLBACK_DELAY-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="s_nIVR_CALLBACK_DELAY"/>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
        </action>
        <action id="40" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=509 y=211 ?>
          <!--StopOneTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopOneTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="38" stubbed="0"/>
          </results>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="544" y-coord="310" width="198" height="61" text="may not in MOH conference, but may use MOH ms" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="OnCancel" start="6" event="OnCancel" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="6" plug-in="Pactolus.Branch.1" ><?xtml-editor x=85 y=219 ?>
          <!--valid?-->
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="sent final response == false" link="1" stubbed="0" >g_bSentFinalResponse == false</result>
          </results>
        </action>
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=310 y=371 ?>
          <!--200 OK-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=543 y=373 ?>
          <!--487 Request Terminated-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 487 Request Terminated"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var cseq = new SipCSeq(Session.strCSeq);
cseq.method = "INVITE";
Session.strCSeq = cseq.encode();]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error sending 487 Request Terminated:");
	Server.logError("Result.name: <" + Result.name + ">");
	Server.logError("g_oCallLegA.strTo: <" + Session.g_oCallLegA.strTo + ">");
	Server.logError("g_oCallLegA.strFrom: <" + Session.g_oCallLegA.strFrom + ">");
	Server.logError("g_oCallLegA.strVia: <" + Session.g_oCallLegA.strVia + ">");
	Server.logError("strCallId: <" + Session.strCallId + ">");
}]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.EndSession.1" ><?xtml-editor x=1035 y=300 ?></action>
        <action id="7" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=303 y=163 ?>
          <!--200 OK-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=781 y=370 ?>
          <!--send alert early-call-cancel-->
          <user-function xmlns="www.pactolus.com:xtml:application" process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"early-call-cancel"</parameter>
          </user-function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="PlayPromptAndHangup" start="14" event="PlayPromptAndHangup" returns="i4" >
      <local-vars >
        <var name="bMessageNumber" type="boolean" >0</var>
        <var name="bCustomerServiceNumber" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="14" plug-in="Pactolus.Branch.1" ><?xtml-editor x=41 y=50 ?>
          <!--error msg > 0 ?-->
          <results >
            <result name="Default" link="12" stubbed="0"/>
            <result name="Play Msg # and CS #" link="9" stubbed="0" >bCustomerServiceNumber == true
AND bMessageNumber == true
AND s_bSuppressCallCSPrompt == false</result>
            <result name="Play Msg # and CS" link="10" stubbed="0" >bMessageNumber == true
AND s_bSuppressCallCSPrompt == false
AND bCustomerServiceNumber == false</result>
            <result name="Play CS #" link="11" stubbed="1" >bCustomerServiceNumber == true
AND s_bSuppressCallCSPrompt == false</result>
            <result name="Suppress CS, no msg #" link="15" stubbed="0" >bMessageNumber == false
AND s_bSuppressCallCSPrompt == true</result>
            <result name="Suppress CS, msg #" link="16" stubbed="0" >bMessageNumber == true
AND s_bSuppressCallCSPrompt == true</result>
            <result name="!SuppressCS, !CSPhone, msg#" link="16" stubbed="0" >bCustomerServiceNumber == false
AND g_bSuppressCallCSPrompt == false
AND bMessageNumber == true</result>
            <result name="!SuppressCS, !CSPhone, no msg#" link="15" stubbed="0" >bCustomerServiceNumber == false
AND bMessageNumber == false
AND g_bSuppressCallCSPrompt == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_nErrorMsgNumber > 0) {
	Session.bMessageNumber = true;
}

if(Session.g_oAPI.strCustomerServicePhone.length > 1) {
	Session.bCustomerServiceNumber = true;
}]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=741 y=155 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="0"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=989 y=223 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="9" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=355 y=199 ?>
          <!--Call CS Number; Error Msg Number; Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >306</audio>
            <audio type="digits" >g_oAPI.strCustomerServicePhone</audio>
            <audio type="index" >3846</audio>
            <audio type="index" >365</audio>
            <audio type="number" >g_nErrorMsgNumber</audio>
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing session ending prompts.");
}]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=325 y=360 ?>
          <!--Call CS; Error Msg Number;  Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >307</audio>
            <audio type="index" >365</audio>
            <audio type="number" >g_nErrorMsgNumber</audio>
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing session ending prompts.");
}]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=207 y=540 ?>
          <!--Call CS Number; Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >306</audio>
            <audio type="digits" >g_oAPI.strCustomerServicePhone</audio>
            <audio type="index" >3846</audio>
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing session ending prompts.");
}]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=374 y=17 ?>
          <!--Call CS; Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >307</audio>
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing session ending prompts.");
}]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.Branch.1" ><?xtml-editor x=612 y=297 ?>
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="One Stage Dialing Session" link="7" stubbed="0" >g_oAPI.strOriginationType == s_oORIG_TYPES.strOneStageDialing</result>
          </results>
        </action>
        <action id="15" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=113 y=684 ?>
          <!--Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >.2</audio>
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing session ending prompts.");
}]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=14 y=821 ?>
          <!--Goodbye-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >.2</audio>
            <audio type="index" >365</audio>
            <audio type="number" >g_nErrorMsgNumber</audio>
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error playing session ending prompts.");
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSRBeginAssignment" start="3" event="OnCSRBeginAssignment" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="lCSRAssignmentId" type="i8" pass="byref"/>
        <parameter name="lCSRRequestId" type="i8" pass="byref"/>
        <parameter name="lCSRUserId" type="i8" pass="byref"/>
        <parameter name="lCSRRequestSkillId" type="i8" pass="byref"/>
        <parameter name="strCSRRequestSkillName" type="string" pass="byref"/>
        <parameter name="lCSRRequestLanguageId" type="i8" pass="byref"/>
        <parameter name="strCSRRequestLanguageName" type="string" pass="byref"/>
        <parameter name="lCSRRequestGroupId" type="i8" pass="byref"/>
        <parameter name="strCSRRequestGroupName" type="string" pass="byref"/>
        <parameter name="nCSRRequestType" type="i4" pass="byref"/>
        <parameter name="strCSRRequestTypeName" type="string" pass="byref"/>
        <parameter name="lServiceProviderId" type="i8" pass="byref"/>
        <parameter name="strServiceProviderName" type="string" pass="byref"/>
        <parameter name="lOfferingId" type="i8" pass="byref"/>
        <parameter name="strOfferingName" type="string" pass="byref"/>
        <parameter name="strConfEventId" type="string" pass="byref"/>
        <parameter name="strConfModPasscode" type="string" pass="byref"/>
        <parameter name="strSubscriberAccount" type="string" pass="byref"/>
        <parameter name="strSubscriberFirstName" type="string" pass="byref"/>
        <parameter name="strSubscriberLastName" type="string" pass="byref"/>
        <parameter name="strCSRAppServerIP" type="string" pass="byref"/>
        <parameter name="strCSRAssignmentType" type="string" pass="byref"/>
        <parameter name="lCSRAssignmentDuration" type="i8" pass="byref"/>
        <parameter name="strSubscriberPin" type="string" pass="byref"/>
        <parameter name="strCSRAssignmentAction" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_oMS" type="object" ></var>
        <var name="f_bUsedMOH_MS" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=118 y=52 ?>
          <!--"BeginCSRAssignment"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;BeginCSRAssignment&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_nCurrentState</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >f_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >s_nPROMPT_JOIN_TONE</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="SUCCESS" link="5" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();


Session.g_nCurrentState = Session.s_nBEGINASSIGNMENT;
Session.g_bBeginAssignment = true;

Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_oACD.lCSRAssignmentId = new String(Session.lCSRAssignmentId);
Session.g_oACD.lCSRRequestId = Session.lCSRRequestId;
Session.g_oACD.lCSRUserId = Session.lCSRUserId;
Session.g_oACD.lCSRRequestSkillId = Session.lCSRRequestSkillId;
Session.g_oACD.strCSRRequestSkillName = Session.strCSRRequestSkillName;
Session.g_oACD.lCSRRequestLanguageId = Session.lCSRRequestLanguageId;
Session.g_oACD.strCSRRequestLanguageName = Session.strCSRRequestLanguageName;
Session.g_oACD.lCSRRequestGroupId = Session.lCSRRequestGroupId;
Session.g_oACD.strCSRRequestGroupName = Session.strCSRRequestGroupName;
Session.g_oACD.nCSRRequestType = Session.nCSRRequestType;
Session.g_oACD.strCSRRequestTypeName = Session.strCSRRequestTypeName;

Session.g_oACD.strCSRAssignmentAction = Session.strCSRAssignmentAction;


Session.g_oACD.lCSRAssignmentStartTime = Server.getUTCTime();
Session.g_oACD.strCSRAppServerIP = Session.strCSRAppServerIP;

if (Session.g_oMOH.bCurrentlyInConf || Session.g_oMOH.bCurrentlyConnected)
{
	Session.f_oMS = Session.g_oMOH;
	Session.f_bUsedMOH_MS = true;
}
else
{
	Session.f_oMS = Session.g_oMS;
}

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.f_bUsedMOH_MS)
{
	Session.g_oMOH = Session.f_oMS;
}
else
{
	Session.g_oMS = Session.f_oMS;
}


]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=503 y=81 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="6" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=388 y=284 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.EndSession.1" ><?xtml-editor x=722 y=98 ?></action>
      </actions>
    </function>
    <function name="OnCSREndAssignment" start="12" event="OnCSREndAssignment" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strCSRTransactionId" type="string" pass="byref"/>
        <parameter name="lCSRAssignmentId" type="string" pass="byref"/>
        <parameter name="lCSRRequestId" type="i8" pass="byref"/>
        <parameter name="lCSRUserId" type="i8" pass="byref"/>
        <parameter name="strCSRAssignmentAction" type="string" pass="byref"/>
        <parameter name="strPasscode" type="string" pass="byref"/>
        <parameter name="strPrepaidPin" type="string" pass="byref"/>
        <parameter name="strPostpaidPin" type="string" pass="byref"/>
        <parameter name="strPostpaidAccountNumber" type="string" pass="byref"/>
        <parameter name="strOutdialPhoneNumber" type="string" pass="byref"/>
        <parameter name="nCSRAvailabilityState" type="i4" pass="byref"/>
        <parameter name="strBillableFlag" type="string" pass="byref"/>
        <parameter name="nReleaseToConfStatus" type="i4" pass="byref"/>
        <parameter name="lPartySchedId" type="i8" pass="byref"/>
        <parameter name="strPartyDetail" type="string" pass="byref"/>
        <parameter name="nDefaultAudioMode" type="i4" pass="byref"/>
        <parameter name="strRequeueFlag      " type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="12" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=20 ?>
          <results >
            <result name="Default" link="1" stubbed="0"/>
            <result name="g_bGotCSROutdial" link="2" stubbed="1" >g_bGotCSROutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Save off values

js_disable_event();

Server.logInfo("Session.array.length:" + Session.g_oArrayCallLegs.length);
Session.g_bBeginAssignment = false;
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strCSRTransactionId;
Session.g_oACD.lCSRAssignmentId = Session.lCSRAssignmentId;
Session.g_oACD.lCSRRequestId = Session.lCSRRequestId;
Session.g_oACD.lCSRUserId = Session.lCSRUserId;
Session.g_oACD.strCSRAssignmentAction = Session.strCSRAssignmentAction;

if(Session.strBillableFlag != "" && Session.strBillableFlag != " ") {
	Session.g_oTempLeg.strBillableFlag = Session.strBillableFlag;
}	

if (Session.g_oAPI.nStatePriorToCSR == Session.s_nGET_PIN || 
	Session.g_oAPI.nStatePriorToCSR == Session.s_nSTATE_LANGUAGE_MENU ||
	Session.g_oAPI.nStatePriorToCSR == Session.s_nSTATE_GET_PIN_PRPD_OR_POPD)
{

	Session.g_oSUB.strUserPin = Session.strPrepaidPin;

}

if(Session.strPostpaidAccountNumber.length > 0) {
	Session.g_oSUB.strAccountNumber = Session.strPostpaidAccountNumber;
}

if(Session.strPostpaidPin.length > 0) {
	Session.g_oSUB.strUserPin = Session.g_oSUB.strAccountNumber + Session.strPostpaidPin;
}

Session.g_oACD.strOutdialBLegPhoneNumber = Session.strOutdialPhoneNumber;
Session.g_oAPI.strDestinationNumber = Session.strOutdialPhoneNumber;

if ("6" == Session.strCSRAssignmentAction || "7" == Session.strCSRAssignmentAction || "13" == Session.strCSRAssignmentAction) {
	Session.g_nCurrentState = Session.s_nREQUEUE;
} else {
	Session.g_bBeginRequest = false;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(2 == Result.id) {

	Session.g_bGotEndAssignment = true;

}
js_enable_event();

]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=45 y=181 ?>
          <!--"EndCSRAssignment"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;EndCSRAssignment&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oACD.strCSRAssignmentAction</parameter>
            <parameter >g_oAPI.nCallTerminationReason</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_bNullFlag</parameter>
            <parameter >g_oNULL</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oTempLeg</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Outdial" link="13" stubbed="0" >f_nReturnCode == 1</result>
            <result name="Get Dest" link="5" stubbed="0" >f_nReturnCode == 2</result>
            <result name="Get Pin" link="7" stubbed="0" >f_nReturnCode == 3</result>
            <result name="IVR" link="10" stubbed="0" >f_nReturnCode == 4</result>
            <result name="Do Nothin" link="2" stubbed="1" >f_nReturnCode == 5</result>
            <result name="Outdial (CSR Drop Out)" link="9" stubbed="0" >f_nReturnCode == 6</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
js_initCallLeg(Session.g_oTempLeg);

Session.g_bUsedTempLeg = false;
if(0 != Session.g_oArrayCallLegs.length) {
	Session.g_oTempLeg = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex];
	Session.g_bUsedTempLeg = true;
}

Server.logInfo("g_nCurrentArrayIndex:" + Session.g_nCurrentArrayIndex);
Server.logInfo("Session.array.length:" + Session.g_oArrayCallLegs.length);
Server.logInfo("strConfCallFlag:" + Session.g_oTempLeg.strConfCallFlag);
Server.logInfo("g_bUsedTempLeg:" + Session.g_bUsedTempLeg);]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode == 6) {

	Session.g_oACD.bCSRWithAB = false;

} 



if(2 != Result.id && 6 != Result.id) {



	Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");

	Session.g_oACD.lCSRAssignmentId = 0;

	Session.g_oACD.lCSRUserId = 0;	

}





if(2 == Session.f_nReturnCode) {

	Session.g_nCurrentState = Session.s_nGET_DESTINATION;

}



if(Session.g_bUsedTempLeg) {

	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex] = Session.g_oTempLeg;

	Session.g_bUsedTempLeg = false;

}





js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=832 y=334 ?>
          <return xmlns="www.pactolus.com:xtml:application" value="f_nReturnCode"/>
        </action>
        <action id="3" plug-in="Standard.EndSession.1" ><?xtml-editor x=635 y=52 ?></action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=316 y=41 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 19;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=662 y=499 ?>
          <!--Main-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=325 y=353 ?>
          <!--Get Pin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;GetPinNumberPrpdOrPopd&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=678 y=193 ?>
          <!--Main-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;



Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCSROutdialFlag = "T";

]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=191 y=442 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Auth Pin?" link="11" stubbed="0" >g_nCurrentState == s_nAUTHENTICATE_PIN</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
switch (Session.g_oAPI.nStatePriorToCSR)
{
	case Session.s_nSTATE_GET_PIN_PRPD_OR_POPD:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;
	case Session.s_nGET_PIN:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;	
	case Session.s_nSTATE_GET_PIN_POPD:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;			
	case Session.s_nGET_DESTINATION:
		Session.g_nCurrentState = Session.s_nGET_DESTINATION;
		break;
	case Session.s_nCC_RECHARGE:
		Session.g_nCurrentState = Session.s_nMAIN_MENU;	
		break;
	case Session.s_nBALANCE_XFER:
		Session.g_nCurrentState = Session.s_nBALANCE_XFER;	
		break;
	case Session.s_nMAIN_MENU:
		Session.g_nCurrentState = Session.s_nMAIN_MENU;	
		break;
	case Session.s_nSTATE_MAIN_MENU_POPD:
		Session.g_nCurrentState = Session.s_nSTATE_MAIN_MENU_POPD;	
		break;		
	case Session.s_nSTATE_MAIN_MENU_PRPD_OR_POPD:
		Session.g_nCurrentState = Session.s_nSTATE_MAIN_MENU_PRPD_OR_POPD;	
		break;				
	case Session.s_nSPEED_DIAL:
		Session.g_nCurrentState = Session.s_nSPEED_DIAL;
		break;						
	case Session.s_nSTATE_LANGUAGE_MENU:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;	
	default:
		Server.logError("UNKNOWN STATE PRIOR TO CSR.");
		break;
}
]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=295 y=625 ?>
          <!--"psAPIUnlockPin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="SUCCESS" >f_nReturnCode == s_sSUCCESS
OR f_nReturnCode == -1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=381 y=129 ?>
          <!--InitCallLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;InitCallLeg&quot;" return="g_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_nCurrentArrayIndex</parameter>
            <parameter >g_oTempLeg</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="9" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnCSRTakeCallerOffHold" start="1" event="OnCSRTakeCallerOffHold" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=32 y=45 ?>
          <!--proc CSRPutCallerOffHold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CSRCallerOffHold&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oMOH</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMOH</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
js_disable_event();

	Server.logInfo("g_oMOH.strConferenceId: " + Session.g_oMOH.strConferenceId);
	Server.logInfo("g_oMOH.strEndPoint: " + Session.g_oMOH.strEndPoint);
	Server.logInfo("g_oMOH.strContent: " + Session.g_oMOH.strContent);
	Server.logInfo("g_oMOH.strConnectionId: " + Session.g_oMOH.strConnectionId);
	Server.logInfo("g_oMOH.strCallId: " + Session.g_oMOH.strCallId);
	Server.logInfo("g_oMOH.strType: " + Session.g_oMOH.strType);
	Server.logInfo("g_oMOH.bCurrentlyInConf: " + Session.g_oMOH.bCurrentlyInConf);
	Server.logInfo("g_oMOH.bCurrentlyConnected: " + Session.g_oMOH.bCurrentlyConnected);
	Server.logInfo("g_oMOH.strSessionId: " + Session.g_oMOH.strSessionId);
	Server.logInfo("g_oMOH.nConfIndex: " + Session.g_oMOH.nConfIndex);]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=228 y=152 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO PUT CALLER OFF HOLD");
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSRPutCallerOnHold" start="1" event="OnCSRPutCallerOnHold" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=20 y=23 ?>
          <!--proc CSRPutCallerOnHold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CSRCallerOnHold&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMOH</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=274 y=20 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO PUT CALLER ON HOLD");
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSROutdialBLeg" start="1" event="OnCSROutdialBLeg" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="strPhoneNumber" type="string" pass="byref"/>
        <parameter name="strPrepaidPin" type="string" pass="byref"/>
        <parameter name="strPostpaidPin" type="string" pass="byref"/>
        <parameter name="strPostpaidAccountNum" type="string" pass="byref"/>
        <parameter name="strBillableFlag" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-99</var>
        <var name="f_nFAILURE" type="i4" >-1</var>
        <var name="f_bNoPin" type="boolean" >1</var>
        <var name="f_strACDAction" type="string" >19</var>
        <var name="f_nNULL" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=15 y=21 ?>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="!f_bNoPin, state = get pin" link="13" stubbed="0" >f_bNoPin == false
AND g_oAPI.nStatePriorToCSR == s_nSTATE_GET_PIN_PRPD_OR_POPD</result>
            <result name="!f_bNoPin" link="8" stubbed="0" >f_bNoPin == false</result>
            <result name="lPinId == 0" link="3" stubbed="1" >g_oSUB.lPinId == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD)
{
	if(Session.strPostpaidAccountNum.length == 0 || Session.strPostpaidPin.length == 0) 
	{
		Session.f_bNoPin = true;
	} 
	else 
	{
		Session.g_oSUB.strUserPin = Session.strPostpaidAccountNum + Session.strPostpaidPin;
		Session.f_bNoPin = false;
	}
}
else if(Session.strPrepaidPin.length > 0) {
	Session.f_bNoPin = false;
	Session.g_oSUB.strUserPin = Session.strPrepaidPin;
} else {
	Session.f_bNoPin = true;
}


Session.g_bGotCSRCancelOutdial = false;
Session.g_bGotCSRHangupOutdial = false;


Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;

Session.g_oAPI.strDestinationNumber = Session.strPhoneNumber;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oACD.strReturnMsg = "Failure to outdial B Leg, because there is no pin";
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=535 y=164 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="(0 or 2) or billFlag = F" link="12" stubbed="0" >(f_nReturnCode == 0
OR f_nReturnCode == 2)
OR strBillableFlag match "F"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Session.g_oSUB.strUserPin = Session.strPrepaidPin;

Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);


js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}

if (1 == Result.id)
{
 switch (Session.f_nReturnCode)
 {
  case 1:
   Session.g_oACD.strReturnMsg = "Call Failed -- insufficient balance";
   break;
  case 3:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber is deactivated";
   break;
  case 4:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber is expired";
   break;
  case 5:
   Session.g_oACD.strReturnMsg = "Call Failed -- pin already in use";
   break;
  case 10:
   Session.g_oACD.strReturnMsg = "Call Failed -- lot cancelled or suspended";
   break;
  case 11:
   Session.g_oACD.strReturnMsg = "Call Failed -- lot not activated";
   break;
  case 12:
   Session.g_oACD.strReturnMsg = "Call Failed -- access number not linked to product offering";
   break;
  default:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber validation failed with reason " + Session.f_nReturnCode;;
   break;
 }
} else {
	Session.g_oAPI.nStatePriorToCSR = Session.s_nGET_DESTINATION;
}

js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=13 y=379 ?>
          <!--"MsgCSROutdialBLegResponse"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MsgCSROutdialBLegResponse&quot;" return="" external-function="1" library="" >
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.nReturnReasonCode = -1;]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=953 y=54 ?>
          <!--"psAPIAuthorizeDestination"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="0-Valid, 1-No Limit, billFlag = F" link="9" stubbed="1" >f_nReturnCode == 0
OR strBillableFlag match "F"
OR f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session Id : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Calling Card Service Id : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber Id : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan Id : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Country Id : " + Session.g_oAPI.nOrigCountryId);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
if (1 == Result.id)
{
	switch (Session.f_nReturnCode)
	{
		case -3:
			Session.g_oACD.strReturnMsg = "Call Failed -- restricted destination";
			break;
		case -4:
			Session.g_oACD.strReturnMsg = "Call Failed -- insufficient digits";
			break;
		case -6:
			Session.g_oACD.strReturnMsg = "Call Failed -- insufficient funds";
			break;
		case -7:
			Session.g_oACD.strReturnMsg = "Call Failed -- no rate";
			break;
		case -8: 
			Session.g_oACD.strReturnMsg = "Call Failed -- destination not in 'phone me' list";
			break;		
		case -9: 
			Session.g_oACD.strReturnMsg = "Call Failed -- no applicable rates found for this call";
			break;								
		default:
			Session.g_oACD.strReturnMsg = "Call Failed";
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=23 y=548 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="7" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=20 y=491 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=309 y=190 ?>
          <!--psAPIUnlockPin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="13" stubbed="1"/>
          </results>
        </action>
        <action id="9" plug-in="Pactolus.Branch.1" ><?xtml-editor x=8 y=240 ?>
          <!--cancel outdial?-->
          <results >
            <result name="Default" link="28" stubbed="0"/>
            <result name="cancel outdial" link="3" stubbed="1" >g_bGotCSRCancelOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strDestinationNumber = Session.g_oCallLegB.strOutdialDestNbr;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oACD.strReturnMsg = "CSR outdial B leg canceled";
}]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1159 y=55 ?>
          <!--psAPIUnlockPin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="1"/>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=772 y=57 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
        </action>
        <action id="13" plug-in="Pactolus.Branch.1" ><?xtml-editor x=294 y=26 ?>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Postpaid" link="14" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=518 y=51 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="(0 or 2) or billFlag = F" link="12" stubbed="0" >(f_nReturnCode == 0
OR f_nReturnCode == 2)
OR strBillableFlag match "F"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
if (1 == Result.id)
{
 switch (Session.f_nReturnCode)
 {
  case -4:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber is deactivated";
   break;
  case -5:
   Session.g_oACD.strReturnMsg = "Call Failed -- account already in use";
   break;
  case -9:
   Session.g_oACD.strReturnMsg = "Call Failed -- corporate account deactivated";
   break;
  case -10:
   Session.g_oACD.strReturnMsg = "Call Failed -- account requires ANI authentication";
   break;
  case -11:
   Session.g_oACD.strReturnMsg = "Call Failed -- insufficient credit to place call";
   break;
  case -12:
   Session.g_oACD.strReturnMsg = "Call Failed -- access number not linked to product offering";
   break;
  default:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber validation failed with reason " + Session.f_nReturnCode;;
   break;
 }
} else {

	if(Session.g_oAPI.nStatePriorToCSR == Session.s_nSTATE_GET_PIN_PRPD_OR_POPD) {
		Session.g_oAPI.nStatePriorToCSR = Session.s_nGET_DESTINATION;
	}	
}


js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Standard.EndSession.1" ><?xtml-editor x=34 y=692 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining prepaid or postpaid.");]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Pactolus.Branch.1" ><?xtml-editor x=480 y=316 ?>
          <results >
            <result name="Default" link="6" stubbed="1"/>
            <result name="EndAssignment, Success" link="17" stubbed="0" >g_bGotEndAssignment == true



AND f_nReturnCode == 0</result>
            <result name="EndAssignment, Failure" link="27" stubbed="0" >g_bGotEndAssignment == true



AND f_nReturnCode != 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.strCSRDidOutdial = "T";



Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;



]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=875 y=292 ?>
          <!--OnCSREndAssignment-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;OnCSREndAssignment&quot;" return="" external-function="0" library="" >
            <parameter >g_oACD.strACDControllerIP</parameter>
            <parameter >g_oACD.nACDControllerPort</parameter>
            <parameter >g_oACD.strTransactionId</parameter>
            <parameter >g_oACD.lCSRAssignmentId</parameter>
            <parameter >g_oACD.lCSRRequestId</parameter>
            <parameter >g_oACD.lCSRUserId</parameter>
            <parameter >f_strACDAction</parameter>
            <parameter >g_strNULL</parameter>
            <parameter >g_oSUB.strUserPin</parameter>
            <parameter >g_strNULL</parameter>
            <parameter >g_strNULL</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >f_nNULL</parameter>
            <parameter >g_oArrayCallLegs[0].strBillableFlag</parameter>
            <parameter >f_nNULL</parameter>
            <parameter >f_nNULL</parameter>
            <parameter >f_nNULL</parameter>
            <parameter >f_nNULL</parameter>
            <parameter >g_strNULL</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bGotCSROutdial = false;
Session.g_bGotEndAssignment = false;]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=949 y=426 ?>
          <!--put A on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="24" stubbed="0"/>
          </results>
        </action>
        <action id="19" plug-in="Pactolus.Branch.1" ><?xtml-editor x=633 y=739 ?>
          <!--play prompt?-->
          <results >
            <result name="Default" link="23" stubbed="0"/>
            <result name="g_nPromptToPlay &gt; 0" link="21" stubbed="0" >g_nPromptToPlay &gt; 0</result>
          </results>
        </action>
        <action id="20" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=401 y=729 ?>
          <!--outdial from MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="22" stubbed="0"/>
            <result name="Success" link="19" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=879 y=777 ?>
          <!--g_nPromptToPlay-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="23" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=609 y=638 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=257 y=961 ?>
          <!--call is GET_DEST-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="6" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nGET_DESTINATION;]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=944 y=548 ?>
          <!--Remove member from temp conference-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;RemoveMemberFromConference&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oConfMS</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="1"/>
          </results>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=240 y=616 ?>
          <!--delete temp conference-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DeleteConference&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oConfMS</parameter>
          </function>
          <results >
            <result name="Default" link="20" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.g_oConfMS.bUseForACD = false;]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=320 y=406 ?>
          <!--proc CSROutdial-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcOnCSROutdialParty&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oConfMS</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="SUCCESS" link="16" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bGotCSROutdial = true;
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_strOrigAEndPoint = Session.g_oConfMS.strEndPoint;

if (Session.s_strTestModeFlag == "T")
{
	Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;
}

Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);
Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");

Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strBillableFlag = Session.strBillableFlag;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber = js_translate_destination_post_rating(Session.s_strCustomerCode, Session.g_oAPI.strDestinationNumber, Session.g_oAPI.strOriginationNumber, Session.g_oAPI.nOrigCountryId, Session.s_strE164_Dialing);

Session.g_oCallLegA.strContent = Session.g_oCallLegA.strOriginalContent;
Session.g_oAPI.nRTPClockRate = 8000;
Session.g_oAPI.nRTPEncoding = 0;
Session.f_lStartTime = Server.getUTCTime();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bGotCSROutdial = false;

if(0 == Session.f_nReturnCode) {
	Session.g_oACD.bCSRWithAB = true;
} else {
	Session.g_oACD.bCSRWithAB = false;
}]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Pactolus.Branch.1" ><?xtml-editor x=726 y=459 ?>
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="bAppPropSuppressOnHold" link="24" stubbed="0" >g_oAPI.bSuppressOnHold == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bGotCSROutdial = false;
Session.g_bGotEndAssignment = false;
Session.g_nPromptToPlay = 0;
switch (Session.f_nReturnCode)
{
	case 1:  //ring no answer
		Session.g_nPromptToPlay = 551;
		Session.g_oAPI.nCallTerminationReason = 8;
		break;
	case 2:  //busy
		Session.g_nPromptToPlay = 550;
		Session.g_oAPI.nCallTerminationReason = 7;
		break;
	default:
		Session.g_nPromptToPlay = 549;
		Session.g_oAPI.nCallTerminationReason = 4;
		break;
}]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=187 y=300 ?>
          <!--InitCallLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;InitCallLeg&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_nCurrentArrayIndex</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="26" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnPing" start="2" event="OnPing" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="strHostIP" type="string" pass="byref"/>
        <parameter name="nHostPort" type="i4" pass="byref"/>
      </parameters>
      <actions >
        <action id="2" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=161 y=107 ?>
          <!--RESPONSE SUCCESS-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="strACDControllerIP" transaction="strTransactionId" message-name="&quot;PingResponse&quot;" destination-port="nACDControllerPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace=""/>
          <results >
            <result name="Default" link="1" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="1" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=418 y=108 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="OnCSRCancelOutdialToBLeg" start="1" event="OnCSRCancelOutdialToBLeg" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=58 ?>
          <!--got cancel-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="bGotCSRCancel" link="3" stubbed="0" >g_bGotCSRCancelOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=251 y=19 ?>
          <!--"ProcOnCSRCancelOutdial"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcOnCSRCancelOutdial&quot;" return="" external-function="1" library="lib_acd.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("RECEIVE CSR CANCEL OUTDIAL TO B LEG FROM: ");

Server.logInfo("ACD CONTROLLER IP: " + Session.strACDControllerIP);

Server.logInfo("ACD CONTROLLER PORT: " + Session.nACDControllerPort);

Server.logInfo("ACD TRANSACTION ID: " + Session.strTransactionId);

Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;

Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;

Session.g_oACD.strTransactionId = Session.strTransactionId;

Session.g_bGotCSRCancelOutdial = true;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (true == Session.g_oACD.bCSRWithAB)
{
	Session.g_oACD.bCSRWithAB = false;
}]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=605 y=158 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=507 y=17 ?>
          <!--"psAPIProcCallCompletion"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIProcCallCompletion&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered = 0;

Session.g_oAPI.nTerminationReason = 10; //other



]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSRHangupBLeg" start="2" event="OnCSRHangupBLeg" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=74 ?>
          <!--got hangup-->
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="bGotCSRHangup" link="1" stubbed="0" >g_bGotCSRHangupOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=686 y=196 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oConfMS.strEndPoint = Session.g_strOrigAEndPoint;

js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=302 y=20 ?>
          <!--"ProcOnCSRHangupBLeg"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcOnCSRHangupBLeg&quot;" return="" external-function="1" library="lib_acd.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("RECEIVE CSR HANGUP B LEG FROM: ");
Server.logInfo("ACD CONTROLLER IP: " + Session.strACDControllerIP);
Server.logInfo("ACD CONTROLLER PORT: " + Session.nACDControllerPort);
Server.logInfo("ACD TRANSACTION ID: " + Session.strTransactionId);
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_bGotCSRHangupOutdial = true;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (true == Session.g_oACD.bCSRWithAB)
{
	Session.g_oACD.bCSRWithAB = false;
}]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=545 y=46 ?>
          <!--"psAPIProcCallCompletion"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIProcCallCompletion&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="1" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered = 0;

Session.g_oAPI.nCallTerminationReason = 11; 

]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnRefer" start="1" event="Refer" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string" pass="byref"/>
        <parameter name="strAcceptEncoding" type="string" pass="byref"/>
        <parameter name="strAcceptLanguage" type="string" pass="byref"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string" pass="byref"/>
        <parameter name="strCallId" type="string" pass="byref"/>
        <parameter name="strContact" type="string" pass="byref"/>
        <parameter name="strContent" type="string" pass="byref"/>
        <parameter name="strContentDisposition" type="string" pass="byref"/>
        <parameter name="strContentType" type="string" pass="byref"/>
        <parameter name="strCSeq" type="string" pass="byref"/>
        <parameter name="strDate" type="string" pass="byref"/>
        <parameter name="strEncryption" type="string" pass="byref"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string" pass="byref"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string" pass="byref"/>
        <parameter name="strProxyRequire" type="string" pass="byref"/>
        <parameter name="strRecordRoute" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strReferTo" type="string" pass="byref"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=208 y=146 ?>
          <!--"SIP/2.0 501 Not Implemented"-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 501 Not Implemented"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=492 y=145 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="ProcLowBalance" start="33" event="ReOriginate" returns="void" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_oOptions" type="object" ></var>
        <var name="f_bBalXfer" type="boolean" >0</var>
        <var name="f_bCustService" type="boolean" >0</var>
        <var name="f_bRecharge" type="boolean" >0</var>
        <var name="f_nNumRetries" type="i4" >0</var>
        <var name="f_bPlayMenu" type="boolean" >0</var>
        <var name="f_bLowBalance" type="boolean" >0</var>
        <var name="f_bGetDest" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="33" plug-in="Pactolus.Branch.1" ><?xtml-editor x=23 y=38 ?>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="f_bPlayMenu" link="32" stubbed="0" >f_bPlayMenu == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oCC.strBalanceTransferFlag: " + Session.g_oBALXFER.strBalanceTransferFlag);
Server.logInfo("g_oCC.strRechargableFlag: " + Session.g_oCC.strRechargableFlag);
Server.logInfo("g_oACD.strEnableFlag: " + Session.g_oACD.strEnableFlag);
Server.logInfo("g_oAPI.strCustomerServicePhone: " + Session.g_oAPI.strCustomerServicePhone);
Server.logInfo("g_oCC.strBalanceTransferFlag: " + Session.g_oBALXFER.strBalanceTransferFlag);
Server.logInfo("g_oCC.strRechargableFlag: " + Session.g_oCC.strRechargableFlag);
Server.logInfo("g_oACD.strEnableFlag: " + Session.g_oACD.strEnableFlag);
Server.logInfo("g_oAPI.strCustomerServicePhone: " + Session.g_oAPI.strCustomerServicePhone);
Server.logInfo("g_oAPI.bPctMaxCallDuration: " + Session.g_oAPI.bPctMaxCallDuration);
Server.logInfo("g_oAPI.strAllowZeroCostFlag: " + Session.g_oAPI.strAllowZeroCostFlag);

if((Session.g_oCC.strRechargableFlag == "T" || Session.g_oBALXFER.strBalanceTransferFlag == "T" || Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone.length != "") 
	&& false == Session.g_oAPI.bPctMaxCallDuration) {
		Session.f_bPlayMenu = true;
}



 ]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=17 y=772 ?>
          <!--PlayPromptAndHangup-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="14" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
if(Session.g_bOutOfMoney) {
            Session.g_oAPI.nSessionTerminationReason = 8;
} else {
            Session.g_oAPI.nSessionTerminationReason = 5;
}
]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=955 y=750 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="10" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=257 y=168 ?>
          <!--outdial from MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strType = Session.s_strMSType;]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Pactolus.Branch.1" ><?xtml-editor x=514 y=159 ?>
          <!--SUCCESS?-->
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="SUCCESS?" link="24" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller hung up" link="14" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=751 y=34 ?>
          <!--put A on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="Success" link="10" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="14" plug-in="Standard.EndSession.1" ><?xtml-editor x=301 y=863 ?></action>
        <action id="19" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=522 y=594 ?>
          <!--call balanceTransfer()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;BalanceTransfer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
        </action>
        <action id="20" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=508 y=321 ?>
          <!--invalid choice-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="24" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error" ><?xtml-editor visible=no?></result>
            <result name="Timeout" ><?xtml-editor visible=no?></result>
            <result name="too many tries" link="2" stubbed="1" >f_nNumRetries &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumRetries++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (5 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuMaxInvalids;	
}]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=727 y=569 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Pactolus.Branch.1" ><?xtml-editor x=276 y=336 ?>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="Recharge" link="26" stubbed="0" >f_bRecharge == true</result>
            <result name="Bal Xfer" link="19" stubbed="0" >f_bBalXfer == true</result>
            <result name="Cust Service" link="27" stubbed="0" >f_bCustService == true</result>
            <result name="Get Dest" link="30" stubbed="0" >f_bGetDest == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bBalXfer = false;
Session.f_bCustService = false;
Session.f_bRecharge = false;
Session.f_bGetDest = false;

if(Session.g_strDigit == "1") {

	switch (Session.f_oOptions[1].nOption) {
		case 519:
			Session.f_bRecharge = true;
			break;
		case 520:
			Session.f_bBalXfer = true;
			break;
		case 523:
			Session.f_bGetDest = true;
			break;	
	}

} else if(Session.g_strDigit == "2") {

	switch (Session.f_oOptions[2].nOption) {
		case 520:
			Session.f_bBalXfer = true;
			break;
		case 523:
			Session.f_bGetDest = true;
			break;			
	}
	
} else if(Session.g_strDigit == "3") {	

	switch (Session.f_oOptions[3].nOption) {
		case 523:
			Session.f_bGetDest = true;
			break;			
	}	
	

} else if(Session.g_strDigit == "0") {

		Session.f_bCustService = true;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuZeroOut;		

}

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 1 && Result.id != 8) {
	Session.g_nNumRetry = 0;
}


if(5 == Result.id) {
	Session.g_nCurrentState = Session.s_nGET_DESTINATION;
}]]></script>
          </scripts>
        </action>
        <action id="23" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=242 y=562 ?>
          <!--552-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >552</audio>
          </play>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="24" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=29 y=327 ?>
          <!--Main menu-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="g_oAPI.nMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >f_oOptions[1].nPress</audio>
            <audio type="index" >f_oOptions[1].nOption</audio>
            <audio type="index" >f_oOptions[1].nHalfTenth</audio>
            <audio type="index" >f_oOptions[2].nPress</audio>
            <audio type="index" >f_oOptions[2].nOption</audio>
            <audio type="index" >f_oOptions[2].nHalfTenth</audio>
            <audio type="index" >f_oOptions[3].nPress</audio>
            <audio type="index" >f_oOptions[3].nOption</audio>
            <audio type="index" >f_oOptions[3].nHalfTenth</audio>
            <audio type="index" >f_oOptions[0].nPressCS1</audio>
            <audio type="index" >f_oOptions[0].nPressCS2</audio>
            <audio type="index" >f_oOptions[0].nOptionCS</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="Success" link="22" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="23" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";
if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
	Server.logInfo("Special case: Farsi language");
		Session.f_oOptions[1].nHalfTenth = 220; // Play half second since assumming all options are on.
	Session.f_oOptions[1].nPress = 519; // Press 1
	Session.f_oOptions[1].nOption = 311; // CC Recharge

	Session.f_oOptions[2].nHalfTenth = 220; // Play half second since assumming all options are on.
	Session.f_oOptions[2].nPress = 520; // Press 2
	Session.f_oOptions[2].nOption = 312; // Bal Xfer

	Session.f_oOptions[3].nHalfTenth = 220; // Play half second
	Session.f_oOptions[3].nPress = 523; // Press 3
	Session.f_oOptions[3].nOption = 313; // Make Call

	Session.f_oOptions[0].nOptionCS = 931;// Customer Service
	Session.f_oOptions[0].nPressCS1 = 3870; // Press 0
	Session.f_oOptions[0].nPressCS2 = 99; // 0
}
else {
// Assume everything is on
Session.f_oOptions[1].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[1].nPress = 311; // Press 1
Session.f_oOptions[1].nOption = 519; // CC Recharge

Session.f_oOptions[2].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[2].nPress = 312; // Press 2
Session.f_oOptions[2].nOption = 520; // Bal Xfer

Session.f_oOptions[3].nHalfTenth = 220; // Play half second
Session.f_oOptions[3].nPress = 313; // Press 3
Session.f_oOptions[3].nOption = 523; // Make Call

Session.f_oOptions[0].nOptionCS = 931;// Customer Service
Session.f_oOptions[0].nPressCS1 = 310; // Press
Session.f_oOptions[0].nPressCS2 = 1; // 0
}
Server.logInfo("f_oOptions.length: " + Session.f_oOptions.length);

var maxPossibleOptions = Session.f_oOptions.length;

var counter = 1;

if("T" != Session.g_oCC.strRechargableFlag) {
	// Pull each option up
	for (var i = 1; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i+1].nOption;
	}
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
} else {
	counter++
}

if("T" != Session.g_oBALXFER.strBalanceTransferFlag) {
	// Pull each option up	
	for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
} else {
	counter++;
}
/*
if("T" != Session.g_oAPI.strAllowZeroCostFlag) {
	// Pull each option up	
	for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
}
*/

if("T" != Session.g_oACD.strMainMenuZeroOut && Session.g_oAPI.strCustomerServicePhone == "" ) {
	Session.f_oOptions[0].nOptionCS = 99;// Customer Service
	Session.f_oOptions[0].nPressCS1 = 99; // Press
	Session.f_oOptions[0].nPressCS2 = 99; // 0
	// Do not play half second of silence after last option
	Session.f_oOptions[Session.f_oOptions.length - 1].nHalfTenth = 99; 
}

// set options not used to 99 (1/10 silence)
for (var i = Session.f_oOptions.length; i < maxPossibleOptions; i++) {
		Session.f_oOptions[i].nOption = 99;
		Session.f_oOptions[i].nPress = 99;	
		Session.f_oOptions[i].nHalfTenth = 99; 
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=513 y=455 ?>
          <!--call creditCardRecharge()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CreditCardRecharge&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="31" stubbed="0"/>
            <result name="Wait For Message" link="21" stubbed="0" >f_nReturnCode == s_nWAIT_FOR_MESSAGE</result>
          </results>
        </action>
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=516 y=712 ?>
          <!--ProcessCSRAttempt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcessCSRAttempt&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_nPromptHoldForCSR</parameter>
            <parameter >g_nPromptNotAllowed</parameter>
            <parameter >g_oMS</parameter>
            <parameter >s_oCSR_REASONS</parameter>
            <parameter >s_nTIMEOUT</parameter>
          </function>
          <results >
            <result name="Default" link="28" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nStatePriorToCSR: " + Session.g_oAPI.nStatePriorToCSR);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oACD.nCSRRouteReasonCode = Session.g_oACD.nCSRRouteReasonCodeTemp;

if(Session.g_nReturnCode == 1) {
	Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;
} else if(Session.g_nReturnCode == 2) {
	Session.g_nCurrentState = Session.s_nROUTE_TO_CSR;	
} else if(Session.g_nReturnCode == 3) {
	Session.g_nCurrentState = Session.s_nEND_CALL;	
} else if(Session.g_nReturnCode == 0) {
	Session.g_nCurrentState = Session.s_nEND_CALL;
}
]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=734 y=722 ?>
          <!--call Main: route csr-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1216 y=457 ?>
          <!--Main-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="5" stubbed="1"/>
          </results>
        </action>
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=959 y=536 ?>
          <results >
            <result name="Default" link="30" stubbed="0"/>
            <result name="f_bLowBalance" link="24" stubbed="1" >f_bLowBalance == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bLowBalance = false;

// If Zero Cost Call is off, we need to check the balance.  If it is on allow the user to enter a destination regardless of their balance.
if(Session.g_oAPI.strAllowZeroCostFlag == "F") { 

	if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD && Session.g_oSUB.fPrepaidBalance <= Session.g_oCC.fMinPrepaidBalance) {
		Session.f_bLowBalance = true;
	} else if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD && 
	   Session.g_oAPI.fCreditUsed >= Session.g_oAPI.fCreditLimit && 
	   Session.g_oAPI.fCreditLimit > 0) {
		Session.f_bLowBalance = true;
	} else {
		// Balance OK - send to main menu
		Session.g_nCurrentState = Session.s_nSTATE_MAIN_MENU_PRPD_OR_POPD;
	}

} else {
	Session.g_nCurrentState = Session.s_nSTATE_MAIN_MENU_PRPD_OR_POPD;
}	
]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Pactolus.Branch.1" ><?xtml-editor x=250 y=45 ?>
          <results >
            <result name="Default" link="35" stubbed="0"/>
            <result name="bCurrentlyConnected" link="24" stubbed="1" >g_oMS.bCurrentlyConnected == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// If the sesson ends now, it will be for a different reason because user will be prompted for DTMF
Session.g_bOutOfMoney = false;]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=32 y=905 ?>
          <!--HangUpParty-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="14" stubbed="0"/>
          </results>
        </action>
        <action id="35" plug-in="Pactolus.Branch.1" ><?xtml-editor x=484 y=46 ?>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="bAppPropSuppressOnHold" link="10" stubbed="1" >g_oAPI.bSuppressOnHold == true</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnClickToDial" start="1" event="ClickToDial" returns="void" >
      <parameters >
        <parameter name="strSrcIpAddress" type="string" pass="byref"/>
        <parameter name="nPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="strCallingNumber" type="string" pass="byref"/>
        <parameter name="strCalledNumber" type="string" pass="byref"/>
        <parameter name="nTreatmentCode" type="i4" pass="byref"/>
        <parameter name="strServiceProviderCode" type="string" pass="byref"/>
        <parameter name="lServiceProviderId" type="i8" pass="byref"/>
        <parameter name="strPrepaidPinNbr" type="string" pass="byref"/>
        <parameter name="strPostpaidAcctNbr" type="string" pass="byref"/>
        <parameter name="strPostpaidPinNbr" type="string" pass="byref"/>
        <parameter name="strLanguage" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="nReturnCode" type="i4" >-1</var>
        <var name="nClickToDialCode" type="i4" >0</var>
        <var name="strClickToDialStatus" type="string" ></var>
        <var name="strResponse" type="string" ></var>
        <var name="strCode" type="string" ></var>
        <var name="strBlindCallback" type="string" >prompt</var>
        <var name="bBlindCallback" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=14 y=19 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Msg Init or C2D" link="12" stubbed="0" >nTreatmentCode == 0
OR nTreatmentCode == 1</result>
            <result name="IVR Init or AN Init" link="25" stubbed="0" >nTreatmentCode == s_nTREATMENT_CODE_IVR_INIT
OR nTreatmentCode == s_nTREATMENT_CODE_AN_INIT</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bNewCall = false;
Server.logInfo("Start OnClickToDial: Recieved Message!");



Server.logInfo("Session.strCallingNumber is: " + Session.strCallingNumber);



Server.logInfo("Session.strCalledNumber is: " + Session.strCalledNumber);



Server.logInfo("Session.nTreatmentCode is: " + Session.nTreatmentCode);



Server.logInfo("Session.strServiceProviderCode is: " + Session.strServiceProviderCode);



Server.logInfo("Session.lServiceProviderId is: " + Session.lServiceProviderId);



Server.logInfo("Session.strPrepaidPinNbr is: " + Session.strPrepaidPinNbr);



Server.logInfo("Session.strPostpaidAcctNbr is: " + Session.strPostpaidAcctNbr);



Server.logInfo("Session.strPostpaidPinNbr is: " + Session.strPostpaidPinNbr);




if(Session.strCallingNumber.length <= 0 || Session.strCallingNumber == " ") {



	Server.logError("No Callback Number recieved with this message.");



}




Session.g_strC2DCalledNumber = Session.strCalledNumber;



Session.g_strOutdialANumber = Session.strCallingNumber;



Session.g_strC2DSoapIp = Session.strSrcIpAddress;



Session.g_nC2DSoapPort = Session.nPort;



Session.g_strC2DTransactionId = Session.strTransactionId;




js_initAPI(Session.g_oAPI);



Session.g_oAPI.bSuppressOnHold = Session.s_bAppPropSuppressOnHold;



js_initACD(Session.g_oACD);



js_initBALXFER(Session.g_oBALXFER);



js_initCallLeg(Session.g_oCallLegA);



js_initCallLeg(Session.g_oCallLegB);



js_initCC(Session.g_oCC);



js_initMS(Session.g_oMS, Session.s_strMSType);



js_initRATE(Session.g_oCallLegA.oRATE);



js_initSUB(Session.g_oSUB);



js_initMS(Session.g_oMOH, Session.s_strMSType);



js_initMS(Session.g_oConfMS, Session.s_strMSType);



js_initORIG_TYPES(Session.s_oORIG_TYPES);



js_initINITIATION_TYPES(Session.s_oINITIATION_TYPES);




Session.g_oMS.strACDType = Session.s_strACDMediaServerType;



Session.g_oMS.strMOHType = Session.s_strMOHMediaServerType;



Session.g_oConfMS.strACDType = Session.s_strACDMediaServerType;



Session.g_oConfMS.strMOHType = Session.s_strMOHMediaServerType;
Session.g_oAPI.lPlatformSessionStartTime = Server.getUTCTime();



Session.g_oAPI.strServiceProviderCode = Session.strServiceProviderCode;



Session.g_oAPI.lServiceProviderId = Session.lServiceProviderId;

if(Session.strPostpaidAcctNbr.length > 0 && Session.strPostpaidAcctNbr != " ") {



	//This is a postpaid subscriber



	Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID_POPD;



	



	if(Session.s_strBlindCallback != Session.strPostpaidAcctNbr) {



		Session.g_oSUB.strAccountNumber = Session.strPostpaidAcctNbr;



		Session.g_oSUB.strUserPin = Session.strPostpaidAcctNbr + Session.strPostpaidPinNbr;	



	} else if(Session.s_strBlindCallback == Session.strPostpaidAcctNbr && 1 == Session.nTreatmentCode) {



		Server.logInfo("This is a blind postpaid message initiated callback.");



		Session.g_oAPI.bBlindCallback = true;



	}	



} else if(Session.strPrepaidPinNbr.length > 0 && Session.strPrepaidPinNbr != " ") {



	//This is a prepaid subscriber



	Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID_PRPD;



	



	if(Session.s_strBlindCallback != Session.strPrepaidPinNbr) {	



		Session.g_oSUB.strUserPin = Session.strPrepaidPinNbr;



	} else if(Session.s_strBlindCallback == Session.strPrepaidPinNbr && 1 == Session.nTreatmentCode) {



		Server.logInfo("This is a blind prepaid message initiated callback.");



		Session.g_oAPI.bBlindCallback = true;



	}		
} else {



	Server.logError("Prepaid pin and postpaid account number are null. So callingcard.xml could not set the service element id.");



}




var myString = new String (Session.strCallingNumber);



var myArray = myString.split("x");



Session.g_oAPI.strDestinationNumber = myArray[0];



Session.g_oAPI.strOriginationNumber = myArray[0];
// set server contact



if( Server.sipPort != 5060 )



{



 Session.g_strContact = "<sip:" + Session.s_strLocalHost + ":" + Server.sipPort + ">";



}



else



{



	Session.g_strContact = "<sip:" + Session.s_strLocalHost + ">";



}
// added for Sachin



if(0 == Session.nTreatmentCode) {



	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegClickToDialOut;



	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strClickToDial;



} else if(1 == Session.nTreatmentCode) {	



	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegMsgInitiatedCallback;



	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strMessageCallback;



} else if(2 == Session.nTreatmentCode) {



	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegIvrInitiatedCallback;



	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strIvrCallback;



} else if(3 == Session.nTreatmentCode) {

	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegAccessNbrIniatedCallback;
	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strAccessNumCallback;

} else {



	Server.logError("Uknown Treatment Code: " + Session.nTreatmentCode);



}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=760 y=815 ?>
          <!--0-->
          <return xmlns="www.pactolus.com:xtml:application" value="0"/>
        </action>
        <action id="5" plug-in="Standard.EndSession.1" ><?xtml-editor x=1332 y=130 ?></action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=487 y=807 ?>
          <!--send to Main function-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nDIAL_OUT_A_ONLY;



Session.g_oAPI.bALegRatingOn = true;



Server.logInfo("g_oAPI.strCreditLimitFlag: " + Session.g_oAPI.strCreditLimitFlag);

Server.logInfo("g_oAPI.bALegRatingOn: " + Session.g_oAPI.bALegRatingOn);

Server.logInfo("g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);

Server.logInfo("g_oAPI.bALegRatingOn: " + Session.g_oAPI.bALegRatingOn);]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=1124 y=128 ?>
          <!--send JAVA ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "JAVA: initialize session";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=940 y=85 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="9" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="11" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=737 y=138 ?>
          <!--send alert db error-->
          <user-function xmlns="www.pactolus.com:xtml:application" process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"dbase-error"</parameter>
          </user-function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=40 y=193 ?>
          <!--psAPIInitializeSession-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIInitializeSession&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="26" stubbed="0"/>
            <result name="Success" link="23" stubbed="0" >nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");

Server.logInfo("Java InitializeSession returned " + Session.nReturnCode);

Session.g_sMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;

if (Session.nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA INITIALIZE SESSION, EXIT ON: " + Result.name);
	Session.strCode = "480";
	Session.strResponse = "A system error has occurred";	

	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1002; //bad ani
			Session.g_oAPI.nSessionTerminationReason = 9;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 2;
			break;
		case -4:
		        Session.g_nErrorMsgNumber = 1004; //service disable
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -9:
			Session.g_nErrorMsgNumber = 0; // No Available Sessions
			Server.logInfo("No Available Sessions - End Call.");			
			break;		
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {
	if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") {

		Session.g_oACD.strPinZeroOut = "T";
		Session.g_oACD.strLanguageMenuZeroOut = "T";
		Session.g_oACD.strMainMenuZeroOut = "T";					

		if(Session.g_oACD.strCSROnMaxLoginsEnabled == "T" || Session.g_oAPI.strCustomerServicePhone != "") {

			Session.g_oACD.strPinMaxTimeouts = "T";		
			Session.g_oACD.strPinMaxInvalids = "T";
			Session.g_oACD.strMainMenuMaxInvalids = "T";
			Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
		} // end if 
		// Settings Based on Customer

	        Session.g_oACD.strDestMaxInvalids = "F";
		Session.g_oACD.strDestMaxTimeouts = "F";
		Session.g_oACD.strDestZeroOut = "F";		
		Session.g_oACD.strMainMenuMaxTimeouts = "F";
		Session.g_oACD.strLanguageMenuMaxTimeouts = "F";				

	} // end strEnableFlag		

} // end return code
Server.logInfo("g_oACD.strPinZeroOut " + Session.g_oACD.strPinZeroOut);
Server.logInfo("g_oACD.strLanguageMenuZeroOut " + Session.g_oACD.strLanguageMenuZeroOut);
Server.logInfo("g_oACD.strMainMenuZeroOut " + Session.g_oACD.strMainMenuZeroOut);
Server.logInfo("g_oACD.strPinMaxTimeouts " + Session.g_oACD.strPinMaxTimeouts);
Server.logInfo("g_oACD.strPinMaxInvalids " + Session.g_oACD.strPinMaxInvalids);
Server.logInfo("g_oACD.strMainMenuMaxInvalids " + Session.g_oACD.strMainMenuMaxInvalids);
Server.logInfo("g_oACD.strLanguageMenuMaxInvalids " + Session.g_oACD.strLanguageMenuMaxInvalids);
Server.logInfo("g_oACD.strDestMaxInvalids " + Session.g_oACD.strDestMaxInvalids);
Server.logInfo("g_oACD.strDestMaxTimeouts " + Session.g_oACD.strDestMaxTimeouts);
Server.logInfo("g_oACD.strDestZeroOut " + Session.g_oACD.strDestZeroOut);
Server.logInfo("g_oACD.strMainMenuMaxTimeouts " + Session.g_oACD.strMainMenuMaxTimeouts);
Server.logInfo("g_oACD.strLanguageMenuMaxTimeouts " + Session.g_oACD.strLanguageMenuMaxTimeouts);

Session.g_oSUB.strPinLanguage = Session.g_oAPI.strLanguage;
// SET UP POSTPAID SESSION

if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD) {
	Session.g_oAPI.strPostPaidFlag = "T";
	Session.g_oACD.lCSRRequestSkillId = 3;

	if(Session.g_oAPI.bBlindCallback) {

		//Need to get pin. Set up digit map
	        if (0 == Session.g_oAPI.nAccountNumLength) 	{

			Session.g_oSUB.strDigitMapAccountNbr = "(xxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
		} else {
			var temp_digits = "(";

			for (var i = 0; i < Session.g_oAPI.nAccountNumLength; i++) 	{
				temp_digits += "x";
			} // end for
			Session.g_oSUB.strDigitMapAccountNbr = temp_digits + "|x.T|x.#|xx.*|*x)";
		} // end 0 == nAccountNumLength

		if (0 == Session.g_oAPI.nPostpaidPinLength) {
			Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
		} else {
			var temp_digits = "(";
			for (var i = 0; i < Session.g_oAPI.nPostpaidPinLength; i++) 	{
				temp_digits += "x";
			} // end for

			Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";		
		} // end 0 == nPostpaidPinLength
	} else {
		if(Session.strPostpaidAcctNbr.length > 0 && Session.strPostpaidAcctNbr != " ") {	
			//We have the postpaid account number
			Session.g_oSUB.strAccountNumber = Session.strPostpaidAcctNbr;
			Session.g_oSUB.strUserPin = Session.strPostpaidAcctNbr + Session.strPostpaidPinNbr;
		} else {
			Server.logError("Postpaid Account number is null.");
		} // end strPostpaidAcctNbr.length >
	} // end oAPI.bBlindCallback

//SET UP PREPAID SESSION

} else if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD) {
	Session.g_oACD.lCSRRequestSkillId = 1;
	if(Session.g_oAPI.bBlindCallback) {
		if (0 == Session.g_oAPI.nPrepaidPinLength) {
			Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
		} else {
			var temp_digits = "(";
			for (var i = 0; i < Session.g_oAPI.nPrepaidPinLength; i++) 	{
				temp_digits += "x";
			} // end for
			Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
		} // end 0 == oAPI.nPrepaidPinLength
	} else {
		if(Session.strPrepaidPinNbr.length > 0 && Session.strPrepaidPinNbr != " ") {

			//This is a prepaid subscriber
			Session.g_oSUB.strUserPin = Session.strPrepaidPinNbr;
		} else {
			Server.logError("Prepaid Pin is null.");
		}
        } // end oAPI.bBlindCallback
} else {
	Server.logError("Application can't determine is the session is pre or postpaid.");
} // End nServiceElementId == ...

Session.g_oCallLegA.strFrom = js_check_to_strip_oli(Session.g_oAPI.strInfoDigits, Session.g_oAPI.strOlisToStrip, Session.g_oCallLegA.strFrom);

]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=280 y=524 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="27" stubbed="0"/>
            <result name="SUCCESS" link="22" stubbed="0" >nReturnCode == 0
OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");



Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);



Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);



Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);



Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);



Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);



Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);



Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);



Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);



Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);



Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);



Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();
Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{
	// Set default error message
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			Session.strResponse = "The account does not have sufficient funds to make this call.";
			Session.strCode = "414";
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "The account has expired."; 
			Session.strCode = "415"; 
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";			
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022; // restricted origination number
			Session.g_oAPI.nSessionTerminationReason = 18;
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";
			break;					
		case 14:
			Session.g_nErrorMsgNumber = 1022; // restricted session init type
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} 
]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=740 y=611 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="28" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="29" stubbed="0" >nReturnCode == 0
OR nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);

Session.g_oAPI.bALegCallback = true;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0)
{
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			Session.strResponse = "The account does not have sufficient funds to make this call.";
			Session.strCode = "414";
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";			
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";			
			break;		
		case -10:
			Session.g_nErrorMsgNumber = 2002; //occurs if zero cost turned on at service level, but one or more associated rates has an amount greater than 0
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.strResponse = "The account does not have sufficient funds to make this call.";			
			Session.strCode = "414";			
        case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
Session.g_bInitiatedANCallback = true;

Server.logInfo("g_oCallLegA.oRATE.fAlegMeteredRate" + Session.g_oCallLegA.oRATE.fAlegMeteredRate);

]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=519 y=257 ?>
          <!--failure response-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;code&quot;" value="strCode"/>
            <parameter tag="&quot;text&quot;" value="strResponse"/>
          </SOAP>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Sending failure reason: " + Session.strResponse + "(" + Session.strCode + ") to click2dial request") ;]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=754 y=449 ?>
          <!--failure response-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;code&quot;" value="strCode"/>
            <parameter tag="&quot;text&quot;" value="strResponse"/>
          </SOAP>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Sending failure reason: " + Session.strResponse + "(" + Session.strCode + ") to click2dial request") ;]]></script>
          </scripts>
        </action>
        <action id="20" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=1065 y=746 ?>
          <!--failure response-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;code&quot;" value="strCode"/>
            <parameter tag="&quot;text&quot;" value="strResponse"/>
          </SOAP>
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Sending failure reason: " + Session.strResponse + "(" + Session.strCode + ") to click2dial request") ;]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=245 y=861 ?>
          <!--Outdial in progress-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;code&quot;" value="&quot;200&quot;"/>
            <parameter tag="&quot;text&quot;" value="&quot;Outdial in progress&quot;"/>
          </SOAP>
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strClick2DialStatus = "Ringing your phone" ;
Session.g_nClick2DialCode = 180 ;]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=505 y=600 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Treatment Type = " + Session.nTreatmentCode);

if(Session.nTreatmentCode == Session.s_nTREATMENT_CODE_CLICK_TO_DIAL || 
   Session.nTreatmentCode == Session.s_nTREATMENT_CODE_MESSAGE_INIT || 
   Session.nTreatmentCode == Session.s_nTREATMENT_CODE_IVR_INIT || 
   Session.nTreatmentCode == Session.s_nWAIT_FOR_MESSAGE) {
	if(Session.strLanguage.length > 0) {
		Session.g_oAPI.strLanguage = Session.strLanguage;
		Server.logInfo("Overide default access number language and pin level Language. Set language to parameter passed in: " + Session.g_oAPI.strLanguage);
	} else {
		Server.logError("No language passed in. Use deafault access number language or pin level language.");
	}
}]]></script>
          </scripts>
        </action>
        <action id="23" plug-in="Pactolus.Branch.1" ><?xtml-editor x=36 y=327 ?>
          <!--Msg Initiated Callback-->
          <results >
            <result name="Default" link="19" stubbed="1"/>
            <result name="Postpaid" link="24" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD
AND g_oAPI.bBlindCallback == false</result>
            <result name="Prepaid" link="14" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD
AND g_oAPI.bBlindCallback == false</result>
            <result name="Blind MIC" link="29" stubbed="1" >g_oAPI.bBlindCallback == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {
	Server.logError("Error determing prepaid or postpaid call.");
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
} else if(4 == Result.id) {
	Server.logInfo("This is a message initiated callback and the subscriber was not authenticated. Prompt for pin");
}

]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=274 y=359 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="27" stubbed="0"/>
            <result name="Success" link="22" stubbed="0" >nReturnCode == 0

OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{
	// Set default error message
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";			
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";			
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {
	if(Session.g_oAPI.strCreditLimitFlag == "T") {
		Session.g_oAPI.nMaxAllowedSeconds = Session.g_oSUB.nSecsRemaining;
	}
}

js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=237 y=77 ?>
          <!--s_nIVR_CALLBACK_DELAY-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="s_nIVR_CALLBACK_DELAY"/>
          <results >
            <result name="Default" link="12" stubbed="0"/>
          </results>
        </action>
        <action id="26" plug-in="Pactolus.Branch.1" ><?xtml-editor x=283 y=182 ?>
          <!--Send SOAP Msg?-->
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Initialization Type?" link="18" stubbed="0" >g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegClickToDialOut
OR g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegMsgInitiatedCallback</result>
          </results>
        </action>
        <action id="27" plug-in="Pactolus.Branch.1" ><?xtml-editor x=529 y=374 ?>
          <!--Send SOAP Msg?-->
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Initialization Type?" link="19" stubbed="0" >g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegClickToDialOut
OR g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegMsgInitiatedCallback</result>
          </results>
        </action>
        <action id="28" plug-in="Pactolus.Branch.1" ><?xtml-editor x=963 y=588 ?>
          <!--Send SOAP Msg?-->
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Initialization Type?" link="20" stubbed="0" >g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegClickToDialOut
OR g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegMsgInitiatedCallback</result>
          </results>
        </action>
        <action id="29" plug-in="Pactolus.Branch.1" ><?xtml-editor x=29 y=748 ?>
          <!--Send SOAP Msg?-->
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="Initialization Type?" link="21" stubbed="0" >g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegClickToDialOut
OR g_oAPI.strCallInitiationType == s_oINITIATION_TYPES.strALegMsgInitiatedCallback</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnClickToDialQuery" start="3" event="ClickToDialQuery" returns="void" >
      <parameters >
        <parameter name="strSrcAddress" type="string" pass="byref"/>
        <parameter name="nPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=22 y=66 ?>
          <results >
            <result name="Default" link="6" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Start OnClickToDialQuery: Recieved Message!");]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=433 y=86 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="6" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=215 y=247 ?>
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="strSrcAddress" transaction="strTransactionId" message-name="&quot;ClickToDialQueryResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;code&quot;" value="g_nClick2DialCode"/>
            <parameter tag="&quot;text&quot;" value="g_strClick2DialStatus"/>
          </SOAP>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="SingleStageDialing" start="9" event="" returns="i4" >
      <local-vars >
        <var name="nReturnCode" type="i4" >-99</var>
        <var name="bRtpRelayRequested" type="boolean" >0</var>
        <var name="oRtpRelay" type="object" ></var>
        <var name="bProxyFinalNonSuccessResponse" type="boolean" >1</var>
        <var name="nFinalStatus" type="i4" >0</var>
        <var name="bAlegHungUp" type="boolean" >0</var>
        <var name="bConnected" type="boolean" >0</var>
        <var name="nLongNoAnswerTimeout" type="i4" >300</var>
        <var name="strMyDest" type="string" ></var>
        <var name="bTryAlternateSwitch" type="boolean" >0</var>
        <var name="nPromptLowBalance" type="i4" >507</var>
        <var name="strResponse" type="string" ></var>
        <var name="bNormalCase" type="boolean" >0</var>
        <var name="bCustomPrompt" type="boolean" >0</var>
        <var name="f_nMinutesAvailable" type="i4" >0</var>
        <var name="f_nMinutesPrompt" type="i4" >309</var>
        <var name="f_strBillingDate" type="string" ></var>
        <var name="bExhauseted" type="boolean" >0</var>
        <var name="strBucketType" type="string" ></var>
        <var name="nTimeToCutOffWarn" type="i4" >0</var>
        <var name="bCustomCallflow" type="boolean" >0</var>
        <var name="bPlayErrorPrompt" type="boolean" >0</var>
        <var name="nPromptIndex" type="i4" >0</var>
        <var name="strPromptUrl" type="string" ></var>
        <var name="strPromptType" type="string" ></var>
        <var name="nPrecallPrompt" type="i4" >0</var>
        <var name="f_nPromptToPlay2" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=47 y=209 ?>
          <!--psAPIInitializeSession-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIInitializeSession&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success" link="29" stubbed="0" >nReturnCode == s_sSUCCESS</result>
            <result name="No Element ID, No Sessions" link="16" stubbed="1" >(nReturnCode == -7
OR nReturnCode == -9
OR nReturnCode == -10)
AND s_bRedirect == false</result>
            <result name="-7, s_bRedirect" link="42" stubbed="0" >s_bRedirect == true
AND nReturnCode == -7</result>
            <result name="Ani Recognized but inactive" link="46" stubbed="0" >nReturnCode == -10
AND s_bRedirect == true</result>
            <result name="-2, -3, -4" link="16" stubbed="0" >nReturnCode == -2
OR nReturnCode == -3
OR nReturnCode == -4</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegOneStageDialing;
Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strOneStageDialing;

Session.g_oAPI.nServiceElementId = 0;
Session.bExhauseted = false;

]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("InitializeSession returned " + Session.nReturnCode);
Session.g_sMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;
if (Session.nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA INITIALIZE SESSION, EXIT ON: " + Result.name);
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1002; //bad ani
			Session.g_oAPI.nSessionTerminationReason = 9;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 2;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1004; //service disable
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;	
			if ( Session.s_bRedirect ) {
				Session.g_bInvalidAniRedirect = true;
			}
			else if ( "Cablevision" == Session.s_strCustomerCode || "cablevision" == Session.s_strCustomerCode ) {
				Session.g_nPromptToPlay = 1300;
				Session.bCustomPrompt = true;
			}else if ( "TNZI" == Session.s_strCustomerCode || "tnzi" == Session.s_strCustomerCode ) {
				Session.g_nPromptToPlay = 1334;
				Session.bCustomPrompt = true;
			}			
			break;
		case -9:
			Session.g_nErrorMsgNumber = 0; // No Available Sessions
			Server.logInfo("No Available Sessions - End Call.");
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1022; //ani recognized but not active.
			Session.g_oAPI.nSessionTerminationReason = 1;	
			if ( Session.s_bRedirect ) {
				Session.g_bInvalidAniRedirect = true;
			}
		    if ( "Cablevision" == Session.s_strCustomerCode || "cablevision" == Session.s_strCustomerCode ) {
				Session.g_nPromptToPlay = 1299;
				Session.bCustomPrompt = true;
				Session.g_oSUB.nDisabledReasonCode = Session.s_sDISABLED_SUSPENDED;
			}	
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
	
		Session.g_oACD.strPinZeroOut = "T";
		Session.g_oACD.strLanguageMenuZeroOut = "T";
		Session.g_oACD.strMainMenuZeroOut = "T";					
	
		if(Session.g_oACD.strCSROnMaxLoginsEnabled == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
			Session.g_oACD.strPinMaxTimeouts = "T";		
			Session.g_oACD.strPinMaxInvalids = "T";
			Session.g_oACD.strMainMenuMaxInvalids = "T";
			Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
		} // end if 

		// Settings Based on Customer
		Session.g_oACD.strDestMaxInvalids = "F";
		Session.g_oACD.strDestMaxTimeouts = "F";
		Session.g_oACD.strDestZeroOut = "F";		
				
		Session.g_oACD.strMainMenuMaxTimeouts = "F";
		Session.g_oACD.strLanguageMenuMaxTimeouts = "F";				
	} // end strEnableFlag		

} // end return code


Server.logInfo("g_oACD.strPinZeroOut " + Session.g_oACD.strPinZeroOut);
Server.logInfo("g_oACD.strLanguageMenuZeroOut " + Session.g_oACD.strLanguageMenuZeroOut);
Server.logInfo("g_oACD.strMainMenuZeroOut " + Session.g_oACD.strMainMenuZeroOut);
Server.logInfo("g_oACD.strPinMaxTimeouts " + Session.g_oACD.strPinMaxTimeouts);
Server.logInfo("g_oACD.strPinMaxInvalids " + Session.g_oACD.strPinMaxInvalids);
Server.logInfo("g_oACD.strMainMenuMaxInvalids " + Session.g_oACD.strMainMenuMaxInvalids);
Server.logInfo("g_oACD.strLanguageMenuMaxInvalids " + Session.g_oACD.strLanguageMenuMaxInvalids);
Server.logInfo("g_oACD.strDestMaxInvalids " + Session.g_oACD.strDestMaxInvalids);
Server.logInfo("g_oACD.strDestMaxTimeouts " + Session.g_oACD.strDestMaxTimeouts);
Server.logInfo("g_oACD.strDestZeroOut " + Session.g_oACD.strDestZeroOut);
Server.logInfo("g_oACD.strMainMenuMaxTimeouts " + Session.g_oACD.strMainMenuMaxTimeouts);
Server.logInfo("g_oACD.strLanguageMenuMaxTimeouts " + Session.g_oACD.strLanguageMenuMaxTimeouts);
Server.logInfo("g_oSUB.strUserPin: <" + Session.g_oSUB.strUserPin + ">");
Server.logInfo("g_oSUB.strAccountNumber: <" + Session.g_oSUB.strAccountNumber + ">");

Session.g_oSUB.strPinLanguage = Session.g_oAPI.strLanguage;


if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD) {
	Server.logInfo("This is a postpaid session. g_oAPI.nServiceElementId: <" + Session.g_oAPI.nServiceElementId + ">");
	
	Session.g_oAPI.strPostPaidFlag = "T";
	Session.g_oACD.lCSRRequestSkillId = 3;
	
	if (0 == Session.g_oAPI.nAccountNumLength) 	{
		Session.g_oSUB.strDigitMapAccountNbr = "(xxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {
		var temp_digits = "(";
		for (var i = 0; i < Session.g_oAPI.nAccountNumLength; i++) 	{
			temp_digits += "x";
		}
		Session.g_oSUB.strDigitMapAccountNbr = temp_digits + "|x.T|x.#|xx.*|*x)";
	}	
	
	if (0 == Session.g_oAPI.nPostpaidPinLength) {
		Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {
		var temp_digits = "(";
		for (var i = 0; i < Session.g_oAPI.nPostpaidPinLength; i++) 	{
			temp_digits += "x";
		}
		Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
	}
	
	if(Session.g_oSUB.strAccountNumber.length > 0 && Session.g_oSUB.strUserPin.length > 0) {
		Session.g_oAPI.strValidateByANI = "1";
		Session.g_bValidateByANI = true;		
		Session.g_oSUB.strUserPin = Session.g_oSUB.strAccountNumber + Session.g_oSUB.strUserPin;
		Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;
	} else if(Session.g_oSUB.strAccountNumber.length > 0 && Session.g_oSUB.strUserPin.length <= 0) {
		Session.g_oAPI.strValidateByANI = "2";
		Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;		
		Session.g_bGetPinOnly = true;
		// Will need to get pin only
	} else {
		// Will need to get account number and pin
	}

} else if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD) {
	Server.logInfo("This is a prepaid session. g_oAPI.nServiceElementId: <" + Session.g_oAPI.nServiceElementId + ">");
	Session.g_oACD.lCSRRequestSkillId = 1;

	if (0 == Session.g_oAPI.nPrepaidPinLength) {
		Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {
		var temp_digits = "(";
		for (var i = 0; i < Session.g_oAPI.nPrepaidPinLength; i++) 	{
			temp_digits += "x";
		}
		Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
	}


	Session.g_oAPI.strValidateByANI = "0";
	if(Session.g_oSUB.strUserPin.length > 0) {
		Session.g_bValidateByANI = true;
                Session.g_oAPI.strValidateByANI = "1";
	}


} else {
	Server.logError("Service Element Id is unknown. g_oAPI.nServiceElementId: <" + Session.g_oAPI.nServiceElementId + ">");	
}

Session.g_oCallLegA.strFrom = js_check_to_strip_oli(Session.g_oAPI.strInfoDigits, Session.g_oAPI.strOlisToStrip, Session.g_oCallLegA.strFrom);




]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=753 y=110 ?>
          <!--send JAVA ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "JAVA: initialize session";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=521 y=113 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="1" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=292 y=183 ?>
          <!--send alert db error-->
          <user-function xmlns="www.pactolus.com:xtml:application" process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"dbase-error"</parameter>
          </user-function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=521 y=577 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="32" stubbed="0" >bNormalCase == true</result>
            <result name="feature code: check balance" link="64" stubbed="0" >g_oSUB.strFeatureCodeCallType == s_sFEATURE_CHECK_BALANCE</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);


]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if((Session.nReturnCode == 0 || Session.nReturnCode == 1) && Session.g_oSUB.strFeatureCodeCallType != Session.s_sFEATURE_CHECK_BALANCE) {
	Session.bNormalCase = true;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0)
{
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.nReturnCode);
			break;
		case -3:
			if ( "Cablevision" == Session.s_strCustomerCode || "cablevision" == Session.s_strCustomerCode ) {
				Session.g_nPromptToPlay = 513;
				Session.bCustomPrompt = true;
			}
			else {
				Session.g_nErrorMsgNumber = 1007; //restricted dest
				Session.g_oAPI.nSessionTerminationReason = 5;
				Session.g_nPromptToPlay = 513;
			}
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = Session.nPromptLowBalance;
			Session.bExhauseted = true;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 2002; //occurs if zero cost turned on at service level, but one or more associated rates has an amount greater than 0
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;//Session.nPromptLowBalance;
			break;
		case -11:
			Session.g_nErrorMsgNumber = 1007; //Blocked off plan destination
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;//Session.nPromptLowBalance;
			break;		
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}

if ( 0 < Session.g_oSUB.strFeatureCodeCallType.length ) {            
	Server.logInfo("Destination is a feature code: " + Session.g_oSUB.strFeatureCodeCallType);
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=286 y=547 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="SUCCESS" link="4" stubbed="0" >nReturnCode == 0
OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");

Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);

js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();

Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}

Session.g_nPromptToPlay = 0;

if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{
        // Set default error message
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			Session.g_nPromptToPlay = Session.nPromptLowBalance;
			Session.g_oAPI.nSessionTerminationReason = 8;
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022; // restricted origination number
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;					
		case 14:
			Session.g_nErrorMsgNumber = 1022; // restricted session init type
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Standard.EndSession.1" ><?xtml-editor x=1240 y=145 ?></action>
        <action id="12" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=1249 y=272 ?>
          <!--183 session in progress-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >g_oMS.strContent</content>
            <content-type >"application/sdp"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 183 Session Progress"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success" link="15" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[/* Need to create and insert a tag for the 183 responce. Most likely will be non existent.. check anyway */

var myTo = new SipTo(Session.g_oCallLegA.strTo);

if (undefined == myTo.tag)
{
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strTo + ";tag=" + Server.getUTCTime();

}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO RESPONSE 183");]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.MGCPDelete.1" ><?xtml-editor x=1531 y=266 ?>
          <dlcx xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTIMEOUT" returns="" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </dlcx>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO DLCX MS CONNECTION");
else
{
	Server.logInfo("SUCCESS DLCX MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = false;
	Session.g_oMS.strCallId = "";
	Session.g_oMS.strConnectionId = "";
	Session.g_oMS.strEndPoint = "";
	Session.g_oMS.strContent = "";
}]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=1547 y=393 ?>
          <!--s_fSingleStagePrePromptDelay-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="s_fSingleStagePrePromptDelay"/>
          <results >
            <result name="Default" link="28" stubbed="0"/>
            <result name="bCustomPrompt" link="44" stubbed="0" >bCustomPrompt == true</result>
            <result name="Exhausted Primary" link="56" stubbed="1" >strBucketType match "Primary"</result>
            <result name="Exhausted SubBucket !Prim" link="57" stubbed="1" >strBucketType match "Sub"
AND g_nPrimSecUsed &lt; g_nPrimSecBalance</result>
            <result name="Prim Exhaust  !SubBucket" link="56" stubbed="1" >strBucketType match "Sub"
AND g_nPrimSecBalance &gt;= g_nPrimSecBalance</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oSUB.lStoredBalanceId = " + Session.g_oSUB.lStoredBalanceId);

//Server.logInfo("g_oSUB.strPlayBucketExhaustWarning = " + Session.g_oSUB.strPlayBucketExhaustWarning);
Server.logInfo("Session.bPlayErrorPrompt = " + Session.bPlayErrorPrompt); 

Session.strBucketType = "";
if (Session.bExhauseted){
   Session.strBucketType = "Primary";
   if (Session.g_oSUB.lStoredBalanceId > 0){
   		Session.strBucketType = "Sub";
 	}
  
}
Server.logInfo("Bucket type: "+Session.strBucketType);]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Pactolus.MGCPCreate.1" ><?xtml-editor x=988 y=173 ?>
          <!--create endpoint-->
          <crcx xmlns="www.pactolus.com:xtml:media" callid="g_oMS.strCallId" remote-sdp="g_oCallLegA.strContent" mode="send/receive" capability="1" returns="nReturnCode" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" local-sdp="g_oMS.strContent" packetization-period="g_oMS.nPacketizationPeriod" codec="g_oMS.strCodec" timeout="s_nTIMEOUT" local-connection-options="" second-endpoint-id="" telephone-events="1" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </crcx>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success" link="12" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO CREATE MS CONNECTION");
else
{
	Server.logInfo("SUCCESS CREATE MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = true;
	
	if(Session.g_nPromptToPlay == Session.nPromptLowBalance) {
		Session.strResponse = "SIP/2.0 603 Decline";
	} else if(Session.g_nErrorMsgNumber == 1003 || Session.g_nErrorMsgNumber == 1002 || Session.g_nErrorMsgNumber == 1004){
	         Session.strResponse = "SIP/2.0 403 Forbidden";
	         }
	         else{
		          Session.strResponse = "SIP/2.0 500 Server Internal Error";
	        }	
	
	
	
}]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=2130 y=342 ?>
          <!--strResponse-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >strResponse</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="13" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="19" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1500 y=795 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="20" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1018 y=573 ?>
          <!--"ProxyCall_Internal"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProxyCall_Internal&quot;" return="bConnected" external-function="1" library="lib_voip.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >nLongNoAnswerTimeout</parameter>
            <parameter >bRtpRelayRequested</parameter>
            <parameter >oRtpRelay</parameter>
            <parameter >g_oCallLegA.nSessionTimer</parameter>
            <parameter >g_oCallLegA.bRefresher</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].nSessionTimer</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].bRefresher</parameter>
            <parameter >bProxyFinalNonSuccessResponse</parameter>
            <parameter >nFinalStatus</parameter>
            <parameter >bAlegHungUp</parameter>
          </function>
          <results >
            <result name="Default" link="23" stubbed="0"/>
            <result name="bConnected" link="63" stubbed="0" >bConnected == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
js_logInfoCallLeg(Session.g_oCallLegA);

js_logInfoCallLeg(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex]);]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_logInfoCallLeg(Session.g_oCallLegA);

js_logInfoCallLeg(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex]);
js_enable_event();
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bCurrentlyDialing = false ;

if (Session.bConnected)
{
        Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bConnected = true;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered = Server.getUTCTime() ;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].nSetUpTime = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeAnswered - Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContent = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteSdp;
	var myUri = new SipRequestUri(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri);
	Session.g_oAPI.strGWIPEgress = myUri.url.host;
	Session.g_oAPI.nGWPortEgress = myUri.url.port;
	if (myUri.url.dtg != undefined)
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strDestTrunkGroup = myUri.url.dtg;
	Server.logInfo("A AND B ARE CONNECTED.  CALL LEG B INFO: ");
	js_logInfoCallLeg(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex]);

}]]></script>
          </scripts>
        </action>
        <action id="23" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1252 y=568 ?>
          <results >
            <result name="Default" link="27" stubbed="0"/>
            <result name="TryAgain" link="20" stubbed="1" >bTryAlternateSwitch == true</result>
            <result name="A leg connected" link="41" stubbed="0" >bAlegHungUp == false
AND nFinalStatus == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Session.g_bTryAgain IS: " + Session.g_bTryAgain);
Server.logInfo("Session.bAlegHungUp IS: " + Session.bAlegHungUp);
Server.logInfo("Session.nFinalStatus IS: " + Session.nFinalStatus);
if (Session.g_bTryAgain && !Session.bAlegHungUp && Session.nFinalStatus == 0 &&
	0 < Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strBackupRequestUri.length) {

	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri = Session.strMyDest + "@" + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strBackupRequestUri;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri = Session.strMyDest + "@" + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strBackupRequestUri;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCallId = js_CreateUniqueCallId() ;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCSeq = "1 INVITE" ;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bAttemptedToOutdial = true; 
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bCurrentlyDialing = true ;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart = Server.getUTCTime() ;
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bUac = true;
	Session.bTryAlternateSwitch = true;
	
if ( 0 == Session.g_oAPI.strOutboundCIC.length && 0 < Session.s_strOutboundCIC.length ) {
	Session.g_oAPI.strOutboundCIC = Session.s_strOutboundCIC;
}
if ( 0 < Session.g_oAPI.strOutboundCIC.length ) {
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri += ";cic=";
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri += Session.g_oAPI.strOutboundCIC;
}
} else {
	Session.bTryAlternateSwitch = false;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bTryAgain = false;]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=288 y=386 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success" link="4" stubbed="1" >nReturnCode == 0
OR nReturnCode == 2</result>
            <result name="-4 Sub Disabled" link="46" stubbed="0" >nReturnCode == -4
AND s_bAnncDisabled == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{

	// Set default error message
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";

	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";			
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";			
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
js_enable_event();

// Save Primary Balances for determination of Prompt to play to Subscriber.
Session.g_nPrimSecBalance = Session.g_oSUB.nSecondsBalance;
Session.g_nPrimSecUsed = Session.g_oSUB.nSecondsUsed;

Server.logInfo("g_nPrimSecBalance= <" + Session.g_nPrimSecBalance + ">");
Server.logInfo("g_nPrimSecUsed= <" + Session.g_nPrimSecUsed + ">");
]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1775 y=554 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="10" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.bAlegHungUp) {
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1876 y=278 ?>
          <!--PlayPromptAndHangup-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="17" stubbed="0"/>
          </results>
        </action>
        <action id="29" plug-in="Pactolus.Branch.1" ><?xtml-editor x=44 y=430 ?>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Postpaid, ValidateByAni" link="26" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD
AND g_bValidateByANI == true</result>
            <result name="Prepaid, ValidateByAni" link="8" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD
AND g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {
	Server.logError("Error determing prepaid or postpaid call OR Ani was not authorized.");
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
	Session.g_nErrorMsgNumber = 1019; //ani authentication require
	Session.g_oAPI.nSessionTerminationReason = 1;		

}]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=790 y=572 ?>
          <!--InitCallLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;InitCallLeg&quot;" return="" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_nCurrentArrayIndex</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="20" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Session.s_strTestModeFlag == "T")
{
    if(Session.g_oTEST.strTestDestinationNumber.length > 0) {
		Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;
	} else {
		Server.logError("Application is in test mode but no test number exists. Using: " + Session.g_oAPI.strDestinationNumber);
	}			
}										
Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");

Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);

Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oAPI.strDestinationNumber = js_translate_destination_post_rating(Session.s_strCustomerCode, Session.g_oAPI.strDestinationNumber, Session.g_oAPI.strOriginationNumber, Session.g_oAPI.nOrigCountryId, Session.s_strE164_Dialing);
Server.logInfo("AFTER translation dest: " + Session.g_oAPI.strDestinationNumber);

Session.g_oAPI.nRTPClockRate = 8000;

Session.g_oAPI.nRTPEncoding = 0;
var myTo = new String();
if ("T" == Session.s_strPrependSVC)
{
	Session.strMyDest = Session.g_oAPI.strServiceProviderCode + Session.g_oAPI.strDestinationNumber;
	Server.logInfo("AFTER prepend SVC to dest: " + Session.strMyDest);
}
else
{
	Session.strMyDest = Session.g_oAPI.strDestinationNumber;	
}
if(Session.g_oAPI.strPrimaryRouteCode != "" && Session.g_oAPI.strPrimaryRouteCode != undefined) {

	Session.strMyDest = Session.g_oAPI.strPrimaryRouteCode + "" + Session.strMyDest;

}
Server.logInfo("AFTER prepend Route Code: " + Session.strMyDest);
myTo = "<sip:" + Session.strMyDest + "@" + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri + ";user=phone>";

Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCalledNumber = Session.strMyDest;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri = Session.strMyDest + "@" + Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRequestUri;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strTo = myTo;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strOriginalTo = myTo;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom = Session.g_oCallLegA.strFrom;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strContact = Session.g_strContact;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCallId = js_CreateUniqueCallId() ;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strCSeq = "1 INVITE" ;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bAttemptedToOutdial = true; 
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bCurrentlyDialing = true ;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].lTimeStart = Server.getUTCTime() ;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bUac = true;
var nMaxForwards = parseInt(Session.g_oCallLegA.strMaxForwards) - 1;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strMaxForwards = "" + nMaxForwards;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemotePartyId = Session.g_oCallLegA.strRemotePartyId;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strPAssertedIdentity = Session.g_oCallLegA.strPAssertedIdentity;

if ( 0 == Session.g_oAPI.strOutboundCIC.length && 0 < Session.s_strOutboundCIC.length ) {
	Session.g_oAPI.strOutboundCIC = Session.s_strOutboundCIC;
}
if ( 0 < Session.g_oAPI.strOutboundCIC.length ) {
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri += ";cic=";
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strRemoteUri += Session.g_oAPI.strOutboundCIC;
}
if(Session.s_strSuppressCallerId == "T"){
	var from_uri = new SipFrom(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom);
	Server.logInfo("SUPPRESS CALLER ID (set user to 'anonymous')");
	Server.logInfo("BEFORE Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom = "+Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom);
	Server.logInfo("BEFORE from_uri.url.user = "+from_uri.url.user);
	Server.logInfo("BEFORE from_uri.displayName = "+from_uri.displayName);
	from_uri.url.user = "anonymous";
	from_uri.displayName = "";
	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom = from_uri.encode();
	Server.logInfo("AFTER from_uri.url.user = "+from_uri.url.user);
	Server.logInfo("AFTER from_uri.displayName = "+from_uri.displayName);
	Server.logInfo("AFTER Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom = "+Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].strFrom);
}]]></script>
          </scripts>
        </action>
        <action id="31" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1232 y=779 ?>
          <!--SetTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;SetTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimer</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].nSetUpTime</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="19" stubbed="0"/>
            <result name="CutOffTimer &gt; 0" link="58" stubbed="0" >s_nCutOffTimeSeconds &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers
js_initTimer(Session.g_oTimerThreshold1);
js_initTimer(Session.g_oTimerThreshold2);
js_initTimer(Session.g_oTimerThreshold3);
js_initTimer(Session.g_oTimerPhoneA);
js_initTimer(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].oTimer);
js_initTimer(Session.g_oTimerMaxTime);

Session.g_oTimerThreshold1.nThresholdTime = Session.g_oAPI.nWarningThreshold1;
Session.g_oTimerThreshold2.nThresholdTime = Session.g_oAPI.nWarningThreshold2;
Session.g_oTimerThreshold3.nThresholdTime = Session.g_oAPI.nWarningThreshold3;
Session.g_oTimerPhoneA.lSleepTime = Session.g_oCallLegA.initSessionTimer;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].oTimer.lSleepTime = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].nSessionTimer;

if (Session.g_oSUB.nSecondsAvailable > 0)
{
	Session.g_oTimerMaxTime.lSleepTime = Session.g_oSUB.nSecondsAvailable;
}
else if (Session.g_oAPI.nMaxAllowedSeconds > 0)
{
	Session.g_oTimerMaxTime.lSleepTime =  Session.g_oAPI.nMaxAllowedSeconds;
}
else
{
	Session.g_oTimerMaxTime.lSleepTime = 4294967;
	Server.logInfo("INFO: BOTH SECOND AVAILABLE AND MAX ALLOW SECONDS EQUAL ZERO");
}]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Pactolus.Branch.1" ><?xtml-editor x=545 y=740 ?>
          <results >
            <result name="Default" link="30" stubbed="0"/>
            <result name="Play First Use Index" link="33" stubbed="0" >g_oAPI.strPromptFirstUseType == "I"
AND g_oAPI.nPromptFirstUseIndex &gt; 0</result>
            <result name="Play First Use URL" link="33" stubbed="0" >g_oAPI.strPromptFirstUseType == "U"
AND g_oAPI.strPromptFirstUseUrl.length &gt; 0</result>
            <result name="play bucket refill warning" link="33" stubbed="0" >g_oSUB.strPlayBucketRefillWarning match "T"</result>
            <result name="play bucket exhaust warning" link="33" stubbed="0" >g_oSUB.strPlayBucketExhaustWarning match "T"</result>
            <result name="Play Branding Prompt" link="33" stubbed="0" >g_oSUB.bPlayFirstBillCycle == true
OR g_oSUB.bPlayOnPlanMeteredAlert == true
OR g_oSUB.bPlayOffPlanAlert == true</result>
          </results>
        </action>
        <action id="33" plug-in="Pactolus.MGCPCreate.1" ><?xtml-editor x=567 y=893 ?>
          <!--create endpoint-->
          <crcx xmlns="www.pactolus.com:xtml:media" callid="g_oMS.strCallId" remote-sdp="g_oCallLegA.strContent" mode="send/receive" capability="1" returns="nReturnCode" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" local-sdp="g_oMS.strContent" packetization-period="g_oMS.nPacketizationPeriod" codec="g_oMS.strCodec" timeout="s_nTIMEOUT" local-connection-options="" second-endpoint-id="" telephone-events="1" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </crcx>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="Success" link="34" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO CREATE MS CONNECTION");
else
{
	Server.logInfo("SUCCESS CREATE MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = true;
	
	if(Session.g_nPromptToPlay == Session.nPromptLowBalance) {
		Session.strResponse = "SIP/2.0 603 Decline";
	} else {
		Session.strResponse = "SIP/2.0 500 Server Internal Error";
	}	
	
	
	
}]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=574 y=1060 ?>
          <!--183 session in progress-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >g_oMS.strContent</content>
            <content-type >"application/sdp"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 183 Session Progress"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="36" stubbed="0"/>
            <result name="Success" link="59" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[/* Need to create and insert a tag for the 183 responce. Most likely will be non existent.. check anyway */

var myTo = new SipTo(Session.g_oCallLegA.strTo);

if (undefined == myTo.tag)
{
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strTo + ";tag=" + Server.getUTCTime();

}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO RESPONSE 183");]]></script>
          </scripts>
        </action>
        <action id="36" plug-in="Pactolus.MGCPDelete.1" ><?xtml-editor x=817 y=956 ?>
          <dlcx xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTIMEOUT" returns="" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </dlcx>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO DLCX MS CONNECTION");
else
{
	Server.logInfo("SUCCESS DLCX MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = false;
	Session.g_oMS.strCallId = "";
	Session.g_oMS.strConnectionId = "";
	Session.g_oMS.strEndPoint = "";
	Session.g_oMS.strContent = "";
}]]></script>
          </scripts>
        </action>
        <action id="37" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1089 y=1128 ?>
          <!--PlayBrandingPrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptFirstUseType</parameter>
            <parameter >g_oAPI.nPromptFirstUseIndex</parameter>
            <parameter >g_oAPI.strPromptFirstUseUrl</parameter>
          </function>
          <results >
            <result name="Default" link="38" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Check which branding prompt flag has been set 
/*
if(firstUse) {
 Session.PromptIndex = API.nPromptFirstBillCycleIndex;
 Session.PromptUrl = API.strPromptFirstBillCycleUrl;
 Session.PromptType = API.strPromptFirstBillCycle;
 } else if (OffplanMeteredAlert) {
  ..similar
     }else if(.....)   
*/]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.MGCPDelete.1" ><?xtml-editor x=1034 y=906 ?>
          <dlcx xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTIMEOUT" returns="" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </dlcx>
          <results >
            <result name="Default" link="61" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO DLCX MS CONNECTION");
else
{
	Server.logInfo("SUCCESS DLCX MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = false;
	Session.g_oMS.strCallId = "";
	Session.g_oMS.strConnectionId = "";
	Session.g_oMS.strEndPoint = "";
	Session.g_oMS.strContent = "";
}]]></script>
          </scripts>
        </action>
        <action id="39" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=789 y=858 ?>
          <!--FeatureCode_CheckBalance-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;FeatureCode_CheckBalance&quot;" return="" external-function="1" library=""/>
          <results >
            <result name="Default" link="40" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Destination is feature code Check Balance");]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1024 y=757 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="41" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=1526 y=629 ?>
          <!--503 Service Unavailable-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 503 Service Unavailable"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="27" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="42" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=528 y=255 ?>
          <!--403 Forbidden-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 403 Forbidden"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="43" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Unrecognized ANI: " + Session.g_oAPI.strOriginationNumber);

]]></script>
          </scripts>
        </action>
        <action id="43" plug-in="Standard.WaitEvent.1" ><?xtml-editor x=747 y=255 ?>
          <!--wait for ACK-->
          <wait xmlns="www.pactolus.com:xtml:communication" timeout="5" recv-name="" >
            <msg name="Pactolus.EveSipAck.1" >
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
            </msg>
          </wait>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if ( 2 != Result.id ) {
	Server.logInfo("No ACK received for 403 Forbidden!");
}]]></script>
          </scripts>
        </action>
        <action id="44" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1867 y=392 ?>
          <!--Play custom prompt-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >g_nPromptToPlay</audio>
            <audio type="index" >f_nPromptToPlay2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_nPromptToPlay == 1334){
      Session.f_nPromptToPlay2 = 1336;
   } else {
         Session.f_nPromptToPlay2 = 99;
         }]]></script>
          </scripts>
        </action>
        <action id="45" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=758 y=438 ?>
          <!--PlayDisabledAnnc-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayDisabledAnnc&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="10" stubbed="0"/>
          </results>
        </action>
        <action id="46" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=540 y=426 ?>
          <!--DirectCallerToMS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DirectCallerToMS&quot;" return="nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="success" link="45" stubbed="0" >nReturnCode == 0</result>
          </results>
        </action>
        <action id="49" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1091 y=1227 ?>
          <!--play the bucket refill warning-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >376</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >1304</audio>
            <audio type="index" >1329</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1327</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//calculate minutes available
//Session.f_nMinutesAvailable = (Session.g_oSUB.nSecondsBalance - Session.g_oSUB.nSecondsUsed) / 60;
Session.f_nMinutesAvailable = Session.g_oSUB.lMinutesToNextBucketThreshold ;
if ( 0 > Session.f_nMinutesAvailable ) {
	Session.f_nMinutesAvailable = 0;
}

if ( 1 == Session.f_nMinutesAvailable ) {
	Session.f_nMinutesPrompt = 308;
}]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1093 y=1383 ?>
          <!--play the bucket exhaust warning-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >376</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >1304</audio>
            <audio type="index" >1307</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >1308</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//calculate minutes available
//Session.f_nMinutesAvailable = (Session.g_oSUB.nSecondsBalance - Session.g_oSUB.nSecondsUsed) / 60;
Session.f_nMinutesAvailable = Session.g_oSUB.lMinutesToNextBucketThreshold ;

if ( 0 > Session.f_nMinutesAvailable ) {
	Session.f_nMinutesAvailable = 0;
}

if ( 1 == Session.f_nMinutesAvailable ) {
	Session.f_nMinutesPrompt = 308;
}]]></script>
          </scripts>
        </action>
        <action id="51" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1094 y=1533 ?>
          <!--play chime before connecting-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="53" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1282 y=1363 ?>
          <!--play Sub bucket refill warning-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >376</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >1304</audio>
            <audio type="index" >1328</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >1327</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//calculate minutes available
Session.f_nMinutesAvailable = Session.g_oSUB.lMinutesToNextBucketThreshold;
if ( 0 > Session.f_nMinutesAvailable ) {
	Session.f_nMinutesAvailable = 0;
}

if ( 1 == Session.f_nMinutesAvailable ) {
	Session.f_nMinutesPrompt = 308;
}]]></script>
          </scripts>
        </action>
        <action id="54" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1289 y=1535 ?>
          <!--play Sub bucket sxhaust warning-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >376</audio>
            <audio type="number" >f_nMinutesAvailable</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >621</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//calculate minutes available
Session.f_nMinutesAvailable = Session.g_oSUB.lMinutesToNextBucketThreshold;
if ( 0 > Session.f_nMinutesAvailable ) {
	Session.f_nMinutesAvailable = 0;
}

if ( 1 == Session.f_nMinutesAvailable ) {
	Session.f_nMinutesPrompt = 308;
}]]></script>
          </scripts>
        </action>
        <action id="55" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=886 y=1087 ?>
          <!--sleep s_fSingleStagePrePromptDelay-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="s_fSingleStagePrePromptDelay"/>
          <results >
            <result name="Default" link="37" stubbed="0"/>
            <result name="play bucket refill warning prompt" link="49" stubbed="0" >g_oSUB.strPlayBucketRefillWarning match "T"
AND g_oSUB.sPlaySubBucketWarnFlag match "F"</result>
            <result name="play bucket exhaust warning prompt" link="50" stubbed="1" >g_oSUB.strPlayBucketExhaustWarning match "T"
AND g_oSUB.sPlaySubBucketWarnFlag match "F"</result>
            <result name="playSubBucket refill Warning" link="53" stubbed="0" >g_oSUB.sPlaySubBucketWarnFlag match "T"
AND g_oSUB.strPlayBucketRefillWarning match "T"</result>
            <result name="Play SubBucket Exhaust Warning" link="54" stubbed="0" >g_oSUB.strPlayBucketExhaustWarning match "T"
AND g_oSUB.sPlaySubBucketWarnFlag match "T"</result>
            <result name="Play Chime" link="51" stubbed="0" >s_bPlayChime == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Need to read in the SUB.lMinutesToNextBucketThreshold
//Check if subBucket WarnFlag is set and if Exhaustflag is also set to see if this is a Refill or Exhaust.
//if subbucketFlag is set and exhaust is not = play refillwarning for SubBucket using variable above for remaining time
//if subbucketFlag is set and exhaust is also = play Exhaust Warning for SubBucket "" ""
//if subbucket flag is not set and Primary warning flag is set = play play standard warning "" "".
// if SBF is not set and PrimaryEhaust is = play Exhaust for Primary Bucket "" "".

Server.logInfo("g_oSUB.strPlayBucketExhaustWarning = " + Session.g_oSUB.strPlayBucketExhaustWarning);
Server.logInfo("g_oSUB.sPlaySubBucketWarnFlag = " + Session.g_oSUB.sPlaySubBucketWarnFlag);]]></script>
          </scripts>
        </action>
        <action id="56" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1794 y=84 ?>
          <!--bucket exhausted-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >1316</audio>
            <audio type="date" >f_strBillingDate</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//format for date prompt: YYYYMMDD
var today = new Date();
	var month = 0;
	Server.logInfo("Billing cycle date: " + Session.g_oSUB.nBillingCycleDay);
	Server.logInfo("Today's date: " + today.toString());
	Session.f_strBillingDate = today.getFullYear();
	//billing cycle dates cannot be greater than 28
	if ( Session.g_oSUB.nBillingCycleDay > today.getDate() ) {
		//next billing date is in the current month
		 month = today.getMonth() + 1 ;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		 Session.f_strBillingDate += month.toString();
	}
	else {
		//next billing date is next month
		month = today.getMonth() + 2;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		Session.f_strBillingDate += month.toString();
	}
	if ( 10 > Session.g_oSUB.nBillingCycleDay ){
		Session.f_strBillingDate += "0";
	}
	Session.f_strBillingDate += Session.g_oSUB.nBillingCycleDay.toString();
	Server.logInfo("Next billing date: " + Session.f_strBillingDate);]]></script>
          </scripts>
        </action>
        <action id="57" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1999 y=133 ?>
          <!--Subbucket exhausted !Primary-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >619</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >309</audio>
            <audio type="index" >1308</audio>
            <audio type="index" >620</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//format for date prompt: YYYYMMDD
var today = new Date();
	var month = 0;
	Server.logInfo("Billing cycle date: " + Session.g_oSUB.nBillingCycleDay);
	Server.logInfo("Today's date: " + today.toString());
	Session.f_strBillingDate = today.getFullYear();
	//billing cycle dates cannot be greater than 28
	if ( Session.g_oSUB.nBillingCycleDay > today.getDate() ) {
		//next billing date is in the current month
		 month = today.getMonth() + 1 ;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		 Session.f_strBillingDate += month.toString();
	}
	else {
		//next billing date is next month
		month = today.getMonth() + 2;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		Session.f_strBillingDate += month.toString();
	}
	if ( 10 > Session.g_oSUB.nBillingCycleDay ){
		Session.f_strBillingDate += "0";
	}
	Session.f_strBillingDate += Session.g_oSUB.nBillingCycleDay.toString();
	Server.logInfo("Next billing date: " + Session.f_strBillingDate);]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Standard.Timer.1" ><?xtml-editor x=1424 y=860 ?>
          <!--5 seconds until CutOff-->
          <timer xmlns="www.pactolus.com:xtml:application" start="1" id="g_nCutOffTimerId" duration="nTimeToCutOffWarn"/>
          <results >
            <result name="Default" link="19" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Cut off Warning Time set to: <" + Session.s_nCutOffTimeSeconds +">");
Server.logInfo("g_oTimerMaxTime.lSleepTime set to: <" + Session.g_oTimerMaxTime.lSleepTime +">");

// 
Session.nTimeToCutOffWarn = 0;
Server.logInfo("What oSUB seconds Avai is set to: <" + Session.g_oSUB.nSecondsAvailable +">");

Session.nTimeToCutOffWarn = Session.g_oTimerMaxTime.lSleepTime - Session.s_nCutOffTimeSeconds;
           
Server.logInfo("Warning will be played at: <"+ Session.nTimeToCutOffWarn + ">");


]]></script>
          </scripts>
        </action>
        <action id="59" plug-in="Pactolus.Branch.1" ><?xtml-editor x=695 y=1208 ?>
          <!--If onplan metered, offplan metered or firstbillingcycle-->
          <results >
            <result name="Default" link="55" stubbed="0"/>
            <result name="First BillCycle call" link="60" stubbed="0" >g_oSUB.bPlayFirstBillCycle == true
OR g_oSUB.bPlayOnPlanMeteredAlert == true
OR g_oSUB.bPlayOffPlanAlert == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Populate the proper prompt to play.
Session.nPromptIndex = 0;
Session.strPromptType = "";
Session.strPromptUrl = "";
Session.nPrecallPrompt = -1; /* 0 == First call of billing cycle
							   1 == Off plan destination
							   2 == On Plan Metered
							*/

Server.logInfo(" Session.g_oSUB.bPlayFirstBillCycle: " + Session.g_oSUB.bPlayFirstBillCycle);
Server.logInfo(" Session.g_oSUB.bPlayOnPlanMeteredAlert: " + Session.g_oSUB.bPlayOnPlanMeteredAlert);
Server.logInfo(" Session.g_oSUB.bPlayOffPlanAlert: " + Session.g_oSUB.bPlayOffPlanAlert);
if(Session.g_oSUB.bPlayFirstBillCycle){
  Session.nPrecallPrompt = 0;
  Session.nPromptIndex = Session.g_oAPI.nPromptFirstBillCycleIndex;
  Session.strPromptUrl = Session.g_oAPI.strPromptFirstBillCycleUrl;
  Session.strPromptType = Session.g_oAPI.strPromptFirstBillCycle;
  } else if (Session.g_oSUB.bPlayOnPlanMeteredAlert) {
  		 Session.nPrecallPrompt = 2;
         Session.nPromptIndex = Session.g_oAPI.nPromptOnPlanMeteredAlertIndex;
         Session.strPromptUrl = Session.g_oAPI.strPromptOnPlanMeteredAlertUrl;
         Session.strPromptType = Session.g_oAPI.strPromptOnPlanMeteredAlert;
         } else if (Session.g_oSUB.bPlayOffPlanAlert){
         	   Session.nPrecallPrompt = 1;
               Session.nPromptIndex = Session.g_oAPI.nPromptOffPlanAlertIndex;
               Session.strPromptUrl = Session.g_oAPI.strPromptOffPlanAlertUrl;
               Session.strPromptType = Session.g_oAPI.strPromptOffPlanAlert;
               }
   ]]></script>
          </scripts>
        </action>
        <action id="60" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=874 y=1310 ?>
          <!--PlayBrandingPrompt ** Need to make NO BARGE-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPromptNoBarge&quot;" return="nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >strPromptType</parameter>
            <parameter >nPromptIndex</parameter>
            <parameter >strPromptUrl</parameter>
          </function>
          <results >
            <result name="Default" link="55" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo(" Session.nPromptIndex: " + Session.nPromptIndex);
Server.logInfo(" Session.strPromptUrl: " + Session.strPromptUrl);
Server.logInfo(" Session.strPromptType: " + Session.strPromptType);
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.nReturnCode != 0) {
    Server.logError("Error playing Branding prompt. Will not be marked as played")
    Session.nPrecallPrompt = -1;
    Session.g_oSUB.nPrecallPromptSetting = 1; // Setting to "1" to prevent callcompletion setting as played.
    }]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1281 y=944 ?>
          <!--Update Prompt Played Now or at CallComp?-->
          <results >
            <result name="Default" link="30" stubbed="1"/>
            <result name="Update post Play" link="62" stubbed="0" >g_oSUB.nPrecallPromptSetting == 1
AND nPrecallPrompt != -1</result>
          </results>
        </action>
        <action id="62" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1484 y=974 ?>
          <!--Call MarkPrecallPromptAsPlayed-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MarkPrecallPromptAsPlayed&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >nPrecallPrompt</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="30" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (0 != Session.nReturnCode){
	Server.logError(" FAILED TO UPDATE PROMPT PLAYED STATUS !! ");
	}]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1175 y=672 ?>
          <!--SetTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers
var diff = Session.g_oSUB.nSecondsUntilBillingCycle - Server.getUTCTime();
Server.logInfo("there are "+diff+" seconds until next billing cycle");
js_initTimer(diff);
Session.g_oTimerBillingCycle.lSleepTime = diff;
Server.logInfo("setting up billing cycle timer to expire after "+diff+" seconds");]]></script>
          </scripts>
        </action>
        <action id="64" plug-in="Pactolus.Branch.1" ><?xtml-editor x=771 y=671 ?>
          <results >
            <result name="Default" link="65" stubbed="0"/>
            <result name="Customer Code &quot;cablevision&quot;" link="39" stubbed="0" >s_strCustomerCode match "cablevision"</result>
          </results>
        </action>
        <action id="65" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=820 y=784 ?>
          <!--CheckBalance-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CheckBalanceByCustomer&quot;" return="nReturnCode" external-function="1" library="lib_featurecode.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oSTB</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >g_nChimeOrSilence</parameter>
            <parameter >s_strLocalHost</parameter>
            <parameter >s_strCustomerCode</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="0"/>
          </results>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="60" y-coord="27" width="369" height="51" text="OnInvite determine if single stage dialing.  Provide global var for Service Code, ANI, Destination" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="StartALegTimer" start="4" event="" returns="i4" >
      <actions >
        <action id="4" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=20 ?>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="oAPI.bALegRatingOn" link="1" stubbed="0" >g_oAPI.bALegRatingOn == true</result>
          </results>
        </action>
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=18 y=168 ?>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="nSecondsAvailable &gt; 0" link="2" stubbed="0" >g_oSUB.nSecondsAvailable &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oSUB.nSecondsAvailable <= 0) {
	Server.logInfo("g_oSUB.nSecondsAvailable <= 0. No starting timer for A leg.");
} else {
	// Set A leg timer
	js_initTimer(Session.g_oTimerMaxTimeALeg);
	Session.g_oTimerMaxTimeALeg.lSleepTime =  Session.g_oSUB.nSecondsAvailable;
}
]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=215 y=332 ?>
          <!--StartTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=373 y=43 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="AuthenticatePinPrpdOrPopd" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=33 y=138 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="3" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=317 y=344 ?>
          <!--s_nAUTHENTICATE_PIN-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nAUTHENTICATE_PIN"/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=375 y=166 ?>
          <!--s_nSTATE_AUTH_PIN_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_AUTH_PIN_POPD"/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=282 y=75 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="AuthenticatePinPopd" start="95" event="AuthenticatePin" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_fAmountLeft" type="float" >0</var>
      </local-vars>
      <actions >
        <action id="95" plug-in="Pactolus.Branch.1" ><?xtml-editor x=7 y=45 ?>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="Callback" link="96" stubbed="0" >g_oAPI.bANCallbackFlag == true
AND g_oAPI.bCollectPinForCallback == false</result>
          </results>
        </action>
        <action id="15" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1960 y=36 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
        </action>
        <action id="29" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=797 y=631 ?>
          <!--get pin-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_GET_PIN_PRPD_OR_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nTempInt = 0;
Session.g_nNumRetry++;

//Make shared access number false after we determine prepaid/postpaid

Session.g_oAPI.bSharedAccessNumber=false;]]></script>
          </scripts>
        </action>
        <action id="46" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1012 y=38 ?>
          <!--post prompt type?-->
          <results >
            <result name="Default" link="106" stubbed="0"/>
            <result name="g_oAPI.strPostPinPromptType==U" link="47" stubbed="0" >g_oAPI.strPostPinPromptType match "U"</result>
            <result name="PromptType = I &amp;&amp; index &gt; 0" link="71" stubbed="0" >g_oAPI.strPostPinPromptType match "I"
AND g_oAPI.nPostPinPromptIndex &gt; 0</result>
          </results>
        </action>
        <action id="47" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1265 y=183 ?>
          <!--Post Pin Prompt URL-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strPostPinPromptUrl</audio>
          </play>
          <results >
            <result name="Default" link="106" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="71" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1286 y=374 ?>
          <!--Post Pin Prompt index-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nPostPinPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="106" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="73" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=626 y=741 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
        </action>
        <action id="74" plug-in="Standard.EndSession.1" ><?xtml-editor x=1002 y=773 ?></action>
        <action id="75" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=411 y=343 ?>
          <!--play reason prompt-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="76" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=305 y=493 ?>
          <!--invalid pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="78" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="78" plug-in="Pactolus.Branch.1" ><?xtml-editor x=519 y=518 ?>
          <!--max retry-->
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="g_nMaxRetry &lt; g_oAPI.nMaxLoginAttempts" link="29" stubbed="0" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oAPI.nCallTerminationReason = 2;
}]]></script>
          </scripts>
        </action>
        <action id="79" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=260 y=657 ?>
          <!--pin in used or no more mintute-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Low Balance" link="101" stubbed="0" >f_nReturnCode == -11</result>
          </results>
        </action>
        <action id="80" plug-in="Pactolus.Branch.1" ><?xtml-editor x=703 y=123 ?>
          <results >
            <result name="Default" link="46" stubbed="0"/>
            <result name="creditLimitFlag = T" link="81" stubbed="0" >g_oAPI.strCreditLimitFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=916 y=284 ?>
          <!--You have used... ..minutes this month.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="currency" unit="" >f_fAmountLeft</audio>
            <audio type="index" >1297</audio>
          </play>
          <results >
            <result name="Default" link="46" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.strCreditLimitFlag == "T") {
	Session.g_oAPI.nMaxAllowedSeconds = Session.g_oSUB.nSecsRemaining;
}


Session.f_fAmountLeft = Session.g_oAPI.fCreditLimit - Session.g_oAPI.fCreditUsed;]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=20 y=328 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="Success or First Use" link="100" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Hangup" link="75" stubbed="0" >f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -10</result>
            <result name="Get pin again" link="76" stubbed="0" >f_nReturnCode == -3
OR f_nReturnCode == -6
OR f_nReturnCode == -7</result>
            <result name="Pin locked or Low Balance" link="79" stubbed="0" >f_nReturnCode == -5
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			Session.g_nPromptToPlay = 1253;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			Session.g_nPromptToPlay = 506;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;			
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 1253;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			Session.g_nPromptToPlay = 1253;
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.g_nPromptToPlay = 1253;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			Session.g_nPromptToPlay = 1296;
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="94" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=790 y=496 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[

if(Session.g_bGetPinOnly) {
	Session.g_oSUB.strUserPin = "";	
	Session.g_oSUB.strAccountNumber = Session.g_strAuthenticationNbr;
} else {
	Session.g_oSUB.strUserPin = "";
	Session.g_oSUB.strAccountNumber = "";
}	


Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;
Session.g_oAPI.nStatePriorToCSR  = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;	]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=228 y=25 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="97" stubbed="0"/>
            <result name="Success or First Use" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Hangup" >f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -10</result>
            <result name="Get pin again" >f_nReturnCode == -3
OR f_nReturnCode == -6
OR f_nReturnCode == -7</result>
            <result name="Pin locked" >f_nReturnCode == -5
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);


// Default to Auth Dest. If we fail here, we will set this to s_nSTATE_INIT_AN_CALLBACK.
Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK; //The system cannot call you back at this number

	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			Session.g_nPromptToPlay = 1253;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			//Session.g_nPromptToPlay = 506;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			//Session.g_nPromptToPlay = 338;			
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:







			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			//Session.g_nPromptToPlay = 1253;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			//Session.g_nPromptToPlay = 1253;
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			//Session.g_nPromptToPlay = 1253;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			//Session.g_nPromptToPlay = 1296;
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {


	Session.g_nPromptToPlay = Session.s_nPROMPT_CALLBACK; // The system will call you back shortly.

}
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="97" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=449 y=29 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="98" stubbed="0"/>
          </results>
        </action>
        <action id="98" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=686 y=31 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
        </action>
        <action id="99" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=475 y=237 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="110" stubbed="0"/>
          </results>
        </action>
        <action id="100" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=234 y=199 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="Success" link="99" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);
if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Server.logError("FAIL TO GET RECHARGE SETTINGS");
	Session.g_nErrorMsgNumber = 1000; //jvm server error
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="101" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=415 y=852 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="Success" link="102" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);
if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Server.logError("FAIL TO GET RECHARGE SETTINGS");
	Session.g_nErrorMsgNumber = 1000; //jvm server error
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="102" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=594 y=985 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="103" stubbed="0"/>
          </results>
        </action>
        <action id="103" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=817 y=996 ?>
          <!--ProcLowBalance-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcLowBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="105" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bOutOfMoney = true;]]></script>
          </scripts>
        </action>
        <action id="104" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1100 y=995 ?>
          <!--s_nSTATE_MAIN_MENU_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_MAIN_MENU_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nTempInt = 0;
Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
        <action id="105" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=957 y=905 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="106" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1414 y=42 ?>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="oAPI.bBlindCallback" link="107" stubbed="0" >g_oAPI.bBlindCallback == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {



	if(Session.g_oAPI.bCollectPinForCallback) {



		Session.g_nCurrentState = Session.s_nSTATE_CALLBACK_MAINT;



	} else {



		Session.g_nCurrentState = Session.s_nGET_DESTINATION;



	}



}



]]></script>
          </scripts>
        </action>
        <action id="107" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1556 y=160 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="109" stubbed="0" >f_nReturnCode == 0



OR f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination for A Leg *********");



Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);



Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);



Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);



Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);



Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);



Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);



Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);



Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);



Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);



Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);



Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);



Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);



Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);



Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);



Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);
Session.g_bALegRatingOn = true;



Session.g_oAPI.bALegCallback = true;	]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("AuthorizeDest for A Leg returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
		        break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
		        Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} 
Server.logInfo("g_oCallLegA.oRATE.fAlegMeteredRate" + Session.g_oCallLegA.oRATE.fAlegMeteredRate);
]]></script>
          </scripts>
        </action>
        <action id="108" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1951 y=417 ?>
          <!--StartALegTimer-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartALegTimer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="nSecondsAvailable &gt; 0" link="15" stubbed="0" >g_oSUB.nSecondsAvailable &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[

Server.logInfo("Need to recalculate time available from A leg.");
Server.logInfo("Original Max A Leg Time Allowed: " + Session.g_oSUB.nSecondsAvailable);

var lALegTimeInSeconds = Server.getUTCTime() - Session.g_oCallLegA.lTimeAnswered;
Server.logInfo("A Leg has been up for <"+lALegTimeInSeconds+">. Need to subtract this from the time available from the A leg.");

Session.g_oSUB.nSecondsAvailable = Session.g_oSUB.nSecondsAvailable - lALegTimeInSeconds;

Server.logInfo("New Max A Leg Time Allowed: " + Session.g_oSUB.nSecondsAvailable);
if(Session.g_oSUB.nSecondsAvailable <= 0) { 
	Server.logInfo("No more A leg time availabe after the sub was authenticated and callback number authorized.");
}]]></script>
          </scripts>
        </action>
        <action id="109" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1677 y=318 ?>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="creditLimitFlag = T" link="108" stubbed="0" >g_oAPI.strCreditLimitFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_strC2DCalledNumber.length > 0) {
	Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;
	Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
} else {
	Session.g_nCurrentState = Session.s_nGET_DESTINATION;
}]]></script>
          </scripts>
        </action>
        <action id="110" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=478 y=118 ?>
          <!--PlayBrandingPrompt-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayBrandingPrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strPromptFirstUseType</parameter>
            <parameter >g_oAPI.nPromptFirstUseIndex</parameter>
            <parameter >g_oAPI.strPromptFirstUseUrl</parameter>
          </function>
          <results >
            <result name="Default" link="80" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="GetPinNumberPopd" start="42" event="GetPinNumber" returns="i4" >
      <local-vars >
        <var name="f_strAcctNumber" type="string" ></var>
        <var name="f_strPinNumber" type="string" ></var>
        <var name="f_bNullString" type="boolean" >0</var>
        <var name="f_bCallCSR" type="boolean" >0</var>
        <var name="f_bIsValid" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_nReturnCode" type="i4" >-1</var>
        <var name="f_nTimeout" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="42" plug-in="Pactolus.Branch.1" ><?xtml-editor x=11 y=201 ?>
          <!--g_oAPI.strWelcomePromptType = U or I-->
          <results >
            <result name="Default" link="87" stubbed="0"/>
            <result name="WelcomePromptType = U" link="43" stubbed="0" >g_oAPI.strWelcomePromptType match "U"
AND g_bFirstTry == true</result>
            <result name="WelcomePromptType = I, &gt; 0" link="40" stubbed="0" >g_oAPI.strWelcomePromptType match "I"
AND g_bFirstTry == true
AND g_oAPI.nWelcomePromptIndex &gt; 0</result>
            <result name="Shared Access Number, prompt for pin" link="58" stubbed="0" >g_oAPI.bSharedAccessNumber == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_nErrorMsgNumber = 0;


if(Session.g_oACD.strPinZeroOut == "T" && Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strTwoStageDialing) {
	if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
		Server.logInfo("Special case: Farsi language");
		Session.f_oCSRPrompts.nOR = 362;
		Session.f_oCSRPrompts.nPRESS = 931;  //for op
		Session.f_oCSRPrompts.nZERO = 3870;  //press 0
		Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
	}
	else {
	Session.f_oCSRPrompts.nOR = 362;
	Session.f_oCSRPrompts.nPRESS = 310;
	Session.f_oCSRPrompts.nZERO = 1;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
	}
} else {
	Session.f_oCSRPrompts.nOR = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.g_bFirstTry)
{
	Session.g_bFirstTry = false;
}]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=500 y=122 ?>
          <!--506: Please enter your card number.-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strDigitMapAccountNbr" language="g_oAPI.strLanguage" digits="f_strAcctNumber" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >1290</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="68" stubbed="0"/>
            <result name="Success" link="38" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="38" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;

Session.f_nTimeout = Session.s_nGetPostPaidAcctNbrTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1465 y=576 ?>
          <!--s_nSTATE_AUTH_PIN_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_AUTH_PIN_POPD"/>
        </action>
        <action id="38" plug-in="Pactolus.Branch.1" ><?xtml-editor x=33 y=661 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="65" stubbed="0"/>
            <result name="misdial" link="18" stubbed="1" >f_bMissDial == true</result>
            <result name="zero to CSR" link="99" stubbed="1" >f_bCallCSR == true</result>
            <result name="invalid" link="103" stubbed="0" >f_bIsValid == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ("0" == Session.f_strAcctNumber) {
	
	Session.f_bCallCSR = true;
	Session.g_nNumRetry++;

} else if(Session.f_strAcctNumber.length <= 0) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 552; // I did not hear a response

} else if (Session.f_strAcctNumber.length <= 1 || "*" == Session.f_strAcctNumber) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
	
} else if ("*" == Session.g_strTerminationDigit) {

	Session.f_bMissDial = true;
	
} else if (Session.f_strAcctNumber.length < 10) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
	
} else {
	Session.f_bIsValid = true;
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_strTerminationDigit = "";]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=275 y=458 ?>
          <!--Welcome prompt Index-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxx|x.T|x.#|x.*)&quot;" language="g_oAPI.strLanguage" digits="f_strAcctNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nWelcomePromptIndex</audio>
            <audio type="index" >1290</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="38" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;

Session.f_nTimeout = Session.s_nGetPostPaidAcctNbrTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="43" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=271 y=275 ?>
          <!--Welcome prompt URL-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxx|x.T|x.#|x.*)&quot;" language="g_oAPI.strLanguage" digits="f_strAcctNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strWelcomePromptUrl</audio>
            <audio type="index" >1290</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="38" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;

Session.f_nTimeout = Session.s_nGetPostPaidAcctNbrTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=544 y=613 ?>
          <!--579: Please enter your pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="f_strPinNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >579</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="68" stubbed="1"/>
            <result name="Success" link="60" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="60" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strPinNumber = "";

Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;

Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout ) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="60" plug-in="Pactolus.Branch.1" ><?xtml-editor x=767 y=611 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="66" stubbed="0"/>
            <result name="misdial" link="58" stubbed="1" >f_bMissDial == true</result>
            <result name="zero to CSR" link="99" stubbed="1" >f_bCallCSR == true</result>
            <result name="invalid" link="102" stubbed="0" >f_bIsValid == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ("0" == Session.f_strPinNumber) {
	Session.f_bCallCSR = true;
	Session.g_nNumRetry++;	
} else if(Session.f_strPinNumber.length <= 0) {
	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 552; // I did not hear a response
} else if (Session.f_strPinNumber.length <= 1 || "*" == Session.f_strPinNumber) {
	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
} else if ("*" == Session.g_strTerminationDigit) {
	Session.f_bMissDial = true;
} else {
	Session.f_bIsValid = true;
}]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1250 y=576 ?>
          <!--concatenate account+pin-->
          <results >
            <result name="Default" link="21" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_bGetPinOnly || Session.g_oAPI.bSharedAccessNumber) {
	Session.g_oSUB.strUserPin = Session.g_strAuthenticationNbr + Session.f_strPinNumber;	
} else {
	Session.g_oSUB.strUserPin = Session.f_strAcctNumber + Session.f_strPinNumber;
}	

	]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=996 y=122 ?>
          <!--send ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="75" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: play get account number";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="65" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=292 y=615 ?>
          <!--0.5 sec-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="0.5"/>
          <results >
            <result name="Default" link="58" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="66" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=1028 y=579 ?>
          <!--0.5 sec-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="0.5"/>
          <results >
            <result name="Default" link="61" stubbed="0"/>
          </results>
        </action>
        <action id="68" plug-in="Pactolus.Branch.1" ><?xtml-editor x=745 y=123 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="75" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="63" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 12;]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1206 y=121 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="0"/>
          </results>
        </action>
        <action id="76" plug-in="Standard.EndSession.1" ><?xtml-editor x=1408 y=119 ?></action>
        <action id="87" plug-in="Pactolus.Branch.1" ><?xtml-editor x=273 y=117 ?>
          <!--get pin only?-->
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="g_bGetPinOnly == true" link="58" stubbed="1" >g_bGetPinOnly == true</result>
          </results>
        </action>
        <action id="99" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=28 y=960 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.f_bCallCSR) {
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinZeroOut;
} else {
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;	
}

Session.g_oAPI.nStatePriorToCSR  = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;	

Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;



if(Session.g_bGetPinOnly) {
	Session.g_oSUB.strUserPin = "";	
	Session.g_oSUB.strAccountNumber = Session.g_strAuthenticationNbr;
} else {
	Session.g_oSUB.strUserPin = "";
	Session.g_oSUB.strAccountNumber = "";
}	]]></script>
          </scripts>
        </action>
        <action id="102" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1047 y=715 ?>
          <!--invalid pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="99" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="try again" link="58" stubbed="1" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
        <action id="103" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=318 y=775 ?>
          <!--invalid pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="99" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="try again" link="18" stubbed="1" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetPinNumberPrpdOrPopd" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=83 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="3" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=304 y=289 ?>
          <!--s_nGET_PIN-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_PIN"/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=362 y=111 ?>
          <!--s_nSTATE_GET_PIN_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_GET_PIN_POPD"/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=269 y=20 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="MainMenuPopd" start="22" event="MainMenu" returns="i4" >
      <local-vars >
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nCounter" type="i4" >0</var>
        <var name="f_nPACMaxAttempts" type="i4" >2</var>
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_strCallbackNumber" type="string" ></var>
        <var name="f_strSoapIp" type="string" ></var>
        <var name="f_strTransactionId" type="string" ></var>
        <var name="f_bValidCallbackNbr" type="boolean" >0</var>
        <var name="f_nSoapPort" type="i4" >0</var>
        <var name="f_oCallBackPrompts" type="object" ></var>
        <var name="f_oRechargePrompts" type="object" ></var>
        <var name="f_oDirectCallPrompts" type="object" ></var>
      </local-vars>
      <actions >
        <action id="22" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=27 y=293 ?>
          <!--Main menu-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigitCollected" retry-count="f_nPACMaxAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >311</audio>
            <audio type="index" >1263</audio>
            <audio type="index" >s_nHalfSecSilence</audio>
            <audio type="index" >312</audio>
            <audio type="index" >1254</audio>
            <audio type="index" >s_nHalfSecSilence</audio>
            <audio type="index" >313</audio>
            <audio type="index" >523</audio>
            <audio type="index" >f_oCallBackPrompts.nSILENCE</audio>
            <audio type="index" >f_oCallBackPrompts.nPRESS</audio>
            <audio type="index" >f_oCallBackPrompts.nFOR_CALLBACK</audio>
            <audio type="index" >f_oRechargePrompts.nSILENCE</audio>
            <audio type="index" >f_oRechargePrompts.nPRESS</audio>
            <audio type="index" >f_oRechargePrompts.nFOR_RECHARGE</audio>
            <audio type="index" >f_oDirectCallPrompts.nSILENCE</audio>
            <audio type="index" >f_oDirectCallPrompts.nPRESS</audio>
            <audio type="index" >f_oDirectCallPrompts.nFOR_DIRECT_CALL</audio>
            <audio type="index" >f_oCSRPrompts.nSILENCE</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="83" stubbed="0"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="100" stubbed="0"/>
            <result name="Review Speed Dial" link="68" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "1"</result>
            <result name="Add Speed Dial" link="23" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "2"</result>
            <result name="Get Dest" link="11" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "3"</result>
            <result name="Cust Service" link="97" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "0"</result>
            <result name="Callback" link="109" stubbed="0" >g_strDigitCollected match "4"
AND g_oAPI.bIVRCallbackAllowed == true</result>
            <result name="Recharge" link="106" stubbed="0" >((g_strDigitCollected match "5"
AND g_oAPI.bIVRCallbackAllowed == true)
OR (g_strDigitCollected match "4"
AND g_oAPI.bIVRCallbackAllowed == false))
AND g_oCC.strRechargableFlag == "T"</result>
            <result name="Easy Call Main Menu" link="110" stubbed="0" >((g_strDigitCollected match "6"
AND g_oAPI.bIVRCallbackAllowed == true
AND g_oCC.strRechargableFlag == "T")
OR (g_strDigitCollected match "5"
AND g_oAPI.bIVRCallbackAllowed == true
AND g_oCC.strRechargableFlag == "F")
OR (g_strDigitCollected match "5"
AND g_oAPI.bIVRCallbackAllowed == false
AND g_oCC.strRechargableFlag == "T")
OR (g_strDigitCollected match "4"
AND g_oAPI.bIVRCallbackAllowed == false
AND g_oCC.strRechargableFlag == "F"))
AND g_oAPI.bSvcDirectCallFlag == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigitCollected = "";

if(Session.g_oACD.strMainMenuZeroOut == "T") {
   if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
		Session.f_oCSRPrompts.nSILENCE = Session.s_nHalfSecSilence;	
		Session.f_oCSRPrompts.nPRESS = 931;  //for op
		Session.f_oCSRPrompts.nZERO = 3870;  //press 0
		Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
	}
	else {
	Session.f_oCSRPrompts.nSILENCE = Session.s_nHalfSecSilence;	
	Session.f_oCSRPrompts.nPRESS = 310;                  // Press 0
	Session.f_oCSRPrompts.nZERO = 1;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
  } 
}  
else {
	Session.f_oCSRPrompts.nSILENCE = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}


Session.f_oRechargePrompts.nSILENCE = 99;
Session.f_oRechargePrompts.nPRESS = 99;
Session.f_oRechargePrompts.nFOR_RECHARGE = 99;



if (Session.g_oAPI.strLanguage == "fas" || Session.g_oAPI.strLanguage == "per" || Session.g_oAPI.strLanguage == "fa1")  {
	Server.logInfo("Special case: Farsi language");
	if(Session.g_oAPI.bIVRCallbackAllowed) {
		Session.f_oCallBackPrompts.nSILENCE = Session.s_nHalfSecSilence;
		Session.f_oCallBackPrompts.nPRESS = 281;              // Press 4 ... Callback
		Session.f_oCallBackPrompts.nFOR_CALLBACK = 314;       
	
		if("T" == Session.g_oCC.strRechargableFlag) {
			Session.f_oRechargePrompts.nSILENCE = Session.s_nHalfSecSilence;
			Session.f_oRechargePrompts.nPRESS = 519;          // Press 5 ... Recharge
			Session.f_oRechargePrompts.nFOR_RECHARGE = 315;
		
			if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 		    	 Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
			     Session.f_oDirectCallPrompts.nPRESS = 606;        // Press 6 ... Direct Call
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 316; 
			} 
			else {
			     Session.f_oDirectCallPrompts.nSILENCE = 99;
			     Session.f_oDirectCallPrompts.nPRESS = 99;
		    	 Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}      
		}
		else {
			if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 			    Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
			    Session.f_oDirectCallPrompts.nPRESS = 606;        // Press 5 ... Direct Call
		    	Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 315;
			} 
			else {
		     Session.f_oDirectCallPrompts.nSILENCE = 99;
		     Session.f_oDirectCallPrompts.nPRESS = 99;
		     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}   
		}	 	
	} 
	else {
		Session.f_oCallBackPrompts.nSILENCE = 99;
		Session.f_oCallBackPrompts.nPRESS = 99;
		Session.f_oCallBackPrompts.nFOR_CALLBACK = 99;
	
		if("T" == Session.g_oCC.strRechargableFlag) {
			Session.f_oRechargePrompts.nSILENCE = Session.s_nHalfSecSilence;
			Session.f_oRechargePrompts.nPRESS = 519;           // Press 4 ... Recharge
			Session.f_oRechargePrompts.nFOR_RECHARGE = 314;
		
	    	if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 		    	 Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
		 	     Session.f_oDirectCallPrompts.nPRESS = 606;         // Press 5 ... Direct Call
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 315;
			} else {
		    	 Session.f_oDirectCallPrompts.nSILENCE = 99;
			     Session.f_oDirectCallPrompts.nPRESS = 99;
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}  
		} 
		else {
		  	if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 	    	     Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
		    	 Session.f_oDirectCallPrompts.nPRESS = 606;         // Press 4 ... Direct Call
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 314;
			} 
			else {
		    	Session.f_oDirectCallPrompts.nSILENCE = 99;
				Session.f_oDirectCallPrompts.nPRESS = 99;
				Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}  
	    }
	}
} //end Farsi
 else {

	if(Session.g_oAPI.bIVRCallbackAllowed) {
		Session.f_oCallBackPrompts.nSILENCE = Session.s_nHalfSecSilence;
		Session.f_oCallBackPrompts.nPRESS = 314;              // Press 4 ... Callback
		Session.f_oCallBackPrompts.nFOR_CALLBACK = 281;       
	
		if("T" == Session.g_oCC.strRechargableFlag) {
			Session.f_oRechargePrompts.nSILENCE = Session.s_nHalfSecSilence;
			Session.f_oRechargePrompts.nPRESS = 315;          // Press 5 ... Recharge
			Session.f_oRechargePrompts.nFOR_RECHARGE = 519;
		
			if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 		    	 Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
			     Session.f_oDirectCallPrompts.nPRESS = 316;        // Press 6 ... Direct Call
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 606; 
			} 
			else {
			     Session.f_oDirectCallPrompts.nSILENCE = 99;
			     Session.f_oDirectCallPrompts.nPRESS = 99;
		    	 Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}      
		}
		else {
			if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 			    Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
			    Session.f_oDirectCallPrompts.nPRESS = 315;        // Press 5 ... Direct Call
		    	Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 606;
			} 
			else {
		     Session.f_oDirectCallPrompts.nSILENCE = 99;
		     Session.f_oDirectCallPrompts.nPRESS = 99;
		     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}   
		}	 	
	} 
	else {
		Session.f_oCallBackPrompts.nSILENCE = 99;
		Session.f_oCallBackPrompts.nPRESS = 99;
		Session.f_oCallBackPrompts.nFOR_CALLBACK = 99;
	
		if("T" == Session.g_oCC.strRechargableFlag) {
			Session.f_oRechargePrompts.nSILENCE = Session.s_nHalfSecSilence;
			Session.f_oRechargePrompts.nPRESS = 314;           // Press 4 ... Recharge
			Session.f_oRechargePrompts.nFOR_RECHARGE = 519;
		
	    	if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 		    	 Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
		 	     Session.f_oDirectCallPrompts.nPRESS = 315;         // Press 5 ... Direct Call
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 606;
			} else {
		    	 Session.f_oDirectCallPrompts.nSILENCE = 99;
			     Session.f_oDirectCallPrompts.nPRESS = 99;
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}  
		} 
		else {
		  	if ( Session.g_oAPI.bSvcDirectCallFlag == true ) {
 	    	     Session.f_oDirectCallPrompts.nSILENCE = Session.s_nHalfSecSilence;
		    	 Session.f_oDirectCallPrompts.nPRESS = 314;         // Press 4 ... Direct Call
			     Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 606;
			} 
			else {
		    	Session.f_oDirectCallPrompts.nSILENCE = 99;
				Session.f_oDirectCallPrompts.nPRESS = 99;
				Session.f_oDirectCallPrompts.nFOR_DIRECT_CALL = 99; 
			}  
	    }
	}
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=296 y=727 ?>
          <!--return GET_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nGET_DESTINATION"/>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=287 y=611 ?>
          <!--call AddSpeedDial()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;AddSpeedDial&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSERVICE_ELEMENT_ID_POPD</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >s_strStripLeadingOne</parameter>
          </function>
          <results >
            <result name="Default" link="61" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="47" plug-in="Pactolus.Branch.1" ><?xtml-editor x=554 y=214 ?>
          <!--invalid choice-->
          <results >
            <result name="Default" link="22" stubbed="1"/>
            <result name="Too many tries" link="90" stubbed="0" >f_nNumTries &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
}]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.Branch.1" ><?xtml-editor x=518 y=549 ?>
          <!--end call? failure?-->
          <results >
            <result name="Default" link="22" stubbed="1"/>
            <result name="Failure" link="63" stubbed="0" >f_nReturnCode == s_sFAILURE</result>
            <result name="AuthorizeDest" link="66" stubbed="0" >f_nReturnCode == s_nAUTHORIZE_DESTINATION</result>
            <result name="End Call" link="82" stubbed="0" >f_nReturnCode == s_nEND_CALL</result>
            <result name="Get Dest" link="11" stubbed="1" >f_nReturnCode == s_nGET_DESTINATION</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries = 0;]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=777 y=450 ?>
          <!--sorry, transaction can't be completed-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >363</audio>
          </play>
          <results >
            <result name="Default" link="11" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="66" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=791 y=649 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nAUTHORIZE_DESTINATION"/>
        </action>
        <action id="68" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=282 y=505 ?>
          <!--ReviewSpeedDial-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReviewSpeedDials&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSERVICE_ELEMENT_ID_POPD</parameter>
            <parameter >s_strStripLeadingOne</parameter>
          </function>
          <results >
            <result name="Default" link="61" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.EndSession.1" ><?xtml-editor x=781 y=791 ?></action>
        <action id="83" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=283 y=212 ?>
          <!--invalid choice-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="47" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="90" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=798 y=300 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="97" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nEND_CALL;]]></script>
          </scripts>
        </action>
        <action id="97" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=293 y=837 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_MAIN_MENU_POPD;
Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuZeroOut;
]]></script>
          </scripts>
        </action>
        <action id="100" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=269 y=376 ?>
          <!--552-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >552</audio>
          </play>
          <results >
            <result name="Default" link="90" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="105" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=369 y=1234 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="106" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=125 y=1130 ?>
          <!--call creditCardRecharge()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CreditCardRecharge&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="22" stubbed="1"/>
            <result name="Wait For Message" link="105" stubbed="0" >f_nReturnCode == s_nWAIT_FOR_MESSAGE</result>
          </results>
        </action>
        <action id="109" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=291 y=988 ?>
          <!--CallbackMaint-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CallbackMaint&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="22" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries = 0;]]></script>
          </scripts>
        </action>
        <action id="110" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=234 y=82 ?>
          <!--PlayDirectCallMainMenu-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayDirectCallMainMenu&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="22" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strDirectCallDigitMap = Session.s_strOutdialDigitMap;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="MainMenuPrpdOrPopd" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=83 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="3" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=304 y=289 ?>
          <!--s_nMAIN_MENU-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nMAIN_MENU"/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=362 y=111 ?>
          <!--s_nSTATE_MAIN_MENU_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_MAIN_MENU_POPD"/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=269 y=20 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="CallbackMaint" start="1" event="" returns="i4" >
      <local-vars >
        <var name="f_strSoapIp" type="string" ></var>
        <var name="f_nSoapPort" type="i4" >0</var>
        <var name="f_strTransactionId" type="string" ></var>
        <var name="f_strCallbackNumber" type="string" ></var>
        <var name="f_bValidCallbackNbr" type="boolean" >0</var>
        <var name="f_nTreatment" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=20 y=20 ?>
          <!--"IVRCallbackSettings"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;IVRCallbackSettings&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="0: Success" link="6" stubbed="0" >g_nReturnCode == 0</result>
            <result name="1: Init Callback" link="3" stubbed="0" >g_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=389 y=692 ?>
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="&quot;ClickToDial&quot;" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="" value="f_strSoapIp"/>
            <parameter tag="" value="f_nSoapPort"/>
            <parameter tag="" value="f_strTransactionId"/>
            <parameter tag="" value="f_strCallbackNumber"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="f_nTreatment"/>
            <parameter tag="" value="g_oAPI.strServiceProviderCode"/>
            <parameter tag="" value="g_oAPI.lServiceProviderId"/>
            <parameter tag="" value="g_oSUB.strUserPin"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="g_oAPI.strLanguage"/>
          </SOAP>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 2) {
	Server.logError("Error sending soap message to initiate a callback from the Main Menu. Exit on: " + Result.name);
} ]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=42 y=215 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="f_bValidCallbackNbr" link="8" stubbed="0" >f_bValidCallbackNbr == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strSoapIp = Server.soapAddress;
Session.f_nSoapPort = Server.soapPort;
Session.f_strTransactionId = Server.getUTCTime();

Session.f_bValidCallbackNbr = false;

if(Session.g_oSUB.strCallbackNumber.length > 0 && Session.g_oSUB.bCallbackNumberEnable) {
	Session.f_strCallbackNumber = Session.g_oSUB.strCallbackNumber;
	Session.f_bValidCallbackNbr = true;
} else if(Session.g_oAPI.strOriginationNumber == Session.s_strDEFAULT_ANI) {	
	Server.logInfo("WARNING: Callback Number is empty or disabled. ANI equals default ANI. System will not call user back.");
} else if(Session.g_oAPI.strOriginationNumber.length > 0) {
	Session.f_strCallbackNumber = Session.g_oAPI.strOriginationNumber;
	Server.logInfo("Callback Number is empty or disabled. ANI will be used for callback.");	
	Session.f_bValidCallbackNbr = true;	
} else {
	Server.logInfo("WARNING: Callback Number is empty or disabled. ANI is empty. System will not call user back.");	
}
]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.EndSession.1" ><?xtml-editor x=684 y=200 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=372 y=158 ?>
          <!--s_nSTATE_MAIN_MENU_PRPD_OR_POPD-->
          <return xmlns="www.pactolus.com:xtml:application" value="s_nSTATE_MAIN_MENU_PRPD_OR_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=401 y=17 ?>
          <!--"PlayPromptAndHangup"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.Branch.1" ><?xtml-editor x=247 y=442 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="9" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nTreatment = Session.g_oAPI.bANCallbackFlag ? Session.s_nTREATMENT_CODE_AN_INIT : Session.s_nTREATMENT_CODE_IVR_INIT;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {
	Server.logError("Error determing if prepaid or postpaid call.");
}]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=477 y=541 ?>
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="&quot;ClickToDial&quot;" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="" value="f_strSoapIp"/>
            <parameter tag="" value="f_nSoapPort"/>
            <parameter tag="" value="f_strTransactionId"/>
            <parameter tag="" value="f_strCallbackNumber"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="f_nTreatment"/>
            <parameter tag="" value="g_oAPI.strServiceProviderCode"/>
            <parameter tag="" value="g_oAPI.lServiceProviderId"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="g_oSUB.strAccountNumber"/>
            <parameter tag="" value="g_oSUB.strUserPin"/>
            <parameter tag="" value="g_oAPI.strLanguage"/>
          </SOAP>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 2) {
	Server.logError("Error sending soap message to initiate a callback from the Main Menu. Exit on: " + Result.name);
} 
]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnACDAuditRequest" start="1" event="ACDAuditRequest" returns="void" >
      <parameters >
        <parameter name="strAcdControllerIp" type="string" pass="byref"/>
        <parameter name="nAcdControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=70 y=191 ?>
          <!--MsgACDAuditResponse-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MsgACDAuditResponse&quot;" return="g_nReturnCode" external-function="1" library="lib_soap.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success" >g_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Recieved OnACDAuditRequest message.");
Session.g_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(2 != Result.id) {
	Server.logError("Error sending BeginRequestCSR message.");
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=348 y=232 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="OnInfo" start="1" event="OnInfo" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strContact" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strPriority" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_lTempLong1" type="i8" >0</var>
        <var name="f_lTempLong2" type="i8" >0</var>
        <var name="f_strContentOFF" type="string" >OFF</var>
        <var name="f_bFromCallLegA" type="boolean" >0</var>
        <var name="f_bProcTermCall" type="boolean" >0</var>
        <var name="f_bPutBOnHold" type="boolean" >0</var>
        <var name="f_bSendCancel" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=19 y=28 ?>
          <!--response 200 OK-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=712 y=40 ?>
          <!--dtmf ##-->
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="fax tone?" link="20" stubbed="0" >strContentType match "tone"</result>
            <result name="multi leg conf but max reached" link="21" stubbed="1" >strContentType match "dtmf"



AND strContent match "#"



AND g_oAPI.nMaxPartiesAllowed &gt; 2



AND g_oArrayCallLegs.length &gt;= g_oAPI.nMaxPartiesAllowed</result>
            <result name="multi leg conf?" link="21" stubbed="1" >strContentType match "dtmf"



AND strContent match "#"



AND g_oAPI.nMaxPartiesAllowed &gt; 2



AND g_oArrayCallLegs.length &lt; g_oAPI.nMaxPartiesAllowed</result>
            <result name="#" link="6" stubbed="1" >strContentType match "dtmf"



AND strContent match "#"</result>
          </results>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=75 y=1068 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=597 y=690 ?>
          <!--Re-originate-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=804 y=743 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="6" plug-in="Pactolus.Branch.1" ><?xtml-editor x=51 y=679 ?>
          <!--connected?-->
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="f_bProcTerminateCall" link="33" stubbed="0" >f_bProcTermCall == true</result>
            <result name="f_bSendCancel" link="13" stubbed="0" >f_bSendCancel == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bProcTermCall = false;



Session.f_bSendCancel = false;



if(Session.g_nCurrentArrayIndex >= 0 && Session.g_oArrayCallLegs.length != 0) {



	if(false == Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bCurrentlyDialing) {

		Session.f_bProcTermCall = true;

		return;

	}

} 



if(Session.g_nCurrentArrayIndex >= 0 && Session.g_oArrayCallLegs.length != 0) {



	if(false == Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bConnected && 

	   true  ==	Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].bCurrentlyDialing) {

		Session.f_bSendCancel = true;

		return;

	}



}]]></script>
          </scripts>
        </action>
        <action id="7" plug-in="Pactolus.Branch.1" ><?xtml-editor x=634 y=1035 ?>
          <!--connect to media server?-->
          <results >
            <result name="Default" link="12" stubbed="0"/>
            <result name="g_oMS.bCurrentlyConnected==true" link="8" stubbed="0" >g_oMS.bCurrentlyConnected == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents( true );]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1115 y=1081 ?>
          <!--s_nGET_DESTINATION-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="5" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nGET_DESTINATION;]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1161 y=20 ?>
          <!--put B on hold-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success" link="16" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(0 != Session.f_nReturnCode) {



	Server.logError("Error putting leg on hold.");



}]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1574 y=114 ?>
          <!--Hangup2Parties-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Hangup2Parties&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;

Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=521 y=876 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="14" stubbed="0"/>
            <result name="Success" link="7" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 5;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");



Session.g_oACD.lCSRAssignmentId = 0;



Session.g_oACD.lCSRUserId = 0;	

]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=870 y=964 ?>
          <!--outdial from MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="14" stubbed="0"/>
            <result name="Success" link="8" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="15" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (3 == Result.id)

{

	Session.g_oAPI.nSessionTerminationReason = 7;

}]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=311 y=862 ?>
          <!--Cancel PartyB-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CancelParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1129 y=891 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
          </results>
        </action>
        <action id="15" plug-in="Standard.EndSession.1" ><?xtml-editor x=1528 y=369 ?></action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1328 y=136 ?>
          <!--"FaxOutdial"-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;FaxOutdial&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >f_lTempLong1</parameter>
            <parameter >f_lTempLong2</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].strSIPStatus</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success" link="3" stubbed="1" >f_nReturnCode == 0</result>
          </results>
        </action>
        <action id="17" plug-in="Pactolus.SipInfo.1" ><?xtml-editor x=511 y=183 ?>
          <!--OFF-->
          <element-tag increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >f_strContentOFF</content>
            <content-type >"application/dtmf"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strTo</from>
            <request-uri >g_oCallLegA.strRequestUri</request-uri>
            <to >g_oCallLegA.strFrom</to>
            <via >s_strVia</via>
          </element-tag>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="18" plug-in="Pactolus.Branch.1" ><?xtml-editor x=207 y=134 ?>
          <!--from call leg A?-->
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="f_bFromCallLegA" link="19" stubbed="0" >f_bFromCallLegA == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (0 == Clib.strcmpi(Session.strCallId, Session.g_oCallLegA.strCallId))

{

	Session.f_bFromCallLegA = true;

	var newCSeq = new SipCSeq(Session.strCSeq);

	var oldCSeq = new SipCSeq(Session.g_oCallLegA.strCSeq);



	if(newCSeq.value >= oldCSeq.value) 

	{

		newCSeq.increment() ;

		Session.g_oCallLegA.strCSeq = newCSeq.encode() ;

	}

}

else

{

	Session.f_bFromCallLegA = false;

}]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Pactolus.Branch.1" ><?xtml-editor x=383 y=20 ?>
          <!--Allow ReOrig?-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Type does not allow ReOrg" link="3" stubbed="1" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strOneStageDialing
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strIvrCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strAccessNumCallback</result>
            <result name="strSendInfoMsg = T" link="17" stubbed="0" >s_strSendInfoMsg match "T"</result>
          </results>
        </action>
        <action id="20" plug-in="Pactolus.Branch.1" ><?xtml-editor x=953 y=101 ?>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="bAppPropSuppressOnHold" link="16" stubbed="0" >g_oAPI.bSuppressOnHold == true</result>
            <result name="!f_bPutBOnHold" link="16" stubbed="0" >f_bPutBOnHold == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bPutBOnHold = false;
if(Session.g_nCurrentArrayIndex >= 0 && Session.g_oArrayCallLegs.length != 0) {



	Session.f_bPutBOnHold = true;



} else {



	Server.logError("Recieved on INFO message and determined it was a Fax Tone but no call legs exit in the array.");



}]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.Branch.1" ><?xtml-editor x=35 y=325 ?>
          <results >
            <result name="Default" link="30" stubbed="0"/>
            <result name="f_bSendCancel" link="22" stubbed="0" >f_bSendCancel == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_nCurrentArrayIndex >= 0 && Session.g_oArrayCallLegs.length != 0) {



	var i = Session.g_oArrayCallLegs.length - 1;



	if(Session.g_oArrayCallLegs[i].bCurrentlyDialing == true) {

		Server.logInfo("Recieved on Info message, app is currently outidaling a B leg;  the array.length:" + Session.g_oArrayCallLegs.length);

		Server.logInfo("App will send Cancel to the b leg.");

		Session.f_bSendCancel = true;

	} 

	

} else {

	Server.logInfo("Recieved on Info message, but current index is at 0, and call leg array.length is " + Session.g_oArrayCallLegs.length);

	Server.logInfo("App will not send a cancel to a B leg.");

}]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=254 y=420 ?>
          <!--Cancel PartyB-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;CancelParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="30" stubbed="0"/>
          </results>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=623 y=312 ?>
          <!--ProcNLeg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcNLeg&quot;" return="f_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="0 - Wait for event" link="32" stubbed="0" >f_nReturnCode == 0</result>
            <result name="3 - Get Dest" link="31" stubbed="0" >f_nReturnCode == 3</result>
            <result name="4 - Get Non Conf Dest" link="31" stubbed="0" >f_nReturnCode == 4</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oArrayCallLegs.length == 0) {
	Server.logError("Recieved OnInfo Event but g_oArrayCallLegs.length: " + Session.g_oArrayCallLegs.length);
}
Session.g_bModAddingParty = true;
js_enable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(0 == Session.f_nReturnCode) {
	Session.g_bModAddingParty = false;
}]]></script>
          </scripts>
        </action>
        <action id="31" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=904 y=394 ?>
          <!--call is GET_DEST-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="3" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nGET_DESTINATION;
if(Session.f_nReturnCode == 4) {
	Session.g_oCallLegB.strConfCallFlag = "F";
} else {
	Session.g_oCallLegB.strConfCallFlag = "T";
}
]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=895 y=236 ?>
          <!--ProcOnByes-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcOnByes&quot;" return="g_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oOnByeCallIds</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerMaxTime</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="-99: End Session" link="15" stubbed="0" >g_nReturnCode == -99</result>
          </results>
        </action>
        <action id="33" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=342 y=682 ?>
          <!--ProcTerminateConf-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcTerminateConf&quot;" return="f_nReturnCode" external-function="1" library="lib_3WayCalling.xml" >
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Success" link="4" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 5;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="FeatureCode_CheckBalance" start="15" event="" returns="void" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nTimeAvailable" type="i4" >0</var>
        <var name="f_nBillingCycleTime" type="i4" >0</var>
        <var name="strDigits" type="string" ></var>
        <var name="f_strBillingDate" type="string" ></var>
        <var name="f_nMinutesPrompt" type="i4" >309</var>
        <var name="f_nClosingPrompt1" type="i4" >1782</var>
        <var name="f_nClosingPrompt2" type="i4" >311</var>
        <var name="f_nReplay" type="i4" >0</var>
        <var name="f_nSecondsAvailable" type="i4" >0</var>
        <var name="f_nBucketSizeSeconds" type="i4" >0</var>
        <var name="p_subBucketSeconds" type="i8" >0</var>
        <var name="p_subSecondsAvailable" type="i8" >0</var>
        <var name="p_subTimeAvailable" type="i8" >0</var>
        <var name="p_TotalBucketSizeSeconds" type="i8" >0</var>
        <var name="p_totalSubBucketSize" type="i8" >0</var>
        <var name="p_totalSubBucketSizeSec" type="i8" >0</var>
        <var name="f_nSubMinutesPrompt" type="i4" >309</var>
      </local-vars>
      <actions >
        <action id="15" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=14 y=22 ?>
          <!--DirectCallerToMS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DirectCallerToMS&quot;" return="f_nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="success" link="18" stubbed="0" >f_nReturnCode == 0</result>
          </results>
        </action>
        <action id="16" plug-in="Standard.EndSession.1" ><?xtml-editor x=757 y=49 ?></action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=884 y=292 ?>
          <!--HangUpParty-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >s_strLocalHost</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=81 y=193 ?>
          <!--Select language-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >1315</audio>
          </play>
          <results >
            <result name="Default" link="19" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Prompting user for language.");
Session.strDigits = "";]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "2" == Session.strDigits ) {
	Session.g_oAPI.strLanguage = "spa";
}
else {
	Session.g_oAPI.strLanguage = "eng";
}
]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=73 y=427 ?>
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psGetStoredBalance&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oSTB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="20" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("------------Java.  StoredBalance-------------");

Server.logInfo("p_secondsBalance00= " + Session.g_oSTB.lSecondsBalance00);
Server.logInfo("p_secondsUsed01 = " + Session.g_oSTB.lSecondUsed01);
Server.logInfo("p_description02 = " + Session.g_oSTB.strDescription02);
Server.logInfo("p_bucketSize03 = " + Session.g_oSTB.lBucketSize03);
Server.logInfo("p_linkedFlag04 = " + Session.g_oSTB.strLinkedFlag04);


]]></script>
          </scripts>
        </action>
        <action id="20" plug-in="Pactolus.Branch.1" ><?xtml-editor x=393 y=160 ?>
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="Min Used &lt;= bucket size" link="21" stubbed="0" >(g_oSUB.nSecondsUsed &lt;= f_nBucketSizeSeconds
AND g_oSTB.lSecondsUsed01 == 0)
OR (g_oSUB.nSecondsUsed &lt;= f_nBucketSizeSeconds
AND g_oSTB.lSecondsUsed01 == -1)</result>
            <result name="Min Used &gt; bucket size" link="22" stubbed="0" >g_oSUB.nSecondsBalance == p_TotalBucketSizeSeconds
AND g_oSUB.nSecondsUsed &lt; p_TotalBucketSizeSeconds
AND (g_oSTB.lSecondsUsed01 == p_subBucketSeconds
OR g_oSTB.lSecondsUsed01 == -1)</result>
            <result name="SBusage and &lt; bucket size" link="23" stubbed="0" >(g_oSTB.lSecondsUsed01 &gt; 0)
AND (g_oSTB.lSecondsUsed01 &lt;= p_subBucketSeconds)
AND (g_oSUB.nSecondsUsed  &lt; f_nBucketSizeSeconds)</result>
            <result name="SBusage and &gt; buckets  size" link="24" stubbed="0" >g_oSTB.lSecondsUsed01 &gt; p_subBucketSeconds
AND g_oSTB.lSecondsBalance00 == p_totalSubBucketSizeSec
AND g_oSUB.nSecondsUsed &lt; p_TotalBucketSizeSeconds
AND g_oSUB.nSecondsBalance == p_TotalBucketSizeSeconds
AND g_oSTB.lSecondsUsed01 &lt; p_totalSubBucketSizeSec</result>
            <result name="SubBuck &gt; total and prim &lt; less" link="25" stubbed="0" >g_oSTB.lSecondsUsed01 &gt;= p_totalSubBucketSizeSec
AND g_oSUB.nSecondsUsed &lt; p_TotalBucketSizeSeconds</result>
            <result name="used &gt; greater than total" link="26" stubbed="0" >g_oSUB.nSecondsUsed &gt;= p_TotalBucketSizeSeconds</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
// eventually need to loop through and play all subBuckets and there description.

//Total subBucket size based on Primary bucket number of refills allowed
var refills = Session.g_oSUB.nTotalBucketSize / Session.g_oSUB.nBucketSize;
Server.logInfo("This is Refills = " + refills);

Server.logInfo("This is the SubBucket Balance First SubBucket = " + Session.g_oSTB.lSecondsBalance00);
Server.logInfo("This is the SubBucket Usage of the FirstSubBucket = " + Session.g_oSTB.lSecondsUsed01);
Server.logInfo("This Is the Name to Announce for the first SubBucket = " + Session.g_oSTB.strDescription02);
Server.logInfo("This Is the SubBucket Size for first SubBucket = " + Session.g_oSTB.lBucketSize03);

Session.p_TotalBucketSizeSeconds = Session.g_oSUB.nTotalBucketSize * 60; //Primary total in Seconds

   //Total subBucket size based on Primary bucket number of refills allowed
  Session.p_subBucketSeconds = Session.g_oSTB.lBucketSize03 * 60; 
  Session.p_totalSubBucketSize = Session.g_oSTB.lBucketSize03	* refills;
  Session.p_totalSubBucketSizeSec = Session.p_totalSubBucketSize * 60;
Server.logInfo("This Is the TotalSubBucket Size for first SubBucket = " + Session.p_totalSubBucketSize);
Server.logInfo("Total Bucket size Primary =" + Session.g_oSUB.nTotalBucketSize );


Session.f_nSecondsAvailable = (Session.g_oSUB.nSecondsBalance - Session.g_oSUB.nSecondsUsed) ;
Session.f_nBucketSizeSeconds = Session.g_oSUB.nBucketSize*60;
	//SubBucket seconds available
Session.p_subSecondsAvailable = (Session.g_oSTB.lSecondsBalance00 - Session.g_oSTB.lSecondsUsed01);

Server.logInfo("Session.f_nSecondsAvailable: " + Session.f_nSecondsAvailable);
Server.logInfo("Session.g_oSUB.nSecondsBalance: "+Session.g_oSUB.nSecondsBalance);
Server.logInfo("Session.g_oSUB.nSecondsUsed: "+Session.g_oSUB.nSecondsUsed);
Server.logInfo("Session.f_nBucketSizeSeconds: "+Session.f_nBucketSizeSeconds);

if ( 0 < Session.f_nSecondsAvailable && 60 > Session.f_nSecondsAvailable ) {
	Session.f_nTimeAvailable = 1;
}
else {
	Session.f_nTimeAvailable = Math.round(Session.f_nSecondsAvailable/60);
}
Server.logInfo("Session.f_nTimeAvailable=" +Session.f_nTimeAvailable);
if ( Session.f_nTimeAvailable < 0){
   Session.f_nTimeAvailable = 0;
}

 // SubBucket TimeAvailable
if ( 0 < Session.p_subSecondsAvailable && 60 > Session.p_subSecondsAvailable ) {
	Session.p_subTimeAvailable = 1;
} 
else {
	Session.p_subTimeAvailable = Math.round(Session.p_subSecondsAvailable/60);
} 
// Check if linked Bucket and if so set SubBucket avail to lesser of primary and Subbucket value
    if ( Session.g_oSTB.strLinkedFlag04 == "T" && Session.p_subTimeAvailable > Session.f_nTimeAvailable ){
	   Session.p_subTimeAvailable = Session.f_nTimeAvailable;
	 } 
if ( 1 == Session.p_subTimeAvailable ){
	Session.f_nSubMinutesPrompt = 308;
}	 		
	 		

Server.logInfo("Minutes available Primary: " + Session.f_nTimeAvailable);
Server.logInfo("Minutes available SubBucket: " + Session.p_subTimeAvailable);
if ( 1 == Session.f_nTimeAvailable ) {
	Session.f_nMinutesPrompt = 308;
}




]]></script>
            <script language="javascript" timing="last" ><![CDATA[//format for date prompt: YYYYMMDD
var today = new Date();
	var month = 0;
	Server.logInfo("Billing cycle date: " + Session.g_oSUB.nBillingCycleDay);
	Server.logInfo("Today's date: " + today.toString());
	Session.f_strBillingDate = today.getFullYear();
	//billing cycle dates cannot be greater than 28
	if ( Session.g_oSUB.nBillingCycleDay > today.getDate() ) {
		//next billing date is in the current month
		 month = today.getMonth() + 1 ;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		 Session.f_strBillingDate += month.toString();
	}
	else {
		//next billing date is next month
		month = today.getMonth() + 2;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 	Session.f_strBillingDate += month.toString();
	     } else {
	     Session.f_strBillingDate += month.toString();
	       }
		 if ( 12 < month ){// Set year to next year and month to Jan
       		 Session.f_strBillingDate = today.getFullYear() + 1;
       		 Session.f_strBillingDate += "01";
		 }
	}
	if ( 10 > Session.g_oSUB.nBillingCycleDay ){
		Session.f_strBillingDate += "0";
	}//first else
	Session.f_strBillingDate += Session.g_oSUB.nBillingCycleDay.toString();
	Server.logInfo("Next billing date: " + Session.f_strBillingDate);
]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=593 y=124 ?>
          <!--<= bucket size min used-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="0" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nTimeAvailable</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >1320</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >f_nClosingPrompt1</audio>
            <audio type="index" >f_nClosingPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="dtmf 1" link="21" stubbed="1" >strDigits match "1"
AND f_nReplay &lt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing prompt for <= 250 minutes available");
Session.strDigits = "";]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.f_nReplay++;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 == Session.f_nReplay ) {
	Session.f_nClosingPrompt1 = 322;
	Session.f_nClosingPrompt2 = 98;
}]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=634 y=311 ?>
          <!--> bucket size min used-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="0" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nTimeAvailable</audio>
            <audio type="index" >1312</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >1313</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >f_nClosingPrompt1</audio>
            <audio type="index" >f_nClosingPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="dtmf 1" link="22" stubbed="1" >strDigits match "1"
AND f_nReplay &lt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing prompt for > 250 minutes available");
Session.strDigits = "";


Server.logInfo("Billing cycle start date: " + Session.g_oSUB.nBillingCycleDay);]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.f_nReplay++;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 == Session.f_nReplay ) {
	Session.f_nClosingPrompt1 = 322;
	Session.f_nClosingPrompt2 = 98;
}]]></script>
          </scripts>
        </action>
        <action id="23" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=638 y=461 ?>
          <!--SubBucket has Usage < than subbucket Size-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="0" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nTimeAvailable</audio>
            <audio type="index" >1312</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >52</audio>
            <audio type="number" >p_subTimeAvailable</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >f_nSubMinutesPrompt</audio>
            <audio type="index" >1320</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >f_nClosingPrompt1</audio>
            <audio type="index" >f_nClosingPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="dtmf 1" link="23" stubbed="1" >strDigits match "1"
AND f_nReplay &lt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing prompt for SubBucket usage < subBucket minutes available");

Session.strDigits = "";]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.f_nReplay++;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 == Session.f_nReplay ) {
	Session.f_nClosingPrompt1 = 322;
	Session.f_nClosingPrompt2 = 98;
}]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=510 y=605 ?>
          <!--SubBucket has Usage >  subbucket Size
OR
Primary has usage > BucketSize-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="0" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nTimeAvailable</audio>
            <audio type="index" >1312</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >52</audio>
            <audio type="number" >p_subTimeAvailable</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >f_nSubMinutesPrompt</audio>
            <audio type="index" >1313</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >f_nClosingPrompt1</audio>
            <audio type="index" >f_nClosingPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="dtmf 1" link="24" stubbed="1" >strDigits match "1"
AND f_nReplay &lt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing prompt for SubBucket usage > subBucket minutes available");

Session.strDigits = "";]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.f_nReplay++;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 == Session.f_nReplay ) {
	Session.f_nClosingPrompt1 = 322;
	Session.f_nClosingPrompt2 = 98;
}]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=438 y=841 ?>
          <!--subUsage >= subBucket In billing Cycle-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="40" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="0" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >376</audio>
            <audio type="number" >f_nTimeAvailable</audio>
            <audio type="index" >1312</audio>
            <audio type="index" >f_nMinutesPrompt</audio>
            <audio type="index" >614</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >f_nSubMinutesPrompt</audio>
            <audio type="index" >1308</audio>
            <audio type="index" >615</audio>
            <audio type="index" >1318</audio>
            <audio type="index" >1321</audio>
            <audio type="date" >f_strBillingDate</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >f_nClosingPrompt1</audio>
            <audio type="index" >f_nClosingPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="dtmf 1" link="25" stubbed="1" >strDigits match "1"
AND f_nReplay &lt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing prompt for Sub >= subBucket in Billing cycle Primary has available seconds");
Session.strDigits = "";


Server.logInfo("Billing cycle start date: " + Session.g_oSUB.nBillingCycleDay);]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.f_nReplay++;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 == Session.f_nReplay ) {
	Session.f_nClosingPrompt1 = 322;
	Session.f_nClosingPrompt2 = 98;
}]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=277 y=973 ?>
          <!--MAX allotment has been reached-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="f_nReturnCode" start-play="1" interrupt="0" return-immediate="0" digit-map="&quot;[x]&quot;" language="g_oAPI.strLanguage" digits="strDigits" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1316</audio>
            <audio type="date" >f_strBillingDate</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >f_nClosingPrompt1</audio>
            <audio type="index" >f_nClosingPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="dtmf 1" link="26" stubbed="1" >strDigits match "1"
AND f_nReplay &lt;= 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Playing prompt for Max ALLOTMENT has been reached");
Session.strDigits = "";


Server.logInfo("Billing cycle start date: " + Session.g_oSUB.nBillingCycleDay);]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.f_nReplay++;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 == Session.f_nReplay ) {
	Session.f_nClosingPrompt1 = 322;
	Session.f_nClosingPrompt2 = 98;
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="PlayDisabledAnnc" start="1" event="" returns="void" >
      <local-vars >
        <var name="f_strBillingDate" type="string" ></var>
        <var name="f_nSuspendedPrompt1" type="i4" >0</var>
        <var name="f_nSuspendedPrompt2" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=65 y=162 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="exhausted bucket" link="3" stubbed="0" >g_oSUB.nDisabledReasonCode == s_sDISABLED_BUCKET_EXHAUSTED</result>
            <result name="account suspended" link="2" stubbed="0" >g_oSUB.nDisabledReasonCode == s_sDISABLED_SUSPENDED</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Subscriber disabled. Reason code <" + Session.g_oSUB.nDisabledReasonCode + ">");
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.f_nSuspendedPrompt1 = 99;//silence
Session.f_nSuspendedPrompt2 = 99;
if (Result.id == 3){
	if ("Cablevision" == Session.s_strCustomerCode || "cablevision" == Session.s_strCustomerCode ){
	Session.f_nSuspendedPrompt1 = 1299;//vox file contains CV custom 1299
	Session.f_nSuspendedPrompt2 = 99;
	}else if ("Tnzi" == Session.s_strCustomerCode || "tnzi" == Session.s_strCustomerCode ){
	Session.f_nSuspendedPrompt1 = 1335;//international calling is not avail
    Session.f_nSuspendedPrompt2 = 1336;//please call customer service for further
               if (Session.g_oSUB.strPinLanguage.length > 0){
                Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage; // set to subscribers desired lang
                }
            } else {
    Session.f_nSuspendedPrompt1 = 1299;//vox file contains pcs standard 1299
	Session.f_nSuspendedPrompt2 = 99;
	}
    
}
]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=417 y=434 ?>
          <!--account suspended-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >f_nSuspendedPrompt1</audio>
            <audio type="index" >f_nSuspendedPrompt2</audio>
          </play>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=410 y=230 ?>
          <!--bucket exhausted-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="silence" >.5</audio>
            <audio type="index" >1302</audio>
            <audio type="date" >f_strBillingDate</audio>
          </play>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//format for date prompt: YYYYMMDD
var today = new Date();
	var month = 0;
	Server.logInfo("Billing cycle date: " + Session.g_oSUB.nBillingCycleDay);
	Server.logInfo("Today's date: " + today.toString());
	Session.f_strBillingDate = today.getFullYear();
	//billing cycle dates cannot be greater than 28
	if ( Session.g_oSUB.nBillingCycleDay > today.getDate() ) {
		//next billing date is in the current month
		 month = today.getMonth() + 1 ;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		 Session.f_strBillingDate += month.toString();
	}
	else {
		//next billing date is next month
		month = today.getMonth() + 2;
		 if ( 10 > month ) {
		 	Session.f_strBillingDate += "0";
		 }
		Session.f_strBillingDate += month.toString();
	}
	if ( 10 > Session.g_oSUB.nBillingCycleDay ){
		Session.f_strBillingDate += "0";
	}
	Session.f_strBillingDate += Session.g_oSUB.nBillingCycleDay.toString();
	Server.logInfo("Next billing date: " + Session.f_strBillingDate);]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=402 y=40 ?>
          <!--other-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nChimeOrSilence</audio>
            <audio type="index" >1300</audio>
          </play>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=789 y=274 ?>
          <!--HangUpParty-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >s_strLocalHost</parameter>
          </function>
          <results >
            <result name="Default" link="6" stubbed="0"/>
          </results>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1062 y=303 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="ReAuthorizeDestination" start="8" event="" returns="i4" >
      <parameters >
        <parameter name="nTimerId" type="i4"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-1</var>
        <var name="f_nDuration" type="i4" >0</var>
        <var name="oApiCopy" type="object" ></var>
        <var name="oRateCopy" type="object" ></var>
        <var name="oSubCopy" type="object" ></var>
        <var name="oCallLegACopy" type="object" ></var>
        <var name="oCallLegBCopy" type="object" ></var>
        <var name="oCallLegArrayCopy" type="object" ></var>
        <var name="nCallLegIndexCopy" type="i4" >0</var>
        <var name="f_bBillingCycle" type="boolean" >0</var>
        <var name="nTimeToCutOffWarn" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="8" plug-in="Pactolus.Branch.1" ><?xtml-editor x=33 y=14 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Multiple B-Legs" link="3" stubbed="0" >g_oArrayCallLegs.length &gt; 1</result>
            <result name="Shared Use" link="3" stubbed="0" >g_oAPI.strSharedUseBillingFlag match "T"</result>
            <result name="Not Dual Rated" link="3" stubbed="0" >g_oRATE.bDualRating == false
AND f_bBillingCycle == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("number of b-legs: "+Session.g_oArrayCallLegs.length);
Server.logInfo("shared use: "+Session.g_oAPI.strSharedUseBillingFlag);
Server.logInfo("dual rating: "+Session.g_oRATE.bDualRating);
Session.f_bBillingCycle = (Session.g_oTimerBillingCycle.lTimerId == Session.nTimerId);]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=741 y=171 ?>
          <!--psAPIAuthorizeDestination-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >oApiCopy</parameter>
            <parameter >oRateCopy</parameter>
            <parameter >oSubCopy</parameter>
            <parameter >oCallLegBCopy</parameter>
            <parameter >oCallLegACopy</parameter>
          </function>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="13" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 1</result>
            <result name="-3,-4,-6,-7, -8, -9, -10: Get Dest Again" link="9" stubbed="0" >f_nReturnCode == -3
OR f_nReturnCode == -4
OR f_nReturnCode == -6
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9
OR f_nReturnCode == -10</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START ReAuthorizeDestination *********");

Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);


Server.logInfo("Session.g_nCurrentArrayIndex    : "+Session.g_nCurrentArrayIndex);
Server.logInfo("Session.g_oArrayCallLegs.length : "+Session.g_oArrayCallLegs.length);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");

Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;

if (Session.f_nReturnCode != 0)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;							
		case -10:
			Session.g_nErrorMsgNumber = 2002; //occurs if zero cost turned on at service level, but one or more associated rates has an amount greater than 0
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;					
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}

Server.logInfo("setting up objects with new auth dest information");

var time = Server.getUTCTime();
if(Session.f_bBillingCycle){
	time = Session.g_oSUB.nSecondsUntilBillingCycle;
}
//make copies, if auth fails, reset the globals to these copies
//also copies will be used in call completion if auth dest is successful
Session.g_oAPI = Session.oApiCopy ;
Session.g_oRATE = Session.oRateCopy;
Session.g_oSUB = Session.oSubCopy;
Session.g_oCallLegA = Session.oCallLegACopy;
Session.g_oCallLegB = Session.oCallLegBCopy;
Session.g_oCallLegB.lTimeAnswered = time;
Session.g_oCallLegB.lTimeStart = time;
Session.g_oCallLegB.lTimeEnded = 0;
Session.g_oCallLegA.lTimeAnswered = time;
Session.g_oCallLegA.lTimeStart = time;
Server.logInfo("Resetting call-leg data since call completion would have removed the b-leg");
Session.g_oArrayCallLegs = Session.oCallLegArrayCopy;
Session.g_nCurrentArrayIndex = Session.nCallLegIndexCopy;
Session.g_oArrayCallLegs[0].lTimeAnswered = Session.g_oCallLegB.lTimeAnswered;
Session.g_oArrayCallLegs[0].lTimeStart = Session.g_oCallLegB.lTimeStart;
Session.g_oArrayCallLegs[0].lTimeEnded = 0;
Session.g_oArrayCallLegs[0].strEventId = Session.g_oCallLegB.strEventId;
Session.g_oArrayCallLegs[0].oRATE = Session.g_oRATE;


Server.logInfo("Session.g_oArrayCallLegs[0].lTimeEnded: "+Session.g_oArrayCallLegs[0].lTimeEnded);
Server.logInfo("Session.g_oCallLegB.lTimeEnded: "+Session.g_oCallLegB.lTimeEnded);
Server.logInfo("Session.g_oArrayCallLegs[0].lTimeStart: "+Session.g_oArrayCallLegs[0].lTimeStart);
Server.logInfo("Session.g_oCallLegB.lTimeStart: "+Session.g_oCallLegB.lTimeStart);
Server.logInfo("Session.g_oArrayCallLegs[0].lTimeAnswered: "+Session.g_oArrayCallLegs[0].lTimeAnswered);
Server.logInfo("Session.g_oCallLegB.lTimeAnswered: "+Session.g_oCallLegB.lTimeAnswered);

Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("Session.g_nCurrentArrayIndex    : "+Session.g_nCurrentArrayIndex);
Server.logInfo("Session.g_oArrayCallLegs.length : "+Session.g_oArrayCallLegs.length);
]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=874 y=470 ?>
          <return xmlns="www.pactolus.com:xtml:application" value="f_nReturnCode"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = 0;]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=496 y=65 ?>
          <return xmlns="www.pactolus.com:xtml:application" value="f_nReturnCode"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -1;]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=887 y=333 ?>
          <!--SetTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;SetTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimer</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex].oTimerGSX</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oArrayCallLegs[g_nCurrentArrayIndex]</parameter>
            <parameter >f_nDuration</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers
js_initTimer(Session.g_oTimerThreshold1);
js_initTimer(Session.g_oTimerThreshold2);
js_initTimer(Session.g_oTimerThreshold3);
js_initTimer(Session.g_oTimerPhoneA);
js_initTimer(Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].oTimer);
js_initTimer(Session.g_oTimerMaxTime);
js_initTimer(Session.g_oTimerLongCallInterval);
if (Session.g_bDirectCallFlag == true) {
  Server.logInfo("Direct call flag enabled.  Warning thresholds disabled.");
} else {
   Session.g_oTimerThreshold1.nThresholdTime = Session.g_oAPI.nWarningThreshold1;
   Session.g_oTimerThreshold2.nThresholdTime = Session.g_oAPI.nWarningThreshold2;
   Session.g_oTimerThreshold3.nThresholdTime = Session.g_oAPI.nWarningThreshold3;
}
Session.g_oTimerPhoneA.lSleepTime = Session.g_oCallLegA.initSessionTimer;
Session.g_oTimerPhoneB.lSleepTime = Session.g_oCallLegB.initSessionTimer;
Session.g_oTimerLongCallInterval.lSleepTime = Session.g_oAPI.nLongCallInterval * 60;
Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].oTimer.lSleepTime = Session.g_oArrayCallLegs[Session.g_nCurrentArrayIndex].nSessionTimer;

if (Session.g_oSUB.nSecondsAvailable > 0){
	Session.g_oTimerMaxTime.lSleepTime = Session.g_oSUB.nSecondsAvailable;
} else if (Session.g_oAPI.nMaxAllowedSeconds > 0){
	Session.g_oTimerMaxTime.lSleepTime =  Session.g_oAPI.nMaxAllowedSeconds;
} else {
	Session.g_oTimerMaxTime.lSleepTime = 4294967;
	Server.logInfo("INFO: BOTH SECOND AVAILABLE AND MAX ALLOW SECONDS EQUAL ZERO");
}]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=36 y=152 ?>
          <!--StopTimers-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
            <parameter >g_oTimerLongCallInterval</parameter>
          </function>
          <results >
            <result name="Default" link="14" stubbed="0"/>
            <result name="returnCode = -2" link="14" stubbed="0" >f_nReturnCode == -2</result>
            <result name="returnCode = -4" link="14" stubbed="0" >f_nReturnCode == -4</result>
            <result name="returnCode = -5" link="14" stubbed="0" >f_nReturnCode == -5</result>
            <result name="returnCode = -3" link="14" stubbed="0" >f_nReturnCode == -3</result>
            <result name="returnCode = -6" link="14" stubbed="0" >f_nReturnCode == -6</result>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=548 y=160 ?>
          <!--call callCompletion()-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="Success" link="1" stubbed="0" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
//make copies, if auth fails, reset the globals to these copies
//also copies will be used in call completion if auth dest is successful
if(Session.f_bBillingCycle){
	Server.logInfo("re-auth was due to billing cycle, set end time to billing cycle date before call completion");
	Session.g_oCallLegB.lTimeEnded = Session.g_oSUB.nSecondsUntilBillingCycle;
	Session.g_oArrayCallLegs[0].lTimeEnded = Session.g_oSUB.nSecondsUntilBillingCycle;
	Server.logInfo("Session.g_oArrayCallLegs[0].lTimeEnded: "+Session.g_oArrayCallLegs[0].lTimeEnded);
	Server.logInfo("Session.g_oCallLegB.lTimeEnded: "+Session.g_oCallLegB.lTimeEnded);
}
Session.oApiCopy = Session.g_oAPI;
Session.oRateCopy = Session.g_oRATE;
Session.oSubCopy = Session.g_oSUB;
Session.oCallLegACopy = Session.g_oCallLegA;
Session.oCallLegBCopy = Session.g_oCallLegB;
Session.oCallLegArrayCopy = Session.g_oArrayCallLegs;
Session.nCallLegIndexCopy = Session.g_nCurrentArrayIndex;]]></script>
            <script language="javascript" timing="last" ><![CDATA[//set the values for prepaid balance, credit used, seconds used, and seconds balance
//calculated by call completion in the copies.  These copies will be
//used for auth dest so we must make sure the values are updated
Session.oSubCopy.nSecondsBalance=Session.g_oSUB.nSecondsBalance;
Session.oSubCopy.nSecondsUsed= Session.g_oSUB.nSecondsUsed;
Session.oSubCopy.fPrepaidBalance =Session.g_oSUB.fPrepaidBalance;
Session.oApiCopy.fCreditUsed = Session.g_oAPI.fCreditUsed;]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=179 y=382 ?>
          <!--Hang Up B-Leg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >oCallLegArrayCopy[0]</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="12" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Hang up b-leg");]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=373 y=386 ?>
          <!--Hang Up A-Leg-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >oCallLegACopy</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Hang up a-leg");]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=509 y=306 ?>
          <!--SetTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StartTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Start Cutoff" link="15" stubbed="0" >s_nCutOffTimeSeconds &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers
var diff = Session.g_oSUB.nSecondsUntilBillingCycle - Server.getUTCTime();
Server.logInfo("there are "+diff+" seconds until next billing cycle");
js_initTimer(diff);
Session.g_oTimerBillingCycle.lSleepTime = diff;
Server.logInfo("setting up billing cycle timer to expire after "+diff+" seconds");]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=210 y=160 ?>
          <!--StopOneTimer - Billing Cycle-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;StopOneTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerBillingCycle</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
        <action id="15" plug-in="Standard.Timer.1" ><?xtml-editor x=685 y=337 ?>
          <!--5 seconds until CutOff-->
          <timer xmlns="www.pactolus.com:xtml:application" start="1" id="g_nCutOffTimerId" duration="nTimeToCutOffWarn"/>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Cut off Warning Time set to: <" + Session.s_nCutOffTimeSeconds +">");
Server.logInfo("g_oTimerMaxTime.lSleepTime set to: <" + Session.g_oTimerMaxTime.lSleepTime +">");

// 
Session.nTimeToCutOffWarn = 0;
Server.logInfo("What oSUB seconds Avai is set to: <" + Session.g_oSUB.nSecondsAvailable +">");
Session.nTimeToCutOffWarn = Session.g_oTimerMaxTime.lSleepTime - Session.s_nCutOffTimeSeconds;
Server.logInfo("Warning will be played at: <"+ Session.nTimeToCutOffWarn + ">");



]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Standard.Timer.1" ><?xtml-editor x=368 y=159 ?>
          <!--Stop - 5 seconds until CutOff-->
          <timer xmlns="www.pactolus.com:xtml:application" start="0" id="g_nCutOffTimerId" duration=""/>
          <results >
            <result name="Default" link="7" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[


]]></script>
          </scripts>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="8" y-coord="325" width="199" height="49" text="An error occured, so hang up both legs." font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
        <text-object x-coord="188" y-coord="11" width="199" height="133" text="Currently not supporting multiple b-legs.  Need to add support later.
Not intended to work with shared use, so skip if this is shared use rating." font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="CheckPinNumberPrpdOrPopd" start="1" event="" returns="i4" >
      <local-vars >
        <var name="f_strCallingCardNumber" type="string" ></var>
        <var name="f_strPrpdPopdDigitMap" type="string" ></var>
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_nGetPinPrompt" type="i4" >579</var>
        <var name="f_nTimeout" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >0</var>
        <var name="f_bCallCSR" type="boolean" >0</var>
        <var name="f_bIsValid" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bNullString" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=12 y=256 ?>
          <results >
            <result name="Default" link="12" stubbed="0"/>
            <result name="Return from CSR" link="10" stubbed="0" >g_breturnFromMain  == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("In CheckPinnumberPrpdOrPopd function");

if((Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") || (Session.g_oACD.strPinZeroOut == "T" && Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strTwoStageDialing)) {
	Session.f_oCSRPrompts.nOR = 362;
	Session.f_oCSRPrompts.nPRESS = 310;
	Session.f_oCSRPrompts.nZERO = 1;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
}else{
	Session.f_oCSRPrompts.nOR = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}
if(Session.g_oAPI.nPopdAcctNumberLength > 0  || Session.g_oAPI.nPrpdPinNumberLength > 0){
	var pin_length=0;
	if(Session.g_oAPI.nPopdAcctNumberLength > Session.g_oAPI.nPrpdPinNumberLength){
		pin_length = Session.g_oAPI.nPopdAcctNumberLength;
	}else{
		pin_length = Session.g_oAPI.nPrpdPinNumberLength;
	}
		var temp_digits = "(";

		for (var i = 0; i < pin_length; i++) 	{

			temp_digits += "x";

		}

		Session.f_strPrpdPopdDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
}
else{
	Session.f_strPrpdPopdDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
}

Server.logInfo("Final Digit Map: "+Session.f_strPrpdPopdDigitMap);
Session.g_strTerminationDigit = "";
Session.f_strCallingCardNumber = "";
Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=469 y=380 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="s_strSendAlarmFlag==T" link="7" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Before sending alarm");
Session.g_oAPI.nSessionTerminationReason = 12;]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=680 y=373 ?>
          <!--Hang Up Phone A-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="8" stubbed="0"/>
          </results>
        </action>
        <action id="7" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=698 y=488 ?>
          <!--send MEDIASERVER ALARM-->
          <SOAP xmlns="www.pactolus.com:xtml:communication" destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" xml-namespace="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="6" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: connect caller to ms";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.EndSession.1" ><?xtml-editor x=918 y=426 ?></action>
        <action id="10" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=230 y=263 ?>
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="f_strPrpdPopdDigitMap" language="g_oAPI.strLanguage" digits="f_strCallingCardNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >629</audio>
          </play>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success" link="15" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="15" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("In CheckPinnumberPrpdOrPopd Play Prompt function");
Session.g_strTerminationDigit = "";
Session.f_nTimeout = Session.s_nGetPrepaidPinTimeout;
if ( 0 < Session.g_nNumRetry && 0 < Session.s_nDTMFDefaultTimeout) {
	Session.f_nTimeout = Session.s_nDTMFDefaultTimeout;
}
Server.logInfo("Setting play/collect timeout to <" + Session.f_nTimeout + ">");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("In CheckPinnumberPrpdOrPopd before calling Initialize Session function");
Server.logInfo("Session.f_strCallingCardNumber: "+Session.f_strCallingCardNumber);
Server.logInfo("Session.f_strCallingCardNumber Length: "+Session.f_strCallingCardNumber.length);


if(Session.f_strCallingCardNumber.length > 0 && Session.f_strCallingCardNumber.length==Session.g_oAPI.nPrpdPinNumberLength){
	Server.logInfo("Prpd Account type");
	Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID_PRPD;
	Session.g_oSUB.strUserPin = Session.f_strCallingCardNumber;
	Session.g_strPinNumber = Session.g_oSUB.strUserPin;
}
if(Session.f_strCallingCardNumber.length > 0 && Session.f_strCallingCardNumber.length==Session.g_oAPI.nPopdAcctNumberLength)
{
	Server.logInfo("Popd Account type");
	Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID_POPD;
	Session.g_oSUB.strAccountNumber = Session.f_strCallingCardNumber;
	Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;
}
Session.g_oAPI.bSharedAccessNumber=true;
Server.logInfo("Service Element Id value: "+Session.g_oAPI.nServiceElementId);
Server.logInfo("Prepaid pin number length: "+Session.g_oAPI.nPrpdPinNumberLength);
Server.logInfo("Postpaid pin number length: "+Session.g_oAPI.nPopdAcctNumberLength);]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=104 y=389 ?>
          <!--direct caller to MS-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;DirectCallerToMS&quot;" return="f_nReturnCode" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success" link="10" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="8" stubbed="0" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
	Session.g_bFailToConnectToMS = true;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
	Session.g_bFailToConnectToMS = true;
}
else
{
	Session.g_bSentFinalResponse = true;
}]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=345 y=500 ?>
          <!--503 service unavailable-->
          <sip-response xmlns="www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 503 Service Unavailable"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("ERROR: INITIALIZE SESSION FAILS, RESPONSE 503 SERVICE UNAVAILABLE");

var myTo = new SipTo(Session.g_oCallLegA.strTo);

if (undefined == myTo.tag)
{
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strTo + ";tag=" + Server.getUTCTime();

}]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=892 y=143 ?>
          <return xmlns="www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nINITIALIZE_SESSION;]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Pactolus.Branch.1" ><?xtml-editor x=488 y=196 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="misdial" link="10" stubbed="1" >f_bMissDial == true</result>
            <result name="zero to CSR" link="16" stubbed="1" >f_bCallCSR == true</result>
            <result name="invalid" link="18" stubbed="1" >f_bIsValid == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Calling card Number"+Session.f_strCallingCardNumber.length);
if ("0" == Session.f_strCallingCardNumber) {
	
	Session.f_bCallCSR = true;
	Session.g_nNumRetry++;

} else if(Session.f_strCallingCardNumber.length <= 0) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 552; // I did not hear a response

} else if (Session.f_strCallingCardNumber.length <= 1 || "*" == Session.f_strCallingCardNumber) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
	
} else if ("*" == Session.g_strTerminationDigit) {

	Session.f_bMissDial = true;
	
} else if (Session.f_strCallingCardNumber.length != Session.g_oAPI.nPopdAcctNumberLength && Session.f_strCallingCardNumber.length != Session.g_oAPI.nPrpdPinNumberLength) {
	
	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
} 
else {
	Session.f_bIsValid = true;
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_strTerminationDigit = "";]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=692 y=279 ?>
          <!--g_nCurrentState-->
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("f_bCallCSR: "+Session.f_bCallCSR);
if(Session.f_bCallCSR) {
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinZeroOut;
} else {
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinMaxInvalids;	
}

Session.g_oAPI.nStatePriorToCSR  = Session.s_nSTATE_CHECK_PIN_PRPD_OR_POPD;	

Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;


]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=668 y=111 ?>
          <!--0.5 sec-->
          <sleep xmlns="www.pactolus.com:xtml:application" duration="0.5"/>
          <results >
            <result name="Default" link="14" stubbed="0"/>
          </results>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=885 y=199 ?>
          <!--invalid card number-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="try again" link="10" stubbed="1" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nMaxLoginAttempts"+Session.g_oAPI.nMaxLoginAttempts);
Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="RegisterAuthAni" start="1" event="BalanceTransfer" returns="i4" >
      <local-vars >
        <var name="strPin" type="string" ></var>
        <var name="bGotPin" type="boolean" >0</var>
        <var name="nReturnCode" type="i4" >-99</var>
        <var name="nRetries" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=100 y=122 ?>
          <!--collect pin-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxxxxxxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="strPin" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >501</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="collected pin" link="4" stubbed="0" >bGotPin == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.strPin = "" ;
Session.bGotPin = false ;

]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if( Session.strPin.length > 0 ) {
	Session.bGotPin = true ;
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.EndSession.1" ><?xtml-editor x=734 y=261 ?></action>
        <action id="4" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=299 y=291 ?>
          <!--RegisterPrepaidAuthAni-->
          <java xmlns="www.pactolus.com:xtml:application" class="s_strJavaClass" method="&quot;RegisterPrepaidAuthAni&quot;" timeout="15" return="" method-return-var="nReturnCode" method-return-type="0" >
            <parameter type="in" var-type="string" >g_oAPI.strPlatformSessionId</parameter>
            <parameter type="in" var-type="string" >strPin</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strOriginationNumber</parameter>
            <parameter type="in" var-type="i8" >g_oAPI.lServiceProviderId</parameter>
          </java>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="successfully activated" link="5" stubbed="0" >'Result'  == 'Success'
AND nReturnCode == 0</result>
            <result name="pin previously activated" link="6" stubbed="0" >nReturnCode == -2</result>
            <result name="pin not found" link="8" stubbed="0" >nReturnCode == -1
</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nReturnCode = -99 ;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=788 y=369 ?>
          <return xmlns="www.pactolus.com:xtml:application" value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = Session.strPin ;
Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=527 y=413 ?>
          <!--account already active-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="0" clear-digits="0" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >338</audio>
          </play>
          <results >
            <result name="Default" link="7" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error" ><?xtml-editor visible=no?></result>
            <result name="Timeout" ><?xtml-editor visible=no?></result>
          </results>
        </action>
        <action id="7" plug-in="Pactolus.Branch.1" ><?xtml-editor x=566 y=131 ?>
          <results >
            <result name="Default" link="1" stubbed="0"/>
            <result name="retries exceeded" link="9" stubbed="0" >nRetries &gt;= 3
</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nRetries++ ;]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=533 y=498 ?>
          <!--pin not found-->
          <play xmlns="www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="0" clear-digits="0" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >502</audio>
          </play>
          <results >
            <result name="Default" link="7" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error" ><?xtml-editor visible=no?></result>
            <result name="Timeout" ><?xtml-editor visible=no?></result>
          </results>
        </action>
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=526 y=277 ?>
          <!--PlayPromptAndHangup-->
          <function xmlns="www.pactolus.com:xtml:application" name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
  </functions>
  <script language="javascript" ><![CDATA[#include <javascript_utils.jsh>
#include <dialing_plan_utils.jsh>

function isAutoAni( phoneNumber ) {
	for( var i = 0; i < Session.s_oAutoAniArray.length; i++ ) {
		if( phoneNumber === Session.s_oAutoAniArray[i] ) {
			Server.logInfo("DH: phone number " + phoneNumber + " is an auto ANI access number") ;
			return true ;
		}
	}
	Server.logInfo("DH: phone number " + phoneNumber + " is not an auto ANI access number") ;
	return false ;
}

function trimString( str ) {
	return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
}
]]></script>
  <properties >
    <property key="&quot;_english&quot;" value="G:/Software/downloads/prepaid_english.vox"/>
    <property key="&quot;en2&quot;" value="G:/Software/downloads/prepaid_english.vox"/>
    <property key="default" value="C:/pactolus_app_server/prompts/pcs_english_g711_cv_converted.vox"/>
    <property key="disable-logging" value="0"/>
    <property key="js-include-path" value="../js"/>
    <property key="library-modules" value="lib_callcontrol.xml; lib_mediaserver.xml;lib_acd.xml;lib_APISce.xml;lib_soap.xml;lib_moh.xml;lib_utils.xml;lib_speeddial.xml;lib_calltreatment.xml;lib_voip.xml;lib_3WayCalling.xml;lib_featurecode.xml"/>
    <property key="library-path" value="../libs"/>
  </properties>
  <application-version >
    <revision >$Id: callingcard.xml,v 1.253.2.7 2009/12/31 09:41:15 egaudette Exp $</revision>
    <label >$Name: PCS-A-4-1-1-1-3-c1 $</label>
  </application-version>
</xtml>