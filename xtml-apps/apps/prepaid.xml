<?xml version="1.0"?>
<xtml version="1.0" >
  <version sce-version="422a4" prev-sce-version="422a4" last-mod-time="Monday, June 27, 2005 12:31:36"/>
  <events >
    <event name="CSRBeginAssignment" display="CSRBeginAssignment" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="lCSRAssignmentId" type="i8"/>
      <parameter name="lCSRRequestId" type="i8"/>
      <parameter name="lCSRUserId" type="i8"/>
      <parameter name="lCSRRequestSkillId" type="i8"/>
      <parameter name="strCSRRequestSkillName" type="string"/>
      <parameter name="lCSRRequestLanguageId" type="i8"/>
      <parameter name="strCSRRequestLanguageName" type="string"/>
      <parameter name="lCSRRequestGroupId" type="i8"/>
      <parameter name="strCSRRequestGroupName" type="string"/>
      <parameter name="nCSRRequestType" type="i4"/>
      <parameter name="strCSRRequestTypeName" type="string"/>
      <parameter name="lServiceProviderId" type="i8"/>
      <parameter name="strServiceProviderName" type="string"/>
      <parameter name="lOfferingId" type="i8"/>
      <parameter name="strOfferingName" type="string"/>
      <parameter name="strConfEventId" type="string"/>
      <parameter name="strConfModPasscode" type="string"/>
      <parameter name="strSubscriberAccount" type="string"/>
      <parameter name="strSubscriberFirstName" type="string"/>
      <parameter name="strSubscriberLastName" type="string"/>
      <parameter name="strCSRAppServerIP" type="string"/>
      <parameter name="strCSRAssignmentType" type="string"/>
      <parameter name="lCSRAssignmentDuration" type="i8"/>
      <parameter name="strSubscriberPin" type="string"/>
      <parameter name="strCSRAssignmentAction" type="string"/>
    </event>
    <event name="CSREndAssignment" display="CSREndAssignment" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strCSRTransactionId" type="string"/>
      <parameter name="lCSRAssignmentId" type="string"/>
      <parameter name="lCSRRequestId" type="i8"/>
      <parameter name="lCSRUserId" type="i8"/>
      <parameter name="strCSRAssignmentAction" type="string"/>
      <parameter name="strPasscode" type="string"/>
      <parameter name="strPrepaidPIN" type="string"/>
      <parameter name="strPostpaidPIN" type="string"/>
      <parameter name="strPostpaidAccountNumber" type="string"/>
      <parameter name="strOutdialPhoneNumber" type="string"/>
      <parameter name="nCSRAvailabilityState" type="i4"/>
      <parameter name="strBillableFlag" type="string"/>
    </event>
    <event name="CallerOffHold" display="CallerOffHold" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="CallerOnHold" display="CallerOnHold" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="CSROutdialBLeg" display="CSROutdialBLeg" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="strPhoneNumber" type="string"/>
      <parameter name="strPrepaidPin" type="string"/>
      <parameter name="strPostpaidPin" type="string"/>
      <parameter name="strPostpaidAccountNum" type="string"/>
      <parameter name="strBillableFlag" type="string"/>
    </event>
    <event name="Ping" display="Ping" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="strHostIP" type="string"/>
      <parameter name="nHostPort" type="i4"/>
    </event>
    <event name="CSRCancelOutdialToBLeg" display="CSRCancelOutdialToBLeg" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="CSRHangupBLeg" display="CSRHangupBLeg" >
      <parameter name="strACDControllerIP" type="string"/>
      <parameter name="nACDControllerPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
    <event name="ClickToDial" display="ClickToDial" >
      <parameter name="strSrcIpAddress" type="string"/>
      <parameter name="nPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
      <parameter name="strCallingNumber" type="string"/>
      <parameter name="strCalledNumber" type="string"/>
      <parameter name="nTreatmentCode" type="i4"/>
      <parameter name="strServiceProviderCode" type="string"/>
      <parameter name="lServiceProviderId" type="i8"/>
      <parameter name="strPrepaidPinNbr" type="string"/>
      <parameter name="strPostpaidAcctNbr" type="string"/>
      <parameter name="strPostpaidPinNbr" type="string"/>
    </event>
    <event name="ClickToDialQuery" display="ClickToDialQuery" >
      <parameter name="strSrcAddress" type="string"/>
      <parameter name="nPort" type="i4"/>
      <parameter name="strTransactionId" type="string"/>
    </event>
  </events>
  <global-handlers >
    <handler event="Pactolus.EveSipRefer.1" function="OnRefer" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipInvite.1" function="OnInvite" public="1" always-on="0"/>
    <handler event="Pactolus.EveSipBye.1" function="OnBye" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipCancel.1" function="OnCancel" public="0" always-on="0"/>
    <handler event="Standard.OnServiceLoad.1" function="OnServiceLoad" public="0" always-on="0"/>
    <handler event="Standard.OnSessionEnd.1" function="OnSessionEnd" public="0" always-on="0"/>
    <handler event="Standard.OnTimer.1" function="OnTimer" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipInfo.1" function="OnInfo" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipOptions.1" function="OnOptions" public="0" always-on="0"/>
    <handler event="CSRBeginAssignment" function="OnCSRBeginAssignment" public="0" always-on="0"/>
    <handler event="CSREndAssignment" function="OnCSREndAssignment" public="0" always-on="0"/>
    <handler event="CallerOffHold" function="OnCSRTakeCallerOffHold" public="0" always-on="0"/>
    <handler event="CallerOnHold" function="OnCSRPutCallerOnHold" public="0" always-on="0"/>
    <handler event="CSROutdialBLeg" function="OnCSROutdialBLeg" public="0" always-on="0"/>
    <handler event="Ping" function="OnPing" public="0" always-on="0"/>
    <handler event="CSRCancelOutdialToBLeg" function="OnCSRCancelOutdialToBLeg" public="0" always-on="0"/>
    <handler event="CSRHangupBLeg" function="OnCSRHangupBLeg" public="0" always-on="0"/>
    <handler event="ClickToDial" function="OnClickToDial" public="1" always-on="0"/>
    <handler event="ClickToDialQuery" function="OnClickToDialQuery" public="1" always-on="0"/>
  </global-handlers>
  <global-vars >
    <var name="g_nMode" type="i4" >0</var>
    <var name="g_nMinIntlDigits" type="i4" >3</var>
    <var name="g_nOrigTacRegionId" type="i4" >1</var>
    <var name="g_strContact" type="string" ></var>
    <var name="g_nCurrentState" type="i4" >-1</var>
    <var name="g_strTempString" type="string" ></var>
    <var name="g_nTempInt" type="i4" >0</var>
    <var name="g_lTempLong" type="i8" >0</var>
    <var name="g_nTimeAvailable" type="i4" >0</var>
    <var name="g_nPromptToPlay" type="i4" >0</var>
    <var name="g_bGotRechargeSettings" type="boolean" >0</var>
    <var name="g_strDigit" type="string" >""</var>
    <var name="g_nSessionType" type="i4" >1</var>
    <var name="g_nNumRetry" type="i4" >0</var>
    <var name="g_sMaxLoginAttempts" type="i2" >0</var>
    <var name="g_bNullFlag" type="boolean" >0</var>
    <var name="g_bTimerAFlag" type="boolean" >0</var>
    <var name="g_bTimerBFlag" type="boolean" >0</var>
    <var name="g_strTestOriginationNumber" type="string" ></var>
    <var name="g_lTimerIdA" type="i8" >0</var>
    <var name="g_lTimerIdB" type="i8" >0</var>
    <var name="g_nSessionExpiresA" type="i4" >0</var>
    <var name="g_nSessionExpiresB" type="i4" >0</var>
    <var name="g_strTerminationDigit" type="string" ></var>
    <var name="g_bFirstTry" type="boolean" >1</var>
    <var name="g_strAlarmType" type="string" ></var>
    <var name="g_strAlarmPriority" type="string" ></var>
    <var name="g_oCallLegA" type="object" ></var>
    <var name="g_oCallLegB" type="object" ></var>
    <var name="g_oMS" type="object" ></var>
    <var name="g_bSentFinalResponse" type="boolean" >0</var>
    <var name="g_bNewCall" type="boolean" >1</var>
    <var name="g_nErrorMsgNumber" type="i4" >0</var>
    <var name="g_oTimerThreshold1" type="object" ></var>
    <var name="g_oTimerThreshold2" type="object" ></var>
    <var name="g_oTimerThreshold3" type="object" ></var>
    <var name="g_oTimerGSXA" type="object" ></var>
    <var name="g_oTimerPhoneA" type="object" ></var>
    <var name="g_oTimerPhoneB" type="object" ></var>
    <var name="g_oTimerGSXB" type="object" ></var>
    <var name="g_oTimerMaxTime" type="object" ></var>
    <var name="g_oAPI" type="object" ></var>
    <var name="g_oACD" type="object" ></var>
    <var name="g_oSUB" type="object" ></var>
    <var name="g_oRATE" type="object" ></var>
    <var name="g_oBALXFER" type="object" ></var>
    <var name="g_oCC" type="object" ></var>
    <var name="g_oMOH" type="object" ></var>
    <var name="g_oTimerMOH" type="object" ></var>
    <var name="g_oTimerPleaseHold" type="object" ></var>
    <var name="g_oTimerMaxWaitCSR" type="object" ></var>
    <var name="g_oConfMS" type="object" ></var>
    <var name="g_oNULL" type="object" ></var>
    <var name="g_oTimerHeartBeat" type="object" ></var>
    <var name="g_oTEST" type="object" ></var>
    <var name="g_oPrompts" type="object" ></var>
    <var name="g_bGotCSRCancelOutdial" type="boolean" >0</var>
    <var name="g_bGotCSRHangupOutdial" type="boolean" >0</var>
    <var name="g_bBeginAssignment" type="boolean" >0</var>
    <var name="g_bBeginRequest" type="boolean" >0</var>
    <var name="g_bFailToConnectToMS" type="boolean" >0</var>
    <var name="g_nPromptHoldForCSR" type="i4" >1501</var>
    <var name="g_nPromptNotAllowed" type="i4" >524</var>
    <var name="g_nReturnCode" type="i4" >0</var>
    <var name="g_oLanguages" type="object" ></var>
    <var name="g_nLanguageMenuPrompt" type="i4" >333</var>
    <var name="g_oArrayCallLegs" type="object" ></var>
    <var name="g_strClick2DialStatus" type="string" ></var>
    <var name="g_nClick2DialCode" type="i4" >0</var>
    <var name="g_bValidateByANI" type="boolean" >0</var>
    <var name="g_strZeroTransactionId" type="string" >0</var>
    <var name="g_strOutdialANumber" type="string" ></var>
    <var name="g_strC2DCalledNumber" type="string" ></var>
    <var name="g_strC2DSoapIp" type="string" ></var>
    <var name="g_nC2DSoapPort" type="i4" >0</var>
    <var name="g_strC2DTransactionId" type="string" ></var>
    <var name="g_bSingleStageDialing" type="boolean" >0</var>
    <var name="g_bInitiatedANCallback" type="boolean" >0</var>
    <var name="g_bTryAgain" type="boolean" >1</var>
    <var name="g_oTimerMaxTimeALeg" type="object" ></var>
    <var name="g_strAuthenticationNbr" type="string" ></var>
    <var name="g_bGetPinOnly" type="boolean" >0</var>
    <var name="g_strDigitCollected" type="string" ></var>
    <var name="g_bALegRatingOn" type="boolean" >0</var>
  </global-vars>
  <shared-vars >
    <var name="s_strPrimaryPSX" type="string" >10.6.9.64</var>
    <var name="s_nSLEEPTIME" type="i4" >7</var>
    <var name="s_nTIMEOUT" type="i4" >30</var>
    <var name="s_strPROTOCOL" type="string" >UDP</var>
    <var name="s_strSIPVERSION" type="string" >SIP/2.0</var>
    <var name="s_strApplicationName" type="string" ></var>
    <var name="s_nINITIALIZE_SESSION" type="i4" >0</var>
    <var name="s_nGET_PIN" type="i4" >1</var>
    <var name="s_nAUTHENTICATE_PIN" type="i4" >2</var>
    <var name="s_nGET_DESTINATION" type="i4" >3</var>
    <var name="s_nAUTHORIZE_DESTINATION" type="i4" >4</var>
    <var name="s_nMAKE_CONNECTION" type="i4" >5</var>
    <var name="s_nCONNECTED" type="i4" >6</var>
    <var name="s_nCALL_COMPLETE" type="i4" >7</var>
    <var name="s_nSESSION_COMPLETE" type="i4" >8</var>
    <var name="s_nEND_CALL" type="i4" >9</var>
    <var name="s_nBALANCE_XFER" type="i4" >10</var>
    <var name="s_nCC_RECHARGE" type="i4" >11</var>
    <var name="s_nPLAY_BALANCE" type="i4" >12</var>
    <var name="s_nPLAY_EXPDATE" type="i4" >13</var>
    <var name="s_nMAKE_CALL" type="i4" >14</var>
    <var name="s_nMAIN_MENU" type="i4" >15</var>
    <var name="s_nRING_NO_ANSWER_TIME" type="i4" >60</var>
    <var name="s_strLocalHost" type="string" ></var>
    <var name="s_bTestMode" type="boolean" >0</var>
    <var name="s_strDEFAULT_ANI" type="string" ></var>
    <var name="s_strBackupPSX" type="string" ></var>
    <var name="s_strTestModeFlag" type="string" ></var>
    <var name="s_nPROMPTLENGTH" type="i4" >35</var>
    <var name="s_strContentType" type="string" >application/sdp</var>
    <var name="s_strSEND_ALARM_REQUEST" type="string" >OnAlarm</var>
    <var name="s_strSendAlarmFlag" type="string" ></var>
    <var name="s_strMSType" type="string" ></var>
    <var name="s_sSUCCESS" type="i2" >0</var>
    <var name="s_sFAILURE" type="i2" >-1</var>
    <var name="s_sCALLERHUNGUP" type="i2" >-2</var>
    <var name="s_strMSRetryFlag" type="string" ></var>
    <var name="s_strDigitPrependToOutDial" type="string" ></var>
    <var name="s_nPROMPT_GOOD_BYE" type="i4" >322</var>
    <var name="s_nPacketizationPeriod" type="i4" >0</var>
    <var name="s_strOutdialDigitMap" type="string" ></var>
    <var name="s_strSessionTimerFlag" type="string" ></var>
    <var name="s_nSessionTimerInterval" type="i4" >0</var>
    <var name="s_nIntlMinConnectTime" type="i4" >0</var>
    <var name="s_nDomMinConnectTime" type="i4" >0</var>
    <var name="s_strOutdialDialingPlan" type="string" ></var>
    <var name="s_strIgnorePinLanguage" type="string" >F</var>
    <var name="s_nHalfSecSilence" type="i4" >220</var>
    <var name="s_fPreStartCallDelay" type="float" >0</var>
    <var name="s_strCodec" type="string" ></var>
    <var name="s_nPROMPT_JOIN_TONE" type="string" >231</var>
    <var name="s_nBEGINASSIGNMENT" type="i4" >20</var>
    <var name="s_nREQUEUE" type="i4" >24</var>
    <var name="s_strCustomerCode" type="string" ></var>
    <var name="s_nSoapPort" type="i4" >0</var>
    <var name="s_nConferenceMaxParties" type="i4" >4</var>
    <var name="s_nConferenceMaxTalkers" type="i4" >4</var>
    <var name="s_nWAIT_FOR_MESSAGE" type="i4" >16</var>
    <var name="s_nSPEED_DIAL" type="i4" >17</var>
    <var name="s_nSPEED_DIAL_SE_ID" type="i4" >1</var>
    <var name="s_nEXCEEDINVALID" type="i4" >2</var>
    <var name="s_nCSR_ROUTE_REASON_ZERO_OUT" type="i4" >4</var>
    <var name="s_nBEGINREQUEST" type="i4" >22</var>
    <var name="s_strSendInfoMsg" type="string" ></var>
    <var name="s_nROUTE_TO_CSR" type="i4" >19</var>
    <var name="s_strPLAY_LANGUAGE_MENU" type="string" ></var>
    <var name="s_oCSR_REASONS" type="object" ></var>
    <var name="s_nSTATE_LANGUAGE_MENU" type="i4" >25</var>
    <var name="s_nSTATE_PROC_CSR_ATTEMPT" type="i4" >26</var>
    <var name="s_nCSR_ROUTE_REASON_TIMEOUT" type="i4" >5</var>
    <var name="s_nCSR_ROUTE_REASON_INVALID" type="i4" >6</var>
    <var name="s_strSendPrecallInfoMsg" type="string" ></var>
    <var name="s_strVia" type="string" ></var>
    <var name="s_strACDMediaServerType" type="string" ></var>
    <var name="s_strMOHMediaServerType" type="string" ></var>
    <var name="s_oINITIATION_TYPES" type="object" ></var>
    <var name="s_oORIG_TYPES" type="object" ></var>
    <var name="s_nDIAL_OUT_A_AND_B" type="i4" >27</var>
    <var name="s_nDIAL_OUT_A_ONLY" type="i4" >28</var>
    <var name="s_nSTATE_INIT_AN_CALLBACK" type="i4" >30</var>
    <var name="s_nPROMPT_CALLBACK" type="i4" >282</var>
    <var name="s_nIVR_CALLBACK_DELAY" type="i4" >5</var>
    <var name="s_nTREATMENT_CODE_IVR_INIT" type="i4" >2</var>
    <var name="s_strNULL" type="string" ></var>
    <var name="s_nPROMPT_CANT_CALLBACK" type="i4" >283</var>
    <var name="s_strPrependSVC" type="string" ></var>
    <var name="s_nSERVICE_ELEMENT_ID" type="i4" >1</var>
    <var name="s_nSERVICE_ELEMENT_ID_POPD" type="i4" >3</var>
    <var name="s_nSERVICE_ELEMENT_ID_PRPD" type="i4" >1</var>
    <var name="s_nSTATE_AUTH_PIN_POPD" type="i4" >31</var>
    <var name="s_nSTATE_AUTH_PRPD_OR_POPD" type="i4" >32</var>
    <var name="s_nSTATE_GET_PIN_POPD" type="i4" >33</var>
    <var name="s_nSTATE_GET_PIN_PRPD_OR_POPD" type="i4" >34</var>
    <var name="s_nSTATE_MAIN_MENU_POPD" type="i4" >35</var>
    <var name="s_nSTATE_MAIN_MENU_PRPD_OR_POPD" type="i4" >36</var>
  </shared-vars>
  <functions >
    <function name="Main" start="1" event="Main" returns="void" >
      <local-vars >
        <var name="f_strContentON" type="string" >ON</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=96 y=317 ?>
          <!--what is the g_nCurrentState-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="initializeSession()" link="3" stubbed="0" >g_nCurrentState == s_nINITIALIZE_SESSION</result>
            <result name="getPinNumber()" link="19" stubbed="0" >g_nCurrentState == s_nGET_PIN</result>
            <result name="authenticatePin()" link="5" stubbed="0" >g_nCurrentState == s_nAUTHENTICATE_PIN</result>
            <result name="getDestNumber()" link="17" stubbed="0" >g_nCurrentState == s_nGET_DESTINATION</result>
            <result name="authorizationDestination()" link="7" stubbed="0" >g_nCurrentState == s_nAUTHORIZE_DESTINATION</result>
            <result name="make connection" link="12" stubbed="0" >g_nCurrentState == s_nMAKE_CONNECTION</result>
            <result name="connected" link="21" stubbed="0" >g_nCurrentState == s_nCONNECTED</result>
            <result name="end call" link="15" stubbed="0" >g_nCurrentState == s_nEND_CALL</result>
            <result name="main menu" link="18" stubbed="0" >g_nCurrentState == s_nMAIN_MENU</result>
            <result name="route to csr" link="23" stubbed="0" >g_nCurrentState == s_nROUTE_TO_CSR</result>
            <result name="language menu" link="25" stubbed="0" >g_nCurrentState == s_nSTATE_LANGUAGE_MENU</result>
            <result name="proc CSR attempt" link="26" stubbed="0" >g_nCurrentState == s_nSTATE_PROC_CSR_ATTEMPT</result>
            <result name="DialOutPartyA" link="27" stubbed="0" >g_nCurrentState == s_nDIAL_OUT_A_ONLY</result>
            <result name="Init AN Callback" link="30" stubbed="0" >g_nCurrentState == s_nSTATE_INIT_AN_CALLBACK</result>
            <result name="Auth Pre or Post" link="35" stubbed="0" >g_nCurrentState == s_nSTATE_AUTH_PRPD_OR_POPD</result>
            <result name="Get Pin Pre or Post" link="36" stubbed="0" >g_nCurrentState == s_nSTATE_GET_PIN_PRPD_OR_POPD</result>
            <result name="Auth Popd Pin" link="37" stubbed="0" >g_nCurrentState == s_nSTATE_AUTH_PIN_POPD</result>
            <result name="Get Popd Pin" link="38" stubbed="0" >g_nCurrentState == s_nSTATE_GET_PIN_POPD</result>
            <result name="Main Menu Prpd or Popd" link="39" stubbed="0" >g_nCurrentState == s_nSTATE_MAIN_MENU_PRPD_OR_POPD</result>
            <result name="Main Menu Popd" link="40" stubbed="0" >g_nCurrentState == s_nSTATE_MAIN_MENU_POPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*** THE CURRENT STATE IS: *** " + Session.g_nCurrentState);]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=501 y=50 ?>
          <return value=""/>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=632 y=119 ?>
          <!--call initializeSession()-->
          <function name="&quot;InitializeSession&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=728 y=330 ?>
          <!--call authenticatePin()-->
          <function name="&quot;AuthenticatePin&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=721 y=537 ?>
          <!--call authorizeDest()-->
          <function name="&quot;AuthorizeDestination&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=686 y=633 ?>
          <!--make the connection-->
          <function name="&quot;Connect&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1128 y=740 ?>
          <return value=""/>
        </action>
        <action id="15" plug-in="Standard.EndSession.1" ><?xtml-editor x=628 y=876 ?></action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1157 y=225 ?>
          <!--getPinNumber()-->
          <function name="&quot;GetPinNumber&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=749 y=440 ?>
          <!--getDestNumber()-->
          <function name="&quot;GetDestNumber&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=632 y=950 ?>
          <!--call main menu-->
          <function name="&quot;MainMenu&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="19" plug-in="Pactolus.Branch.1" ><?xtml-editor x=674 y=223 ?>
          <!--delay?-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="s_fPreStartCallDelay &gt; 0 ?" link="20" stubbed="0" >s_fPreStartCallDelay &gt; 0</result>
          </results>
        </action>
        <action id="20" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=914 y=224 ?>
          <!--s_fPreStartCallDelay secs-->
          <sleep duration="s_fPreStartCallDelay"/>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
        <action id="21" plug-in="Pactolus.Branch.1" ><?xtml-editor x=645 y=745 ?>
          <!--send info msg = T and send info precall = F ?-->
          <results >
            <result name="Default" link="14" stubbed="1"/>
            <result name="SendInfoMs &amp;&amp; PreCall = F" link="22" stubbed="0" >s_strSendInfoMsg match "T"
AND s_strSendPrecallInfoMsg match "F"</result>
          </results>
        </action>
        <action id="22" plug-in="Pactolus.SipInfo.1" ><?xtml-editor x=887 y=742 ?>
          <!--ON-->
          <element-tag increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >f_strContentON</content>
            <content-type >"application/dtmf"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strTo</from>
            <request-uri >g_oCallLegA.strRequestUri</request-uri>
            <to >g_oCallLegA.strFrom</to>
            <via >s_strVia</via>
          </element-tag>
          <results >
            <result name="Default" link="14" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=604 y=1052 ?>
          <!--RouteToCSR-->
          <function name="&quot;RouteToCSR&quot;" return="g_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="24" stubbed="0"/>
            <result name="Success" link="1" stubbed="1" >g_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.lCSRRequestSkillId = 1;
Session.g_nNumRetry = 0;
js_disable_event();

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.g_nReturnCode == 0) {
	Session.g_bBeginRequest = true;
}	

Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;

js_enable_event();
]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=825 y=1051 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
          </results>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=600 y=1184 ?>
          <!--playLanguageMenu-->
          <function name="&quot;playLanguageMenu&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oLanguages</parameter>
            <parameter >g_nLanguageMenuPrompt</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="ProcCSRAttempt" >g_nReturnCode == 1
OR g_nReturnCode == 2
OR g_nReturnCode == 3</result>
            <result name="MS Error" link="24" stubbed="1" >g_nReturnCode == -1</result>
            <result name="!bValidateByANI " >g_bValidateByANI == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oLanguages[0].nPressNumber = 311;
Session.g_oLanguages[0].nForLanguage = 343;
Session.g_oLanguages[0].strCode = "eng";

Session.g_oLanguages[1].nPressNumber = 312;
Session.g_oLanguages[1].nForLanguage = 346;
Session.g_oLanguages[1].strCode = "spa";

Session.g_oLanguages[2].nPressNumber = 313;
Session.g_oLanguages[2].nForLanguage = 344;
Session.g_oLanguages[2].strCode = "ita";

Session.g_oLanguages[3].nPressNumber = 314;
Session.g_oLanguages[3].nForLanguage = 347;
Session.g_oLanguages[3].strCode = "ger";

Session.g_oLanguages[4].nPressNumber = 315;
Session.g_oLanguages[4].nForLanguage = 371;
Session.g_oLanguages[4].strCode = "chi";


if(Session.g_nLanguageMenuPrompt <= 0 && Session.g_oMS.strMSType == "CONV") {
	// Using Dynamic Language Menu w/ Convedia - need to set offsets for each language:
	Session.g_oLanguages[0].nOffset = 0; 	   	// Offset for English	
	Session.g_oLanguages[1].nOffset = 5000;	// Offset for Spanish	
	Session.g_oLanguages[2].nOffset = 20000;	// Offset for Italian
	Session.g_oLanguages[3].nOffset = 25000; 	// Offset for German	
	Session.g_oLanguages[4].nOffset = 30000; 	// Offset for Mandarin
	
/*	
	Session.g_oLanguages[0].nOffset = 0; 	   	// Offset for English	
	Session.g_oLanguages[1].nOffset = 10000; 	// Offset for French
	Session.g_oLanguages[2].nOffset = 5000;	// Offset for Spanish	
	Session.g_oLanguages[3].nOffset = 25000; 	// Offset for German	
	Session.g_oLanguages[4].nOffset = 40000; 	// Offset for Japanese
	Session.g_oLanguages[5].nOffset = 30000; 	// Offset for Chinese	
*/
	
	
}



]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(2 == Result.id) {

	if(Session.g_nReturnCode == 1) {
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nLanguageMenuMaxTimeouts;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_TIMEOUT;
	} else if(Session.g_nReturnCode == 2) {
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nLanguageMenuMaxInvalids;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;
	} else if(Session.g_nReturnCode == 3) {
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nLanguageMenuZeroOut;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
	}
	
	Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
	Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_LANGUAGE_MENU;
	
} else if(3 == Result.id) {
	Server.logError("Error playing language menu.");
} else if(4 == Result.id) {
	Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
} else {
	Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;

}


]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=588 y=1315 ?>
          <!--ProcessCSRAttempt-->
          <function name="&quot;ProcessCSRAttempt&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_nPromptHoldForCSR</parameter>
            <parameter >g_nPromptNotAllowed</parameter>
            <parameter >g_oMS</parameter>
            <parameter >s_oCSR_REASONS</parameter>
            <parameter >s_nTIMEOUT</parameter>
          </function>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nStatePriorToCSR: " + Session.g_oAPI.nStatePriorToCSR);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oACD.nCSRRouteReasonCode = Session.g_oACD.nCSRRouteReasonCodeTemp;

if(Session.g_nReturnCode == 1) {
	Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;
} else if(Session.g_nReturnCode == 2) {
	Session.g_nCurrentState = Session.s_nROUTE_TO_CSR;	
} else if(Session.g_nReturnCode == 3) {
	Session.g_nCurrentState = Session.s_nEND_CALL;	
} else if(Session.g_nReturnCode == 0) {
	Session.g_nCurrentState = Session.g_oAPI.nStatePriorToCSR;
}
]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=584 y=1414 ?>
          <!--DialOutPartyA-->
          <function name="&quot;DialOutPartyA&quot;" return="g_nReturnCode" external-function="1" library="lib_calltreatment.xml" >
            <parameter >g_strOutdialANumber</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strClick2DialStatus</parameter>
            <parameter >g_nClick2DialCode</parameter>
          </function>
          <results >
            <result name="Default" link="29" stubbed="0"/>
            <result name="Success" link="33" stubbed="0" >g_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ("T" == Session.s_strPrependSVC)
	Session.g_strOutdialANumber = Session.g_oAPI.strServiceProviderCode + Session.g_strOutdialANumber;]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1402 y=1607 ?>
          <!--call playPrepaidBalance()-->
          <function name="&quot;PlayPrepaidBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="29" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=830 y=1403 ?>
          <sleep duration="5"/>
          <results >
            <result name="Default" link="15" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strClick2DialStatus = "Unable to connect." ;
Session.g_nClick2DialCode = 503 ;
]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=587 y=1534 ?>
          <!--InitiateAccessNumberCallback-->
          <function name="&quot;InitiateAccessNumberCallback&quot;" return="g_nReturnCode" external-function="1" library="lib_calltreatment.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_nPromptToPlay</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Success, Callback" link="1" stubbed="1" >g_nPromptToPlay == s_nPROMPT_CALLBACK
AND g_nReturnCode == s_sSUCCESS</result>
            <result name="Success, !Callback" >g_nReturnCode == s_sSUCCESS
AND g_nPromptToPlay != s_nPROMPT_CALLBACK</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[

if(Session.g_nReturnCode == Session.s_sSUCCESS && Session.g_nPromptToPlay == Session.s_nPROMPT_CALLBACK) {
	
	Session.g_nCurrentState = Session.s_nDIAL_OUT_A_ONLY;

	var oCallLegA = Session.g_oCallLegA;
	js_initCallLeg(Session.g_oCallLegA);
	Session.g_oCallLegA.oRate = oCallLegA.oRate;	
	
	Session.g_bInitiatedANCallback = true;
	
	if(Session.g_oSUB.strCallbackNumber.length > 0) {
		Session.g_strOutdialANumber = Session.g_oSUB.strCallbackNumber;
	} else {
		Session.g_strOutdialANumber = Session.g_oAPI.strOriginationNumber;
	}		
		
} 
]]></script>
          </scripts>
        </action>
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1158 y=1546 ?>
          <!--play balance?-->
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="g_oSUB.strPlayBalanceFlag==&quot;T&quot;" link="28" stubbed="0" >g_oSUB.strPlayBalanceFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.strOriginationType: " + Session.g_oAPI.strOriginationType);

if (Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strClickToDial) {


	if (Session.g_strC2DCalledNumber.length > 0)
	{
		Server.logInfo("CLIK TO DIAL AND HAS CALLED NUMBER, NO NEED TO GET DEST");
		Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;
		Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
	}
	else
	{
		Server.logInfo("CLICK TO DIAL AND HAS NO DEST, NEED TO GET DEST");
		Session.g_nCurrentState = Session.s_nGET_DESTINATION;
	}

	Session.g_strClick2DialStatus = "Connected." ;
	Session.g_nClick2DialCode = 200 ;
	
} else if (Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strMessageCallback) {	
	
	
	if (Session.g_strC2DCalledNumber.length > 0)
	{
		Server.logInfo("MESSAGE INITIATE CALL AND HAS CALLED NUMBER, NO NEED TO GET DEST");
		Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;
		Session.g_oAPI.strDestinationNumber = Session.g_strC2DCalledNumber;
	}
	else
	{
		Server.logInfo("MESSAGE INITIATE CALL AND HAS NO DEST, NEED TO GET DEST");
		Session.g_nCurrentState = Session.s_nGET_DESTINATION;
	}
	
	
} else {
	Session.g_nCurrentState = Session.s_nGET_DESTINATION;
}	]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Pactolus.Branch.1" ><?xtml-editor x=813 y=1506 ?>
          <results >
            <result name="Default" link="31" stubbed="0"/>
            <result name="oAPI.bALegRatingOn" link="34" stubbed="0" >g_oAPI.bALegRatingOn == true
</result>
          </results>
        </action>
        <action id="34" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=992 y=1635 ?>
          <!--StartALegTimer-->
          <function name="&quot;StartALegTimer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
        </action>
        <action id="35" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=346 y=1619 ?>
          <!--AuthenticatePinPrpdOrPopd-->
          <function name="&quot;AuthenticatePinPrpdOrPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="36" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=348 y=1743 ?>
          <!--GetPinNumberPrpdOrPopd-->
          <function name="&quot;GetPinNumberPrpdOrPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="37" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=342 y=1891 ?>
          <!--AuthenticatePinPopd-->
          <function name="&quot;AuthenticatePinPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="38" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=324 y=2015 ?>
          <!--GetPinNumberPopd-->
          <function name="&quot;GetPinNumberPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="39" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=345 y=2128 ?>
          <!--MainMenuPrpdOrPopd-->
          <function name="&quot;MainMenuPrpdOrPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
        <action id="40" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=334 y=2290 ?>
          <!--MainMenuPopd-->
          <function name="&quot;MainMenuPopd&quot;" return="g_nCurrentState" external-function="0" library=""/>
          <results >
            <result name="Default" link="1" stubbed="1"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnInvite" start="114" event="OnInvite" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAlertInfo" type="string" pass="byref"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAnonymity" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strCallInfo" type="string" pass="byref"/>
        <parameter name="strContact" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentEncoding" type="string" pass="byref"/>
        <parameter name="strContentLanguage" type="string" pass="byref"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strExpires" type="string"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strInReplyTo" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strMinSE" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strPriority" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRemotePartyId" type="string" pass="byref"/>
        <parameter name="strReplaces" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string"/>
        <parameter name="strRequire" type="string"/>
        <parameter name="strResponseKey" type="string"/>
        <parameter name="strRoute" type="string"/>
        <parameter name="strSessionExpires" type="string"/>
        <parameter name="strSubject" type="string"/>
        <parameter name="strSupported" type="string"/>
        <parameter name="strTimestamp" type="string"/>
        <parameter name="strTo" type="string"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string"/>
      </parameters>
      <local-vars >
        <var name="f_b_A_re_INVITE" type="boolean" >0</var>
        <var name="f_b_B_re_INVITE" type="boolean" >0</var>
        <var name="f_b_New_A_SDP" type="boolean" >0</var>
        <var name="f_b_New_B_SDP" type="boolean" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="114" plug-in="Pactolus.Branch.1" ><?xtml-editor x=12 y=30 ?>
          <!--New Call?-->
          <results >
            <result name="Default" link="113" stubbed="0"/>
            <result name="g_bNewCall" link="28" stubbed="0" >g_bNewCall == true</result>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=927 y=19 ?>
          <!--send to Main function-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.s_strTestModeFlag == "T")
{
	Session.g_oAPI.strInfoDigits = Session.g_oTEST.strTestInfoDigits;
}
else
{
	Session.g_oAPI.strInfoDigits = js_get_info_digits(Session.g_oCallLegA.strFrom);
	Server.logInfo("AFTER get info digits: <" + Session.g_oAPI.strInfoDigits + ">");
}



Session.g_nCurrentState = Session.s_nINITIALIZE_SESSION;

]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Pactolus.Branch.1" ><?xtml-editor x=244 y=43 ?>
          <!--use object save incoming info
s_strTestModeFlag==T-->
          <results >
            <result name="Default" link="126" stubbed="0"/>
            <result name="s_strTestModeFlag==T" link="124" stubbed="0" >s_strTestModeFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bNewCall = false;
Server.logInfo("CALLER CALL ID: " + Session.strCallId);
js_initAPI(Session.g_oAPI);
js_initACD(Session.g_oACD);
js_initBALXFER(Session.g_oBALXFER);
js_initCallLeg(Session.g_oCallLegA);
js_initCallLeg(Session.g_oCallLegB);
js_initACD(Session.g_oACD);
js_initCC(Session.g_oCC);
js_initMS(Session.g_oMS, Session.s_strMSType);
js_initRATE(Session.g_oRATE);
js_initSUB(Session.g_oSUB);
js_initMS(Session.g_oMOH, Session.s_strMSType);
js_initMS(Session.g_oConfMS, Session.s_strMSType);
js_initORIG_TYPES(Session.s_oORIG_TYPES);
js_initINITIATION_TYPES(Session.s_oINITIATION_TYPES);

Session.g_oMS.strACDType = Session.s_strACDMediaServerType;
Session.g_oMS.strMOHType = Session.s_strMOHMediaServerType;
Session.g_oConfMS.strACDType = Session.s_strACDMediaServerType;
Session.g_oConfMS.strMOHType = Session.s_strMOHMediaServerType;

Session.g_oAPI.lPlatformSessionStartTime = Server.getUTCTime();

Session.g_oCallLegA.strAccept = Session.strAccept;
Session.g_oCallLegA.strAcceptEncoding = Session.strAcceptEncoding;
Session.g_oCallLegA.strAcceptLanguage = Session.strAcceptLanguage;
Session.g_oCallLegA.strAlertInfo = Session.strAlertInfo;
Session.g_oCallLegA.strAllow = Session.strAllow;
Session.g_oCallLegA.strAllowEvents = Session.strAllowEvents;
Session.g_oCallLegA.strAnonymity = Session.strAnonymity;
Session.g_oCallLegA.strAuthorization = Session.strAuthorization;
Session.g_oCallLegA.strCallId = Session.strCallId;
Session.g_oCallLegA.strCallInfo = Session.strCallInfo;
Session.g_oCallLegA.strContact = Session.strContact;
Session.g_oCallLegA.strContent = Session.strContent;
Session.g_oCallLegA.strContentDisposition = Session.strContentDisposition;
Session.g_oCallLegA.strContentEncoding = Session.strContentEncoding;
Session.g_oCallLegA.strContentLanguage = Session.strContentLanguage;
Session.g_oCallLegA.strContentType = Session.strContentType;
Session.g_oCallLegA.strCSeq = Session.strCSeq;
Session.g_oCallLegA.strDate = Session.strDate;
Session.g_oCallLegA.strEncryption = Session.strEncryption;
Session.g_oCallLegA.strErrorInfo = Session.strErrorInfo;
Session.g_oCallLegA.strExpires = Session.strExpires;
Session.g_oCallLegA.strFrom = Session.strFrom;
Session.g_oCallLegA.strInReplyTo = Session.strInReplyTo;
Session.g_oCallLegA.strMaxForwards = Session.strMaxForwards;
Session.g_oCallLegA.strMIMEVersion = Session.strMIMEVersion;
Session.g_oCallLegA.strMinSE = Session.strMinSE;
Session.g_oCallLegA.strOrganization = Session.strOrganization;
Session.g_oCallLegA.strPriority = Session.strPriority;
Session.g_oCallLegA.strProxyAuthorization = Session.strProxyAuthorization;
Session.g_oCallLegA.strProxyRequire = Session.strProxyRequire;
Session.g_oCallLegA.strRecordRoute = Session.strRecordRoute;
Session.g_oCallLegA.strReferredBy = Session.strReferredBy;
Session.g_oCallLegA.strRemotePartyId = Session.strRemotePartyId;
Session.g_oCallLegA.strReplaces = Session.strReplaces;
Session.g_oCallLegA.strRequestUri = Session.strRequestUri;
Session.g_oCallLegA.strRequire = Session.strRequire;
Session.g_oCallLegA.strResponseKey = Session.strResponseKey;
Session.g_oCallLegA.strRoute = Session.strRoute;
Session.g_oCallLegA.strSessionExpires = Session.strSessionExpires;
Session.g_oCallLegA.strSubject = Session.strSubject;
Session.g_oCallLegA.strSupported = Session.strSupported;
Session.g_oCallLegA.strTimestamp = Session.strTimestamp;
Session.g_oCallLegA.strTo = Session.strTo;
Session.g_oCallLegA.strUserAgent = Session.strUserAgent;
Session.g_oCallLegA.strVia = Session.strVia;


//Ingress
var from_uri = new SipFrom( Session.strFrom ) ;
if (from_uri.url.host == undefined)
{
	Session.g_oAPI.strGWIPIngress = Session.s_strPrimaryPSX;
}
else
{
	Session.g_oAPI.strGWIPIngress = from_uri.url.host;
}
if (from_uri.url.port == undefined)
{
	Session.g_oAPI.nGWPortIngress = 5060;
}
else
{
	Session.g_oAPI.nGWPortIngress = from_uri.url.port;
}
//Egress
var contact = new SipNameAddr(Session.strContact);
if (contact.url.host == undefined)
{
	Session.g_oAPI.strGWIPEgress = Session.s_strPrimaryPSX;
}
else
{
	Session.g_oAPI.strGWIPEgress = contact.url.host;
}
if (contact.url.port == undefined)
{
	Session.g_oAPI.nGWPortEgress = 5060;
}
else
{
	Session.g_oAPI.nGWPortEgress = contact.url.port;
}

if(from_uri.url.otg != undefined) {
	Session.g_oCallLegA.strOrigTrunkGroup = from_uri.url.otg;
}

// Phone A object
Session.g_oCallLegA.bReverseFromTo = true;
Session.g_oCallLegA.bUac = false;
Session.g_oCallLegA.strOriginalContent = Session.strContent;
Session.g_oCallLegA.strRemoteSdp = Session.strContent;
Session.g_oCallLegA.strRemoteCSeq = Session.strCSeq;
Session.g_oCallLegA.nSessionTimer = Number(Session.strSessionExpires);
Session.g_oCallLegA.strOriginalTo = Session.strTo;

js_initTimer(Session.g_oTimerGSXA);
js_initTimer(Session.g_oTimerGSXB);

Session.g_oTimerGSXA.lSleepTime = Number(Session.strSessionExpires);
Session.g_oTimerGSXB.lSleepTime = Number(Session.strSessionExpires);

Server.logInfo("CALLING js_calculate_uri_and_route");
Server.logInfo("BEFORE contact: " + Session.g_oCallLegA.strContact);
Server.logInfo("BEFORE record route: " + Session.g_oCallLegA.strRecordRoute);
Server.logInfo("BEFORE request Uri: " + Session.g_oCallLegA.strRequestUri);
Server.logInfo("BEFORE route: " + Session.g_oCallLegA.strRoute);
var bDialIn = true;
js_calculate_uri_and_route(bDialIn, Session.s_strSIPVERSION, Session.g_oCallLegA.strFrom, Session.g_oCallLegA.strContact, Session.g_oCallLegA.strRecordRoute, Session.g_oCallLegA.strRequestUri, Session.g_oCallLegA.strRoute);
Server.logInfo("AFTER contact: " + Session.g_oCallLegA.strContact);
Server.logInfo("AFTER record route: " + Session.g_oCallLegA.strRecordRoute);
Server.logInfo("AFTER request Uri: " + Session.g_oCallLegA.strRequestUri);
Server.logInfo("AFTER route: " + Session.g_oCallLegA.strRoute);
Server.logInfo("Call leg A request Uri is: " + Session.g_oCallLegA.strRequestUri);
Session.g_oCallLegA.strRemoteUri = Session.g_oCallLegA.strRequestUri;
Server.logInfo("Call leg A remote Uri is: " + Session.g_oCallLegA.strRemoteUri);

Session.g_oCallLegA.nTearDownTime = 0;
if (Session.s_strSessionTimerFlag == "T")
{
	Session.g_oCallLegA.strSessionTimerFlag = Session.s_strSessionTimerFlag;
	Session.g_oCallLegA.nSessionTimer = Session.s_nSessionTimerInterval;
}
// if no ANI, use this default
var strANI = new String(from_uri.url.user);

if (from_uri.url.user == undefined ||
	strANI.length <= 0 ||
	strANI.indexOf("restricted") != -1 ||
	strANI.indexOf("Restricted") != -1	||
	strANI.indexOf("RESTRICTED")  != -1)
{
	Session.g_oAPI.strOriginationNumber = Session.s_strDEFAULT_ANI;
	Session.g_oCallLegA.strCallingNumber = Session.s_strDEFAULT_ANI;
	Session.g_oAPI.strUsedDefaultANIFlag = "T";
}
else
{
	Session.g_oCallLegA.strCallingNumber = from_uri.url.user;
	Session.g_oAPI.strOriginationNumber	= from_uri.url.user;
}
// get dnis
var myUri = new SipUrl(Session.strRequestUri);

Session.g_oAPI.strAccessNumber = myUri.phoneNumber;
Server.logInfo("ACCESS NUMBER IS: " + Session.g_oAPI.strAccessNumber);

var myTo = new SipTo (Session.strTo);
Session.g_oAPI.strDestinationNumber = myTo.url.user;

// set server contact
if( Server.sipPort != 5060 )
{
 Session.g_strContact = "sip:" + Session.s_strLocalHost + ":" + Server.sipPort + ">";
}
else
{
	Session.g_strContact = "<sip:" + Session.s_strLocalHost + ">";
}
// already build remote/request uri, set contact to appserver
Session.g_oCallLegA.strContact = Session.g_strContact;

Server.logInfo("PLATFORM SESSION ID:  " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("APPLICATION NAME:  " + Session._appName);
// Mediaserver object
Session.g_oMS.strContent = "";
Session.g_oMS.strCallId = "";
Session.g_oMS.strEndPoint = "";
Session.g_oMS.strConnectionId = "";
Session.g_oMS.strType = Session.s_strMSType;
Session.g_oMS.bCurrentlyConnected = false;
Session.g_oMS.nPacketizationPeriod = Session.s_nPacketizationPeriod;
Session.g_oMS.strCodec = Session.s_strCodec;

if (Session.s_strMSRetryFlag == "T")
{
	Session.g_oMS.bRetry = true;
}
else
{
	Session.g_oMS.bRetry = false;
}

// Phone B object
Session.g_oCallLegB.bReverseFromTo = false;
Session.g_oCallLegB.bCurrentlyDialing = false;
Session.g_oCallLegB.bAttemptedToOutdial = false;
Session.g_oCallLegB.bConnected = false;
Session.g_oCallLegB.strSessionTimerFlag = "";
Session.g_oCallLegB.nSessionTimer = "";
Session.g_oCallLegB.nRingNoAnswerTime = "";
Session.g_oCallLegB.strCallId = "";
Session.g_oCallLegB.strContent = "";
Session.g_oCallLegB.strCSeq = "";
Session.g_oCallLegB.strFrom = "";
Session.g_oCallLegB.strTo = "";
Session.g_oCallLegB.strRoute = "";
Session.g_oCallLegB.strRecordRoute = "";
Session.g_oCallLegB.strContact = "";
Session.g_oCallLegB.nSetUpTime = 0;
Session.g_oCallLegB.nTearDownTime = 0;



Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID; // Set default

if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD) {
	Session.g_oAPI.strPostPaidFlag = "T";
	Session.g_oACD.lCSRRequestSkillId = 3;
}
]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=18 y=602 ?>
          <return value=""/>
        </action>
        <action id="53" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=871 y=211 ?>
          <!--500 Server Error-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 500 Server Internal Error"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="115" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("TEST MODE, BUT FAIL TO GET TEST DATA");
Server.logError("RESPONSE WITH 500 Server Error");
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="66" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=668 y=299 ?>
          <!--481 Transaction does not exist-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 481 Call Leg/Transaction Does Not Exist"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("ERROR: GET REINVITE BUT TRANSACTION DOES NOT EXIST.");
Server.logError("ERROR: FROM: " + Session.strFrom);
Server.logError("ERROR: TO: " + Session.strTo);
Server.logError("ERROR: CALL ID: " + Session.strCallId);
Server.logError("ERROR: CSEQ: " + Session.strCSeq);
Server.logError("ERROR: CONTENT: " + Session.strContent);]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Pactolus.Branch.1" ><?xtml-editor x=170 y=415 ?>
          <!--connected to ms?-->
          <results >
            <result name="Default" link="83" stubbed="0"/>
            <result name="connected to ms == false" link="121" stubbed="0" >g_oMS.bCurrentlyConnected == false
AND g_oCallLegB.bConnected == true</result>
            <result name="during outdial" link="90" stubbed="0" >g_oCallLegB.bConnected == false
AND g_oMS.bCurrentlyConnected == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (0 == Clib.strcmpi(Session.strCallId, Session.g_oCallLegA.strCallId))
{
	Session.f_b_A_re_INVITE = true;
	var newCSeq = new SipCSeq(Session.strCSeq);
	var oldCSeq = new SipCSeq(Session.g_oCallLegA.strCSeq);

	if(newCSeq.value >= oldCSeq.value) 
	{
		newCSeq.increment() ;
		Session.g_oCallLegA.strCSeq = newCSeq.encode() ;
	}
	if (Clib.strcmpi(Session.strContent, Session.g_oCallLegA.strContent) != 0)
	{
		Session.f_b_New_A_SDP = true;
		Session.g_oCallLegA.strContent = Session.strContent;
		Session.g_oCallLegA.strOriginalContent = Session.strContent;
	}
}
else
{
	Session.f_b_B_re_INVITE = true;
	var newCSeq = new SipCSeq(Session.strCSeq);
	var oldCSeq = new SipCSeq(Session.g_oCallLegB.strCSeq);

	if(newCSeq.value >= oldCSeq.value) 
	{
		newCSeq.increment() ;
		Session.g_oCallLegB.strCSeq = newCSeq.encode() ;
	}
	if (Clib.strcmpi(Session.strContent, Session.g_oCallLegB.strContent) != 0)
	{
		Session.f_b_New_B_SDP = true;
		Session.g_oCallLegB.strContent = Session.strContent;
	}
}]]></script>
          </scripts>
        </action>
        <action id="83" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=419 y=369 ?>
          <!--200 OK SDP of MS-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <content >g_oMS.strContent</content>
            <content-type >s_strContentType</content-type>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="90" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=376 y=719 ?>
          <!--200 OK hold SDP A-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <content >g_oCallLegA.strContent</content>
            <content-type >s_strContentType</content-type>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="93" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=879 y=597 ?>
          <!--Hang Up Phone  B-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="96" stubbed="0"/>
          </results>
        </action>
        <action id="94" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1291 y=691 ?>
          <!--Re-originate-->
          <function name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Session.f_b_A_re_INVITE = false;
Session.f_b_B_re_INVITE = false;
Session.f_b_New_A_SDP = false;
Session.f_b_New_B_SDP = false;]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1081 y=585 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="118" stubbed="0"/>
            <result name="Success" link="94" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 9;
Session.f_nReturnCode = -50;]]></script>
          </scripts>
        </action>
        <action id="101" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=940 y=783 ?>
          <!--Hangup2Parties-->
          <function name="&quot;Hangup2Parties&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="115" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 9;
Session.g_oAPI.nSessionTerminationReason = 11;]]></script>
          </scripts>
        </action>
        <action id="113" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=279 ?>
          <!--re-invite from A or B?-->
          <results >
            <result name="Default" link="66" stubbed="0"/>
            <result name="re-invite from A or B" link="81" stubbed="0" >strCallId match g_oCallLegA.strCallId
OR strCallId match g_oCallLegB.strCallId</result>
          </results>
        </action>
        <action id="115" plug-in="Standard.EndSession.1" ><?xtml-editor x=14 y=666 ?></action>
        <action id="118" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1283 y=534 ?>
          <!--Hang Up Phone  A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="115" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="121" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=425 y=532 ?>
          <!--ProcessReInvite-->
          <function name="&quot;ProcessReInvite&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >f_b_A_re_INVITE</parameter>
            <parameter >f_b_New_A_SDP</parameter>
            <parameter >f_b_B_re_INVITE</parameter>
            <parameter >f_b_New_B_SDP</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerPhoneB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >strContentType</parameter>
            <parameter >g_strContact</parameter>
            <parameter >strCallId</parameter>
            <parameter >strCSeq</parameter>
            <parameter >strTo</parameter>
            <parameter >strFrom</parameter>
            <parameter >strVia</parameter>
            <parameter >strSessionExpires</parameter>
          </function>
          <results >
            <result name="Default" link="33" stubbed="1"/>
            <result name="Send 481" link="66" stubbed="0" >f_nReturnCode == 1</result>
            <result name="-2" link="123" stubbed="0" >f_nReturnCode == -2</result>
            <result name="-3" link="122" stubbed="0" >f_nReturnCode == -3</result>
          </results>
        </action>
        <action id="122" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=701 y=788 ?>
          <!--StopTimers-->
          <function name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneB</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="101" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
        <action id="123" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=661 y=600 ?>
          <!--StopTimers-->
          <function name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="93" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
        <action id="124" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=471 y=187 ?>
          <!--APIGetTestData-->
          <function name="&quot;APIGetTestData&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oTEST</parameter>
          </function>
          <results >
            <result name="Default" link="53" stubbed="0"/>
            <result name="Success" link="126" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_initTEST(Session.g_oTEST);
Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (0 == Session.f_nReturnCode)
{
	Session.g_oAPI.strOriginationNumber = Session.g_oTEST.strTestOriginationNumber;
	
	if (Session.g_oAPI.strOriginationNumber == "undefined" ||
		Session.g_oAPI.strOriginationNumber == undefined ||
		Session.g_oAPI.strOriginationNumber.length <= 0 ||
		Session.g_oAPI.strOriginationNumber.indexOf("restricted") != -1 ||
		Session.g_oAPI.strOriginationNumber.indexOf("Restricted") != -1	||
		Session.g_oAPI.strOriginationNumber.indexOf("RESTRICTED")  != -1)
	{
		Session.g_oAPI.strOriginationNumber = Session.s_strDEFAULT_ANI;
		Session.g_oCallLegA.strCallingNumber = Session.s_strDEFAULT_ANI;
		Session.g_oAPI.strUsedDefaultANIFlag = "T";
	}	
		
	
	
	

	Server.logInfo("BEFORE strip non digit off original number: <" + Session.g_oAPI.strOriginationNumber + " >");
	Session.g_oAPI.strOriginationNumber = js_strip_non_digits(Session.g_oAPI.strOriginationNumber);
	Server.logInfo("AFTER strip non digit off original number: <" + Session.g_oAPI.strOriginationNumber + " >");
}
else
{
	Server.logError("ERROR: FAIL TO GET TEST DATA");
}]]></script>
          </scripts>
        </action>
        <action id="125" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=736 y=94 ?>
          <!--"SingleStageDialing"-->
          <function name="&quot;SingleStageDialing&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
        </action>
        <action id="126" plug-in="Pactolus.Branch.1" ><?xtml-editor x=456 y=37 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="g_bSingleStageDialing" link="125" stubbed="0" >g_bSingleStageDialing == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var myString = new String(Session.g_oAPI.strDestinationNumber);
if ( '0' == myString.charAt(0) )
{
	Session.g_bSingleStageDialing = true;
	Server.logInfo("THIS IS SINGLE STAGE DIALING.  DESTINATION NUMBER IS: " + myString);
	Session.g_oAPI.strServiceProviderCode = myString.substr(1, 4);
	Server.logInfo("SERVICE PROVIDER CODE IS: " + Session.g_oAPI.strServiceProviderCode);
	Session.g_oAPI.strDestinationNumber = myString.substr(5);
	Server.logInfo("DESTINATION NUMBER IS: " + Session.g_oAPI.strDestinationNumber);	
	Session.g_oAPI.strAccessNumber = "";
}
else
{
	Session.g_bSingleStageDialing = false;
	Server.logInfo("THIS IS NOT SINGLE STAGE DIALING.  DESTINATION NUMBER IS: " + Session.g_oAPI.strDestinationNumber);
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="InitializeSession" start="85" event="InitializeSession" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nLanguageMenuPrompt" type="i4" >4163</var>
      </local-vars>
      <actions >
        <action id="85" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=21 y=45 ?>
          <!--psAPIInitializeSession-->
          <function name="&quot;psAPIInitializeSession&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="Success, bCallback" link="72" stubbed="1" >f_nReturnCode == s_sSUCCESS
AND g_oAPI.bANCallbackFlag == true</result>
            <result name="Fail, bCallback" link="95" stubbed="1" >f_nReturnCode != 0
AND g_oAPI.bANCallbackFlag == true</result>
            <result name="Success" link="90" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("InitializeSession returned " + Session.f_nReturnCode);
Session.g_sMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA INITIALIZE SESSION, EXIT ON: " + Result.name);
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1002; //bad ani
			Session.g_oAPI.nSessionTerminationReason = 9;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 2;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1004; //service disable
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
	
		Session.g_oACD.strPinZeroOut = "T";
		Session.g_oACD.strLanguageMenuZeroOut = "T";
		Session.g_oACD.strMainMenuZeroOut = "T";					
	
		if(Session.g_oACD.strCSROnMaxLoginsEnabled == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
			Session.g_oACD.strPinMaxTimeouts = "T";		
			Session.g_oACD.strPinMaxInvalids = "T";
			Session.g_oACD.strMainMenuMaxInvalids = "T";
			Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
		} // end if 

		// Settings Based on Customer
		Session.g_oACD.strDestMaxInvalids = "F";
		Session.g_oACD.strDestMaxTimeouts = "F";
		Session.g_oACD.strDestZeroOut = "F";		
				
		Session.g_oACD.strMainMenuMaxTimeouts = "F";
		Session.g_oACD.strLanguageMenuMaxTimeouts = "F";				

		
	} // end strEnableFlag		

} // end return code

Server.logInfo("g_oACD.strPinZeroOut " + Session.g_oACD.strPinZeroOut);
Server.logInfo("g_oACD.strLanguageMenuZeroOut " + Session.g_oACD.strLanguageMenuZeroOut);
Server.logInfo("g_oACD.strMainMenuZeroOut " + Session.g_oACD.strMainMenuZeroOut);
Server.logInfo("g_oACD.strPinMaxTimeouts " + Session.g_oACD.strPinMaxTimeouts);
Server.logInfo("g_oACD.strPinMaxInvalids " + Session.g_oACD.strPinMaxInvalids);
Server.logInfo("g_oACD.strMainMenuMaxInvalids " + Session.g_oACD.strMainMenuMaxInvalids);
Server.logInfo("g_oACD.strLanguageMenuMaxInvalids " + Session.g_oACD.strLanguageMenuMaxInvalids);
Server.logInfo("g_oACD.strDestMaxInvalids " + Session.g_oACD.strDestMaxInvalids);
Server.logInfo("g_oACD.strDestMaxTimeouts " + Session.g_oACD.strDestMaxTimeouts);
Server.logInfo("g_oACD.strDestZeroOut " + Session.g_oACD.strDestZeroOut);
Server.logInfo("g_oACD.strMainMenuMaxTimeouts " + Session.g_oACD.strMainMenuMaxTimeouts);
Server.logInfo("g_oACD.strLanguageMenuMaxTimeouts " + Session.g_oACD.strLanguageMenuMaxTimeouts);

Session.g_oSUB.strPinLanguage = Session.g_oAPI.strLanguage;


if(Session.g_oAPI.bANCallbackFlag) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegAccessNbrIniatedCallback;
	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strAccessNumCallback;
}



if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD) {
	
	Session.g_oAPI.strPostPaidFlag = "T";
	Session.g_oACD.lCSRRequestSkillId = 3;
	
	if (0 == Session.g_oAPI.nAccountNumLength) 	{
		Session.g_oSUB.strDigitMapAccountNbr = "(xxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {
		
		var temp_digits = "(";
		for (var i = 0; i < Session.g_oAPI.nAccountNumLength; i++) 	{
			temp_digits += "x";
		}
		Session.g_oSUB.strDigitMapAccountNbr = temp_digits + "|x.T|x.#|xx.*|*x)";
	}	
	
	if (0 == Session.g_oAPI.nPostpaidPinLength) {
		Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {
		var temp_digits = "(";
		for (var i = 0; i < Session.g_oAPI.nPostpaidPinLength; i++) 	{
			temp_digits += "x";
		}
		
		Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
	}
	
	if(Session.g_oSUB.strAccountNumber.length > 0 && Session.g_oSUB.strUserPin.length > 0) {
		Session.g_oAPI.strValidateByANI = "1";
		Session.g_bValidateByANI = true;		
		Session.g_oSUB.strUserPin = Session.g_oSUB.strAccountNumber + Session.g_oSUB.strUserPin;
		Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;
	} else if(Session.g_oSUB.strAccountNumber.length > 0 && Session.g_oSUB.strUserPin.length <= 0) {
		Session.g_oAPI.strValidateByANI = "2";
		Session.g_strAuthenticationNbr = Session.g_oSUB.strAccountNumber;		
		Session.g_bGetPinOnly = true;
		// Will need to get pin only
	} else {
		// Will need to get account number and pin
	}

} else if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_PRPD) {


	if (0 == Session.g_oAPI.nPinLength) {
		Session.g_oSUB.strPinDigitMap = "(xxxxxxxxxxxxxxxxxxxx|x.T|x.#|xx.*|*x)";
	} else {
		var temp_digits = "(";
		for (var i = 0; i < Session.g_oAPI.nPinLength; i++) 	{
			temp_digits += "x";
		}
		
		Session.g_oSUB.strPinDigitMap = temp_digits + "|x.T|x.#|xx.*|*x)";
	}


	Session.g_oAPI.strValidateByANI = "F";
	if(Session.g_oSUB.strUserPin.length > 0) {
		Session.g_bValidateByANI = true;
	}


}






]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=275 y=610 ?>
          <!--s_nSTATE_GET_PIN_PRPD_OR_POPD-->
          <return value="s_nSTATE_GET_PIN_PRPD_OR_POPD"/>
        </action>
        <action id="34" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=316 y=23 ?>
          <!--503 service unavailable-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 503 Service Unavailable"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="65" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("ERROR: INITIALIZE SESSION FAILS, RESPONSE 503 SERVICE UNAVAILABLE");
var myTo = new SipTo(Session.g_oCallLegA.strTo);
if (undefined == myTo.tag)
{
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strTo + ";tag=" + Server.getUTCTime();
}]]></script>
          </scripts>
        </action>
        <action id="59" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=748 y=258 ?>
          <!--send JAVA ALARM-->
          <SOAP destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="96" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "JAVA: initialize session";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=781 y=71 ?>
          <!--send MEDIASERVER ALARM-->
          <SOAP destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="84" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: connect caller to ms";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Pactolus.Branch.1" ><?xtml-editor x=537 y=176 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="82" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="59" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="65" plug-in="Pactolus.Branch.1" ><?xtml-editor x=535 y=50 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="84" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="61" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="71" plug-in="Pactolus.Branch.1" ><?xtml-editor x=41 y=426 ?>
          <results >
            <result name="Default" link="72" stubbed="1"/>
            <result name="ACD.strGreetEnabled" link="89" stubbed="0" >g_oACD.strGreetEnabled match "T"</result>
            <result name="playLanguageMenu = T" link="94" stubbed="0" >s_strPLAY_LANGUAGE_MENU match "T"</result>
            <result name="!bValidateByANI" link="5" stubbed="0" >g_bValidateByANI == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_oSUB.strUserPin.length <= 0)
	Session.g_bNullFlag = true;
else
{
	Session.g_bNullFlag = false;
	Session.g_bValidateByANI = true;
}
	]]></script>
          </scripts>
        </action>
        <action id="72" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=23 y=671 ?>
          <!--s_nSTATE_AUTH_PRPD_OR_POST-->
          <return value="s_nSTATE_AUTH_PRPD_OR_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("SET THE CURRENT STATE TO *** AUTHENTICATE_PIN *** ");]]></script>
          </scripts>
        </action>
        <action id="73" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=334 y=229 ?>
          <!--send alert db error-->
          <user-function process="&quot;PACTOLUS_ps_snmp_event&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"dbase-error"</parameter>
          </user-function>
          <results >
            <result name="Default" link="63" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=15 y=852 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="83" stubbed="0"/>
          </results>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=247 y=870 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="84" stubbed="0"/>
          </results>
        </action>
        <action id="84" plug-in="Standard.EndSession.1" ><?xtml-editor x=532 y=888 ?></action>
        <action id="87" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=689 y=384 ?>
          <!--RouteToCSR-->
          <function name="&quot;RouteToCSR&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="82" stubbed="1"/>
            <result name="Success" link="88" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.lCSRRequestSkillId = 1;
Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
Session.g_oACD.nCSRRouteReasonCode = 1;

js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="88" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=934 y=422 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="89" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=464 y=371 ?>
          <!--please hold for csr-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1501</audio>
          </play>
          <results >
            <result name="Default" link="87" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="90" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=52 y=227 ?>
          <!--direct caller to MS-->
          <function name="&quot;DirectCallerToMS&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="34" stubbed="0"/>
            <result name="Success" link="71" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="84" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
	Session.g_bFailToConnectToMS = true;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
	Session.g_bFailToConnectToMS = true;
}
else
{
	Session.g_bSentFinalResponse = true;
}]]></script>
          </scripts>
        </action>
        <action id="94" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=316 y=520 ?>
          <!--return s_nSTATE_LANGUAGE_MENU-->
          <return value="s_nSTATE_LANGUAGE_MENU"/>
        </action>
        <action id="95" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=26 y=770 ?>
          <!--s_nSTATE_INIT_AN_CALLBACK-->
          <return value="s_nSTATE_INIT_AN_CALLBACK"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nPromptToPlay = 283; //The system cannot call you back at this number.

]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=959 y=240 ?>
          <!--direct caller to MS-->
          <function name="&quot;DirectCallerToMS&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="84" stubbed="1"/>
            <result name="Success" link="82" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_bFailToConnectToMS = true;
}
else if (3 == Result.id)
{
	Session.g_bFailToConnectToMS = true;
}
else
{
	Session.g_bSentFinalResponse = true;
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="AuthenticatePin" start="117" event="AuthenticatePin" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bRequestCSR" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bNull" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="117" plug-in="Pactolus.Branch.1" ><?xtml-editor x=12 y=24 ?>
          <results >
            <result name="Default" link="102" stubbed="0"/>
            <result name="bANCallbackFlag" link="116" stubbed="1" >g_oAPI.bANCallbackFlag == true</result>
          </results>
        </action>
        <action id="15" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1294 y=38 ?>
          <!--return s_nGET_DESTINATION-->
          <return value="s_nGET_DESTINATION"/>
        </action>
        <action id="17" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1131 y=121 ?>
          <!--502: Your account balance is ...-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >503</audio>
            <audio type="currency" >g_oSUB.fPrepaidBalance</audio>
          </play>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="42" plug-in="Pactolus.Branch.1" ><?xtml-editor x=889 y=25 ?>
          <!--play balance?-->
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="g_oSUB.strPlayBalanceFlag==&quot;T&quot;" link="17" stubbed="0" >g_oSUB.strPlayBalanceFlag match "T"</result>
          </results>
        </action>
        <action id="47" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=686 y=126 ?>
          <!--Post Pin Prompt URL-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strPostPinPromptUrl</audio>
          </play>
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="75" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=30 y=1166 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="0"/>
          </results>
        </action>
        <action id="76" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=258 y=1167 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="77" stubbed="0"/>
          </results>
        </action>
        <action id="77" plug-in="Standard.EndSession.1" ><?xtml-editor x=489 y=1198 ?></action>
        <action id="84" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=794 y=439 ?>
          <!--get pin again-->
          <return value="s_nGET_PIN"/>
        </action>
        <action id="85" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=291 y=526 ?>
          <!--507-low balance-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="112" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="!bGotRechargeSettings" link="97" stubbed="0" >g_bGotRechargeSettings == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="86" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=959 y=604 ?>
          <!--main menu-->
          <return value="s_nMAIN_MENU"/>
        </action>
        <action id="89" plug-in="Pactolus.Branch.1" ><?xtml-editor x=454 y=36 ?>
          <!--g_oAPI.strPostPinPromptType = U or I-->
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="g_oAPI.strPostPinPromptType==U" link="47" stubbed="0" >g_oAPI.strPostPinPromptType match "U"</result>
            <result name="g_oAPI.strPostPinPromptType==I" link="90" stubbed="0" >g_oAPI.strPostPinPromptType match "I"
AND g_oAPI.nPostPinPromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="90" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=690 y=261 ?>
          <!--post pin prompt index-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nPostPinPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="92" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=325 y=398 ?>
          <!--g_nPromptToPlay-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="93" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=532 y=714 ?>
          <!--reason prompt-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="returnCode = 8" link="110" stubbed="1" >f_nReturnCode == 8</result>
          </results>
        </action>
        <action id="94" plug-in="Pactolus.Branch.1" ><?xtml-editor x=561 y=420 ?>
          <!--max retry-->
          <results >
            <result name="Default" link="110" stubbed="1"/>
            <result name="nNumRetry&lt;oAPI.nMaxLoginAttempts" link="84" stubbed="0" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oAPI.nCallTerminationReason = 2;

	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinInvalids;	
	
}]]></script>
          </scripts>
        </action>
        <action id="95" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=471 y=848 ?>
          <!--pin in used-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >338</audio>
          </play>
          <results >
            <result name="Default" link="75" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=13 y=345 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="113" stubbed="0"/>
            <result name="Get Dest" link="119" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Get Pin Again" link="92" stubbed="0" >f_nReturnCode == 6</result>
            <result name="Recharge" link="85" stubbed="0" >f_nReturnCode == 1</result>
            <result name="Play Reason" link="114" stubbed="0" >f_nReturnCode == 3
OR f_nReturnCode == 4
OR f_nReturnCode == 7
OR f_nReturnCode == 8
OR f_nReturnCode == 10
OR f_nReturnCode == 11
OR f_nReturnCode == 12</result>
            <result name="Pin Locked" link="115" stubbed="0" >f_nReturnCode == 5</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);


js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();
Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;							
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;					
				
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
]]></script>
          </scripts>
        </action>
        <action id="97" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=511 y=601 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="75" stubbed="1"/>
            <result name="Success" link="112" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);
if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Server.logError("FAIL TO GET RECHARGE SETTINGS");
	Session.g_nErrorMsgNumber = 1000; //jvm server error
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="102" plug-in="Pactolus.Branch.1" ><?xtml-editor x=14 y=162 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="96" stubbed="0"/>
            <result name="Misdial" link="94" stubbed="1" >f_bMissDial == true</result>
            <result name="Request CSR" link="110" stubbed="1" >f_bRequestCSR == true</result>
            <result name="Null" link="92" stubbed="1" >f_bNull == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oSUB.strUserPin.length <= 0) {

	Session.g_nPromptToPlay = 552; // I did not hear a response.
	Session.f_bNull = true;
	Session.g_oAPI.nSessionTerminationReason = 6;

} else if("*" == Session.g_strTerminationDigit || "*" == Session.g_oSUB.strUserPin) {

	Session.f_bMissDial = true;

} else if("0" == Session.g_oSUB.strUserPin) {

	Session.f_bRequestCSR = true;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinZeroOut;
}

Session.g_nNumRetry++;

]]></script>
          </scripts>
        </action>
        <action id="110" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=29 y=1078 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oSUB.strUserPin = "";
Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;]]></script>
          </scripts>
        </action>
        <action id="112" plug-in="Pactolus.Branch.1" ><?xtml-editor x=753 y=584 ?>
          <!--recharge and bal xfer-->
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="MainMenu &amp;&amp; (Recharge | Bal Xfer)" link="86" stubbed="0" >(g_oBALXFER.strBalanceTransferFlag match "T"
OR g_oCC.strRechargableFlag match "T")
AND g_oAPI.strMainMenuFlag == "T"</result>
          </results>
        </action>
        <action id="113" plug-in="Pactolus.Branch.1" ><?xtml-editor x=271 y=244 ?>
          <results >
            <result name="Default" link="75" stubbed="1"/>
            <result name="g_bValidateByANI" link="84" stubbed="1" >g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_bValidateByANI = false;
	Session.g_oSUB.strUserPin = "";
}]]></script>
          </scripts>
        </action>
        <action id="114" plug-in="Pactolus.Branch.1" ><?xtml-editor x=289 y=711 ?>
          <results >
            <result name="Default" link="93" stubbed="0"/>
            <result name="g_bValidateByANI" link="84" stubbed="1" >g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_bValidateByANI = false;
	Session.g_oSUB.strUserPin = "";
}]]></script>
          </scripts>
        </action>
        <action id="115" plug-in="Pactolus.Branch.1" ><?xtml-editor x=247 y=844 ?>
          <results >
            <result name="Default" link="95" stubbed="0"/>
            <result name="g_bValidateByANI" link="84" stubbed="1" >g_bValidateByANI == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_bValidateByANI = false;
	Session.g_oSUB.strUserPin = "";
}]]></script>
          </scripts>
        </action>
        <action id="116" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=27 y=906 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="120" stubbed="0"/>
            <result name="Get Dest" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Get Pin Again" >f_nReturnCode == 6</result>
            <result name="Recharge" >f_nReturnCode == 1</result>
            <result name="Play Reason" >f_nReturnCode == 3
OR f_nReturnCode == 4
OR f_nReturnCode == 7
OR f_nReturnCode == 8
OR f_nReturnCode == 10
OR f_nReturnCode == 11
OR f_nReturnCode == 12</result>
            <result name="Pin Locked" >f_nReturnCode == 5</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);


js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();

// Default to Auth Dest. If we fail here, we will set this to s_nSTATE_INIT_AN_CALLBACK.
Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;

Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}


if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK; //The system cannot call you back at this number

	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			//Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				//Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				//Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;							
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //inactive pin
			//Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;					
				
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {


	Session.g_nPromptToPlay = Session.s_nPROMPT_CALLBACK; // Please call back then.

}
]]></script>
          </scripts>
        </action>
        <action id="118" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=508 y=1022 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
        </action>
        <action id="119" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=250 y=93 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="89" stubbed="0"/>
          </results>
        </action>
        <action id="120" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=238 y=1013 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="AuthorizeDestination" start="79" event="AuthorizeDestination" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_bNull" type="boolean" >0</var>
        <var name="f_bMainMenu" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bIsDestValid" type="boolean" >0</var>
        <var name="f_nPrompt" type="i4" >380</var>
      </local-vars>
      <actions >
        <action id="79" plug-in="Pactolus.Branch.1" ><?xtml-editor x=13 y=28 ?>
          <results >
            <result name="Default" link="77" stubbed="0"/>
            <result name="bANCallbackFlag, !bInitANCB" link="80" stubbed="1" >g_oAPI.bANCallbackFlag == true
AND g_bInitiatedANCallback == false</result>
          </results>
        </action>
        <action id="10" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1689 y=360 ?>
          <!--return s_nMAKE_CONNECTION-->
          <return value="s_nMAKE_CONNECTION"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Phone B object
Session.g_oCallLegB.bReverseFromTo = false;
Session.g_oCallLegB.bCurrentlyDialing = false;
Session.g_oCallLegB.bAttemptedToOutdial = false;
Session.g_oCallLegB.bConnected = false;
Session.g_oCallLegB.strSessionTimerFlag = Session.s_strSessionTimerFlag;
Session.g_oCallLegB.nSessionTimer = Session.s_nSessionTimerInterval;
Session.g_oCallLegB.nRingNoAnswerTime = Session.s_nRING_NO_ANSWER_TIME;

if(Session.g_oAPI.strPrimarySoftswitchIP.length > 0) {
	Session.g_oCallLegB.strRequestUri = Session.g_oAPI.strPrimarySoftswitchIP;
} else {
	Session.g_oCallLegB.strRequestUri = Session.s_strPrimaryPSX;
}

if(Session.g_oAPI.strBackupSoftswitchIP.length > 0) {
	Session.g_oCallLegB.strBackupRequestUri = Session.g_oAPI.strBackupSoftswitchIP;
} else {
	Session.g_oCallLegB.strBackupRequestUri = Session.s_strBackupPSX;
}
Session.g_oCallLegB.strCallId = "";
Session.g_oCallLegB.strContent = "";
Session.g_oCallLegB.strCSeq = "";
Session.g_oCallLegB.strFrom = "";
Session.g_oCallLegB.strTo = "";
Session.g_oCallLegB.strRoute = "";
Session.g_oCallLegB.strRecordRoute = "";
Session.g_oCallLegB.strContact = "";
Session.g_oCallLegB.nSetUpTime = 0;
Session.g_oCallLegB.nTearDownTime = 0;
Session.g_oCallLegB.strCodec = Session.s_strCodec;]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Pactolus.Branch.1" ><?xtml-editor x=311 y=366 ?>
          <!--g_oAPI.strPostDestPromptType= U or I-->
          <results >
            <result name="Default" link="53" stubbed="0"/>
            <result name="g_oAPI.strPostDestPromptType==U" link="34" stubbed="0" >g_oAPI.strPostDestPromptType match "U"</result>
            <result name="g_oAPI.strPostDestPromptType==I" link="67" stubbed="0" >g_oAPI.strPostDestPromptType match "I"
AND g_oAPI.nPostDestPromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;

Session.g_oAPI.strDestinationNumber = Session.g_oCallLegB.strOutdialDestNbr;
]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=662 y=453 ?>
          <!--strPostDestPromptURL-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strPostDestPromptUrl</audio>
          </play>
          <results >
            <result name="Default" link="53" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="51" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1056 y=530 ?>
          <!--play time available-->
          <function name="&quot;PlayTimeAvailable&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="82" stubbed="0"/>
          </results>
        </action>
        <action id="53" plug-in="Pactolus.Branch.1" ><?xtml-editor x=879 y=391 ?>
          <!--play time avail?-->
          <results >
            <result name="Default" link="84" stubbed="0"/>
            <result name="PlayTime" link="51" stubbed="0" >g_oSUB.strPlayTimeAvailableFlag match "T"
AND g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="67" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=496 y=559 ?>
          <!--g_oAPI.nPostDestPromptIndex-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nPostDestPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="53" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="68" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=173 y=661 ?>
          <!--g_nPromptToPlay-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="69" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="69" plug-in="Pactolus.Branch.1" ><?xtml-editor x=390 y=708 ?>
          <!--max retry-->
          <results >
            <result name="Default" link="71" stubbed="1"/>
            <result name="intMaxRetry &lt; oAPI.nMaxLoginAttempts" link="70" stubbed="0" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
        </action>
        <action id="70" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=632 y=728 ?>
          <!--s_nGET_DESTINATION-->
          <return value="s_nGET_DESTINATION"/>
        </action>
        <action id="71" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=518 y=202 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="72" stubbed="0"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.EndSession.1" ><?xtml-editor x=734 y=213 ?></action>
        <action id="73" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=282 y=246 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="71" stubbed="0"/>
          </results>
        </action>
        <action id="74" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=22 y=347 ?>
          <!--psAPIAuthorizeDestination-->
          <function name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="33" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 1</result>
            <result name="-3,-4,-6,-7, -8, -9: Get Dest Again" link="68" stubbed="0" >f_nReturnCode == -3
OR f_nReturnCode == -4
OR f_nReturnCode == -6
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);
Session.g_oAPI.bALegCallback = false;
Session.g_oRATE.fAlegMeteredRate = Session.g_oCallLegA.oRATE.fAlegMeteredRate;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;							
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="77" plug-in="Pactolus.Branch.1" ><?xtml-editor x=32 y=152 ?>
          <!--null string?-->
          <results >
            <result name="Default" link="74" stubbed="0"/>
            <result name="main menu" link="78" stubbed="0" >f_bMainMenu == true</result>
            <result name="miss dial" link="69" stubbed="1" >f_bMissDial == true</result>
            <result name="Invalid or Null" link="68" stubbed="1" >f_bIsDestValid == false
OR f_bNull == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nPromptToPlay = 0;
Session.g_nErrorMsgNumber = 0;

Session.g_nNumRetry++;

if(Session.g_oAPI.strDestinationNumber.length <= 0) {

	Session.g_nPromptToPlay = 552; // I did not hear a response.
	Session.f_bNull = true;
	Session.g_oAPI.nSessionTerminationReason = 6;
	
} else if("*" == Session.g_strTerminationDigit && "*" == Session.g_oAPI.strDestinationNumber && "T" == Session.g_oAPI.strMainMenuFlag) {

	Session.f_bMainMenu = true; 		
	
} else if(Session.s_strCustomerCode == "latinode" && Session.g_oAPI.strDestinationNumber.length != 2 && Session.g_oAPI.strDestinationNumber.length < 10) {	

	Session.g_nPromptToPlay = Session.f_nPrompt; // ?
	Session.f_bIsDestValid = false;
	
	
} else if("*" == Session.g_strTerminationDigit) {

	Session.f_bMissDial = true;

} else if('0' == Session.g_oAPI.strDestinationNumber.charAt(0) && 1 == Session.g_oAPI.nDialingPlanId) {

		if ( '1' == Session.g_oAPI.strDestinationNumber.charAt(1) && '1' == Session.g_oAPI.strDestinationNumber.charAt(2)) {
			Session.f_bIsDestValid = true;
		} else {
			Session.f_bIsDestValid = false;
			Session.g_nPromptToPlay = 514;
		} // end if charAt(1) == 1, charAt(2) == 2;
		
} else {

	Session.f_bIsDestValid = true;
	
}
]]></script>
          </scripts>
        </action>
        <action id="78" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=291 y=151 ?>
          <!--s_nSTATE_MAIN_MENU_PRPD_OR_POPD-->
          <return value="s_nSTATE_MAIN_MENU_PRPD_OR_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strTerminationDigit = "";
Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="80" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=21 y=843 ?>
          <!--psAPIAuthorizeDestination-->
          <function name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="81" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" >f_nReturnCode == 0
OR f_nReturnCode == 1</result>
            <result name="-3,-4,-6,-7, -8, -9: Get Dest Again" >f_nReturnCode == -3
OR f_nReturnCode == -4
OR f_nReturnCode == -6
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);
Session.g_oAPI.bALegCallback = true;



var myString = new String ("");

if(Session.g_oSUB.strCallbackNumber.length > 0) {
	myString = new String (Session.g_oSUB.strCallbackNumber);	
} else if(Session.g_oAPI.strOriginationNumber.length > 0) {
	myString = new String (Session.g_oAPI.strOriginationNumber);		
} else {
	Server.logError("Attempting to authorize destination for A leg callback but callback number and ANI are empty.");
}		

var myArray = myString.split("x");
Session.g_oAPI.strDestinationNumber = myArray[0];]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 1)
{
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK;

	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			//Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			//Session.g_nPromptToPlay = 514;							
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {
	Session.g_nPromptToPlay = Session.s_nPROMPT_CALLBACK;
}


Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=284 y=944 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
        </action>
        <action id="82" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1369 y=388 ?>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="C2D or Msg Init" link="83" stubbed="0" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback</result>
          </results>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1566 y=538 ?>
          <!--PlayOnePrompt-->
          <function name="&quot;PlayOnePrompt&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_nPromptToPlay</parameter>
          </function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nPromptToPlay = 517; // PLease hold while your call...]]></script>
          </scripts>
        </action>
        <action id="84" plug-in="Pactolus.Branch.1" ><?xtml-editor x=972 y=255 ?>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="creditLimitFlag = T" link="85" stubbed="0" >g_oAPI.strCreditLimitFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="85" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1127 y=344 ?>
          <!--"PlayTimeAvailable"-->
          <function name="&quot;PlayTimeAvailable&quot;" return="" external-function="0" library="lib_utils.xml"/>
          <results >
            <result name="Default" link="82" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="Connect" start="93" event="Connect" returns="i4" >
      <local-vars >
        <var name="f_sStatus" type="i2" >0</var>
        <var name="f_lStartTime" type="i8" >0</var>
        <var name="f_lEndTime" type="i8" >0</var>
        <var name="f_nDuration" type="i4" >0</var>
        <var name="f_nTimerAFirstTimer" type="i4" >60</var>
        <var name="f_nTimerBFirstTimer" type="i4" >60</var>
        <var name="f_nBUSY" type="i4" >2</var>
        <var name="f_nCALLEDPARTYERROR" type="i4" >-2</var>
        <var name="f_nCALLINGPARTYERROR" type="i4" >-3</var>
        <var name="f_nDTMFINTERRUPTED" type="i4" >3</var>
        <var name="f_nOTHERERROR" type="i4" >-4</var>
        <var name="f_nRESOURCEUNAVAIL" type="i4" >-5</var>
        <var name="f_nRINGNOANSWER" type="i4" >1</var>
        <var name="f_nSUCCESS" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_strContentON" type="string" >ON</var>
      </local-vars>
      <actions >
        <action id="93" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=14 y=30 ?>
          <!--Delete MS Connection-->
          <function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="130" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if("T" == Session.g_oAPI.strOutdialOperatorFlag && "T" != Session.g_oACD.strCSRDidOutdial) {
	Session.g_oCallLegB.bReverseFromTo = false;
	Session.g_oCallLegB.bCurrentlyDialing = false;
	Session.g_oCallLegB.bAttemptedToOutdial = false;
	Session.g_oCallLegB.bConnected = false;
	Session.g_oCallLegB.strSessionTimerFlag = Session.s_strSessionTimerFlag;
	Session.g_oCallLegB.nSessionTimer = Session.s_nSessionTimerInterval;
	Session.g_oCallLegB.nRingNoAnswerTime = Session.s_nRING_NO_ANSWER_TIME;
	
	if(Session.g_oAPI.strPrimarySoftswitchIP.length > 0) {
		Session.g_oCallLegB.strRequestUri = Session.g_oAPI.strPrimarySoftswitchIP;
	} else {
		Session.g_oCallLegB.strRequestUri = Session.s_strPrimaryPSX;
	}

	if(Session.g_oAPI.strBackupSoftswitchIP.length > 0) {
		Session.g_oCallLegB.strBackupRequestUri = Session.g_oAPI.strBackupSoftswitchIP;
	} else {
		Session.g_oCallLegB.strBackupRequestUri = Session.s_strBackupPSX;
	}	

	Session.g_oCallLegB.strCallId = "";
	Session.g_oCallLegB.strContent = "";
	Session.g_oCallLegB.strCSeq = "";
	Session.g_oCallLegB.strFrom = "";
	Session.g_oCallLegB.strTo = "";
	Session.g_oCallLegB.strRoute = "";
	Session.g_oCallLegB.strRecordRoute = "";
	Session.g_oCallLegB.strContact = "";
	Session.g_oCallLegB.nSetUpTime = 0;
	Session.g_oCallLegB.nTearDownTime = 0;
	Session.g_oCallLegB.strCodec = Session.s_strCodec;	
}

]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=2899 y=229 ?>
          <!--s_nGET_DESTINATION-->
          <return value="s_nGET_DESTINATION"/>
        </action>
        <action id="54" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=30 y=609 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
        </action>
        <action id="78" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=333 y=253 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success" link="129" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="110" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=258 y=488 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
        </action>
        <action id="112" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=2011 y=213 ?>
          <!--outdial from MS-->
          <function name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success" link="122" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller Hung Up" link="118" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="116" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=40 y=190 ?>
          <!--Setup B leg and outdial-->
          <function name="&quot;OutdialParty&quot;" return="f_nReturnCode" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegB.lTimeStart</parameter>
            <parameter >g_oCallLegB.lTimeAnswered</parameter>
            <parameter >g_oCallLegB.strSIPStatus</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="78" stubbed="0"/>
            <result name="0 - success" link="127" stubbed="0" >f_nReturnCode == f_nSUCCESS</result>
            <result name="CallingParty error, other error, resource unavail" link="110" stubbed="0" >f_nReturnCode == f_nCALLINGPARTYERROR
OR f_nReturnCode == f_nOTHERERROR
OR f_nReturnCode == f_nRESOURCEUNAVAIL</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
if (Session.s_strTestModeFlag == "T")
{
	if(Session.g_oTEST.strTestDestinationNumber.length > 0) {
		Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;
	} else {
		Server.logError("Application is in test mode but no test number exists. Using: " + Session.g_oAPI.strDestinationNumber);
	}			
}										
Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);
Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
if ("T" == Session.s_strPrependSVC)
	Session.g_oCallLegB.strCalledNumber = Session.g_oAPI.strServiceProviderCode + Session.g_oAPI.strDestinationNumber;
else
	Session.g_oCallLegB.strCalledNumber = Session.g_oAPI.strDestinationNumber;
Session.g_oCallLegA.strContent = Session.g_oCallLegA.strOriginalContent;
Session.g_oAPI.nRTPClockRate = 8000;
Session.g_oAPI.nRTPEncoding = 0;
Session.f_lStartTime = Server.getUTCTime();

/*
Server.logInfo("Session.g_oAPI.strOriginationType IS: " + Session.g_oAPI.strOriginationType);
Server.logInfo("Session.s_oORIG_TYPES.strClickToDial IS: " + Session.s_oORIG_TYPES.strClickToDial);
Server.logInfo("Session.s_oORIG_TYPES.strAccessNumCallback IS: " + Session.s_oORIG_TYPES.strAccessNumCallback);

if (Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strClickToDial ||
	Session.g_oAPI.strOriginationType == Session.s_oORIG_TYPES.strAccessNumCallback)
{

	var myTempTo = Session.g_oCallLegA.strTo;
	Session.g_oCallLegA.strTo = Session.g_oCallLegA.strFrom;
	Session.g_oCallLegA.strFrom = myTempTo;
	Server.logInfo("Session.g_oCallLegA.strTo IS: " + Session.g_oCallLegA.strTo);
	Server.logInfo("Session.g_oCallLegA.strFrom IS: " + Session.g_oCallLegA.strFrom);
	Server.logInfo("Session.g_oCallLegA.strContent IS: " + Session.g_oCallLegA.strContent);
	Server.logInfo("Switch To and From");
}
*/]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("********* OUTDIAL RETURN *********");
Server.logInfo("f_nReturnCode " + Session.f_nReturnCode);
Session.g_nPromptToPlay = 0;
switch (Session.f_nReturnCode)
{
	case 0:  //success
		Session.f_lEndTime = Server.getUTCTime();
		Session.f_nDuration = Session.f_lEndTime - Session.f_lStartTime;
		break;
	case 1:  //ring no answer
		Session.g_nPromptToPlay = 551;
		Session.g_oAPI.nCallTerminationReason = 8;
		break;
	case 2:  //busy
		Session.g_nPromptToPlay = 550;
		Session.g_oAPI.nCallTerminationReason = 7;
		break;
	case 3:  //DTMF interrupted
		Session.g_nPromptToPlay = 0;
		Session.g_oAPI.nCallTerminationReason = 5;
		break;
	case -3:  //calling party error
		Session.g_oAPI.nCallTerminationReason = 6;
		Session.g_oAPI.nSessionTerminationReason = 5;
		break;
	default:
		Session.g_nPromptToPlay = 549;
		Session.g_oAPI.nCallTerminationReason = 4;
		break;
}

Server.logInfo("CALLING js_calculate_uri_and_route");
Server.logInfo("BEFORE contact: " + Session.g_oCallLegB.strContact);
Server.logInfo("BEFORE record route: " + Session.g_oCallLegB.strRecordRoute);
Server.logInfo("BEFORE request Uri: " + Session.g_oCallLegB.strRequestUri);
Server.logInfo("BEFORE route: " + Session.g_oCallLegB.strRoute);
var bDialIn = false;
js_calculate_uri_and_route(bDialIn, Session.s_strSIPVERSION, Session.g_oCallLegB.strFrom, Session.g_oCallLegB.strContact, Session.g_oCallLegB.strRecordRoute, Session.g_oCallLegB.strRequestUri, Session.g_oCallLegB.strRoute);
Server.logInfo("AFTER contact: " + Session.g_oCallLegB.strContact);
Server.logInfo("AFTER record route: " + Session.g_oCallLegB.strRecordRoute);
Server.logInfo("AFTER request Uri: " + Session.g_oCallLegB.strRequestUri);
Server.logInfo("AFTER route: " + Session.g_oCallLegB.strRoute);
Server.logInfo("Call leg B request Uri is: " + Session.g_oCallLegB.strRequestUri);
var myUri = new SipRequestUri(Session.g_oCallLegB.strRequestUri);
Session.g_oAPI.strGWIPEgress = myUri.url.host;
Session.g_oAPI.nGWPortEgress = myUri.url.port;
if (myUri.url.dtg != undefined)
	Session.g_oCallLegB.strDestTrunkGroup = myUri.url.dtg;]]></script>
          </scripts>
        </action>
        <action id="118" plug-in="Standard.EndSession.1" ><?xtml-editor x=286 y=643 ?></action>
        <action id="119" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2410 y=311 ?>
          <!--g_nPromptToPlay-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="122" plug-in="Pactolus.Branch.1" ><?xtml-editor x=2240 y=183 ?>
          <!--play prompt?-->
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="g_nPromptToPlay &gt; 0" link="119" stubbed="0" >g_nPromptToPlay &gt; 0</result>
          </results>
        </action>
        <action id="124" plug-in="Pactolus.Branch.1" ><?xtml-editor x=2594 y=222 ?>
          <!--outdial csr?-->
          <results >
            <result name="Default" link="30" stubbed="0"/>
            <result name="g_oAPI.strOutdialOperatorFlag==T" link="125" stubbed="0" >g_oAPI.strOutdialOperatorFlag match "T"</result>
          </results>
        </action>
        <action id="125" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2771 y=351 ?>
          <!--could not reach csr-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1503</audio>
          </play>
          <results >
            <result name="Default" link="54" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 10;]]></script>
          </scripts>
        </action>
        <action id="127" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=294 y=380 ?>
          <!--SetTimers-->
          <function name="&quot;SetTimers&quot;" return="" external-function="1" library="" >
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerPhoneB</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >f_nDuration</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="128" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers


js_initTimer(Session.g_oTimerThreshold1);
js_initTimer(Session.g_oTimerThreshold2);
js_initTimer(Session.g_oTimerThreshold3);
js_initTimer(Session.g_oTimerPhoneA);
js_initTimer(Session.g_oTimerPhoneB);
js_initTimer(Session.g_oTimerMaxTime);


Session.g_oTimerThreshold1.nThresholdTime = Session.g_oAPI.nWarningThreshold1;
Session.g_oTimerThreshold2.nThresholdTime = Session.g_oAPI.nWarningThreshold2;
Session.g_oTimerThreshold3.nThresholdTime = Session.g_oAPI.nWarningThreshold3;

Session.g_oTimerPhoneA.lSleepTime = Session.g_oCallLegA.initSessionTimer;
Session.g_oTimerPhoneB.lSleepTime = Session.g_oCallLegB.initSessionTimer;





if (Session.g_oSUB.nSecondsAvailable > 0)
{
	Session.g_oTimerMaxTime.lSleepTime = Session.g_oSUB.nSecondsAvailable;
}
else if (Session.g_oAPI.nMaxAllowedSeconds > 0)
{
	Session.g_oTimerMaxTime.lSleepTime =  Session.g_oAPI.nMaxAllowedSeconds;
}
else
{
	Session.g_oTimerMaxTime.lSleepTime = 4294967;
	Server.logInfo("INFO: BOTH SECOND AVAILABLE AND MAX ALLOW SECONDS EQUAL ZERO");
}

Server.logInfo("g_oTimerMaxTime.lSleepTime: " + Session.g_oTimerMaxTime.lSleepTime);

]]></script>
          </scripts>
        </action>
        <action id="128" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=548 y=416 ?>
          <!--return s_nCONNECTED-->
          <return value="s_nCONNECTED"/>
        </action>
        <action id="129" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=546 y=235 ?>
          <!--put A on hold-->
          <function name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="112" stubbed="0"/>
          </results>
        </action>
        <action id="130" plug-in="Pactolus.Branch.1" ><?xtml-editor x=200 y=19 ?>
          <!--send info msg?-->
          <results >
            <result name="Default" link="116" stubbed="0"/>
            <result name="SendInfoMs &amp;&amp; SendPreCall" link="131" stubbed="0" >s_strSendInfoMsg match "T"
AND s_strSendPrecallInfoMsg match "T"</result>
          </results>
        </action>
        <action id="131" plug-in="Pactolus.SipInfo.1" ><?xtml-editor x=440 y=0 ?>
          <!--ON-->
          <element-tag increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >f_strContentON</content>
            <content-type >"application/dtmf"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strTo</from>
            <request-uri >g_oCallLegA.strRequestUri</request-uri>
            <to >g_oCallLegA.strFrom</to>
            <via >s_strVia</via>
          </element-tag>
          <results >
            <result name="Default" link="116" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnBye" start="1" event="OnBye" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string"/>
        <parameter name="strRequire" type="string"/>
        <parameter name="strResponseKey" type="string"/>
        <parameter name="strRoute" type="string"/>
        <parameter name="strSupported" type="string"/>
        <parameter name="strTimestamp" type="string"/>
        <parameter name="strTo" type="string"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_oNullArray" type="object" ></var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=26 y=28 ?>
          <!--reponse 200 OK-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="58" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents( false );]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Pactolus.Branch.1" ><?xtml-editor x=28 y=159 ?>
          <!--BYE from 
phone A or Phone B-->
          <results >
            <result name="Default" link="34" stubbed="0"/>
            <result name="from phoneA" link="33" stubbed="0" >strCallId match g_oCallLegA.strCallId</result>
            <result name="from phoneB" link="60" stubbed="0" >strCallId match g_oCallLegB.strCallId</result>
          </results>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=509 y=761 ?>
          <!--Re-originate-->
          <function name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="29" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Phone B object
Session.g_oCallLegB.bReverseFromTo = false;
Session.g_oCallLegB.bCurrentlyDialing = false;
Session.g_oCallLegB.bAttemptedToOutdial = false;
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="29" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=749 y=770 ?>
          <return value=""/>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=728 y=237 ?>
          <!--Hang Up Phone B-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="57" stubbed="0"/>
          </results>
        </action>
        <action id="33" plug-in="Pactolus.Branch.1" ><?xtml-editor x=381 y=248 ?>
          <!--connected?-->
          <results >
            <result name="Default" link="51" stubbed="0"/>
            <result name="g_oCallLegB.bConnected == true?" link="30" stubbed="0" >g_oCallLegB.bConnected == true</result>
            <result name="g_oCallLegB.bCurrentlyDialing== true?" link="53" stubbed="0" >g_oCallLegB.bCurrentlyDialing == true</result>
            <result name="ACD.bCSRWithAB" link="62" stubbed="0" >g_oACD.bCSRWithAB == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 2;
Session.g_oAPI.nSessionTerminationReason = 7;]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=260 y=147 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=30 y=683 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="55" stubbed="0"/>
            <result name="Success" link="67" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 1;
Session.g_oAPI.nSessionTerminationReason = 7;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");
Session.g_oACD.lCSRAssignmentId = 0;
Session.g_oACD.lCSRUserId = 0;	

if(Session.f_nReturnCode != Session.s_sSUCCESS) {
	Session.g_oAPI.nSessionTerminationReason = 5;
}
]]></script>
          </scripts>
        </action>
        <action id="51" plug-in="Standard.EndSession.1" ><?xtml-editor x=660 y=140 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="53" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=781 y=370 ?>
          <!--Cancel PartyB-->
          <function name="&quot;CancelParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="57" stubbed="1"/>
          </results>
        </action>
        <action id="55" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=279 y=642 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="56" stubbed="0"/>
          </results>
        </action>
        <action id="56" plug-in="Standard.EndSession.1" ><?xtml-editor x=494 y=640 ?></action>
        <action id="57" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1013 y=291 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="51" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=250 y=55 ?>
          <!--StopTimers-->
          <function name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="6" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
        <action id="60" plug-in="Pactolus.Branch.1" ><?xtml-editor x=23 y=533 ?>
          <results >
            <result name="Default" link="50" stubbed="0"/>
            <result name="true == g_oACD.bCSRWithAB" link="63" stubbed="0" >g_oACD.bCSRWithAB == true</result>
          </results>
        </action>
        <action id="61" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=495 y=517 ?>
          <!--"CSROutdialBLegHangup"-->
          <SOAP destination-ip="g_oACD.strACDControllerIP" transaction="g_strZeroTransactionId" message-name="&quot;CSROutdialBLegHangup&quot;" destination-port="g_oACD.nACDControllerPort" destination-type="4" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;AssignmentId&quot;" value="g_oACD.lCSRAssignmentId"/>
          </SOAP>
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oACD.bCSRWithAB == true) {
	Session.g_oACD.bCSRWithAB = false;
}]]></script>
          </scripts>
        </action>
        <action id="62" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=780 y=525 ?>
          <!--Hang Up Phone B-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="57" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.lTimeAnswered = 0;]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=274 y=530 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="61" stubbed="0"/>
            <result name="Success" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 1;
Session.g_oCallLegB.lTimeAnswered = 0;]]></script>
          </scripts>
        </action>
        <action id="67" plug-in="Pactolus.Branch.1" ><?xtml-editor x=265 y=835 ?>
          <!--Click2Dial?-->
          <results >
            <result name="Default" link="28" stubbed="0"/>
            <result name="!2Stage and !SingleStage" link="55" stubbed="0" >g_oAPI.strOriginationType != s_oORIG_TYPES.strTwoStageDialing
AND g_oAPI.strOriginationType != s_oORIG_TYPES.strOneStageDialing</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="ProcCallCompletion" start="10" event="ProcCallCompletion" returns="i4" >
      <local-vars >
        <var name="f_bWriteCDR" type="boolean" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=174 y=336 ?>
          <!--write CDR?-->
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="f_bWriteCDR == true" link="12" stubbed="0" >f_bWriteCDR == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
if (Session.g_oAPI.strProcDBName.length > 0)
{
	Session.f_bWriteCDR = true;
}
else
{
	Session.f_bWriteCDR = false;
	Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION, NO DB NAME.");
	Server.logError("ERROR: g_oAPI.strProcDBName.length is: " + Session.g_oAPI.strProcDBName.length);
	if (Session.g_oCallLegB.lTimeAnswered > 0)
	{
		var myTime;
		
		Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION, ANSWER TIMER GREATER THAN ZERO.");
		Server.logError("ERROR: g_oAPI.lPlatformSessionStartTime is: " + Session.g_oAPI.lPlatformSessionStartTime);
		myTime = new Date(Session.g_oAPI.lPlatformSessionStartTime * 1000);
		Server.logError("ERROR: g_oAPI.lPlatformSessionStartTime is: " + myTime.toString() );
		
		Server.logError("ERROR: g_oCallLegB.lTimeStart is: " + Session.g_oCallLegB.lTimeStart);
		myTime = new Date(Session.g_oCallLegB.lTimeStart * 1000);
		Server.logError("ERROR: g_oCallLegB.lTimeStart is: " + myTime.toString() );
		
		Server.logError("ERROR: g_oCallLegB.lTimeAnswered is: " + Session.g_oCallLegB.lTimeAnswered);
		myTime = new Date(Session.g_oCallLegB.lTimeAnswered * 1000);
		Server.logError("ERROR: g_oCallLegB.lTimeAnswered is: " + myTime.toString() );
		
		Server.logError("ERROR: g_oCallLegB.lTimeStart is: " + Session.g_oCallLegB.lTimeStart);
		myTime = new Date(Session.g_oCallLegB.lTimeStart * 1000);
		Server.logError("ERROR: g_oCallLegB.lTimeStart is: " + myTime.toString() );
	}
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=683 y=438 ?>
          <!--SUCCESS-->
          <return value="s_sSUCCESS"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Server.logInfo("INFO: PROC CALL COMPLETION SUCCESS");
Session.g_oAPI.nCallSequence++;
Server.logInfo(" ****** CLEAR OUT VARIABLES *****");
Session.g_oCallLegB.lTimeStart = 0;
Session.g_oCallLegB.lTimeAnswered = 0;
Session.g_oCallLegB.lTimeEnded = 0;
Session.g_oCallLegB.bAttemptedToOutdial = false;
Session.g_oCallLegB.bConnected = false;
Session.g_oAPI.bWriteAtleastOneCDR = true;]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=418 y=318 ?>
          <!--FAILURE-->
          <return value="s_sFAILURE"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=434 y=439 ?>
          <!--JAVA: psAPIProcCallCompletion-->
          <function name="&quot;psAPIProcCallCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="8" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START CallComletion *********");
Session.g_oCallLegB.strSIPStatus = Session.g_oCallLegB.strSIPStatus.toString();
Session.g_oCallLegB.lTimeStart = Server.getUTCTime();

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("procCallCompletion returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION");
	Server.logError("ERROR: procCallCompletion returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="173" y-coord="128" width="397" height="51" text="Only write CDR if g_oCallLegB.bAttemptedToOutdial == true
Once write CDR, reset bAttemptedToOutdial" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="ProcSessionCompletion" start="7" event="ProcSessionCompletion" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="7" plug-in="Pactolus.Branch.1" ><?xtml-editor x=73 y=57 ?>
          <!--null string?-->
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="null string" link="5" stubbed="0" >g_bNullFlag == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_oAPI.strProcDBName.length <= 0)
{
	Session.g_bNullFlag = true;
}
else
{
	Session.g_bNullFlag = false;
}]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=973 y=233 ?>
          <return value=""/>
        </action>
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=490 y=132 ?>
          <!--MediaServer Connected?-->
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="g_oMS.bCurrentlyConnected == true" link="6" stubbed="0" >g_oMS.bCurrentlyConnected == true</result>
          </results>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=724 y=251 ?>
          <!--Delete MS Connection-->
          <function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=312 y=558 ?>
          <!--JAVA: PrepaidAPISessionCompletion-->
          <function name="&quot;PrepaidAPISessionCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START SessionCompletion *********");
Session.g_oAPI.lPlatformSessionEndTime = Server.getUTCTime();
Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("procSessionCompletion returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC SESSION COMPLETION");
	Server.logError("ERROR: procSessionCompletion returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.Branch.1" ><?xtml-editor x=69 y=272 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Postpaid" link="13" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="8" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Result.id == 1) {
	Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);
}]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=305 y=427 ?>
          <!--procSessionCompletion-->
          <function name="&quot;PostpaidAPISessionCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC SESSION COMPLETION");
	Server.logError("ERROR: procSessionCompletion returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnTimer" start="74" event="OnTimer" returns="void" >
      <parameters >
        <parameter name="nTimerId" type="i4"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >0</var>
        <var name="f_lCurrentTime" type="i8" >0</var>
        <var name="f_bGetReInviteOnTime" type="boolean" >0</var>
        <var name="f_oTimer" type="object" ></var>
        <var name="f_oMS" type="object" ></var>
        <var name="f_bLowBalance" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="74" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=40 y=107 ?>
          <!--ProcessOnTimer-->
          <function name="&quot;ProcessOnTimer&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >nTimerId</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerPhoneB</parameter>
            <parameter >f_oTimer</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
            <parameter >s_strContentType</parameter>
            <parameter >f_oMS</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oPrompts</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="ReturnCode != 0" link="75" stubbed="0" >f_nReturnCode != 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("THIS TIMER ID OCCURES : " + Session.nTimerId);
js_disable_event();

js_initMS(Session.f_oMS, Session.s_strMSType);
if(Session.g_oConfMS.bCurrentlyInConf) {
	Session.f_oMS = Session.g_oConfMS;
	Server.logInfo("Use conf. media server for process on timer.");	
} else if(Session.g_oMOH.bCurrentlyInConf || Session.g_oMOH.bCurrentlyConnected) {
	Server.logInfo("Use MOH media server for process on timer.");	
	Session.f_oMS = Session.g_oMOH;
} else {
	Session.f_oMS = Session.g_oMS;
}

js_initTimerPrompts(Session.g_oPrompts);

if(Session.g_oTimerThreshold1.lTimerId == Session.nTimerId) {
	Session.f_oTimer = Session.g_oTimerThreshold1;
	Session.g_oPrompts.nTime = Session.g_oTimerThreshold1.nThresholdTime;
} else if(Session.g_oTimerThreshold2.lTimerId == Session.nTimerId) {
	Session.f_oTimer = Session.g_oTimerThreshold2;
	Session.g_oPrompts.nTime = Session.g_oTimerThreshold2.nThresholdTime;	
} else if(Session.g_oTimerThreshold3.lTimerId == Session.nTimerId) {
	Session.f_oTimer = Session.g_oTimerThreshold3;
	Session.g_oPrompts.nTime = Session.g_oTimerThreshold3.nThresholdTime;	
} 
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.nTimerId == Session.g_oTimerMOH.lTimerId)
{
	Session.g_oMOH = Session.f_oMS;
}
if (-3 == Session.f_nReturnCode)
	Session.f_bLowBalance = true;
else
	Session.f_bLowBalance = false;]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=20 y=535 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="56" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=511 y=72 ?>
          <!--Hangup2Parties-->
          <function name="&quot;Hangup2Parties&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="72" stubbed="0"/>
          </results>
        </action>
        <action id="61" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=508 y=284 ?>
          <!--Hang Up Phone  B-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="64" stubbed="0"/>
          </results>
        </action>
        <action id="62" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1007 y=298 ?>
          <!--Re-originate-->
          <function name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Session.f_b_A_re_INVITE = false;
Session.f_b_B_re_INVITE = false;
Session.f_b_New_A_SDP = false;
Session.f_b_New_B_SDP = false;]]></script>
          </scripts>
        </action>
        <action id="64" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=749 y=222 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="70" stubbed="0"/>
            <result name="initiate dialout A" link="70" stubbed="1" >g_oAPI.strOriginationType == s_oORIG_TYPES.strClickToDial
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strMessageCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strAccessNumCallback
OR g_oAPI.strOriginationType == s_oORIG_TYPES.strIvrCallback</result>
            <result name="Sucess &amp;&amp; !LowBalance" link="62" stubbed="0" >f_nReturnCode == s_sSUCCESS
AND f_bLowBalance == false</result>
            <result name="Success &amp;&amp; LowBalance" link="76" stubbed="0" >f_nReturnCode == s_sSUCCESS
AND f_bLowBalance == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
]]></script>
          </scripts>
        </action>
        <action id="67" plug-in="Standard.EndSession.1" ><?xtml-editor x=22 y=468 ?></action>
        <action id="70" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=975 y=168 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="67" stubbed="1"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=752 y=66 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="67" stubbed="1"/>
          </results>
        </action>
        <action id="75" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=283 y=103 ?>
          <!--StopTimers-->
          <function name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="56" stubbed="0"/>
            <result name="returnCode = -2" link="61" stubbed="0" >f_nReturnCode == -2
OR f_nReturnCode == -3</result>
            <result name="returnCode = -4" link="67" stubbed="1" >f_nReturnCode == -4</result>
            <result name="returnCode = -5" link="70" stubbed="0" >f_nReturnCode == -5</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
        <action id="76" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1021 y=410 ?>
          <!--"ProcLowBalance"-->
          <function name="&quot;ProcLowBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();
Session.f_b_A_re_INVITE = false;
Session.f_b_B_re_INVITE = false;
Session.f_b_New_A_SDP = false;
Session.f_b_New_B_SDP = false;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetDestNumber" start="5" event="GetDestNumber" returns="i4" >
      <local-vars >
        <var name="f_bIsDestValid" type="boolean" >0</var>
        <var name="f_bCallCSR" type="boolean" >0</var>
        <var name="f_bMainMenu" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_bRouteToCSR" type="boolean" >0</var>
        <var name="f_nReturnCode" type="i4" >-99</var>
        <var name="f_nStarStar" type="i4" >359</var>
        <var name="f_nToGoToMainMenu" type="i4" >946</var>
      </local-vars>
      <actions >
        <action id="5" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=45 y=55 ?>
          <!--507: Please enter the phone number you wish to reach. For international calls start with 011.-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="s_strOutdialDigitMap" language="g_oAPI.strLanguage" digits="g_oAPI.strDestinationNumber" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >509</audio>
            <audio type="index" >f_nStarStar</audio>
            <audio type="index" >f_nToGoToMainMenu</audio>
          </play>
          <results >
            <result name="Default" link="47" stubbed="0"/>
            <result name="Success" link="11" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="11" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strDestinationNumber = "";
Session.g_strTerminationDigit = "";

if("F" == Session.g_oAPI.strMainMenuFlag) {
	Session.f_nStarStar = 99;
	Session.f_nToGoToMainMenu = 99;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("THE DESTINATION COLLECTED IS: " + Session.g_oAPI.strDestinationNumber);
Session.g_oAPI.strDestinationNumber = js_translate_destination(Session.s_strCustomerCode, Session.g_oAPI.strDestinationNumber, Session.g_oAPI.strStrippedOrigNumber, Session.g_oAPI.nOrigCountryId);
Server.logInfo("THE DESTINATION AFTER TRANSLATION IS: " + Session.g_oAPI.strDestinationNumber);
if (Result.id != 2) { //ms error
	Session.g_oAPI.nSessionTerminationReason = 12;
}]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=369 y=160 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return value="s_nAUTHORIZE_DESTINATION"/>
        </action>
        <action id="45" plug-in="Standard.EndSession.1" ><?xtml-editor x=593 y=39 ?></action>
        <action id="47" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=355 y=25 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="45" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="GetPinNumber" start="42" event="GetPinNumber" returns="i4" >
      <local-vars >
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_nGetPinPrompt" type="i4" >501</var>
      </local-vars>
      <actions >
        <action id="42" plug-in="Pactolus.Branch.1" ><?xtml-editor x=25 y=179 ?>
          <!--g_oAPI.strWelcomePromptType = U or I-->
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="g_oAPI.strWelcomePromptType==U" link="43" stubbed="0" >g_oAPI.strWelcomePromptType match "U"
AND g_bFirstTry == true</result>
            <result name="g_oAPI.strWelcomePromptType==I" link="40" stubbed="0" >g_oAPI.strWelcomePromptType match "I"
AND g_bFirstTry == true
AND g_oAPI.nWelcomePromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_nErrorMsgNumber = 0;
Session.g_strTerminationDigit = "";

if(Session.g_oACD.strPinZeroOut == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
	Session.f_oCSRPrompts.nOR = 362;
	Session.f_oCSRPrompts.nPRESS = 310;
	Session.f_oCSRPrompts.nZERO = 1;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
} else {
	Session.f_oCSRPrompts.nOR = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}


if (Session.g_oAPI.nPinLength > 0) {
	Session.f_nGetPinPrompt = 579;
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bFirstTry = false;]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=322 y=161 ?>
          <!--506: Please enter your card number.-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="30" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >f_nGetPinPrompt</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="0"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oSUB.strUserPin = "";
Session.g_strTerminationDigit = "";]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=597 y=238 ?>
          <!--return s_nAUTHENTICATE_PIN-->
          <return value="s_nAUTHENTICATE_PIN"/>
        </action>
        <action id="40" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=222 y=508 ?>
          <!--Welcome prompt Index-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nPROMPTLENGTH" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nWelcomePromptIndex</audio>
            <audio type="index" >f_nGetPinPrompt</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="0"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
        </action>
        <action id="43" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=301 y=348 ?>
          <!--Welcome prompt URL-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nPROMPTLENGTH" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="g_oSUB.strUserPin" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strWelcomePromptUrl</audio>
            <audio type="index" >f_nGetPinPrompt</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="58" stubbed="0"/>
            <result name="Success" link="21" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout" link="21" stubbed="1"/>
          </results>
        </action>
        <action id="55" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=728 y=485 ?>
          <!--send MEDIASERVER ALARM-->
          <SOAP destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: connect caller to ms";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Pactolus.Branch.1" ><?xtml-editor x=565 y=364 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="73" stubbed="0"/>
            <result name="s_strSendAlarmFlag==T" link="55" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 12;]]></script>
          </scripts>
        </action>
        <action id="73" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=952 y=415 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
        </action>
        <action id="74" plug-in="Standard.EndSession.1" ><?xtml-editor x=1192 y=444 ?></action>
      </actions>
    </function>
    <function name="OnOptions" start="1" event="OnOptions" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strCallInfo" type="string" pass="byref"/>
        <parameter name="strContact" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentEncoding" type="string" pass="byref"/>
        <parameter name="strContentLanguage" type="string" pass="byref"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strRemotePartyId" type="string" pass="byref"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string"/>
        <parameter name="strRequire" type="string"/>
        <parameter name="strResponseKey" type="string"/>
        <parameter name="strRoute" type="string"/>
        <parameter name="strSupported" type="string"/>
        <parameter name="strTimestamp" type="string"/>
        <parameter name="strTo" type="string"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=136 y=204 ?>
          <!--200 OK-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=360 y=207 ?>
          <return value=""/>
        </action>
      </actions>
    </function>
    <function name="ReOriginate" start="57" event="ReOriginate" returns="void" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="57" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=125 y=87 ?>
          <!--put A on hold-->
          <function name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="56" stubbed="0"/>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=368 y=812 ?>
          <!--call is GET_DEST-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nGET_DESTINATION;]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=590 y=73 ?>
          <!--"HangUpParty"-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="58" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.Branch.1" ><?xtml-editor x=392 y=302 ?>
          <!--got recharge settings?-->
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="NEED TO GET SETTINGS" link="69" stubbed="0" >g_bGotRechargeSettings == false
AND g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="39" plug-in="Pactolus.Branch.1" ><?xtml-editor x=111 y=680 ?>
          <!--g_oSUB.fPrepaidBalance >=  g_oCC.fMinPrepaidBalance-->
          <results >
            <result name="Default" link="48" stubbed="0"/>
            <result name="g_oSUB.fPrepaidBalance &gt;= g_oCC.fMinPrepaidBalance" link="5" stubbed="0" >g_oSUB.fPrepaidBalance &gt;= g_oCC.fMinPrepaidBalance
AND g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1058 y=715 ?>
          <return value=""/>
        </action>
        <action id="41" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=602 y=717 ?>
          <!--Low balance-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="42" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="42" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=825 y=717 ?>
          <!--call is MAIN MENU-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="40" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nMAIN_MENU;]]></script>
          </scripts>
        </action>
        <action id="48" plug-in="Pactolus.Branch.1" ><?xtml-editor x=350 y=606 ?>
          <!--recharge==true-->
          <results >
            <result name="Default" link="53" stubbed="0"/>
            <result name="recharge==true" link="41" stubbed="0" >g_oBALXFER.strBalanceTransferFlag match "T"
AND g_oCC.strRechargableFlag match "T"</result>
          </results>
        </action>
        <action id="53" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=585 y=538 ?>
          <!--Low balance-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="67" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 5;
Session.g_oAPI.nSessionTerminationReason = 8;]]></script>
          </scripts>
        </action>
        <action id="54" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=607 y=164 ?>
          <!--outdial from MS-->
          <function name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="55" stubbed="0"/>
          </results>
        </action>
        <action id="55" plug-in="Pactolus.Branch.1" ><?xtml-editor x=114 y=293 ?>
          <!--SUCCESS?-->
          <results >
            <result name="Default" link="26" stubbed="1"/>
            <result name="SUCCESS?" link="38" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller hung up" link="58" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="56" plug-in="Pactolus.Branch.1" ><?xtml-editor x=352 y=82 ?>
          <!--success?-->
          <results >
            <result name="Default" link="26" stubbed="0"/>
            <result name="success" link="54" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="58" plug-in="Standard.EndSession.1" ><?xtml-editor x=821 y=70 ?></action>
        <action id="66" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=870 y=303 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="67" stubbed="0"/>
          </results>
        </action>
        <action id="67" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1117 y=298 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="68" stubbed="0"/>
          </results>
        </action>
        <action id="68" plug-in="Standard.EndSession.1" ><?xtml-editor x=1360 y=296 ?></action>
        <action id="69" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=646 y=307 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="66" stubbed="0"/>
            <result name="Success" link="39" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);
if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnInfo" start="1" event="OnInfo" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strContact" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strPriority" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strRequestUri" type="string"/>
        <parameter name="strRequire" type="string"/>
        <parameter name="strResponseKey" type="string"/>
        <parameter name="strRoute" type="string"/>
        <parameter name="strSupported" type="string"/>
        <parameter name="strTimestamp" type="string"/>
        <parameter name="strTo" type="string"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_lTempLong1" type="i8" >0</var>
        <var name="f_lTempLong2" type="i8" >0</var>
        <var name="f_strContentOFF" type="string" >OFF</var>
        <var name="f_bFromCallLegA" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=86 y=164 ?>
          <!--response 200 OK-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="84" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents( false );]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1048 y=215 ?>
          <!--dtmf ##-->
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="fax tone?" link="42" stubbed="0" >strContentType match "tone"</result>
            <result name="re-originate?" link="12" stubbed="0" >strContentType match "dtmf"
AND strContent match "#"</result>
          </results>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1279 y=171 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents( true );]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=549 y=530 ?>
          <!--Hang Up Phone B-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="50" stubbed="0"/>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1221 y=525 ?>
          <!--Re-originate-->
          <function name="&quot;ReOriginate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="6" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents( true );]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1463 y=525 ?>
          <return value=""/>
        </action>
        <action id="12" plug-in="Pactolus.Branch.1" ><?xtml-editor x=69 y=473 ?>
          <!--connected?-->
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="g_oCallLegB.bConnected == true?" link="81" stubbed="0" >g_oCallLegB.bConnected == true
AND g_oCallLegB.bCurrentlyDialing == false</result>
            <result name="currently dialing == true?" link="61" stubbed="0" >g_oCallLegB.bConnected == false
AND g_oCallLegB.bCurrentlyDialing == true</result>
          </results>
        </action>
        <action id="28" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1117 y=766 ?>
          <!--connect to media server?-->
          <results >
            <result name="Default" link="59" stubbed="0"/>
            <result name="g_oMS.bCurrentlyConnected==true" link="29" stubbed="1" >g_oMS.bCurrentlyConnected == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents( true );]]></script>
          </scripts>
        </action>
        <action id="29" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1896 y=805 ?>
          <!--call main function
s_nGET_DESTINATION-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="6" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nGET_DESTINATION;]]></script>
          </scripts>
        </action>
        <action id="42" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1330 y=274 ?>
          <!--put B on hold-->
          <function name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="58" stubbed="0"/>
          </results>
        </action>
        <action id="46" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=2279 y=265 ?>
          <!--Hangup2Parties-->
          <function name="&quot;Hangup2Parties&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="72" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=756 y=528 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 5;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");
Session.g_oACD.lCSRAssignmentId = 0;
Session.g_oACD.lCSRUserId = 0;	

]]></script>
          </scripts>
        </action>
        <action id="57" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=597 y=775 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="76" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 5;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");
Session.g_oACD.lCSRAssignmentId = 0;
Session.g_oACD.lCSRUserId = 0;	

]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1553 y=267 ?>
          <!--success?-->
          <results >
            <result name="Default" link="46" stubbed="1"/>
            <result name="success" link="79" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="59" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1378 y=761 ?>
          <!--outdial from MS-->
          <function name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="60" stubbed="0"/>
          </results>
        </action>
        <action id="60" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1599 y=754 ?>
          <!--SUCCESS?-->
          <results >
            <result name="Default" link="67" stubbed="0"/>
            <result name="SUCCESS?" link="29" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller hung up" link="72" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 5;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=348 y=781 ?>
          <!--Cancel PartyB-->
          <function name="&quot;CancelParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="57" stubbed="0"/>
          </results>
        </action>
        <action id="67" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1881 y=682 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="72" stubbed="1"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.EndSession.1" ><?xtml-editor x=2508 y=268 ?></action>
        <action id="74" plug-in="Pactolus.Branch.1" ><?xtml-editor x=973 y=529 ?>
          <!--success?-->
          <results >
            <result name="Default" link="67" stubbed="1"/>
            <result name="success" link="5" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="76" plug-in="Pactolus.Branch.1" ><?xtml-editor x=850 y=771 ?>
          <!--success?-->
          <results >
            <result name="Default" link="67" stubbed="1"/>
            <result name="success" link="28" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="79" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1823 y=271 ?>
          <!--"FaxOutdial"-->
          <function name="&quot;FaxOutdial&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >f_lTempLong1</parameter>
            <parameter >f_lTempLong2</parameter>
            <parameter >g_oCallLegB.strSIPStatus</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="80" stubbed="0"/>
          </results>
        </action>
        <action id="80" plug-in="Pactolus.Branch.1" ><?xtml-editor x=2046 y=267 ?>
          <!--success?-->
          <results >
            <result name="Default" link="46" stubbed="0"/>
            <result name="success" link="3" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="81" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=354 y=523 ?>
          <!--StopTimers-->
          <function name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Pactolus.Branch.1" ><?xtml-editor x=555 y=165 ?>
          <!--send info msg?-->
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="s_strSendInfoMsg==&quot;T&quot;" link="83" stubbed="0" >s_strSendInfoMsg match "T"</result>
          </results>
        </action>
        <action id="83" plug-in="Pactolus.SipInfo.1" ><?xtml-editor x=814 y=113 ?>
          <!--OFF-->
          <element-tag increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >f_strContentOFF</content>
            <content-type >"application/dtmf"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strTo</from>
            <request-uri >g_oCallLegA.strRequestUri</request-uri>
            <to >g_oCallLegA.strFrom</to>
            <via >s_strVia</via>
          </element-tag>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="84" plug-in="Pactolus.Branch.1" ><?xtml-editor x=322 y=163 ?>
          <!--from call leg A?-->
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="f_bFromCallLegA" link="82" stubbed="0" >f_bFromCallLegA == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (0 == Clib.strcmpi(Session.strCallId, Session.g_oCallLegA.strCallId))
{
	Session.f_bFromCallLegA = true;
	var newCSeq = new SipCSeq(Session.strCSeq);
	var oldCSeq = new SipCSeq(Session.g_oCallLegA.strCSeq);

	if(newCSeq.value >= oldCSeq.value) 
	{
		newCSeq.increment() ;
		Session.g_oCallLegA.strCSeq = newCSeq.encode() ;
	}
}
else
{
	Session.f_bFromCallLegA = false;
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="PlayThresholdsPrompt" start="68" event="PlayThresholdsPrompt" returns="void" >
      <parameters >
        <parameter name="n_TimeLeft" type="i4"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_lTempLong1" type="i8" >0</var>
        <var name="f_lTempLong2" type="i8" >0</var>
      </local-vars>
      <actions >
        <action id="68" plug-in="Pactolus.Branch.1" ><?xtml-editor x=145 y=123 ?>
          <!--timerflag==true-->
          <results >
            <result name="Default" link="71" stubbed="1"/>
            <result name="TimerAFlag==true" link="69" stubbed="0" >g_bTimerAFlag == true</result>
          </results>
        </action>
        <action id="6" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=130 y=728 ?>
          <!--517: You have ...-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="number" >n_TimeLeft</audio>
            <audio type="index" >46</audio>
          </play>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1703 y=584 ?>
          <!--Hang Up both A and B-->
          <function name="&quot;Hangup2Parties&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="95" stubbed="0"/>
          </results>
        </action>
        <action id="57" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1372 y=992 ?>
          <return value=""/>
        </action>
        <action id="64" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1033 y=438 ?>
          <results >
            <result name="Default" link="24" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="65" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1457 y=568 ?>
          <results >
            <result name="Default" link="24" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 4;
Session.g_oAPI.nSessionTerminationReason = 12;]]></script>
          </scripts>
        </action>
        <action id="69" plug-in="Standard.Timer.1" ><?xtml-editor x=394 y=125 ?>
          <!--stop phoneA session timer-->
          <timer start="0" id="g_lTimerIdA" duration=""/>
          <results >
            <result name="Default" link="71" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.g_bTimerAFlag = false;]]></script>
          </scripts>
        </action>
        <action id="70" plug-in="Standard.Timer.1" ><?xtml-editor x=864 y=181 ?>
          <!--stop PhoneB session timer-->
          <timer start="0" id="g_lTimerIdB" duration=""/>
          <results >
            <result name="Default" link="83" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.g_bTimerBFlag = false;]]></script>
          </scripts>
        </action>
        <action id="71" plug-in="Pactolus.Branch.1" ><?xtml-editor x=633 y=122 ?>
          <!--timerflag==true-->
          <results >
            <result name="Default" link="83" stubbed="1"/>
            <result name="TimerBFlag==true" link="70" stubbed="0" >g_bTimerBFlag == true</result>
          </results>
        </action>
        <action id="72" plug-in="Standard.Timer.1" ><?xtml-editor x=642 y=1003 ?>
          <!--set PhoneB session timer-->
          <timer start="1" id="g_lTimerIdB" duration="g_nSessionExpiresB"/>
          <results >
            <result name="Default" link="93" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bTimerBFlag = true;]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Standard.Timer.1" ><?xtml-editor x=1152 y=998 ?>
          <!--set PhoneA session timer-->
          <timer start="1" id="g_lTimerIdA" duration="g_nSessionExpiresA"/>
          <results >
            <result name="Default" link="57" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bTimerAFlag = true;]]></script>
          </scripts>
        </action>
        <action id="78" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=169 y=1007 ?>
          <!--1 sec-->
          <sleep duration="1"/>
          <results >
            <result name="Default" link="92" stubbed="0"/>
          </results>
        </action>
        <action id="79" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1014 y=529 ?>
          <!--outdial from MS-->
          <function name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="80" stubbed="0"/>
          </results>
        </action>
        <action id="80" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1234 y=524 ?>
          <!--SUCCESS?-->
          <results >
            <result name="Default" link="65" stubbed="0"/>
            <result name="SUCCESS?" link="6" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller hung up" link="81" stubbed="0" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
        </action>
        <action id="81" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1500 y=698 ?>
          <!--Hang Up B-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="95" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 2;
Session.g_oAPI.nSessionTerminationReason = 7;]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=343 y=731 ?>
          <!--delete MS connection-->
          <function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="88" stubbed="0"/>
          </results>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=142 y=378 ?>
          <!--put A on hold-->
          <function name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="85" stubbed="0"/>
          </results>
        </action>
        <action id="84" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=565 y=457 ?>
          <!--put B on hold-->
          <function name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="86" stubbed="0"/>
          </results>
        </action>
        <action id="85" plug-in="Pactolus.Branch.1" ><?xtml-editor x=358 y=371 ?>
          <!--success?-->
          <results >
            <result name="Default" link="64" stubbed="0"/>
            <result name="success" link="84" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="86" plug-in="Pactolus.Branch.1" ><?xtml-editor x=785 y=455 ?>
          <!--success?-->
          <results >
            <result name="Default" link="64" stubbed="0"/>
            <result name="success" link="79" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="87" plug-in="Pactolus.Branch.1" ><?xtml-editor x=805 y=774 ?>
          <!--success?-->
          <results >
            <result name="Default" link="24" stubbed="0"/>
            <result name="0 - success" link="94" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("INFO: CALING LIBOUTDIAL RETURN: " + Session.f_nReturnCode);]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="88" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=574 y=730 ?>
          <!--outdial-->
          <function name="&quot;OutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >f_lTempLong1</parameter>
            <parameter >f_lTempLong2</parameter>
            <parameter >g_oCallLegB.strSIPStatus</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="87" stubbed="0"/>
          </results>
        </action>
        <action id="91" plug-in="Standard.EndSession.1" ><?xtml-editor x=2200 y=575 ?></action>
        <action id="92" plug-in="Pactolus.Branch.1" ><?xtml-editor x=399 y=1006 ?>
          <!--timerflag==true-->
          <results >
            <result name="Default" link="93" stubbed="1"/>
            <result name="TimerBFlag==true" link="72" stubbed="0" >g_bTimerBFlag == true</result>
          </results>
        </action>
        <action id="93" plug-in="Pactolus.Branch.1" ><?xtml-editor x=877 y=998 ?>
          <!--timerflag==true-->
          <results >
            <result name="Default" link="57" stubbed="1"/>
            <result name="TimerAFlag==true" link="75" stubbed="0" >g_bTimerAFlag == true</result>
          </results>
        </action>
        <action id="94" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1036 y=871 ?>
          <!--session timer ON?-->
          <results >
            <result name="Default" link="57" stubbed="0"/>
            <result name="sessionTimerFlag == &quot;T&quot;" link="78" stubbed="0" >s_strSessionTimerFlag match "T"</result>
          </results>
        </action>
        <action id="95" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1944 y=580 ?>
          <!--call callCompletion()-->
          <function name="&quot;ProcCallCompletion&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="91" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="BalanceTransfer" start="20" event="BalanceTransfer" returns="i4" >
      <local-vars >
        <var name="f_bExceedsBalXferTries" type="boolean" >0</var>
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_strDigit" type="string" ></var>
      </local-vars>
      <actions >
        <action id="20" plug-in="Pactolus.Branch.1" ><?xtml-editor x=19 y=42 ?>
          <!--check rechargeable-->
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="Rechargeable" link="1" stubbed="0" >g_oBALXFER.strBalanceTransferFlag match "T"</result>
          </results>
        </action>
        <action id="1" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=179 y=185 ?>
          <!--Get donor pin-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxxxxxxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="g_oBALXFER.strBalXferPin" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >541</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success" link="80" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="59" stubbed="0"/>
            <result name="Cancel" link="40" stubbed="1" >g_oBALXFER.strBalXferPin match "*"</result>
            <result name="Same Pin" link="74" stubbed="0" >g_oBALXFER.strBalXferPin match g_oSUB.strUserPin</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oBALXFER.strBalXferPin = "";


]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=821 y=253 ?>
          <!--"This account has a balance of ...."-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="f_strDigit" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >543</audio>
            <audio type="currency" >g_oBALXFER.fBalXferBalance</audio>
            <audio type="index" >311</audio>
            <audio type="index" >544</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="0"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Continue" link="83" stubbed="0" >'Result'  == 'Success'
AND f_strDigit match "1"</result>
          </results>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1334 y=541 ?>
          <!--"bal xfer was successful"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >545</audio>
            <audio type="index" >546</audio>
            <audio type="currency" >g_oSUB.fPrepaidBalance</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="21" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=359 y=36 ?>
          <!--"not allowed"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >524</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="24" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=842 y=573 ?>
          <!--Exceeds max balance, not allowed-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >543</audio>
            <audio type="currency" >g_oBALXFER.fBalXferBalance</audio>
            <audio type="index" >532</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=605 y=60 ?>
          <!--return to main menu-->
          <return value="s_nMAIN_MENU"/>
        </action>
        <action id="59" plug-in="Pactolus.Branch.1" ><?xtml-editor x=468 y=422 ?>
          <!--termination reason = 6-->
          <results >
            <result name="Default" link="78" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 6;]]></script>
          </scripts>
        </action>
        <action id="74" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=339 y=597 ?>
          <!--invalid pin-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >502</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries++;]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=834 y=423 ?>
          <!--Not allowed-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >542</audio>
          </play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="76" plug-in="Pactolus.Branch.1" ><?xtml-editor x=544 y=611 ?>
          <!--check retries-->
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="Too many tries" link="78" stubbed="1" >f_nNumTries &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
}]]></script>
          </scripts>
        </action>
        <action id="77" plug-in="Standard.EndSession.1" ><?xtml-editor x=1186 y=177 ?></action>
        <action id="78" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=957 y=147 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="77" stubbed="0"/>
          </results>
        </action>
        <action id="79" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=735 y=152 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="78" stubbed="0"/>
          </results>
        </action>
        <action id="80" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=495 y=181 ?>
          <!--PrepaidAPIValidateBalanceXfer-->
          <function name="&quot;PrepaidAPIValidateBalanceXfer&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="79" stubbed="0"/>
            <result name="0 Valid" link="14" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-2, -6, -12 Invalid" link="74" stubbed="1" >f_nReturnCode == -2
OR f_nReturnCode == -6
OR f_nReturnCode == -12</result>
            <result name="-3,-4,-5 Not Alloved" link="75" stubbed="0" >f_nReturnCode == -3
AND f_nReturnCode == -4
AND f_nReturnCode == -5</result>
            <result name="-7 Max Balance" link="24" stubbed="0" >f_nReturnCode == -7</result>
            <result name="-13 card has no $" link="84" stubbed="0" >f_nReturnCode == -13</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START validateBalanceTransfer *********");
Server.logInfo("donor pin = " + Session.g_oBALXFER.strBalXferPin);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("validate bal xfer returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA VALIDATE BALANCE XFER, EXIT ON: " + Result.name);
	Server.logError("ERROR: validate bal xfer returned " + Session.f_nReturnCode);	
	switch (Session.f_nReturnCode)
	{
		case -1:
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1010; //invalid subscriber
			break;
		case -3:
			Session.g_nErrorMsgNumber = 2005; //not rechargable
			break;
		case -4:
			Session.g_nErrorMsgNumber = 2004; //currency mismatch
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1005; //disable subscriber
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2006; //exceed max balance
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1100 y=263 ?>
          <!--JAVA: PrepaidAPIUnlockPin-->
          <function name="&quot;PrepaidAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="40" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START unlockPin() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("unlockPin returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO UNLOCK PIN");
	Server.logError("ERROR: unlockPin returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1350 y=395 ?>
          <!--JAVA: PrepaidAPIUnlockPin-->
          <function name="&quot;PrepaidAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="79" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START unlockPin() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("unlockPin returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO UNLOCK PIN");
	Server.logError("ERROR: unlockPin returned: " + Session.f_nReturnCode);
}]]></script>
          </scripts>
        </action>
        <action id="83" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1090 y=398 ?>
          <!--JAVA: PrepaidAPIBalanceXfer-->
          <function name="&quot;PrepaidAPIBalanceXfer&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="0: Valid Pin" link="18" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-2: Invalid Pin" link="74" stubbed="1" >f_nReturnCode == -2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
Server.logInfo("*********JAVA START transferBalance() *********");]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("transferBalance returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA XFER BALANCE, EXIT ON: " + Result.name);
	Server.logInfo("transferBalance returned " + Session.f_nReturnCode);	
	switch (Session.f_nReturnCode)
	{
		case -1:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1010; //invalid pin
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="84" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=841 y=734 ?>
          <!--zero balance card-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >543</audio>
            <audio type="currency" >0</audio>
          </play>
          <results >
            <result name="Default" link="76" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries++;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetExpirationDate" start="27" event="GetExpirationDate" returns="i4" >
      <local-vars >
        <var name="f_strExpDate" type="string" >""</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=26 y=110 ?>
          <!--psAPIGetExpDate-->
          <function name="&quot;psAPIGetExpDate&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="24" stubbed="0"/>
            <result name="Got Exp Date" link="11" stubbed="0" >f_nReturnCode == 0</result>
            <result name="No Exp Date" link="26" stubbed="0" >f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getExpDate returned " + Session.f_nReturnCode);
Server.logInfo("exp date = " + Session.g_oSUB.strExpDate);

if (-1 == Session.f_nReturnCode)
{
	Session.g_nErrorMsgNumber = 1001; //db error
}
else if (-50 == Session.f_nReturnCode)
{
	Session.g_nErrorMsgNumber = 1000; //jvm server error
}
else
{
	Session.g_nErrorMsgNumber = 0;
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=655 y=334 ?>
          <!--s_nSTATE_MAIN_MENU_PRPD_OR_POPD-->
          <return value="s_nSTATE_MAIN_MENU_PRPD_OR_POPD"/>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=288 y=203 ?>
          <!--Play Exp Date-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >547</audio>
            <audio type="date" >g_oSUB.strExpDate</audio>
          </play>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.EndSession.1" ><?xtml-editor x=824 y=69 ?></action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=358 y=37 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 5;
Server.logError("ERROR: FAIL TO GET EXP DATE");
Server.logError("ERROR: getExpDate returned " + Session.f_nReturnCode);]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=569 y=39 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="23" stubbed="0"/>
          </results>
        </action>
        <action id="26" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=291 y=373 ?>
          <!--No Exp Date-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >548</audio>
          </play>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="PlayPrepaidBalance" start="3" event="PlayPrepaidBalance" returns="i4" >
      <actions >
        <action id="3" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=231 y=269 ?>
          <!--502: Your account balance is ...-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >1</audio>
            <audio type="index" >503</audio>
            <audio type="currency" >g_oSUB.fPrepaidBalance</audio>
          </play>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=455 y=273 ?>
          <!--return MAIN_MENU-->
          <return value="s_nMAIN_MENU"/>
        </action>
      </actions>
    </function>
    <function name="MainMenu" start="31" event="MainMenu" returns="i4" >
      <local-vars >
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nCounter" type="i4" >0</var>
        <var name="f_oOptions" type="object" ></var>
        <var name="f_bRecharge" type="boolean" >0</var>
        <var name="f_bBalXfer" type="boolean" >0</var>
        <var name="f_bPlayBalance" type="boolean" >0</var>
        <var name="f_bPlayExpDate" type="boolean" >0</var>
        <var name="f_bMakeCall" type="boolean" >0</var>
        <var name="f_bReviewSD" type="boolean" >0</var>
        <var name="f_bAddSD" type="boolean" >0</var>
        <var name="f_bCustService" type="boolean" >0</var>
        <var name="f_nPACMaxAttempts" type="i4" >2</var>
        <var name="f_bCallbackMaint" type="boolean" >0</var>
        <var name="f_strSoapIp" type="string" ></var>
        <var name="f_nSoapPort" type="i4" >0</var>
        <var name="f_strTransactionId" type="string" ></var>
        <var name="f_strCallbackNumber" type="string" ></var>
        <var name="f_bValidCallbackNbr" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=18 y=32 ?>
          <!--check return code-->
          <results >
            <result name="Default" link="131" stubbed="0"/>
            <result name="Get Recharge Settings" link="125" stubbed="0" >g_bGotRechargeSettings == false</result>
            <result name="g_nNumRetry &gt;= Max" link="96" stubbed="1" >g_nNumRetry &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.nMaxLoginAttempts > 0) {
	Session.f_nPACMaxAttempts = Session.g_oAPI.nMaxLoginAttempts - 1;
}]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=278 y=494 ?>
          <!--call balanceTransfer()-->
          <function name="&quot;BalanceTransfer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=272 y=1204 ?>
          <!--call getExpirationDate()-->
          <function name="&quot;GetExpirationDate&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=278 y=603 ?>
          <!--call playPrepaidBalance()-->
          <function name="&quot;PlayPrepaidBalance&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
          </results>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=555 y=404 ?>
          <!--call creditCardRecharge()-->
          <function name="&quot;CreditCardRecharge&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Wait For Message" link="127" stubbed="0" >f_nReturnCode == s_nWAIT_FOR_MESSAGE</result>
          </results>
        </action>
        <action id="35" plug-in="Pactolus.Branch.1" ><?xtml-editor x=281 y=689 ?>
          <!--g_oSUB.fPrepaidBalance >= g_oCC.fMinPrepaidBalance-->
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="g_oSUB.fPrepaidBalance &gt;= g_oCC.fMinPrepaidBalance" link="64" stubbed="0" >g_oSUB.fPrepaidBalance  &gt;= g_oCC.fMinPrepaidBalance</result>
          </results>
        </action>
        <action id="64" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=768 y=636 ?>
          <!--return GET_DESTINATION-->
          <return value="s_nGET_DESTINATION"/>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=500 y=209 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="97" stubbed="1"/>
          </results>
        </action>
        <action id="97" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=12 y=629 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="98" stubbed="0"/>
          </results>
        </action>
        <action id="98" plug-in="Standard.EndSession.1" ><?xtml-editor x=7 y=831 ?></action>
        <action id="99" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=512 y=280 ?>
          <!--invalid choice-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error" ><?xtml-editor visible=no?></result>
            <result name="Timeout" ><?xtml-editor visible=no?></result>
            <result name="too many tries" link="97" stubbed="1" >g_nNumRetry &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (5 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuMaxInvalids;	
}]]></script>
          </scripts>
        </action>
        <action id="116" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=280 y=813 ?>
          <!--ReviewSpeedDial-->
          <function name="&quot;ReviewSpeedDials&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSPEED_DIAL_SE_ID</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="117" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=279 y=924 ?>
          <!--call AddSpeedDial()-->
          <function name="&quot;AddSpeedDial&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSPEED_DIAL_SE_ID</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
          </function>
          <results >
            <result name="Default" link="118" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="118" plug-in="Pactolus.Branch.1" ><?xtml-editor x=579 y=785 ?>
          <!--end call? failure?-->
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Failure" link="119" stubbed="0" >f_nReturnCode == s_sFAILURE</result>
            <result name="AuthorizeDest" link="122" stubbed="0" >f_nReturnCode == s_nAUTHORIZE_DESTINATION</result>
            <result name="End Call" link="98" stubbed="1" >f_nReturnCode == s_nEND_CALL</result>
            <result name="Get Dest" link="64" stubbed="0" >f_nReturnCode == s_nGET_DESTINATION</result>
          </results>
        </action>
        <action id="119" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=898 y=744 ?>
          <!--sorry, transaction can't be completed-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >363</audio>
          </play>
          <results >
            <result name="Default" link="131" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="122" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=905 y=938 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return value="s_nAUTHORIZE_DESTINATION"/>
        </action>
        <action id="124" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=590 y=508 ?>
          <!--insufficient funds-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >507</audio>
          </play>
          <results >
            <result name="Default" link="97" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="125" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=315 y=16 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="96" stubbed="1"/>
            <result name="Success" link="131" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);
if(Session.f_nReturnCode == 0)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="127" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=767 y=384 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="129" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=540 y=1159 ?>
          <!--ProcessCSRAttempt-->
          <function name="&quot;ProcessCSRAttempt&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_nPromptHoldForCSR</parameter>
            <parameter >g_nPromptNotAllowed</parameter>
            <parameter >g_oMS</parameter>
            <parameter >s_oCSR_REASONS</parameter>
            <parameter >s_nTIMEOUT</parameter>
          </function>
          <results >
            <result name="Default" link="96" stubbed="1"/>
            <result name="1 - Make Connection" link="130" stubbed="0" >f_nReturnCode == 1</result>
            <result name="2 - Route To CSR" link="130" stubbed="0" >f_nReturnCode == 2</result>
            <result name="3 - End Calll" link="130" stubbed="0" >f_nReturnCode == 3</result>
            <result name="0 - Do Noting" link="131" stubbed="1" >f_nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nStatePriorToCSR = Session.s_nMAIN_MENU;
Session.g_oACD.nCSRRouteReasonCode = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	


]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode == 1) {
	Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;
} else if(Session.f_nReturnCode == 2) {
	Session.g_nCurrentState = Session.s_nROUTE_TO_CSR;	
} else if(Session.f_nReturnCode == 3) {
	Session.g_nCurrentState = Session.s_nEND_CALL;	
}]]></script>
          </scripts>
        </action>
        <action id="130" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=290 y=1054 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oAPI.nStatePriorToCSR = Session.s_nMAIN_MENU;
Session.g_nNumRetry++;

]]></script>
          </scripts>
        </action>
        <action id="131" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=15 y=240 ?>
          <!--Main menu-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="f_nPACMaxAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >518</audio>
            <audio type="index" >f_oOptions[1].nPress</audio>
            <audio type="index" >f_oOptions[1].nOption</audio>
            <audio type="index" >f_oOptions[1].nHalfTenth</audio>
            <audio type="index" >f_oOptions[2].nPress</audio>
            <audio type="index" >f_oOptions[2].nOption</audio>
            <audio type="index" >f_oOptions[2].nHalfTenth</audio>
            <audio type="index" >f_oOptions[3].nPress</audio>
            <audio type="index" >f_oOptions[3].nOption</audio>
            <audio type="index" >f_oOptions[3].nHalfTenth</audio>
            <audio type="index" >f_oOptions[4].nPress</audio>
            <audio type="index" >f_oOptions[4].nOption</audio>
            <audio type="index" >f_oOptions[4].nHalfTenth</audio>
            <audio type="index" >f_oOptions[5].nPress</audio>
            <audio type="index" >f_oOptions[5].nOption</audio>
            <audio type="index" >f_oOptions[5].nHalfTenth</audio>
            <audio type="index" >f_oOptions[6].nPress</audio>
            <audio type="index" >f_oOptions[6].nOption</audio>
            <audio type="index" >f_oOptions[6].nHalfTenth</audio>
            <audio type="index" >f_oOptions[7].nPress</audio>
            <audio type="index" >f_oOptions[7].nOption</audio>
            <audio type="index" >f_oOptions[7].nHalfTenth</audio>
            <audio type="index" >f_oOptions[8].nPress</audio>
            <audio type="index" >f_oOptions[8].nOption</audio>
            <audio type="index" >f_oOptions[8].nHalfTenth</audio>
            <audio type="index" >f_oOptions[0].nPressCS1</audio>
            <audio type="index" >f_oOptions[0].nPressCS2</audio>
            <audio type="index" >f_oOptions[0].nOptionCS</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="132" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="133" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";

Server.logInfo("g_oCC.strBalanceTransferFlag: " + Session.g_oBALXFER.strBalanceTransferFlag);
Server.logInfo("g_oCC.strRechargableFlag: " + Session.g_oCC.strRechargableFlag);
Server.logInfo("g_oACD.strEnableFlag: " + Session.g_oACD.strEnableFlag);
Server.logInfo("g_oAPI.strCustomerServicePhone: " + Session.g_oAPI.strCustomerServicePhone);
Server.logInfo("g_oAPI.bIVRCallbackAllowed: " + Session.g_oAPI.bIVRCallbackAllowed);


//

// Assume everything is on
Session.f_oOptions[1].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[1].nPress = 311; // Press 1
Session.f_oOptions[1].nOption = 519; // CC Recharge


Session.f_oOptions[2].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[2].nPress = 312; // Press 2
Session.f_oOptions[2].nOption = 520; // Bal Xfer

Session.f_oOptions[3].nHalfTenth = 220; // Play half second
Session.f_oOptions[3].nPress = 313; // Press 3
Session.f_oOptions[3].nOption = 521; // Balance

Session.f_oOptions[4].nHalfTenth = 220; // Play half second
Session.f_oOptions[4].nPress = 314; // Press 4
Session.f_oOptions[4].nOption = 522; // Expiration Date

Session.f_oOptions[5].nHalfTenth = 220; // Play half second
Session.f_oOptions[5].nPress = 315; // Press 5
Session.f_oOptions[5].nOption = 523; // Make Call

Session.f_oOptions[6].nHalfTenth = 220; // Play half second
Session.f_oOptions[6].nPress = 316; // Press 6
Session.f_oOptions[6].nOption = 1263; // Review Speed Dials

Session.f_oOptions[7].nHalfTenth = 220; // Play half second
Session.f_oOptions[7].nPress = 317; // Press 7
Session.f_oOptions[7].nOption = 1264; // Add Speed Dials

Session.f_oOptions[8].nHalfTenth = 220; // Play half second
Session.f_oOptions[8].nPress = 318; // Press 8
Session.f_oOptions[8].nOption = 281; // Manage your callback number or initiate a callback

Session.f_oOptions[0].nOptionCS = 931;// Customer Service
Session.f_oOptions[0].nPressCS1 = 310; // Press
Session.f_oOptions[0].nPressCS2 = 1; // 0




Server.logInfo("f_oOptions.length: " + Session.f_oOptions.length);

var maxPossibleOptions = Session.f_oOptions.length;
var minPossibleOption = 5;
var counter = 2;


if("T" != Session.g_oCC.strRechargableFlag) {

	// Pull each option up
	for (var i = 1; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i+1].nOption;
	}
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
	counter--;
}


if("T" != Session.g_oBALXFER.strBalanceTransferFlag) {
	
	// Pull each option up	
	for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
	counter--;	
}


if(!Session.g_oAPI.bIVRCallbackAllowed) {
	counter = counter + 6; // 6 is the lowest possible option #
	// Pull each option up	
	for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
	
}


if("T" != Session.g_oACD.strMainMenuZeroOut && Session.g_oAPI.strCustomerServicePhone == "" ) {

	Session.f_oOptions[0].nOptionCS = 99;// Customer Service
	Session.f_oOptions[0].nPressCS1 = 99; // Press
	Session.f_oOptions[0].nPressCS2 = 99; // 0
	// Do not play half second of silence after last option
	Session.f_oOptions[Session.f_oOptions.length - 1].nHalfTenth = 99; 
}


// set options not used to 99 (1/10 silence)
for (var i = Session.f_oOptions.length; i < maxPossibleOptions; i++) {
		Session.f_oOptions[i].nOption = 99;
		Session.f_oOptions[i].nPress = 99;	
		Session.f_oOptions[i].nHalfTenth = 99; 
}

/*

Server.logInfo("Optns[0].nOptionCS: " + Session.f_oOptions[0].nOptionCS);
Server.logInfo("Optns[0].nPressCS1: " + Session.f_oOptions[0].nPressCS1);
Server.logInfo("Optns[0].nPressCS2: " + Session.f_oOptions[0].nPressCS2);

for (var i = 1; i < Session.f_oOptions.length; i++) {

	Server.logInfo("4Optns["+i+"].Optn: " + Session.f_oOptions[i].nOption);
	Server.logInfo("4Optns["+i+"].Prss: " + Session.f_oOptions[i].nPress);	
	Server.logInfo("4Optns["+i+"].HlfTnth: " + Session.f_oOptions[i].nHalfTenth);	
}
*/


]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="132" plug-in="Pactolus.Branch.1" ><?xtml-editor x=31 y=396 ?>
          <results >
            <result name="Default" link="99" stubbed="0"/>
            <result name="Recharge" link="25" stubbed="0" >f_bRecharge == true</result>
            <result name="Bal Xfer" link="18" stubbed="0" >f_bBalXfer == true</result>
            <result name="Play Balance" link="24" stubbed="0" >f_bPlayBalance == true</result>
            <result name="Make Call" link="35" stubbed="0" >f_bMakeCall == true</result>
            <result name="Review Speed Dial" link="116" stubbed="1" >f_bReviewSD == true</result>
            <result name="Add Speed Dial" link="117" stubbed="1" >f_bAddSD == true</result>
            <result name="Cust Service" link="130" stubbed="1" >f_bCustService == true</result>
            <result name="Play Exp Date" link="23" stubbed="1" >f_bPlayExpDate == true</result>
            <result name="Callback Maint" link="134" stubbed="0" >f_bCallbackMaint == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bAddSD = false;
Session.f_bBalXfer = false;
Session.f_bCustService = false;
Session.f_bMakeCall = false;
Session.f_bPlayBalance = false;
Session.f_bPlayExpDate = false;
Session.f_bRecharge = false;
Session.f_bReviewSD = false;
Session.f_bCallbackMaint = false;

if(Session.g_strDigit == "1") {

	switch (Session.f_oOptions[1].nOption) {
		case 519:
			Session.f_bRecharge = true;
			break;
		case 520:
			Session.f_bBalXfer = true;
			break;
		case 521:
			Session.f_bPlayBalance = true;
			break;
	}

} else if(Session.g_strDigit == "2") {

	switch (Session.f_oOptions[2].nOption) {
		case 520:
			Session.f_bBalXfer = true;
			break;
		case 521:
			Session.f_bPlayBalance = true;
			break;
		case 522:
			Session.f_bPlayExpDate = true;
			break;	
	}

} else if(Session.g_strDigit == "3") {

	switch (Session.f_oOptions[3].nOption) {
		case 521:
			Session.f_bPlayBalance = true;
			break;
		case 522:
			Session.f_bPlayExpDate = true;
			break;
		case 523:
			Session.f_bMakeCall = true;
			break;	
	}
} else if(Session.g_strDigit == "4") {

	switch (Session.f_oOptions[4].nOption) {
		case 522:
			Session.f_bPlayExpDate = true;
			break;
		case 523:
			Session.f_bMakeCall = true;
			break;
		case 1263:
			Session.f_bReviewSD = true;
			break;	
	}
} else if(Session.g_strDigit == "5") {

	switch (Session.f_oOptions[5].nOption) {
		case 523:
			Session.f_bMakeCall = true;
			break;
		case 1263:
			Session.f_bReviewSD = true;
			break;
		case 1264:
			Session.f_bAddSD = true;
			break;	
	}
} else if(Session.g_strDigit == "6") {

	switch (Session.f_oOptions[6].nOption) {
		case 1263:
			Session.f_bReviewSD = true;
			break;
		case 1264:
			Session.f_bAddSD = true;
			break;
		case 281:
			Session.f_bCallbackMaint = true;
			break;			
		default:
			break;	
	}
} else if(Session.g_strDigit == "7") {

	switch (Session.f_oOptions[7].nOption) {
		case 1264:
			Session.f_bAddSD = true;
			break;
		case 281:
			Session.f_bCallbackMaint = true;
			break;			
		default:
			break;	
	}
} else if(Session.g_strDigit == "8") {

	switch (Session.f_oOptions[8].nOption) {
		case 281:
			Session.f_bCallbackMaint = true;
			break;
		default:
			break;	
	}	
} else if(Session.g_strDigit == "0") {

		Session.f_bCustService = true;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuZeroOut;		

	
}






















]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 1 && Result.id != 8) {
	Session.g_nNumRetry = 0;
}]]></script>
          </scripts>
        </action>
        <action id="133" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=277 y=219 ?>
          <!--552-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >552</audio>
          </play>
          <results >
            <result name="Default" link="96" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="134" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=269 y=1357 ?>
          <!--"IVRCallbackSettings"-->
          <function name="&quot;IVRCallbackSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="97" stubbed="1"/>
            <result name="0: Success" link="131" stubbed="1" >f_nReturnCode == 0</result>
            <result name="1: Init Callback" link="135" stubbed="0" >f_nReturnCode == 1</result>
          </results>
        </action>
        <action id="135" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=561 y=1501 ?>
          <!--s_nIVR_CALLBACK_DELAY-->
          <sleep duration="s_nIVR_CALLBACK_DELAY"/>
          <results >
            <result name="Default" link="138" stubbed="0"/>
          </results>
        </action>
        <action id="137" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=461 y=1719 ?>
          <SOAP destination-ip="" transaction="" message-name="&quot;ClickToDial&quot;" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="" value="f_strSoapIp"/>
            <parameter tag="" value="f_nSoapPort"/>
            <parameter tag="" value="f_strTransactionId"/>
            <parameter tag="" value="f_strCallbackNumber"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="s_nTREATMENT_CODE_IVR_INIT"/>
            <parameter tag="" value="g_oAPI.strServiceProviderCode"/>
            <parameter tag="" value="g_oAPI.lServiceProviderId"/>
            <parameter tag="" value="g_oSUB.strUserPin"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="s_strNULL"/>
          </SOAP>
          <results >
            <result name="Default" link="98" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 2) {
	Server.logError("Error sending soap message to initiate a callback from the Main Menu. Exit on: " + Result.name);
}]]></script>
          </scripts>
        </action>
        <action id="138" plug-in="Pactolus.Branch.1" ><?xtml-editor x=254 y=1615 ?>
          <results >
            <result name="Default" link="98" stubbed="1"/>
            <result name="f_bValidCallbackNbr" link="137" stubbed="0" >f_bValidCallbackNbr == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strSoapIp = Server.soapAddress;
Session.f_nSoapPort = Server.soapPort;
Session.f_strTransactionId = Server.getUTCTime();

Session.f_bValidCallbackNbr = false;

if(Session.g_oSUB.strCallbackNumber.length > 0 && Session.g_oSUB.bCallbackNumberEnable) {
	Session.f_strCallbackNumber = Session.g_oSUB.strCallbackNumber;
	Session.f_bValidCallbackNbr = true;
} else if(Session.g_oAPI.strOriginationNumber == Session.s_strDEFAULT_ANI) {	
	Server.logInfo("WARNING: Callback Number is empty or disabled. ANI equals default ANI. System will not call user back.");
} else if(Session.g_oAPI.strOriginationNumber.length > 0) {
	Session.f_strCallbackNumber = Session.g_oAPI.strOriginationNumber;
	Server.logInfo("Callback Number is empty or disabled. ANI will be used for callback.");	
	Session.f_bValidCallbackNbr = true;	
} else {
	Server.logInfo("WARNING: Callback Number is empty or disabled. ANI is empty. System will not call user back.");	
}
]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="CreditCardRecharge" start="69" event="CreditCardRecharge" returns="i4" >
      <local-vars >
        <var name="f_strCCLast4Digits" type="string" >""</var>
        <var name="f_strInputExpDate" type="string" >""</var>
        <var name="f_bExpDateMatch" type="boolean" >0</var>
        <var name="f_strRechargeAmount" type="string" >""</var>
        <var name="f_bExceedsMaxBalance" type="boolean" >0</var>
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nTimeout" type="i4" >30</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="69" plug-in="Pactolus.Branch.1" ><?xtml-editor x=15 y=36 ?>
          <!--check rechargeable-->
          <results >
            <result name="Default" link="70" stubbed="0"/>
            <result name="Rechargeable" link="208" stubbed="0" >g_oCC.strRechargableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("INFO: service provider recharge flag: " + Session.g_oCC.strRechargableFlag);
]]></script>
          </scripts>
        </action>
        <action id="36" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1655 y=492 ?>
          <!--"recharge was successful"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >539</audio>
            <audio type="index" >546</audio>
            <audio type="currency" >g_oSUB.fPrepaidBalance</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="41" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=617 y=212 ?>
          <!--"no active credit card"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >528</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="46" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=12 y=326 ?>
          <!--get cc last 4 digits-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="f_strCCLast4Digits" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >525</audio>
            <audio type="index" >526</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" link="48" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="*" link="81" stubbed="1" >f_strCCLast4Digits match "*"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_oACD.strEnableFlag match "T"
AND f_strCCLast4Digits == "0"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strCCLast4Digits = "";
Session.f_nNumTries++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered cc digits = " + Session.f_strCCLast4Digits);
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="48" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=276 y=340 ?>
          <!--get cc exp date-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxx|x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="f_strInputExpDate" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >527</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="*" link="81" stubbed="1" >f_strInputExpDate match "*"
AND 'Result'  == 'Success'</result>
            <result name="f_bExpDateMatch==true" link="62" stubbed="0" >f_bExpDateMatch == true
AND 'Result'  == 'Success'</result>
            <result name="f_bExpDateMatch==false" link="203" stubbed="0" >'Result'  == 'Success'
AND f_bExpDateMatch == false</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >f_strInputExpDate match "0"
AND g_oACD.strEnableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strInputExpDate = "";]]></script>
            <script language="javascript" timing="middle" ><![CDATA[//check for match cc and exp date
if ((Session.g_oCC.strExpDate == Session.f_strInputExpDate) && (Session.f_strCCLast4Digits == Session.g_oCC.strCCNum)){
	Session.f_bExpDateMatch = true;
	Session.f_nNumTries = 0;
} else {
	Session.f_bExpDateMatch = false;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered exp date = " + Session.f_strInputExpDate);
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
} ]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1082 y=612 ?>
          <!--"continue or cancel"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >534</audio>
            <audio type="currency" >g_oCC.fRechargeFee</audio>
            <audio type="index" >535</audio>
            <audio type="index" >311</audio>
            <audio type="index" >536</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="201" stubbed="1"/>
            <result name="Continue" link="124" stubbed="0" >g_strDigit match "1"
AND 'Result'  == 'Success'</result>
            <result name="Cancel" link="81" stubbed="1" >g_strDigit match "*"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_strDigit match "T"
AND g_oACD.strEnableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered exp date = " + Session.f_strInputExpDate);
Session.f_bExpDateMatch = false;
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="62" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=19 y=576 ?>
          <!--get amount-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="f_nTimeout" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x.T|x.#)&quot;" language="g_oAPI.strLanguage" digits="f_strRechargeAmount" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >529</audio>
            <audio type="index" >580</audio>
            <audio type="index" >530</audio>
            <audio type="currency" >g_oCC.fMinRechargeAmount</audio>
            <audio type="index" >531</audio>
            <audio type="currency" >g_oCC.fMaxRechargeAmount</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" link="71" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="*" link="81" stubbed="1" >f_strRechargeAmount match "*"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_oACD.strEnableFlag match "T"
AND f_strRechargeAmount match "^0{1}$"</result>
            <result name="strRechargeAmount = &quot;&quot;" link="62" stubbed="0" >f_strRechargeAmount match ""</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strRechargeAmount = "";
Session.f_nNumTries++;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if (Session.f_strRechargeAmount == "")
{
	Session.f_strRechargeAmount = "0";
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user amount = " + Session.f_strRechargeAmount);
Session.g_oCC.fRechargeAmount = parseFloat(Session.f_strRechargeAmount);
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
} ]]></script>
          </scripts>
        </action>
        <action id="65" plug-in="Pactolus.Branch.1" ><?xtml-editor x=549 y=663 ?>
          <!--check max balance-->
          <results >
            <result name="Default" link="206" stubbed="0"/>
            <result name="Exceeds max balance" link="66" stubbed="0" >f_bExceedsMaxBalance == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bExceedsMaxBalance = false;
if (Session.g_oCC.fRechargeAmount > Session.g_oCC.fMaxRechargeAmount)
{
	Session.f_bExceedsMaxBalance = true;	
	Server.logInfo("recharge amount exceeds max, try again");
}
else if (Session.g_oCC.fRechargeAmount < Session.g_oCC.fMinRechargeAmount)
{
	Session.f_bExceedsMaxBalance = true;	
	Server.logInfo("recharge amount below min, try again");
}]]></script>
          </scripts>
        </action>
        <action id="66" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=825 y=647 ?>
          <!--"exceeds max balance"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >532</audio>
          </play>
          <results >
            <result name="Default" link="62" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="MaxTries, strCSROnMaxLoginsEnabled" link="211" stubbed="1" >f_nNumTries == g_sMaxLoginAttempts
AND g_oACD.strCSROnMaxLoginsEnabled match "T"</result>
          </results>
        </action>
        <action id="70" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=302 y=11 ?>
          <!--"not allowed"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >524</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="71" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=293 y=579 ?>
          <!--"continue or cancel"-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="g_sMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >339</audio>
            <audio type="currency" >g_oCC.fRechargeAmount</audio>
            <audio type="index" >335</audio>
            <audio type="index" >311</audio>
            <audio type="index" >336</audio>
            <audio type="index" >312</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="210" stubbed="1"/>
            <result name="Continue" link="65" stubbed="0" >g_strDigit match "1"
AND 'Result'  == 'Success'</result>
            <result name="Cancel" link="81" stubbed="1" >g_strDigit match "*"
AND 'Result'  == 'Success'</result>
            <result name="Try Again" link="62" stubbed="1" >g_strDigit match "2"
AND 'Result'  == 'Success'</result>
            <result name="0, strEnableFlag" link="211" stubbed="1" >g_strDigit match "0"
AND g_oACD.strEnableFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("user entered exp date = " + Session.f_strInputExpDate);
Session.f_bExpDateMatch = false;
if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=26 y=1113 ?>
          <!--return to main menu-->
          <return value="s_nMAIN_MENU"/>
        </action>
        <action id="124" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1131 y=436 ?>
          <!--please hold-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="10" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >553</audio>
          </play>
          <results >
            <result name="Default" link="209" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="200" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=563 y=105 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="201" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="201" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=23 y=1005 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="202" stubbed="0"/>
          </results>
        </action>
        <action id="202" plug-in="Standard.EndSession.1" ><?xtml-editor x=294 y=1018 ?></action>
        <action id="203" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=588 y=358 ?>
          <!--cc and date not match-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >533</audio>
          </play>
          <results >
            <result name="Default" link="46" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="MaxTries, strCSROnMaxLoginsEnabled" link="211" stubbed="1" >f_nNumTries == g_sMaxLoginAttempts
AND g_oACD.strCSROnMaxLoginsEnabled match "T"</result>
          </results>
        </action>
        <action id="204" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1700 y=627 ?>
          <!--invalid amount-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >532</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="205" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1675 y=766 ?>
          <!--transaction refuse-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >537</audio>
          </play>
          <results >
            <result name="Default" link="81" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="206" plug-in="Pactolus.Branch.1" ><?xtml-editor x=775 y=524 ?>
          <!--is there a fee?-->
          <results >
            <result name="Default" link="124" stubbed="0"/>
            <result name="rechargeFee &gt; 0" link="50" stubbed="0" >g_oCC.fRechargeFee &gt; 0</result>
          </results>
        </action>
        <action id="208" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=275 y=168 ?>
          <!--JAVA: PrepaidAPIGetActiveCC-->
          <function name="&quot;PrepaidAPIGetActiveCC&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="200" stubbed="0"/>
            <result name="0 Success" link="46" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-2 No Active CC" link="41" stubbed="0" >f_nReturnCode == -2</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getActiveCC returned " + Session.f_nReturnCode);
Server.logInfo("cc num last 4 digits =  " + Session.g_oCC.strCCNum);
Server.logInfo("cc exp date = " + Session.g_oCC.strExpDate);

if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA GET ACTIVE CC, EXIT ON: " + Result.name);
	Server.logInfo("getActiveCC returned " + Session.f_nReturnCode);
	switch (Session.f_nReturnCode)
	{
		case -1:
			Session.g_nErrorMsgNumber = 1001; //db error
			break;
		case -2:
			Session.g_nErrorMsgNumber = 2019; //no active credit card selected
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	// Set max balance

	var temp = Session.g_oCC.fMaxPrepaidBalance - Session.g_oSUB.fPrepaidBalance;
	Server.logInfo("current prepaid balance = " + Session.g_oSUB.fPrepaidBalance);
	Server.logInfo("max pp balance = " + Session.g_oCC.fMaxPrepaidBalance);
	Server.logInfo("max recharge amount = " + Session.g_oCC.fMaxRechargeAmount);

	if (temp > 0 && Session.g_oCC.fMaxRechargeAmount > temp){
		Session.g_oCC.fMaxRechargeAmount = temp;
	}

	Session.g_oCC.fMaxRechargeAmount = Math.floor(Session.g_oCC.fMaxRechargeAmount);
	Session.g_oCC.fMinRechargeAmount = Math.ceil(Session.g_oCC.fMinRechargeAmount);

}]]></script>
          </scripts>
        </action>
        <action id="209" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1373 y=602 ?>
          <!--JAVA: PrepaidAPIDoCCRecharge-->
          <function name="&quot;PrepaidAPIDoCCRecharge&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="200" stubbed="1"/>
            <result name="0 - Success" link="36" stubbed="0" >f_nReturnCode == 0</result>
            <result name="-5 - Max Balance" link="204" stubbed="0" >f_nReturnCode == -5</result>
            <result name="Trans Refused" link="205" stubbed="0" >f_nReturnCode == -2
OR f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -8
OR f_nReturnCode == -9
OR f_nReturnCode == -10
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("doCCRecharge returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO DO CC RECHARGE");
	Server.logError("ERROR: doCCRecharge returned: " + Session.f_nReturnCode);
	switch (Session.f_nReturnCode)
	{
		case -1:
			Session.g_nErrorMsgNumber = 1001; //db error
			break;
		case -2:
			Session.g_nErrorMsgNumber = 2007; //credit card refuse
			break;
		case -3:
			Session.g_nErrorMsgNumber = 2008; //credit card fraud
			break;
		case -4:
			Session.g_nErrorMsgNumber = 2009; //credit card not active
			break;
		case -5:
			Session.g_nErrorMsgNumber = 2006; //exceed max balance
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1011; //locked pin
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2010; //credit card expired
			break;
		case -8:
			Session.g_nErrorMsgNumber = 2011; //credit card invalid
			break;
		case -9:
			Session.g_nErrorMsgNumber = 2012; //credit card bad data
			break;
		case -10:
			Session.g_nErrorMsgNumber = 2013; //credit card missing data
			break;
		case -11:
			Session.g_nErrorMsgNumber = 2014; //cyber source timeout
			break;
		case -12:
			Session.g_nErrorMsgNumber = 2015; //cyber source error
			break;
		case -13:
			Session.g_nErrorMsgNumber = 2016; //cyber source net work error
			break;
		case -14:
			Session.g_nErrorMsgNumber = 2017; //cyber source system config error
			break;
		case -15:
			Session.g_nErrorMsgNumber = 2018; //cyber source unknown error
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="210" plug-in="Pactolus.Branch.1" ><?xtml-editor x=17 y=789 ?>
          <results >
            <result name="Default" link="201" stubbed="1"/>
            <result name="strCSROnMaxLoginsEnabled" link="211" stubbed="1" >g_oACD.strCSROnMaxLoginsEnabled match "T"</result>
          </results>
        </action>
        <action id="211" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=21 y=885 ?>
          <!--RouteToCSR-->
          <function name="&quot;RouteToCSR&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="201" stubbed="1"/>
            <result name="Success" link="212" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.f_nNumTries == Session.g_sMaxLoginAttempts) {
	Session.g_oACD.nCSRRouteReasonCode = 2;	
} else {
	Session.g_oACD.nCSRRouteReasonCode = 3;
}

Session.g_oACD.lCSRRequestSkillId = 1;
Session.g_oAPI.nStatePriorToCSR = Session.s_nCC_RECHARGE;
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="212" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=281 y=885 ?>
          <!--s_nWAIT_FOR_MESSAGE-->
          <return value="s_nWAIT_FOR_MESSAGE"/>
        </action>
      </actions>
    </function>
    <function name="PlayTimeAvailable" start="1" event="PlayTimeAvailable" returns="void" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=191 y=328 ?>
          <!--calculation mins and secs-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nTimeAvailable = Session.g_oSUB.nSecondsAnnounce / 60;
Session.g_nTempInt = Session.g_oSUB.nSecondsAnnounce % 60;]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=458 y=323 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="0 minute" link="3" stubbed="0" >g_nTimeAvailable == 0</result>
            <result name="1 minute" link="4" stubbed="0" >g_nTimeAvailable == 1</result>
            <result name="2 or more minutes" link="5" stubbed="0" >g_nTimeAvailable &gt; 1</result>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=742 y=302 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0 second" link="6" stubbed="0" >g_nTempInt == 0</result>
            <result name="1 second" link="7" stubbed="0" >g_nTempInt == 1</result>
            <result name="2 or more seconds" link="8" stubbed="0" >g_nTempInt &gt; 1</result>
          </results>
        </action>
        <action id="4" plug-in="Pactolus.Branch.1" ><?xtml-editor x=696 y=594 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0 second" link="10" stubbed="0" >g_nTempInt == 0</result>
            <result name="1 second" link="11" stubbed="0" >g_nTempInt == 1</result>
            <result name="2 or more seconds" link="12" stubbed="0" >g_nTempInt &gt; 1</result>
          </results>
        </action>
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=667 y=1091 ?>
          <!--calculate mins and secs-->
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0 second" link="14" stubbed="0" >g_nTempInt == 0</result>
            <result name="1 second" link="13" stubbed="0" >g_nTempInt == 1</result>
            <result name="2 or more seconds" link="9" stubbed="0" >g_nTempInt &gt; 1</result>
          </results>
        </action>
        <action id="6" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1170 y=101 ?>
          <!--517: You have ...-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="7" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1203 y=266 ?>
          <!--517: You have ...-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1198 y=432 ?>
          <!--517: You have ...-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >46</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="9" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=929 y=1324 ?>
          <!--517: You have x minutes and x seconds-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >309</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >46</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="10" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=987 y=520 ?>
          <!--517: You have 1 minute-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >308</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=981 y=693 ?>
          <!--517: You have 1 minute and 1 second-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >308</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="12" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=950 y=847 ?>
          <!--517: You have 1 minutes and x seconds-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >308</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >46</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="13" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=929 y=1165 ?>
          <!--517: You have x minutes and 1 second-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >309</audio>
            <audio type="index" >52</audio>
            <audio type="number" >g_nTempInt</audio>
            <audio type="index" >54</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="14" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=930 y=1014 ?>
          <!--517: You have x minutes-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="number" >g_nTimeAvailable</audio>
            <audio type="index" >309</audio>
            <audio type="index" >516</audio>
          </play>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="16" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=683 y=195 ?>
          <return value=""/>
        </action>
      </actions>
    </function>
    <function name="OnServiceLoad" start="1" event="OnServiceLoad" returns="void" >
      <parameters >
        <parameter name="strAppName" type="string"/>
        <parameter name="nSessionCount" type="i2"/>
        <parameter name="nMaxIterations" type="i2"/>
        <parameter name="nServerId" type="i2"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=31 y=70 ?>
          <!--GET PSX IP from config-->
          <user-function process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;get_property&quot;" timeout="s_nTIMEOUT" return="" async="0" >
            <parameter >"primary-softswitch"</parameter>
            <parameter >s_strPrimaryPSX</parameter>
            <parameter >"backup-softswitch"</parameter>
            <parameter >s_strBackupPSX</parameter>
            <parameter >"appserver-logical-ip"</parameter>
            <parameter >s_strLocalHost</parameter>
            <parameter >"prepaid-default-ani"</parameter>
            <parameter >s_strDEFAULT_ANI</parameter>
            <parameter >"send-alarm-flag"</parameter>
            <parameter >s_strSendAlarmFlag</parameter>
            <parameter >"prepend-to-outdial"</parameter>
            <parameter >s_strDigitPrependToOutDial</parameter>
            <parameter >"packetization-period"</parameter>
            <parameter >s_nPacketizationPeriod</parameter>
            <parameter >"media-server-type"</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >"ms-connect-retry"</parameter>
            <parameter >s_strMSRetryFlag</parameter>
            <parameter >"outdial-dialing-plan"</parameter>
            <parameter >s_strOutdialDialingPlan</parameter>
            <parameter >"outdial-digit-map"</parameter>
            <parameter >s_strOutdialDigitMap</parameter>
            <parameter >"ring-no-answer-time"</parameter>
            <parameter >s_nRING_NO_ANSWER_TIME</parameter>
            <parameter >"session-timer-enabled"</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >"session-timer-interval"</parameter>
            <parameter >s_nSessionTimerInterval</parameter>
            <parameter >"intl-min-connect-time"</parameter>
            <parameter >s_nIntlMinConnectTime</parameter>
            <parameter >"dom-min-connect-time"</parameter>
            <parameter >s_nDomMinConnectTime</parameter>
            <parameter >"ignore-pin-language"</parameter>
            <parameter >s_strIgnorePinLanguage</parameter>
            <parameter >"prepaid-start-call-delay"</parameter>
            <parameter >s_fPreStartCallDelay</parameter>
            <parameter >"codec"</parameter>
            <parameter >s_strCodec</parameter>
            <parameter >"customer-code"</parameter>
            <parameter >s_strCustomerCode</parameter>
            <parameter >"send-info-msg"</parameter>
            <parameter >s_strSendInfoMsg</parameter>
            <parameter >"play-language-menu"</parameter>
            <parameter >s_strPLAY_LANGUAGE_MENU</parameter>
            <parameter >"send-precall-info-msg"</parameter>
            <parameter >s_strSendPrecallInfoMsg</parameter>
            <parameter >"acd-media-server-type"</parameter>
            <parameter >s_strACDMediaServerType</parameter>
            <parameter >"moh-media-server-type"</parameter>
            <parameter >s_strMOHMediaServerType</parameter>
            <parameter >"ivr-callback-delay"</parameter>
            <parameter >s_nIVR_CALLBACK_DELAY</parameter>
            <parameter >"prepend-service-provider-code"</parameter>
            <parameter >s_strPrependSVC</parameter>
            <parameter >"service-element-id"</parameter>
            <parameter >s_nSERVICE_ELEMENT_ID</parameter>
          </user-function>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.s_strApplicationName = Session._appName;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.s_strPrimaryPSX.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR PRIMARY SOFTSWITCH.");
}
if (Session.s_strBackupPSX.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR BACKUP SOFTSWITCH.");
}
if (Session.s_strLocalHost.length <= 0)
{
	Session.s_strLocalHost = Server.ipAddress;
	Server.logInfo("WARNING:  NO SETTING FOR LOCAL HOST IP ADDRESS.  USE DEFAULT: " + Session.s_strLocalHost);
}
if (Session.s_strDEFAULT_ANI.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR PREPAID DEFAULT ANI.");
}
if (Session.s_strSendAlarmFlag.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR SEND ALARM FLAG.");
}
if (Session.s_strDigitPrependToOutDial.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR DIGIT PREPEND TO OUTDIAL.");
}
if (Session.s_nPacketizationPeriod <= 0)
{
	Session.s_nPacketizationPeriod = 20;
	Server.logInfo("WARNING: NO SETTING FOR PACKETIZATION PERIOD.  USE DEFAULT: " + Session.s_nPacketizationPeriod);
}
if (Session.s_strMSType.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR MEDIA SERVER TYP, DEAULT WILL BE PCS.");
	Session.s_strMSType = "PCS";
}
if (Session.s_strACDMediaServerType.length <= 0)
{
	Session.s_strACDMediaServerType = Session.s_strMSType;
	Server.logInfo("WARNING:  NO SETTING FOR ACD MEDIASERVER TYPE.  USE s_strMSType");
}
if (Session.s_strMOHMediaServerType.length <= 0)
{
	Session.s_strMOHMediaServerType = Session.s_strMSType;
	Server.logInfo("WARNING:  NO SETTING FOR MOH MEDIASERVER TYPE.  USE s_strMSType");
}
if (Session.s_strMSRetryFlag.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR RETRY TO CONNECT TO MEDIASERVER.");
}
if (Session.s_strOutdialDialingPlan.length <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR OUTDIAL DIALING PLAN.");
}
if (Session.s_strOutdialDigitMap.length <= 0)
{
	Session.s_strOutdialDigitMap = "(1xxxxxxxxxx|[2-9]xxxxxxxxx|xx.*|x.#|x.T|*x)";
	Server.logInfo("WARNING: NO SETTING OUTDIAL DIGIT MAP.  USE DEFAULT: " + Session.s_strOutdialDigitMap);
}
if (Session.s_nRING_NO_ANSWER_TIME <= 0)
{
	Session.s_nRING_NO_ANSWER_TIME = 60;
	Server.logInfo("WARNING: NO SETTING RING NO ANSWER TIME.  USE DEFAULT: " + Session.s_nRING_NO_ANSWER_TIME);
}

if(Session.s_strPLAY_LANGUAGE_MENU.length <= 0) 
{
	Session.s_strPLAY_LANGUAGE_MENU = "F";
	Server.logInfo("WARNING: NO SETTING FOR PLAY LANGUAGE MENU.  USE DEFAULT: " + Session.s_strPLAY_LANGUAGE_MENU);
}


if(Session.s_nIVR_CALLBACK_DELAY <= 0) {
	Session.s_nIVR_CALLBACK_DELAY = 5;
	Server.logInfo("WARNING: NO SETTING CALLBACK DELAY.  USE DEFAULT: " + Session.s_nIVR_CALLBACK_DELAY);	
}


if (Session.s_strSessionTimerFlag.length <= 0 || "F" == Session.s_strSessionTimerFlag)
{
	Session.s_strSessionTimerFlag = "F";
	Server.logInfo("WARNING: NO SETTING FOR SESSION TIMER FLAG.  USE DEFAULT: F");
	Session.s_nSessionTimerInterval = 0;
	Server.logInfo("WARNING: NO SETTING SESSION TIMER INTERVAL.  USE DEFAULT: 0");

}
else
{
	if (Session.s_nSessionTimerInterval <= 0)
	{
		Session.s_nSessionTimerInterval = 120;
		Server.logInfo("WARNING: NO SETTING SESSION TIMER INTERVAL.  USE DEFAULT: 120");
	}
}

if(Session.s_nSERVICE_ELEMENT_ID == undefined ||
   Session.s_nSERVICE_ELEMENT_ID <= 0) {
   
	Session.s_nSERVICE_ELEMENT_ID = 1;
	Server.logInfo("WARNING: NO SETTING FOR SERVICE ELEMENT ID.  USE DEFAULT: " + Session.s_nSERVICE_ELEMENT_ID);   
	   
  } 	


if (Session.s_strOutdialDialingPlan.length <= 0)
{
	Session.s_strOutdialDialingPlan = "1";
	Server.logInfo("WARNING: NO SETTING FOR DIALING PLAN.  USE DEFAULT: 1");
}
if (Session.s_nIntlMinConnectTime <= 0)
{
	Server.logInfo("WARNING:  NO SETTING FOR INTL MINIMUM CONNECT TIME.");
}
if (Session.s_nDomMinConnectTime)
{
	Server.logInfo("WARNING:  NO SETTING FOR DOMESTIC MINIMUM CONNECT TIME.");
}
if (Session.s_strIgnorePinLanguage.length <= 0)
{
 Session.s_strIgnorePinLanguage = "F";
}
if (Session.s_strCodec.length <= 0)
{
	Session.s_strCodec = "PCMU";
	Server.logInfo("WARNING: NO SETTING FOR CODEC.  USE DEFAULT: PCMU");
}

Session.s_nSoapPort = Server.soapPort;

if (Session.s_strSendInfoMsg.length <= 0)
{
	Session.s_strSendInfoMsg = "F";
	Server.logInfo("WARNING: NO SETTING SENDING INFO MESSAGE.  USE DEFAULT: " + Session.s_strSendInfoMsg);
}

if (Session.s_strSendPrecallInfoMsg.length <= 0)
{
	Session.s_strSendPrecallInfoMsg = "F";
	Server.logInfo("WARNING: NO SETTING SENDING INFO MESSAGE PRECALL.  USE DEFAULT: " + Session.s_strSendPrecallInfoMsg);
}

Session.s_strVia = Session.s_strSIPVERSION + "/" + Session.s_strPROTOCOL + " " + Server.sipAddress + ":" + Server.sipPort ;
Server.logInfo("VIA = " + Session.s_strVia);



js_initCSR_REASONS(Session.s_oCSR_REASONS);
]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=704 y=109 ?>
          <return value=""/>
        </action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=458 y=64 ?>
          <!--APIGetTestData-->
          <function name="&quot;APIGetTestData&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oTEST</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_initTEST(Session.g_oTEST);


]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.lockSharedVariables();
Session.s_strTestModeFlag = Session.g_oTEST.strPrepaidTestFlag;
Server.unlockSharedVariables();]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=252 y=71 ?>
          <!--PrepaidAPIDeleteLockPins-->
          <function name="&quot;PrepaidAPIDeleteLockPins&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >s_strLocalHost</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnSessionEnd" start="34" event="OnSessionEnd" returns="void" >
      <parameters >
        <parameter name="nSessionEndReason" type="i2"/>
      </parameters>
      <local-vars >
        <var name="f_oNullArray" type="object" ></var>
        <var name="f_nReturnCode" type="i4" >-10</var>
      </local-vars>
      <actions >
        <action id="34" plug-in="Pactolus.Branch.1" ><?xtml-editor x=77 y=171 ?>
          <!--fail to connect to MS-->
          <results >
            <result name="Default" link="24" stubbed="0"/>
            <result name="g_bFailToConnectToMS" link="2" stubbed="1" >g_bFailToConnectToMS == true</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=63 y=851 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("INFO: prepaid.END SESSION.3: SUCCESS");
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=978 y=291 ?>
          <!--procSessionCompletion-->
          <function name="&quot;ProcSessionCompletion&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="22" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=79 y=380 ?>
          <!--delete MS connection-->
          <function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="26" stubbed="0"/>
            <result name="MOH.bCurrentlyInConf" link="28" stubbed="0" >g_oMOH.bCurrentlyInConf == true</result>
          </results>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=340 y=170 ?>
          <!--StopTimers-->
          <function name="&quot;StopTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oArrayCallLegs</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="38" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;


]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=556 y=431 ?>
          <!--DeleteConference-->
          <function name="&quot;DeleteConference&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oConfMS</parameter>
          </function>
          <results >
            <result name="Default" link="29" stubbed="1"/>
          </results>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=314 y=341 ?>
          <!--delete MOH connection-->
          <function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="" >
            <parameter >g_oMOH</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="0"/>
          </results>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=334 y=487 ?>
          <!--"DisconnectFromMOH"-->
          <function name="&quot;DisconnectFromMOH&quot;" return="" external-function="1" library="lib_moh.xml" >
            <parameter >g_oMOH</parameter>
            <parameter >g_oMOH.strSessionId</parameter>
            <parameter >g_oMOH.nConfIndex</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
          </function>
          <results >
            <result name="Default" link="25" stubbed="0"/>
          </results>
        </action>
        <action id="29" plug-in="Pactolus.Branch.1" ><?xtml-editor x=72 y=652 ?>
          <!--what state-->
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Begin Assignment" link="30" stubbed="0" >g_bBeginAssignment == true</result>
            <result name="Begin Request or Requeue" link="32" stubbed="0" >g_bBeginRequest == true</result>
          </results>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=322 y=615 ?>
          <!--Soap EndRequest-->
          <function name="&quot;MsgEndRequestCSR&quot;" return="" external-function="1" library="lib_soap.xml" >
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
        </action>
        <action id="31" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=548 y=614 ?>
          <!--"ACDAPIEndAssignment"-->
          <function name="&quot;ACDAPIEndAssignment&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="33" stubbed="1"/>
          </results>
        </action>
        <action id="32" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=344 y=747 ?>
          <!--Soap EndRequest-->
          <function name="&quot;MsgEndRequestCSR&quot;" return="" external-function="1" library="lib_soap.xml" >
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="33" stubbed="0"/>
          </results>
        </action>
        <action id="33" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=566 y=743 ?>
          <!--"ACDAPIEndRequest"-->
          <function name="&quot;ACDAPIEndRequest&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="36" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=728 y=355 ?>
          <!--JAVA: psAPIProcCallCompletion-->
          <function name="&quot;psAPIProcCallCompletion&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >f_oNullArray</parameter>
          </function>
          <results >
            <result name="Default" link="21" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START CallComletion *********");
Session.f_oNullArray.length = 0;
Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("procCallCompletion returned " + Session.f_nReturnCode);
if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL PROC CALL COMPLETION");
	Server.logError("ERROR: procCallCompletion returned: " + Session.f_nReturnCode);
}


Server.logInfo("g_oAPI.nSessionTerminationReason: " + Session.g_oAPI.nSessionTerminationReason);]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.Branch.1" ><?xtml-editor x=602 y=186 ?>
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="oAPI.bALegRatingOn" link="36" stubbed="0" >g_oAPI.bALegRatingOn == true</result>
          </results>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="544" y-coord="310" width="198" height="61" text="may not in MOH conference, but may use MOH ms" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="OnCancel" start="6" event="OnCancel" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string"/>
        <parameter name="strAcceptEncoding" type="string"/>
        <parameter name="strAcceptLanguage" type="string"/>
        <parameter name="strAuthorization" type="string"/>
        <parameter name="strCallId" type="string"/>
        <parameter name="strContent" type="string"/>
        <parameter name="strContentDisposition" type="string"/>
        <parameter name="strContentType" type="string"/>
        <parameter name="strCSeq" type="string"/>
        <parameter name="strDate" type="string"/>
        <parameter name="strEncryption" type="string"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string"/>
        <parameter name="strMaxForwards" type="string"/>
        <parameter name="strProxyAuthorization" type="string"/>
        <parameter name="strProxyRequire" type="string"/>
        <parameter name="strRecordRoute" type="string"/>
        <parameter name="strRequestUri" type="string"/>
        <parameter name="strRequire" type="string"/>
        <parameter name="strResponseKey" type="string"/>
        <parameter name="strRoute" type="string"/>
        <parameter name="strSupported" type="string"/>
        <parameter name="strTimestamp" type="string"/>
        <parameter name="strTo" type="string"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string"/>
      </parameters>
      <actions >
        <action id="6" plug-in="Pactolus.Branch.1" ><?xtml-editor x=85 y=219 ?>
          <!--valid?-->
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="sent final response == false" link="1" stubbed="0" >g_bSentFinalResponse == false</result>
          </results>
        </action>
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=310 y=371 ?>
          <!--200 OK-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=543 y=373 ?>
          <!--487 Request Terminated-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 487 Request Terminated"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var cseq = new SipCSeq(Session.strCSeq);
cseq.method = "INVITE";
Session.strCSeq = cseq.encode();]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.EndSession.1" ><?xtml-editor x=1035 y=300 ?></action>
        <action id="7" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=303 y=163 ?>
          <!--200 OK-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=781 y=370 ?>
          <!--send alert early-call-cancel-->
          <user-function process="&quot;PACTOLUS_ps_snmp_event&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"early-call-cancel"</parameter>
          </user-function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="PlayPromptAndHangup" start="5" event="PlayPromptAndHangup" returns="i4" >
      <actions >
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=104 y=140 ?>
          <!--error msg > 0 ?-->
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="error msg &gt; 0 ?" link="8" stubbed="0" >g_nErrorMsgNumber &gt; 0</result>
          </results>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=775 y=223 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="0"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=989 y=223 ?>
          <return value=""/>
        </action>
        <action id="8" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=323 y=233 ?>
          <!--g_nErrorMsgNumber-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >365</audio>
            <audio type="number" >g_nErrorMsgNumber</audio>
          </play>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="9" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=550 y=231 ?>
          <!--good bye-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="5" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnCSRBeginAssignment" start="3" event="OnCSRBeginAssignment" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="lCSRAssignmentId" type="i8" pass="byref"/>
        <parameter name="lCSRRequestId" type="i8" pass="byref"/>
        <parameter name="lCSRUserId" type="i8" pass="byref"/>
        <parameter name="lCSRRequestSkillId" type="i8" pass="byref"/>
        <parameter name="strCSRRequestSkillName" type="string" pass="byref"/>
        <parameter name="lCSRRequestLanguageId" type="i8" pass="byref"/>
        <parameter name="strCSRRequestLanguageName" type="string" pass="byref"/>
        <parameter name="lCSRRequestGroupId" type="i8" pass="byref"/>
        <parameter name="strCSRRequestGroupName" type="string" pass="byref"/>
        <parameter name="nCSRRequestType" type="i4" pass="byref"/>
        <parameter name="strCSRRequestTypeName" type="string" pass="byref"/>
        <parameter name="lServiceProviderId" type="i8" pass="byref"/>
        <parameter name="strServiceProviderName" type="string" pass="byref"/>
        <parameter name="lOfferingId" type="i8" pass="byref"/>
        <parameter name="strOfferingName" type="string" pass="byref"/>
        <parameter name="strConfEventId" type="string" pass="byref"/>
        <parameter name="strConfModPasscode" type="string" pass="byref"/>
        <parameter name="strSubscriberAccount" type="string" pass="byref"/>
        <parameter name="strSubscriberFirstName" type="string" pass="byref"/>
        <parameter name="strSubscriberLastName" type="string" pass="byref"/>
        <parameter name="strCSRAppServerIP" type="string" pass="byref"/>
        <parameter name="strCSRAssignmentType" type="string" pass="byref"/>
        <parameter name="lCSRAssignmentDuration" type="i8" pass="byref"/>
        <parameter name="strSubscriberPin" type="string" pass="byref"/>
        <parameter name="strCSRAssignmentAction" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_oMS" type="object" ></var>
        <var name="f_bUsedMOH_MS" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=118 y=52 ?>
          <!--"BeginCSRAssignment"-->
          <function name="&quot;BeginCSRAssignment&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_nCurrentState</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >f_oMS</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >s_nPROMPT_JOIN_TONE</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oTimerHeartBeat</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="SUCCESS" link="5" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();


Session.g_nCurrentState = Session.s_nBEGINASSIGNMENT;
Session.g_bBeginAssignment = true;

Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_oACD.lCSRAssignmentId = new String(Session.lCSRAssignmentId);
Session.g_oACD.lCSRRequestId = Session.lCSRRequestId;
Session.g_oACD.lCSRUserId = Session.lCSRUserId;
Session.g_oACD.lCSRRequestSkillId = Session.lCSRRequestSkillId;
Session.g_oACD.strCSRRequestSkillName = Session.strCSRRequestSkillName;
Session.g_oACD.lCSRRequestLanguageId = Session.lCSRRequestLanguageId;
Session.g_oACD.strCSRRequestLanguageName = Session.strCSRRequestLanguageName;
Session.g_oACD.lCSRRequestGroupId = Session.lCSRRequestGroupId;
Session.g_oACD.strCSRRequestGroupName = Session.strCSRRequestGroupName;
Session.g_oACD.nCSRRequestType = Session.nCSRRequestType;
Session.g_oACD.strCSRRequestTypeName = Session.strCSRRequestTypeName;

Session.g_oACD.strCSRAssignmentAction = Session.strCSRAssignmentAction;


Session.g_oACD.lCSRAssignmentStartTime = Server.getUTCTime();
Session.g_oACD.strCSRAppServerIP = Session.strCSRAppServerIP;

if (Session.g_oMOH.bCurrentlyInConf || Session.g_oMOH.bCurrentlyConnected)
{
	Session.f_oMS = Session.g_oMOH;
	Session.f_bUsedMOH_MS = true;
}
else
{
	Session.f_oMS = Session.g_oMS;
}

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (Session.f_bUsedMOH_MS)
{
	Session.g_oMOH = Session.f_oMS;
}
else
{
	Session.g_oMS = Session.f_oMS;
}


]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=503 y=81 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="6" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=388 y=284 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.EndSession.1" ><?xtml-editor x=722 y=98 ?></action>
      </actions>
    </function>
    <function name="OnCSREndAssignment" start="1" event="OnCSREndAssignment" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strCSRTransactionId" type="string" pass="byref"/>
        <parameter name="lCSRAssignmentId" type="string" pass="byref"/>
        <parameter name="lCSRRequestId" type="i8" pass="byref"/>
        <parameter name="lCSRUserId" type="i8" pass="byref"/>
        <parameter name="strCSRAssignmentAction" type="string" pass="byref"/>
        <parameter name="strPasscode" type="string" pass="byref"/>
        <parameter name="strPrepaidPIN" type="string" pass="byref"/>
        <parameter name="strPostpaidPIN" type="string" pass="byref"/>
        <parameter name="strPostpaidAccountNumber" type="string" pass="byref"/>
        <parameter name="strOutdialPhoneNumber" type="string" pass="byref"/>
        <parameter name="nCSRAvailabilityState" type="i4" pass="byref"/>
        <parameter name="strBillableFlag" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=16 y=34 ?>
          <!--"EndCSRAssignment"-->
          <function name="&quot;EndCSRAssignment&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oACD.strCSRAssignmentAction</parameter>
            <parameter >g_oAPI.nCallTerminationReason</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_bNullFlag</parameter>
            <parameter >g_oNULL</parameter>
            <parameter >g_oTimerMaxWaitCSR</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Outdial" link="9" stubbed="0" >f_nReturnCode == 1
OR f_nReturnCode == 6</result>
            <result name="Get Dest" link="6" stubbed="0" >f_nReturnCode == 2</result>
            <result name="Get Pin" link="7" stubbed="0" >f_nReturnCode == 3</result>
            <result name="IVR" link="10" stubbed="0" >f_nReturnCode == 4</result>
            <result name="Do Nothin" link="2" stubbed="1" >f_nReturnCode == 5</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();


Session.g_bBeginAssignment = false;

Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strCSRTransactionId;
Session.g_oACD.lCSRAssignmentId = Session.lCSRAssignmentId;
Session.g_oACD.lCSRRequestId = Session.lCSRRequestId;
Session.g_oACD.lCSRUserId = Session.lCSRUserId;
Session.g_oACD.strCSRAssignmentAction = Session.strCSRAssignmentAction;

if(Session.strBillableFlag != "" && Session.strBillableFlag != " ") {
	Session.g_oCallLegB.strBillableFlag = Session.strBillableFlag;
}	


if (Session.g_oAPI.nStatePriorToCSR == Session.s_nGET_PIN || Session.g_oAPI.nStatePriorToCSR == Session.s_nSTATE_LANGUAGE_MENU)
{
	Session.g_oSUB.strUserPin = Session.strPrepaidPIN;
}



if(Session.strPostpaidAccountNumber.length > 0) {
	Session.g_oSUB.strAccountNumber = Session.strPostpaidAccountNumber;
}

if(Session.strPostpaidPin.length > 0) {
	Session.g_oSUB.strUserPin = Session.g_oSUB.strAccountNumber + Session.strPostpaidPin;
}


Session.g_oACD.strOutdialBLegPhoneNumber = Session.strOutdialPhoneNumber;
Session.g_oAPI.strDestinationNumber = Session.strOutdialPhoneNumber;


if ("6" == Session.strCSRAssignmentAction || "7" == Session.strCSRAssignmentAction || "13" == Session.strCSRAssignmentAction) {
	Session.g_nCurrentState = Session.s_nREQUEUE;
} else {
	Session.g_bBeginRequest = false;
}


Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Session.f_nReturnCode == 6) {
	Session.g_oACD.bCSRWithAB = false;
} else if(Session.f_nReturnCode == 1) {
	Session.g_oCallLegB.bReverseFromTo = false;
	Session.g_oCallLegB.bCurrentlyDialing = false;
	Session.g_oCallLegB.bAttemptedToOutdial = false;
	Session.g_oCallLegB.bConnected = false;
	Session.g_oCallLegB.strSessionTimerFlag = Session.s_strSessionTimerFlag;
	Session.g_oCallLegB.nSessionTimer = Session.s_nSessionTimerInterval;
	Session.g_oCallLegB.nRingNoAnswerTime = Session.s_nRING_NO_ANSWER_TIME;

	if(Session.g_oAPI.strPrimarySoftswitchIP.length > 0) {
		Session.g_oCallLegB.strRequestUri = Session.g_oAPI.strPrimarySoftswitchIP;
	} else {
		Session.g_oCallLegB.strRequestUri = Session.s_strPrimaryPSX;
	}

	if(Session.g_oAPI.strBackupSoftswitchIP.length > 0) {
		Session.g_oCallLegB.strBackupRequestUri = Session.g_oAPI.strBackupSoftswitchIP;
	} else {
		Session.g_oCallLegB.strBackupRequestUri = Session.s_strBackupPSX;
	}

	Session.g_oCallLegB.strCallId = "";
	Session.g_oCallLegB.strContent = "";
	Session.g_oCallLegB.strCSeq = "";
	Session.g_oCallLegB.strFrom = "";
	Session.g_oCallLegB.strTo = "";
	Session.g_oCallLegB.strRoute = "";
	Session.g_oCallLegB.strRecordRoute = "";
	Session.g_oCallLegB.strContact = "";
	Session.g_oCallLegB.nSetUpTime = 0;
	Session.g_oCallLegB.nTearDownTime = 0;
	Session.g_oCallLegB.strCodec = Session.s_strCodec;
}


if(2 != Result.id && 6 != Result.id) {

	Server.logInfo("Reset lCSRAssignmentId and lCSRUserId.");
	Session.g_oACD.lCSRAssignmentId = 0;
	Session.g_oACD.lCSRUserId = 0;	
}




js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=582 y=271 ?>
          <return value="f_nReturnCode"/>
        </action>
        <action id="3" plug-in="Standard.EndSession.1" ><?xtml-editor x=641 y=21 ?></action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=290 y=18 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 19;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=490 y=474 ?>
          <!--Main-->
          <function name="&quot;Main&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=300 y=199 ?>
          <!--Get Dest-->
          <function name="&quot;GetDestNumber&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=291 y=295 ?>
          <!--Get Pin-->
          <function name="&quot;GetPinNumberPrpdOrPopd&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=299 y=106 ?>
          <!--Main-->
          <function name="&quot;Main&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;
Session.g_oCallLegB.strCSROutdialFlag = "T";

]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=157 y=384 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Auth Pin?" link="11" stubbed="0" >g_nCurrentState == s_nAUTHENTICATE_PIN</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
switch (Session.g_oAPI.nStatePriorToCSR)
{
	case Session.s_nSTATE_GET_PIN_PRPD_OR_POPD:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;
	case Session.s_nGET_PIN:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;	
	case Session.s_nSTATE_GET_PIN_POPD:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;			
	case Session.s_nGET_DESTINATION:
		Session.g_nCurrentState = Session.s_nGET_DESTINATION;
		break;
	case Session.s_nCC_RECHARGE:
		Session.g_nCurrentState = Session.s_nMAIN_MENU;	
		break;
	case Session.s_nBALANCE_XFER:
		Session.g_nCurrentState = Session.s_nBALANCE_XFER;	
		break;
	case Session.s_nMAIN_MENU:
		Session.g_nCurrentState = Session.s_nMAIN_MENU;	
		break;
	case Session.s_nSTATE_MAIN_MENU_POPD:
		Session.g_nCurrentState = Session.s_nSTATE_MAIN_MENU_POPD;	
		break;		
	case Session.s_nSTATE_MAIN_MENU_PRPD_OR_POPD:
		Session.g_nCurrentState = Session.s_nSTATE_MAIN_MENU_PRPD_OR_POPD;	
		break;				
	case Session.s_nSPEED_DIAL:
		Session.g_nCurrentState = Session.s_nSPEED_DIAL;
		break;						
	case Session.s_nSTATE_LANGUAGE_MENU:
		if(Session.g_oSUB.strUserPin.length > 0) {
			Session.g_nCurrentState = Session.s_nSTATE_AUTH_PRPD_OR_POPD;
		} else {
			Session.g_nCurrentState = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;
		}
		break;	
	default:
		Server.logError("UNKNOWN STATE PRIOR TO CSR.");
		break;
}
]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=261 y=567 ?>
          <!--"psAPIUnlockPin"-->
          <function name="&quot;psAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="SUCCESS" >f_nReturnCode == s_sSUCCESS
OR f_nReturnCode == -1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSRTakeCallerOffHold" start="1" event="OnCSRTakeCallerOffHold" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=32 y=45 ?>
          <!--proc CSRPutCallerOffHold-->
          <function name="&quot;CSRCallerOffHold&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oMOH</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
            <parameter >g_oTimerMOH</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
js_disable_event();

	Server.logInfo("g_oMOH.strConferenceId: " + Session.g_oMOH.strConferenceId);
	Server.logInfo("g_oMOH.strEndPoint: " + Session.g_oMOH.strEndPoint);
	Server.logInfo("g_oMOH.strContent: " + Session.g_oMOH.strContent);
	Server.logInfo("g_oMOH.strConnectionId: " + Session.g_oMOH.strConnectionId);
	Server.logInfo("g_oMOH.strCallId: " + Session.g_oMOH.strCallId);
	Server.logInfo("g_oMOH.strType: " + Session.g_oMOH.strType);
	Server.logInfo("g_oMOH.bCurrentlyInConf: " + Session.g_oMOH.bCurrentlyInConf);
	Server.logInfo("g_oMOH.bCurrentlyConnected: " + Session.g_oMOH.bCurrentlyConnected);
	Server.logInfo("g_oMOH.strSessionId: " + Session.g_oMOH.strSessionId);
	Server.logInfo("g_oMOH.nConfIndex: " + Session.g_oMOH.nConfIndex);]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=228 y=152 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO PUT CALLER OFF HOLD");
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSRPutCallerOnHold" start="1" event="OnCSRPutCallerOnHold" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=20 y=23 ?>
          <!--proc CSRPutCallerOnHold-->
          <function name="&quot;CSRCallerOnHold&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oMOH</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oTimerMOH</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oTimerPleaseHold</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=274 y=20 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.f_nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO PUT CALLER ON HOLD");
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSROutdialBLeg" start="1" event="OnCSROutdialBLeg" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="strPhoneNumber" type="string" pass="byref"/>
        <parameter name="strPrepaidPin" type="string" pass="byref"/>
        <parameter name="strPostpaidPin" type="string" pass="byref"/>
        <parameter name="strPostpaidAccountNum" type="string" pass="byref"/>
        <parameter name="strBillableFlag" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-99</var>
        <var name="f_nFAILURE" type="i4" >-1</var>
        <var name="f_bNoPin" type="boolean" >1</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=15 y=21 ?>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="!f_bNoPin, state = get pin" link="13" stubbed="0" >f_bNoPin == false
AND g_oAPI.nStatePriorToCSR == s_nSTATE_GET_PIN_PRPD_OR_POPD</result>
            <result name="!f_bNoPin" link="8" stubbed="0" >f_bNoPin == false</result>
            <result name="lPinId == 0" link="3" stubbed="1" >g_oSUB.lPinId == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.strPrepaidPin.length > 0) {
	Session.f_bNoPin = false;
} else {
	Session.f_bNoPin = true;
}


Session.g_bGotCSRCancelOutdial = false;
Session.g_bGotCSRHangupOutdial = false;

Session.g_oSUB.strUserPin = Session.strPrepaidPin;

Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;

Session.g_oAPI.strDestinationNumber = Session.strPhoneNumber;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oACD.strReturnMsg = "Failure to outdial B Leg, because there is no pin";
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=499 y=173 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function name="&quot;PrepaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="(0 or 2) or billFlag = F" link="12" stubbed="0" >(f_nReturnCode == 0
OR f_nReturnCode == 2)
OR strBillableFlag match "F"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Session.g_oSUB.strUserPin = Session.strPrepaidPin;

Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);


js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}

if (1 == Result.id)
{
 switch (Session.f_nReturnCode)
 {
  case 1:
   Session.g_oACD.strReturnMsg = "Call Failed -- insufficient balance";
   break;
  case 3:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber is deactivated";
   break;
  case 4:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber is expired";
   break;
  case 5:
   Session.g_oACD.strReturnMsg = "Call Failed -- pin already in use";
   break;
  case 10:
   Session.g_oACD.strReturnMsg = "Call Failed -- lot cancelled or suspended";
   break;
  case 11:
   Session.g_oACD.strReturnMsg = "Call Failed -- lot not activated";
   break;
  case 12:
   Session.g_oACD.strReturnMsg = "Call Failed -- access number not linked to product offering";
   break;
  default:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber validation failed with reason " + Session.f_nReturnCode;;
   break;
 }
} else {
	Session.g_oAPI.nStatePriorToCSR = Session.s_nGET_DESTINATION;
}

js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=13 y=379 ?>
          <!--"MsgCSROutdialBLegResponse"-->
          <function name="&quot;MsgCSROutdialBLegResponse&quot;" return="" external-function="1" library="" >
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.nReturnReasonCode = -1;]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=722 y=240 ?>
          <!--"psAPIAuthorizeDestination"-->
          <function name="&quot;psAPIAuthorizeDestination&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="0-Valid, 1-No Limit, billFlag = F" link="9" stubbed="1" >f_nReturnCode == 0
OR strBillableFlag match "F"
OR f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session Id : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Calling Card Service Id : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber Id : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan Id : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Country Id : " + Session.g_oAPI.nOrigCountryId);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.f_nReturnCode);
if (1 == Result.id)
{
	switch (Session.f_nReturnCode)
	{
		case -3:
			Session.g_oACD.strReturnMsg = "Call Failed -- restricted destination";
			break;
		case -4:
			Session.g_oACD.strReturnMsg = "Call Failed -- insufficient digits";
			break;
		case -6:
			Session.g_oACD.strReturnMsg = "Call Failed -- insufficient funds";
			break;
		case -7:
			Session.g_oACD.strReturnMsg = "Call Failed -- no rate";
			break;
		case -8: 
			Session.g_oACD.strReturnMsg = "Call Failed -- destination not in 'phone me' list";
			break;		
		case -9: 
			Session.g_oACD.strReturnMsg = "Call Failed -- no applicable rates found for this call";
			break;								
		default:
			Session.g_oACD.strReturnMsg = "Call Failed";
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=23 y=548 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oACD.strCSRDidOutdial = "T";
Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;
Session.g_oACD.bCSRWithAB = true;]]></script>
          </scripts>
        </action>
        <action id="7" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=20 y=491 ?>
          <return value=""/>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=216 y=151 ?>
          <!--psAPIUnlockPin-->
          <function name="&quot;psAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="f_nReturnCode = 0" >f_nReturnCode == 0</result>
          </results>
        </action>
        <action id="9" plug-in="Pactolus.Branch.1" ><?xtml-editor x=13 y=252 ?>
          <!--cancel outdial?-->
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="cancel outdial" link="3" stubbed="1" >g_bGotCSRCancelOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strDestinationNumber = Session.g_oCallLegB.strOutdialDestNbr;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oACD.strReturnMsg = "CSR outdial B leg canceled";
}]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=302 y=384 ?>
          <!--proc CSROutdial-->
          <function name="&quot;ProcOnCSROutdialParty&quot;" return="f_nReturnCode" external-function="1" library="lib_acd.xml" >
            <parameter >g_oConfMS</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_strContact</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="1"/>
            <result name="SUCCESS" link="6" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//js_disable_event();
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
//Session.g_oAPI.strDestinationNumber = Session.strPhoneNumber;



// Phone B object
Session.g_oCallLegB.bReverseFromTo = false;
Session.g_oCallLegB.bCurrentlyDialing = false;
Session.g_oCallLegB.bAttemptedToOutdial = false;
Session.g_oCallLegB.bConnected = false;
Session.g_oCallLegB.strSessionTimerFlag = Session.s_strSessionTimerFlag;
Session.g_oCallLegB.nSessionTimer = Session.s_nSessionTimerInterval;
Session.g_oCallLegB.nRingNoAnswerTime = Session.s_nRING_NO_ANSWER_TIME;

if(Session.g_oAPI.strPrimarySoftswitchIP.length > 0) {
	Session.g_oCallLegB.strRequestUri = Session.g_oAPI.strPrimarySoftswitchIP;
} else {
	Session.g_oCallLegB.strRequestUri = Session.s_strPrimaryPSX;
}

if(Session.g_oAPI.strBackupSoftswitchIP.length > 0) {
	Session.g_oCallLegB.strBackupRequestUri = Session.g_oAPI.strBackupSoftswitchIP;
} else {
	Session.g_oCallLegB.strBackupRequestUri = Session.s_strBackupPSX;
}

Session.g_oCallLegB.strCallId = "";
Session.g_oCallLegB.strContent = "";
Session.g_oCallLegB.strCSeq = "";
Session.g_oCallLegB.strFrom = "";
Session.g_oCallLegB.strTo = "";
Session.g_oCallLegB.strRoute = "";
Session.g_oCallLegB.strRecordRoute = "";
Session.g_oCallLegB.strContact = "";
Session.g_oCallLegB.nSetUpTime = 0;
Session.g_oCallLegB.nTearDownTime = 0;
Session.g_oCallLegB.strCodec = Session.s_strCodec;

if (Session.s_strTestModeFlag == "T")
{
	Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;
}
Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);
Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");

Session.g_oCallLegB.strBillableFlag = Session.strBillableFlag;


Session.g_oCallLegB.strCalledNumber = Session.g_oAPI.strDestinationNumber;
Session.g_oCallLegA.strContent = Session.g_oCallLegA.strOriginalContent;
Session.g_oAPI.nRTPClockRate = 8000;
Session.g_oAPI.nRTPEncoding = 0;
Session.f_lStartTime = Server.getUTCTime();

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
            <script language="javascript" timing="last" ><![CDATA[//js_enable_event();

Session.g_oACD.bCSRWithAB = true;]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=829 y=430 ?>
          <!--psAPIUnlockPin-->
          <function name="&quot;psAPIUnlockPin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oSUB</parameter>
            <parameter >g_oAPI</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="f_nReturnCode = 0" >f_nReturnCode == 0</result>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=726 y=134 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
        </action>
        <action id="13" plug-in="Pactolus.Branch.1" ><?xtml-editor x=294 y=26 ?>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Postpaid" link="14" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=503 y=39 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="12" stubbed="0"/>
            <result name="(0 or 2) or billFlag = F" link="3" stubbed="1" >(f_nReturnCode == 0
OR f_nReturnCode == 2)
OR strBillableFlag match "F"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
if (1 == Result.id)
{
 switch (Session.f_nReturnCode)
 {
  case -4:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber is deactivated";
   break;
  case -5:
   Session.g_oACD.strReturnMsg = "Call Failed -- account already in use";
   break;
  case -9:
   Session.g_oACD.strReturnMsg = "Call Failed -- corporate account deactivated";
   break;
  case -10:
   Session.g_oACD.strReturnMsg = "Call Failed -- account requires ANI authentication";
   break;
  case -11:
   Session.g_oACD.strReturnMsg = "Call Failed -- insufficient credit to place call";
   break;
  case -12:
   Session.g_oACD.strReturnMsg = "Call Failed -- access number not linked to product offering";
   break;
  default:
   Session.g_oACD.strReturnMsg = "Call Failed -- subscriber validation failed with reason " + Session.f_nReturnCode;;
   break;
 }
} else {

	if(Session.g_oAPI.nStatePriorToCSR == Session.s_nSTATE_GET_PIN_PRPD_OR_POPD) {
		Session.g_oAPI.nStatePriorToCSR = Session.s_nGET_DESTINATION;
	}	
}


js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Standard.EndSession.1" ><?xtml-editor x=34 y=692 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining prepaid or postpaid.");]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnPing" start="2" event="OnPing" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="strHostIP" type="string" pass="byref"/>
        <parameter name="nHostPort" type="i4" pass="byref"/>
      </parameters>
      <actions >
        <action id="2" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=161 y=107 ?>
          <!--RESPONSE SUCCESS-->
          <SOAP destination-ip="strACDControllerIP" transaction="strTransactionId" message-name="&quot;PingResponse&quot;" destination-port="nACDControllerPort" destination-type="4" destination-session="" waiting-session-selected=""/>
          <results >
            <result name="Default" link="1" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="1" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=418 y=108 ?>
          <return value=""/>
        </action>
      </actions>
    </function>
    <function name="OnCSRCancelOutdialToBLeg" start="1" event="OnCSRCancelOutdialToBLeg" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=58 ?>
          <!--got cancel-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="bGotCSRCancel" link="3" stubbed="0" >g_bGotCSRCancelOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=251 y=19 ?>
          <!--"ProcOnCSRCancelOutdial"-->
          <function name="&quot;ProcOnCSRCancelOutdial&quot;" return="" external-function="1" library="lib_acd.xml" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("RECEIVE CSR CANCEL OUTDIAL TO B LEG FROM: ");
Server.logInfo("ACD CONTROLLER IP: " + Session.strACDControllerIP);
Server.logInfo("ACD CONTROLLER PORT: " + Session.nACDControllerPort);
Server.logInfo("ACD TRANSACTION ID: " + Session.strTransactionId);
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_bGotCSRCancelOutdial = true;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (true == Session.g_oACD.bCSRWithAB)
{
	Session.g_oACD.bCSRWithAB = false;
}]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=605 y=158 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=507 y=17 ?>
          <!--"psAPIProcCallCompletion"-->
          <function name="&quot;psAPIProcCallCompletion&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.lTimeAnswered = 0;
Session.g_oAPI.nTerminationReason = 10; //other

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCSRHangupBLeg" start="2" event="OnCSRHangupBLeg" returns="void" >
      <parameters >
        <parameter name="strACDControllerIP" type="string" pass="byref"/>
        <parameter name="nACDControllerPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=74 ?>
          <!--got hangup-->
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="bGotCSRHangup" link="1" stubbed="0" >g_bGotCSRHangupOutdial == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=686 y=196 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=302 y=20 ?>
          <!--"ProcOnCSRHangupBLeg"-->
          <function name="&quot;ProcOnCSRHangupBLeg&quot;" return="" external-function="1" library="lib_acd.xml" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oConfMS</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("RECEIVE CSR HANGUP B LEG FROM: ");
Server.logInfo("ACD CONTROLLER IP: " + Session.strACDControllerIP);
Server.logInfo("ACD CONTROLLER PORT: " + Session.nACDControllerPort);
Server.logInfo("ACD TRANSACTION ID: " + Session.strTransactionId);
Session.g_oACD.strACDControllerIP = Session.strACDControllerIP;
Session.g_oACD.nACDControllerPort = Session.nACDControllerPort;
Session.g_oACD.strTransactionId = Session.strTransactionId;
Session.g_bGotCSRHangupOutdial = true;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (true == Session.g_oACD.bCSRWithAB)
{
	Session.g_oACD.bCSRWithAB = false;
}]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=545 y=46 ?>
          <!--"psAPIProcCallCompletion"-->
          <function name="&quot;psAPIProcCallCompletion&quot;" return="" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_oArrayCallLegs</parameter>
          </function>
          <results >
            <result name="Default" link="1" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.lTimeAnswered = 0;
Session.g_oAPI.nCallTerminationReason = 11; 

Session.g_oArrayCallLegs.length = 0;
Session.g_oArrayCallLegs[0] = Session.g_oCallLegB;
Session.g_oArrayCallLegs[0].oTimer = Session.g_oTimerPhoneB;
Session.g_oArrayCallLegs[0].oTimerGSX = Session.g_oTimerGSXB;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnRefer" start="1" event="Refer" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string" pass="byref"/>
        <parameter name="strAcceptEncoding" type="string" pass="byref"/>
        <parameter name="strAcceptLanguage" type="string" pass="byref"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string" pass="byref"/>
        <parameter name="strCallId" type="string" pass="byref"/>
        <parameter name="strContact" type="string" pass="byref"/>
        <parameter name="strContent" type="string" pass="byref"/>
        <parameter name="strContentDisposition" type="string" pass="byref"/>
        <parameter name="strContentType" type="string" pass="byref"/>
        <parameter name="strCSeq" type="string" pass="byref"/>
        <parameter name="strDate" type="string" pass="byref"/>
        <parameter name="strEncryption" type="string" pass="byref"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string" pass="byref"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string" pass="byref"/>
        <parameter name="strProxyRequire" type="string" pass="byref"/>
        <parameter name="strRecordRoute" type="string" pass="byref"/>
        <parameter name="strRequestUri" type="string" pass="byref"/>
        <parameter name="strReferTo" type="string" pass="byref"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=208 y=146 ?>
          <!--"SIP/2.0 501 Not Implemented"-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="1" >
            <call-id >strCallId</call-id>
            <contact >g_strContact</contact>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 501 Not Implemented"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=492 y=145 ?>
          <return value=""/>
        </action>
      </actions>
    </function>
    <function name="ProcLowBalance" start="13" event="ReOriginate" returns="void" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_oOptions" type="object" ></var>
        <var name="f_bBalXfer" type="boolean" >0</var>
        <var name="f_bCustService" type="boolean" >0</var>
        <var name="f_bRecharge" type="boolean" >0</var>
        <var name="f_nNumRetries" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=125 y=87 ?>
          <!--put A on hold-->
          <function name="&quot;PutPartyOnHold&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="12" stubbed="0"/>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=590 y=73 ?>
          <!--"HangUpParty"-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="14" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nCallTerminationReason = 6;
Session.g_oAPI.nSessionTerminationReason = 5;]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=392 y=302 ?>
          <!--got recharge settings?-->
          <results >
            <result name="Default" link="24" stubbed="1"/>
            <result name="NEED TO GET SETTINGS" link="18" stubbed="0" >g_bGotRechargeSettings == false</result>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1109 y=823 ?>
          <return value=""/>
        </action>
        <action id="10" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=607 y=164 ?>
          <!--outdial from MS-->
          <function name="&quot;MSOutdialParty&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strType = Session.s_strMSType;]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Pactolus.Branch.1" ><?xtml-editor x=114 y=293 ?>
          <!--SUCCESS?-->
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="SUCCESS?" link="3" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
            <result name="Caller hung up" link="14" stubbed="1" >f_nReturnCode == s_sCALLERHUNGUP</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (1 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 12;
}
else if (3 == Result.id)
{
	Session.g_oAPI.nCallTerminationReason = 2;
	Session.g_oAPI.nSessionTerminationReason = 7;
}]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.Branch.1" ><?xtml-editor x=352 y=82 ?>
          <!--success?-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="success" link="10" stubbed="0" >f_nReturnCode == s_sSUCCESS</result>
          </results>
        </action>
        <action id="14" plug-in="Standard.EndSession.1" ><?xtml-editor x=821 y=70 ?></action>
        <action id="15" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=870 y=303 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="0"/>
          </results>
        </action>
        <action id="16" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1117 y=298 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="17" stubbed="0"/>
          </results>
        </action>
        <action id="17" plug-in="Standard.EndSession.1" ><?xtml-editor x=1360 y=296 ?></action>
        <action id="18" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=646 y=307 ?>
          <!--JAVA: PrepaidAPIGetRechargeSettings-->
          <function name="&quot;PrepaidAPIGetRechargeSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCC</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oBALXFER</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="Success" link="24" stubbed="1" >f_nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nReturnCode = -50;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN *********");
Server.logInfo("getRechargeSettings returned " + Session.f_nReturnCode);
if(0 == Session.f_nReturnCode)
{
	Session.g_bGotRechargeSettings = true;
}
else
{
	Session.g_bGotRechargeSettings = false;
	Session.g_oAPI.nSessionTerminationReason = 5;
}]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=676 y=678 ?>
          <!--call balanceTransfer()-->
          <function name="&quot;BalanceTransfer&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="31" stubbed="0"/>
          </results>
        </action>
        <action id="20" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=661 y=452 ?>
          <!--invalid choice-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="24" stubbed="1"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error" ><?xtml-editor visible=no?></result>
            <result name="Timeout" ><?xtml-editor visible=no?></result>
            <result name="too many tries" link="2" stubbed="1" >f_nNumRetries &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumRetries++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (5 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuMaxInvalids;	
}]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=915 y=559 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nWAIT_FOR_MESSAGE;]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Pactolus.Branch.1" ><?xtml-editor x=370 y=522 ?>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="Recharge" link="26" stubbed="0" >f_bRecharge == true</result>
            <result name="Bal Xfer" link="19" stubbed="0" >f_bBalXfer == true</result>
            <result name="Cust Service" link="27" stubbed="0" >f_bCustService == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_bBalXfer = false;
Session.f_bCustService = false;
Session.f_bRecharge = false;

if(Session.g_strDigit == "1") {

	switch (Session.f_oOptions[1].nOption) {
		case 519:
			Session.f_bRecharge = true;
			break;
		case 520:
			Session.f_bBalXfer = true;
			break;
	}

} else if(Session.g_strDigit == "2") {

	switch (Session.f_oOptions[2].nOption) {
		case 520:
			Session.f_bBalXfer = true;
			break;
		case 521:
			Session.f_bPlayBalance = true;
			break;
	}

} else if(Session.g_strDigit == "0") {

	//if("T" == Session.g_oACD.strEnableFlag || Session.g_oAPI.strCustomerServicePhone != "") {
		Session.f_bCustService = true;
		Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;
		Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuZeroOut;		
	//}	
}






















]]></script>
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 1 && Result.id != 8) {
	Session.g_nNumRetry = 0;
}]]></script>
          </scripts>
        </action>
        <action id="23" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=404 y=856 ?>
          <!--552-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >552</audio>
          </play>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="24" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=122 y=632 ?>
          <!--Main menu-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigit" retry-count="g_oAPI.nMaxLoginAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >f_oOptions[1].nPress</audio>
            <audio type="index" >f_oOptions[1].nOption</audio>
            <audio type="index" >f_oOptions[1].nHalfTenth</audio>
            <audio type="index" >f_oOptions[2].nPress</audio>
            <audio type="index" >f_oOptions[2].nOption</audio>
            <audio type="index" >f_oOptions[2].nHalfTenth</audio>
            <audio type="index" >f_oOptions[0].nPressCS1</audio>
            <audio type="index" >f_oOptions[0].nPressCS2</audio>
            <audio type="index" >f_oOptions[0].nOptionCS</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Success" link="22" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="23" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigit = "";

Server.logInfo("g_oCC.strBalanceTransferFlag: " + Session.g_oBALXFER.strBalanceTransferFlag);
Server.logInfo("g_oCC.strRechargableFlag: " + Session.g_oCC.strRechargableFlag);
Server.logInfo("g_oACD.strEnableFlag: " + Session.g_oACD.strEnableFlag);
Server.logInfo("g_oAPI.strCustomerServicePhone: " + Session.g_oAPI.strCustomerServicePhone);

// Assume everything is on
Session.f_oOptions[1].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[1].nPress = 311; // Press 1
Session.f_oOptions[1].nOption = 519; // CC Recharge

Session.f_oOptions[2].nHalfTenth = 220; // Play half second since assumming all options are on.
Session.f_oOptions[2].nPress = 312; // Press 2
Session.f_oOptions[2].nOption = 520; // Bal Xfer

Session.f_oOptions[0].nOptionCS = 931;// Customer Service
Session.f_oOptions[0].nPressCS1 = 310; // Press
Session.f_oOptions[0].nPressCS2 = 1; // 0

Server.logInfo("f_oOptions.length: " + Session.f_oOptions.length);

var maxPossibleOptions = Session.f_oOptions.length;
var minPossibleOption = 5;
var counter = 2;

if("T" != Session.g_oCC.strRechargableFlag) {
	// Pull each option up
	for (var i = 1; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i+1].nOption;
	}
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
	counter--;
}

if("T" != Session.g_oBALXFER.strBalanceTransferFlag) {
	// Pull each option up	
	for (var i = counter; i < Session.f_oOptions.length - 1; i++) {
		Session.f_oOptions[i].nOption = Session.f_oOptions[i + 1].nOption;
	}	
	// Truncate array
	Session.f_oOptions.length = Session.f_oOptions.length - 1;
}

if("T" != Session.g_oACD.strMainMenuZeroOut && Session.g_oAPI.strCustomerServicePhone == "" ) {
	Session.f_oOptions[0].nOptionCS = 99;// Customer Service
	Session.f_oOptions[0].nPressCS1 = 99; // Press
	Session.f_oOptions[0].nPressCS2 = 99; // 0
	// Do not play half second of silence after last option
	Session.f_oOptions[Session.f_oOptions.length - 1].nHalfTenth = 99; 
}

// set options not used to 99 (1/10 silence)
for (var i = Session.f_oOptions.length; i < maxPossibleOptions; i++) {
		Session.f_oOptions[i].nOption = 99;
		Session.f_oOptions[i].nPress = 99;	
		Session.f_oOptions[i].nHalfTenth = 99; 
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=675 y=561 ?>
          <!--call creditCardRecharge()-->
          <function name="&quot;CreditCardRecharge&quot;" return="f_nReturnCode" external-function="0" library=""/>
          <results >
            <result name="Default" link="31" stubbed="1"/>
            <result name="Wait For Message" link="21" stubbed="0" >f_nReturnCode == s_nWAIT_FOR_MESSAGE</result>
          </results>
        </action>
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=646 y=824 ?>
          <!--ProcessCSRAttempt-->
          <function name="&quot;ProcessCSRAttempt&quot;" return="g_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oACD</parameter>
            <parameter >g_nPromptHoldForCSR</parameter>
            <parameter >g_nPromptNotAllowed</parameter>
            <parameter >g_oMS</parameter>
            <parameter >s_oCSR_REASONS</parameter>
            <parameter >s_nTIMEOUT</parameter>
          </function>
          <results >
            <result name="Default" link="28" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("g_oAPI.nStatePriorToCSR: " + Session.g_oAPI.nStatePriorToCSR);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oACD.nCSRRouteReasonCode = Session.g_oACD.nCSRRouteReasonCodeTemp;

if(Session.g_nReturnCode == 1) {
	Session.g_nCurrentState = Session.s_nMAKE_CONNECTION;
} else if(Session.g_nReturnCode == 2) {
	Session.g_nCurrentState = Session.s_nROUTE_TO_CSR;	
} else if(Session.g_nReturnCode == 3) {
	Session.g_nCurrentState = Session.s_nEND_CALL;	
} else if(Session.g_nReturnCode == 0) {
	Session.g_nCurrentState = Session.g_oAPI.nStatePriorToCSR;
}
]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=882 y=823 ?>
          <!--call Main: route csr-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="5" stubbed="0"/>
          </results>
        </action>
        <action id="30" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1156 y=674 ?>
          <!--call is MAIN MENU-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="5" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nMAIN_MENU;]]></script>
          </scripts>
        </action>
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=898 y=675 ?>
          <!--g_oSUB.fPrepaidBalance >=  g_oCC.fMinPrepaidBalance-->
          <results >
            <result name="Default" link="24" stubbed="1"/>
            <result name="g_oSUB.fPrepaidBalance &gt;= g_oCC.fMinPrepaidBalance" link="30" stubbed="0" >g_oSUB.fPrepaidBalance &gt;= g_oCC.fMinPrepaidBalance</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="OnClickToDial" start="1" event="ClickToDial" returns="void" >
      <parameters >
        <parameter name="strSrcIpAddress" type="string" pass="byref"/>
        <parameter name="nPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
        <parameter name="strCallingNumber" type="string" pass="byref"/>
        <parameter name="strCalledNumber" type="string" pass="byref"/>
        <parameter name="nTreatmentCode" type="i4" pass="byref"/>
        <parameter name="strServiceProviderCode" type="string" pass="byref"/>
        <parameter name="lServiceProviderId" type="i8" pass="byref"/>
        <parameter name="strPrepaidPinNbr" type="string" pass="byref"/>
        <parameter name="strPostpaidAcctNbr" type="string" pass="byref"/>
        <parameter name="strPostpaidPinNbr" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="nReturnCode" type="i4" >-1</var>
        <var name="nClickToDialCode" type="i4" >0</var>
        <var name="strClickToDialStatus" type="string" ></var>
        <var name="strResponse" type="string" ></var>
        <var name="strCode" type="string" ></var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=23 y=54 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Click2Dial" link="12" stubbed="0" >nTreatmentCode == 0
OR nTreatmentCode == 1
OR nTreatmentCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bNewCall = false;

Server.logInfo("Start OnClickToDial: Recieved Message!");
Server.logInfo("Session.strCallingNumber is: " + Session.strCallingNumber);
Server.logInfo("Session.strCalledNumber is: " + Session.strCalledNumber);
Server.logInfo("Session.nTreatmentCode is: " + Session.nTreatmentCode);
Server.logInfo("Session.strServiceProviderCode is: " + Session.strServiceProviderCode);
Server.logInfo("Session.lServiceProviderId is: " + Session.lServiceProviderId);
Server.logInfo("Session.strPrepaidPinNbr is: " + Session.strPrepaidPinNbr);
Server.logInfo("Session.strPostpaidAcctNbr is: " + Session.strPostpaidAcctNbr);
Server.logInfo("Session.strPostpaidPinNbr is: " + Session.strPostpaidPinNbr);

if(Session.strCallingNumber.length <= 0 || Session.strCallingNumber == " ") {
	Server.logError("No Callback Number recieved with this message.");
}



Session.g_strC2DCalledNumber = Session.strCalledNumber;
Session.g_strOutdialANumber = Session.strCallingNumber;
Session.g_strC2DSoapIp = Session.strSrcIpAddress;
Session.g_nC2DSoapPort = Session.nPort;
Session.g_strC2DTransactionId = Session.strTransactionId;


js_initAPI(Session.g_oAPI);
js_initACD(Session.g_oACD);
js_initBALXFER(Session.g_oBALXFER);
js_initCallLeg(Session.g_oCallLegA);
js_initCallLeg(Session.g_oCallLegB);
js_initCC(Session.g_oCC);
js_initMS(Session.g_oMS, Session.s_strMSType);
js_initRATE(Session.g_oCallLegA.oRATE);
js_initSUB(Session.g_oSUB);
js_initMS(Session.g_oMOH, Session.s_strMSType);
js_initMS(Session.g_oConfMS, Session.s_strMSType);
js_initORIG_TYPES(Session.s_oORIG_TYPES);
js_initINITIATION_TYPES(Session.s_oINITIATION_TYPES);

Session.g_oMS.strACDType = Session.s_strACDMediaServerType;
Session.g_oMS.strMOHType = Session.s_strMOHMediaServerType;
Session.g_oConfMS.strACDType = Session.s_strACDMediaServerType;
Session.g_oConfMS.strMOHType = Session.s_strMOHMediaServerType;

Session.g_oAPI.lPlatformSessionStartTime = Server.getUTCTime();
Session.g_oAPI.strServiceProviderCode = Session.strServiceProviderCode;
Session.g_oAPI.lServiceProviderId = Session.lServiceProviderId;


if(Session.strPostpaidAcctNbr.length > 0 && Session.strPostpaidAcctNbr != " ") {
	//This is a postpaid subscriber
	Session.g_oSUB.strAccountNumber = Session.strPostpaidAcctNbr;
	Session.g_oSUB.strUserPin = Session.strPostpaidAcctNbr + Session.strPostpaidPinNbr;
	Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID_POPD;
	Session.g_oAPI.strPostPaidFlag = "T";
	Session.g_oACD.lCSRRequestSkillId = 3;	
} else if(Session.strPrepaidPinNbr.length > 0 && Session.strPrepaidPinNbr != " ") {
	//This is a prepaid subscriber
	Session.g_oSUB.strUserPin = Session.strPrepaidPinNbr;
	Session.g_oAPI.nServiceElementId = Session.s_nSERVICE_ELEMENT_ID_PRPD;	
} else {
	Server.logError("Prepaid pin and postpaid account number are null.");
}

var myString = new String (Session.strCallingNumber);
var myArray = myString.split("x");
Session.g_oAPI.strDestinationNumber = myArray[0];

// set server contact
if( Server.sipPort != 5060 )
{
 Session.g_strContact = "sip:" + Session.s_strLocalHost + ":" + Server.sipPort + ">";
}
else
{
	Session.g_strContact = "<sip:" + Session.s_strLocalHost + ">";
}
// added for Sachin

if(0 == Session.nTreatmentCode) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegClickToDialOut;
	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strClickToDial;
} else if(1 == Session.nTreatmentCode) {	
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegMsgInitiatedCallback;
	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strMessageCallback;
} else if(2 == Session.nTreatmentCode) {
	Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegIvrInitiatedCallback;
	Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strIvrCallback;
} else {
	Server.logError("Uknown Treatment Code: " + Session.nTreatmentCode);
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=586 y=738 ?>
          <!--0-->
          <return value="0"/>
        </action>
        <action id="5" plug-in="Standard.EndSession.1" ><?xtml-editor x=1332 y=130 ?></action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=318 y=715 ?>
          <!--send to Main function-->
          <function name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nDIAL_OUT_A_ONLY;

Session.g_oAPI.bALegRatingOn = true;

Server.logInfo("g_oAPI.strCreditLimitFlag: " + Session.g_oAPI.strCreditLimitFlag);
Server.logInfo("g_oAPI.bALegRatingOn: " + Session.g_oAPI.bALegRatingOn);
Server.logInfo("g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);


if(2 == Session.nTreatmentCode) {
	Session.g_oAPI.bALegRatingOn = false;
} else if(Session.g_oAPI.nServiceElementId == Session.s_nSERVICE_ELEMENT_ID_POPD && Session.g_oAPI.strCreditLimitFlag != "T") {
	Session.g_oAPI.bALegRatingOn = false;
}	
	
Server.logInfo("g_oAPI.bALegRatingOn: " + Session.g_oAPI.bALegRatingOn);]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=1060 y=206 ?>
          <!--send JAVA ALARM-->
          <SOAP destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "JAVA: initialize session";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=815 y=154 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="9" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="11" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=568 y=161 ?>
          <!--send alert db error-->
          <user-function process="&quot;PACTOLUS_ps_snmp_event&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"dbase-error"</parameter>
          </user-function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=39 y=182 ?>
          <!--psAPIInitializeSession-->
          <function name="&quot;psAPIInitializeSession&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="Success" link="23" stubbed="0" >nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("InitializeSession returned " + Session.nReturnCode);
Session.g_sMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;
if (Session.nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA INITIALIZE SESSION, EXIT ON: " + Result.name);
	Session.strCode = "480";
	Session.strResponse = "A system error has occurred";	
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1002; //bad ani
			Session.g_oAPI.nSessionTerminationReason = 9;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 2;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1004; //service disable
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
	
		Session.g_oACD.strPinZeroOut = "T";
		Session.g_oACD.strLanguageMenuZeroOut = "T";
		Session.g_oACD.strMainMenuZeroOut = "T";					
	
		if(Session.g_oACD.strCSROnMaxLoginsEnabled == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
			Session.g_oACD.strPinMaxTimeouts = "T";		
			Session.g_oACD.strPinMaxInvalids = "T";
			Session.g_oACD.strMainMenuMaxInvalids = "T";
			Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
		} // end if 

		// Settings Based on Customer
		Session.g_oACD.strDestMaxInvalids = "F";
		Session.g_oACD.strDestMaxTimeouts = "F";
		Session.g_oACD.strDestZeroOut = "F";		
				
		Session.g_oACD.strMainMenuMaxTimeouts = "F";
		Session.g_oACD.strLanguageMenuMaxTimeouts = "F";				

		
	} // end strEnableFlag		

} // end return code


Server.logInfo("g_oACD.strPinZeroOut " + Session.g_oACD.strPinZeroOut);
Server.logInfo("g_oACD.strLanguageMenuZeroOut " + Session.g_oACD.strLanguageMenuZeroOut);
Server.logInfo("g_oACD.strMainMenuZeroOut " + Session.g_oACD.strMainMenuZeroOut);
Server.logInfo("g_oACD.strPinMaxTimeouts " + Session.g_oACD.strPinMaxTimeouts);
Server.logInfo("g_oACD.strPinMaxInvalids " + Session.g_oACD.strPinMaxInvalids);
Server.logInfo("g_oACD.strMainMenuMaxInvalids " + Session.g_oACD.strMainMenuMaxInvalids);
Server.logInfo("g_oACD.strLanguageMenuMaxInvalids " + Session.g_oACD.strLanguageMenuMaxInvalids);
Server.logInfo("g_oACD.strDestMaxInvalids " + Session.g_oACD.strDestMaxInvalids);
Server.logInfo("g_oACD.strDestMaxTimeouts " + Session.g_oACD.strDestMaxTimeouts);
Server.logInfo("g_oACD.strDestZeroOut " + Session.g_oACD.strDestZeroOut);
Server.logInfo("g_oACD.strMainMenuMaxTimeouts " + Session.g_oACD.strMainMenuMaxTimeouts);
Server.logInfo("g_oACD.strLanguageMenuMaxTimeouts " + Session.g_oACD.strLanguageMenuMaxTimeouts);

Session.g_oSUB.strPinLanguage = Session.g_oAPI.strLanguage;



if(Session.strPostpaidAcctNbr.length > 0 && Session.strPostpaidAcctNbr != " ") {
	//This is a postpaid subscriber
	Session.g_oSUB.strAccountNumber = Session.strPostpaidAcctNbr;
	Session.g_oSUB.strUserPin = Session.strPostpaidAcctNbr + Session.strPostpaidPinNbr;
	Session.g_oAPI.strPostPaidFlag = "T";
} else if(Session.strPrepaidPinNbr.length > 0 && Session.strPrepaidPinNbr != " ") {
	//This is a prepaid subscriber
	Session.g_oSUB.strUserPin = Session.strPrepaidPinNbr;
} else {
	Server.logError("Prepaid pin and postpaid account number are null.");
}












]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=242 y=396 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function name="&quot;PrepaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="19" stubbed="0"/>
            <result name="SUCCESS" link="22" stubbed="0" >nReturnCode == 0
OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);

js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();
Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{
	// Set default error message
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			Session.strResponse = "The account does not have sufficient funds to make this call.";
			Session.strCode = "414";
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "The account has expired."; 
			Session.strCode = "415"; 
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";			
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022; // restricted origination number
			Session.g_oAPI.nSessionTerminationReason = 18;
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";
			break;					
		case 14:
			Session.g_nErrorMsgNumber = 1022; // restricted session init type
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} 


Session.g_bALegRatingOn = true;

]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=648 y=502 ?>
          <!--psAPIAuthorizeDestination-->
          <function name="&quot;psAPIAuthorizeDestination&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="21" stubbed="0" >nReturnCode == 0
OR nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);

Session.g_oAPI.bALegCallback = true;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0)
{
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			Session.strResponse = "The account does not have sufficient funds to make this call.";
			Session.strCode = "414";
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}


Server.logInfo("g_oCallLegA.oRATE.fAlegMeteredRate" + Session.g_oCallLegA.oRATE.fAlegMeteredRate);

]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=325 y=133 ?>
          <!--failure response-->
          <SOAP destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;code&quot;" value="strCode"/>
            <parameter tag="&quot;text&quot;" value="strResponse"/>
          </SOAP>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Sending failure reason: " + Session.strResponse + "(" + Session.strCode + ") to click2dial request") ;]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=791 y=337 ?>
          <!--failure response-->
          <SOAP destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;code&quot;" value="strCode"/>
            <parameter tag="&quot;text&quot;" value="strResponse"/>
          </SOAP>
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Sending failure reason: " + Session.strResponse + "(" + Session.strCode + ") to click2dial request") ;]]></script>
          </scripts>
        </action>
        <action id="20" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=886 y=535 ?>
          <!--failure response-->
          <SOAP destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;code&quot;" value="strCode"/>
            <parameter tag="&quot;text&quot;" value="strResponse"/>
          </SOAP>
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Sending failure reason: " + Session.strResponse + "(" + Session.strCode + ") to click2dial request") ;]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=97 y=695 ?>
          <!--Outdial in progress-->
          <SOAP destination-ip="strSrcIpAddress" transaction="strTransactionId" message-name="&quot;ClickToDialResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;code&quot;" value="&quot;200&quot;"/>
            <parameter tag="&quot;text&quot;" value="&quot;Outdial in progress&quot;"/>
          </SOAP>
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strClick2DialStatus = "Ringing your phone" ;
Session.g_nClick2DialCode = 180 ;]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=431 y=508 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="15" stubbed="0"/>
          </results>
        </action>
        <action id="23" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=329 ?>
          <results >
            <result name="Default" link="19" stubbed="1"/>
            <result name="Postpaid" link="24" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="14" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {
	Server.logError("Error determing prepaid or postpaid call.");
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
}]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=267 y=282 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function name="&quot;PostpaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="19" stubbed="0"/>
            <result name="Success" link="22" stubbed="0" >nReturnCode == 0
OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{

	// Set default error message
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";

	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";			
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";			
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	if(Session.g_oAPI.strCreditLimitFlag == "T") {
		Session.g_oAPI.nMaxAllowedSeconds = Session.g_oSUB.nSecsRemaining;
	}




}

js_enable_event();]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnClickToDialQuery" start="3" event="ClickToDialQuery" returns="void" >
      <parameters >
        <parameter name="strSrcAddress" type="string" pass="byref"/>
        <parameter name="nPort" type="i4" pass="byref"/>
        <parameter name="strTransactionId" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=22 y=66 ?>
          <results >
            <result name="Default" link="6" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Start OnClickToDialQuery: Recieved Message!");]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=433 y=86 ?>
          <return value=""/>
        </action>
        <action id="6" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=215 y=247 ?>
          <SOAP destination-ip="strSrcAddress" transaction="strTransactionId" message-name="&quot;ClickToDialQueryResponse&quot;" destination-port="nPort" destination-type="4" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;code&quot;" value="g_nClick2DialCode"/>
            <parameter tag="&quot;text&quot;" value="g_strClick2DialStatus"/>
          </SOAP>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="SingleStageDialing" start="9" event="" returns="i4" >
      <local-vars >
        <var name="nReturnCode" type="i4" >-99</var>
        <var name="bRtpRelayRequested" type="boolean" >0</var>
        <var name="oRtpRelay" type="object" ></var>
        <var name="bProxyFinalNonSuccessResponse" type="boolean" >1</var>
        <var name="nFinalStatus" type="i4" >0</var>
        <var name="bAlegHungUp" type="boolean" >0</var>
        <var name="bConnected" type="boolean" >0</var>
        <var name="nLongNoAnswerTimeout" type="i4" >300</var>
        <var name="strMyDest" type="string" ></var>
      </local-vars>
      <actions >
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=47 y=209 ?>
          <!--psAPIInitializeSession-->
          <function name="&quot;psAPIInitializeSession&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oACD</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success" link="25" stubbed="0" >nReturnCode == s_sSUCCESS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strCallInitiationType = Session.s_oINITIATION_TYPES.strALegOneStageDialing;
Session.g_oAPI.strOriginationType = Session.s_oORIG_TYPES.strOneStageDialing;
Session.g_oAPI.strServiceProviderCode = Session.strServiceProviderCode;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("InitializeSession returned " + Session.nReturnCode);
Session.g_sMaxLoginAttempts = Session.g_oAPI.nMaxLoginAttempts;
if (Session.nReturnCode != 0)
{
	Server.logError("ERROR: FAIL TO CALL JAVA INITIALIZE SESSION, EXIT ON: " + Result.name);
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1002; //bad ani
			Session.g_oAPI.nSessionTerminationReason = 9;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 2;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1004; //service disable
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {

	if(Session.g_oACD.strEnableFlag == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
	
		Session.g_oACD.strPinZeroOut = "T";
		Session.g_oACD.strLanguageMenuZeroOut = "T";
		Session.g_oACD.strMainMenuZeroOut = "T";					
	
		if(Session.g_oACD.strCSROnMaxLoginsEnabled == "T" || Session.g_oAPI.strCustomerServicePhone != "") {
			Session.g_oACD.strPinMaxTimeouts = "T";		
			Session.g_oACD.strPinMaxInvalids = "T";
			Session.g_oACD.strMainMenuMaxInvalids = "T";
			Session.g_oACD.strLanguageMenuMaxInvalids = "T";	
		} // end if 

		// Settings Based on Customer
		Session.g_oACD.strDestMaxInvalids = "F";
		Session.g_oACD.strDestMaxTimeouts = "F";
		Session.g_oACD.strDestZeroOut = "F";		
				
		Session.g_oACD.strMainMenuMaxTimeouts = "F";
		Session.g_oACD.strLanguageMenuMaxTimeouts = "F";				

		
	} // end strEnableFlag		

} // end return code


Server.logInfo("g_oACD.strPinZeroOut " + Session.g_oACD.strPinZeroOut);
Server.logInfo("g_oACD.strLanguageMenuZeroOut " + Session.g_oACD.strLanguageMenuZeroOut);
Server.logInfo("g_oACD.strMainMenuZeroOut " + Session.g_oACD.strMainMenuZeroOut);
Server.logInfo("g_oACD.strPinMaxTimeouts " + Session.g_oACD.strPinMaxTimeouts);
Server.logInfo("g_oACD.strPinMaxInvalids " + Session.g_oACD.strPinMaxInvalids);
Server.logInfo("g_oACD.strMainMenuMaxInvalids " + Session.g_oACD.strMainMenuMaxInvalids);
Server.logInfo("g_oACD.strLanguageMenuMaxInvalids " + Session.g_oACD.strLanguageMenuMaxInvalids);
Server.logInfo("g_oACD.strDestMaxInvalids " + Session.g_oACD.strDestMaxInvalids);
Server.logInfo("g_oACD.strDestMaxTimeouts " + Session.g_oACD.strDestMaxTimeouts);
Server.logInfo("g_oACD.strDestZeroOut " + Session.g_oACD.strDestZeroOut);
Server.logInfo("g_oACD.strMainMenuMaxTimeouts " + Session.g_oACD.strMainMenuMaxTimeouts);
Server.logInfo("g_oACD.strLanguageMenuMaxTimeouts " + Session.g_oACD.strLanguageMenuMaxTimeouts);

Session.g_oSUB.strPinLanguage = Session.g_oAPI.strLanguage;
















]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=754 y=175 ?>
          <!--send JAVA ALARM-->
          <SOAP destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="16" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "JAVA: initialize session";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=516 y=180 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="1" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=292 y=183 ?>
          <!--send alert db error-->
          <user-function process="&quot;PACTOLUS_ps_snmp_event&quot;" function="&quot;increment_event_counter&quot;" timeout="s_nTIMEOUT" return="" async="1" >
            <parameter >"dbase-error"</parameter>
          </user-function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=539 y=415 ?>
          <!--psAPIAuthorizeDestination-->
          <function name="&quot;psAPIAuthorizeDestination&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oCallLegA.oRATE</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegA</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="0: Valid Dest, 1: No Time Limit" link="24" stubbed="0" >nReturnCode == 0
OR nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthorizeDestination *********");
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Prepaid Calling Card Service : " + Session.g_oSUB.nServiceId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Subscriber ID : " + Session.g_oSUB.lSubscriberId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Destination Number : " + Session.g_oAPI.strDestinationNumber);
Server.logInfo("Call Sequence : " + Session.g_oAPI.nCallSequence);
Server.logInfo("Info Digits : " + Session.g_oAPI.strInfoDigits);
Server.logInfo("Dialing Plan ID : " + Session.g_oAPI.nDialingPlanId);
Server.logInfo("Min Intl Digits : " + Session.g_nMinIntlDigits);
Server.logInfo("Domestic Intl Flag : " + Session.g_oAPI.strOrigDomIntFlag);
Server.logInfo("Origin Tac Region : " + Session.g_nOrigTacRegionId);
Server.logInfo("Origin Country ID : " + Session.g_oAPI.nOrigCountryId);]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthorizeDest returned " + Session.nReturnCode);
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0)
{
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.nReturnCode);
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1008; //insufficent digit
			Session.g_oAPI.nSessionTerminationReason = 4;
			Session.g_nPromptToPlay = 514;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 2002; //low balance
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 507;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		case -8: // Not in Phone Me List
			Session.g_nErrorMsgNumber = 1007; //restricted dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 513;
			break;	
		case -9:
			Session.g_nErrorMsgNumber = 2003; //no rate dest
			Session.g_oAPI.nSessionTerminationReason = 5;
			Session.g_nPromptToPlay = 514;
			break;
		
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHORIZE DESTINATION, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthorizeDest returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=299 y=578 ?>
          <!--PrepaidAPIAuthenticatePin-->
          <function name="&quot;PrepaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oCC</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="SUCCESS" link="4" stubbed="0" >nReturnCode == 0
OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Pin Password : " + Session.g_oSUB.strPinPassword);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number of login attemps: " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("strOriginationType : " + Session.g_oAPI.strOriginationType);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_enable_event();
Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
 Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{
	// Set default error message
	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case -1:
			Session.g_nErrorMsgNumber = 1016; //SQL error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1017; //logger error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1014; //general error
			Session.g_oAPI.nSessionTerminationReason = 5;
			break;
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.nReturnCode);
			break;
		case 1:
			Session.g_nErrorMsgNumber = 2000; //balance below minimum
			Session.g_nPromptToPlay = 507;
			Session.g_oAPI.nSessionTerminationReason = 8;
			break;
		case 3:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			if(2 == Session.g_oSUB.nDisabledReasonCode) {
				Session.g_nPromptToPlay = 506; // disabled due to bal xfer		
			} else {
				Session.g_nPromptToPlay = 506;
			}				
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 4:
			Session.g_nErrorMsgNumber = 1015; //expired account
			Session.g_nPromptToPlay = 505;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case 5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case 6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 7:
			Session.g_nErrorMsgNumber = 2001; //invalid password
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 8:
			Session.g_nErrorMsgNumber = 1012; //max retry
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 13;
			Session.g_oACD.nCSRRouteReasonCode = Session.s_nEXCEEDINVALID;
			break;
		case 9:
			Session.g_nErrorMsgNumber = 1013; //no primary offer
			Session.g_oAPI.nSessionTerminationReason = 10;
			break;
		case 10:
			Session.g_nErrorMsgNumber = 2020; //lot cancelled or suspended
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 11:
			Session.g_nErrorMsgNumber = 2021; //inactive pin
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case 12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_nPromptToPlay = 502;
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;		
		case 13:
			Session.g_nErrorMsgNumber = 1022; // restricted origination number
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;					
		case 14:
			Session.g_nErrorMsgNumber = 1022; // restricted session init type
			Session.g_oAPI.nSessionTerminationReason = 18;
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Standard.EndSession.1" ><?xtml-editor x=1240 y=145 ?></action>
        <action id="12" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=1249 y=272 ?>
          <!--183 session in progress-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <content >g_oMS.strContent</content>
            <content-type >"application/sdp"</content-type>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 183 Session Progress"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success" link="15" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO RESPONSE 183");]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.MGCPDelete.1" ><?xtml-editor x=1531 y=266 ?>
          <dlcx connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTIMEOUT" returns="" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </dlcx>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO DLCX MS CONNECTION");
else
{
	Server.logInfo("SUCCESS DLCX MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = false;
	Session.g_oMS.strCallId = "";
	Session.g_oMS.strConnectionId = "";
	Session.g_oMS.strEndPoint = "";
	Session.g_oMS.strContent = "";
}]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1762 y=392 ?>
          <!--g_nErrorMsgNumber-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >365</audio>
            <audio type="number" >g_nErrorMsgNumber</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO PLAY PROMPT INDEX: " + Session.nPromptIndex);]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=1547 y=393 ?>
          <!--2 secs-->
          <sleep duration="2"/>
          <results >
            <result name="Default" link="14" stubbed="0"/>
          </results>
        </action>
        <action id="16" plug-in="Pactolus.MGCPCreate.1" ><?xtml-editor x=988 y=173 ?>
          <!--create endpoint-->
          <crcx callid="g_oMS.strCallId" remote-sdp="g_oCallLegA.strContent" mode="send/receive" capability="1" returns="nReturnCode" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" local-sdp="g_oMS.strContent" packetization-period="g_oMS.nPacketizationPeriod" codec="g_oMS.strCodec" timeout="s_nTIMEOUT" local-connection-options="" second-endpoint-id="" telephone-events="1" ms-type="g_oMS.strType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </crcx>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success" link="12" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (Result.id != 2)
	Server.logError("FAIL TO CREATE MS CONNECTION");
else
{
	Server.logInfo("SUCCESS CREATE MS CONNECTION");
	Server.logInfo("Session.g_oMS.strCallId IS: " + Session.g_oMS.strCallId);
	Server.logInfo("Session.g_oMS.strConnectionId IS: " + Session.g_oMS.strConnectionId);
	Server.logInfo("Session.g_oMS.strEndPoint IS: " + Session.g_oMS.strEndPoint);
	Server.logInfo("Session.g_oMS.strContent IS: " + Session.g_oMS.strContent);
	Server.logInfo("Session.g_oMS.strType IS: " + Session.g_oMS.strType);
	Server.logInfo("Session.g_oMS.strCodec IS: " + Session.g_oMS.strCodec);
	Server.logInfo("Session.g_oMS.nPacketizationPeriod IS: " + Session.g_oMS.nPacketizationPeriod);
	Session.g_oMS.bCurrentlyConnected = true;
}]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=2002 y=386 ?>
          <!--500 ERROR-->
          <sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 500 Server Internal Error"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="13" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="19" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1485 y=539 ?>
          <return value=""/>
        </action>
        <action id="20" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1006 y=414 ?>
          <!--"ProxyCall_Internal"-->
          <function name="&quot;ProxyCall_Internal&quot;" return="bConnected" external-function="1" library="lib_voip.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >nLongNoAnswerTimeout</parameter>
            <parameter >bRtpRelayRequested</parameter>
            <parameter >oRtpRelay</parameter>
            <parameter >g_oCallLegA.nSessionTimer</parameter>
            <parameter >g_oCallLegA.bRefresher</parameter>
            <parameter >g_oCallLegB.nSessionTimer</parameter>
            <parameter >g_oCallLegB.bRefresher</parameter>
            <parameter >bProxyFinalNonSuccessResponse</parameter>
            <parameter >nFinalStatus</parameter>
            <parameter >bAlegHungUp</parameter>
          </function>
          <results >
            <result name="Default" link="23" stubbed="0"/>
            <result name="bConnected" link="22" stubbed="0" >bConnected == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_disable_event();
js_logInfoCallLeg(Session.g_oCallLegA);
js_logInfoCallLeg(Session.g_oCallLegB);]]></script>
            <script language="javascript" timing="last" ><![CDATA[js_logInfoCallLeg(Session.g_oCallLegA);
js_logInfoCallLeg(Session.g_oCallLegB);
js_enable_event();
Session.g_oCallLegB.bCurrentlyDialing = false ;

if (Session.bConnected)
{
	Session.g_oCallLegB.bConnected = true;
	Session.g_oCallLegB.lTimeAnswered = Server.getUTCTime() ;
	Session.g_oCallLegB.nSetUpTime = Session.g_oCallLegB.lTimeAnswered - Session.g_oCallLegB.lTimeStart;
	Session.g_oCallLegB.strRequestUri = Session.g_oCallLegB.strRemoteUri;
	Session.g_oCallLegB.strContent = Session.g_oCallLegB.strRemoteSdp;
	var myUri = new SipRequestUri(Session.g_oCallLegB.strRequestUri);
	Session.g_oAPI.strGWIPEgress = myUri.url.host;
	Session.g_oAPI.nGWPortEgress = myUri.url.port;
	if (myUri.url.dtg != undefined)
	Session.g_oCallLegB.strDestTrunkGroup = myUri.url.dtg;
	Server.logInfo("A AND B ARE CONNECTED.  CALL LEG B INFO: ");
	js_logInfoCallLeg(Session.g_oCallLegB);
}]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1246 y=540 ?>
          <!--SetTimers-->
          <function name="&quot;SetTimers&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerThreshold1</parameter>
            <parameter >g_oTimerThreshold2</parameter>
            <parameter >g_oTimerThreshold3</parameter>
            <parameter >g_oTimerPhoneA</parameter>
            <parameter >g_oTimerPhoneB</parameter>
            <parameter >g_oTimerGSXA</parameter>
            <parameter >g_oTimerGSXB</parameter>
            <parameter >g_oTimerMaxTime</parameter>
            <parameter >s_strSessionTimerFlag</parameter>
            <parameter >g_oAPI.strOutdialOperatorFlag</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oCallLegB</parameter>
            <parameter >g_oCallLegB.nSetUpTime</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oRATE</parameter>
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="19" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// init. timers


js_initTimer(Session.g_oTimerThreshold1);
js_initTimer(Session.g_oTimerThreshold2);
js_initTimer(Session.g_oTimerThreshold3);
js_initTimer(Session.g_oTimerPhoneA);
js_initTimer(Session.g_oTimerPhoneB);
js_initTimer(Session.g_oTimerMaxTime);


Session.g_oTimerThreshold1.nThresholdTime = Session.g_oAPI.nWarningThreshold1;
Session.g_oTimerThreshold2.nThresholdTime = Session.g_oAPI.nWarningThreshold2;
Session.g_oTimerThreshold3.nThresholdTime = Session.g_oAPI.nWarningThreshold3;

Session.g_oTimerPhoneA.lSleepTime = Session.g_oCallLegA.initSessionTimer;
Session.g_oTimerPhoneB.lSleepTime = Session.g_oCallLegB.initSessionTimer;

Session.g_oTimerMaxTime.lSleepTime =  Session.g_oSUB.nSecondsAvailable;
]]></script>
          </scripts>
        </action>
        <action id="23" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1230 y=402 ?>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="TryAgain" link="20" stubbed="1" >g_bTryAgain == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo(" Session.g_bTryAgain IS: " + Session.g_bTryAgain);
Server.logInfo(" Session.bAlegHungUp IS: " + Session.bAlegHungUp);
Server.logInfo(" Session.nFinalStatus IS: " + Session.nFinalStatus);
if (Session.g_bTryAgain && !Session.bAlegHungUp && 0 == Session.nFinalStatus)
{
	Session.g_oCallLegB.strRemoteUri = Session.strMyDest + "@" + Session.g_oCallLegB.strBackupRequestUri;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bTryAgain = false;]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Pactolus.Branch.1" ><?xtml-editor x=774 y=414 ?>
          <!--set call leg info-->
          <results >
            <result name="Default" link="20" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strDestinationNumber = Session.g_oCallLegB.strOutdialDestNbr;

if (Session.s_strTestModeFlag == "T")
{
	if(Session.g_oTEST.strTestDestinationNumber.length > 0) {
		Session.g_oAPI.strDestinationNumber = Session.g_oTEST.strTestDestinationNumber;
	} else {
		Server.logError("Application is in test mode but no test number exists. Using: " + Session.g_oAPI.strDestinationNumber);
	}			
}										
Server.logInfo("BEFORE g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");
Session.g_oAPI.strDestinationNumber = js_prepend_digits(Session.g_oAPI.strDestinationNumber, Session.s_strDigitPrependToOutDial);
Server.logInfo("AFTER g_oAPI.strDestinationNumber prepend : <" + Session.g_oAPI.strDestinationNumber + " >");

Session.g_oCallLegB.strCalledNumber = Session.g_oAPI.strDestinationNumber;
Session.g_oAPI.nRTPClockRate = 8000;
Session.g_oAPI.nRTPEncoding = 0;

var myTo = new String();

if ("T" == Session.s_strPrependSVC)
{
	Session.strMyDest = Session.g_oAPI.strServiceProviderCode + Session.g_oAPI.strDestinationNumber;
	myTo = "<sip:" + Session.strMyDest + "@" + Session.g_oCallLegB.strRequestUri + ";user=phone>";
	Session.g_oCallLegB.strRemoteUri = Session.strMyDest + "@" + Session.g_oCallLegB.strRequestUri;
}
else
{
	Session.strMyDest = Session.g_oAPI.strDestinationNumber;	
	myTo = "<sip:" + Session.strMyDest + "@" + Session.g_oCallLegB.strRequestUri + ";user=phone>";
	Session.g_oCallLegB.strRemoteUri = Session.strMyDest + "@" + Session.g_oCallLegB.strRequestUri;
}

Session.g_oCallLegB.strTo = myTo;
Session.g_oCallLegB.strOriginalTo = myTo;
Session.g_oCallLegB.strFrom = Session.g_oCallLegA.strFrom;
Session.g_oCallLegB.strContact = Session.g_strContact;
Session.g_oCallLegB.strCallId = js_CreateUniqueCallId() ;
Session.g_oCallLegB.strCSeq = "1 INVITE" ;
Session.g_oCallLegB.bAttemptedToOutdial = true; 
Session.g_oCallLegB.bCurrentlyDialing = true ;
Session.g_oCallLegB.lTimeStart = Server.getUTCTime() ;
Session.g_oCallLegB.bUac = true;]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Pactolus.Branch.1" ><?xtml-editor x=42 y=405 ?>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="Postpaid" link="26" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="8" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(1 == Result.id) {
	Server.logError("Error determing prepaid or postpaid call.");
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";
}]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=288 y=386 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function name="&quot;PostpaidAPIAuthenticatePin&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="16" stubbed="1"/>
            <result name="Success" link="4" stubbed="0" >nReturnCode == 0
OR nReturnCode == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.nReturnCode != 0 && Session.nReturnCode != 2)
{

	// Set default error message
	Session.strResponse = "A system error occurred." ;
	Session.strCode = "480";

	switch (Session.nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			Session.g_oAPI.nSessionTerminationReason = 3;
			Session.strResponse = "Account is disabled."; 
			Session.strCode = "405";			
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			Session.strResponse = "Calls are not allowed to the requested number."; 
			Session.strCode = "408";			
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
js_enable_event();]]></script>
          </scripts>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="60" y-coord="27" width="369" height="51" text="OnInvite determine if single stage dialing.  Provide global var for Service Code, ANI, Destination" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="StartALegTimer" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=18 y=168 ?>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="nSecondsAvailable &gt; 0" link="2" stubbed="0" >g_oSUB.nSecondsAvailable &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oSUB.nSecondsAvailable <= 0) {
	Server.logInfo("ERROR: g_oSUB.nSecondsAvailable <= 0. No starting timer for A leg.");
} else {

	// Set A leg timer
	js_initTimer(Session.g_oTimerMaxTimeALeg);
	Session.g_oTimerMaxTimeALeg.lSleepTime =  Session.g_oSUB.nSecondsAvailable;

}



]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=215 y=332 ?>
          <!--StartTimer-->
          <function name="&quot;StartTimer&quot;" return="" external-function="1" library="lib_utils.xml" >
            <parameter >g_oTimerMaxTimeALeg</parameter>
          </function>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=362 y=159 ?>
          <return value=""/>
        </action>
      </actions>
    </function>
    <function name="AuthenticatePinPrpdOrPopd" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=33 y=138 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="3" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=317 y=344 ?>
          <!--s_nAUTHENTICATE_PIN-->
          <return value="s_nAUTHENTICATE_PIN"/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=375 y=166 ?>
          <!--s_nSTATE_AUTH_PIN_POPD-->
          <return value="s_nSTATE_AUTH_PIN_POPD"/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=282 y=75 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="AuthenticatePinPopd" start="95" event="AuthenticatePin" returns="i4" >
      <local-vars >
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_fAmountLeft" type="float" >0</var>
      </local-vars>
      <actions >
        <action id="95" plug-in="Pactolus.Branch.1" ><?xtml-editor x=6 y=73 ?>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="bANCallbackFlag" link="96" stubbed="1" >g_oAPI.bANCallbackFlag == true</result>
          </results>
        </action>
        <action id="15" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1127 y=341 ?>
          <!--return s_nGET_DESTINATION-->
          <return value="s_nGET_DESTINATION"/>
        </action>
        <action id="29" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=942 y=821 ?>
          <!--get pin-->
          <return value="s_nSTATE_GET_PIN_PRPD_OR_POPD"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nTempInt = 0;
Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
        <action id="46" plug-in="Pactolus.Branch.1" ><?xtml-editor x=619 y=139 ?>
          <!--post prompt type?-->
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="g_oAPI.strPostPinPromptType==U" link="47" stubbed="0" >g_oAPI.strPostPinPromptType match "U"</result>
            <result name="PromptType = I &amp;&amp; index &gt; 0" link="71" stubbed="0" >g_oAPI.strPostPinPromptType match "I"
AND g_oAPI.nPostPinPromptIndex &gt; 0</result>
          </results>
        </action>
        <action id="47" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=876 y=114 ?>
          <!--Post Pin Prompt URL-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strPostPinPromptUrl</audio>
          </play>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="71" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=894 y=338 ?>
          <!--Post Pin Prompt index-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nPostPinPromptIndex</audio>
          </play>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="72" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=653 y=924 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="73" stubbed="0"/>
          </results>
        </action>
        <action id="73" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=880 y=920 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="74" stubbed="0"/>
          </results>
        </action>
        <action id="74" plug-in="Standard.EndSession.1" ><?xtml-editor x=1100 y=918 ?></action>
        <action id="75" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=411 y=343 ?>
          <!--play reason prompt-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="73" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="76" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=426 y=686 ?>
          <!--invalid pin-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="78" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="78" plug-in="Pactolus.Branch.1" ><?xtml-editor x=681 y=687 ?>
          <!--max retry-->
          <results >
            <result name="Default" link="94" stubbed="0"/>
            <result name="g_nMaxRetry &lt; g_oAPI.nMaxLoginAttempts" link="29" stubbed="0" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
	Session.g_oAPI.nCallTerminationReason = 2;
}]]></script>
          </scripts>
        </action>
        <action id="79" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=410 y=927 ?>
          <!--pin in used or no more mintute-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="72" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="80" plug-in="Pactolus.Branch.1" ><?xtml-editor x=392 y=257 ?>
          <results >
            <result name="Default" link="46" stubbed="0"/>
            <result name="creditLimitFlag = T" link="81" stubbed="0" >g_oAPI.strCreditLimitFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry = 0;]]></script>
          </scripts>
        </action>
        <action id="81" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=620 y=307 ?>
          <!--You have used... ..minutes this month.-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >515</audio>
            <audio type="currency" >f_fAmountLeft</audio>
            <audio type="index" >1297</audio>
          </play>
          <results >
            <result name="Default" link="46" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_oAPI.strCreditLimitFlag == "T") {
	Session.g_oAPI.nMaxAllowedSeconds = Session.g_oSUB.nSecsRemaining;
}


Session.f_fAmountLeft = Session.g_oAPI.fCreditLimit - Session.g_oAPI.fCreditUsed;]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=64 y=266 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="72" stubbed="1"/>
            <result name="Success or First Use" link="80" stubbed="0" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Hangup" link="75" stubbed="0" >f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -10</result>
            <result name="Get pin again" link="76" stubbed="0" >f_nReturnCode == -3
OR f_nReturnCode == -6
OR f_nReturnCode == -7</result>
            <result name="Pin locked" link="79" stubbed="0" >f_nReturnCode == -5
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			Session.g_nPromptToPlay = 1253;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			Session.g_nPromptToPlay = 506;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			Session.g_nPromptToPlay = 338;			
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			Session.g_nPromptToPlay = 1253;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			Session.g_nPromptToPlay = 1253;
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			Session.g_nPromptToPlay = 1253;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			Session.g_nPromptToPlay = 1296;
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
}
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="94" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=939 y=592 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[

if(Session.g_bGetPinOnly) {
	Session.g_oSUB.strUserPin = "";	
	Session.g_oSUB.strAccountNumber = Session.g_strAuthenticationNbr;
} else {
	Session.g_oSUB.strUserPin = "";
	Session.g_oSUB.strAccountNumber = "";
}	


Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinInvalids;
Session.g_oAPI.nStatePriorToCSR  = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;	]]></script>
          </scripts>
        </action>
        <action id="96" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=158 y=1196 ?>
          <!--"PostpaidAPIAuthenticatePin"-->
          <function name="&quot;PostpaidAPIAuthenticatePin&quot;" return="f_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
          </function>
          <results >
            <result name="Default" link="97" stubbed="0"/>
            <result name="Success or First Use" >f_nReturnCode == 0
OR f_nReturnCode == 2</result>
            <result name="Hangup" >f_nReturnCode == -4
OR f_nReturnCode == -7
OR f_nReturnCode == -10</result>
            <result name="Get pin again" >f_nReturnCode == -3
OR f_nReturnCode == -6
OR f_nReturnCode == -7</result>
            <result name="Pin locked" >f_nReturnCode == -5
OR f_nReturnCode == -11</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("*********JAVA START AuthenticateSub *********");
Server.logInfo("DB Name : " + Session.g_oAPI.strProcDBName);
Server.logInfo("Platform Session ID : " + Session.g_oAPI.strPlatformSessionId);
Server.logInfo("Service Provider : " + Session.g_oAPI.lServiceProviderId);
Server.logInfo("Origination Number : " + Session.g_oAPI.strOriginationNumber);
Server.logInfo("Stripped Origination Number : " + Session.g_oAPI.strStrippedOrigNumber);
Server.logInfo("Pin number : " + Session.g_oSUB.strUserPin);
Server.logInfo("Max login attemps : " + Session.g_oAPI.nMaxLoginAttempts);
Server.logInfo("Number login attemps : " + Session.g_oAPI.nNumberLoginAttempts);
Server.logInfo("Origination Country : " + Session.g_oAPI.nOrigCountryId);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);
js_disable_event();]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("*********JAVA RETURN*********");
Server.logInfo("AuthenticateSub returned " + Session.f_nReturnCode);
Server.logInfo("Pin level language " + Session.g_oSUB.strPinLanguage);
Server.logInfo("BEFORE: g_oAPI.fCreditLimit: " + Session.g_oAPI.fCreditLimit);
Server.logInfo("BEFORE: g_oAPI.fCreditUsed: " + Session.g_oAPI.fCreditUsed);


// Default to Auth Dest. If we fail here, we will set this to s_nSTATE_INIT_AN_CALLBACK.
Session.g_nCurrentState = Session.s_nAUTHORIZE_DESTINATION;

if (Session.s_strIgnorePinLanguage == "F" && Session.g_oSUB.strPinLanguage.length > 0){
	Session.g_oAPI.strLanguage = Session.g_oSUB.strPinLanguage;
}else{
    Server.logInfo("ignoring pin level language, continue with access number language");
}
Session.g_nPromptToPlay = 0;
if (Session.f_nReturnCode != 0 && Session.f_nReturnCode != 2)
{
	Session.g_nCurrentState = Session.s_nSTATE_INIT_AN_CALLBACK;
	Session.g_nPromptToPlay = Session.s_nPROMPT_CANT_CALLBACK; //The system cannot call you back at this number

	switch (Session.f_nReturnCode)
	{
		case -99:
			Session.g_nErrorMsgNumber = 1001; //db error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		case -2:
			Session.g_nErrorMsgNumber = 1003; //no service provider
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -3:
			Session.g_nErrorMsgNumber = 1008; //insufficient digits
			Session.g_nPromptToPlay = 1253;
			break;
		case -4:
			Session.g_nErrorMsgNumber = 1005; //subscriber disable
			//Session.g_nPromptToPlay = 506;
			Session.g_oAPI.nSessionTerminationReason = 3;
			break;
		case -5:
			Session.g_nErrorMsgNumber = 1011; //pin locked
			//Session.g_nPromptToPlay = 338;			
			Session.g_oAPI.nSessionTerminationReason = 14;
			break;
		case -6:
			Session.g_nErrorMsgNumber = 1010; //pin does not exist
			//Session.g_nPromptToPlay = 1253;
			break;
		case -7:
			Session.g_nErrorMsgNumber = 1012; //exceed max retry
			//Session.g_nPromptToPlay = 1253;
			Session.g_oAPI.nSessionTerminationReason = 13;
			break;
		case -8:
			Session.g_nErrorMsgNumber = 1013; //no primary offering
			Session.g_oAPI.nSessionTerminationReason = 4;
			break;
		case -10:
			Session.g_nErrorMsgNumber = 1019; //ani authentication require
			Session.g_oAPI.nSessionTerminationReason = 1;
			//Session.g_nPromptToPlay = 1253;
			break;
		case -11:
			Session.g_oAPI.nSessionTerminationReason = 16; // no more minutes
			//Session.g_nPromptToPlay = 1296;
			Session.g_nErrorMsgNumber = 0;
			break;			
		case -12:
			Session.g_nErrorMsgNumber = 1021; //invalid access number
			Session.g_oAPI.nSessionTerminationReason = 17;
			break;
		case -13:
			Session.g_nErrorMsgNumber = 1022;
			Session.g_oAPI.nSessionTerminationReason = 18; // orig restricted
			break;				
		case -50:
			Session.g_nErrorMsgNumber = 1000; //jvm server error
			Session.g_oAPI.nSessionTerminationReason = 5;
			Server.logError("ERROR: FAIL TO AUTHENTICATE PIN, EXIT ON: " + Result.name);
			Server.logError("ERROR: AuthenticateSub returned " + Session.f_nReturnCode);
			break;
		default:
			Session.g_nErrorMsgNumber = 0;
			break;
	}
} else {


	Session.g_nPromptToPlay = Session.s_nPROMPT_CALLBACK; // Please call back then.

}
js_enable_event();]]></script>
          </scripts>
        </action>
        <action id="97" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=387 y=1250 ?>
          <!--psAPIMapLanguageCurrencyToCode-->
          <function name="&quot;psAPIMapLanguageCurrencyToCode&quot;" return="g_nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="98" stubbed="0"/>
          </results>
        </action>
        <action id="98" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=643 y=1232 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
        </action>
      </actions>
    </function>
    <function name="GetPinNumberPopd" start="42" event="GetPinNumber" returns="i4" >
      <local-vars >
        <var name="f_strAcctNumber" type="string" ></var>
        <var name="f_strPinNumber" type="string" ></var>
        <var name="f_bNullString" type="boolean" >0</var>
        <var name="f_bCallCSR" type="boolean" >0</var>
        <var name="f_bIsValid" type="boolean" >0</var>
        <var name="f_bMissDial" type="boolean" >0</var>
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_nReturnCode" type="i4" >-1</var>
      </local-vars>
      <actions >
        <action id="42" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=42 ?>
          <!--g_oAPI.strWelcomePromptType = U or I-->
          <results >
            <result name="Default" link="87" stubbed="0"/>
            <result name="WelcomePromptType = U" link="43" stubbed="0" >g_oAPI.strWelcomePromptType match "U"
AND g_bFirstTry == true</result>
            <result name="WelcomePromptType = I, &gt; 0" link="40" stubbed="0" >g_oAPI.strWelcomePromptType match "I"
AND g_bFirstTry == true
AND g_oAPI.nWelcomePromptIndex &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_nErrorMsgNumber = 0;


if(Session.g_oACD.strPinZeroOut == "T") {
	Session.f_oCSRPrompts.nOR = 362;
	Session.f_oCSRPrompts.nPRESS = 310;
	Session.f_oCSRPrompts.nZERO = 1;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
} else {
	Session.f_oCSRPrompts.nOR = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_bFirstTry = false;
]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=477 y=23 ?>
          <!--506: Please enter your card number.-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strDigitMapAccountNbr" language="g_oAPI.strLanguage" digits="f_strAcctNumber" retry-count="" clear-digits="0" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >1290</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="68" stubbed="0"/>
            <result name="Success" link="38" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="38" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=2019 y=174 ?>
          <!--s_nSTATE_AUTH_PIN_POPD-->
          <return value="s_nSTATE_AUTH_PIN_POPD"/>
        </action>
        <action id="38" plug-in="Pactolus.Branch.1" ><?xtml-editor x=689 y=310 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="65" stubbed="0"/>
            <result name="misdial" link="18" stubbed="1" >f_bMissDial == true</result>
            <result name="zero to CSR" link="99" stubbed="1" >f_bCallCSR == true</result>
            <result name="invalid" link="82" stubbed="0" >f_bIsValid == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ("0" == Session.f_strAcctNumber) {
	
	Session.f_bCallCSR = true;
	Session.g_nNumRetry++;

} else if(Session.f_strAcctNumber.length <= 0) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 552; // I did not hear a response

} else if (Session.f_strAcctNumber.length <= 1 || "*" == Session.f_strAcctNumber) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
	
} else if ("*" == Session.g_strTerminationDigit) {

	Session.f_bMissDial = true;
	
} else if (Session.f_strAcctNumber.length < 10) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
	
} else {
	Session.f_bIsValid = true;
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_strTerminationDigit = "";]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=239 y=440 ?>
          <!--Welcome prompt Index-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nPROMPTLENGTH" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxx|x.T|x.#|x.*)&quot;" language="g_oAPI.strLanguage" digits="f_strAcctNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >g_oAPI.nWelcomePromptIndex</audio>
            <audio type="index" >1290</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="38" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;]]></script>
          </scripts>
        </action>
        <action id="43" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=241 y=281 ?>
          <!--Welcome prompt URL-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nPROMPTLENGTH" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(xxxxxxxxxx|x.T|x.#|x.*)&quot;" language="g_oAPI.strLanguage" digits="f_strAcctNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="url" >g_oAPI.strWelcomePromptUrl</audio>
            <audio type="index" >1290</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="38" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strAcctNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1197 y=211 ?>
          <!--579: Please enter your pin-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="20" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="g_oSUB.strPinDigitMap" language="g_oAPI.strLanguage" digits="f_strPinNumber" retry-count="" clear-digits="1" terminating-digit="g_strTerminationDigit" quick-collect="0" digit-timer="" >
            <audio type="index" >579</audio>
            <audio type="index" >f_oCSRPrompts.nOR</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
          </play>
          <results >
            <result name="Default" link="68" stubbed="0"/>
            <result name="Success" link="60" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout" link="60" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strPinNumber = "";
Session.g_strTerminationDigit = "";
Session.f_bCallCSR = false;
Session.f_bIsValid = false;
Session.f_bMissDial = false;]]></script>
          </scripts>
        </action>
        <action id="60" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1423 y=260 ?>
          <!--null OR misdial-->
          <results >
            <result name="Default" link="66" stubbed="0"/>
            <result name="misdial" link="58" stubbed="1" >f_bMissDial == true</result>
            <result name="zero to CSR" link="99" stubbed="1" >f_bCallCSR == true</result>
            <result name="invalid" link="102" stubbed="0" >f_bIsValid == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ("0" == Session.f_strPinNumber) {
	
	Session.f_bCallCSR = true;
	Session.g_nNumRetry++;	

} else if(Session.f_strPinNumber.length <= 0) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 552; // I did not hear a response

} else if (Session.f_strPinNumber.length <= 1 || "*" == Session.f_strPinNumber) {

	Session.f_bIsValid = false;
	Session.g_nPromptToPlay = 1253;
	
} else if ("*" == Session.g_strTerminationDigit) {

	Session.f_bMissDial = true;

} else {
	Session.f_bIsValid = true;
}]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1813 y=159 ?>
          <!--concatenate account+pin-->
          <results >
            <result name="Default" link="21" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.g_bGetPinOnly) {
	Session.g_oSUB.strUserPin = Session.g_strAuthenticationNbr + Session.f_strPinNumber;	
} else {
	Session.g_oSUB.strUserPin = Session.f_strAcctNumber + Session.f_strPinNumber;
}	

	]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=1057 y=41 ?>
          <!--send ALARM-->
          <SOAP destination-ip="" transaction="" message-name="s_strSEND_ALARM_REQUEST" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="&quot;calling_number&quot;" value="g_strAlarmType"/>
            <parameter tag="&quot;called_number&quot;" value="g_strAlarmPriority"/>
          </SOAP>
          <results >
            <result name="Default" link="75" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strAlarmType = "MEDIASERVER: play get account number";
Session.g_strAlarmPriority = "MAJOR";]]></script>
          </scripts>
        </action>
        <action id="65" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=945 y=288 ?>
          <!--0.5 sec-->
          <sleep duration="0.5"/>
          <results >
            <result name="Default" link="58" stubbed="0"/>
          </results>
        </action>
        <action id="66" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=1579 y=144 ?>
          <!--0.5 sec-->
          <sleep duration="0.5"/>
          <results >
            <result name="Default" link="61" stubbed="0"/>
          </results>
        </action>
        <action id="68" plug-in="Pactolus.Branch.1" ><?xtml-editor x=815 y=57 ?>
          <!--send alarm?-->
          <results >
            <result name="Default" link="75" stubbed="1"/>
            <result name="s_strSendAlarmFlag==T" link="63" stubbed="0" >s_strSendAlarmFlag match "T"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.nSessionTerminationReason = 12;]]></script>
          </scripts>
        </action>
        <action id="75" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=1282 y=40 ?>
          <!--Hang Up Phone A-->
          <function name="&quot;HangUpParty&quot;" return="" external-function="1" library="" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="76" stubbed="0"/>
          </results>
        </action>
        <action id="76" plug-in="Standard.EndSession.1" ><?xtml-editor x=1511 y=53 ?></action>
        <action id="82" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=940 y=452 ?>
          <!--invalid pin-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="99" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="try again" link="18" stubbed="1" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;
]]></script>
          </scripts>
        </action>
        <action id="87" plug-in="Pactolus.Branch.1" ><?xtml-editor x=274 y=126 ?>
          <!--get pin only?-->
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="g_bGetPinOnly == true" link="58" stubbed="0" >g_bGetPinOnly == true</result>
          </results>
        </action>
        <action id="99" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=42 y=639 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if(Session.f_bCallCSR) {
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinZeroOut;
} else {
	Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_INVALID;	
	Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nPinInvalids;	
}

Session.g_oAPI.nStatePriorToCSR  = Session.s_nSTATE_GET_PIN_PRPD_OR_POPD;	

Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;



if(Session.g_bGetPinOnly) {
	Session.g_oSUB.strUserPin = "";	
	Session.g_oSUB.strAccountNumber = Session.g_strAuthenticationNbr;
} else {
	Session.g_oSUB.strUserPin = "";
	Session.g_oSUB.strAccountNumber = "";
}	]]></script>
          </scripts>
        </action>
        <action id="102" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1703 y=364 ?>
          <!--invalid pin-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >g_nPromptToPlay</audio>
          </play>
          <results >
            <result name="Default" link="99" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="try again" link="58" stubbed="1" >g_nNumRetry &lt; g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nNumRetry++;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetPinNumberPrpdOrPopd" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=83 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="3" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=304 y=289 ?>
          <!--s_nGET_PIN-->
          <return value="s_nGET_PIN"/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=362 y=111 ?>
          <!--s_nSTATE_GET_PIN_POPD-->
          <return value="s_nSTATE_GET_PIN_POPD"/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=269 y=20 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="MainMenuPopd" start="22" event="MainMenu" returns="i4" >
      <local-vars >
        <var name="f_nNumTries" type="i4" >0</var>
        <var name="f_nReturnCode" type="i4" >-50</var>
        <var name="f_nCounter" type="i4" >0</var>
        <var name="f_nPACMaxAttempts" type="i4" >2</var>
        <var name="f_oCSRPrompts" type="object" ></var>
        <var name="f_strCallbackNumber" type="string" ></var>
        <var name="f_strSoapIp" type="string" ></var>
        <var name="f_strTransactionId" type="string" ></var>
        <var name="f_bValidCallbackNbr" type="boolean" >0</var>
        <var name="f_nSoapPort" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="22" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=9 y=73 ?>
          <!--Main menu-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="35" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="&quot;(x)&quot;" language="g_oAPI.strLanguage" digits="g_strDigitCollected" retry-count="f_nPACMaxAttempts" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >311</audio>
            <audio type="index" >1263</audio>
            <audio type="index" >s_nHalfSecSilence</audio>
            <audio type="index" >312</audio>
            <audio type="index" >1254</audio>
            <audio type="index" >s_nHalfSecSilence</audio>
            <audio type="index" >313</audio>
            <audio type="index" >523</audio>
            <audio type="index" >s_nHalfSecSilence</audio>
            <audio type="index" >314</audio>
            <audio type="index" >281</audio>
            <audio type="index" >f_oCSRPrompts.nSILENCE</audio>
            <audio type="index" >f_oCSRPrompts.nPRESS</audio>
            <audio type="index" >f_oCSRPrompts.nZERO</audio>
            <audio type="index" >f_oCSRPrompts.nFOR_OPERATOR</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="83" stubbed="0"/>
            <result name="Success" ><?xtml-editor visible=no?></result>
            <result name="Error"/>
            <result name="Timeout" link="100" stubbed="0"/>
            <result name="press 1" link="68" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "1"</result>
            <result name="press 2" link="23" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "2"</result>
            <result name="press 3" link="11" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "3"</result>
            <result name="press 0" link="97" stubbed="0" >'Result'  == 'Success'
AND g_strDigitCollected match "0"</result>
            <result name="press 4" link="101" stubbed="0" >g_strDigitCollected match "4"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strDigitCollected = "";

if(Session.g_oACD.strMainMenuZeroOut == "T") {
	Session.f_oCSRPrompts.nSILENCE = Session.s_nHalfSecSilence;	
	Session.f_oCSRPrompts.nPRESS = 310;
	Session.f_oCSRPrompts.nZERO = 1;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 931;
} else {
	Session.f_oCSRPrompts.nSILENCE = 99;
	Session.f_oCSRPrompts.nPRESS = 99;
	Session.f_oCSRPrompts.nZERO = 99;
	Session.f_oCSRPrompts.nFOR_OPERATOR = 99;
}]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (4 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 6;
}]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=271 y=507 ?>
          <!--return GET_DESTINATION-->
          <return value="s_nGET_DESTINATION"/>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=269 y=391 ?>
          <!--call AddSpeedDial()-->
          <function name="&quot;AddSpeedDial&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSPEED_DIAL_SE_ID</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
          </function>
          <results >
            <result name="Default" link="61" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="47" plug-in="Pactolus.Branch.1" ><?xtml-editor x=508 y=21 ?>
          <!--invalid choice-->
          <results >
            <result name="Default" link="22" stubbed="1"/>
            <result name="Too many tries" link="89" stubbed="0" >f_nNumTries &gt;= g_oAPI.nMaxLoginAttempts</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries++;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if (2 == Result.id)
{
	Session.g_oAPI.nSessionTerminationReason = 13;
}]]></script>
          </scripts>
        </action>
        <action id="61" plug-in="Pactolus.Branch.1" ><?xtml-editor x=500 y=329 ?>
          <!--end call? failure?-->
          <results >
            <result name="Default" link="22" stubbed="1"/>
            <result name="Failure" link="63" stubbed="0" >f_nReturnCode == s_sFAILURE</result>
            <result name="AuthorizeDest" link="66" stubbed="0" >f_nReturnCode == s_nAUTHORIZE_DESTINATION</result>
            <result name="End Call" link="82" stubbed="0" >f_nReturnCode == s_nEND_CALL</result>
            <result name="Get Dest" link="11" stubbed="1" >f_nReturnCode == s_nGET_DESTINATION</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries = 0;]]></script>
          </scripts>
        </action>
        <action id="63" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=759 y=230 ?>
          <!--sorry, transaction can't be completed-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >301</audio>
            <audio type="index" >363</audio>
          </play>
          <results >
            <result name="Default" link="11" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="66" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=773 y=429 ?>
          <!--return s_nAUTHORIZE_DESTINATION-->
          <return value="s_nAUTHORIZE_DESTINATION"/>
        </action>
        <action id="68" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=264 y=285 ?>
          <!--ReviewSpeedDial-->
          <function name="&quot;ReviewSpeedDials&quot;" return="f_nReturnCode" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >s_nTIMEOUT</parameter>
            <parameter >s_nAUTHORIZE_DESTINATION</parameter>
            <parameter >s_sSUCCESS</parameter>
            <parameter >s_sFAILURE</parameter>
            <parameter >g_oAPI.nMaxLoginAttempts</parameter>
            <parameter >g_oAPI.strDestinationNumber</parameter>
            <parameter >g_oAPI.nSessionTerminationReason</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oSUB.lSubscriberId</parameter>
            <parameter >g_oSUB.lPinId</parameter>
            <parameter >s_nSPEED_DIAL_SE_ID</parameter>
          </function>
          <results >
            <result name="Default" link="61" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMS.strLanguage = Session.g_oAPI.strLanguage;]]></script>
          </scripts>
        </action>
        <action id="82" plug-in="Standard.EndSession.1" ><?xtml-editor x=763 y=571 ?></action>
        <action id="83" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=269 y=16 ?>
          <!--invalid choice-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >337</audio>
          </play>
          <results >
            <result name="Default" link="47" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="89" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=550 y=162 ?>
          <!--play Error, call CSR-->
          <function name="&quot;PlayCallCSR&quot;" return="" external-function="1" library="" >
            <parameter >g_oMS</parameter>
            <parameter >g_oAPI.strLanguage</parameter>
            <parameter >g_oAPI.strCustomerServicePhone</parameter>
          </function>
          <results >
            <result name="Default" link="90" stubbed="0"/>
          </results>
        </action>
        <action id="90" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=780 y=80 ?>
          <!--"PlayPromptAndHangup"-->
          <function name="&quot;PlayPromptAndHangup&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="97" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nEND_CALL;]]></script>
          </scripts>
        </action>
        <action id="97" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=275 y=617 ?>
          <!--g_nCurrentState-->
          <return value="g_nCurrentState"/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_nCurrentState = Session.s_nSTATE_PROC_CSR_ATTEMPT;
Session.g_oAPI.nStatePriorToCSR = Session.s_nSTATE_MAIN_MENU_POPD;
Session.g_oACD.nCSRRouteReasonCodeTemp = Session.s_nCSR_ROUTE_REASON_ZERO_OUT;	
Session.g_oACD.nCSRRouteReasonCode = Session.s_oCSR_REASONS.nMainMenuZeroOut;
]]></script>
          </scripts>
        </action>
        <action id="100" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=251 y=156 ?>
          <!--552-->
          <play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTIMEOUT" ms-type="g_oMS.strType" returns="" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_oAPI.strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >552</audio>
          </play>
          <results >
            <result name="Default" link="89" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="101" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=237 y=722 ?>
          <!--"IVRCallbackSettings"-->
          <function name="&quot;IVRCallbackSettings&quot;" return="f_nReturnCode" external-function="1" library="lib_utils.xml" >
            <parameter >g_oAPI</parameter>
            <parameter >g_oSUB</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strContact</parameter>
          </function>
          <results >
            <result name="Default" link="90" stubbed="1"/>
            <result name="0: Success" link="22" stubbed="1" >f_nReturnCode == 0</result>
            <result name="1: Init Callback" link="102" stubbed="0" >f_nReturnCode == 1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_nNumTries = 0;]]></script>
          </scripts>
        </action>
        <action id="102" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=504 y=749 ?>
          <!--s_nIVR_CALLBACK_DELAY-->
          <sleep duration="s_nIVR_CALLBACK_DELAY"/>
          <results >
            <result name="Default" link="104" stubbed="0"/>
          </results>
        </action>
        <action id="103" plug-in="Pactolus.SOAPMessage.1" ><?xtml-editor x=560 y=977 ?>
          <SOAP destination-ip="" transaction="" message-name="&quot;ClickToDial&quot;" destination-port="" destination-type="1" destination-session="" waiting-session-selected="" >
            <parameter tag="" value="f_strSoapIp"/>
            <parameter tag="" value="f_nSoapPort"/>
            <parameter tag="" value="f_strTransactionId"/>
            <parameter tag="" value="f_strCallbackNumber"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="s_nTREATMENT_CODE_IVR_INIT"/>
            <parameter tag="" value="g_oAPI.strServiceProviderCode"/>
            <parameter tag="" value="g_oAPI.lServiceProviderId"/>
            <parameter tag="" value="g_oSUB.strUserPin"/>
            <parameter tag="" value="s_strNULL"/>
            <parameter tag="" value="s_strNULL"/>
          </SOAP>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if(Result.id != 2) {
	Server.logError("Error sending soap message to initiate a callback from the Main Menu. Exit on: " + Result.name);
}]]></script>
          </scripts>
        </action>
        <action id="104" plug-in="Pactolus.Branch.1" ><?xtml-editor x=307 y=906 ?>
          <results >
            <result name="Default" link="82" stubbed="0"/>
            <result name="f_bValidCallbackNbr" link="103" stubbed="0" >f_bValidCallbackNbr == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.f_strSoapIp = Server.soapAddress;
Session.f_nSoapPort = Server.soapPort;
Session.f_strTransactionId = Server.getUTCTime();

Session.f_bValidCallbackNbr = false;

if(Session.g_oSUB.strCallbackNumber.length > 0 && Session.g_oSUB.bCallbackNumberEnable) {
	Session.f_strCallbackNumber = Session.g_oSUB.strCallbackNumber;
	Session.f_bValidCallbackNbr = true;
} else if(Session.g_oAPI.strOriginationNumber == Session.s_strDEFAULT_ANI) {	
	Server.logInfo("WARNING: Callback Number is empty or disabled. ANI equals default ANI. System will not call user back.");
} else if(Session.g_oAPI.strOriginationNumber.length > 0) {
	Session.f_strCallbackNumber = Session.g_oAPI.strOriginationNumber;
	Server.logInfo("Callback Number is empty or disabled. ANI will be used for callback.");	
	Session.f_bValidCallbackNbr = true;	
} else {
	Server.logInfo("WARNING: Callback Number is empty or disabled. ANI is empty. System will not call user back.");	
}
]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="MainMenuPrpdOrPopd" start="1" event="" returns="i4" >
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=20 y=83 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Postpaid" link="3" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_POPD</result>
            <result name="Prepaid" link="2" stubbed="0" >g_oAPI.nServiceElementId == s_nSERVICE_ELEMENT_ID_PRPD</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=304 y=289 ?>
          <!--s_nMAIN_MENU-->
          <return value="s_nMAIN_MENU"/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=362 y=111 ?>
          <!--s_nSTATE_MAIN_MENU_POPD-->
          <return value="s_nSTATE_MAIN_MENU_POPD"/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=269 y=20 ?>
          <return value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Error determining if prepaid or postpaid caller. g_oAPI.nServiceElementId: " + Session.g_oAPI.nServiceElementId);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
  </functions>
  <script language="javascript" ><![CDATA[#include <javascript_utils.jsh>
#include <dialing_plan_utils.jsh>]]></script>
  <properties >
    <property key="&quot;_english&quot;" value="G:/Software/downloads/prepaid_english.vox"/>
    <property key="&quot;en2&quot;" value="G:/Software/downloads/prepaid_english.vox"/>
    <property key="default" value="C:/pcs_english.vox"/>
    <property key="disable-logging" value="0"/>
    <property key="js-include-path" value="../Libs"/>
    <property key="library-modules" value="lib_callcontrol.xml; lib_mediaserver.xml;lib_acd.xml;lib_APISce.xml;lib_soap.xml;lib_moh.xml;lib_utils.xml;lib_speeddial.xml;lib_calltreatment.xml;lib_voip.xml"/>
    <property key="library-path" value="../Libs"/>
  </properties>
  <application-version >
    <revision >$Id: prepaid.xml,v 1.442 2005/06/27 16:39:00 sbhatt Exp $</revision>
    <label >$Name: PCS-A-4-1-1-1-4-c6 $</label>
  </application-version>
</xtml>