<?xml version="1.0"?>
<xtml version="1.0" xmlns="urn:www.pactolus.com:xtml" >
  <version sce-version="6015" prev-sce-version="6015" last-mod-time="Thursday, March 18, 2010 14:47:31"/>
  <events >
    <event name="RetrieveAcct" display="RetrieveAcct" >
      <parameter name="strSubAcct" type="string"/>
      <parameter name="strTo" type="string"/>
      <parameter name="strRealm" type="string"/>
      <parameter name="strMSEndPoint" type="string"/>
      <parameter name="strMSConnectionId" type="string"/>
      <parameter name="strMSCallId" type="string"/>
      <parameter name="strMSContent" type="string"/>
    </event>
  </events>
  <global-handlers >
    <handler event="Pactolus.EveSipInvite.1" function="OnInvite" public="1" always-on="0"/>
    <handler event="Pactolus.EveSipBye.1" function="OnBye" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipCancel.1" function="OnCancel" public="0" always-on="0"/>
    <handler event="Standard.OnServiceLoad.1" function="OnServiceLoad" public="0" always-on="0"/>
    <handler event="Standard.OnSessionEnd.1" function="OnSessionEnd" public="0" always-on="0"/>
    <handler event="Pactolus.EveSipAck.1" function="OnAck" public="0" always-on="0"/>
    <handler event="Pactolus.MGCPDtmf.2" function="OnDTMF" public="0" always-on="0"/>
  </global-handlers>
  <global-vars >
    <var name="g_nReturnValue" type="i4" >0</var>
    <var name="g_sSTATE" type="i2" >0</var>
    <var name="g_oCallLegA" type="object" ></var>
    <var name="g_oMS" type="object" ></var>
    <var name="g_strSubPhone" type="string" ></var>
    <var name="g_strSubPIN" type="string" ></var>
    <var name="g_strANI" type="string" ></var>
    <var name="g_strTermDigit" type="string" ></var>
    <var name="g_nUrgent_Count" type="i4" >0</var>
    <var name="g_nUnseen_Count" type="i4" >0</var>
    <var name="g_nSaved_Count" type="i4" >0</var>
    <var name="g_oUrgent" type="object" ></var>
    <var name="g_oUnseen" type="object" ></var>
    <var name="g_oSaved" type="object" ></var>
    <var name="g_strPINmap" type="string" >([0-9]xxx.#|xxx.T|xx.*)</var>
    <var name="g_bSystemError" type="boolean" >0</var>
    <var name="g_oMessage" type="object" ></var>
    <var name="g_nMsgSaveFor" type="i4" >0</var>
    <var name="g_nPINMin" type="i4" >0</var>
    <var name="g_strDigitMap_x" type="string" >(x)</var>
    <var name="g_strDigitMap_2" type="string" >([1-7]|9|*)</var>
    <var name="g_oAPI" type="object" ></var>
    <var name="g_nMaxMsgs" type="i4" >0</var>
    <var name="g_nMaxGreetingLength" type="i4" >0</var>
    <var name="g_nMaxGreeting_ms" type="i4" >0</var>
    <var name="g_bReadMsgs" type="boolean" >0</var>
    <var name="g_strFirstCall" type="string" ></var>
    <var name="g_strMailDomain" type="string" ></var>
    <var name="g_nInvalidChoicePrompt" type="i4" >99</var>
    <var name="g_strRecordURL" type="string" ></var>
    <var name="g_nReasonCode" type="i4" >0</var>
    <var name="g_nRecordLength" type="i4" >0</var>
    <var name="g_nErrorMsgId" type="i4" >0</var>
    <var name="g_nTimezoneOffset" type="i4" >0</var>
    <var name="g_nPinLength" type="i4" >0</var>
    <var name="g_strLocalContact" type="string" ></var>
    <var name="g_strEvent" type="string" ></var>
    <var name="g_strDigitMap_Return" type="string" >(**)</var>
    <var name="oCallLeg" type="object" ></var>
    <var name="g_oReturnCallAPI" type="object" ></var>
    <var name="g_oReturnCallAccessLine" type="object" ></var>
    <var name="g_oReturnCallVoipService" type="object" ></var>
    <var name="g_bDepositHandoff" type="boolean" >0</var>
    <var name="g_strPIN" type="string" ></var>
    <var name="g_strLanguage" type="string" >eng</var>
    <var name="g_oTimer" type="object" ></var>
    <var name="g_nTimerB" type="i4" >0</var>
    <var name="g_oRate" type="object" ></var>
    <var name="g_oSub" type="object" ></var>
    <var name="g_oCallLegB" type="object" ></var>
    <var name="g_bReturnFromRapidCall" type="boolean" >0</var>
    <var name="g_bCorpAcct" type="boolean" >0</var>
    <var name="g_strReturnNumber" type="string" ></var>
    <var name="g_strEndDigit" type="string" ></var>
  </global-vars>
  <shared-vars >
    <var name="s_strMSType" type="string" ></var>
    <var name="s_nTimeout" type="i4" >20</var>
    <var name="s_sSTATE_AWAITING_CALL" type="i2" >0</var>
    <var name="s_sSTATE_CONNECTED_MS" type="i2" >1</var>
    <var name="s_sSTATE_DISCONNECT_MS" type="i2" >2</var>
    <var name="s_sSTATE_CALLER_HUNG_UP" type="i2" >20</var>
    <var name="s_sSTATE_READ_MSG" type="i2" >7</var>
    <var name="s_sSTATE_DELETE_MSG" type="i2" >9</var>
    <var name="s_sSTATE_UPDATE_MSG" type="i2" >8</var>
    <var name="s_sSTATE_UPDATE_PIN" type="i2" >17</var>
    <var name="s_sSTATE_UPDATE_GREET" type="i2" >14</var>
    <var name="s_sSTATE_GET_MSGS" type="i2" >6</var>
    <var name="s_sSTATE_PLAY_OPTIONS" type="i2" >4</var>
    <var name="s_sSTATE_AUTHENTICATE_SUB" type="i2" >3</var>
    <var name="s_sSTATE_HANGUP_SUB" type="i2" >22</var>
    <var name="s_sSTATE_PLAY_BYE" type="i2" >21</var>
    <var name="s_sSTATE_RECORD_GREET" type="i2" >11</var>
    <var name="s_sSTATE_PLAY_GREET" type="i2" >16</var>
    <var name="s_sSTATE_FETCH_GREET" type="i2" >15</var>
    <var name="s_strLocalUri" type="string" ></var>
    <var name="s_sSTATE_PLAY_OPTIONS_SUB" type="i2" >5</var>
    <var name="s_sSTATE_PLAY_GREET_MENU" type="i2" >10</var>
    <var name="s_sSTATE_START_RECORD" type="i2" >12</var>
    <var name="s_sSTATE_STOPPING_RECORD" type="i2" >13</var>
    <var name="s_sSTATE_END_SESSION_ON_ERROR" type="i2" >101</var>
    <var name="s_sSTATE_PLAY_MSG_HEADER" type="i2" >19</var>
    <var name="s_sSTATE_PLAY_MSG_OPTIONS" type="i2" >18</var>
    <var name="s_sSTATE_END_SESSION" type="i2" >100</var>
    <var name="s_nTotalSuccess" type="i4" >0</var>
    <var name="s_nTotalError" type="i4" >0</var>
    <var name="s_strDBName" type="string" >pactolusdb</var>
    <var name="s_sSTATE_GET_SIP_ADDRESS" type="i2" >-1</var>
    <var name="s_sSTATE_SET_MWI" type="i2" >-2</var>
    <var name="s_sSTATE_GOT_REINVITE" type="i2" >25</var>
    <var name="s_sSTATE_CHCK_EXPIRED_MSGS" type="i2" >-3</var>
    <var name="s_sSTATE_RETURN_CALL" type="i2" >26</var>
    <var name="s_strNIUAddress" type="string" ></var>
    <var name="s_sSTATE_RETURNCALL_CONNECTED" type="i2" >27</var>
    <var name="s_sSTATE_HANGUP_RETURN_CALL" type="i2" >28</var>
    <var name="s_sSTATE_WRITE_CDR" type="i2" >30</var>
    <var name="s_nRING_NO_ANSWER_TIME" type="i4" >120</var>
    <var name="s_BT_PREPAID" type="i2" >1</var>
    <var name="s_nPacketizationPeriod" type="i4" >20</var>
    <var name="s_sSTATE_PLAY_ADDTL_GREETINGS" type="i2" >31</var>
    <var name="s_strCodec" type="string" ></var>
    <var name="s_strVMEncodingFlag" type="string" >F</var>
  </shared-vars>
  <functions >
    <function name="OnInvite" start="1" event="OnInvite" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string" pass="byref"/>
        <parameter name="strAcceptEncoding" type="string" pass="byref"/>
        <parameter name="strAcceptLanguage" type="string" pass="byref"/>
        <parameter name="strAlertInfo" type="string" pass="byref"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAnonymity" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string" pass="byref"/>
        <parameter name="strCallId" type="string" pass="byref"/>
        <parameter name="strCallInfo" type="string" pass="byref"/>
        <parameter name="strContact" type="string" pass="byref"/>
        <parameter name="strContent" type="string" pass="byref"/>
        <parameter name="strContentDisposition" type="string" pass="byref"/>
        <parameter name="strContentEncoding" type="string" pass="byref"/>
        <parameter name="strContentLanguage" type="string" pass="byref"/>
        <parameter name="strContentType" type="string" pass="byref"/>
        <parameter name="strCSeq" type="string" pass="byref"/>
        <parameter name="strDate" type="string" pass="byref"/>
        <parameter name="strEncryption" type="string" pass="byref"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strExpires" type="string" pass="byref"/>
        <parameter name="strFrom" type="string" pass="byref"/>
        <parameter name="strInReplyTo" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string" pass="byref"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strMinSE" type="string" pass="byref"/>
        <parameter name="strOrganization" type="string" pass="byref"/>
        <parameter name="strPriority" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string" pass="byref"/>
        <parameter name="strProxyRequire" type="string" pass="byref"/>
        <parameter name="strRecordRoute" type="string" pass="byref"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRemotePartyID" type="string" pass="byref"/>
        <parameter name="strReplaces" type="string" pass="byref"/>
        <parameter name="strRequestURI" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSessionExpires" type="string" pass="byref"/>
        <parameter name="strSubject" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="oSipMsg" type="object" ></var>
        <var name="strEvtRecvd" type="string" ></var>
        <var name="strCallingNumber" type="string" ></var>
        <var name="strCalledNumber" type="string" ></var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=33 y=57 ?>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="New Call" link="5" stubbed="0" >g_sSTATE == s_sSTATE_AWAITING_CALL
AND g_bDepositHandoff == false</result>
            <result name="Handoff from Deposit" link="13" stubbed="0" >g_bDepositHandoff == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bDepositHandoff = false ;
Server.logInfo("REQUEST URI: " + Session.strRequestURI ) ;
if ( -1 != Session.strRequestURI.indexOf("pcs_vmail_deposit") ) {
	Session.g_bDepositHandoff = true ;
}

]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( Session.g_sSTATE == Session.s_sSTATE_AWAITING_CALL ) {

	js_initVoipCallLeg( Session.g_oCallLegA ); 

	Session.g_oMS.strType = Session.s_strMSType ;
	Session.g_oMS.intPacketizationPeriod = 20 ;
	Session.g_oMS.strCodec = "PCMU" ;

	var host = new SipNameAddr( Session.strContact.toString() ) ;
	Session.g_oCallLegA.strRemoteURI = "sip:" + host.url.host ;
	if( 5060 != host.url.port && undefined != host.url.port ) {
		Session.g_oCallLegA.strRemoteURI += ":" + host.url.port ;
	} 
 
	Session.g_oCallLegA.strAccept = Session.strAccept ;
	Session.g_oCallLegA.strAuthorization = Session.strAuthorization ;
	Session.g_oCallLegA.strProxyAuthorization = Session.strProxyAuthorization ;
	Session.g_oCallLegA.strFrom = Session.strFrom ;
	if ( false == Session.g_bDepositHandoff ) {
		Session.g_oCallLegA.strTo = Session.strTo ;
	}
	Session.g_oCallLegA.strContact = Session.strContact ;
	Session.g_oCallLegA.strRecordRoute = Session.strRecordRoute ;
	Session.g_oCallLegA.strRequestUri = Session.strRequestURI ;
	Session.g_oCallLegA.strRoute = Session.strRoute ;
	Session.g_oCallLegA.strContent = Session.strContent ;
	Session.g_oCallLegA.strContentDisposition = Session.strContentDisposition ;
	Session.g_oCallLegA.strContentType = Session.strContentType ;
	Session.g_oCallLegA.strCallId = Session.strCallId ;
	Session.g_oCallLegA.strCSeq = Session.strCSeq ;
	Session.g_oCallLegA.strVia = Session.strVia ;
	
	Session.g_oCallLegA.bUac = false;

	Session.g_strLocalContact = "<" + Session.s_strLocalUri + ">" ;	
	Server.logInfo("Local Contact: " + Session.g_strLocalContact);
	
	/* save the actual calling phone number; we'll update voip_phone_number.last_used_date in authRetrieval */
	var from = new SipFrom( Session.strFrom ) ;
	Session.g_oCallLegA.strCallingNumber = from.url.phoneNumber ;
	

}

]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=481 y=247 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=708 y=337 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=266 y=385 ?>
          <!--DirectCallerToMS-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;DirectCallerToMS&quot;" return="g_nReturnValue" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success" link="7" stubbed="0" >g_nReturnValue == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[js_initMS(Session.g_oMS, Session.s_strMSType);
js_initAPI(Session.g_oAPI);

//initialize API params needed to authenticate user
Session.g_oAPI.strSIPRealm = "" ;
Session.g_oAPI.strAccessNumber = "" ;

/* DH: simply take the first offered codec that we support, as long as transcoding is enabled */
if( "T" == Session.s_strVMEncodingFlag ) {
	Session.g_oMS.strCodec = "no preference" ;
}
else {
 
	var anSdp = new Sdp( Session.strContent );

	for(var i = 0; i < anSdp.media.length; i++) 
	{
    	if (anSdp.media[i].type == "audio")
    	{
       		// cycle through all media streams offered
       		for ( var j = 0; j < anSdp.media[i].rtpMaps.length; j++ )
       		{
           		if (("T" == Session.s_strVMEncodingFlag) && ( anSdp.media[i].rtpMaps[j].type == 18 ))
           		{
                	// Use G729 codec.
                	Session.g_oMS.strCodec = "g729";
                	Server.logInfo("Applying <" + Session.g_oMS.strCodec + "> as the codec for this call.");
                	break;
           		} else if ( anSdp.media[i].rtpMaps[j].type == 0 ) 
           		{
                	// Use PCMU codec.
                	Session.g_oMS.strCodec = "PCMU";
                	Server.logInfo("Applying <" + Session.g_oMS.strCodec + "> as the codec for this call.");
                	break;
           		}
       		}
    	}
	}
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oMS.bCurrentlyConnected = false ;
Session.g_oCallLegA.bConnected = false ;

if (0 == Session.g_nReturnValue) {
	Session.g_oMS.bCurrentlyConnected = true ;
	Session.g_oCallLegA.bConnected = true ;
	Session.g_sSTATE = Session.s_sSTATE_CONNECTED_MS ;
}


	

]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.EndSession.1" ><?xtml-editor x=690 y=477 ?></action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=487 y=367 ?>
          <!--Main-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_AUTHENTICATE_SUB ;]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=266 y=234 ?>
          <!--OnRe-Invite-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;OnRe-Invite&quot;" return="" external-function="0" library="" >
            <parameter >oSipMsg</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.oSipMsg.strAccept = Session.strAccept ;
Session.oSipMsg.strAuthorization = Session.strAuthorization ;
Session.oSipMsg.strProxyAuthorization = Session.strProxyAuthorization ;
Session.oSipMsg.strFrom = Session.strFrom ;
Session.oSipMsg.strTo = Session.strTo ;
Session.oSipMsg.strContact = Session.strContact ;
Session.oSipMsg.strRecordRoute = Session.strRecordRoute ;
Session.oSipMsg.strRoute = Session.strRoute ;
Session.oSipMsg.strContent = Session.strContent ;
Session.oSipMsg.strContentDisposition = Session.strContentDisposition ;
Session.oSipMsg.strContentType = Session.strContentType ;
Session.oSipMsg.strCallId = Session.strCallId ;
Session.oSipMsg.strCSeq = Session.strCSeq ;
Session.oSipMsg.strVia = Session.strVia ;
]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=49 y=351 ?>
          <!--180 Ringing-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 180 Ringing"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="10" plug-in="Pactolus.Sleep.1" ><?xtml-editor x=41 y=220 ?>
          <sleep xmlns="urn:www.pactolus.com:xtml:application" duration="1"/>
          <results >
            <result name="Default" link="9" stubbed="0"/>
          </results>
        </action>
        <action id="11" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=489 y=489 ?>
          <!--503 Service Unavailable-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 503 Service Unavailable"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="13" plug-in="Standard.WaitEvent.1" ><?xtml-editor x=265 y=41 ?>
          <!--Wait for RetrieveAcct message-->
          <wait xmlns="urn:www.pactolus.com:xtml:communication" timeout="2" recv-name="strEvtRecvd" >
            <msg name="RetrieveAcct" >
              <parameter >g_strSubPhone</parameter>
              <parameter >g_oCallLegA.strTo</parameter>
              <parameter >g_oAPI.strSIPRealm</parameter>
              <parameter >g_oMS.strEndPoint</parameter>
              <parameter >g_oMS.strConnectionId</parameter>
              <parameter >g_oMS.strCallId</parameter>
              <parameter >g_oMS.strContent</parameter>
            </msg>
          </wait>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="Success" link="7" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//initialize API params needed to authenticate user

Session.g_oAPI.strSIPRealm = "" ;
Session.g_oAPI.strAccessNumber = "" ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("HANDOFF DETECTED. EVENT RECEIVED: " + Session.strEvtRecvd) ;

if ( 2 == Result.id ) {
	Session.g_oMS.bCurrentlyConnected = true ;
	Session.g_oCallLegA.bConnected = true ;
	Session.g_sSTATE = Session.s_sSTATE_CONNECTED_MS ;
	Server.logInfo("Received Subscriber Acct: " + Session.g_strSubPhone) ;
	Server.logInfo("Received strTo: " + Session.g_oCallLegA.strTo) ;
	Server.logInfo("Received Realm: " + Session.g_oAPI.strSIPRealm) ;
	Server.logInfo("Received MS Connection ID: " + Session.g_oMS.strConnectionId) ;
}

]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=484 y=39 ?>
          <!--MSOutdialParty-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;MSOutdialParty&quot;" return="g_nReturnValue" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_oMS</parameter>
            <parameter >g_strLocalContact</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="1"/>
            <result name="Success" link="7" stubbed="1" >g_nReturnValue == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegA.strOriginalRequestURI = Session.g_oCallLegA.strRequestUri ;
Session.g_oCallLegA.strRequestUri = Session.g_oCallLegA.strRemoteURI ;

Session.g_oCallLegA.bReverseFromTo = true ;

var cseq = new SipCSeq(Session.strCSeq) ;
cseq.increment() ;
Session.g_oCallLegA.strCSeq = cseq.encode() ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oMS.bCurrentlyConnected = false ;
Session.g_oCallLegA.bConnected = false ;

if (0 == Session.g_nReturnValue) {
	Session.g_oMS.bCurrentlyConnected = true ;
	Session.g_oCallLegA.bConnected = true ;
	Session.g_sSTATE = Session.s_sSTATE_CONNECTED_MS ;
}
	

]]></script>
          </scripts>
        </action>
        <action id="20" plug-in="Standard.EndSession.1" ><?xtml-editor x=485 y=165 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("FAILED TO RECEIVE HANDOFF INFORMATION. ENDING SESSION") ;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnServiceLoad" start="1" event="OnServiceLoad" returns="void" >
      <parameters >
        <parameter name="strAppName" type="string" pass="byref"/>
        <parameter name="nSessionCount" type="i2" pass="byref"/>
        <parameter name="nMaxIterations" type="i2" pass="byref"/>
        <parameter name="nServerId" type="i2" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.UserFunction.1" ><?xtml-editor x=175 y=82 ?>
          <user-function xmlns="urn:www.pactolus.com:xtml:application" process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;get_property&quot;" timeout="s_nTimeout" return="g_nReturnValue" async="0" >
            <parameter >"media-server-type"</parameter>
            <parameter >s_strMSType</parameter>
            <parameter >"niu-address"</parameter>
            <parameter >s_strNIUAddress</parameter>
            <parameter >"codec"</parameter>
            <parameter >s_strCodec</parameter>
            <parameter >"vmail-encoding-flag"</parameter>
            <parameter >s_strVMEncodingFlag</parameter>
          </user-function>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=399 y=103 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.s_strLocalUri = Server.sipAddress ;
	if( 5060 != Server.sipPort ) {
		Session.s_strLocalUri += ":" ;
		Session.s_strLocalUri += Server.sipPort ;
	}



// if the vmail-encoding-flag is false or not present then we do not allow
// for the transcoding of VM from g.729 to PCMU and vice versa.
if ("F" == Session.s_strVMEncodingFlag || "f" == Session.s_strVMEncodingFlag)
{
	if ( "pcma" == Session.s_strCodec || "PCMA" == Session.s_strCodec ) {
    	Session.s_strCodec = "PCMA";
     	Server.logInfo("Applying <" + Session.s_strCodec + "> as the codec for this call."); 
	} else {
    	Session.s_strCodec = "PCMU" ;
     	Server.logInfo("Applying PCMU as the codec for this call.");
	}
}
// otherwise .. allow transcoding
else {
	if ( "g729" == Session.s_strCodec || "G729" == Session.s_strCodec) {
    	Session.s_strCodec = "g729";
     	Server.logInfo("Applying <" + Session.s_strCodec + "> as the codec for this call.");
	} else if ( "pcma" == Session.s_strCodec || "PCMA" == Session.s_strCodec ) {
     	Session.s_strCodec = "PCMA";
     	Server.logInfo("Applying <" + Session.s_strCodec + "> as the codec for this call."); 
	} else {
     	Session.s_strCodec = "PCMU" ;
     	Server.logInfo("Applying PCMU as the codec for this call.");
	}
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="Main" start="2" event="Main" returns="void" >
      <actions >
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=63 y=227 ?>
          <results >
            <result name="Default" link="5" stubbed="1"/>
            <result name="AUTHENTICATE_SUB" link="4" stubbed="0" >g_sSTATE == s_sSTATE_AUTHENTICATE_SUB</result>
            <result name="GET_MSGS" link="3" stubbed="1" >g_sSTATE == s_sSTATE_GET_MSGS</result>
            <result name="PLAY_OPTIONS" link="6" stubbed="1" >g_sSTATE == s_sSTATE_PLAY_OPTIONS
OR g_sSTATE == s_sSTATE_PLAY_OPTIONS_SUB</result>
            <result name="READ_MSG" link="7" stubbed="1" >g_sSTATE == s_sSTATE_READ_MSG
OR g_sSTATE == s_sSTATE_PLAY_MSG_OPTIONS</result>
            <result name="RECORD_GREET" link="9" stubbed="1" >g_sSTATE == s_sSTATE_RECORD_GREET</result>
            <result name="UPDATE_PIN" link="10" stubbed="1" >g_sSTATE == s_sSTATE_UPDATE_PIN</result>
            <result name="PLAY_BYE" link="11" stubbed="1" >g_sSTATE == s_sSTATE_PLAY_BYE</result>
            <result name="HANGUP_SUB" link="8" stubbed="1" >g_sSTATE == s_sSTATE_HANGUP_SUB</result>
            <result name="DISCONNECT_MS" link="12" stubbed="1" >g_sSTATE == s_sSTATE_DISCONNECT_MS</result>
            <result name="RETURN_CALL" link="13" stubbed="1" >g_sSTATE == s_sSTATE_RETURN_CALL</result>
            <result name="RETURN_CALL_CONNECTED" link="14" stubbed="1" >g_sSTATE == s_sSTATE_RETURNCALL_CONNECTED</result>
            <result name="HANGUP_RETURN_CALL" link="15" stubbed="1" >g_sSTATE == s_sSTATE_HANGUP_RETURN_CALL</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( Session.g_sSTATE == Session.s_sSTATE_HANGUP_SUB && false == Session.g_oCallLegA.bConnected ) {
	Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ;
}]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=326 y=137 ?>
          <!--GetMessages-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;GetMessages&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="4" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=322 y=43 ?>
          <!--AuthenticateSub-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;AuthenticateSub&quot;" return="" external-function="1" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="5" plug-in="Standard.EndSession.1" ><?xtml-editor x=79 y=510 ?></action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=328 y=232 ?>
          <!--PlayOptions-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;PlayOptions&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="7" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=333 y=324 ?>
          <!--ReadMessages-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;ReadMessages&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="8" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=335 y=716 ?>
          <!--HangUpParty - CallLegA-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strLocalContact</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegA.bReverseFromTo = true ;
Session.g_oCallLegA.strRequestUri = Session.g_oCallLegA.strRemoteURI ;

js_calculate_uri_and_route( false, "SIP/2.0", 
	Session.g_oCallLegA.strFrom.toString(),
	Session.g_oCallLegA.strContact.toString(),
	Session.g_oCallLegA.strRecordRoute.toString(),
	Session.g_oCallLegA.strRequestUri, 
	Session.g_oCallLegA.strRoute ) ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( true == Session.g_oMS.bCurrentlyConnected ) {
	Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_END_SESSION ;
}

Session.g_oCallLegA.bConnected = false ;]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=334 y=418 ?>
          <!--RecordNewGreeting-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;RecordNewGreeting&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="10" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=334 y=514 ?>
          <!--UpdatePIN-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;UpdatePIN&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=332 y=617 ?>
          <!--PlayGoodbye-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;PlayGoodbye&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="12" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=338 y=814 ?>
          <!--DeleteMSConnection-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="lib_mediaserver.xml" >
            <parameter >g_oMS</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if ( Session.g_bSystemError ) {
	Session.g_sSTATE = Session.s_sSTATE_END_SESSION_ON_ERROR ;
	}
else {
	Session.g_sSTATE = Session.s_sSTATE_END_SESSION ;
	}
	
Session.g_oMS.bCurrentlyConnected = false ;]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=338 y=917 ?>
          <!--RapidCallReturn-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;ReturnCall&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
        </action>
        <action id="14" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=80 y=576 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="15" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=341 y=1018 ?>
          <!--HangUpParty - CallLegB-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegB</parameter>
            <parameter >g_strLocalContact</parameter>
          </function>
          <results >
            <result name="Default" link="2" stubbed="1"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.bReverseFromTo = false ;


]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_oCallLegB.bConnected = false ;
Session.g_oCallLegB.lTimeEnded = Server.getUTCTime() ;

if ( Session.g_oCallLegA.bConnected == true ) {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_OPTIONS ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_END_SESSION;
}]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="GetMessages" start="1" event="GetMessages" returns="void" >
      <local-vars >
        <var name="bCancelled" type="boolean" >0</var>
        <var name="nRetryCount" type="i4" >0</var>
        <var name="strPhone_map" type="string" >(xxxxxxxxxx|x.#|x.T|xx.*)</var>
        <var name="strPIN_map" type="string" >(xxxxxx|xx.#|x.T|xx.*)</var>
        <var name="strPIN" type="string" ></var>
        <var name="nMsgCount" type="i4" >0</var>
        <var name="nTotalMsgs" type="i4" >0</var>
        <var name="nNewMsgs" type="i4" >0</var>
        <var name="strDigits" type="string" ></var>
        <var name="nReturnCode" type="i4" >0</var>
        <var name="nMessagePrompt" type="i4" >0</var>
        <var name="nNewUrgentMsgs" type="i4" >0</var>
        <var name="nUrgentMessagePrompt" type="i4" >0</var>
        <var name="nSavedMsgs" type="i4" >0</var>
        <var name="nSavedMsgsPrompt" type="i4" >0</var>
        <var name="nAndPrompt1" type="i4" >0</var>
        <var name="nAndPrompt2" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.MailboxStatus.1" ><?xtml-editor x=32 y=162 ?>
          <!--Status InBox-->
          <imap-status xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;InBox&quot;" flagged-count="g_nUrgent_Count" unseen-count="g_nUnseen_Count" saved-count="g_nSaved_Count" flagged="g_oUrgent" unseen="g_oUnseen" saved="g_oSaved" returns="g_nReturnValue" timeout="s_nTimeout"/>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success" link="14" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="no messages" link="7" stubbed="0" >g_nUnseen_Count == 0
AND g_nUrgent_Count == 0
AND g_nSaved_Count == 0
AND 'Result'  != 'Timeout'</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***FETCHING MAILBOX STATUS***") ;

/* clear out any previous values for message vars */
Session.g_oMessage.strFrom = "" ;
Session.g_oMessage.strDate = "" ;
Session.g_oMessage.strAtt1 = "" ;
Session.g_oMessage.iId = 0 ;

Session.g_nSaved_Count = 0 ;
Session.g_nUnseen_Count = 0 ;	
Session.g_nUrgent_Count = 0 ;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Urgent Msgs: " + Session.g_nUrgent_Count) ;
Server.logInfo("Unseen Msgs: " + Session.g_nUnseen_Count) ;
Server.logInfo("Saved Msgs: " + Session.g_nSaved_Count) ;

Session.nTotalMsgs = Session.g_nUnseen_Count + Session.g_nUrgent_Count + Session.g_nSaved_Count ;
Session.nNewMsgs = Session.g_nUnseen_Count ;
Session.nNewUrgentMsgs = Session.g_nUrgent_Count ;]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=259 y=40 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError( "Ending session after state: " + Session.g_sSTATE ) ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_BYE ;

Session.g_bSystemError = true ;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=250 y=432 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS ;]]></script>
          </scripts>
        </action>
        <action id="7" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=50 y=380 ?>
          <!--No new messages-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1796</audio>
          </play>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.Branch.1" ><?xtml-editor x=268 y=255 ?>
          <results >
            <result name="Default" link="13" stubbed="1"/>
            <result name="Urgent and Non" link="10" stubbed="1" >g_nUrgent_Count &gt; 0
AND g_nUnseen_Count &gt; 0</result>
            <result name="Only Urgent" link="12" stubbed="1" >g_nUrgent_Count &gt; 0
AND g_nUnseen_Count == 0</result>
            <result name="Only New Non-Urgent" link="13" stubbed="0" >g_nUnseen_Count &gt; 0
AND g_nUrgent_Count == 0</result>
            <result name="Only Saved Msgs" link="15" stubbed="0" >g_nSaved_Count &gt; 0
AND g_nUnseen_Count == 0
AND g_nUrgent_Count == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if ( 1 == Session.nNewMsgs ) {
	Session.nMessagePrompt = 1775 ;
}
else {
	Session.nMessagePrompt = 1766 ;
}

if ( 1 == Session.nNewUrgentMsgs ) {
	Session.nUrgentMessagePrompt = 1803 ;
}
else {
	Session.nUrgentMessagePrompt = 1802 ;
}

if ( 0 < Session.g_nSaved_Count ) {
	Session.nSavedMsgs = Session.g_nSaved_Count ;
	if ( 1 == Session.g_nSaved_Count ) {
		Session.nSavedMsgsPrompt = 1778 ; 
	}
	else {
		Session.nSavedMsgsPrompt = 1836 ;
	}
	Session.nAndPrompt1 = 99 ;
}
else {
	Session.nAndPrompt1 = 1831 ;
}
]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=505 y=50 ?>
          <!--Your mailbox is full.-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1799</audio>
            <audio type="index" >1800</audio>
          </play>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="10" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=503 y=215 ?>
          <!--Announce All message types-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigits" terminating-char="" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="g_strDigitMap_x" fdt="10" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >515</audio>
            <audio type="number" >nNewUrgentMsgs</audio>
            <audio type="index" >nUrgentMessagePrompt</audio>
            <audio type="index" >nAndPrompt1</audio>
            <audio type="number" >nNewMsgs</audio>
            <audio type="index" >nMessagePrompt</audio>
          </collect-play>
          <results >
            <result name="Default" link="18" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
        </action>
        <action id="11" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1165 y=450 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( 1 == Session.strDigits ) {
	Session.g_sSTATE = Session.s_sSTATE_READ_MSG ;
	Session.g_oMessage.bReadNew = true ;
}
else if ( 2 == Session.strDigits ) {
	Session.g_sSTATE = Session.s_sSTATE_READ_MSG ;
	Session.g_oMessage.bReadNew = false ;
}
else if ( 3 == Session.strDigits ) {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS_SUB ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS ;
}
]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=504 y=397 ?>
          <!--Announce New Messages - only urgent-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigits" terminating-char="" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="g_strDigitMap_x" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >515</audio>
            <audio type="number" >nNewUrgentMsgs</audio>
            <audio type="index" >nUrgentMessagePrompt</audio>
          </collect-play>
          <results >
            <result name="Default" link="18" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
        </action>
        <action id="13" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=507 y=579 ?>
          <!--Announce New Messages - only non-urgent new-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigits" terminating-char="" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="g_strDigitMap_x" fdt="10" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >515</audio>
            <audio type="number" >nNewMsgs</audio>
            <audio type="index" >nMessagePrompt</audio>
          </collect-play>
          <results >
            <result name="Default" link="18" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
        </action>
        <action id="14" plug-in="Pactolus.Branch.1" ><?xtml-editor x=257 y=106 ?>
          <results >
            <result name="Default" link="8" stubbed="0"/>
            <result name="nTotalMsgs &gt;= g_nMaxMsgs" link="9" stubbed="0" >nTotalMsgs &gt;= g_nMaxMsgs
AND g_nMaxMsgs != 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if ( 1 == Session.nNewMsgs ) {
	Session.nMessagePrompt = 1775 ;
}
else {
	Session.nMessagePrompt = 1766 ;
}

if ( 1 == Session.nNewUrgentMsgs ) {
	Session.nUrgentMessagePrompt = 1803 ;
}
else {
	Session.nUrgentMessagePrompt = 1802 ;
}]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=511 y=767 ?>
          <!--Announce Saved Messages Only-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigits" terminating-char="" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="g_strDigitMap_x" fdt="10" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >1796</audio>
            <audio type="index" >515</audio>
            <audio type="number" >nSavedMsgs</audio>
            <audio type="index" >nSavedMsgsPrompt</audio>
          </collect-play>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
        </action>
        <action id="16" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=899 y=417 ?>
          <!--Saved Messages-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigits" terminating-char="" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="g_strDigitMap_x" fdt="5" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >1831</audio>
            <audio type="number" >nSavedMsgs</audio>
            <audio type="index" >nSavedMsgsPrompt</audio>
          </collect-play>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
        </action>
        <action id="17" plug-in="Pactolus.Branch.1" ><?xtml-editor x=980 y=262 ?>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="g_nSaved_Count &gt; 0" link="16" stubbed="0" >g_nSaved_Count &gt; 0</result>
          </results>
        </action>
        <action id="18" plug-in="Pactolus.Branch.1" ><?xtml-editor x=762 y=250 ?>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="strDigits = &quot;1&quot;" link="11" stubbed="0" >strDigits match "1"</result>
            <result name="strDigits = &quot;2&quot;" link="11" stubbed="1" >strDigits match "2"</result>
            <result name="strDigits = &quot;3&quot;" link="11" stubbed="0" >strDigits match "3"</result>
          </results>
        </action>
      </actions>
    </function>
    <function name="AuthenticateSub" start="14" event="AuthenticateSub" returns="void" >
      <local-vars >
        <var name="strPhoneMap" type="string" >([0-9] xxxxxxxxxx|x.#|x.T|xx.*)</var>
        <var name="bCancelled" type="boolean" >0</var>
        <var name="nRetryCount" type="i4" >0</var>
        <var name="bValidSub" type="boolean" >0</var>
        <var name="bLoadTest" type="boolean" >0</var>
        <var name="bAuthorized" type="boolean" >0</var>
        <var name="strMailBox" type="string" ></var>
        <var name="nPIN_length" type="i4" >0</var>
        <var name="nReturnCode" type="i4" >0</var>
        <var name="nErrorPrompt" type="i4" >0</var>
        <var name="strDestReceived" type="string" ></var>
        <var name="strTermDigitRecvd" type="string" ></var>
        <var name="bGetPhoneNumber" type="boolean" >0</var>
        <var name="nPhoneNumbers" type="i4" >0</var>
        <var name="bPstnCaller" type="boolean" >0</var>
        <var name="strTemp" type="string" ></var>
        <var name="bNumberTooShort" type="boolean" >0</var>
      </local-vars>
      <actions >
        <action id="14" plug-in="Pactolus.Branch.1" ><?xtml-editor x=24 y=36 ?>
          <!--Check for Sip Realm-->
          <results >
            <result name="Default" link="23" stubbed="0"/>
            <result name="get phone number" link="24" stubbed="0" >bGetPhoneNumber == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strProcDBName = Session.s_strDBName;
Session.bGetPhoneNumber = false;

if( Session.g_oCallLegA.strProxyAuthorization.length > 0 && !Session.g_bDepositHandoff ) {

	Session.bAuthorized = true;	

	/* get values */
	var s = Session.g_oCallLegA.strProxyAuthorization.toString() ;
	
	if( !js_parse_value( s, "realm", Session.g_oAPI.strSIPRealm ) )
	{
		Server.logError("Failed to parse attributes for authentication") ;
		Session.bAuthorized = false;
	}
	else {
		Server.logInfo("Service Provider Realm: " + Session.g_oAPI.strSIPRealm) ;
	}
	
	if ( !js_parse_value( s, "username", Session.g_oAPI.strUserName ) )
	{
		Server.logError("Failed to parse attributes for authentication") ;
		Session.bAuthorized = false;
	}
	else {
		Server.logInfo("UserName: " + Session.g_oAPI.strUserName) ;
	}
	
	
	//check if the voice mail account id has been passed in
	//INVITE sip:10.10.100.127:5060;target=pcs_vmail_deposit;vmail_account_id=7632;access_line_id=xxx SIP/2.0
	if( !parse_uri_params( Session.g_oCallLegA.strRequestUri ) ) {

		/* get destination phone number */
		var from = new SipFrom(Session.g_oCallLegA.strFrom.toString());
		if ( undefined != from.url.phoneNumber) {
	
			var check_from = from.url.phoneNumber.toLowerCase() ;

			if( -1 != check_from.indexOf( "anonymous" ) 
				||  -1 != check_from.indexOf( "restricted" ) 
				||  -1 != check_from.indexOf( "blocked" ) 
		  		||  -1 != check_from.indexOf( "undefined" ) )
		  	{
		  		Session.bAuthorized = false;
			  	Server.logError("Sub's ani blocked: " + from.url.phoneNumber);
		  	}
		  	else {
		  		//first check that the phoneNumber field is not alphaNumeric characters.
		  		var len = from.url.phoneNumber.length;
				var nPos = -1;
				
				for (var i = 0; i < len; i++) {
					var c = from.url.phoneNumber.charAt(i);
					if (( c >= "a" && c <= "z" ) || ( c >= "A" && c <= "Z")){
						nPos = i;
						break;	
					}
				}
		  		if ( -1 == nPos ) {
					// TODO (GAT) What if access_line_id is zero?
					if( js_parse_value( Session.g_oCallLegA.strRequestUri, "access_line_id", Session.g_oAPI.lAccessLineId ) ) {
					
						Server.logInfo("Parsed access line id: " + Session.g_oAPI.lAccessLineId);
						// Can't use the authentication name as the phone number
						// But can assume that the call is authorized at this point
		  				Session.bGetPhoneNumber = true;
					}
					else {
				  		Session.g_strSubPhone = from.url.phoneNumber;
				  		Server.logInfo("g_strSubPhone: " + Session.g_strSubPhone);
				  	}
		  		}
		  		else {
		  			Session.bAuthorized = false;
		  			Server.logInfo("Could not extract phone number from From header");
		  		}
		  	}
		}
		else {
			Session.bAuthorized = false; //no ani for sub
			Server.logError("Sub's ani undefined: " + from.url.user);
		}	
	}
	else {
		Session.bAuthorized = true ;
		Session.bGetPhoneNumber = true;
	}		  			
	
} //have Proxy Authentication header
	  
else {
	Server.logInfo("No Authorization header provided") ;
	Server.logInfo("Realm: " + Session.g_oAPI.strSIPRealm) ;
	Session.bAuthorized = false ;
	
	/*If no realm found set AccessNumber equal to phone number of RequestURI */
	if( !parse_uri_params( Session.g_oCallLegA.strRequestUri ) ) {
		if ( 0 == Session.g_oAPI.strSIPRealm.toString().length ) {
			var access_no = new SipRequestUri( Session.g_oCallLegA.strRequestUri.toString() ) ;
			Session.g_oAPI.strAccessNumber = access_no.url.phoneNumber ;
			
			/* remove ;npdi=yes from the phone number String */
			var i = Session.g_oAPI.strAccessNumber.toString().indexOf(";") ;
			if ( -1 != i ) {
				var access = Session.g_oAPI.strAccessNumber.toString().substring(0, i) ;
				Session.g_oAPI.strAccessNumber = access ;
			}
			Server.logInfo("Extracted Access Number: " + Session.g_oAPI.strAccessNumber);
		}
		else {
			Session.bAuthorized = true ;  //This is a handoff call.
		}
	}
	else {
		Session.bAuthorized = true ;
		Session.bGetPhoneNumber = true;
		Session.bPstnCaller = true ;
	}
}


	]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=31 y=577 ?>
          <!--Prompt for PIN-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="g_strPINmap" language="g_strLanguage" digits="g_strPIN" retry-count="3" clear-digits="1" terminating-digit="g_strTermDigit" quick-collect="0" digit-timer="" >
            <audio type="silence" >.5</audio>
            <audio type="index" >501</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="Success" link="17" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="PIN cancelled" link="3" stubbed="1" >bCancelled == true</result>
            <result name="PIN too long" link="16" stubbed="1" >nPIN_length &gt;= 20</result>
            <result name="PIN too short" link="8" stubbed="1" >nPIN_length &lt; 3
AND nPIN_length &gt; 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PROMPTING FOR PIN***") ;

Session.bCancelled = false ;
Session.g_strTermDigit = "" ;
Session.nPIN_length = 0 ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if ( "*" == Session.g_strTermDigit ) {
	Session.bCancelled = true ;
}

Session.nPIN_length = Session.g_strPIN.length ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.nErrorPrompt = 1010 ; //Invalid PIN]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=887 y=420 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( "T" == Session.g_strFirstCall ) {
	Session.g_sSTATE = Session.s_sSTATE_UPDATE_PIN ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_GET_MSGS ;
}]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=612 y=566 ?>
          <!--Invalid PIN-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1763</audio>
          </play>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Max Retries" link="18" stubbed="0" >nRetryCount == 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nRetryCount++ ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id ) {
	Session.nErrorPrompt = 1010 ; //Invalid PIN
}]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=360 y=53 ?>
          <!--Get Mailbox number-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="strPhoneMap" language="g_strLanguage" digits="g_strSubPhone" retry-count="3" clear-digits="1" terminating-digit="g_strTermDigit" quick-collect="0" digit-timer="" >
            <audio type="silence" >.5</audio>
            <audio type="index" >1764</audio>
            <timeout-prompt type="index" >552</timeout-prompt>
          </play>
          <results >
            <result name="Default" link="12" stubbed="0"/>
            <result name="Success" link="3" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Mailbox cancelled" link="11" stubbed="1" >g_strTermDigit match "*"</result>
            <result name="number too short" link="12" stubbed="0" >bNumberTooShort == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("COLLECTING MAIL BOX NUMBER");
Session.g_strTermDigit = "";
Session.g_strSubPhone = "" ;
]]></script>
            <script language="javascript" timing="middle" ><![CDATA[/* you can't enter an extension, it must be a DID since extensions are not
	unique within an SP
*/
Session.bNumberTooShort = (Session.g_strSubPhone.length < 5 ) ;]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=614 y=48 ?>
          <!--Phone number not recognized-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1765</audio>
          </play>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Max Retries" link="18" stubbed="1" >nRetryCount == 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nRetryCount++ ;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 2 != Result.id ) {
	Session.nErrorPrompt = 307 ; //Please call customer service
}]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=389 y=563 ?>
          <!--PIN too long-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1815</audio>
          </play>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Max Retries" link="18" stubbed="0" >nRetryCount == 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nRetryCount++ ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id ) {
	Session.nErrorPrompt = 1010 ; //Invalid PIN
}]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=379 y=272 ?>
          <!--psAPISceVoicemailAuth.authVoicemailRetrieval-->
          <java xmlns="urn:www.pactolus.com:xtml:application" class="&quot;com.pactolus.broadband.psAPISceVoicemailAuth&quot;" method="&quot;authVoicemailRetrieval&quot;" timeout="s_nTimeout" return="g_nReturnValue" method-return-var="nReturnCode" method-return-type="0" >
            <parameter type="in" var-type="string" >g_oAPI.strProcDBName</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strPlatformSessionId</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strSIPRealm</parameter>
            <parameter type="in" var-type="string" >g_strPIN</parameter>
            <parameter type="in" var-type="string" >g_strSubPhone</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strAccessNumber</parameter>
            <parameter type="in" var-type="i8" >g_oAPI.lVMAcctId</parameter>
            <parameter type="inout" var-type="string" >g_strFirstCall</parameter>
            <parameter type="inout" var-type="string" >g_oMessage.strAcctName</parameter>
            <parameter type="inout" var-type="string" >g_oMessage.strAcctPassword</parameter>
            <parameter type="inout" var-type="i4" >g_nMaxMsgs</parameter>
            <parameter type="inout" var-type="i4" >g_nMsgSaveFor</parameter>
            <parameter type="inout" var-type="i4" >g_nMaxGreetingLength</parameter>
            <parameter type="inout" var-type="i8" >g_oAPI.lVMAcctId</parameter>
            <parameter type="inout" var-type="i8" >g_oAPI.lAccessLineId</parameter>
            <parameter type="inout" var-type="i8" >g_oAPI.lSubscriberId</parameter>
            <parameter type="inout" var-type="i8" >g_oAPI.lSvcProviderId</parameter>
            <parameter type="inout" var-type="i4" >g_oAPI.iVMServiceId</parameter>
            <parameter type="inout" var-type="string" >g_oAPI.strRealm</parameter>
            <parameter type="inout" var-type="string" >g_oAPI.strUserName</parameter>
            <parameter type="inout" var-type="string" >g_oAPI.strPassword</parameter>
            <parameter type="inout" var-type="string" >g_oAPI.strGreeting</parameter>
            <parameter type="inout" var-type="string" >g_oAPI.strCallReturnFlag</parameter>
            <parameter type="inout" var-type="i4" >g_oAPI.nTimezoneId</parameter>
            <parameter type="inout" var-type="i4" >g_nPinLength</parameter>
            <parameter type="inout" var-type="i8" >g_oAPI.lDeptId</parameter>
          </java>
          <results >
            <result name="Default" link="18" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="-10 Invalid PIN" link="8" stubbed="1" >nReturnCode == -10</result>
            <result name="-7, -13, -16 Invalid Phone/Sub" link="12" stubbed="0" >nReturnCode == -7
OR nReturnCode == -13
OR nReturnCode == -16</result>
            <result name="0 Success" link="6" stubbed="0" >nReturnCode == 0
AND 'Result'  == 'Success'
AND g_oAPI.strGreeting != "Alternate_Greeting"</result>
            <result name="0, Alternate Greeting " link="21" stubbed="0" >g_oAPI.strGreeting == "Alternate_Greeting"
AND 'Result'  == 'Success'</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strPlatformSessionId = Session._sessionId ;

Session.g_sSTATE = Session.s_sSTATE_AUTHENTICATE_SUB ;

if( Session.bPstnCaller ) {
	Session.strTemp = Session.g_strSubPhone ;
	Session.g_strSubPhone = Session.g_oCallLegA.strCallingNumber ;
}
Server.logInfo("AUTHENTICATE VOICEMAIL for Sub: " + Session.g_strSubPhone) ;
Server.logInfo("AUTHENTICATE VOICEMAIL for Realm: " + Session.g_oAPI.strSIPRealm) ;
Server.logInfo("AUTHENTICATE VOICEMAIL for Access Number: " + Session.g_oAPI.strAccessNumber) ;
Server.logInfo("AUTHENTICATE VOICEMAIL for PIN: " + Session.g_strPIN) ;
Server.logInfo("AUTHENTICATE VOICEMAIL for Voice Mail Account ID: " + Session.g_oAPI.lVMAcctId);





]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("PAC Return Value: " + Session.g_nReturnValue) ;
Server.logInfo("API Return Code: " + Session.nReturnCode ) ;

if ( 0 == Session.nReturnCode ) {
	Server.logInfo("***AUTHENTICATE VOICEMAIL Successful***") ;
	Server.logInfo("First call: " + Session.g_strFirstCall ) ;
	Server.logInfo("Mailbox Account Name: " + Session.g_oMessage.strAcctName ) ;
	Server.logInfo("Max Messages: " + Session.g_nMaxMsgs ) ;
	Server.logInfo("Message Save Time: " + Session.g_nMsgSaveFor ) ;
	Server.logInfo("Max Greeting length: " + Session.g_nMaxGreetingLength ) ;
	Server.logInfo("Pin Length: " + Session.g_nPinLength ) ;
	Server.logInfo("Realm: " + Session.g_oAPI.strRealm ) ;
	Server.logInfo("UserName: " + Session.g_oAPI.strUserName ) ;
	Server.logInfo("Password: " + Session.g_oAPI.strPassword ) ;
	Server.logInfo("Active Greeting: " + Session.g_oAPI.strGreeting) ;
	if ( null == Session.g_oAPI.strGreeting || "null" == Session.g_oAPI.strGreeting || 0 == Session.g_oAPI.strGreeting.length ) {
		Session.g_oAPI.strGreeting = "System_Greeting" ;
	}
	Server.logInfo("Rapid Call Return: " + Session.g_oAPI.strCallReturnFlag) ;
	Server.logInfo("Timezone ID: " + Session.g_oAPI.nTimezoneId ) ;
	if ( 0 < Session.strDestReceived.length ) {
		Session.g_strSubPhone = Session.strDestReceived;
	}
	Server.logInfo("Subscriber Phone Number: " + Session.g_strSubPhone);
	Server.logInfo("Corp Dept ID: " + Session.g_oAPI.lDeptId);
	if ( 0 < Session.g_oAPI.lDeptId ) {
		Session.g_bCorpAcct = true;
	}
}

/* set to generic value: "System Error has occurred" */
Session.nErrorPrompt = 305 ;

switch (Session.nReturnCode) {
	case -1:
		Session.nErrorPrompt = 1014 ;
		Server.logError("authenticateVoicemailRetrieval returned FAILURE") ;
		break ;
	case -2:
		Session.nErrorPrompt = 1001 ;
		Server.logError("authenticateVoicemailRetrieval returned DB_ERROR") ;
		break ;
	case -3:
		Session.nErrorPrompt = 1004 ;
		Server.logError("authenticateVoicemailRetrieval returned SRVC_PROVIDER_DISABLED") ;
		break ;
	case -4:
		Session.nErrorPrompt = 7000 ;
		Server.logError("authenticateVoicemailRetrieval returned ACCESS_LINE_DISABLED") ;
		break ;
	case -5:
		Session.nErrorPrompt = 1003 ;
		Server.logError("authenticateVoicemailRetrieval returned INVALID_SRVC_PROVIDER") ;
		break ;
	case -6:
		Session.nErrorPrompt = 1005 ;
		Server.logError("authenticateVoicemailRetrieval returned SUBSCRIBER_DISABLED") ;
		break ;
	case -8:
		Session.nErrorPrompt = 7008 ;
		Server.logError("authenticateVoicemailRetrieval returned VMAIL_DISABLED") ;
		break;
	case -11:
		Session.nErrorPrompt = 7002 ;
		Server.logError("authenticateVoicemailRetrieval returned INVALID_ACCESS_LINE") ;
		break ;
	case -12:
		Session.nErrorPrompt = 7003 ;
		Server.logError("authenticateVoicemailRetrieval returned INVALID_SERVICE") ;
		break ;
	case -14:
		Session.nErrorPrompt = 7005 ; 
		Server.logError("authenticateVoicemailRetrieval returned REALM_ACCESS_MISSING") ;
		break ;
	case -15:
		Session.nErrorPrompt = 7006 ; 
		Server.logError("authenticateVoicemailRetrieval returned SERVICE_NOT_FOUND") ;
		break ;
}

if( Session.bPstnCaller ) {
	Session.g_strSubPhone = Session.strTemp ;
}

]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=615 y=217 ?>
          <!--Error fetching mailbox info -->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >365</audio>
            <audio type="number" >nErrorPrompt</audio>
          </play>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="20" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=845 y=293 ?>
          <!--hangup sub-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError( "Ending session after state: " + Session.g_sSTATE ) ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_HANGUP_SUB ;]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=616 y=371 ?>
          <!--"Your outgoing message is currently set to the Alternate Greeting"-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1848</audio>
          </play>
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="23" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=19 y=319 ?>
          <!--VoipGetLanguageCode-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;VoipGetLanguageCode&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_strSubPhone</parameter>
            <parameter >g_oAPI.strUserName</parameter>
            <parameter >g_oAPI.strSIPRealm</parameter>
            <parameter >g_oAPI.lVMAcctId</parameter>
            <parameter >g_oAPI.strAccessNumber</parameter>
            <parameter >g_strLanguage</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="bAuthorized == true" link="3" stubbed="0" >bAuthorized == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strPlatformSessionId = Session._sessionId ;


Session.nRetryCount = 0;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Setting language code to: " + Session.g_strLanguage);]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=154 y=227 ?>
          <!--VoipGetPhoneNumbers-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;VoipGetPhoneNumbers&quot;" return="nReturnCode" external-function="1" library="lib_APISce.xml" >
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >g_oAPI.lAccessLineId</parameter>
            <parameter >nPhoneNumbers</parameter>
            <parameter >g_strSubPhone</parameter>
          </function>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="success" link="23" stubbed="1" >nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Setting phone number to: " + Session.g_strSubPhone);]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="PlayOptions" start="31" event="PlayOptions" returns="void" >
      <local-vars >
        <var name="strDigit" type="string" ></var>
        <var name="strPIN" type="string" ></var>
        <var name="nRetryCount" type="i4" >0</var>
        <var name="strRecordURL" type="string" ></var>
        <var name="nRecordLength" type="i4" >0</var>
        <var name="nReasonCode" type="i4" >0</var>
        <var name="strResponseText" type="string" ></var>
        <var name="nNewMsgsPrompt" type="i4" >0</var>
        <var name="nNewMsgsDtmf" type="i4" >0</var>
        <var name="nSavedMsgsPrompt" type="i4" >0</var>
        <var name="nSavedMsgsDtmf" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="31" plug-in="Pactolus.Branch.1" ><?xtml-editor x=66 y=40 ?>
          <results >
            <result name="Default" link="36" stubbed="0"/>
            <result name="Play_Options_Sub == true" link="35" stubbed="0" >g_sSTATE == s_sSTATE_PLAY_OPTIONS_SUB</result>
          </results>
        </action>
        <action id="17" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=585 y=308 ?>
          <!--BYE-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError( "Ending session after state: " + Session.g_sSTATE ) ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_BYE ;]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=590 y=442 ?>
          <!--Read Messages-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_READ_MSG ;]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=544 y=41 ?>
          <!--Record Greeting-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_RECORD_GREET ;]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=547 y=118 ?>
          <!--Update PIN-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_UPDATE_PIN ;]]></script>
          </scripts>
        </action>
        <action id="35" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=317 y=39 ?>
          <!--Personal Options Menu-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigit" terminating-char="" rc="" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;([1-2]|*)&quot;" fdt="50" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >1811</audio>
            <audio type="index" >311</audio>
            <audio type="index" >1793</audio>
            <audio type="index" >312</audio>
            <audio type="index" >560</audio>
          </collect-play>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="35" stubbed="1"/>
            <result name="First/Inter Digit Timeout" link="35" stubbed="1"/>
            <result name="1 - update greeting" link="30" stubbed="1" >strDigit match "1"</result>
            <result name="2 - change PIN" link="32" stubbed="1" >strDigit match "2"</result>
            <result name="* - previous menu" link="36" stubbed="1" >strDigit match "*"</result>
            <result name="Max Retries" link="36" stubbed="1" >nRetryCount == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING PERSONAL OPTIONS MENU: 1 TO UPDATE GREET, 2 FOR PASSWORD***") ;

Session.strDigit = "" ;

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 337 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount++ ;
}
else {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount = 0 ;
}]]></script>
          </scripts>
        </action>
        <action id="36" plug-in="Pactolus.MailboxStatus.1" ><?xtml-editor x=70 y=150 ?>
          <!--Status InBox-->
          <imap-status xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;InBox&quot;" flagged-count="g_nUrgent_Count" unseen-count="g_nUnseen_Count" saved-count="g_nSaved_Count" flagged="g_oUrgent" unseen="g_oUnseen" saved="g_oSaved" returns="g_nReturnValue" timeout="s_nTimeout"/>
          <results >
            <result name="Default" link="38" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="no messages" link="37" stubbed="0" >g_nUnseen_Count == 0
AND g_nUrgent_Count == 0
AND g_nSaved_Count == 0
AND 'Result'  != 'Timeout'</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Server.logInfo("***FETCHING MAILBOX STATUS***") ;

/* clear out any previous values for message vars */
Session.g_oMessage.strFrom = "" ;
Session.g_oMessage.strDate = "" ;
Session.g_oMessage.strAtt1 = "" ;
Session.g_oMessage.iId = 0 ;

Session.g_nSaved_Count = 0 ;
Session.g_nUnseen_Count = 0 ;	
Session.g_nUrgent_Count = 0 ;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[//Server.logInfo("Urgent Msgs: " + Session.g_nUrgent_Count) ;
//Server.logInfo("Unseen Msgs: " + Session.g_nUnseen_Count) ;
//Server.logInfo("Saved Msgs: " + Session.g_nSaved_Count) ;

]]></script>
          </scripts>
        </action>
        <action id="37" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=334 y=330 ?>
          <!--Main Options Menu - Only Play Personal Options Choice-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigit" terminating-char="" rc="" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;([1-3])&quot;" fdt="50" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >nNewMsgsPrompt</audio>
            <audio type="index" >nNewMsgsDtmf</audio>
            <audio type="index" >nSavedMsgsPrompt</audio>
            <audio type="index" >nSavedMsgsDtmf</audio>
            <audio type="index" >1792</audio>
            <audio type="index" >313</audio>
          </collect-play>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="37" stubbed="1"/>
            <result name="First/Inter Digit Timeout" link="37" stubbed="1"/>
            <result name="1 - listen to new msgs" link="27" stubbed="1" >strDigit match "1"</result>
            <result name="2 - listen to saved msgs" link="27" stubbed="1" >strDigit match "2"</result>
            <result name="3 - personal options" link="35" stubbed="1" >strDigit match "3"</result>
            <result name="Max Retries" link="17" stubbed="1" >nRetryCount == 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Server.logInfo("***PLAYING OPTIONS MENU:  3 FOR PERSONAL OPTIONS***") ;

Session.strDigit = "" ;



]]></script>
            <script language="javascript" timing="last" ><![CDATA[/* Even though we are not playing the option to listen to messages, 
pass the user to the message check with No Messages prompt if they select 1 or 2 */
if ( 1 == Session.strDigit ) {
	Session.g_oMessage.bReadNew = true ;
}
else {
	Session.g_oMessage.bReadNew = false ;
}

if ( 5 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 337 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount++ ;
}
else {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount = 0 ;
}

]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=81 y=351 ?>
          <!--Main Options Menu-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigit" terminating-char="" rc="" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;([1-3])&quot;" fdt="50" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >nNewMsgsPrompt</audio>
            <audio type="index" >nNewMsgsDtmf</audio>
            <audio type="index" >nSavedMsgsPrompt</audio>
            <audio type="index" >nSavedMsgsDtmf</audio>
            <audio type="index" >1792</audio>
            <audio type="index" >313</audio>
          </collect-play>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="38" stubbed="1"/>
            <result name="First/Inter Digit Timeout" link="38" stubbed="1"/>
            <result name="1 - listen to new msgs" link="27" stubbed="1" >strDigit match "1"</result>
            <result name="2 - listen to saved msgs" link="27" stubbed="1" >strDigit match "2"</result>
            <result name="3 - personal options" link="35" stubbed="1" >strDigit match "3"</result>
            <result name="Max Retries" link="17" stubbed="1" >nRetryCount == 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//Server.logInfo("***PLAYING OPTIONS MENU: 1 FOR NEW MSGS, 2 FOR SAVED, 3 FOR PERSONAL OPTIONS***") ;

Session.strDigit = "" ;


if ( 0 == Session.g_nUnseen_Count && 0 == Session.g_nUrgent_Count ) {	
	Session.nNewMsgsPrompt = 99 ;
	Session.nNewMsgsDtmf = 99 ;
}
else {
	Session.nNewMsgsPrompt = 1767 ;
	Session.nNewMsgsDtmf = 311 ;
}

if ( 0 == Session.g_nSaved_Count ) {
	Session.nSavedMsgsPrompt = 99 ;
	Session.nSavedMsgsDtmf = 99 ;
}
else {
	Session.nSavedMsgsPrompt = 1768 ;
	Session.nSavedMsgsDtmf = 312 ;
}




]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 1 == Session.strDigit ) {
	Session.g_oMessage.bReadNew = true ;
}
else {
	Session.g_oMessage.bReadNew = false ;
}

if ( 5 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 337 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount++ ;
}
else {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount = 0 ;
}

]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="PlayGoodbye" start="3" event="PlayGoodbye" returns="void" >
      <actions >
        <action id="3" plug-in="Pactolus.Branch.1" ><?xtml-editor x=61 y=132 ?>
          <results >
            <result name="Default" link="1" stubbed="0"/>
            <result name="System Error" link="4" stubbed="0" >g_bSystemError == true
AND g_nErrorMsgId != 0</result>
          </results>
        </action>
        <action id="1" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=308 y=45 ?>
          <!--Goodbye-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >322</audio>
          </play>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=550 y=193 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_HANGUP_SUB ;]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=311 y=243 ?>
          <!--System Error-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >365</audio>
            <audio type="number" >g_nErrorMsgId</audio>
          </play>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
      </actions>
    </function>
    <function name="ReadMessages" start="47" event="ReadMessages" returns="void" >
      <local-vars >
        <var name="nNextUrgentMsg" type="i4" >0</var>
        <var name="strDigits" type="string" ></var>
        <var name="nReasonCode" type="i4" >0</var>
        <var name="nMsgIntro1" type="i4" >0</var>
        <var name="nNextUnseenMsg" type="i4" >0</var>
        <var name="nNextSavedMsg" type="i4" >0</var>
        <var name="bNoPreviousMsgs" type="boolean" >0</var>
        <var name="nFromLength" type="i4" >0</var>
        <var name="nMsgIntro2" type="i4" >0</var>
        <var name="bCallerID" type="boolean" >0</var>
        <var name="nAM_PM" type="i4" >0</var>
        <var name="nPromptNoMsgs" type="i4" >0</var>
        <var name="bNoMsgAtt" type="boolean" >0</var>
        <var name="nPlayTimeout" type="i4" >0</var>
        <var name="nRetryCount" type="i4" >0</var>
        <var name="nAPIreturn" type="i4" >0</var>
        <var name="nMsgOptionsPrompt" type="i4" >0</var>
        <var name="nMsgOptionsPrompt2" type="i4" >0</var>
        <var name="strOptionsDigitMap" type="string" ></var>
        <var name="nOffset" type="i4" >0</var>
        <var name="nLengthPlayed" type="i4" >0</var>
        <var name="nDayPrompt" type="i4" >0</var>
        <var name="strDigitMap_1" type="string" >([1-6]|*)</var>
        <var name="bIsCallerId" type="boolean" >0</var>
        <var name="strPhoneAnnc" type="string" ></var>
      </local-vars>
      <actions >
        <action id="47" plug-in="Pactolus.Branch.1" ><?xtml-editor x=30 y=32 ?>
          <results >
            <result name="Default" link="1" stubbed="1"/>
            <result name="PLAY_MSG_OPTIONS" link="41" stubbed="0" >g_sSTATE == s_sSTATE_PLAY_MSG_OPTIONS</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if (Session.g_bReturnFromRapidCall) {
	Session.bCallerID = true;
	Session.g_bReturnFromRapidCall = false;
}]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Pactolus.MailboxStatus.1" ><?xtml-editor x=26 y=128 ?>
          <!--Status InBox-->
          <imap-status xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;InBox&quot;" flagged-count="g_nUrgent_Count" unseen-count="g_nUnseen_Count" saved-count="g_nSaved_Count" flagged="g_oUrgent" unseen="g_oUnseen" saved="g_oSaved" returns="g_nReturnValue" timeout="s_nTimeout"/>
          <results >
            <result name="Default" link="15" stubbed="1"/>
            <result name="Success" link="2" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No new messages" link="18" stubbed="1" >g_nUnseen_Count == 0
AND g_nUrgent_Count == 0
AND g_oMessage.bReadNew == true
AND 'Result'  != 'Timeout'</result>
            <result name="No saved messages" link="18" stubbed="1" >g_nSaved_Count == 0
AND g_oMessage.bReadNew == false
AND 'Result'  != 'Timeout'</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***FETCHING MAILBOX STATUS***") ;

/* clear out any previous values for message vars */
Session.g_nSaved_Count = 0 ;
Session.g_nUnseen_Count = 0 ;	
Session.g_nUrgent_Count = 0 ;

Session.g_oSaved.length = 0 ;
Session.g_oUnseen.length = 0 ;
Session.g_oUrgent.length = 0 ;

Session.bNoPreviousMsgs = false ;




]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Urgent count: " +Session.g_nUrgent_Count) ;
Server.logInfo("Unseen count: " +Session.g_nUnseen_Count) ;
Server.logInfo("Saved count: " +Session.g_nSaved_Count) ;


/* Set Message ID for initial Read */

if ( Session.g_oMessage.bReadNew && Session.nNextUrgentMsg < Session.g_nUrgent_Count ) {
	Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg] ;
	Server.logInfo("***Reading Urgent Message***") ;
	} 
else if ( Session.g_oMessage.bReadNew && Session.nNextUnseenMsg < Session.g_nUnseen_Count ) {
	Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg] ;
	Server.logInfo("***Reading Unseen Message***") ;
	}
else if ( false == Session.g_oMessage.bReadNew && Session.nNextSavedMsg < Session.g_nSaved_Count ) {
	Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;
	Server.logInfo("***Reading Saved Message***") ;
}

if ( 0 == Session.g_nSaved_Count && !Session.g_oMessage.bReadNew ) {
	Session.nPromptNoMsgs = 1832 ;
}
else if ( 0 == Session.g_nUnseen_Count && 0 == Session.g_nUrgent_Count ) {
	Session.nPromptNoMsgs = 1796 ;
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Pactolus.ReadMail.1" ><?xtml-editor x=260 y=153 ?>
          <imap-read xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;InBox&quot;" msg-uid="g_oMessage.iId" to="g_oMessage.strTo" from="g_oMessage.strFrom" cc="" subject="g_oMessage.strSubject" body="" attachment1="g_oMessage.strAtt1" attachment2="" attachment3="" timeout="s_nTimeout" returns="g_nReturnValue" timestamp="g_oMessage.strDate"/>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="Success" link="42" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oMessage.strTo = "" ;
Session.g_oMessage.strFrom = "" ;
Session.g_oMessage.strDate = "" ;
Session.g_oMessage.strAtt1 = "" ;

Session.g_sSTATE = Session.s_sSTATE_GET_MSGS ;

/* Set flag to check for MWI send at end of Session */
Session.g_bReadMsgs = true ;

Session.nOffset = 0;





	
	
	]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Message_To: " +Session.g_oMessage.strTo) ;
Server.logInfo("Message_From: " +Session.g_oMessage.strFrom) ;
Server.logInfo("Message_Date: " +Session.g_oMessage.strDate) ;
Server.logInfo("Message_Att1: " +Session.g_oMessage.strAtt1) ;


]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=713 y=24 ?>
          <!--Message introduction w/ Caller ID-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="strDigitMap_1" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >nMsgIntro1</audio>
            <audio type="index" >nMsgIntro2</audio>
            <audio type="index" >1779</audio>
            <audio type="date" >g_oMessage.strDateAnnc</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
            <audio type="index" >1781</audio>
            <audio type="digits" >strPhoneAnnc</audio>
          </collect-play>
          <results >
            <result name="Default" link="39" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Play Message" link="39" stubbed="1" >strDigits match "1"</result>
            <result name="2 - Save Message" link="37" stubbed="1" >strDigits match "2"</result>
            <result name="3 - Delete Message" link="24" stubbed="1" >strDigits match "3"</result>
            <result name="4 - Hear Message Options" link="41" stubbed="1" >strDigits match "4"</result>
            <result name="5 - Previous Message" link="27" stubbed="1" >strDigits match "5"</result>
            <result name="6 - Next Message" link="9" stubbed="1" >strDigits match "6"</result>
            <result name="* - Previous Menu" link="34" stubbed="1" >strDigits match "*"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***INTRODUCING MSG WITH CALLER ID***") ;

Session.strDigits = "" ;
Session.g_strTermDigit = "" ;







]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1683 y=887 ?>
          <!--Message Skipped-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="" fdt="0" idt="40" ict="160" terminating-digit="" >
            <audio type="index" >1808</audio>
          </collect-play>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***MESSAGE SKIPPED***") ;]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=718 y=316 ?>
          <!--Message introduction w/o Caller ID-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="strDigitMap_1" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >nMsgIntro1</audio>
            <audio type="index" >nMsgIntro2</audio>
            <audio type="index" >1779</audio>
            <audio type="date" >g_oMessage.strDateAnnc</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
          </collect-play>
          <results >
            <result name="Default" link="39" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Play Messsage" link="39" stubbed="1" >strDigits match "1"</result>
            <result name="2 - Save Message" link="37" stubbed="1" >strDigits match "2"</result>
            <result name="3 - Delete Message" link="24" stubbed="1" >strDigits match "3"</result>
            <result name="4 - Hear Message Options" link="41" stubbed="1" >strDigits match "4"</result>
            <result name="5 - Previous Message" link="27" stubbed="1" >strDigits match "5"</result>
            <result name="6 - Next Message" link="9" stubbed="1" >strDigits match "6"</result>
            <result name="* - Previous Menu" >strDigits match "*"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***INTRODUCING MSG WITHOUT CALLER ID***") ;

Session.strDigits = "" ;
Session.g_strTermDigit = "" ;





]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.Branch.1" ><?xtml-editor x=532 y=181 ?>
          <results >
            <result name="Default" link="12" stubbed="1"/>
            <result name="bCallerID == true, not recent" link="4" stubbed="1" >bCallerID == true
AND nDayPrompt == 0</result>
            <result name="bCallerID == true, recent" link="50" stubbed="1" >bCallerID == true
AND nDayPrompt != 0</result>
            <result name="bCallerID == false, not recent" link="12" stubbed="1" >bCallerID == false
AND nDayPrompt == 0</result>
            <result name="bCallerID == false, recent" link="51" stubbed="1" >bCallerID == false
AND nDayPrompt != 0</result>
            <result name="bNoMsgAtt == true" link="20" stubbed="1" >bNoMsgAtt == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[/* determine if caller id can be announced */
//"Display Name " <6172221001@10.10.100.126>
var i = Session.g_oMessage.strFrom.toString().indexOf("\"");
var j = Session.g_oMessage.strFrom.toString().lastIndexOf("\"");
var displayName = Session.g_oMessage.strFrom.toString().substring(i+1, j);
Server.logInfo("Display Name: " + displayName);

var k = Session.g_oMessage.strFrom.toString().indexOf("<");
var l = Session.g_oMessage.strFrom.toString().lastIndexOf("@");
var phoneNumber = Session.g_oMessage.strFromAnnc = Session.g_oMessage.strFrom.toString().substring(k+1, l);
Session.strPhoneAnnc = js_strip_non_digits(phoneNumber);//Remove a '+' etc. if present to allow playback
Server.logInfo("Phone Number: " + phoneNumber);

Session.bCallerID = false ;

if ( 0 == Session.g_oMessage.strFrom.length ) {
	Session.bCallerID = false ;
}
else if ( undefined != displayName ) {
	var name = displayName.toLowerCase() ;

	if( -1 != name.indexOf( "anonymous" ) ) {
  		Session.bCallerID = false ;
	}
  	else if ( -1 != name.indexOf( "restricted" ) ) {
	  	Session.bCallerID = false ;
	}
	else if ( -1 != name.indexOf( "blocked" ) ) {
	  	Session.bCallerID = false ;
	}
  	else if ( "undefined" != phoneNumber && "Restricted" != phoneNumber && undefined != phoneNumber ) {
  		Session.bCallerID = true ;
  	}
}
else if ( "undefined" == phoneNumber || undefined == phoneNumber || 0 == phoneNumber.length ) {
  	Session.bCallerID = false ;
}
else {
	Session.bCallerID = true ;
}


/* If message has no attachment to play, skip to the next one. */
Session.bNoMsgAtt = false ;

if ( 0 == Session.g_oMessage.strAtt1.length ) {
	Session.bNoMsgAtt = true ;
}


]]></script>
            <script language="javascript" timing="middle" ><![CDATA[/* define intro prompts to play 
1773 = "Next..."; 1774 = "First...";  1807 = "Previous message" ;
1775 = "...new message"; 1778 = "...saved message"; 1803 = "...new urgent message"; 1804 = "...saved urgent message; 1806 = "...marked urgent" 
*/

//Server.logInfo("Urgent_0 = " + Session.g_oUrgent[0] ) ;
//Server.logInfo("Unseen_0 = " + Session.g_oUnseen[0] ) ;
//Server.logInfo("Saved_0 = " + Session.g_oSaved[0] ) ;
//Server.logInfo("Message_ID = " + Session.g_oMessage.iId ) ;

/* Assign placement value */
if ( "5" == Session.strDigits ) { //Reading Previous Message
	Session.nMsgIntro1 = 1807 ;
}
else if  ( Session.g_oMessage.iId == Session.g_oUrgent[0] ) {
	Session.nMsgIntro1 = 1774 ;
}
else if ( Session.g_oMessage.iId == Session.g_oUnseen[0] ) {
	if ( Session.g_nUrgent_Count != 0 ) {
		Session.nMsgIntro1 = 1773 ;
	}
	else {
		Session.nMsgIntro1 = 1774 ;
	}
}
else if ( Session.g_oMessage.iId == Session.g_oSaved[0] ) {
	Session.nMsgIntro1 = 1774 ;
}
else {
	Session.nMsgIntro1 = 1773 ;
}

/* Assign new/urgent/saved value */		
if ( "5" == Session.strDigits ) { //Reading Previous message
	if ( -1 != Session.g_oMessage.strSubject.toString().indexOf("URGENT") ) {
		Session.nMsgIntro2 = 1806 ;
	}
	else {
		Session.nMsgIntro2 = 99 ;
	}
}
else if ( Session.g_oMessage.iId == Session.g_oUrgent[Session.nNextUrgentMsg] ) {
	Session.nMsgIntro2 = 1803 ;
}
else if ( Session.g_oMessage.iId == Session.g_oUnseen[Session.nNextUnseenMsg] ) {
	Session.nMsgIntro2 = 1775 ;
}
else if ( Session.g_oMessage.iId == Session.g_oSaved[Session.nNextSavedMsg] && -1 != Session.g_oMessage.strSubject.toString().indexOf("URGENT") ){
	Session.nMsgIntro2 = 1804 ;
}
else {
	Session.nMsgIntro2 = 1778 ;
}
	

/* set Date and time vars */
var MsgDate ;
var recv ;
var today = new Date() ;

if ( Session.g_oAPI.strLocalDate.length > 0 ) {
	MsgDate = Session.g_oAPI.strLocalDate ;
	recv = new Date(MsgDate) ;
}
else {
	recv = new Date() ;
	Server.logError("Local Date returned empty. Using current time.") ;
}

/* Check if message was received today or yesterday. Otherwise parse date as MMDD */
Session.nDayPrompt = 0 ;
if ( today.getDate() == recv.getDate() && today.getMonth() == recv.getMonth() && today.getFullYear() == recv.getFullYear() ) {
	Session.nDayPrompt = "1851" ; //today   
	Server.logInfo("Message received Today") ;
}
else if ( (today.getDate() - 1) == recv.getDate() && today.getMonth() == recv.getMonth() && today.getFullYear() == recv.getFullYear() ) {
	Session.nDayPrompt = "1850" ; //yesterday  
	Server.logInfo("Message received Yesterday") ;
}
else { 
	var month = (recv.getMonth() + 1) + "" ;
	if ( 10 > month ) {
		Session.g_oMessage.strDateAnnc = 0 + month ;
	}
	else {
		Session.g_oMessage.strDateAnnc = month ;
	}
			
	var day_no =  recv.getDate() + "" ;
	if ( 10 > day_no ) {
		Session.g_oMessage.strDateAnnc += 0 + day_no ;
	}
	else {
		Session.g_oMessage.strDateAnnc += day_no ;
	}	

	Server.logInfo("Date to announce: " +Session.g_oMessage.strDateAnnc) ;
}

/* Parse time */	
var hours = recv.getHours() ;

( hours + "" ) ;
	
if ( 10 > hours ) {
	Session.g_oMessage.strTime = 0 + hours ;
}
else {
	Session.g_oMessage.strTime = hours ;	
}

var minutes = recv.getMinutes() + "" ;
if ( 10 > minutes ) {
	Session.g_oMessage.strTime += 0 +  minutes ;
}
else {
	Session.g_oMessage.strTime += minutes ;
}

Server.logInfo("Time: " +Session.g_oMessage.strTime) ;]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_HEADER ;

]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=62 y=307 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Ending Session after state: " +Session.g_sSTATE ) ;

]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_BYE ;

Session.g_bSystemError = true ;]]></script>
          </scripts>
        </action>
        <action id="17" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=450 y=474 ?>
          <!--Return to Main Menu - Options-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS ;]]></script>
          </scripts>
        </action>
        <action id="18" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=271 y=324 ?>
          <!--No messages-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >nPromptNoMsgs</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="bNoPreviousMsgs == true" link="40" stubbed="1" >bNoPreviousMsgs == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***NO MESSAGES***") ;


]]></script>
          </scripts>
        </action>
        <action id="20" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1930 y=1014 ?>
          <!--Verify there are more messages to read-->
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="all messages read" link="18" stubbed="1" >nNextSavedMsg == -1
AND nNextUnseenMsg == -1
AND nNextUrgentMsg == -1</result>
            <result name="All saved messages read" link="18" stubbed="0" >g_oMessage.bReadNew == false
AND nNextSavedMsg == -1</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Current Urgent Msg: " + Session.nNextUrgentMsg + ", ID: " + Session.g_oUrgent[Session.nNextUrgentMsg]) ;
Server.logInfo("Current Unseen Msg: " + Session.nNextUnseenMsg + ", ID: " + Session.g_oUnseen[Session.nNextUnseenMsg]) ;
Server.logInfo("Current Saved Msg: " + Session.nNextSavedMsg + ", ID: " + Session.g_oSaved[Session.nNextSavedMsg]) ;
Server.logInfo("Current Message ID: " + Session.g_oMessage.iId) ;

/* Set empty message groups to -1 */

if ( 0 == Session.g_nUrgent_Count ) {
	Session.nNextUrgentMsg = -1 ;
}
if ( 0 == Session.g_nUnseen_Count ) {
	Session.nNextUnseenMsg = -1 ;
}
if ( 0 == Session.g_nSaved_Count ) {
	Session.nNextSavedMsg = -1 ;
}

/* Determine next message to play */

if ( Session.g_oMessage.iId == Session.g_oUrgent[Session.nNextUrgentMsg] ) {
	if ( (Session.nNextUrgentMsg + 1) == Session.g_nUrgent_Count ) { //check if we are at the end of the current queue
		Session.nNextUrgentMsg = -1 ; //if so, set to -1 and check the next groups.
		if ( 0 != Session.g_nUnseen_Count ) {
			var i = find_next_message(0, Session.g_oUnseen);
			if ( 0 <= i ) {
				Session.nNextUnseenMsg = i;
				Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg] ;
				Server.logInfo("Finished Reading Urgent. Start Unseen: " + Session.g_oMessage.iId)
			}
		}
		if ( -1 == Session.nNextUnseenMsg && 0!= Session.g_nSaved_Count ) {
			var i = find_next_message(0, Session.g_oSaved);
			if ( 0 <= i ) {
				Session.nNextSavedMsg = i;
				Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;
				Server.logInfo("Finished Reading Urgent, No Unseen. Start Saved: " + Session.g_oMessage.iId)
			}
		}
	}
	else if ( -1 != Session.nNextUrgentMsg ) {
		var nextUrgent = Session.nNextUrgentMsg + 1;
		var i = find_next_message(nextUrgent, Session.g_oUrgent);
		if ( 0 <= i ) {
			Session.nNextUrgentMsg = i;
			Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg] ;
			Server.logInfo("Reading Next Urgent Message: " + Session.g_oMessage.iId) ;
		}
		else { //if unable to find valid next message in Urgent queue, check Unseen then Saved.
			if ( 0 != Session.g_nUnseen_Count ) {
				var i = find_next_message(0, Session.g_oUnseen);
				if ( 0 <= i ) {
					Session.nNextUnseenMsg = i;
					Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg] ;
					Server.logInfo("Finished Reading Urgent. Start Unseen: " + Session.g_oMessage.iId)
				}
			}
			if ( -1 == Session.nNextUnseenMsg && 0!= Session.g_nSaved_Count ) {
				var i = find_next_message(0, Session.g_oSaved);
				if ( 0 <= i ) {
					Session.nNextSavedMsg = i;
					Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;
					Server.logInfo("Finished Reading Urgent, No Unseen. Start Saved: " + Session.g_oMessage.iId)
				}
			}
		}
	}
}

else if ( Session.g_oMessage.iId == Session.g_oUnseen[Session.nNextUnseenMsg] ) {
	if ( (Session.nNextUnseenMsg + 1) == Session.g_nUnseen_Count ) {
		Session.nNextUnseenMsg = -1 ;

		//find next valid Saved message
		if ( 0 < Session.g_nSaved_Count ) {
			var i = find_next_message(0, Session.g_oSaved);
			if ( 0 <= i ) {
				Session.nNextSavedMsg = i;
				Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;
				Server.logInfo("Finished reading Unseen. Start Saved: " + Session.g_oMessage.iId) ;
			}
		}
	}
	else if ( -1 != Session.nNextUnseenMsg ) {
		var nextUnseen = Session.nNextUnseenMsg + 1;
		var i = find_next_message(nextUnseen, Session.g_oUnseen);
		if ( 0 <= i ) {
			Session.nNextUnseenMsg = i;
			Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg];
			Server.logInfo("Reading next valid new message: " + Session.g_oMessage.iId);
		}
		else if ( 0 < Session.g_nSaved_Count ) {
			var i = find_next_message(0, Session.g_oSaved);
			if ( 0 <= i ) {	
				Session.nNextSavedMsg = i;
				Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;
				Server.logInfo("Finished reading Unseen. Start Saved: " + Session.g_oMessage.iId) ;
			}
		}
	}
}

else if ( Session.g_oMessage.iId == Session.g_oSaved[Session.nNextSavedMsg] ) {
	if ( (Session.nNextSavedMsg + 1) == Session.g_nSaved_Count ) {
		Session.nNextSavedMsg = -1 ;
		Server.logInfo("All Saved messages have been read") ;
	}
	else if ( -1 != Session.nNextSavedMsg ) {
		var nextSaved = Session.nNextSavedMsg + 1;
		var i = find_next_message(nextSaved, Session.g_oSaved);
		if ( 0 <= i ) {
			Session.nNextSavedMsg = i;
			Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg];
			Server.logInfo("Reding next valid saved message: " + Session.nNextSavedMsg);
		}
		
	}
}
	

/* In case the user has attempted to listen to previous msgs, reset this, 
 so as not to hit the no previous message path in the No Messages anncmnt. */
Session.bNoPreviousMsgs = false ; ]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Next Urgent Msg: " + Session.nNextUrgentMsg) ;
Server.logInfo("Next Unseen Msg: " + Session.nNextUnseenMsg) ;
Server.logInfo("Next Saved Msg: " + Session.nNextSavedMsg) ;

Session.nPromptNoMsgs = 1809 ;]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Pactolus.UpdateMail.1" ><?xtml-editor x=1684 y=288 ?>
          <imap-update xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;InBox&quot;" msg-uid="g_oMessage.iId" flag="&quot;delete&quot;" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="30" stubbed="0"/>
            <result name="Success" link="25" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***SENDING DELETE MSG TO IMAP SERVER***") ;

]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1936 y=271 ?>
          <!--Message Deleted-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="silence" >.5</audio>
            <audio type="index" >1770</audio>
          </play>
          <results >
            <result name="Default" link="20" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAY MSG DELETED PROMPT***") ;
Server.logInfo("Set Message id: " + Session.g_oMessage.iId + " to deleted") ;

if ( Session.g_oMessage.iId == Session.g_oUrgent[Session.nNextUrgentMsg]) {
	Session.g_oUrgent[Session.nNextUrgentMsg] = "deleted" ;
	Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg] ;
}
else if ( Session.g_oMessage.iId == Session.g_oUnseen[Session.nNextUnseenMsg]) {
	Session.g_oUnseen[Session.nNextUnseenMsg] = "deleted" ;
	Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg] ;
}
else if ( Session.g_oMessage.iId == Session.g_oSaved[Session.nNextSavedMsg]) {
	Session.g_oSaved[Session.nNextSavedMsg] = "deleted" ;
	Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;	
}
else {
	Server.logError("No message ids match the Deleted message!") ;
}


]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1686 y=774 ?>
          <!--Determine previous msg ID-->
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="No previous msgs" link="18" stubbed="0" >bNoPreviousMsgs == true</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.bNoPreviousMsgs = false ;

Server.logInfo("Current Urgent Msg: " + Session.nNextUrgentMsg) ;
Server.logInfo("Current Unseen Msg: " + Session.nNextUnseenMsg) ;
Server.logInfo("Current Saved Msg: " + Session.nNextSavedMsg) ;
Server.logInfo("Current Message ID: " + Session.g_oMessage.iId) ;

//when all messages in a group have been read, the iNext value is set to -1. 

if ( 0 < Session.nNextUrgentMsg && Session.g_oMessage.bReadNew ) {
	var lastUrgent = Session.nNextUrgentMsg - 1;
	var i = find_previous_message(lastUrgent, Session.g_oUrgent) ;
	if ( 0 <= i ) {
		Session.nNextUrgentMsg = i; 
		Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg] ;
		Server.logInfo("PREVIOUS MSG: decrement Urgent Msg");
		Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
	}
	else {
		Session.bNoPreviousMsgs = true ;
	}
}
else if ( Session.g_oMessage.iId == Session.g_oUrgent[Session.nNextUrgentMsg] && 0 == Session.nNextUrgentMsg ) {
	Session.bNoPreviousMsgs = true ;
}

else if ( 0 < Session.nNextUnseenMsg && Session.g_oMessage.bReadNew ) {
	var lastUnseen = Session.nNextUnseenMsg - 1;
	var i = find_previous_message(lastUnseen, Session.g_oUnseen) ;
	if ( 0 <= i ) {
		Session.nNextUnseenMsg = i; 
		Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg] ;
		Server.logInfo("PREVIOUS MSG: decrement Unseen Msg");
		Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
	}
	else if ( 0 != Session.g_nUrgent_Count ) { //if no valid previous msg in current queue, try previous queue
		var lastUrgent = Session.g_nUrgent_Count - 1;
		var i = find_previous_message(lastUrgent, Session.g_oUrgent) ;
		if ( 0 <= i ) {
			Session.nNextUrgentMsg = i; 
			Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg] ;
			Server.logInfo("PREVIOUS MSG: Play last Urgent, after Unseen") ;
			Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
		}
		else {
			Session.bNoPreviousMsgs = true;
		}
	}
	else {
		Session.bNoPreviousMsgs = true ;
	}
}
else if ( 0 == Session.nNextUnseenMsg && Session.g_oMessage.bReadNew ) {
	if ( 0 != Session.g_nUrgent_Count ) {
		var lastUrgent = Session.g_nUrgent_Count - 1;
		var i = find_previous_message(lastUrgent, Session.g_oUrgent) ;
		if ( 0 <= i ) {
			Session.nNextUrgentMsg = i; 
			Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg] ;
			Server.logInfo("PREVIOUS MSG: Play last Urgent, after Unseen") ;
			Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
		}
		else {
			Session.bNoPreviousMsgs = true ;
		}
 	}
	else {
		Session.bNoPreviousMsgs = true ;
	}
}

else if ( 0 < Session.nNextSavedMsg ) {
	var lastSaved = Session.nNextSavedMsg - 1;
	var i = find_previous_message(lastSaved, Session.g_oSaved) ;
	if ( 0 <= i ) {
		Session.nNextSavedMsg = i; 		
		Session.g_oMessage.iId = Session.g_oSaved[Session.nNextSavedMsg] ;
		Server.logInfo("PREVIOUS MSG: decrement Saved Msgs") ;
		Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
	}
	else if ( Session.g_oMessage.bReadNew ) {
		if ( 0 < Session.g_nUnseen_Count ) {
			var lastUnseen = Session.g_nUnseen_Count - 1;
			var i = find_previous_message(lastUnseen, Session.g_oUnseen);
			if ( 0 <= i ) {
				Session.nNextUnseenMsg = i;
				Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg];
				Server.logInfo("PREVIOUS MSG: Play last Unseen, after Saved") ;
				Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
			}	
		}
		if ( 0 < Session.g_nUrgent_Count && -1 == Session.nNextUnseenMsg ) {
			var lastUrgent = Session.g_nUrgent_Count - 1;
			var i = find_previous_message(lastUrgent, Session.g_oUrgent);
			if ( 0 <= i ) {
				Session.nNextUrgentMsg = i;
				Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg];
				Server.logInfo("PREVIOUS MSG: Play last Urgent, after Saved");
				Server.logInfo("Previous message: " + Session.g_oMessage.iId);
			}
		}	
		if ( -1 == Session.nNextUnseenMsg && -1 == Session.nNextUrgentMsg ) {
			Session.bNoPreviousMsgs = true;
		}
	}
	else {
		Session.bNoPreviousMsgs = true;
	}
}
else if ( 0 == Session.nNextSavedMsg ) { //we are already at the beginning of the queue, check previous groups.
	if ( Session.g_oMessage.bReadNew ) { 
		if ( 0 < Session.g_nUnseen_Count ) {
			var lastUnseen = Session.g_nUnseen_Count - 1;
			var i = find_previous_message(lastUnseen, Session.g_oUnseen);
			if ( 0 <= i ) {
				Session.nNextUnseenMsg = i;
				Session.g_oMessage.iId = Session.g_oUnseen[Session.nNextUnseenMsg];
				Server.logInfo("PREVIOUS MSG: Play last Unseen, after Saved") ;
				Server.logInfo("Previous message: " + Session.g_oMessage.iId ) ;
			}	
		}
		if ( 0 < Session.g_nUrgent_Count && -1 == Session.nNextUnseenMsg ) {
			var lastUrgent = Session.g_nUrgent_Count - 1;
			var i = find_previous_message(lastUrgent, Session.g_oUrgent);
			if ( 0 <= i ) {
				Session.nNextUrgentMsg = i;
				Session.g_oMessage.iId = Session.g_oUrgent[Session.nNextUrgentMsg];
				Server.logInfo("PREVIOUS MSG: Play last Urgent, after Saved");
				Server.logInfo("Previous message: " + Session.g_oMessage.iId);
			}
		}
		if ( -1 == Session.nNextUnseenMsg && -1 == Session.nNextUrgentMsg ) {
			Session.bNoPreviousMsgs = true;
		}
	}
	else {
		Session.bNoPreviousMsgs = true;
	}
}

//catch all	
else {
	Session.bNoPreviousMsgs = true ;
}
	

	

	

	]]></script>
            <script language="javascript" timing="last" ><![CDATA[Session.nPromptNoMsgs = 1827 ;]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1936 y=410 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError( "Ending session after state: " + Session.g_sSTATE ) ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_BYE ;

Session.g_bSystemError = true ;]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1934 y=621 ?>
          <!--Play message envelope w/ Caller ID-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1779</audio>
            <audio type="date" >g_oMessage.strDateAnnc</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
            <audio type="index" >nAM_PM</audio>
            <audio type="index" >1781</audio>
            <audio type="digits" >strPhoneAnnc</audio>
          </play>
          <results >
            <result name="Default" link="41" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING MESSAGE HEADER***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_HEADER ;]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1937 y=142 ?>
          <!--Message Saved for...-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1772</audio>
            <audio type="number" >g_nMsgSaveFor</audio>
            <audio type="index" >1812</audio>
          </play>
          <results >
            <result name="Default" link="20" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="34" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1458 y=516 ?>
          <!--Go to Play Options-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS ;]]></script>
          </scripts>
        </action>
        <action id="35" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1929 y=469 ?>
          <!--Play message envelope w/o Caller ID-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1779</audio>
            <audio type="date" >g_oMessage.strDateAnnc</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
            <audio type="index" >nAM_PM</audio>
          </play>
          <results >
            <result name="Default" link="41" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING MESSAGE HEADER***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_HEADER ;]]></script>
          </scripts>
        </action>
        <action id="36" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1939 y=6 ?>
          <!--Message Saved-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1801</audio>
          </play>
          <results >
            <result name="Default" link="20" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="37" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1676 y=129 ?>
          <results >
            <result name="Default" link="36" stubbed="1"/>
            <result name="iMsgSaveFor &gt; 0" link="33" stubbed="1" >g_nMsgSaveFor &gt; 0</result>
          </results>
        </action>
        <action id="39" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1175 y=185 ?>
          <!--Play Message-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="nPlayTimeout" ms-type="g_oMS.strType" played-length="nLengthPlayed" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="nOffset" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="g_strDigitMap_2" fdt="40" idt="40" ict="16" terminating-digit="" >
            <audio type="url" >g_oMessage.strAtt1</audio>
          </collect-play>
          <results >
            <result name="Default" link="40" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Replay" link="39" stubbed="1" >strDigits match "1"</result>
            <result name="2 - Save Message" link="37" stubbed="1" >strDigits match "2"</result>
            <result name="3 - Delete Message" link="24" stubbed="1" >strDigits match "3"</result>
            <result name="4 - Hear Message Options" link="41" stubbed="1" >strDigits match "4"</result>
            <result name="5 - Previous Message" link="27" stubbed="1" >strDigits match "5"</result>
            <result name="6 - Next Message" link="9" stubbed="1" >strDigits match "6"</result>
            <result name="7 - Skip Back" link="49" stubbed="1" >strDigits match "7"</result>
            <result name="9 - Skip Ahead" link="49" stubbed="1" >strDigits match "9"</result>
            <result name="* - Previous Menu" link="34" stubbed="1" >strDigits match "*"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING MESSAGE***") ;
Session.g_sSTATE = Session.s_sSTATE_READ_MSG ;

Session.strDigits = "" ;
Session.g_strTermDigit = "" ;

Session.nPlayTimeout = 240 ;







]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( "1" == Session.strDigits ) {
	Session.nOffset = 0 ;
}]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1393 y=194 ?>
          <!--Play Message Menu-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="40" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="strDigitMap_1" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >1782</audio>
            <audio type="index" >311</audio>
            <audio type="index" >1771</audio>
            <audio type="index" >312</audio>
            <audio type="index" >1769</audio>
            <audio type="index" >313</audio>
            <audio type="index" >1786</audio>
            <audio type="index" >314</audio>
            <audio type="index" >1785</audio>
            <audio type="index" >315</audio>
            <audio type="index" >1835</audio>
            <audio type="index" >316</audio>
            <audio type="index" >1787</audio>
            <audio type="index" >320</audio>
          </collect-play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="40" stubbed="1"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Replay" link="39" stubbed="1" >strDigits match "1"</result>
            <result name="2 - Save Message" link="37" stubbed="1" >strDigits match "2"</result>
            <result name="3 - Delete Message" link="24" stubbed="1" >strDigits match "3"</result>
            <result name="4 - Hear Message Options" link="41" stubbed="1" >strDigits match "4"</result>
            <result name="5 - Previous Message" link="27" stubbed="1" >strDigits match "5"</result>
            <result name="6 - Next Message" link="20" stubbed="1" >strDigits match "6"</result>
            <result name="* - Previous Menu" link="34" stubbed="1" >strDigits match "*"</result>
            <result name="Max Retries" link="34" stubbed="1" >nRetryCount == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING MESSAGE MENU***") ;

Session.strDigits = "" ;

Session.nOffset = 0 ;






]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 337 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount++ ;
}
else {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount = 0 ;
}

if ( "3" == Session.strDigits ) {
	Session.g_sSTATE = Session.s_sSTATE_DELETE_MSG ;
}
]]></script>
          </scripts>
        </action>
        <action id="41" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1686 y=469 ?>
          <!--Play Msg Options Menu
-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="40" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="strOptionsDigitMap" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >1783</audio>
            <audio type="index" >311</audio>
            <audio type="index" >nMsgOptionsPrompt</audio>
            <audio type="index" >nMsgOptionsPrompt2</audio>
            <audio type="index" >1787</audio>
            <audio type="index" >320</audio>
          </collect-play>
          <results >
            <result name="Default" link="40" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="41" stubbed="1"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - w/o Call ID, recent" link="52" stubbed="1" >strDigits match "1"
AND bCallerID == false
AND nDayPrompt != 0</result>
            <result name="1 - w/o Call ID, not recent" link="35" stubbed="1" >strDigits match "1"
AND bCallerID == false
AND nDayPrompt == 0</result>
            <result name="1 - w/ Call ID, recent" link="53" stubbed="1" >strDigits match "1"
AND bCallerID == true
AND nDayPrompt != 0</result>
            <result name="1 - w/ Call ID, not recent" link="32" stubbed="1" >strDigits match "1"
AND bCallerID == true
AND nDayPrompt == 0</result>
            <result name="2 - Return Call" link="58" stubbed="0" >strDigits match "2"
AND g_oAPI.strCallReturnFlag == "T"</result>
            <result name="* - Previous Menu" link="40" stubbed="1" >strDigits match "*"</result>
            <result name="max retries" link="40" stubbed="1" >nRetryCount == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAY MESSAGE OPTIONS: 1 FOR HEADER INFO, 2 FOR CALL RETURN***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_OPTIONS ;

Session.strDigits = "" ;

if ( "T" == Session.g_oAPI.strCallReturnFlag ) {
	Session.nMsgOptionsPrompt = 1821 ;
	Session.nMsgOptionsPrompt2 = 312 ;
	Session.strOptionsDigitMap = "([1-2]|*)" ;
}
else {
	Session.nMsgOptionsPrompt = 99 ;
	Session.nMsgOptionsPrompt2 = 99 ;
	Session.strOptionsDigitMap = "([1]|*)" ;
}
	







]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 337 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount++ ;
}
else {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount = 0 ;
}

]]></script>
          </scripts>
        </action>
        <action id="42" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=452 y=27 ?>
          <!--convertGMTTimestamp-->
          <java xmlns="urn:www.pactolus.com:xtml:application" class="&quot;com.pactolus.psAPISceMisc&quot;" method="&quot;convertGMTTimestamp&quot;" timeout="s_nTimeout" return="g_nReturnValue" method-return-var="nAPIreturn" method-return-type="0" >
            <parameter type="in" var-type="string" >g_oAPI.strPlatformSessionId</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strProcDBName</parameter>
            <parameter type="in" var-type="string" >g_oMessage.strDate</parameter>
            <parameter type="in" var-type="i4" >g_oAPI.nTimezoneId</parameter>
            <parameter type="inout" var-type="string" >g_oAPI.strLocalDate</parameter>
          </java>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Local date returned from API: " + Session.g_oAPI.strLocalDate) ;]]></script>
          </scripts>
        </action>
        <action id="44" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1938 y=849 ?>
          <results >
            <result name="Default" link="45" stubbed="0"/>
            <result name="bCallerId == true" link="46" stubbed="0" >bCallerID == true</result>
          </results>
        </action>
        <action id="45" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2194 y=781 ?>
          <!--Call cannot be completed - No Caller ID-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1837</audio>
          </play>
          <results >
            <result name="Default" link="41" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***CANNOT RETURN CALL: NO CALLER ID***");]]></script>
          </scripts>
        </action>
        <action id="46" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2201 y=964 ?>
          <!--Press the * key to hang up the call and return to voicemail.-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >517</audio>
            <audio type="index" >1838</audio>
            <audio type="index" >359</audio>
          </play>
          <results >
            <result name="Default" link="48" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="48" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=2404 y=1046 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_RETURN_CALL ;
Session.g_bReturnFromRapidCall = true;]]></script>
          </scripts>
        </action>
        <action id="49" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1202 y=534 ?>
          <!--Set offset-->
          <results >
            <result name="Default" link="39" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//skip ahead or back 5 seconds
//Session.nOffset initialized in Read Mail PAC
Server.logInfo("Adjusting Play Offset. Already played <" + Session.nLengthPlayed + ">");
if ( "7" == Session.strDigits ) {
	if((Session.nOffset + Session.nLengthPlayed) > 50) {
		Session.nOffset = Session.nOffset + Session.nLengthPlayed - 50;
	}
	else {
		Session.nOffset = 0; 
	}
}

if ( "9" == Session.strDigits ) {
	Session.nOffset = Session.nOffset + Session.nLengthPlayed + 50 ;
}

Server.logInfo("Offset = " + Session.nOffset) ;
	
]]></script>
          </scripts>
        </action>
        <action id="50" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=930 y=19 ?>
          <!--Message introduction w/ Caller ID, Message recvd yesterday or today-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="strDigitMap_1" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >nMsgIntro1</audio>
            <audio type="index" >nMsgIntro2</audio>
            <audio type="index" >1849</audio>
            <audio type="index" >nDayPrompt</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
            <audio type="index" >1781</audio>
            <audio type="digits" >strPhoneAnnc</audio>
          </collect-play>
          <results >
            <result name="Default" link="39" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Play Message" link="39" stubbed="1" >strDigits match "1"</result>
            <result name="2 - Save Message" link="37" stubbed="1" >strDigits match "2"</result>
            <result name="3 - Delete Message" link="24" stubbed="1" >strDigits match "3"</result>
            <result name="4 - Hear Message Options" link="41" stubbed="1" >strDigits match "4"</result>
            <result name="5 - Previous Message" link="27" stubbed="1" >strDigits match "5"</result>
            <result name="6 - Next Message" link="9" stubbed="1" >strDigits match "6"</result>
            <result name="* - Previous Menu" link="34" stubbed="1" >strDigits match "*"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***INTRODUCING MSG WITH CALLER ID***") ;

Session.strDigits = "" ;
Session.g_strTermDigit = "" ;







]]></script>
          </scripts>
        </action>
        <action id="51" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=930 y=325 ?>
          <!--Message introduction w/o Caller ID, Message recvd yesterday or today-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="strDigitMap_1" fdt="20" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >nMsgIntro1</audio>
            <audio type="index" >nMsgIntro2</audio>
            <audio type="index" >1849</audio>
            <audio type="index" >nDayPrompt</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
          </collect-play>
          <results >
            <result name="Default" link="39" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Play Messsage" link="39" stubbed="1" >strDigits match "1"</result>
            <result name="2 - Save Message" link="37" stubbed="1" >strDigits match "2"</result>
            <result name="3 - Delete Message" link="24" stubbed="1" >strDigits match "3"</result>
            <result name="4 - Hear Message Options" link="41" stubbed="1" >strDigits match "4"</result>
            <result name="5 - Previous Message" link="27" stubbed="1" >strDigits match "5"</result>
            <result name="6 - Next Message" link="9" stubbed="1" >strDigits match "6"</result>
            <result name="* - Previous Menu" link="34" stubbed="1" >strDigits match "*"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***INTRODUCING MSG WITHOUT CALLER ID***") ;

Session.strDigits = "" ;
Session.g_strTermDigit = "" ;





]]></script>
          </scripts>
        </action>
        <action id="52" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2155 y=436 ?>
          <!--Play message envelope w/o Caller ID, recvd yesterday or today-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1849</audio>
            <audio type="index" >nDayPrompt</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
            <audio type="index" >nAM_PM</audio>
          </play>
          <results >
            <result name="Default" link="41" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING MESSAGE HEADER***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_HEADER ;]]></script>
          </scripts>
        </action>
        <action id="53" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2156 y=601 ?>
          <!--Play message envelope w/ Caller ID, recv yesterday or today-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1849</audio>
            <audio type="index" >nDayPrompt</audio>
            <audio type="index" >1780</audio>
            <audio type="time" >g_oMessage.strTime</audio>
            <audio type="index" >nAM_PM</audio>
            <audio type="index" >1781</audio>
            <audio type="digits" >strPhoneAnnc</audio>
          </play>
          <results >
            <result name="Default" link="41" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING MESSAGE HEADER***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_HEADER ;]]></script>
          </scripts>
        </action>
        <action id="55" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1767 y=1105 ?>
          <!--Option for Alternate return destination.-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="40" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="g_strTermDigit" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;(x.T|x.#)&quot;" fdt="50" idt="40" ict="16" terminating-digit="g_strEndDigit" >
            <audio type="index" >1839</audio>
            <audio type="index" >2154</audio>
            <audio type="digits" >strPhoneAnnc</audio>
            <audio type="index" >321</audio>
            <audio type="index" >99</audio>
            <audio type="index" >99</audio>
            <audio type="index" >362</audio>
            <audio type="index" >1853</audio>
            <audio type="index" >580</audio>
          </collect-play>
          <results >
            <result name="Default" link="44" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="44" stubbed="1"/>
            <result name="No/Impossible Match" link="55" stubbed="1"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="# - Use Existing" link="44" stubbed="1" >strDigits match "#"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Set end Digit
Session.g_strEndDigit = "#";

Server.logInfo("Session.bCallerID = <" + Session.bCallerID +">");


]]></script>
            <script language="javascript" timing="last" ><![CDATA[
if (Session.strDigits.length > 3) {
// Update the current phone CallerID with the entered destination
Server.logInfo("Customer Request change of Return Number FROM " + Session.g_oMessage.strFromAnnc + " to "+ Session.strDigits)
Session.g_strReturnNumber = Session.strDigits ;
Server.logInfo("Session.g_strReturnNumber = <" + Session.g_strReturnNumber + ">" );
}else {
Session.g_strReturnNumber = Session.g_oMessage.strFromAnnc;
Server.logInfo("Session.g_strReturnNumber = <" + Session.g_strReturnNumber + ">" );
}
Session.g_strEndDigit = "";]]></script>
          </scripts>
        </action>
        <action id="57" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1594 y=1233 ?>
          <!--Option for Alternate return destination.-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="40" ms-type="g_oMS.strType" played-length="" digits="strDigits" terminating-char="g_strTermDigit" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;(x.T|x.#)&quot;" fdt="50" idt="40" ict="16" terminating-digit="g_strEndDigit" >
            <audio type="index" >1837</audio>
            <audio type="index" >99</audio>
            <audio type="index" >99</audio>
            <audio type="index" >509</audio>
            <audio type="index" >580</audio>
          </collect-play>
          <results >
            <result name="Default" link="44" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout" link="44" stubbed="1"/>
            <result name="No/Impossible Match" link="57" stubbed="1"/>
            <result name="First/Inter Digit Timeout" link="44" stubbed="1"/>
            <result name="digits entered" >strDigits.length &gt; 3</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[// Set end Digit
Session.g_strEndDigit = "#";


Server.logInfo("Session.bCallerID = <" + Session.bCallerID +">");
]]></script>
            <script language="javascript" timing="last" ><![CDATA[
if (Session.strDigits.length > 3) {
// Update the current phone CallerID with the untered destination
Server.logInfo("Customer Request change of Return Number FROM " + Session.g_oMessage.strFromAnnc + " to "+ Session.strDigits)
Session.g_strReturnNumber = Session.strDigits ;
Server.logInfo("Session.g_strReturnNumber = <" + Session.g_strReturnNumber + ">" );
Session.bCallerID = true;
}else {
Session.g_strReturnNumber = Session.g_oMessage.strFromAnnc;
Server.logInfo("Session.g_strReturnNumber = <" + Session.g_strReturnNumber + ">" );
}
Session.g_strEndDigit = "";
]]></script>
          </scripts>
        </action>
        <action id="58" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1519 y=1098 ?>
          <!--Caller id Present-->
          <results >
            <result name="Default" link="55" stubbed="0"/>
            <result name="CallerId == false" link="57" stubbed="0" >bCallerID == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[/* For return from ReturnCall function Pac 47 Sets bCallerId to true.  
This is a problem when callerId is really False and the customer has entered a destination*/

if ( "undefined" == Session.g_oMessage.strFromAnnc || undefined == Session.g_oMessage.strFromAnnc || 0 == Session.g_oMessage.strFromAnnc.length ) {
  	Session.bCallerID = false ;
}



Server.logInfo("Session.bCallerID = <" + Session.bCallerID + ">");
]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnBye" start="3" event="OnBye" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string" pass="byref"/>
        <parameter name="strAcceptEncoding" type="string" pass="byref"/>
        <parameter name="strAcceptLanguage" type="string" pass="byref"/>
        <parameter name="strAllow" type="string" pass="byref"/>
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string" pass="byref"/>
        <parameter name="strCallId" type="string" pass="byref"/>
        <parameter name="strCSeq" type="string" pass="byref"/>
        <parameter name="strDate" type="string" pass="byref"/>
        <parameter name="strEncryption" type="string" pass="byref"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string" pass="byref"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string" pass="byref"/>
        <parameter name="strProxyRequire" type="string" pass="byref"/>
        <parameter name="strRecordRoute" type="string" pass="byref"/>
        <parameter name="strReferredBy" type="string" pass="byref"/>
        <parameter name="strRequestURI" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="lTimeStart" type="i8" >0</var>
        <var name="lTimeAnswered" type="i8" >0</var>
        <var name="strStatus" type="string" ></var>
        <var name="strCallingNumber" type="string" ></var>
      </local-vars>
      <actions >
        <action id="3" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=26 y=169 ?>
          <!--200 OK-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <record-route >strRecordRoute</record-route>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="9" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( Session.strCallId == Session.g_oCallLegA.strCallId ) {
	Session.g_oCallLegA.bConnected = false ;
	Session.g_oCallLegB.nTerminationReason = "2" ; //Caller Hungup
}
else {
	Session.g_oCallLegB.bConnected = false ;
	Session.g_oCallLegB.nTerminationReason = "1" ; //Called Party Hangup
}

//Server.logInfo( "Received BYE during state: " + Session.g_sSTATE ) ;]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=945 y=409 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="6" plug-in="Pactolus.MGCPRecord.1" ><?xtml-editor x=497 y=364 ?>
          <!--Stop Record-->
          <record xmlns="urn:www.pactolus.com:xtml:media" op-mode="1" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTimeout" returns="g_nReturnValue" return-immediate="0" ms-type="g_oMS.strType" rid="g_strRecordURL" eik="" rlt="10" prt="" pst="" rl="g_nRecordLength" dc="" rc="g_nReasonCode" id-cleanup="1" play-beep="0" ef="&quot;PCM8M16&quot;" agc="0" agcta="" ga="" sla="" bpf="" bpa="" bpd=""/>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No Speech Detected"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_STOPPING_RECORD ;
]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Pactolus.Branch.1" ><?xtml-editor x=247 y=176 ?>
          <results >
            <result name="Default" link="32" stubbed="0"/>
            <result name="In Record" link="6" stubbed="1" >g_sSTATE == s_sSTATE_START_RECORD
OR g_sSTATE == s_sSTATE_RECORD_GREET</result>
            <result name="BYE from B" link="25" stubbed="0" >g_oCallLegB.strCallId == strCallId</result>
            <result name="BYE from A, Connected to B" link="25" stubbed="0" >g_oCallLegB.bConnected == true
AND strCallId match g_oCallLegA.strCallId</result>
            <result name="BYE from A, Outdialing B" link="31" stubbed="0" >strCallId match g_oCallLegA.strCallId
AND g_oCallLegB.bCurrentlyDialing == true</result>
          </results>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=706 y=386 ?>
          <!--Main-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( 0 != Session.g_nRecordLength ) {
	Session.g_sSTATE = Session.s_sSTATE_RECORD_GREET ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ;
}]]></script>
          </scripts>
        </action>
        <action id="25" plug-in="Pactolus.CNFDeleteConf.1" ><?xtml-editor x=488 y=180 ?>
          <delete-conference xmlns="urn:www.pactolus.com:xtml:conference" ci="g_oMS.strConferenceId" ms-type="s_strMSType" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="29" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="27" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=493 y=22 ?>
          <!--Main - DeleteMSConnection-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="28" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ;
]]></script>
          </scripts>
        </action>
        <action id="28" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=704 y=47 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="29" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=712 y=191 ?>
          <!--Main-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="30" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( Session.strCallId == Session.g_oCallLegA.strCallId ) {
	if ( true == Session.g_oCallLegB.bConnected ) {
		Session.g_sSTATE = Session.s_sSTATE_HANGUP_RETURN_CALL ; 
	}
	else {
		Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ; //A hung up during outdial to C
	}
}
else {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_OPTIONS ; //C hung up
}]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=956 y=201 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="31" plug-in="Pactolus.SipCancel.1" ><?xtml-editor x=270 y=373 ?>
          <!--Send CANCEL to CallLegB-->
          <sip-bye xmlns="urn:www.pactolus.com:xtml:sip" add-record-route="0" add-via="1" timeout="4" handle-responses="1" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegB.strCallId</call-id>
            <cseq >g_oCallLegB.strCSeq</cseq>
            <from >g_oCallLegB.strFrom</from>
            <request-uri >g_oCallLegB.strRequestUri</request-uri>
            <to >g_oCallLegB.strTo</to>
          </sip-bye>
          <results >
            <result name="Default" link="25" stubbed="0"/>
            <result name="Success"/>
            <result name="Timeout"/>
            <result name="Error"/>
          </results>
        </action>
        <action id="32" plug-in="Standard.EndSession.1" ><?xtml-editor x=757 y=114 ?></action>
      </actions>
    </function>
    <function name="OnSessionEnd" start="1" event="OnSessionEnd" returns="void" >
      <parameters >
        <parameter name="nSessionEndReason" type="i2" pass="byref"/>
      </parameters>
      <local-vars >
        <var name="oSubscriber" type="object" ></var>
        <var name="bMWIOn" type="boolean" >0</var>
        <var name="strMWIOffFlag" type="string" ></var>
      </local-vars>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=31 y=82 ?>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Caller Connected" link="2" stubbed="1" >g_oCallLegA.bConnected == true</result>
          </results>
        </action>
        <action id="2" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=257 y=81 ?>
          <!--HangUpParty-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;HangUpParty&quot;" return="" external-function="1" library="lib_callcontrol.xml" >
            <parameter >g_oCallLegA</parameter>
            <parameter >g_strLocalContact</parameter>
          </function>
          <results >
            <result name="Default" link="10" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegA.bReverseFromTo = true ;
Session.g_oCallLegA.strRequestUri = Session.g_oCallLegA.strRemoteURI ;

js_calculate_uri_and_route( false, "SIP/2.0", 
	Session.g_oCallLegA.strFrom.toString(),
	Session.g_oCallLegA.strContact.toString(),
	Session.g_oCallLegA.strRecordRoute.toString(),
	Session.g_oCallLegA.strRequestUri, 
	Session.g_oCallLegA.strRoute ) ;]]></script>
          </scripts>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=312 y=363 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="4" plug-in="Pactolus.Branch.1" ><?xtml-editor x=255 y=238 ?>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="bReadMsgs == false" link="3" stubbed="0" >g_bReadMsgs == false</result>
          </results>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=472 y=228 ?>
          <!--GetSIPAddress-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;GetSIPAddress&quot;" return="g_nReturnValue" external-function="1" library="lib_voip.xml" >
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oAPI.strPlatformSessionId</parameter>
            <parameter >oSubscriber</parameter>
            <parameter >g_oAPI.strSIPRealm</parameter>
            <parameter >g_oAPI.lVMAcctId</parameter>
            <parameter >g_oAPI.lAccessLineId</parameter>
            <parameter >g_oAPI.nTimezoneId</parameter>
            <parameter >strMWIOffFlag</parameter>
          </function>
          <results >
            <result name="Default" link="7" stubbed="0"/>
            <result name="g_nReturnValue == 0" link="6" stubbed="0" >g_nReturnValue == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***GETTING SIP ADDRESS***") ;
Session.g_sSTATE = Session.s_sSTATE_GET_SIP_ADDRESS ;

Session.g_oAPI.strPlatformSessionId = Session._sessionId ;
Session.oSubscriber.strPhone = Session.g_strSubPhone ;

Session.g_nReturnValue = 0 ;]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=692 y=231 ?>
          <!--SetMWI-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;SetMWI&quot;" return="g_nReturnValue" external-function="1" library="lib_vmail.xml" >
            <parameter >bMWIOn</parameter>
            <parameter >oSubscriber</parameter>
            <parameter >g_oMessage</parameter>
            <parameter >g_strSubPhone</parameter>
            <parameter >g_oAPI.strProcDBName</parameter>
            <parameter >g_oAPI.strSIPRealm</parameter>
            <parameter >g_oAPI.lAccessLineId</parameter>
          </function>
          <results >
            <result name="Default" link="9" stubbed="1"/>
            <result name="g_nReturnValue == -99" link="8" stubbed="1" >g_nReturnValue == -99</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***SETTING MWI***") ;
Session.g_sSTATE = Session.s_sSTATE_SET_MWI ;


if ( "F" == Session.strMWIOffFlag ) { 
	//there are still messages on other vm accounts for this accessline
	Session.bMWIOn = true;
}	
else{	
	Session.bMWIOn = false ;
}

Session.g_nReturnValue = 0 ;


]]></script>
          </scripts>
        </action>
        <action id="7" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=523 y=366 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Failed to get SIP address. Return Value: " + Session.g_nReturnValue ) ;



]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=900 y=289 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("Failed to set MWI. Return Value: " + Session.g_nReturnValue ) ;

]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=895 y=228 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="10" plug-in="Pactolus.Branch.1" ><?xtml-editor x=32 y=228 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Check for Expired Messages" link="11" stubbed="0" >g_nMsgSaveFor != 0</result>
          </results>
        </action>
        <action id="11" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=36 y=354 ?>
          <!--DeleteExpiredMsgs-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;DeleteExpiredMsgs&quot;" return="g_nReturnValue" external-function="1" library="lib_vmail.xml" >
            <parameter >g_oMessage.strAcctName</parameter>
            <parameter >g_nMsgSaveFor</parameter>
          </function>
          <results >
            <result name="Default" link="4" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_CHCK_EXPIRED_MSGS ;
]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="RecordNewGreeting" start="2" event="RecordNewGreeting" returns="void" >
      <local-vars >
        <var name="nReasonCode" type="i4" >0</var>
        <var name="strResponseText" type="string" ></var>
        <var name="strDigit" type="string" ></var>
        <var name="nRetryCount" type="i4" >0</var>
        <var name="nRecordTimeout" type="i4" >0</var>
        <var name="strQuery" type="string" ></var>
        <var name="oGreetings" type="object" ></var>
        <var name="strRecordPrompt" type="string" ></var>
        <var name="nRecordRetry" type="i4" >0</var>
        <var name="nReturnCode" type="i4" >0</var>
        <var name="nSearchResult" type="i4" >0</var>
        <var name="bReview" type="boolean" >0</var>
        <var name="strErrorPrompt" type="string" ></var>
        <var name="nGreetingName" type="i4" >0</var>
        <var name="bFirstCallComplete" type="boolean" >0</var>
        <var name="nAdditionalGreetingsPrompt" type="i4" >99</var>
        <var name="nAdditionalGreetingsKey" type="i4" >99</var>
      </local-vars>
      <actions >
        <action id="2" plug-in="Pactolus.Branch.1" ><?xtml-editor x=29 y=37 ?>
          <results >
            <result name="Default" link="21" stubbed="1"/>
            <result name="g_strFirstCall == T" link="39" stubbed="0" >g_strFirstCall match "T"</result>
            <result name="Caller hung up in record" link="24" stubbed="1" >g_oCallLegA.bConnected == false
AND g_nRecordLength != 0</result>
          </results>
        </action>
        <action id="3" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=377 y=626 ?>
          <!--Prompt to begin recording-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >strRecordPrompt</audio>
          </play>
          <results >
            <result name="Default" link="7" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PROMPT TO BEGIN RECORDING***") ;

if ( 0 == Session.strRecordPrompt ) {
	Session.strRecordPrompt = "1798" ;
}

]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Pactolus.ReadMail.1" ><?xtml-editor x=714 y=39 ?>
          <imap-read xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;Greetings&quot;" msg-uid="oGreetings[0]" to="" from="" cc="" subject="" body="" attachment1="oGreetings[0].strAtt1" attachment2="" attachment3="" timeout="s_nTimeout" returns="g_nReturnValue" timestamp=""/>
          <results >
            <result name="Default" link="26" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="7" plug-in="Pactolus.MGCPRecord.1" ><?xtml-editor x=675 y=621 ?>
          <record xmlns="urn:www.pactolus.com:xtml:media" op-mode="0" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="nRecordTimeout" returns="g_nReturnValue" return-immediate="0" ms-type="g_oMS.strType" rid="g_strRecordURL" eik="g_strTermDigit" rlt="g_nMaxGreeting_ms" prt="50" pst="50" rl="g_nRecordLength" dc="" rc="nReasonCode" id-cleanup="1" play-beep="1" ef="&quot;PCM8M16&quot;" agc="0" agcta="" ga="" sla="" bpf="1400" bpa="" bpd="10"/>
          <results >
            <result name="Default" link="2" stubbed="1"/>
            <result name="Success" link="24" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No Speech Detected" link="12" stubbed="0"/>
            <result name="nRecordLength == 0" link="12" stubbed="0" >g_nRecordLength == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_START_RECORD ;

Session.g_strRecordURL = "" ;

if ( 0 == Session.g_nMaxGreetingLength ) {
	Session.g_nMaxGreetingLength = 120 ;
}

Session.g_nMaxGreeting_ms = Session.g_nMaxGreetingLength * 10 ;

Session.nRecordTimeout = Session.g_nMaxGreetingLength + 5 ;

Session.g_strTermDigit = "#" ;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Greeting length: " + Session.g_nRecordLength ) ;]]></script>
          </scripts>
        </action>
        <action id="8" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1172 y=35 ?>
          <!--Play Subscriber Greeting-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="nRecordTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >oGreetings[0].strAtt1</audio>
          </play>
          <results >
            <result name="Default" link="34" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING SUBSCRIBER GREETING***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_GREET ;

]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1684 y=783 ?>
          <!--bye - system error-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError( "Ending session after state: " + Session.g_sSTATE ) ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_BYE ;

Session.g_bSystemError = true ;
Session.g_nErrorMsgId = 305 ; //Generic System Error until new prompt is recorded]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Pactolus.SendMail.1" ><?xtml-editor x=1412 y=648 ?>
          <smtp-send xmlns="urn:www.pactolus.com:xtml:smtp" to="g_oMessage.strAcctName" from="g_strLocalContact" cc="" bcc="" subject="g_oAPI.strGreeting" attachment1="g_strRecordURL" attachment2="" attachment3="" flagged="0" timeout="s_nTimeout" returns="g_nReturnValue" response-code="nReasonCode" response-text="strResponseText" body=""/>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success" link="29" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***DEPOSIT NEW GREETING***") ;

Session.g_sSTATE = Session.s_sSTATE_UPDATE_GREET ;





]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=835 y=874 ?>
          <!--No speech detected-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1810</audio>
          </play>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Max retries" link="21" stubbed="1" >nRecordRetry == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Session.nRecordRetry++ ;]]></script>
          </scripts>
        </action>
        <action id="16" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=268 y=485 ?>
          <!--Return to Options Menu,
Disconnect if Caller has hung up-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( false == Session.g_oCallLegA.bConnected ) {
	Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS ;
}]]></script>
          </scripts>
        </action>
        <action id="19" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1980 y=665 ?>
          <!--If caller hangs up during record of greet, clean up session and end.-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_DISCONNECT_MS ;

]]></script>
          </scripts>
        </action>
        <action id="20" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=976 y=187 ?>
          <!--Default Greeting-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1751</audio>
            <audio type="digits" >g_strSubPhone</audio>
            <audio type="index" >1752</audio>
          </play>
          <results >
            <result name="Default" link="21" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING SYSTEM DEFAULT GREETING***") ;]]></script>
          </scripts>
        </action>
        <action id="21" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=117 y=196 ?>
          <!--Update Greeting menu-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="40" ms-type="g_oMS.strType" played-length="" digits="strDigit" terminating-char="" rc="nReasonCode" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;([1-5]|*)&quot;" fdt="40" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >g_nInvalidChoicePrompt</audio>
            <audio type="index" >1789</audio>
            <audio type="index" >311</audio>
            <audio type="index" >1841</audio>
            <audio type="index" >1842</audio>
            <audio type="index" >312</audio>
            <audio type="index" >1841</audio>
            <audio type="index" >1844</audio>
            <audio type="index" >313</audio>
            <audio type="index" >1841</audio>
            <audio type="index" >1845</audio>
            <audio type="index" >314</audio>
            <audio type="index" >1841</audio>
            <audio type="index" >1843</audio>
            <audio type="index" >315</audio>
            <audio type="index" >560</audio>
          </collect-play>
          <results >
            <result name="Default" link="21" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="21" stubbed="1"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - review greeting" link="33" stubbed="1" >strDigit match "1"</result>
            <result name="2 - record personal greeting" link="30" stubbed="1" >strDigit match "2"</result>
            <result name="3 - use system greeting w/Name" link="30" stubbed="1" >strDigit match "3"</result>
            <result name="4 - use system greeting w/Phone" link="29" stubbed="1" >strDigit match "4"</result>
            <result name="5 - record alternate greeting" link="30" stubbed="1" >strDigit match "5"</result>
            <result name="* - previous menu" link="16" stubbed="0" >strDigit match "*"</result>
            <result name="Max Retries" link="16" stubbed="0" >nRetryCount == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***UPDATE GREETING MENU***") ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_GREET_MENU ;

Session.strDigit = "" ;

Session.bReview = false ;


if ( 0 < Session.g_oAPI.nCorpDeptId ) {
	Session.nAdditionalGreetingsPrompt = 5048;
	Session.nAdditionalGreetingsKey = 316;
}


]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 337 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id || 1 == Result.id ) {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount++ ;
}
else {
	Session.g_nInvalidChoicePrompt = 99 ;
	Session.nRetryCount = 0 ;
}

if ( 7 < Result.id ) {
Session.strRecordPrompt = "1798" ;
	switch ( Session.strDigit ) {
		case "1" :
			Session.bReview = true ;
			break ;
		case "2" :
			Session.g_oAPI.strGreeting = "Primary_Greeting" ;
			Session.strRecordPrompt = "1798" ;
			Session.nGreetingName = 1842 ;
			break ;
		case "3" :
			Session.g_oAPI.strGreeting = "Name_Greeting" ;
			Session.strRecordPrompt = "869" ;  
			Session.nGreetingName = 1844 ;
			break ;
		case "4" :
			Session.g_oAPI.strGreeting = "System_Greeting" ;
			Session.nGreetingName = 1845 ;
			break;
		case "5" :
			Session.g_oAPI.strGreeting = "Alternate_Greeting" ;
			Session.strRecordPrompt = "1798" ;
			Session.nGreetingName = 1843 ;
			break ;
	}
}


	
	




]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Pactolus.UpdateMail.1" ><?xtml-editor x=1187 y=640 ?>
          <imap-update xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;Greetings&quot;" msg-uid="oGreetings" flag="&quot;delete&quot;" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="11" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("DELETING MESSAGE ID: " + Session.oGreetings) ;
]]></script>
          </scripts>
        </action>
        <action id="24" plug-in="Pactolus.MailboxSearch.1" ><?xtml-editor x=919 y=634 ?>
          <search-mailbox xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;Greetings&quot;" query-string="strQuery" search-result="oGreetings" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="22" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="no ids found" link="11" stubbed="0" >nSearchResult == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.strQuery = "SUBJECT \"" + Session.g_oAPI.strGreeting + "\"" ;

Session.oGreetings.length = 0 ;
]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.nSearchResult = Session.oGreetings.length ;]]></script>
          </scripts>
        </action>
        <action id="26" plug-in="Pactolus.Branch.1" ><?xtml-editor x=936 y=46 ?>
          <results >
            <result name="Default" link="20" stubbed="1"/>
            <result name="Name" link="28" stubbed="0" >g_oAPI.strGreeting == "Name_Greeting"</result>
            <result name="Primary or Alternate" link="8" stubbed="0" >g_oAPI.strGreeting == "Primary_Greeting"
OR g_oAPI.strGreeting == "Alternate_Greeting"</result>
          </results>
        </action>
        <action id="28" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1421 y=108 ?>
          <!--Default Greeting with Name-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="url" >oGreetings[0].strAtt1</audio>
            <audio type="index" >1752</audio>
          </play>
          <results >
            <result name="Default" link="34" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PLAYING SYSTEM GREETING WITH NAME***"); ]]></script>
          </scripts>
        </action>
        <action id="29" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=1679 y=529 ?>
          <!--updateVoicemailGreeting-->
          <java xmlns="urn:www.pactolus.com:xtml:application" class="&quot;com.pactolus.broadband.psAPISceVoicemailAuth&quot;" method="&quot;updateVoicemailGreeting&quot;" timeout="s_nTimeout" return="g_nReturnValue" method-return-var="nReturnCode" method-return-type="0" >
            <parameter type="in" var-type="string" >g_oAPI.strProcDBName</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strPlatformSessionId</parameter>
            <parameter type="in" var-type="i8" >g_oAPI.lVMAcctId</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strGreeting</parameter>
          </java>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success" link="32" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Caller hung up" link="19" stubbed="1" >g_oCallLegA.bConnected == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("Updating Active Greeting to be: " + Session.g_oAPI.strGreeting) ;
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( Session.g_strFirstCall == "T" ) {
	Session.g_sSTATE = Session.s_sSTATE_GET_MSGS;
	Session.g_strFirstCall = "F";
}]]></script>
          </scripts>
        </action>
        <action id="30" plug-in="Pactolus.MailboxSearch.1" ><?xtml-editor x=489 y=33 ?>
          <search-mailbox xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;Greetings&quot;" query-string="strQuery" search-result="oGreetings" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="20" stubbed="1"/>
            <result name="Success" link="6" stubbed="1"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No matches found" link="36" stubbed="1" >nSearchResult == 0
AND bReview == false</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***FETCHING ACTIVE GREETING***") ;

Session.g_sSTATE = Session.s_sSTATE_FETCH_GREET ;

/* clear out any previous values for message vars */
Session.oGreetings.length = 0 ;

Session.strQuery = "SUBJECT \"" + Session.g_oAPI.strGreeting + "\"" ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.nSearchResult = Session.oGreetings.length ;
]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1978 y=435 ?>
          <!--"Your greeting has been updated."-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1840</audio>
          </play>
          <results >
            <result name="Default" link="41" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="33" plug-in="Pactolus.Branch.1" ><?xtml-editor x=491 y=178 ?>
          <results >
            <result name="Default" link="30" stubbed="1"/>
            <result name="System Default is active" link="20" stubbed="1" >g_oAPI.strGreeting == "System_Greeting"</result>
          </results>
        </action>
        <action id="34" plug-in="Pactolus.Branch.1" ><?xtml-editor x=1659 y=75 ?>
          <results >
            <result name="Default" link="21" stubbed="1"/>
            <result name="Accept Greeting?" link="37" stubbed="0" >bReview == false</result>
          </results>
        </action>
        <action id="36" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=735 y=180 ?>
          <!--"This greeting has not yet been recorded."-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >nGreetingName</audio>
            <audio type="index" >1846</audio>
          </play>
          <results >
            <result name="Default" link="3" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="37" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=1902 y=42 ?>
          <!--Accept current or record new greeting?-->
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strDigit" terminating-char="" rc="" returns="g_nReturnValue" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;([1-2]|*)&quot;" fdt="40" idt="40" ict="16" terminating-digit="" >
            <audio type="index" >1790</audio>
            <audio type="index" >311</audio>
            <audio type="index" >1788</audio>
            <audio type="index" >312</audio>
          </collect-play>
          <results >
            <result name="Default" link="38" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
            <result name="1 - Accept" link="29" stubbed="1" >strDigit match "1"</result>
            <result name="2 - Record New" link="3" stubbed="1" >strDigit match "2"</result>
            <result name="* - previous menu" link="21" stubbed="1" >strDigit match "*"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.strDigit = "" ;
]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=2118 y=57 ?>
          <!--"Your greeting has been updated."-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1840</audio>
          </play>
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( 0 == Session.strDigit.length ) {
	Session.strErrorPrompt = "552" ;
}
else {
	Session.strErrorPrompt = "337" ;
}]]></script>
          </scripts>
        </action>
        <action id="39" plug-in="Pactolus.MailboxSearch.1" ><?xtml-editor x=66 y=621 ?>
          <!--Verify that sub has not uploaded a primary greeting already-->
          <search-mailbox xmlns="urn:www.pactolus.com:xtml:imap" username="g_oMessage.strAcctName" password="g_oMessage.strAcctPassword" mailbox="&quot;Greetings&quot;" query-string="strQuery" search-result="oGreetings" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="40" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No matches found" link="3" stubbed="0" >nSearchResult == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_FETCH_GREET ;

/* clear out any previous values for message vars */
Session.oGreetings.length = 0 ;

if ( Session.g_bCorpAcct ) { //check for name recording
	Session.strQuery = "SUBJECT \"Name_Greeting\"" ;
	Session.g_oAPI.strGreeting = "Name_Greeting" ;
	Session.strRecordPrompt = "869" ;
}
else { //this is a residential account; check for primary greeting
	Session.strQuery = "SUBJECT \"Primary_Greeting\"" ;
	Session.g_oAPI.strGreeting = "Primary_Greeting" ;
}

Session.bFirstCallComplete = false;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[Session.nSearchResult = Session.oGreetings.length ;
]]></script>
          </scripts>
        </action>
        <action id="40" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=307 y=836 ?>
          <!--GetMessages-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_GET_MSGS;
Session.g_strFirstCall = "F";]]></script>
          </scripts>
        </action>
        <action id="41" plug-in="Pactolus.Branch.1" ><?xtml-editor x=2213 y=482 ?>
          <results >
            <result name="Default" link="21" stubbed="1"/>
            <result name="STATE_GET_MSGS" link="42" stubbed="0" >g_sSTATE == s_sSTATE_GET_MSGS</result>
          </results>
        </action>
        <action id="42" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=2465 y=501 ?>
          <!--GetMsgs-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="UpdatePIN" start="12" event="UpdatePIN" returns="void" >
      <local-vars >
        <var name="strPIN" type="string" ></var>
        <var name="bCancelled" type="boolean" >0</var>
        <var name="nPINlength" type="i4" >0</var>
        <var name="nReturnCode" type="i4" >0</var>
        <var name="nRetryCount" type="i4" >0</var>
        <var name="nInvalidPINPrompt" type="i4" >99</var>
        <var name="strEndKey" type="string" ></var>
        <var name="strPINConfirm" type="string" ></var>
        <var name="nPin1" type="i4" >0</var>
        <var name="nPin2" type="i4" >0</var>
      </local-vars>
      <actions >
        <action id="12" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=29 y=40 ?>
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strPIN" terminating-char="g_strTermDigit" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;(xxxxxx.#|xxxxxx.T|xx.*)&quot;" fdt="50" idt="40" ict="16" terminating-digit="&quot;*,#&quot;" >
            <audio type="index" >nInvalidPINPrompt</audio>
            <audio type="index" >1794</audio>
            <audio type="number" >g_nPinLength</audio>
            <audio type="index" >377</audio>
          </collect-play>
          <results >
            <result name="Default" link="10" stubbed="1"/>
            <result name="Success" link="5" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match" link="12" stubbed="1"/>
            <result name="First/Inter Digit Timeout" link="12" stubbed="1"/>
            <result name="PIN Cancelled" link="11" stubbed="0" >g_strTermDigit match "*"</result>
            <result name="Retry Max" link="10" stubbed="1" >nRetryCount == 2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PROMPT FOR NEW PIN***") ;

Session.bCancelled = false ;
Session.g_strTermDigit = "" ;

if ( 0 == Session.g_nPinLength ) {
	Session.g_nPinLength = 6 ;
}

]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 5 == Result.id && "F" == Session.g_strFirstCall ) {
	Session.nInvalidPINPrompt = 1763 ;
	Session.nRetryCount++ ;
}
else if ( 6 == Result.id && Session.g_strFirstCall ) {
	Session.nInvalidPINPrompt = 552 ;
	Session.nRetryCount++ ;
}
else {
	Session.nInvalidPINPrompt = 99 ;
}

Server.logInfo("FIRST PIN UPDATE: " + Session.strPIN) ;]]></script>
          </scripts>
        </action>
        <action id="1" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1166 y=72 ?>
          <!--PIN updated successfully-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1795</audio>
          </play>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PIN SUCCESSFULLY UPDATED***") ;]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1395 y=130 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( "T" == Session.g_strFirstCall ) {
	Session.g_sSTATE = Session.s_sSTATE_RECORD_GREET ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS_SUB ;
}

	]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Pactolus.Branch.1" ><?xtml-editor x=233 y=57 ?>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="PIN too long" link="6" stubbed="0" >nPINlength &gt;g_nPinLength</result>
            <result name="PIN too short" link="12" stubbed="0" >nPINlength &lt; g_nPinLength</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nPINlength = Session.strPIN.length ;

if ( Session.nPINlength < Session.g_nPinLength ) {
	Session.nInvalidPINPrompt = 1763 ;
	Session.nRetryCount++ ;
}

]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=465 y=255 ?>
          <!--PIN too long-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1815</audio>
          </play>
          <results >
            <result name="Default" link="12" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="8" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=931 y=58 ?>
          <!--psAPISceVoicemailAuth.updateVoicemailPin-->
          <java xmlns="urn:www.pactolus.com:xtml:application" class="&quot;com.pactolus.broadband.psAPISceVoicemailAuth&quot;" method="&quot;updateVoicemailPin&quot;" timeout="s_nTimeout" return="g_nReturnValue" method-return-var="nReturnCode" method-return-type="0" >
            <parameter type="in" var-type="string" >g_oAPI.strProcDBName</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strPlatformSessionId</parameter>
            <parameter type="in" var-type="i8" >g_oAPI.lVMAcctId</parameter>
            <parameter type="in" var-type="string" >strPIN</parameter>
          </java>
          <results >
            <result name="Default" link="9" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="0 Success" link="1" stubbed="0" >nReturnCode == 0</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oAPI.strPlatformSessionId = Session._sessionId ;

Session.g_sSTATE = Session.s_sSTATE_AUTHENTICATE_SUB ;

Server.logInfo("UPDATE PIN for Sub: " + Session.g_strSubPhone) ;
Server.logInfo("NEW PIN: " + Session.strPIN) ;







]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Return Code: " + Session.nReturnCode ) ;

switch (Session.nReturnCode) {
	case -16:
		Server.logError("UpdatePIN returned ACCOUNT NOT FOUND") ;
		Session.g_nErrorMsgId = 305 ; //NEED NEW MSG ID
		break ;
	case -99:
		Server.logError("UpdatePIN returned DB ERROR") ;
		Session.g_nErrorMsgId = 1001 ; //General DB Error
		break;
}

/*** RESULT CODES ***/
//SUCCESS = 0;
//-16 = Account not found
//-99 = DB Error


]]></script>
          </scripts>
        </action>
        <action id="9" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1178 y=241 ?>
          <!--Error-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_bSystemError = true ;

Session.g_sSTATE = Session.s_sSTATE_PLAY_BYE ;

	]]></script>
          </scripts>
        </action>
        <action id="10" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=252 y=400 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[if ( "T" == Session.g_strFirstCall ) {
	Session.g_sSTATE = Session.s_sSTATE_RECORD_GREET ;
}
else {
	Session.g_sSTATE = Session.s_sSTATE_PLAY_OPTIONS_SUB ;
}
]]></script>
          </scripts>
        </action>
        <action id="11" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=176 y=248 ?>
          <!--Update Cancelled-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1818</audio>
          </play>
          <results >
            <result name="Default" link="10" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PIN CANCELLED***") ;

]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.CollectPlay.1" ><?xtml-editor x=452 y=41 ?>
          <collect-play xmlns="urn:www.pactolus.com:xtml:media" endpoint="g_oMS.strEndPoint" connection-id="g_oMS.strConnectionId" timeout="s_nTimeout" ms-type="s_strMSType" played-length="" digits="strPINConfirm" terminating-char="g_strTermDigit" rc="" returns="nReturnCode" play-offset="" language="g_strLanguage" retry-count="1" time-to-play="" interrupt="1" repeat="0" clear-digits="1" digit-map="&quot;(xxxxxx.#|xxxxxx.T|xx.*)&quot;" fdt="50" idt="40" ict="16" terminating-digit="&quot;*,#&quot;" >
            <audio type="index" >1833</audio>
          </collect-play>
          <results >
            <result name="Default" link="15" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="No/Impossible Match"/>
            <result name="First/Inter Digit Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***CONFIRM NEW PIN***") ;

Session.bCancelled = false ;
Session.g_strTermDigit = "" ;


]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Confirmation PIN: " + Session.strPINConfirm ) ;]]></script>
          </scripts>
        </action>
        <action id="14" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=697 y=240 ?>
          <!--PINs do not match-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="g_oMS.strType" returns="g_nReturnValue" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="0" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >1834</audio>
          </play>
          <results >
            <result name="Default" link="12" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("***PINs DO NOT MATCH***") ;]]></script>
          </scripts>
        </action>
        <action id="15" plug-in="Pactolus.Branch.1" ><?xtml-editor x=691 y=78 ?>
          <results >
            <result name="Default" link="14" stubbed="0"/>
            <result name="PINs match" link="8" stubbed="0" >nPin1 == nPin2</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.nPin1 = parseInt(Session.strPIN) ;
Session.nPin2 = parseInt(Session.strPINConfirm) ;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnCancel" start="1" event="OnCancel" returns="void" >
      <parameters >
        <parameter name="strAccept" type="string" pass="byref"/>
        <parameter name="strAcceptEncoding" type="string" pass="byref"/>
        <parameter name="strAcceptLanguage" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string" pass="byref"/>
        <parameter name="strCallId" type="string" pass="byref"/>
        <parameter name="strContent" type="string" pass="byref"/>
        <parameter name="strContentDisposition" type="string" pass="byref"/>
        <parameter name="strContentType" type="string" pass="byref"/>
        <parameter name="strCSeq" type="string" pass="byref"/>
        <parameter name="strDate" type="string" pass="byref"/>
        <parameter name="strEncryption" type="string" pass="byref"/>
        <parameter name="strErrorInfo" type="string" pass="byref"/>
        <parameter name="strFrom" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string" pass="byref"/>
        <parameter name="strProxyRequire" type="string" pass="byref"/>
        <parameter name="strRecordRoute" type="string" pass="byref"/>
        <parameter name="strRequestURI" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strSupported" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=103 y=124 ?>
          <!--200 OK-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >strCallId</call-id>
            <cseq >strCSeq</cseq>
            <from >strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >strTo</to>
            <via >strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="2" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=341 y=99 ?>
          <!--487 Request Terminated-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegA.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >g_oCallLegA.strCSeq</cseq>
            <from >g_oCallLegA.strFrom</from>
            <status >"SIP/2.0 487 Request Terminated"</status>
            <to >g_oCallLegA.strTo</to>
            <via >g_oCallLegA.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var cseq = new SipCSeq(Session.strCSeq.toString());
cseq.method = "INVITE";
Session.strCSeq = cseq.encode();]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Standard.EndSession.1" ><?xtml-editor x=583 y=164 ?>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo( "RECEIVED CANCEL. ENDING SESSION" ) ;
Session.g_oCallLegA.bConnected = false ;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnRe-Invite" start="1" event="OnRe-Invite" returns="void" >
      <parameters >
        <parameter name="oSipMsg" type="object" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=78 y=152 ?>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="call id matches" link="4" stubbed="0" >g_oCallLegA.strCallId == oSipMsg.strCallId</result>
          </results>
        </action>
        <action id="2" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=333 y=42 ?>
          <!--481 Call Leg/Transaction Does Not Exist-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >oSipMsg.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >oSipMsg.strCSeq</cseq>
            <from >oSipMsg.strFrom</from>
            <status >"SIP/2.0 481 Call Leg/Transaction Does Not Exist"</status>
            <to >oSipMsg.strTo</to>
            <via >oSipMsg.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="3" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=560 y=87 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logError("IGNORING REINVITE; THIS CALL ID DOES NOT MATCH: " + Session.oSipMsg.strCallId) ;
]]></script>
          </scripts>
        </action>
        <action id="4" plug-in="Pactolus.SipResponse.1" ><?xtml-editor x=321 y=256 ?>
          <!--200 OK-->
          <sip-response xmlns="urn:www.pactolus.com:xtml:sip" remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >oSipMsg.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <content >g_oMS.strContent</content>
            <content-type >oSipMsg.strContentType</content-type>
            <cseq >oSipMsg.strCSeq</cseq>
            <from >oSipMsg.strFrom</from>
            <status >"SIP/2.0 200 OK"</status>
            <to >oSipMsg.strTo</to>
            <via >oSipMsg.strVia</via>
          </sip-response>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_GOT_REINVITE ;]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=568 y=276 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("SUCCESSFUL REINVITE") ;]]></script>
          </scripts>
        </action>
      </actions>
    </function>
    <function name="OnAck" start="1" event="OnAck" returns="void" >
      <parameters >
        <parameter name="strAllowEvents" type="string" pass="byref"/>
        <parameter name="strAuthorization" type="string" pass="byref"/>
        <parameter name="strCallId" type="string" pass="byref"/>
        <parameter name="strContact" type="string" pass="byref"/>
        <parameter name="strContent" type="string" pass="byref"/>
        <parameter name="strContentDisposition" type="string" pass="byref"/>
        <parameter name="strContentEncoding" type="string" pass="byref"/>
        <parameter name="strContentLanguage" type="string" pass="byref"/>
        <parameter name="strContentType" type="string" pass="byref"/>
        <parameter name="strCSeq" type="string" pass="byref"/>
        <parameter name="strDate" type="string" pass="byref"/>
        <parameter name="strEncryption" type="string" pass="byref"/>
        <parameter name="strFrom" type="string" pass="byref"/>
        <parameter name="strMaxForwards" type="string" pass="byref"/>
        <parameter name="strMIMEVersion" type="string" pass="byref"/>
        <parameter name="strProxyAuthorization" type="string" pass="byref"/>
        <parameter name="strProxyRequire" type="string" pass="byref"/>
        <parameter name="strRecordRoute" type="string" pass="byref"/>
        <parameter name="strRequestURI" type="string" pass="byref"/>
        <parameter name="strRequire" type="string" pass="byref"/>
        <parameter name="strResponseKey" type="string" pass="byref"/>
        <parameter name="strRoute" type="string" pass="byref"/>
        <parameter name="strTimestamp" type="string" pass="byref"/>
        <parameter name="strTo" type="string" pass="byref"/>
        <parameter name="strUserAgent" type="string" pass="byref"/>
        <parameter name="strVia" type="string" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=130 y=124 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
      </actions>
    </function>
    <function name="ReturnCall" start="15" event="ReturnCall" returns="void" >
      <local-vars >
        <var name="oReturnCallAPI" type="object" ></var>
        <var name="oAccessLine" type="object" ></var>
        <var name="oVoipService" type="object" ></var>
        <var name="strResponse" type="string" ></var>
        <var name="strPrompt" type="string" ></var>
        <var name="oProxyIP" type="object" ></var>
        <var name="idx" type="i4" >0</var>
        <var name="strSIPStatus" type="string" ></var>
        <var name="nSessionTimer" type="i4" >0</var>
        <var name="nAPIReturnCode" type="i4" >0</var>
        <var name="nErrorMsg" type="i4" >0</var>
        <var name="strEventRcvd" type="string" ></var>
        <var name="strDtmf" type="string" ></var>
        <var name="strRequestID" type="string" ></var>
        <var name="strEndPoint" type="string" ></var>
        <var name="strCallId" type="string" ></var>
        <var name="strContact" type="string" ></var>
        <var name="strContent" type="string" ></var>
        <var name="strCSeq" type="string" ></var>
        <var name="strFrom" type="string" ></var>
        <var name="strRecordRoute" type="string" ></var>
        <var name="strTo" type="string" ></var>
        <var name="strVia" type="string" ></var>
        <var name="strStatus" type="string" ></var>
        <var name="nStatus" type="i4" >0</var>
        <var name="strNonce" type="string" ></var>
        <var name="strDigestResponse" type="string" ></var>
        <var name="strProxyAuthenticate" type="string" ></var>
      </local-vars>
      <actions >
        <action id="15" plug-in="Pactolus.CNFCreateConf.1" ><?xtml-editor x=23 y=93 ?>
          <create-conference xmlns="urn:www.pactolus.com:xtml:conference" ci="g_oMS.strConferenceId" persist="1" ms-type="s_strMSType" timeout="s_nTimeout" returns="g_nReturnValue" mp="2" mt="2" hysteresis="" time-constant="" active-speakers="2" reporting-interval="2" active-speaker-threshold="" >
            <attributes mp="2" mt="2" ig="0" og="0" iat="-10" ias="-40" oat="-10" oas="-40" atn="2" att="2" ia="1" oa="1" te="1" le="1" tp="0" dc="1" tc="1" ate="0" se="0"/>
          </create-conference>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success" link="12" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[//clear out any pre-existing values for the B call leg
js_initCallLeg(Session.g_oCallLegB);

Session.g_oCallLegB.strConfContent = "";
Session.g_oCallLegB.strConfEndPoint = "";
Session.g_oCallLegB.strConfConnectionId = "";
Session.g_oCallLegB.strConfCallId = "";
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("CREATE CONFERENCE RETURNED: " + Session.g_nReturnValue) ;
if ( 0 == Session.g_nReturnValue ) {
	Server.logInfo("CONFERENCE ID: " + Session.g_oMS.strConferenceId) ;
}]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=1893 y=87 ?>
          <!--Connected-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_RETURNCALL_CONNECTED ;
]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=659 y=492 ?>
          <!--Play Msg Options-->
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_PLAY_MSG_OPTIONS ;
]]></script>
          </scripts>
        </action>
        <action id="12" plug-in="Pactolus.CNFAddMember.1" ><?xtml-editor x=248 y=90 ?>
          <!--Add Local connection to Conference-->
          <add-member xmlns="urn:www.pactolus.com:xtml:conference" endpoint="g_oMS.strEndPoint" ms-type="s_strMSType" ci="g_oMS.strConferenceId" inbound="1" returns="g_nReturnValue" timeout="s_nTimeout" connection-id="g_oMS.strConnectionId" ms-sdp="g_oMS.strDummy" mgcp-call-id="g_oMS.strCallId" ingress-gateway="" early-media="0" local="1" party-on-hold="0" packetization-period="g_oMS.intPacketizationPeriod" codec="0" telephone-events="1" route="" record-route="" contact="" te="1" dc="0" le="1" ig="" og="" ia="" oa="" iat="" oat="" ias="" oas="" tf="1" lf="1" session-expires="" min-se="" supported="" min-supported-session-timer="" refresher="" use-session-timer="0" conn-mode="send/receive" >
            <attributes mp="16" mt="3" ig="0" og="0" iat="-10" ias="-40" oat="-10" oas="-40" atn="3" att="2" ia="1" oa="1" te="1" le="1" tp="0" dc="0" tc="1" ate="0" se="0"/>
          </add-member>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success" link="35" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Resource Unavailable"/>
            <result name="Caller Hung up"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("ADD MEMBER RETURNED: " + Session.g_nReturnValue) ;
Server.logInfo("MS_Content: " + Session.g_oMS.strContent);
Server.logInfo("MS_EndPoint: " + Session.g_oMS.strEndPoint);
Server.logInfo("MS_ConnectionID: " + Session.g_oMS.strConnectionId);
Server.logInfo("MS_CallId: " + Session.g_oMS.strCallId);
Server.logInfo("MS_ConferenceId: " + Session.g_oMS.strConferenceId);
]]></script>
          </scripts>
        </action>
        <action id="13" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=241 y=381 ?>
          <!--Local Conference set up failed-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >375</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="17" plug-in="Pactolus.CNFDeleteConf.1" ><?xtml-editor x=481 y=407 ?>
          <delete-conference xmlns="urn:www.pactolus.com:xtml:conference" ci="g_oMS.strConferenceId" ms-type="s_strMSType" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="6" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="21" plug-in="Pactolus.MGCPPlay.1" ><?xtml-editor x=1442 y=307 ?>
          <!--Unable to connect to B-->
          <play xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_nTimeout" ms-type="s_strMSType" returns="g_nReturnValue" start-play="1" interrupt="0" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer="" >
            <audio type="index" >549</audio>
          </play>
          <results >
            <result name="Default" link="17" stubbed="1"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.bCurrentlyOutdialing = false;
Session.g_oCallLegB.bConnected = false;

Server.enableEvents(true);

]]></script>
          </scripts>
        </action>
        <action id="22" plug-in="Pactolus.MGCPNotifyRequest.1" ><?xtml-editor x=1656 y=67 ?>
          <!--Set digit map for return to VM-->
          <rqnt xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTimeout" returns="g_nReturnValue" ms-type="s_strMSType" >
            <parameters >
              <quarantine step="1" loop="0" process="0" discard="1"/>
              <events ><![CDATA[g_strEvent]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[g_strDigitMap_Return]]></digit-map>
            </parameters>
          </rqnt>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_strEvent = "[0-9#*T]@"+ Session.g_oMS.strConnectionId + "(D,K)";
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 0 != Session.g_nReturnValue ) {
	Server.logError("FAILED TO SET DIGIT MAP FOR RETURN CALL");
}]]></script>
          </scripts>
        </action>
        <action id="27" plug-in="Pactolus.SipInvite.1" ><?xtml-editor x=702 y=84 ?>
          <!--INVITE to CallLegB-->
          <sip-invite xmlns="urn:www.pactolus.com:xtml:sip" add-record-route="0" add-via="1" handle-responses="0" follow-redirection="0" final-response-status="" response-content="" response-content-type="" final-request-uri="" timeout-for-final-response="" timeout-for-provisional-response="" record-route="" contact="" response-to="" use-session-timer="0" session-expires="" min-supported-session-timer="" refresher="" remote-party-id="" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegB.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <content >g_oCallLegB.strConfContent</content>
            <content-type >g_oCallLegA.strContentType</content-type>
            <cseq >g_oCallLegB.strCSeq</cseq>
            <from >g_oCallLegB.strFrom</from>
            <proxy-authorization >g_oCallLegB.strProxyAuthorization</proxy-authorization>
            <request-uri >g_oCallLegB.strRequestUri</request-uri>
            <to >g_oCallLegB.strTo</to>
          </sip-invite>
          <results >
            <result name="Default" link="21" stubbed="1"/>
            <result name="Success" link="31" stubbed="0"/>
            <result name="Redirect (3xx)"/>
            <result name="Client error (4xx)"/>
            <result name="Server error (5xx)"/>
            <result name="Global error (6xx)"/>
            <result name="Provisional Timeout"/>
            <result name="Final Timeout"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.bCurrentlyDialing = true;
Session.g_oCallLegB.strTo = "<sip:" + Session.g_strReturnNumber + "@" + Session.s_strNIUAddress + ">";
Session.g_oCallLegB.strFrom = Session.g_oCallLegA.strFrom;
Session.g_oCallLegB.strCallId = js_CreateUniqueCallId();
Session.g_oCallLegB.strCSeq = 1001;
Session.g_oCallLegB.strRequestUri = "sip:" + Session.g_strReturnNumber + "@" + Session.s_strNIUAddress;
Session.g_oCallLegB.strRequestUri += ";target=pcs_voip_originate SIP/2.0";
Session.g_oCallLegB.strProxyAuthorization = Session.g_oCallLegA.strProxyAuthorization ;

Server.logInfo("Session.g_oCallLegB.strProxyAuthorization = <" + Session.g_oCallLegB.strProxyAuthorization + ">" );

Server.enableEvents(false) ;]]></script>
          </scripts>
        </action>
        <action id="31" plug-in="Standard.WaitEvent.1" ><?xtml-editor x=930 y=97 ?>
          <!--wait for final SIP response or dtmf-->
          <wait xmlns="urn:www.pactolus.com:xtml:communication" timeout="s_nTimeout" recv-name="strEventRcvd" >
            <msg name="Pactolus.EveSipResponse.1" >
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strCallId</parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strContact</parameter>
              <parameter >g_oCallLegB.strContent</parameter>
              <parameter >g_oCallLegB.strContentDisposition</parameter>
              <parameter >g_oCallLegB.strContentEncoding</parameter>
              <parameter >g_oCallLegB.strContentLanguage</parameter>
              <parameter >g_oCallLegB.strContentType</parameter>
              <parameter >g_oCallLegB.strCSeq</parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strFrom</parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strMinSE</parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter >strProxyAuthenticate</parameter>
              <parameter >g_oCallLegB.strRecordRoute</parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strSessionExpires</parameter>
              <parameter >strStatus</parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strSupported</parameter>
              <parameter ></parameter>
              <parameter >g_oCallLegB.strTo</parameter>
              <parameter >g_oCallLegB.strUnsupported</parameter>
              <parameter >g_oCallLegB.strUserAgent</parameter>
              <parameter >g_oCallLegB.strVia</parameter>
              <parameter ></parameter>
              <parameter ></parameter>
            </msg>
            <msg name="Pactolus.MGCPDtmf.1" >
              <parameter >strEndPoint</parameter>
              <parameter >strRequestID</parameter>
              <parameter >strDtmf</parameter>
            </msg>
          </wait>
          <results >
            <result name="Default" link="31" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="200 Ok" link="33" stubbed="0" >nStatus == 200</result>
            <result name="strDtmf == &quot;**&quot;" link="32" stubbed="0" >strDtmf match "**"</result>
            <result name="NonSuccess Response" link="34" stubbed="0" >nStatus &gt; 200</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents(true) ;]]></script>
            <script language="javascript" timing="middle" ><![CDATA[if (0 < Session.strStatus.length) {
	var status = new SipStatus(Session.strStatus);
	Session.nStatus = status.code;
}
]]></script>
            <script language="javascript" timing="last" ><![CDATA[Server.enableEvents(false) ;]]></script>
          </scripts>
        </action>
        <action id="32" plug-in="Pactolus.SipCancel.1" ><?xtml-editor x=1210 y=428 ?>
          <!--Cancel to CallLegB-->
          <sip-bye xmlns="urn:www.pactolus.com:xtml:sip" add-record-route="0" add-via="1" timeout="4" handle-responses="1" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegB.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >g_oCallLegB.strCSeq</cseq>
            <from >g_oCallLegB.strFrom</from>
            <record-route >g_oCallLegB.strRecordRoute</record-route>
            <request-uri >g_oCallLegB.strRequestUri</request-uri>
            <route >g_oCallLegB.strRoute</route>
            <to >g_oCallLegB.strTo</to>
          </sip-bye>
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="Success"/>
            <result name="Timeout"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
var cseq = new SipCSeq(Session.g_oCallLegB.strCSeq.toString());
cseq.method = "CANCEL";
Session.g_oCallLegB.strCSeq = cseq.encode();

Server.enableEvents(false);]]></script>
          </scripts>
        </action>
        <action id="33" plug-in="Pactolus.SipAck.1" ><?xtml-editor x=1166 y=60 ?>
          <!--Ack to success-->
          <sip-ack xmlns="urn:www.pactolus.com:xtml:sip" add-record-route="0" add-via="1" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegB.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >g_oCallLegB.strCSeq</cseq>
            <from >g_oCallLegB.strFrom</from>
            <request-uri >g_oCallLegB.strRequestUri</request-uri>
            <to >g_oCallLegB.strTo</to>
          </sip-ack>
          <results >
            <result name="Default" link="36" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_oCallLegB.bConnected = true;
Session.g_oCallLegB.bCurrentlyDialing = false;
js_calculate_uri_and_route( false, "SIP/2.0", 
		Session.g_oCallLegB.strFrom, 
		Session.g_oCallLegB.strContact, 
		Session.g_oCallLegB.strRecordRoute, 
		Session.g_oCallLegB.strRemoteUri, 
		Session.g_oCallLegB.strRoute )
Server.logInfo("CallLegB's Contact: " + Session.g_oCallLegB.strContact);
Server.logInfo("CallLegB's RecordRoute: " + Session.g_oCallLegB.strRecordRoute);
Server.logInfo("Setting CallLegB RemoteUri: " + Session.g_oCallLegB.strRemoteUri);
Server.logInfo("Setting CallLegB Route: " + Session.g_oCallLegB.strRoute);
//for lib calls
Session.g_oCallLegB.strRequestUri = Session.g_oCallLegB.strRemoteUri;

Server.enableEvents(true) ;]]></script>
          </scripts>
        </action>
        <action id="34" plug-in="Pactolus.SipAck.1" ><?xtml-editor x=1164 y=237 ?>
          <!--ACK to unsuccesful final response-->
          <sip-ack xmlns="urn:www.pactolus.com:xtml:sip" add-record-route="0" add-via="0" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegB.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <cseq >g_oCallLegB.strCSeq</cseq>
            <from >g_oCallLegB.strFrom</from>
            <request-uri >g_oCallLegB.strRequestUri</request-uri>
            <to >g_oCallLegB.strTo</to>
            <via >g_oCallLegB.strVia</via>
          </sip-ack>
          <results >
            <result name="Default" link="21" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="407 response" link="38" stubbed="0" >nStatus == 407</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.enableEvents(true) ;
if( 407 != Session.nStatus ) {
	Server.logError("RAPID CALL RETURN FAILED. FINAL RESPONSE FROM CALL LEG B: " + Session.strStatus);
}
Session.g_oCallLegB.bCurrentlyDialing = false;]]></script>
            <script language="javascript" timing="last" ><![CDATA[if( 407 == Session.nStatus ) {
	js_parse_value( Session.strProxyAuthenticate, "nonce", Session.strNonce ) ;
	var uri = new SipUrl( Session.g_oCallLegB.strContact ) ;
	var address = uri.host ; 
	if( uri.port != null && 5060 != uri.port ) {
		address += ":" ;
		address += port ;
	} 
	Session.g_oCallLegB.strTo = "<sip:" + Session.g_oMessage.strFromAnnc + "@" + Session.s_strNIUAddress + ">";
	Session.g_oCallLegB.strCSeq = 1002;
}
]]></script>
          </scripts>
        </action>
        <action id="35" plug-in="Pactolus.CNFAddMember.1" ><?xtml-editor x=473 y=94 ?>
          <!--Create conf connection to Invite B-->
          <add-member xmlns="urn:www.pactolus.com:xtml:conference" endpoint="g_oCallLegB.strConfEndPoint" ms-type="s_strMSType" ci="g_oMS.strConferenceId" inbound="1" returns="g_nReturnValue" timeout="s_nTimeout" connection-id="g_oCallLegB.strConfConnectionId" ms-sdp="g_oCallLegB.strConfContent" mgcp-call-id="g_oCallLegB.strConfCallId" ingress-gateway="" early-media="0" local="1" party-on-hold="0" packetization-period="g_oMS.intPacketizationPeriod" codec="0" telephone-events="1" route="" record-route="" contact="" te="1" dc="0" le="1" ig="" og="" ia="" oa="" iat="" oat="" ias="" oas="" tf="1" lf="1" session-expires="" min-se="" supported="" min-supported-session-timer="" refresher="" use-session-timer="0" conn-mode="send/receive" >
            <attributes mp="16" mt="3" ig="0" og="0" iat="-10" ias="-40" oat="-10" oas="-40" atn="3" att="2" ia="1" oa="1" te="1" le="1" tp="0" dc="0" tc="1" ate="0" se="0"/>
          </add-member>
          <results >
            <result name="Default" link="13" stubbed="0"/>
            <result name="Success" link="27" stubbed="0"/>
            <result name="Error"/>
            <result name="Timeout"/>
            <result name="Resource Unavailable"/>
            <result name="Caller Hung up"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("ADD MEMBER_B RETURNED: " + Session.g_nReturnValue) ;
Server.logInfo("CallLegB_ConfContent: " + Session.g_oCallLegB.strConfContent);
Server.logInfo("CallLegB_ConfEndPoint: " + Session.g_oCallLegB.strConfEndPoint);
Server.logInfo("CallLegB_ConfConnectionID: " + Session.g_oCallLegB.strConfConnectionId);
Server.logInfo("CallLegB_ConfCallId: " + Session.g_oCallLegB.strConfCallId);
Server.logInfo("ConferenceId: " + Session.g_oMS.strConferenceId);
]]></script>
          </scripts>
        </action>
        <action id="36" plug-in="Pactolus.MGCPModify.1" ><?xtml-editor x=1416 y=60 ?>
          <!--Modify connection to the SDP returned by B in the final response-->
          <mdcx xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oCallLegB.strConfConnectionId" endpoint="g_oCallLegB.strConfEndPoint" callid="g_oCallLegB.strConfCallId" returns="g_nReturnValue" remote-sdp="g_oCallLegB.strContent" mode="send/receive" packetization-period="20" codec="-1" timeout="s_nTimeout" local-connection-options="" second-endpoint-id="" ms-type="s_strMSType" >
            <parameters >
              <quarantine step="0" loop="0" process="0" discard="0"/>
              <events ><![CDATA[]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[]]></digit-map>
            </parameters>
          </mdcx>
          <results >
            <result name="Default" link="22" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
        </action>
        <action id="37" plug-in="Pactolus.SipInvite.1" ><?xtml-editor x=1048 y=538 ?>
          <!--INVITE to CallLegB-->
          <sip-invite xmlns="urn:www.pactolus.com:xtml:sip" add-record-route="0" add-via="1" handle-responses="0" follow-redirection="0" final-response-status="" response-content="" response-content-type="" final-request-uri="" timeout-for-final-response="" timeout-for-provisional-response="" record-route="" contact="" response-to="" use-session-timer="0" session-expires="" min-supported-session-timer="" refresher="" remote-party-id="" increment-cseq-first="0" increment-cseq-last="0" >
            <call-id >g_oCallLegB.strCallId</call-id>
            <contact >g_strLocalContact</contact>
            <content >g_oCallLegB.strConfContent</content>
            <content-type >g_oCallLegA.strContentType</content-type>
            <cseq >g_oCallLegB.strCSeq</cseq>
            <from >g_oCallLegB.strFrom</from>
            <proxy-authorization >g_oCallLegB.strProxyAuthorization</proxy-authorization>
            <request-uri >g_oCallLegB.strRequestUri</request-uri>
            <to >g_oCallLegB.strTo</to>
          </sip-invite>
          <results >
            <result name="Default" link="31" stubbed="0"/>
            <result name="Success"/>
            <result name="Redirect (3xx)"/>
            <result name="Client error (4xx)"/>
            <result name="Server error (5xx)"/>
            <result name="Global error (6xx)"/>
            <result name="Provisional Timeout"/>
            <result name="Final Timeout"/>
            <result name="Error"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[var authorization = "Digest username=\"" ;
authorization += Session.g_oAPI.strUserName ;
authorization += "\" realm=\"" ;
authorization += Session.g_oAPI.strRealm ;
authorization += "\" nonce=\"" ;
authorization += Session.strNonce ;
authorization += "\" uri=\"" ;
authorization += Session.g_oCallLegB.strRequestUri ;
authorization += "\" response=\"" ;
authorization += Session.strDigestResponse ;
authorization += "\" algorithm=MD5" ;

Session.g_oCallLegB.strProxyAuthorization = authorization ;

Session.g_oCallLegB.bCurrentlyDialing = true;


Server.enableEvents(false) ;]]></script>
          </scripts>
        </action>
        <action id="38" plug-in="Pactolus.JavaStaticMethod.1" ><?xtml-editor x=807 y=558 ?>
          <!--calcMD5Response-->
          <java xmlns="urn:www.pactolus.com:xtml:application" class="&quot;com.pactolus.Utilities&quot;" method="&quot;calcMD5Response&quot;" timeout="5" return="" method-return-var="" method-return-type="0" >
            <parameter type="in" var-type="string" >g_oAPI.strUserName</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strRealm</parameter>
            <parameter type="in" var-type="string" >g_oAPI.strPassword</parameter>
            <parameter type="in" var-type="string" >strNonce</parameter>
            <parameter type="in" var-type="string" >"INVITE"</parameter>
            <parameter type="in" var-type="string" >g_oCallLegB.strRequestUri</parameter>
            <parameter type="inout" var-type="string" >strDigestResponse</parameter>
          </java>
          <results >
            <result name="Default" link="37" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[Server.logInfo("Username: " + Session.g_oAPI.strUserName ) ;
Server.logInfo("Password: " + Session.g_oAPI.strPassword) ;
Server.logInfo("Realm: " + Session.g_oAPI.strRealm) ;
Server.logInfo("Nonce: " + Session.strNonce) ;
Server.logInfo("uri: " + Session.g_oCallLegB.strRequestUri) ;
Server.logInfo("response: " + Session.strDigestResponse ) ;
]]></script>
          </scripts>
        </action>
      </actions>
      <text-objects >
        <text-object x-coord="53" y-coord="24" width="254" height="25" text="***Add support for wiertap on A leg" font-name="Times New Roman" size="-16" red="0" green="0" blue="0" weight="0" underline="0" strikeout="0" point-size="12" italic="0"/>
      </text-objects>
    </function>
    <function name="OnDTMF" start="1" event="OnDTMF" returns="void" >
      <parameters >
        <parameter name="strEndpoint" type="string" pass="byref"/>
        <parameter name="strRequestID" type="string" pass="byref"/>
        <parameter name="strDtmf" type="string" pass="byref"/>
        <parameter name="nReason" type="i2" pass="byref"/>
      </parameters>
      <actions >
        <action id="1" plug-in="Pactolus.Branch.1" ><?xtml-editor x=88 y=165 ?>
          <results >
            <result name="Default" link="4" stubbed="0"/>
            <result name="**" link="6" stubbed="0" >strEndpoint match g_oMS.strEndPoint
AND strDtmf match "**"</result>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Server.logInfo("RECEIVED DTMF: " + Session.strDtmf) ;]]></script>
          </scripts>
        </action>
        <action id="2" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=625 y=124 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="3" plug-in="Standard.FunctionReturn.1" ><?xtml-editor x=612 y=333 ?>
          <return xmlns="urn:www.pactolus.com:xtml:application" value=""/>
        </action>
        <action id="4" plug-in="Pactolus.MGCPNotifyRequest.1" ><?xtml-editor x=369 y=85 ?>
          <!--Reset digit map for return to VM-->
          <rqnt xmlns="urn:www.pactolus.com:xtml:media" connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" timeout="s_nTimeout" returns="g_nReturnValue" ms-type="s_strMSType" >
            <parameters >
              <quarantine step="1" loop="0" process="0" discard="1"/>
              <events ><![CDATA[g_strEvent]]></events>
              <signals ><![CDATA[]]></signals>
              <digit-map ><![CDATA[g_strDigitMap_Return]]></digit-map>
            </parameters>
          </rqnt>
          <results >
            <result name="Default" link="2" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[
]]></script>
            <script language="javascript" timing="last" ><![CDATA[if ( 0 != Session.g_nReturnValue ) {
	Server.logError("FAILED TO SET DIGIT MAP FOR RETURN CALL");
}]]></script>
          </scripts>
        </action>
        <action id="5" plug-in="Standard.FunctionCall.1" ><?xtml-editor x=396 y=318 ?>
          <!--Main - HangupReturnCall-->
          <function xmlns="urn:www.pactolus.com:xtml:application" name="&quot;Main&quot;" return="" external-function="0" library=""/>
          <results >
            <result name="Default" link="3" stubbed="0"/>
          </results>
          <scripts >
            <script language="javascript" timing="first" ><![CDATA[Session.g_sSTATE = Session.s_sSTATE_HANGUP_RETURN_CALL ;]]></script>
          </scripts>
        </action>
        <action id="6" plug-in="Pactolus.CNFDeleteConf.1" ><?xtml-editor x=187 y=306 ?>
          <delete-conference xmlns="urn:www.pactolus.com:xtml:conference" ci="g_oMS.strConferenceId" ms-type="s_strMSType" timeout="s_nTimeout" returns="g_nReturnValue"/>
          <results >
            <result name="Default" link="5" stubbed="0"/>
            <result name="Success"/>
            <result name="Error"/>
            <result name="Timeout"/>
          </results>
          <scripts >
            <script language="javascript" timing="last" ><![CDATA[if ( 0 != Session.g_nReturnValue ) {
	Server.logError("FAILED TO DELETE CONFERENCE. RETURN CODE: " + Session.g_nReturnValue) ;
}

Session.g_oCallLegB.nTerminationReason = "2" ; //Caller hungup]]></script>
          </scripts>
        </action>
      </actions>
    </function>
  </functions>
  <script language="javascript" ><![CDATA[#include <javascript_utils.jsh>
#include <dialing_plan_utils.jsh>

function find_previous_message(iNextMsg, oMsgGroup) {
	var j = -1 ;
	for ( var i = iNextMsg ; i >= 0 ; i-- ) {
		Server.logInfo("GLOBAL: i = " + i + " Msg: " + oMsgGroup[i]);
			if ( "deleted" != oMsgGroup[i] ) {
				var j = i ;
				break ;
			}
	}
	return j ;
}

function find_next_message(iNextMsg, oMsgGroup) {
	var j = -1 ;
	for ( var i = iNextMsg ; i >= 0 ; i++ ) {
	Server.logInfo("GLOBAL: i = " + i + " Msg: " + oMsgGroup[i]);
		if ( "deleted" != oMsgGroup[i] ) {
			var j = i ;
			break ;
		}
	}
	return j ;
}

function parse_uri_params( &uri ) 
{
	if( js_parse_value( uri, "vmail_account_id", Session.g_oAPI.lVMAcctId ) ) {
		js_parse_value( uri, "access_line_id", Session.g_oAPI.lAccessLineId ) ; 
		Server.logInfo("parse_uri_params: Retrieved voicemail account id from INVITE: " + Session.g_oAPI.lVMAcctId);
		Server.logInfo("parse_uri_params: Parsed access line id: " + Session.g_oAPI.lAccessLineId);
		return true ;
	}
	return false ;
}]]></script>
  <properties >
    <property key="&quot;eng&quot;" value="C:/pactolus_app_server/prompts/pcs_english.vox"/>
    <property key="default" value="C:/pactolus_app_server/prompts/pcs_english.vox"/>
    <property key="disable-logging" value="0"/>
    <property key="js-include-path" value="../Libs"/>
    <property key="library-modules" value="lib_callcontrol.xml;lib_mediaserver.xml;lib_voip.xml;lib_vmail.xml;lib_APISce.xml"/>
    <property key="library-path" value="../Libs"/>
  </properties>
  <application-version >
    <revision >$Id: pcs_vmail_retrieve.xml,v 1.115.4.1 2010/03/30 19:22:58 jgibson Exp $</revision>
    <label >$Name: PCS-A-4-1-1-1-4-c6 $</label>
  </application-version>
</xtml>