<?xml version="1.0"?>
<xtml version="1.0"><events><event name="ConnectToMusicResponse" display="ConnectToMusicResponse"><parameter name="intReplyCode" type="i4"/><parameter name="strReplyMsg" type="string"/><parameter name="intConferenceIndex" type="i4"/><parameter name="strConferenceId" type="string"/></event><event name="ForceDisconnectFromMusic" display="ForceDisconnectFromMusic"/></events><global-handlers><handler event="Pactolus.EveSipInvite.1" function="OnInvite" public="1" always-on="0"/><handler event="Pactolus.EveSipBye.1" function="OnBye" public="0" always-on="0"/><handler event="Standard.OnServiceLoad.1" function="OnServiceLoad" public="0" always-on="0"/><handler event="Standard.OnSessionEnd.1" function="OnSessionEnd" public="0" always-on="0"/><handler event="ForceDisconnectFromMusic" function="OnForceDisconnectFromMusic" public="0" always-on="0"/></global-handlers><global-vars><var name="g_oMS" type="object"></var><var name="g_oCallLegA" type="object"></var><var name="g_intReturnCode" type="i4">-99</var><var name="g_strLanguage" type="string">eng</var><var name="g_strSessionID" type="string"></var><var name="g_intSessionIndex" type="i4">0</var><var name="g_intReplyCode" type="i4">-99</var><var name="g_strReplyMsg" type="string"></var><var name="g_intConferenceIndex" type="i4">0</var><var name="g_strConferenceId" type="string"></var><var name="g_strEvtReceive" type="string"></var><var name="g_strCalledSessionId" type="string"></var><var name="g_lServiceProviderId" type="i8">0</var></global-vars><shared-vars><var name="s_strMSType" type="string"></var><var name="s_intTIMEOUT" type="i4">35</var><var name="s_intFAILURE" type="i4">-1</var><var name="s_intSUCCESS" type="i4">0</var><var name="s_intCALLERHUNGUP" type="i4">-2</var><var name="s_intMOHTIMEOUT" type="i4">60</var><var name="s_intPacketizationPeriod" type="i4">20</var><var name="s_strContact" type="string"></var></shared-vars><functions><function name="OnInvite" start="1" returns="void"><parameters><parameter name="strAccept" type="string"/><parameter name="strAcceptEncoding" type="string"/><parameter name="strAcceptLanguage" type="string"/><parameter name="strAuthorization" type="string"/><parameter name="strCallId" type="string"/><parameter name="strContact" type="string"/><parameter name="strContent" type="string"/><parameter name="strContentDisposition" type="string"/><parameter name="strContentType" type="string"/><parameter name="strCSeq" type="string"/><parameter name="strDate" type="string"/><parameter name="strEncryption" type="string"/><parameter name="strExpires" type="string"/><parameter name="strFrom" type="string"/><parameter name="nMaxForwards" type="i2"/><parameter name="strProxyAuthorization" type="string"/><parameter name="strProxyRequire" type="string"/><parameter name="strRecordRoute" type="string"/><parameter name="strRequestURI" type="string"/><parameter name="strRequire" type="string"/><parameter name="strResponseKey" type="string"/><parameter name="strRoute" type="string"/><parameter name="strSessionExpires" type="string"/><parameter name="strSubject" type="string"/><parameter name="strSupported" type="string"/><parameter name="strTimestamp" type="string"/><parameter name="strTo" type="string"/><parameter name="strVia" type="string"/></parameters><local-vars><var name="intReturnCode" type="i4">0</var></local-vars><actions><action id="1" plug-in="Pactolus.Branch.1"><?xtml-editor x=178 y=132 ?><!--intialize oCallLegA and oMS--><results><result name="Default" link="2" stubbed="0"/></results><scripts><script language="javascript" timing="first"><![CDATA[Session.g_strSessionID = Session._sessionId;
// Phone A object
Session.g_oCallLegA.bReverseFromTo = true;
Session.g_oCallLegA.strFrom = Session.strFrom;
Session.g_oCallLegA.strTo = Session.strTo;
Session.g_oCallLegA.strCallId = Session.strCallId;
Session.g_oCallLegA.strContact = Session.strContact;
Session.g_oCallLegA.strContent = Session.strContent;
Session.g_oCallLegA.strOriginalContent = Session.strContent;
Session.g_oCallLegA.strContentType = Session.strContentType;
Session.g_oCallLegA.strCSeq = Session.strCSeq;
Session.g_oCallLegA.strRecordRoute = Session.strRecordRoute;
Session.g_oCallLegA.strRoute = Session.strRoute;
Session.g_oCallLegA.strVia = Session.strVia;
Session.g_oCallLegA.intSessionTimer = Clib.strtod(Session.strSessionExpires);
var contact = new SipNameAddr(Session.strContact);
Session.g_oCallLegA.strRequestURI = contact.url.toString() + " SIP/2.0";
var from_uri = new SipFrom( Session.strFrom ) ;
Session.g_oCallLegA.strCallingNumber = from_uri.url.user;
if (from_uri.url.user.length <= 0 || from_uri.url.user == undefined)
{
	Server.logInfo("NO FROM URI");
}

//mediaserver object
Session.g_oMS.strEndPoint = "";
Session.g_oMS.strConnectionId = "";
Session.g_oMS.strCallId = "";
Session.g_oMS.strContent = "";
Session.g_oMS.strConferenceId = "";	//use through out
Session.g_oMS.strConfEndPoint = "";	//use for create and delete conf
Session.g_oMS.strType = Session.s_strMSType;
Session.g_oMS.intPacketizationPeriod = Session.s_intPacketizationPeriod;
Session.g_oMS.bMuteFlag = true;
Session.g_oMS.bDeafFlag = false;
Session.g_oMS.bCurrentlyInConf = false;
Session.g_oMS.bConfCreated = false;
Session.g_oMS.bCurrentlyConnected = false;
Session.g_oMS.bRetry = false;]]></script></scripts></action><action id="2" plug-in="Standard.FunctionCall.1"><?xtml-editor x=433 y=131 ?><!--Direct caller to MS--><function name="&quot;DirectCallerToMS&quot;" return="intReturnCode" external-function="1" library=""><parameter>g_oCallLegA</parameter><parameter>g_oMS</parameter></function><results><result name="Default" link="4" stubbed="0"/></results></action><action id="3" plug-in="Pactolus.MGCPPlay.1"><?xtml-editor x=176 y=342 ?><!--WaitForModerator, Please hold--><play connection-id="g_oMS.strConnectionId" endpoint="g_oMS.strEndPoint" callid="g_oMS.strCallId" repeat="1" timeout="s_intTIMEOUT" ms-type="g_oMS.strType" returns="g_intReturnCode" start-play="1" interrupt="1" return-immediate="0" digit-map="" language="g_strLanguage" digits="" retry-count="" clear-digits="1" terminating-digit="" quick-collect="0" digit-timer=""><audio type="index">897</audio><audio type="index">898</audio></play><results><result name="Default" link="5" stubbed="0"/><result name="Success"/><result name="Error"/><result name="Timeout"/></results></action><action id="4" plug-in="Pactolus.Branch.1"><?xtml-editor x=673 y=131 ?><!--failure?--><results><result name="Default" link="3" stubbed="0"/><result name="failure" link="8" stubbed="0">intReturnCode == s_intFAILURE</result><result name="caller hung up" link="7" stubbed="0">intReturnCode == s_intCALLERHUNGUP</result></results><scripts><script language="javascript" timing="last"><![CDATA[if (Result.id != 1)
{
	Session.g_bSentFinalResponse = true;
}]]></script></scripts></action><action id="5" plug-in="Standard.FunctionCall.1"><?xtml-editor x=406 y=340 ?><!--put caller on hold--><function name="&quot;PutPartyOnHold&quot;" return="intReturnCode" external-function="1" library="lib_callcontrol.xml"><parameter>g_oCallLegA</parameter><parameter>strContact</parameter></function><results><result name="Default" link="6" stubbed="0"/></results></action><action id="6" plug-in="Pactolus.Branch.1"><?xtml-editor x=636 y=337 ?><!--success?--><results><result name="Default" link="9" stubbed="0"/><result name="success?" link="11" stubbed="0">intReturnCode == s_intSUCCESS</result></results></action><action id="7" plug-in="Standard.EndSession.1"><?xtml-editor x=1134 y=158 ?></action><action id="8" plug-in="Pactolus.SipResponse.1"><?xtml-editor x=914 y=68 ?><!--503 Service Unavailable--><sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0"><call-id>strCallId</call-id><cseq>strCSeq</cseq><from>strFrom</from><status>"SIP/2.0 503 Service Unavailable"</status><to>strTo</to><via>strVia</via></sip-response><results><result name="Default" link="7" stubbed="0"/><result name="Success"/><result name="Error"/><result name="Timeout"/></results></action><action id="9" plug-in="Standard.FunctionCall.1"><?xtml-editor x=862 y=331 ?><!--Hang up party--><function name="&quot;HangUpParty&quot;" return="" external-function="1" library=""><parameter>g_oCallLegA</parameter></function><results><result name="Default" link="7" stubbed="0"/></results></action><action id="10" plug-in="Pactolus.SOAPMessage.1"><?xtml-editor x=178 y=576 ?><!--send ConnectToMusic--><SOAP destination-ip="" transaction="" message-name="&quot;ConnectToMusic&quot;" destination-port="" destination-type="1" destination-session="" waiting-session-selected="g_strCalledSessionId"><parameter tag="&quot;session_id&quot;" value="g_strSessionID"/><parameter tag="&quot;service_provider_id&quot;" value="g_lServiceProviderId"/></SOAP><results><result name="Default" link="12" stubbed="0"/><result name="Success"/><result name="Error"/></results><scripts><script language="javascript" timing="first"><![CDATA[Server.logInfo("INFO: SEND FROM session ID is: " + Session.g_strSessionID);
// Session.g_lServiceProviderId = Server.getUTCTime();
//Session.g_lServiceProviderId = 1234567890;
Session.g_lServiceProviderId = 1;
Server.logInfo("INFO: SEND FROM service provider ID is: " + Session.g_lServiceProviderId);]]></script><script language="javascript" timing="last"><![CDATA[Server.logInfo("INFO: SENT IVRCONFADDPARTY TO session ID is: " + Session.g_strCalledSessionId);]]></script></scripts></action><action id="11" plug-in="Standard.FunctionCall.1"><?xtml-editor x=868 y=437 ?><!--Delete MS Connection--><function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library=""><parameter>g_oMS</parameter></function><results><result name="Default" link="10" stubbed="0"/></results></action><action id="12" plug-in="Standard.WaitEvent.1"><?xtml-editor x=418 y=576 ?><!--for ConnectToMusicResponse--><wait timeout="s_intMOHTIMEOUT" recv-name="g_strEvtReceive"><msg name="ConnectToMusicResponse"><parameter>g_intReplyCode</parameter><parameter>g_strReplyMsg</parameter><parameter>g_intConferenceIndex</parameter><parameter>g_strConferenceId</parameter></msg></wait><results><result name="Default" link="7" stubbed="0"/><result name="Success" link="16" stubbed="0"/><result name="Error"/><result name="Timeout"/></results></action><action id="13" plug-in="Standard.FunctionReturn.1"><?xtml-editor x=642 y=853 ?><return value=""/></action><action id="14" plug-in="Standard.FunctionCall.1"><?xtml-editor x=181 y=955 ?><!--AddMemberToConference--><function name="&quot;AddMemberToConference&quot;" return="intReturnCode" external-function="1" library="lib_mediaserver.xml"><parameter>g_oMS</parameter><parameter>g_oCallLegA</parameter><parameter>s_strContact</parameter></function><results><result name="Default" link="15" stubbed="0"/></results><scripts><script language="javascript" timing="first"><![CDATA[Session.g_oMS.strConferenceId = Session.g_strConferenceId;]]></script></scripts></action><action id="15" plug-in="Pactolus.Branch.1"><?xtml-editor x=404 y=954 ?><!--success?--><results><result name="Default" link="13" stubbed="0"/><result name="FAILURE" link="17" stubbed="0">intReturnCode == s_intFAILURE</result><result name="CALLERHUNGUP" link="7" stubbed="0">intReturnCode == s_intCALLERHUNGUP</result></results></action><action id="16" plug-in="Pactolus.Branch.1"><?xtml-editor x=651 y=694 ?><!--success?--><results><result name="Default" link="7" stubbed="0"/><result name="ReplyCode==0?" link="14" stubbed="0">g_intReplyCode == s_intSUCCESS</result></results><scripts><script language="javascript" timing="first"><![CDATA[Server.logInfo("INFO: RECEIVE RESPONSE: " + Session.g_strEvtReceive);
Server.logInfo("INFO: RECEIVE REPLY CODE: " + Session.g_intReplyCode);
Server.logInfo("INFO: RECEIVE REPLY MSG: " + Session.g_strReplyMsg);
Server.logInfo("INFO: RECEIVE CONF INDEX: " + Session.g_intConferenceIndex);
Server.logInfo("INFO: RECEIVE CONF ID: " + Session.g_strConferenceId);]]></script></scripts></action><action id="17" plug-in="Standard.FunctionCall.1"><?xtml-editor x=708 y=923 ?><!--Hang up party--><function name="&quot;HangUpParty&quot;" return="" external-function="1" library=""><parameter>g_oCallLegA</parameter></function><results><result name="Default" link="7" stubbed="0"/></results></action></actions></function><function name="OnSessionEnd" start="1" returns="void"><parameters><parameter name="nSessionEndReason" type="i2"/></parameters><local-vars><var name="f_bSendDisconnect" type="boolean">0</var></local-vars><actions><action id="1" plug-in="Standard.FunctionCall.1"><?xtml-editor x=163 y=133 ?><!--Remove member from conference--><function name="&quot;RemoveMemberFromConference&quot;" return="" external-function="1" library=""><parameter>g_oMS</parameter></function><results><result name="Default" link="5" stubbed="0"/></results></action><action id="2" plug-in="Pactolus.SOAPMessage.1"><?xtml-editor x=433 y=452 ?><!--send DisconnectToMusic--><SOAP destination-ip="" transaction="" message-name="&quot;DisconnectFromMusic&quot;" destination-port="" destination-type="3" destination-session="g_strCalledSessionId" waiting-session-selected=""><parameter tag="&quot;conference_index&quot;" value="g_intConferenceIndex"/><parameter tag="&quot;session_id&quot;" value="g_strSessionID"/></SOAP><results><result name="Default" link="3" stubbed="0"/><result name="Success"/><result name="Error"/></results><scripts><script language="javascript" timing="first"><![CDATA[Server.logInfo("INFO: SEND FROM session ID is: " + Session.g_strSessionID);]]></script><script language="javascript" timing="last"><![CDATA[Server.logInfo("INFO: SENT IVRCONFADDPARTY TO session ID is: " + Session.g_strCalledSessionId);]]></script></scripts></action><action id="3" plug-in="Standard.FunctionReturn.1"><?xtml-editor x=708 y=470 ?><return value=""/></action><action id="4" plug-in="Pactolus.Branch.1"><?xtml-editor x=160 y=393 ?><!--send disconnect--><results><result name="Default" link="3" stubbed="0"/><result name="send diconnect == true" link="2" stubbed="0">f_bSendDisconnect == true</result></results><scripts><script language="javascript" timing="first"><![CDATA[if (Session.g_strCalledSessionId.length > 0)
{
	Session.f_bSendDisconnect = true;
}]]></script></scripts></action><action id="5" plug-in="Standard.FunctionCall.1"><?xtml-editor x=416 y=191 ?><!--Delete MS Connection--><function name="&quot;DeleteMSConnection&quot;" return="" external-function="1" library="lib_mediaserver.xml"><parameter>g_oMS</parameter></function><results><result name="Default" link="4" stubbed="0"/></results></action></actions></function><function name="OnBye" start="1" returns="void"><parameters><parameter name="strAccept" type="string" pass="byref"/><parameter name="strAcceptEncoding" type="string" pass="byref"/><parameter name="strAcceptLanguage" type="string" pass="byref"/><parameter name="strAuthorization" type="string" pass="byref"/><parameter name="strCallId" type="string" pass="byref"/><parameter name="strCSeq" type="string" pass="byref"/><parameter name="strDate" type="string" pass="byref"/><parameter name="strEncryption" type="string" pass="byref"/><parameter name="strFrom" type="string" pass="byref"/><parameter name="nMaxForwards" type="i2" pass="byref"/><parameter name="strProxyAuthorization" type="string" pass="byref"/><parameter name="strProxyRequire" type="string" pass="byref"/><parameter name="strRecordRoute" type="string" pass="byref"/><parameter name="strRequestURI" type="string" pass="byref"/><parameter name="strRequire" type="string" pass="byref"/><parameter name="strResponseKey" type="string" pass="byref"/><parameter name="strRoute" type="string" pass="byref"/><parameter name="strSupported" type="string" pass="byref"/><parameter name="strTimestamp" type="string" pass="byref"/><parameter name="strTo" type="string" pass="byref"/><parameter name="strVia" type="string" pass="byref"/></parameters><actions><action id="1" plug-in="Pactolus.SipResponse.1"><?xtml-editor x=158 y=237 ?><!--200 OK--><sip-response remove-via="0" reliable="0" increment-cseq-first="0" increment-cseq-last="0"><call-id>strCallId</call-id><cseq>strCSeq</cseq><from>strFrom</from><status>"SIP/2.0 200 OK"</status><to>strTo</to><via>strVia</via></sip-response><results><result name="Default" link="2" stubbed="0"/><result name="Success"/><result name="Error"/><result name="Timeout"/></results></action><action id="2" plug-in="Standard.EndSession.1"><?xtml-editor x=393 y=238 ?></action></actions></function><function name="OnServiceLoad" start="1" returns="void"><parameters><parameter name="strAppName" type="string" pass="byref"/><parameter name="nSessionCount" type="i2" pass="byref"/><parameter name="nMaxIterations" type="i2" pass="byref"/><parameter name="nServerId" type="i2" pass="byref"/></parameters><actions><action id="1" plug-in="Pactolus.UserFunction.1"><?xtml-editor x=263 y=280 ?><!--GET PSX IP from config--><user-function process="&quot;PACTOLUS_ps_c_adaptor&quot;" function="&quot;get_property&quot;" timeout="s_intTIMEOUT" return="" async="0"><parameter>"packetization-period"</parameter><parameter>s_intPacketizationPeriod</parameter><parameter>"media-server-type"</parameter><parameter>s_strMSType</parameter></user-function><results><result name="Default" link="2" stubbed="0"/><result name="Success"/><result name="Error"/><result name="Timeout"/></results><scripts><script language="javascript" timing="last"><![CDATA[if (Result.id == 2)
{
	Server.logInfo("INFO: SUCCESS CALL C++ FUNCTION TO GET INFO FROM PS_MASTER.");
}
else
{
	Server.logError("ERROR: FAIL TO CALL C++ FUNCTION TO GET INFO FROM PS_MASTER, EXIT ON: " + Result.name);
}

Session.s_strContact = "sip:" + Server.ipAddress;
if( Server.sipPort != 5060 )
{
	Session.s_strContact += ":" + Server.sipPort;
}]]></script></scripts></action><action id="2" plug-in="Standard.FunctionReturn.1"><?xtml-editor x=517 y=279 ?><return value=""/></action></actions></function><function name="OnForceDisconnectFromMusic" start="1" returns="void"><actions><action id="1" plug-in="Standard.FunctionCall.1"><?xtml-editor x=209 y=209 ?><!--Hang up party--><function name="&quot;HangUpParty&quot;" return="" external-function="1" library=""><parameter>g_oCallLegA</parameter></function><results><result name="Default" link="2" stubbed="0"/></results></action><action id="2" plug-in="Standard.EndSession.1"><?xtml-editor x=436 y=206 ?></action></actions></function></functions><properties><property key="disable-logging" value=""/><property key="js-include-path" value="D:\Applications\InternalProduct\SceXMLScripts\Libs"/><property key="library-modules" value="lib_3WayCalling.xml,lib_acd.xml,lib_APISce.xml,lib_callcontrol.xml,lib_mediaserver.xml,lib_moh.xml,lib_soap.xml,lib_speeddial.xml,lib_utils.xml"/><property key="library-path" value="D:\Applications\InternalProduct\SceXMLScripts\Libs"/></properties><application-version>
		<revision>$Id: test_music_on_hold.xml,v 1.8 2003/11/26 21:22:25 hlam Exp $</revision>
		<label>$Name: PCS-A-4-1-1-1-4-c6 $</label>
	</application-version>
</xtml>
